<!DOCTYPE html>
<html lang="zh-CN">
    <head hexo-theme='https://github.com/volantis-x/hexo-theme-volantis/tree/5.5.0'>
  <meta name="generator" content="Hexo 6.2.0">
  <meta name="Volantis" content="5.5.0">
  <meta charset="utf-8">
  <!-- SEOç›¸å…³ -->
  
  <link rel="canonical" href="http://example.com/2022/08/06/java/redis/"/>
  <!-- æ¸²æŸ“ä¼˜åŒ– -->
    <meta http-equiv='x-dns-prefetch-control' content='on' />
      <link rel='dns-prefetch' href='https://unpkg.com'>
      <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Content-Security-Policy" content=" default-src 'self' https:; block-all-mixed-content; base-uri 'self' https:; form-action 'self' https:; worker-src 'self' https:; connect-src 'self' https: *; img-src 'self' data: https: *; media-src 'self' https: *; font-src 'self' data: https: *; frame-src 'self' https: *; manifest-src 'self' https: *; child-src https:; script-src 'self' https: 'unsafe-inline' *; style-src 'self' https: 'unsafe-inline' *; ">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <!-- import head_begin begin -->
  <!-- import head_begin end -->
  <!-- Custom Files headBegin begin-->
  
  <!-- Custom Files headBegin end-->
  <link rel="preload" href="/css/style.13e9f403.css" as="style">
  <link rel="preload" href="https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/VarelaRound/VarelaRound-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
<link rel="preload" href="https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/UbuntuMono/UbuntuMono-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <!-- feed -->
  <!-- é¡µé¢å…ƒæ•°æ® -->
  <title>Redisçš„å­¦ä¹ ç¬”è®° - æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼</title>
  <meta name="keywords" content="Java,æ•°æ®åº“,null">
  <meta desc name="description" content="ä¸€ä¸ªä¸èµ·çœ¼çš„å°åšå®¢ - ä¸€ä¸ªå°åƒåœ¾ - æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼">
  
<meta property="og:type" content="article">
<meta property="og:title" content="Redisçš„å­¦ä¹ ç¬”è®°">
<meta property="og:url" content="http://example.com/2022/08/06/Java/Redis/index.html">
<meta property="og:site_name" content="æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼">
<meta property="og:description" content="åŸºç¡€ç¯‡1.åˆè¯†Redis1.1 è®¤è¯†NoSqlé”®å€¼æ•°æ®åº“æ˜¯ä¸€ç§NoSqlæ•°æ®åº“    key value    1001 {   â€œidâ€:1001,   â€œnameâ€:â€å¼ ä¸‰â€,   â€œageâ€:20,}   SQLï¼šå…³ç³»å‹æ•°æ®åº“ NoSQLï¼šéå…³ç³»å‹æ•°æ®åº“ SQLä¸NoSQlçš„æ¯”è¾ƒï¼š     SQL NoSQL    æ•°æ®ç»“æ„ ç»“æ„åŒ– éç»“æ„åŒ–ï¼š1.é”®å€¼ç±»å‹(Redis)2.æ–‡æ¡£ç±»å‹(Mong">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
<meta property="article:published_time" content="2022-08-06T11:11:16.304Z">
<meta property="article:modified_time" content="2023-02-06T13:48:39.866Z">
<meta property="article:author" content="ä¸€ä¸ªå°åƒåœ¾">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="æ•°æ®åº“">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
  <style>
    /* é¦–å±æ ·å¼ */
    #safearea {
  display: none;
}
/*
  * Workaround for Chrome bug, part 1
  * Chunk rendering for all but the first article.
  * /layout/_partial/scripts/content-visibility-scroll-fix.ejs
*/
.post-story + .post-story {
  content-visibility: auto;
  contain-intrinsic-size: 10px 500px;
}
:root {
  --color-site-body: #f4f4f4;
  --color-site-bg: #f4f4f4;
  --color-site-inner: #fff;
  --color-site-footer: #666;
  --color-card: #fff;
  --color-text: #444;
  --color-block: #f6f6f6;
  --color-inlinecode: #c74f00;
  --color-codeblock: #fff7ea;
  --color-h1: #3a3a3a;
  --color-h2: #3a3a3a;
  --color-h3: #333;
  --color-h4: #444;
  --color-h5: #555;
  --color-h6: #666;
  --color-p: #444;
  --color-list: #666;
  --color-list-hl: #30ad91;
  --color-meta: #888;
  --color-read-bkg: #e0d8c8;
  --color-read-post: #f8f1e2;
  --color-copyright-bkg: #f5f5f5;
}
* {
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  outline: none;
  margin: 0;
  padding: 0;
}
*::-webkit-scrollbar {
  height: 4px;
  width: 4px;
}
*::-webkit-scrollbar-track-piece {
  background: transparent;
}
*::-webkit-scrollbar-thumb {
  background: #3dd9b6;
  cursor: pointer;
  border-radius: 2px;
  -webkit-border-radius: 2px;
}
*::-webkit-scrollbar-thumb:hover {
  background: #ff5722;
}
html {
  color: var(--color-text);
  width: 100%;
  height: 100%;
  font-family: UbuntuMono, "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Menlo, Monaco, monospace, sans-serif;
  font-size: 16px;
}
html >::-webkit-scrollbar {
  height: 4px;
  width: 4px;
}
html >::-webkit-scrollbar-track-piece {
  background: transparent;
}
html >::-webkit-scrollbar-thumb {
  background: #3dd9b6;
  cursor: pointer;
  border-radius: 2px;
  -webkit-border-radius: 2px;
}
html >::-webkit-scrollbar-thumb:hover {
  background: #ff5722;
}
body {
  background-color: var(--color-site-body);
  text-rendering: optimizelegibility;
  -webkit-tap-highlight-color: rgba(0,0,0,0);
  line-height: 1.6;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}
body.modal-active {
  overflow: hidden;
}
@media screen and (max-width: 680px) {
  body.modal-active {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
  }
}
a {
  color: #2092ec;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
a:hover {
  color: #ff5722;
}
a:active,
a:hover {
  outline: 0;
}
ul,
ol {
  padding-left: 0;
}
ul li,
ol li {
  list-style: none;
}
header {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
img {
  border: 0;
  background: none;
  max-width: 100%;
}
svg:not(:root) {
  overflow: hidden;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  -webkit-box-sizing: content-box;
  -moz-box-sizing: content-box;
  height: 0;
  border: 0;
  border-radius: 1px;
  -webkit-border-radius: 1px;
  border-bottom: 1px solid rgba(68,68,68,0.1);
}
button,
input {
  color: inherit;
  font: inherit;
  margin: 0;
}
button {
  overflow: visible;
  text-transform: none;
  -webkit-appearance: button;
  cursor: pointer;
}
@supports (backdrop-filter: blur(20px)) {
  .blur {
    background: rgba(255,255,255,0.9) !important;
    backdrop-filter: saturate(200%) blur(20px);
  }
}
.shadow {
  box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
}
.shadow.floatable {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.shadow.floatable:hover {
  box-shadow: 0 2px 4px 0px rgba(0,0,0,0.1), 0 4px 8px 0px rgba(0,0,0,0.1), 0 8px 16px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 2px 4px 0px rgba(0,0,0,0.1), 0 4px 8px 0px rgba(0,0,0,0.1), 0 8px 16px 0px rgba(0,0,0,0.1);
}
#l_cover {
  min-height: 64px;
}
.cover-wrapper {
  top: 0;
  left: 0;
  max-width: 100%;
  height: 100vh;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  flex-wrap: nowrap;
  -webkit-flex-wrap: nowrap;
  -khtml-flex-wrap: nowrap;
  -moz-flex-wrap: nowrap;
  -o-flex-wrap: nowrap;
  -ms-flex-wrap: nowrap;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: vertical;
  -moz-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  align-items: center;
  align-self: center;
  align-content: center;
  color: var(--color-site-inner);
  padding: 0 16px;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  position: relative;
  overflow: hidden;
  margin-bottom: -100px;
}
.cover-wrapper .cover-bg {
  position: absolute;
  width: 100%;
  height: 100%;
  background-position: center;
  background-size: cover;
  -webkit-background-size: cover;
  -moz-background-size: cover;
}
.cover-wrapper .cover-bg.lazyload:not(.loaded) {
  opacity: 0;
  -webkit-opacity: 0;
  -moz-opacity: 0;
}
.cover-wrapper .cover-bg.lazyload.loaded {
  animation-delay: 0s;
  animation-duration: 0.5s;
  animation-fill-mode: forwards;
  animation-timing-function: ease-out;
  animation-name: fadeIn;
}
@-moz-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-webkit-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-o-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.cover-wrapper .cover-body {
  z-index: 1;
  position: relative;
  width: 100%;
  height: 100%;
}
.cover-wrapper#full {
  height: calc(100vh + 100px);
  padding-bottom: 100px;
}
.cover-wrapper#half {
  max-height: 640px;
  min-height: 400px;
  height: calc(36vh - 64px + 200px);
}
.cover-wrapper #scroll-down {
  width: 100%;
  height: 64px;
  position: absolute;
  bottom: 100px;
  text-align: center;
  cursor: pointer;
}
.cover-wrapper #scroll-down .scroll-down-effects {
  color: #fff;
  font-size: 24px;
  line-height: 64px;
  position: absolute;
  width: 24px;
  left: calc(50% - 12px);
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  animation: scroll-down-effect 1.5s infinite;
  -webkit-animation: scroll-down-effect 1.5s infinite;
  -khtml-animation: scroll-down-effect 1.5s infinite;
  -moz-animation: scroll-down-effect 1.5s infinite;
  -o-animation: scroll-down-effect 1.5s infinite;
  -ms-animation: scroll-down-effect 1.5s infinite;
}
@-moz-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-webkit-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-o-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.cover-wrapper .cover-body {
  margin-top: 64px;
  margin-bottom: 100px;
}
.cover-wrapper .cover-body,
.cover-wrapper .cover-body .top,
.cover-wrapper .cover-body .bottom {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: vertical;
  -moz-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  max-width: 100%;
}
.cover-wrapper .cover-body .bottom {
  margin-top: 32px;
}
.cover-wrapper .cover-body .title {
  font-family: "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Helvetica, monospace;
  font-size: 3.125rem;
  line-height: 1.2;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.cover-wrapper .cover-body .subtitle {
  font-size: 20px;
}
.cover-wrapper .cover-body .logo {
  max-height: 120px;
  max-width: calc(100% - 4 * 16px);
}
@media screen and (min-height: 1024px) {
  .cover-wrapper .cover-body .title {
    font-size: 3rem;
  }
  .cover-wrapper .cover-body .subtitle {
    font-size: 1.05rem;
  }
  .cover-wrapper .cover-body .logo {
    max-height: 150px;
  }
}
.cover-wrapper .cover-body .m_search {
  position: relative;
  max-width: calc(100% - 16px);
  width: 320px;
  vertical-align: middle;
}
.cover-wrapper .cover-body .m_search .form {
  position: relative;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  width: 100%;
}
.cover-wrapper .cover-body .m_search .icon,
.cover-wrapper .cover-body .m_search .input {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.cover-wrapper .cover-body .m_search .icon {
  position: absolute;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  line-height: 2.5rem;
  width: 32px;
  top: 0;
  left: 5px;
  color: rgba(68,68,68,0.75);
}
.cover-wrapper .cover-body .m_search .input {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  height: 2.5rem;
  width: 100%;
  box-shadow: none;
  -webkit-box-shadow: none;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  font-size: 0.875rem;
  -webkit-appearance: none;
  padding-left: 36px;
  border-radius: 1.4rem;
  -webkit-border-radius: 1.4rem;
  background: rgba(255,255,255,0.6);
  backdrop-filter: blur(10px);
  border: none;
  color: var(--color-text);
}
@media screen and (max-width: 500px) {
  .cover-wrapper .cover-body .m_search .input {
    padding-left: 36px;
  }
}
.cover-wrapper .cover-body .m_search .input:hover {
  background: rgba(255,255,255,0.8);
}
.cover-wrapper .cover-body .m_search .input:focus {
  background: #fff;
}
.cover-wrapper .list-h {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: horizontal;
  -moz-box-orient: horizontal;
  -webkit-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  flex-wrap: wrap;
  -webkit-flex-wrap: wrap;
  -khtml-flex-wrap: wrap;
  -moz-flex-wrap: wrap;
  -o-flex-wrap: wrap;
  -ms-flex-wrap: wrap;
  align-items: stretch;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
.cover-wrapper .list-h a {
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  -webkit-flex: 1 0;
  -ms-flex: 1 0;
  flex: 1 0;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  font-weight: 600;
}
.cover-wrapper .list-h a img {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  border-radius: 2px;
  -webkit-border-radius: 2px;
  margin: 4px;
  min-width: 40px;
  max-width: 44px;
}
@media screen and (max-width: 768px) {
  .cover-wrapper .list-h a img {
    min-width: 36px;
    max-width: 40px;
  }
}
@media screen and (max-width: 500px) {
  .cover-wrapper .list-h a img {
    margin: 2px 4px;
    min-width: 32px;
    max-width: 36px;
  }
}
@media screen and (max-width: 375px) {
  .cover-wrapper .list-h a img {
    min-width: 28px;
    max-width: 32px;
  }
}
.cover-wrapper {
  max-width: 100%;
}
.cover-wrapper.search .bottom .menu {
  margin-top: 16px;
}
.cover-wrapper.search .bottom .menu .list-h a {
  white-space: nowrap;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: horizontal;
  -moz-box-orient: horizontal;
  -webkit-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  align-items: baseline;
  padding: 2px;
  margin: 4px;
  color: var(--color-site-inner);
  opacity: 0.75;
  -webkit-opacity: 0.75;
  -moz-opacity: 0.75;
  text-shadow: 0 1px 2px rgba(0,0,0,0.05);
  border-bottom: 2px solid transparent;
}
.cover-wrapper.search .bottom .menu .list-h a i {
  margin-right: 4px;
}
.cover-wrapper.search .bottom .menu .list-h a p {
  font-size: 0.9375rem;
}
.cover-wrapper.search .bottom .menu .list-h a:hover,
.cover-wrapper.search .bottom .menu .list-h a.active,
.cover-wrapper.search .bottom .menu .list-h a:active {
  opacity: 1;
  -webkit-opacity: 1;
  -moz-opacity: 1;
  border-bottom: 2px solid var(--color-site-inner);
}
.cover-wrapper.dock .menu,
.cover-wrapper.featured .menu,
.cover-wrapper.focus .menu {
  border-radius: 6px;
  -webkit-border-radius: 6px;
}
.cover-wrapper.dock .menu .list-h a,
.cover-wrapper.featured .menu .list-h a,
.cover-wrapper.focus .menu .list-h a {
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: vertical;
  -moz-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  align-items: center;
  padding: 12px;
  line-height: 24px;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  border-bottom: none;
  text-align: center;
  align-content: flex-end;
  color: rgba(68,68,68,0.7);
  font-size: 1.5rem;
}
@media screen and (max-width: 500px) {
  .cover-wrapper.dock .menu .list-h a,
  .cover-wrapper.featured .menu .list-h a,
  .cover-wrapper.focus .menu .list-h a {
    padding: 12px 8px;
  }
}
.cover-wrapper.dock .menu .list-h a i,
.cover-wrapper.featured .menu .list-h a i,
.cover-wrapper.focus .menu .list-h a i {
  margin: 8px;
}
.cover-wrapper.dock .menu .list-h a p,
.cover-wrapper.featured .menu .list-h a p,
.cover-wrapper.focus .menu .list-h a p {
  font-size: 0.875rem;
}
.cover-wrapper.dock .menu .list-h a.active,
.cover-wrapper.featured .menu .list-h a.active,
.cover-wrapper.focus .menu .list-h a.active {
  background: var(--color-card);
  backdrop-filter: none;
}
.cover-wrapper.dock .menu .list-h a.active i,
.cover-wrapper.featured .menu .list-h a.active i,
.cover-wrapper.focus .menu .list-h a.active i,
.cover-wrapper.dock .menu .list-h a.active i+p,
.cover-wrapper.featured .menu .list-h a.active i+p,
.cover-wrapper.focus .menu .list-h a.active i+p {
  color: #3dd9b6;
}
.cover-wrapper.dock .menu .list-h a.active img+p,
.cover-wrapper.featured .menu .list-h a.active img+p,
.cover-wrapper.focus .menu .list-h a.active img+p {
  color: var(--color-text);
}
.cover-wrapper.dock .menu .list-h a:hover,
.cover-wrapper.featured .menu .list-h a:hover,
.cover-wrapper.focus .menu .list-h a:hover {
  background: var(--color-card);
}
.cover-wrapper.dock .top {
  margin-bottom: 48px;
}
.cover-wrapper.dock .menu {
  background: rgba(255,255,255,0.5);
  position: absolute;
  bottom: 0;
  max-width: 100%;
}
.cover-wrapper.dock .menu .list-h {
  flex-wrap: nowrap;
  -webkit-flex-wrap: nowrap;
  -khtml-flex-wrap: nowrap;
  -moz-flex-wrap: nowrap;
  -o-flex-wrap: nowrap;
  -ms-flex-wrap: nowrap;
  margin: 4px;
}
.cover-wrapper.dock .menu .list-h a+a {
  margin-left: 4px;
}
@media screen and (max-width: 500px) {
  .cover-wrapper.dock .menu .list-h {
    overflow-x: scroll;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar {
    height: 0;
    width: 0;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar-track-piece {
    background: transparent;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar-thumb {
    background: #3dd9b6;
    cursor: pointer;
    border-radius: 0;
    -webkit-border-radius: 0;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar-thumb:hover {
    background: #ff5722;
  }
}
@supports (backdrop-filter: blur(20px)) {
  .cover-wrapper.dock .menu {
    background: rgba(255,255,255,0.5);
    backdrop-filter: saturate(200%) blur(20px);
  }
}
@font-face {
  font-family: 'UbuntuMono';
  src: url("https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/UbuntuMono/UbuntuMono-Regular.ttf");
  font-weight: 'normal';
  font-style: 'normal';
  font-display: swap;
}
@font-face {
  font-family: 'Varela Round';
  src: url("https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/VarelaRound/VarelaRound-Regular.ttf");
  font-weight: 'normal';
  font-style: 'normal';
  font-display: swap;
}
.l_header {
  position: fixed;
  z-index: 1000;
  top: 0;
  width: 100%;
  height: 64px;
  background: var(--color-card);
  box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
}
.l_header.auto {
  transition: opacity 0.4s ease;
  -webkit-transition: opacity 0.4s ease;
  -khtml-transition: opacity 0.4s ease;
  -moz-transition: opacity 0.4s ease;
  -o-transition: opacity 0.4s ease;
  -ms-transition: opacity 0.4s ease;
  visibility: hidden;
}
.l_header.auto.show {
  opacity: 1 !important;
  -webkit-opacity: 1 !important;
  -moz-opacity: 1 !important;
  visibility: visible;
}
.l_header .container {
  margin-left: 16px;
  margin-right: 16px;
}
.l_header #wrapper {
  height: 100%;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
.l_header #wrapper .nav-main,
.l_header #wrapper .nav-sub {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  flex-wrap: nowrap;
  -webkit-flex-wrap: nowrap;
  -khtml-flex-wrap: nowrap;
  -moz-flex-wrap: nowrap;
  -o-flex-wrap: nowrap;
  -ms-flex-wrap: nowrap;
  justify-content: space-between;
  -webkit-justify-content: space-between;
  -khtml-justify-content: space-between;
  -moz-justify-content: space-between;
  -o-justify-content: space-between;
  -ms-justify-content: space-between;
  align-items: center;
}
.l_header #wrapper .nav-main {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.l_header #wrapper.sub .nav-main {
  transform: translateY(-64px);
  -webkit-transform: translateY(-64px);
  -khtml-transform: translateY(-64px);
  -moz-transform: translateY(-64px);
  -o-transform: translateY(-64px);
  -ms-transform: translateY(-64px);
}
.l_header #wrapper .nav-sub {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  opacity: 0;
  -webkit-opacity: 0;
  -moz-opacity: 0;
  height: 64px;
  width: calc(100% - 2 * 16px);
  position: absolute;
}
.l_header #wrapper .nav-sub ::-webkit-scrollbar {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
}
@media screen and (min-width: 2048px) {
  .l_header #wrapper .nav-sub {
    max-width: 55vw;
    margin: auto;
  }
}
.l_header #wrapper.sub .nav-sub {
  opacity: 1;
  -webkit-opacity: 1;
  -moz-opacity: 1;
}
.l_header #wrapper .title {
  position: relative;
  color: var(--color-text);
  padding-left: 24px;
  max-height: 64px;
}
.l_header #wrapper .nav-main .title {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-shrink: 0;
  line-height: 64px;
  padding: 0 24px;
  font-size: 1.25rem;
  font-family: "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Helvetica, monospace;
}
.l_header #wrapper .nav-main .title img {
  height: 64px;
}
.l_header .nav-sub {
  max-width: 1080px;
  margin: auto;
}
.l_header .nav-sub .title {
  font-weight: bold;
  font-family: UbuntuMono, "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Menlo, Monaco, monospace, sans-serif;
  line-height: 1.2;
  max-height: 64px;
  white-space: normal;
  flex-shrink: 1;
}
.l_header .switcher {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  line-height: 64px;
  align-items: center;
}
.l_header .switcher .s-toc {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
}
@media screen and (max-width: 768px) {
  .l_header .switcher .s-toc {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: -ms-flexbox /* TWEENER - IE 10 */;
    display: -webkit-flex /* NEW - Chrome */;
    display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
    display: flex;
  }
}
.l_header .switcher >li {
  height: 48px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  margin: 2px;
}
@media screen and (max-width: 500px) {
  .l_header .switcher >li {
    margin: 0 1px;
    height: 48px;
  }
}
.l_header .switcher >li >a {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  align-items: center;
  width: 48px;
  height: 48px;
  padding: 0.85em 1.1em;
  border-radius: 100px;
  -webkit-border-radius: 100px;
  border: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  color: #3dd9b6;
}
.l_header .switcher >li >a:hover {
  border: none;
}
.l_header .switcher >li >a.active,
.l_header .switcher >li >a:active {
  border: none;
  background: var(--color-site-bg);
}
@media screen and (max-width: 500px) {
  .l_header .switcher >li >a {
    width: 36px;
    height: 48px;
  }
}
.l_header .nav-sub .switcher {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
}
.l_header .m_search {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  height: 64px;
  width: 240px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
@media screen and (max-width: 1024px) {
  .l_header .m_search {
    width: 44px;
    min-width: 44px;
  }
  .l_header .m_search input::placeholder {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
  }
  .l_header .m_search:hover {
    width: 240px;
  }
  .l_header .m_search:hover input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@media screen and (min-width: 500px) {
  .l_header .m_search:hover .input {
    width: 100%;
  }
  .l_header .m_search:hover .input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@media screen and (max-width: 500px) {
  .l_header .m_search {
    min-width: 0;
  }
  .l_header .m_search input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.l_header .m_search .form {
  position: relative;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  width: 100%;
  align-items: center;
}
.l_header .m_search .icon {
  position: absolute;
  width: 36px;
  left: 5px;
  color: var(--color-meta);
}
@media screen and (max-width: 500px) {
  .l_header .m_search .icon {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: none;
  }
}
.l_header .m_search .input {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  padding-top: 8px;
  padding-bottom: 8px;
  line-height: 1.3;
  width: 100%;
  color: var(--color-text);
  background: #fafafa;
  box-shadow: none;
  -webkit-box-shadow: none;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  padding-left: 40px;
  font-size: 0.875rem;
  border-radius: 8px;
  -webkit-border-radius: 8px;
  border: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
@media screen and (min-width: 500px) {
  .l_header .m_search .input:focus {
    box-shadow: 0 4px 8px 0px rgba(0,0,0,0.1);
    -webkit-box-shadow: 0 4px 8px 0px rgba(0,0,0,0.1);
  }
}
@media screen and (max-width: 500px) {
  .l_header .m_search .input {
    background: var(--color-block);
    padding-left: 8px;
    border: none;
  }
  .l_header .m_search .input:hover,
  .l_header .m_search .input:focus {
    border: none;
  }
}
@media (max-width: 500px) {
  .l_header .m_search {
    left: 0;
    width: 0;
    overflow: hidden;
    position: absolute;
    background: #fff;
    transition: all 0.28s ease;
    -webkit-transition: all 0.28s ease;
    -khtml-transition: all 0.28s ease;
    -moz-transition: all 0.28s ease;
    -o-transition: all 0.28s ease;
    -ms-transition: all 0.28s ease;
  }
  .l_header .m_search .input {
    border-radius: 32px;
    -webkit-border-radius: 32px;
    margin-left: 16px;
    padding-left: 16px;
  }
  .l_header.z_search-open .m_search {
    width: 100%;
  }
  .l_header.z_search-open .m_search .input {
    width: calc(100% - 120px);
  }
}
ul.m-pc >li>a {
  color: inherit;
  border-bottom: 2px solid transparent;
}
ul.m-pc >li>a:active,
ul.m-pc >li>a.active {
  border-bottom: 2px solid #3dd9b6;
}
ul.m-pc li:hover >ul.list-v,
ul.list-v li:hover >ul.list-v {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
ul.nav-list-h {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  align-items: stretch;
}
ul.nav-list-h>li {
  position: relative;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  height: 100%;
  line-height: 2.4;
  border-radius: 4px;
  -webkit-border-radius: 4px;
}
ul.nav-list-h>li >a {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  font-weight: 600;
}
ul.list-v {
  z-index: 1;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  position: absolute;
  background: var(--color-card);
  box-shadow: 0 2px 4px 0px rgba(0,0,0,0.08), 0 4px 8px 0px rgba(0,0,0,0.08), 0 8px 16px 0px rgba(0,0,0,0.08);
  -webkit-box-shadow: 0 2px 4px 0px rgba(0,0,0,0.08), 0 4px 8px 0px rgba(0,0,0,0.08), 0 8px 16px 0px rgba(0,0,0,0.08);
  margin-top: -6px;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  padding: 8px 0;
}
ul.list-v.show {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
ul.list-v hr {
  margin-top: 8px;
  margin-bottom: 8px;
}
ul.list-v >li {
  white-space: nowrap;
  word-break: keep-all;
}
ul.list-v >li.header {
  font-size: 0.78125rem;
  font-weight: bold;
  line-height: 2em;
  color: var(--color-meta);
  margin: 8px 16px 4px;
}
ul.list-v >li.header i {
  margin-right: 8px;
}
ul.list-v >li ul {
  margin-left: 0;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  margin-top: -40px;
}
ul.list-v .aplayer-container {
  min-height: 64px;
  padding: 6px 16px;
}
ul.list-v >li>a {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  color: var(--color-list);
  font-size: 0.875rem;
  font-weight: bold;
  line-height: 36px;
  padding: 0 20px 0 16px;
  text-overflow: ellipsis;
  margin: 0 4px;
  border-radius: 4px;
  -webkit-border-radius: 4px;
}
@media screen and (max-width: 1024px) {
  ul.list-v >li>a {
    line-height: 40px;
  }
}
ul.list-v >li>a >i {
  margin-right: 8px;
}
ul.list-v >li>a:active,
ul.list-v >li>a.active {
  color: var(--color-list-hl);
}
ul.list-v >li>a:hover {
  color: var(--color-list-hl);
  background: var(--color-site-bg);
}
.l_header .menu >ul>li>a {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  padding: 0 8px;
}
.l_header .menu >ul>li>a >i {
  margin-right: 4px;
}
.l_header ul.nav-list-h>li {
  color: var(--color-list);
  line-height: 64px;
}
.l_header ul.nav-list-h>li >a {
  max-height: 64px;
  overflow: hidden;
  color: inherit;
}
.l_header ul.nav-list-h>li >a:active,
.l_header ul.nav-list-h>li >a.active {
  color: #3dd9b6;
}
.l_header ul.nav-list-h>li:hover>a {
  color: var(--color-list-hl);
}
.l_header ul.nav-list-h>li i.music {
  animation: rotate-effect 1.5s linear infinite;
  -webkit-animation: rotate-effect 1.5s linear infinite;
  -khtml-animation: rotate-effect 1.5s linear infinite;
  -moz-animation: rotate-effect 1.5s linear infinite;
  -o-animation: rotate-effect 1.5s linear infinite;
  -ms-animation: rotate-effect 1.5s linear infinite;
}
@-moz-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@-webkit-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@-o-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
.menu-phone li ul.list-v {
  right: calc(100% - 0.5 * 16px);
}
.menu-phone li ul.list-v ul {
  right: calc(100% - 0.5 * 16px);
}
#wrapper {
  max-width: 1080px;
  margin: auto;
}
@media screen and (min-width: 2048px) {
  #wrapper {
    max-width: 55vw;
  }
}
#wrapper .menu {
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  -webkit-flex: 1 1;
  -ms-flex: 1 1;
  flex: 1 1;
  margin: 0 16px 0 0;
}
#wrapper .menu .list-v ul {
  left: calc(100% - 0.5 * 16px);
}
.menu-phone {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  margin-top: 16px;
  right: 8px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.menu-phone ul {
  right: calc(100% - 0.5 * 16px);
}
@media screen and (max-width: 500px) {
  .menu-phone {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: block;
  }
}
.l_header {
  max-width: 65vw;
  left: calc((100% - 65vw) * 0.5);
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
}
@media screen and (max-width: 2048px) {
  .l_header {
    max-width: 1112px;
    left: calc((100% - 1112px) * 0.5);
  }
}
@media screen and (max-width: 1112px) {
  .l_header {
    left: 0;
    border-radius: 0;
    -webkit-border-radius: 0;
    max-width: 100%;
  }
}
@media screen and (max-width: 500px) {
  .l_header .container {
    margin-left: 0;
    margin-right: 0;
  }
  .l_header #wrapper .nav-main .title {
    padding-left: 16px;
    padding-right: 16px;
  }
  .l_header #wrapper .nav-sub {
    width: 100%;
  }
  .l_header #wrapper .nav-sub .title {
    overflow-y: scroll;
    margin-top: 2px;
    padding: 8px 16px;
  }
  .l_header #wrapper .switcher {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: -ms-flexbox /* TWEENER - IE 10 */;
    display: -webkit-flex /* NEW - Chrome */;
    display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
    display: flex;
    margin-right: 8px;
  }
  .l_header .menu {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: none;
  }
}
@media screen and (max-width: 500px) {
  .list-v li {
    max-width: 270px;
  }
}
#u-search {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 60px 20px;
  z-index: 1001;
}
@media screen and (max-width: 680px) {
  #u-search {
    padding: 0px;
  }
}

  </style>
  <link rel="stylesheet" href="/css/style.13e9f403.css" media="print" onload="this.media='all';this.onload=null">
  <noscript><link rel="stylesheet" href="/css/style.13e9f403.css"></noscript>
  
<script>
if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode))
    document.write(
	'<style>'+
		'html{'+
			'overflow-x: hidden !important;'+
			'overflow-y: hidden !important;'+
		'}'+
		'.kill-ie{'+
			'text-align:center;'+
			'height: 100%;'+
			'margin-top: 15%;'+
			'margin-bottom: 5500%;'+
		'}'+
    '.kill-t{'+
      'font-size: 2rem;'+
    '}'+
    '.kill-c{'+
      'font-size: 1.2rem;'+
    '}'+
		'#l_header,#l_body{'+
			'display: none;'+
		'}'+
	'</style>'+
    '<div class="kill-ie">'+
        `<span class="kill-t"><b>æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨æ— æ³•è®¿é—®æœ¬ç«™</b></span><br/>`+
        `<span class="kill-c">å¾®è½¯å·²ç»äº2016å¹´ç»ˆæ­¢äº†å¯¹ Internet Explorer (IE) 10 åŠæ›´æ—©ç‰ˆæœ¬çš„æ”¯æŒï¼Œ<br/>ç»§ç»­ä½¿ç”¨å­˜åœ¨æå¤§çš„å®‰å…¨éšæ‚£ï¼Œè¯·ä½¿ç”¨å½“ä»£ä¸»æµçš„æµè§ˆå™¨è¿›è¡Œè®¿é—®ã€‚</span><br/>`+
        `<a target="_blank" rel="noopener" href="https://blogs.windows.com/windowsexperience/2021/05/19/the-future-of-internet-explorer-on-windows-10-is-in-microsoft-edge/"><strong>äº†è§£è¯¦æƒ… ></strong></a>`+
    '</div>');
</script>


<noscript>
	<style>
		html{
			overflow-x: hidden !important;
			overflow-y: hidden !important;
		}
		.kill-noscript{
			text-align:center;
			height: 100%;
			margin-top: 15%;
			margin-bottom: 5500%;
		}
    .kill-t{
      font-size: 2rem;
    }
    .kill-c{
      font-size: 1.2rem;
    }
		#l_header,#l_body{
			display: none;
		}
	</style>
    <div class="kill-noscript">
        <span class="kill-t"><b>æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨æ— æ³•è®¿é—®æœ¬ç«™</b></span><br/>
        <span class="kill-c">æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</span><br/>
        <a target="_blank" rel="noopener" href="https://www.baidu.com/s?wd=å¯ç”¨JavaScript"><strong>äº†è§£è¯¦æƒ… ></strong></a>
    </div>
</noscript>


  <script>
  /************è¿™ä¸ªæ–‡ä»¶å­˜æ”¾ä¸éœ€è¦é‡è½½çš„å…¨å±€å˜é‡å’Œå…¨å±€å‡½æ•°*********/
  window.volantis = {}; // volantis å…¨å±€å˜é‡
  volantis.debug = false; // å¼€å¯è°ƒè¯•æ¨¡å¼
  volantis.dom = {}; // é¡µé¢Dom see: /source/js/app.js etc.

  volantis.GLOBAL_CONFIG ={
    debug: false,
    cdn: {"js":{"app":"/js/app.af2d54c8.js","parallax":"/js/plugins/parallax.8bf0ab10.js","rightMenu":"/js/plugins/rightMenu.d9437285.js","rightMenus":"/js/plugins/rightMenus.4d580c89.js","sites":"/js/plugins/tags/sites.76bf19b8.js","friends":"/js/plugins/tags/friends.f372da57.js","contributors":"/js/plugins/tags/contributors.aec80453.js","search":"/js/search/hexo.0e52f222.js"},"css":{"style":"/css/style.13e9f403.css"}},
    default: {"avatar":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/avatar/round/3442075.svg","link":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/link/8f277b4ee0ecd.svg","cover":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/cover/76b86c0226ffd.svg","image":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/image/2659360.svg"},
    lastupdate: new Date(1675949129326),
    sidebar: {
      for_page: ["blogger","category","tagcloud","donate"],
      for_post: ["toc"],
      webinfo: {
        lastupd: {
          enable: true,
          friendlyShow: true
        },
        runtime: {
          data: "2022/06/24",
          unit: "å¤©"
        }
      }
    },
    plugins: {
      message: {"enable":true,"css":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/izitoast/dist/css/iziToast.min.css","js":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/izitoast/dist/js/iziToast.min.js","icon":{"default":"fa-solid fa-info-circle light-blue","quection":"fa-solid fa-question-circle light-blue"},"time":{"default":5000,"quection":20000},"position":"topRight","transitionIn":"bounceInLeft","transitionOut":"fadeOutRight","titleColor":"var(--color-text)","messageColor":"var(--color-text)","backgroundColor":"var(--color-card)","zindex":2147483647,"copyright":{"enable":true,"title":"çŸ¥è¯†å…±äº«è®¸å¯åè®®","message":"è¯·éµå®ˆ CC BY-NC-SA 4.0 åè®®ã€‚","icon":"far fa-copyright light-blue"},"aplayer":{"enable":true,"play":"fa-solid fa-play","pause":"fa-solid fa-pause"},"rightmenu":{"enable":true,"notice":true}},
      fancybox: {"css":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fancyapps/ui/dist/fancybox.css","js":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fancyapps/ui/dist/fancybox.umd.js"},
      
      
      
      rightmenus: {"enable":true,"order":["plugins.navigation","hr","plugins.inputBox","plugins.seletctText","plugins.elementCheck","plugins.elementImage","menus.link","hr","menus.darkMode","plugins.articlePage","music"],"options":{"iconPrefix":"fa-solid","articleShowLink":false,"musicAlwaysShow":false},"plugins":{"navigation":[{"id":"left","name":"è½¬åˆ°ä¸Šä¸€é¡µ","icon":"fa-solid fa-arrow-left","event":"history.back()","group":"navigation"},{"id":"right","name":"è½¬åˆ°ä¸‹ä¸€é¡µ","icon":"fa-solid fa-arrow-right","event":"history.forward()","group":"navigation"},{"id":"redo","name":"åˆ·æ–°å½“å‰é¡µé¢","icon":"fa-solid fa-redo","event":"window.location.reload()","group":"navigation"},{"id":"up","name":"å›åˆ°é¡¶éƒ¨","icon":"fa-solid fa-arrow-up","event":"VolantisApp.scrolltoElement(volantis.dom.bodyAnchor)","group":"navigation"}],"inputBox":[{"id":"copyPaste","name":"ç²˜è´´æ–‡æœ¬","icon":"fa-solid fa-paste","event":"copyPaste","group":"inputBox"},{"id":"copyAll","name":"å…¨é€‰æ–‡æœ¬","icon":"fa-solid fa-object-ungroup","event":"copyAll","group":"inputBox"},{"id":"copyCut","name":"å‰ªåˆ‡æ–‡æœ¬","icon":"fa-solid fa-cut","event":"copyCut","group":"inputBox"}],"seletctText":[{"id":"copyText","name":"å¤åˆ¶æ–‡æœ¬","icon":"fa-solid fa-copy","event":"copyText","group":"seletctText"},{"id":"searchWord","name":"ç«™å†…æœç´¢","icon":"fa-solid fa-search","event":"OpenSearch(__text__)","group":"seletctText"},{"id":"bingSearch","name":"å¿…åº”æœç´¢","icon":"fa-solid fa-search","event":"window.open(`https://cn.bing.com/search?q=${__text__}`)","group":"seletctText"}],"elementCheck":[{"id":"openTab","name":"æ–°æ ‡ç­¾é¡µæ‰“å¼€","icon":"fa-solid fa-external-link-square-alt","event":"window.open(__link__)","group":"elementCheck"},{"id":"copyLink","name":"å¤åˆ¶é“¾æ¥åœ°å€","icon":"fa-solid fa-link","event":"copyLink","group":"elementCheck"}],"elementImage":[{"id":"copyImg","name":"å¤åˆ¶å›¾ç‰‡","icon":"fa-solid fa-image","event":"copyImg","group":"elementImage"},{"id":"googleImg","name":"è°·æ­Œè¯†å›¾","icon":"fa-solid fa-images","event":"window.open(`https://www.google.com.hk/searchbyimage?image_url=${__link__}`)","group":"elementImage"}],"articlePage":[{"id":"printMode","name":"æ‰“å°é¡µé¢","icon":"fa-solid fa-print","event":"printMode","group":"articlePage"},{"id":"readMode","name":"é˜…è¯»æ¨¡å¼","icon":"fa-solid fa-book-open","event":"readMode","group":"articlePage"}]},"menus":{"link":["hr",{"id":"source_docs","name":"æœ¬ç«™æºç ","icon":"fa-solid fa-code-branch","link":"https://github.com/volantis-x/volantis-docs/","group":"link"},{"id":"source_theme","name":"ä¸»é¢˜æºç ","icon":"fa-solid fa-code-branch","link":"https://github.com/volantis-x/hexo-theme-volantis/","group":"link"}]}}
      
    }
  }

  /******************** volantis.EventListener ********************************/
  // äº‹ä»¶ç›‘å¬å™¨ see: /source/js/app.js
  volantis.EventListener = {}
  // è¿™é‡Œå­˜æ”¾pjaxåˆ‡æ¢é¡µé¢æ—¶å°†è¢«ç§»é™¤çš„äº‹ä»¶ç›‘å¬å™¨
  volantis.EventListener.list = []
  //æ„é€ æ–¹æ³•
  function volantisEventListener(type, f, ele) {
    this.type = type
    this.f = f
    this.ele = ele
  }
  // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
  volantis.EventListener.remove = () => {
    volantis.EventListener.list.forEach(function (i) {
      i.ele.removeEventListener(i.type, i.f, false)
    })
    volantis.EventListener.list = []
  }
  /******************** volantis.dom.$ ********************************/
  // æ³¨ï¼šè¿™é‡Œæ²¡æœ‰é€‰æ‹©å™¨ï¼Œä¹Ÿæ²¡æœ‰forEachä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªdomï¼Œè¿™é‡Œé‡æ–°å°è£…ä¸»é¢˜å¸¸ç”¨çš„domæ–¹æ³•ï¼Œè¿”å›çš„æ˜¯domå¯¹è±¡ï¼Œå¯¹è±¡åŒ…å«äº†ä»¥ä¸‹æ–¹æ³•ï¼ŒåŒæ—¶ä¿ç•™domçš„åŸç”ŸAPI
  function volantisDom(ele) {
    if (!ele) ele = document.createElement("div")
    this.ele = ele;
    // ==============================================================
    this.ele.find = (c) => {
      let q = this.ele.querySelector(c)
      if (q)
        return new volantisDom(q)
    }
    // ==============================================================
    this.ele.hasClass = (c) => {
      return this.ele.className.match(new RegExp('(\\s|^)' + c + '(\\s|$)'));
    }
    this.ele.addClass = (c) => {
      this.ele.classList.add(c);
      return this.ele
    }
    this.ele.removeClass = (c) => {
      this.ele.classList.remove(c);
      return this.ele
    }
    this.ele.toggleClass = (c) => {
      if (this.ele.hasClass(c)) {
        this.ele.removeClass(c)
      } else {
        this.ele.addClass(c)
      }
      return this.ele
    }
    // ==============================================================
    // å‚æ•° r ä¸º true è¡¨ç¤ºpjaxåˆ‡æ¢é¡µé¢æ—¶äº‹ä»¶ç›‘å¬å™¨å°†è¢«ç§»é™¤ï¼Œfalseä¸ç§»é™¤
    this.ele.on = (c, f, r = 1) => {
      this.ele.addEventListener(c, f, false)
      if (r) {
        volantis.EventListener.list.push(new volantisEventListener(c, f, this.ele))
      }
      return this.ele
    }
    this.ele.click = (f, r) => {
      this.ele.on("click", f, r)
      return this.ele
    }
    this.ele.scroll = (f, r) => {
      this.ele.on("scroll", f, r)
      return this.ele
    }
    // ==============================================================
    this.ele.html = (c) => {
      // if(c=== undefined){
      //   return this.ele.innerHTML
      // }else{
      this.ele.innerHTML = c
      return this.ele
      // }
    }
    // ==============================================================
    this.ele.hide = (c) => {
      this.ele.style.display = "none"
      return this.ele
    }
    this.ele.show = (c) => {
      this.ele.style.display = "block"
      return this.ele
    }
    // ==============================================================
    return this.ele
  }
  volantis.dom.$ = (ele) => {
    return !!ele ? new volantisDom(ele) : null;
  }
  /******************** RunItem ********************************/
  function RunItem() {
    this.list = []; // å­˜æ”¾å›è°ƒå‡½æ•°
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = ()=>{
          volantis.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) =>{
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index,1);
        }
      }
    }
    // æ„é€ ä¸€ä¸ªå¯ä»¥runçš„å¯¹è±¡
    function Item(fn, name) {
      // å‡½æ•°åç§°
      this.name = name || fn.name;
      // runæ–¹æ³•
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }
  /******************** Pjax ********************************/
  // /layout/_plugins/pjax/index.ejs
  // volantis.pjax.send(callBack[,"callBackName"]) ä¼ å…¥pjax:sendå›è°ƒå‡½æ•°
  // volantis.pjax.push(callBack[,"callBackName"]) ä¼ å…¥pjax:completeå›è°ƒå‡½æ•°
  // volantis.pjax.error(callBack[,"callBackName"]) ä¼ å…¥pjax:errorå›è°ƒå‡½æ•°
  volantis.pjax = {};
  volantis.pjax.method = {
    complete: new RunItem(),
    error: new RunItem(),
    send: new RunItem(),
  };
  volantis.pjax = Object.assign(volantis.pjax, {
    push: volantis.pjax.method.complete.push,
    error: volantis.pjax.method.error.push,
    send: volantis.pjax.method.send.push,
  });
  /******************** RightMenu ********************************/
  // volantis.rightmenu.handle(callBack[,"callBackName"]) å¤–éƒ¨èœå•é¡¹æ§åˆ¶
  // å¯åœ¨ volantis.mouseEvent å¤„è·å–å³é”®äº‹ä»¶
  volantis.rightmenu = {};
  volantis.rightmenu.method = {
    handle: new RunItem(),
  }
  volantis.rightmenu = Object.assign(volantis.rightmenu, {
    handle: volantis.rightmenu.method.handle.push,
  });
  /********************  Dark Mode  ********************************/
  // /layout/_partial/scripts/darkmode.ejs
  // volantis.dark.mode å½“å‰æ¨¡å¼ dark or light
  // volantis.dark.toggle() æš—é»‘æ¨¡å¼è§¦å‘å™¨
  // volantis.dark.push(callBack[,"callBackName"]) ä¼ å…¥è§¦å‘å™¨å›è°ƒå‡½æ•°
  volantis.dark = {};
  volantis.dark.method = {
    toggle: new RunItem(),
  };
  volantis.dark = Object.assign(volantis.dark, {
    push: volantis.dark.method.toggle.push,
  });
  /********************  Message  ********************************/
  // VolantisApp.message
  /********************  isMobile  ********************************/
  // /source/js/app.js
  // volantis.isMobile
  // volantis.isMobileOld
  /********************è„šæœ¬åŠ¨æ€åŠ è½½å‡½æ•°********************************/
  // volantis.js(src, cb)  cb å¯ä»¥ä¼ å…¥onloadå›è°ƒå‡½æ•° æˆ–è€… JSONå¯¹è±¡ ä¾‹å¦‚: volantis.js("src", ()=>{}) æˆ– volantis.js("src", {defer:true,onload:()=>{}})
  // volantis.css(src)

  // è¿”å›Promiseå¯¹è±¡ï¼Œå¦‚ä¸‹æ–¹æ³•åŒæ­¥åŠ è½½èµ„æºï¼Œè¿™åˆ©äºå¤„ç†æ–‡ä»¶èµ„æºä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä¾‹å¦‚ï¼šAPlayer éœ€è¦åœ¨ MetingJS ä¹‹å‰åŠ è½½
  // (async () => {
  //     await volantis.js("...theme.plugins.aplayer.js.aplayer...")
  //     await volantis.js("...theme.plugins.aplayer.js.meting...")
  // })();

  // å·²ç»åŠ å…¥äº†setTimeout
  volantis.js = (src, cb) => {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }
  volantis.css = (src) => {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  }
  /********************æŒ‰éœ€åŠ è½½çš„æ’ä»¶********************************/
  // volantis.import.jQuery().then(()=>{})
  volantis.import = {
    jQuery: () => {
      if (typeof jQuery == "undefined") {
        return volantis.js("https://unpkg.com/volantis-static@0.0.1654736714924/libs/jquery/dist/jquery.min.js")
      } else {
        return new Promise(resolve => {
          resolve()
        });
      }
    }
  }
  /********************** requestAnimationFrame ********************************/
  // 1ã€requestAnimationFrame ä¼šæŠŠæ¯ä¸€å¸§ä¸­çš„æ‰€æœ‰ DOM æ“ä½œé›†ä¸­èµ·æ¥ï¼Œåœ¨ä¸€æ¬¡é‡ç»˜æˆ–å›æµä¸­å°±å®Œæˆï¼Œå¹¶ä¸”é‡ç»˜æˆ–å›æµçš„æ—¶é—´é—´éš”ç´§ç´§è·Ÿéšæµè§ˆå™¨çš„åˆ·æ–°é¢‘ç‡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªé¢‘ç‡ä¸ºæ¯ç§’60å¸§ã€‚
  // 2ã€åœ¨éšè—æˆ–ä¸å¯è§çš„å…ƒç´ ä¸­ï¼ŒrequestAnimationFrame å°†ä¸ä¼šè¿›è¡Œé‡ç»˜æˆ–å›æµï¼Œè¿™å½“ç„¶å°±æ„å‘³ç€æ›´å°‘çš„çš„ cpuï¼Œgpu å’Œå†…å­˜ä½¿ç”¨é‡ã€‚
  volantis.requestAnimationFrame = (fn)=>{
    if (!window.requestAnimationFrame) {
      window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
    }
    window.requestAnimationFrame(fn)
  }
  /************************ layoutHelper *****************************************/
  volantis.layoutHelper = (helper, html, opt)=>{
    opt = Object.assign({clean:false, pjax:true}, opt)
    function myhelper(helper, html, clean) {
      volantis.tempDiv = document.createElement("div");
      volantis.tempDiv.innerHTML = html;
      let layoutHelper = document.querySelector("#layoutHelper-"+helper)
      if (layoutHelper) {
        if (clean) {
          layoutHelper.innerHTML = ""
        }
        layoutHelper.append(volantis.tempDiv);
      }
    }
    myhelper(helper, html, opt.clean)
    if (opt.pjax) {
      volantis.pjax.push(()=>{
        myhelper(helper, html, opt.clean)
      },"layoutHelper-"+helper)
    }
  }
  /****************************** æ»šåŠ¨äº‹ä»¶å¤„ç† ****************************************/
  volantis.scroll = {
    engine: new RunItem(),
    unengine: new RunItem(),
  };
  volantis.scroll = Object.assign(volantis.scroll, {
    push: volantis.scroll.engine.push,
  });
  // æ»šåŠ¨æ¡è·ç¦»é¡¶éƒ¨çš„è·ç¦»
  volantis.scroll.getScrollTop = () =>{
    let scrollPos;
    if (window.pageYOffset) {
      scrollPos = window.pageYOffset;
    } else if (document.compatMode && document.compatMode != 'BackCompat') {
      scrollPos = document.documentElement.scrollTop;
    } else if (document.body) {
      scrollPos = document.body.scrollTop;
    }
    return scrollPos;
  }
  // ä½¿ç”¨ requestAnimationFrame å¤„ç†æ»šåŠ¨äº‹ä»¶
  // `volantis.scroll.del` ä¸­å­˜å‚¨äº†ä¸€ä¸ªæ•°å€¼, è¯¥æ•°å€¼æ£€æµ‹ä¸€å®šæ—¶é—´é—´éš”å†…æ»šåŠ¨æ¡æ»šåŠ¨çš„ä½ç§», æ•°å€¼çš„æ£€æµ‹é¢‘ç‡æ˜¯æµè§ˆå™¨çš„åˆ·æ–°é¢‘ç‡. æ•°å€¼ä¸ºæ­£æ•°æ—¶, è¡¨ç¤ºå‘ä¸‹æ»šåŠ¨. æ•°å€¼ä¸ºè´Ÿæ•°æ—¶, è¡¨ç¤ºå‘ä¸Šæ»šåŠ¨.
  volantis.scroll.handleScrollEvents = () => {
    volantis.scroll.lastScrollTop = volantis.scroll.getScrollTop()
    function loop() {
      const scrollTop = volantis.scroll.getScrollTop();
      if (volantis.scroll.lastScrollTop !== scrollTop) {
        volantis.scroll.del = scrollTop - volantis.scroll.lastScrollTop;
        volantis.scroll.lastScrollTop = scrollTop;
        // if (volantis.scroll.del > 0) {
        //   console.log("å‘ä¸‹æ»šåŠ¨");
        // } else {
        //   console.log("å‘ä¸Šæ»šåŠ¨");
        // }
        // æ³¨é”€è¿‡æœŸçš„unengineæœªæ»šåŠ¨äº‹ä»¶
        volantis.scroll.unengine.list=[]
        volantis.scroll.engine.start();
      }else{
        volantis.scroll.unengine.start();
      }
      volantis.requestAnimationFrame(loop)
    }
    volantis.requestAnimationFrame(loop)
  }
  volantis.scroll.handleScrollEvents()
  // è§¦å‘é¡µé¢æ»šåŠ¨è‡³ç›®æ ‡å…ƒç´ ä½ç½®
  volantis.scroll.to = (ele, option = {}) =>{
    // é»˜è®¤é…ç½®
    opt = {
      top: ele.getBoundingClientRect().top + document.documentElement.scrollTop,
      behavior: "smooth"
    }
    // å®šä¹‰é…ç½®
    if ("top" in option) {
      opt.top = option.top
    }
    if ("behavior" in option) {
      opt.behavior = option.behavior
    }
    if ("addTop" in option) {
      opt.top += option.addTop
    }
    if (!("observerDic" in option)) {
      option.observerDic = 100
    }
    // æ»šåŠ¨
    window.scrollTo(opt);
    // ç›‘è§†å™¨
    // ç›‘è§†å¹¶çŸ«æ­£å…ƒç´ æ»šåŠ¨åˆ°æŒ‡å®šä½ç½®
    // ç”¨äºå¤„ç† lazyload å¼•èµ·çš„ cls å¯¼è‡´çš„å®šä½å¤±è´¥é—®é¢˜
    // option.observer = false
    if (option.observer) {
      setTimeout(()=>{
        volantis.scroll.unengine.push(()=>{
          let me = ele.getBoundingClientRect().top
          if(!(me >= -option.observerDic && me <= option.observerDic)){
            volantis.scroll.to(ele, option)
          }
          volantis.scroll.unengine.remove("unengineObserver")
        },"unengineObserver")
      },1000)
    }
  }
  /********************** Content Visibility ********************************/
  // è§ source/css/first.styl å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ åˆ é™¤ .post-story å³å¯
  // ä¸€ä¸ªå…ƒç´ è¢«å£°æ˜ content-visibility å±æ€§å å¦‚æœå…ƒç´ ä¸åœ¨ viewport ä¸­ æµè§ˆå™¨ä¸ä¼šè®¡ç®—å…¶åä»£å…ƒç´ æ ·å¼å’Œå±æ€§ ä»è€ŒèŠ‚çœ Style & Layout è€—æ—¶
  // content-visibility çš„å‰¯ä½œç”¨: é”šç‚¹å¤±æ•ˆ ç­‰ç­‰(å®éªŒåˆæœŸ æš‚ä¸æ˜ç¡®), ä½¿ç”¨æ­¤æ–¹æ³•æ¸…é™¤æ ·å¼
  volantis.cleanContentVisibility = ()=>{
    if (document.querySelector(".post-story")) {
      console.log("cleanContentVisibility");
      document.querySelectorAll(".post-story").forEach(e=>{
        e.classList.remove("post-story")
      })
    }
  }
  /******************************************************************************/
  /******************************************************************************/
  /******************************************************************************/
  //å›¾åƒåŠ è½½å‡ºé”™æ—¶çš„å¤„ç†
  function errorImgAvatar(img) {
    img.src = "https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/avatar/round/3442075.svg";
    img.onerror = null;
  }
  function errorImgCover(img) {
    img.src = "https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/cover/76b86c0226ffd.svg";
    img.onerror = null;
  }
  /******************************************************************************/
</script>

  <!-- import head_end begin -->
  <!-- import head_end end -->
  <!-- Custom Files headEnd begin-->
  
  <!-- Custom Files headEnd end-->
</head>
  <body itemscope itemtype="http://schema.org/WebPage">
    <!-- import body_begin begin-->
    <!-- import body_begin end-->
    <!-- Custom Files bodyBegin begin-->
    
    <!-- Custom Files bodyBegin end-->
    <header itemscope itemtype="http://schema.org/WPHeader" id="l_header" class="l_header auto shadow floatable blur show" style='opacity: 0' >
  <div class='container'>
  <div id='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h m-phone' id="pjax-header-nav-list">
        <li><a id="s-comment" class="fa-solid fa-comments fa-fw" target="_self"  href="/" onclick="return false;" title="comment"></a></li>
        
          <li><a id="s-toc" class="s-toc fa-solid fa-list fa-fw" target="_self"  href="/" onclick="return false;" title="toc"></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
            <img no-lazy class='logo' src='/images/Head.jpg'/>
          
          
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h m-pc'>
          
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/" title="åšå®¢"
                  
                  
                  
                    active-action="action-home"
                  >
                  <i class='fa-solid fa-rss fa-fw'></i>åšå®¢
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/categories/" title="åˆ†ç±»"
                  
                  
                  
                    active-action="action-categories"
                  >
                  <i class='fa-solid fa-folder-open fa-fw'></i>åˆ†ç±»
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/tags/" title="æ ‡ç­¾"
                  
                  
                  
                    active-action="action-tags"
                  >
                  <i class='fa-solid fa-tags fa-fw'></i>æ ‡ç­¾
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/archives/" title="å½’æ¡£"
                  
                  
                  
                    active-action="action-archives"
                  >
                  <i class='fa-solid fa-archive fa-fw'></i>å½’æ¡£
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/about/" title="å…³äº"
                  
                  
                  
                    active-action="action-about"
                  >
                  <i class='fa-solid fa-info-circle fa-fw'></i>å…³äº
                </a>
                
              </li>
            
          
          
				</ul>
			</div>
      
      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fa-solid fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>
      

			<ul class='switcher nav-list-h m-phone'>
				
					<li><a class="s-search fa-solid fa-search fa-fw" target="_self" href="/" onclick="return false;" title="search"></a></li>
				
				<li>
          <a class="s-menu fa-solid fa-bars fa-fw" target="_self" href="/" onclick="return false;" title="menu"></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/" title="åšå®¢"
                  
                  
                  
                    active-action="action-home"
                  >
                  <i class='fa-solid fa-rss fa-fw'></i>åšå®¢
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/categories/" title="åˆ†ç±»"
                  
                  
                  
                    active-action="action-categories"
                  >
                  <i class='fa-solid fa-folder-open fa-fw'></i>åˆ†ç±»
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/tags/" title="æ ‡ç­¾"
                  
                  
                  
                    active-action="action-tags"
                  >
                  <i class='fa-solid fa-tags fa-fw'></i>æ ‡ç­¾
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/archives/" title="å½’æ¡£"
                  
                  
                  
                    active-action="action-archives"
                  >
                  <i class='fa-solid fa-archive fa-fw'></i>å½’æ¡£
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/about/" title="å…³äº"
                  
                  
                  
                    active-action="action-about"
                  >
                  <i class='fa-solid fa-info-circle fa-fw'></i>å…³äº
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>

      <!-- Custom Files header begin -->
      
      <!-- Custom Files header end -->
		</div>
	</div>
  </div>
</header>

    <div id="l_body">
      <div id="l_cover">
  
    
      <!-- see: /layout/_partial/scripts/_ctrl/coverCtrl.ejs -->
      <div id="none" class='cover-wrapper post dock' style="display: none;">
        
  <div class='cover-bg lazyload placeholder' data-bg="https://fastly.jsdelivr.net/gh/MHG-LAB/cron@gh-pages/bing/bing.jpg"></div>

<div class='cover-body'>
  <div class='top'>
    
    
      <p class="title">ALittleGarbageçš„åšå®¢</p>
    
    
      <p class="subtitle">å–æ³•äºä¸Šï¼Œä»…å¾—å…¶ä¸­ï¼Œå–æ³•äºä¸­ï¼Œä»…å¾—å…¶æœ«ã€‚</p>
    
  </div>
  <div class='bottom'>
    <div class='menu navigation'>
      <div class='list-h'>
        
      </div>
    </div>
  </div>
</div>

        <div id="scroll-down" style="display: none;"><i class="fa fa-chevron-down scroll-down-effects"></i></div>
      </div>
    
  
</div>

      <div id="safearea">
        <div class="body-wrapper">
          
<div id="l_main" class=''>
  <article itemscope itemtype="http://schema.org/Article" class="article post white-box reveal md shadow floatable blur article-type-post" id="post" itemscope itemprop="blogPost">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/06/Java/Redis/">
  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼">
  </span>
  <span hidden itemprop="post" itemscope itemtype="http://schema.org/Post">
    <meta itemprop="name" content="æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼">
    <meta itemprop="description" content="ä¸€ä¸ªä¸èµ·çœ¼çš„å°åšå®¢">
  </span>
  


  
    <span hidden>
      <meta itemprop="image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
    </span>
  
  <div class="article-meta" id="top">
    
    
    
      <h1 class="title" itemprop="name headline">
        Redisçš„å­¦ä¹ ç¬”è®°
      </h1>
      <div class='new-meta-box'>
        
          
            
<div class='new-meta-item author' itemprop="author" itemscope itemtype="http://schema.org/Person">
  <a itemprop="url" class='author' href="/" rel="nofollow">
    <img itemprop="image" src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/apple-touch-icon.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/apple-touch-icon.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
    <p itemprop="name">ä¸€ä¸ªå°åƒåœ¾</p>
  </a>
</div>

          
        
          
            
  <div class='new-meta-item category'>
    <i class="fa-solid fa-folder-open fa-fw" aria-hidden="true"></i>
    <a class="category-link" href="/categories/Java/">Java</a>
    
      <span hidden itemprop="about" itemscope itemtype="http://schema.org/Thing">
        <a href="/categories/Java/" itemprop="url"><span itemprop="name">Java</span></a>
      </span>
    
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateCreated datePublished" datetime="2022-08-06T19:11:16+08:00">
  <a class='notlink'>
    <i class="fa-solid fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>å‘å¸ƒäºï¼š2022å¹´8æœˆ6æ—¥</p>
  </a>
</div>

          
        
          
            


<div class="new-meta-item browse">
  <a class='notlink'>
    <p>
      <i class="fa-solid fa-eye fa-fw" aria-hidden="true"></i>
      
      <span>æ¬¡æµè§ˆ</span>
    </p>
  </a>
</div>


          
        
        <!-- Custom Files topMeta begin-->
        
        <!-- Custom Files topMeta end-->
      </div>
    
  </div>


  <div id="layoutHelper-page-plugins"></div>
  <div id="post-body" itemprop="articleBody">
    <h1 id="åŸºç¡€ç¯‡"><a href="#åŸºç¡€ç¯‡" class="headerlink" title="åŸºç¡€ç¯‡"></a>åŸºç¡€ç¯‡</h1><div class="story post-story"><h2 id="1-åˆè¯†Redis"><a href="#1-åˆè¯†Redis" class="headerlink" title="1.åˆè¯†Redis"></a>1.åˆè¯†Redis</h2><h3 id="1-1-è®¤è¯†NoSql"><a href="#1-1-è®¤è¯†NoSql" class="headerlink" title="1.1 è®¤è¯†NoSql"></a>1.1 è®¤è¯†NoSql</h3><p>é”®å€¼æ•°æ®åº“æ˜¯ä¸€ç§NoSqlæ•°æ®åº“</p>
<table>
<thead>
<tr>
<th align="center">key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1001</td>
<td>{<br>   â€œidâ€:1001,<br>   â€œnameâ€:â€å¼ ä¸‰â€,<br>   â€œageâ€:20,<br>}</td>
</tr>
</tbody></table>
<p>SQLï¼šå…³ç³»å‹æ•°æ®åº“</p>
<p>NoSQLï¼šéå…³ç³»å‹æ•°æ®åº“</p>
<p>SQLä¸NoSQlçš„æ¯”è¾ƒï¼š</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th>SQL</th>
<th>NoSQL</th>
</tr>
</thead>
<tbody><tr>
<td align="center">æ•°æ®ç»“æ„</td>
<td>ç»“æ„åŒ–</td>
<td>éç»“æ„åŒ–ï¼š<br>1.é”®å€¼ç±»å‹(Redis)<br>2.æ–‡æ¡£ç±»å‹(MongoDB)<br>3.åˆ—ç±»å‹(HBase)<br>4.Graphç±»å‹(Neo4j)</td>
</tr>
<tr>
<td align="center">æ•°æ®å…³è”</td>
<td>å…³è”çš„(æ•°æ®æœ‰å…³è”)</td>
<td>æ— å…³è”çš„</td>
</tr>
<tr>
<td align="center">æŸ¥è¯¢æ–¹å¼</td>
<td>SQLæŸ¥è¯¢(SQLè¯­æ³•é€šç”¨)</td>
<td>éSQL(è¯­æ³•ä¸ç»Ÿä¸€)</td>
</tr>
<tr>
<td align="center">äº‹åŠ¡ç‰¹æ€§</td>
<td>ACID</td>
<td>BASE</td>
</tr>
<tr>
<td align="center">å­˜å‚¨æ–¹å¼</td>
<td>ç£ç›˜</td>
<td>å†…å­˜</td>
</tr>
<tr>
<td align="center">æ‰©å±•æ€§</td>
<td>å‚ç›´</td>
<td>æ°´å¹³</td>
</tr>
<tr>
<td align="center">ä½¿ç”¨åœºæ™¯</td>
<td>1.æ•°æ®ç»“æ„å›ºå®š<br>2.ç›¸å…³ä¸šåŠ¡æ•°æ®å®‰å…¨æ€§ã€<br>ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜</td>
<td>1.æ•°æ®ç»“æ„ä¸å›ºå®š<br>2.ç›¸å…³ä¸šåŠ¡æ•°æ®å®‰å…¨æ€§ã€ä¸€è‡´æ€§è¦æ±‚ä¸é«˜<br>3.å¯¹æ€§èƒ½è¦æ±‚</td>
</tr>
</tbody></table>
<h3 id="1-2-è®¤è¯†Redis"><a href="#1-2-è®¤è¯†Redis" class="headerlink" title="1.2 è®¤è¯†Redis"></a>1.2 è®¤è¯†Redis</h3><p>Redisè¯ç”Ÿäº2009å¹´å…¨ç§°æ—¶Remote Dictionary Serverï¼Œè¿œç¨‹è¯å…¸æœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„é”®å€¼å‹NoSQLæ•°æ®åº“ã€‚</p>
<p>ç‰¹å¾ï¼š</p>
<ul>
<li><p>é”®å€¼(key-value)å‹ï¼švalueæ”¯æŒå¤šç§ä¸åŒæ•°æ®ç»“æ„ï¼ŒåŠŸèƒ½ä¸°å¯Œ</p>
</li>
<li><p>å•çº¿ç¨‹ï¼šæ¯ä¸ªå‘½ä»¤å…·å¤‡åŸå­æ€§</p>
</li>
<li><p>ä½å»¶è¿Ÿã€é€Ÿåº¦å¿«ï¼šåŸºäºå†…å­˜ã€IOå¤šè·¯å¤ç”¨ã€è‰¯å¥½çš„ç¼–ç (Cè¯­è¨€å¼€å‘)</p>
</li>
<li><p>æ”¯æŒæ•°æ®æŒä¹…åŒ–</p>
</li>
<li><p>æ”¯æŒä¸»ä»é›†ç¾¤ã€åˆ†ç‰‡é›†ç¾¤</p>
</li>
<li><p>æ”¯æŒå¤šè¯­è¨€å®¢æˆ·ç«¯</p>
</li>
</ul>
<h3 id="1-3-Redisçš„å®‰è£…åŠå…¶é…ç½®"><a href="#1-3-Redisçš„å®‰è£…åŠå…¶é…ç½®" class="headerlink" title="1.3 Redisçš„å®‰è£…åŠå…¶é…ç½®"></a>1.3 Redisçš„å®‰è£…åŠå…¶é…ç½®</h3><p>(<span style="color:red">ä¸è¦çœ‹è¿™ä¸ªæ•™ç¨‹å®‰è£…ï¼Œæœ‰é—®é¢˜</span>)</p>
<p>â€‹		å¤§å¤šä¼ä¸šéƒ½æ˜¯åŸºäºLinuxæœåŠ¡å™¨æ¥éƒ¨ç½²é¡¹ç›®ï¼Œè€Œä¸”Rediså®˜æ–¹ä¹Ÿæ²¡æœ‰æä¾›Windowsç‰ˆæœ¬çš„å®‰è£…åŒ…ã€‚å› æ­¤ä¼šä½¿ç”¨åŸºäºLinuxç³»ç»Ÿæ¥å®‰è£…Redisã€‚</p>
<p>Rediså®˜ç½‘ï¼š<a target="_blank" rel="noopener" href="https://redis.io/">Redis</a></p>
<p>Linuxç‰ˆæœ¬ä¸ºï¼šCentOS7</p>
<p>æ³¨æ„ï¼šä¸‹é¢çš„å®‰è£…Redisæ–¹æ³•ä¸é€‚ç”¨äº<strong>Ubuntu</strong></p>
<p>æ‰“å¼€å‘½ä»¤è¡Œï¼Œä¾æ¬¡è¾“å…¥ä¸€ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è½¬æ¢æˆrootæƒé™</span></span><br><span class="line">su - </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è¾“å…¥å¯†ç </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å®‰è£…gccä¾èµ–</span></span><br><span class="line">yum install -y gcc tcl</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è¿›å…¥åˆ°srcç›®å½•</span></span><br><span class="line">cd /usr/local/src</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ä¸‹è½½redis-6.2.6.tar.gz</span></span><br><span class="line">wget https://download.redis.io/releases/redis-6.2.6.tar.gz</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è§£å‹redis-6.2.6.tar.gz</span></span><br><span class="line">tar -zxvf redis-6.2.6.tar.gz</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è¿›å…¥redis-6.2.6</span></span><br><span class="line">cd redis-6.2.6</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è¿è¡Œç¼–è¯‘å‘½ä»¤</span></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>



<p>é»˜è®¤å®‰è£…è·¯å¾„ä¸º<code>/usr/local/bin</code>ç›®å½•ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll /usr/local/bin</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/01/25/GjaV3w5Yc7x4s8K.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/GjaV3w5Yc7x4s8K.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220707211843362.png"></p>
<p>çœ‹åˆ°è¿™ä¸ªæ ·å­å®‰è£…åŸºæœ¬æˆåŠŸäº†</p>
<p>Redisçš„é…ç½®æ–‡ä»¶ï¼š</p>
<p>é‡æ–°æ‰“å¼€å‘½ä»¤è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">su -</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è¾“å…¥å¯†ç </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è¿›å…¥åˆ°redis-6.2.6ç›®å½•</span></span><br><span class="line">cd /usr/local/src/redis-6.2.6</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å¤‡ä»½redis.conf</span></span><br><span class="line">cp redis.conf redis.conf.bck</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ‰“å¼€redis.confé…ç½®æ–‡ä»¶</span></span><br><span class="line">vi redis.conf</span><br></pre></td></tr></table></figure>



<p>ä¿®æ”¹redis.confæ–‡ä»¶çš„ä¸€äº›é…ç½®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#bind 127.0.0.1 -::ä¼šå¯¼è‡´åªèƒ½åœ¨æœ¬åœ°è®¿é—®ï¼Œä¿®æ”¹ä¸º0.0.0.0å°±å¯ä»¥åœ¨ä»»æ„ipè®¿é—®ï¼Œç”Ÿäº§ç¯å¢ƒä¸è¦è®¾ç½®ä¸º0.0.0.0</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">#å®ˆæŠ¤è¿›ç¨‹ï¼Œä¿®æ”¹ä¸ºyeså³å¯åå°è¿è¡Œ</span><br><span class="line">daemonize yes</span><br><span class="line">#è®¾ç½®å¯†ç ä¸º123456</span><br><span class="line">requirepass 123456</span><br></pre></td></tr></table></figure>

<p>æŸ¥æ‰¾ï¼š<code>/</code>+æ‰€è¦æŸ¥æ‰¾çš„å­—ç¬¦ä¸²ï¼›æŒ‰<code>n</code>å‘ä¸‹æŸ¥æ‰¾ï¼ŒæŒ‰<code>N</code>å‘ä¸ŠæŸ¥æ‰¾</p>
<p>è¾“å…¥<code>i</code>å³å¯ä¿®æ”¹æ•°æ®ï¼Œä¿®æ”¹å®ŒæˆåæŒ‰<code>ESC</code>é€€å‡ºç¼–è¾‘</p>
<p><code>:wq</code>ä¸ºä¿å­˜å¹¶é€€å‡º</p>
<p>é€€å‡ºåï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-server redis.conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æŸ¥çœ‹redisè¿›ç¨‹</span></span><br><span class="line">ps -ef|grep redis </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ€æ­»è¿›ç¨‹</span></span><br><span class="line">kill -9 ç«¯å£å·</span><br></pre></td></tr></table></figure>



<p>æ¥ç€è®¾ç½®å¼€æœºè‡ªå¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ–°å»ºä¸€ä¸ªç³»ç»ŸæœåŠ¡æ–‡ä»¶</span></span><br><span class="line">vi /etc/systemd/system/redis.service</span><br></pre></td></tr></table></figure>

<p>å°†ä¸‹é¢å†…å®¹å…¨éƒ¨å¤åˆ¶åˆ°redis.serviceæ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=redis-server</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/usr/local/bin/redis-server /usr/local/src/redis-6.2.6/redis.conf</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>ä¿å­˜é€€å‡ºåï¼Œ</p>
<p>æ¥ç€:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">é‡è½½ç³»ç»ŸæœåŠ¡</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å¯åŠ¨redis</span></span><br><span class="line">systemctl start redis</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æŸ¥çœ‹redisçŠ¶æ€</span></span><br><span class="line">systemctl status redis</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åœæ­¢redis</span></span><br><span class="line">systemctl stop redis</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">rediså¼€æœºè‡ªå¯</span></span><br><span class="line">systemctl enable redis</span><br></pre></td></tr></table></figure>



</div><div class="story post-story"><h2 id="2-Rediså‘½ä»¤"><a href="#2-Rediså‘½ä»¤" class="headerlink" title="2.Rediså‘½ä»¤"></a>2.Rediså‘½ä»¤</h2><h3 id="2-1-Redisæ•°æ®ç»“æ„ä»‹ç»"><a href="#2-1-Redisæ•°æ®ç»“æ„ä»‹ç»" class="headerlink" title="2.1 Redisæ•°æ®ç»“æ„ä»‹ç»"></a>2.1 Redisæ•°æ®ç»“æ„ä»‹ç»</h3><p>Redisæ˜¯ä¸€ä¸ªkey-valueçš„æ•°æ®åº“ï¼Œkeyä¸€èˆ¬æ˜¯Stringç±»å‹ï¼Œä¸è¿‡valueçš„ç±»å‹å¤šç§å¤šæ ·ï¼š</p>
<table>
<thead>
<tr>
<th align="center">æ•°æ®ç±»å‹</th>
<th>æ ¼å¼</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><span style="color:red">String</span></td>
<td>hello Redis</td>
</tr>
<tr>
<td align="center"><span style="color:red">Hash</span></td>
<td>{name: â€œjackâ€, age: 21}</td>
</tr>
<tr>
<td align="center"><span style="color:red">List</span></td>
<td>[A -&gt; B -&gt; C -&gt; D]</td>
</tr>
<tr>
<td align="center"><span style="color:red">Set</span></td>
<td>{A, B, C}</td>
</tr>
<tr>
<td align="center"><span style="color:red">SortSet</span></td>
<td>{A: 1, B: 2, C: 3}</td>
</tr>
<tr>
<td align="center"><span style="color:red">GEO</span>(åœ°ç†åæ ‡)</td>
<td>{A: (120.3, 30.5)}</td>
</tr>
<tr>
<td align="center"><span style="color:red">BitMap</span></td>
<td>0101001001100101011001000110100101110011</td>
</tr>
<tr>
<td align="center"><span style="color:red">HyperLog</span></td>
<td>0101001001100101011001000110100101110011</td>
</tr>
</tbody></table>
<p>åŸºæœ¬ç±»å‹ï¼šStringã€Hashã€Listã€Setã€SortSet</p>
<p>ç‰¹æ®Šç±»å‹ï¼šGEOã€BitMapã€HyperLog</p>
<h3 id="2-2-Redisé€šç”¨å‘½ä»¤"><a href="#2-2-Redisé€šç”¨å‘½ä»¤" class="headerlink" title="2.2 Redisé€šç”¨å‘½ä»¤"></a>2.2 Redisé€šç”¨å‘½ä»¤</h3><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è§£é‡Š</th>
<th>ä¸¾ä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td>KEYS</td>
<td>æŸ¥çœ‹ç¬¦åˆæ¨¡æ¿çš„æ‰€æœ‰keyï¼Œ<br>ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒè®¾å¤‡ä¸Šä½¿ç”¨(æ•ˆç‡ä½)</td>
<td><code>KEYS *</code>ï¼šæŸ¥çœ‹æ‰€æœ‰key<br><code>KEYS n*</code>ï¼šæŸ¥çœ‹æ‰€æœ‰nå¼€å¤´çš„key</td>
</tr>
<tr>
<td>DEL</td>
<td>åˆ é™¤ä¸€ä¸ªæŒ‡å®škey</td>
<td><code>DEL name</code>ï¼šåˆ é™¤name</td>
</tr>
<tr>
<td>EXISTS</td>
<td>åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨</td>
<td><code>EXISTS name</code>ï¼šå­˜åœ¨è¿”å›1ï¼Œå¦åˆ™è¿”å›0</td>
</tr>
<tr>
<td>EXPIRE</td>
<td>ç»™ä¸€ä¸ªkeyè®¾ç½®æœ‰æ•ˆæœŸï¼Œ<br>æœ‰æ•ˆæœŸåˆ°æœŸkeyä¼šè¢«è‡ªåŠ¨åˆ é™¤</td>
<td><code>EXPIRE name 20</code>ï¼šè®¾ç½®nameçš„æœ‰æ•ˆæœŸä¸º20ç§’</td>
</tr>
<tr>
<td>TTL</td>
<td>æŸ¥çœ‹ä¸€ä¸ªkeyçš„å‰©ä½™æœ‰æ•ˆæœŸ</td>
<td><code>TTL name</code>ï¼šæŸ¥çœ‹nameçš„æœ‰æ•ˆæœŸï¼Œ<br>å¦‚æœè¿”å›-2ï¼Œåˆ™è¯´æ˜åˆ°æœŸäº†<br>å¦‚æœè¿”å›-1ï¼Œåˆ™è¯´æ˜æ°¸ä¹…æœ‰æ•ˆ</td>
</tr>
</tbody></table>
<h3 id="2-3-Stringç±»å‹"><a href="#2-3-Stringç±»å‹" class="headerlink" title="2.3 Stringç±»å‹"></a>2.3 Stringç±»å‹</h3><p>Stringç±»å‹ã€ä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œæ˜¯Redisä¸­æœ€ç®€å•çš„å­˜å‚¨ç±»å‹</p>
<p>å…¶valueæ˜¯å­—ç¬¦ä¸²ï¼Œä¸è¿‡æ ¹æ®å­—ç¬¦ä¸²çš„æ ¼å¼ä¸åŒï¼Œåˆå¯ä»¥åˆ†ç±»ä¸º3ç±»ï¼š</p>
<ul>
<li><p>stringï¼šæ™®é€šå­—ç¬¦ä¸²</p>
</li>
<li><p>intï¼šæ•´æ•°ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</p>
</li>
<li><p>floatï¼šæµ®ç‚¹ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</p>
</li>
</ul>
<p>ä¸ç®¡æ˜¯å“ªç§æ ¼å¼ï¼Œåº•å±‚éƒ½æ˜¯å­—èŠ‚æ•°ç»„å½¢å¼å­˜å‚¨ï¼Œå­—ç¬¦ä¸²ç±»å‹çš„æœ€å¤§ç©ºé—´ä¸èƒ½è¶…è¿‡512m</p>
<table>
<thead>
<tr>
<th align="center">Key</th>
<th align="center">Value</th>
</tr>
</thead>
<tbody><tr>
<td align="center">msg</td>
<td align="center">hello Redis</td>
</tr>
<tr>
<td align="center">num</td>
<td align="center">10</td>
</tr>
<tr>
<td align="center">score</td>
<td align="center">98.5</td>
</tr>
</tbody></table>
<p>Stringç±»å‹å¸¸è§å‘½ä»¤ï¼š</p>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="center">SET key value</td>
<td>æ·»åŠ æˆ–ä¿®æ”¹å·²ç»å­˜åœ¨çš„ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹</td>
<td><code>SET name Jerry</code>ï¼šæŠŠnameçš„valueè®¾ç½®ä¸ºJerry</td>
</tr>
<tr>
<td align="center">GET key</td>
<td>æ ¹æ®keyè·å–Stringç±»å‹çš„value</td>
<td><code>GET name</code>ï¼šè·å–åˆ°valueä¸ºâ€Jerryâ€</td>
</tr>
<tr>
<td align="center">MSET</td>
<td>æ‰¹é‡æ·»åŠ å¤šä¸ªStringç±»å‹çš„é”®å€¼å¯¹</td>
<td><code>MSET score 12.5 age 18</code>ï¼šæ·»åŠ å¤šä¸ªé”®å€¼å¯¹</td>
</tr>
<tr>
<td align="center">MGET</td>
<td>æ ¹æ®å¤šä¸ªkeyè·å–å¤šä¸ªStringç±»å‹çš„value</td>
<td><code>MGET name score age</code>ï¼šå¾—åˆ°å¤šä¸ªvalueä¸ºâ€Jreeyâ€ â€œ12.5â€ â€œ18â€</td>
</tr>
<tr>
<td align="center">INCR</td>
<td>è®©ä¸€ä¸ªæ•´å‹çš„keyè‡ªå¢1</td>
<td><code>INCR age</code>ï¼šageçš„valueåŠ 1ï¼Œç”±18å˜ä¸º19</td>
</tr>
<tr>
<td align="center">INCRBY</td>
<td>è®©ä¸€ä¸ªæ•´å‹çš„keyè‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿</td>
<td><code>INCRBY age 2</code>ï¼šageçš„valueåŠ 2ï¼Œç”±19å˜ä¸º21</td>
</tr>
<tr>
<td align="center">INCRBYFLOAT</td>
<td>è®©ä¸€ä¸ªæµ®ç‚¹ç±»å‹çš„æ•°å­—è‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿</td>
<td><code>INCRBYFLOAT score 0.5</code>ï¼šscoreçš„valueåŠ 0.5ï¼Œç”±12.5å˜ä¸º13.0</td>
</tr>
<tr>
<td align="center">SETNX</td>
<td>æ·»åŠ ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹ï¼Œ<br>å‰ææ˜¯è¿™ä¸ª<span style="color:red">key</span>ä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ(æ–°å¢æ•ˆæœ)</td>
<td><code>SETNX name Tom</code>ï¼šä¸æ‰§è¡Œï¼Œè¿”å›0<br><code>SETNX k1 v1</code>ï¼šæ‰§è¡Œï¼Œè¿”å›1</td>
</tr>
<tr>
<td align="center">SETEX</td>
<td>æ·»åŠ ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹ï¼Œå¹¶ä¸”æŒ‡å®šæœ‰æ•ˆæœŸ</td>
<td><code>SETEX name 10 jerry </code>ï¼šæ·»åŠ é”®å€¼å¯¹ï¼Œå¹¶å°†æœ‰æ•ˆæœŸè®¾ç½®ä¸º10ç§’</td>
</tr>
</tbody></table>
<h3 id="2-4-Keyçš„å±‚çº§æ ¼å¼"><a href="#2-4-Keyçš„å±‚çº§æ ¼å¼" class="headerlink" title="2.4 Keyçš„å±‚çº§æ ¼å¼"></a>2.4 Keyçš„å±‚çº§æ ¼å¼</h3><p>Redisæ²¡æœ‰ç±»ä¼¼äºMySQLä¸­çš„<code>Table</code>è¡¨çš„æ¦‚å¿µ</p>
<p>Redisçš„Keyå…è®¸æœ‰å¤šä¸ªå•è¯å½¢æˆå±‚çº§ç»“æ„ï¼Œå¤šä¸ªå•è¯ä¹‹é—´ç”¨<code>:</code>éš”å¼€ï¼Œæ ¼å¼(ä¸å›ºå®š)å¦‚ä¸‹ï¼š</p>
<p><code>é¡¹ç›®å:ä¸šåŠ¡å:ç±»å‹:id</code></p>
<p>ä¾‹å¦‚é¡¹ç›®åå«<code>demo</code>ï¼Œæœ‰<code>user</code>å’Œ<code>book</code>ä¸¤ç§ä¸åŒç±»å‹çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å®šä¹‰Keyï¼š</p>
<ul>
<li><p>userç›¸å…³çš„Keyï¼š<code>demo:user:1</code></p>
</li>
<li><p>bookç›¸å…³çš„Keyï¼š<code>demo:book:1</code></p>
</li>
</ul>
<p>å¦‚æœValueæ˜¯ä¸€ä¸ªjavaå¯¹è±¡ï¼Œä¾‹å¦‚ä¸€ä¸ªUserå¯¹è±¡ï¼Œåˆ™å¯ä»¥å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå­—ç¬¦ä¸²åå­˜å‚¨ï¼š</p>
<table>
<thead>
<tr>
<th align="center">Key</th>
<th align="center">Value</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>demo:user:1</code></td>
<td align="center">{â€œidâ€: 1, â€œnameâ€: â€œJerryâ€, â€œageâ€: 18}</td>
</tr>
<tr>
<td align="center"><code>demo:book:1</code></td>
<td align="center">{â€œidâ€: 1, â€œnameâ€: â€œBOOKâ€, â€œpriceâ€: 15}</td>
</tr>
</tbody></table>
<p>æ’å…¥æ“ä½œ(æ³¨æ„ï¼šValueå€¼è¦åŠ <code>&#39;&#39;</code>)ï¼š</p>
<ul>
<li><p><code>set demo:user:1 &#39;&#123;&quot;id&quot;: 1, &quot;name&quot;: &quot;Jerry&quot;, &quot;age&quot;: 18&#125;&#39;</code></p>
</li>
<li><p><code>set demo:book:1 &#39;&#123;&quot;id&quot;: 1, &quot;name&quot;: &quot;BOOK&quot;, &quot;price&quot;: 15&#125;&#39;</code></p>
</li>
</ul>
<p>æ‰“å¼€å›¾å½¢ç•Œé¢å®¢æˆ·ç«¯æŸ¥çœ‹ï¼š</p>
<p><img src="https://s2.loli.net/2022/07/08/vckFyG2VYdjzhOS.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/08/vckFyG2VYdjzhOS.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220708185626850"></p>
<h3 id="2-5-Hashç±»å‹"><a href="#2-5-Hashç±»å‹" class="headerlink" title="2.5 Hashç±»å‹"></a>2.5 Hashç±»å‹</h3><p>Hashç±»å‹ï¼Œä¹Ÿå«æ•£åˆ—ï¼Œå…¶valueæ˜¯ä¸€ä¸ªæ— åºå­—å…¸ï¼Œç±»ä¼¼äºjavaä¸­çš„HashMapç»“æ„</p>
<p>Stringç»“æ„æ˜¯å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå­—ç¬¦ä¸²åå­˜å‚¨ï¼Œå½“éœ€è¦ä¿®æ”¹å¯¹è±¡æŸä¸ªå­—æ®µæ—¶å¾ˆä¸æ–¹ä¾¿(éœ€è¦ä¿®æ”¹æ•´ä¸ªå­—ç¬¦ä¸²)ï¼š</p>
<table>
<thead>
<tr>
<th align="center">Key</th>
<th align="center">Value</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>demo:user:1</code></td>
<td align="center">{â€œidâ€: 1, â€œnameâ€: â€œJerryâ€, â€œageâ€: 18}</td>
</tr>
<tr>
<td align="center"><code>demo:user:2</code></td>
<td align="center">{â€œidâ€: 2, â€œnameâ€: â€œTomâ€, â€œpriceâ€: 20}</td>
</tr>
</tbody></table>
<p>è€ŒHashç»“æ„å¯ä»¥å°†å¯¹è±¡ä¸­æ¯ä¸ªå­—æ®µç‹¬ç«‹å­˜å‚¨ï¼Œå¯ä»¥é’ˆå¯¹å•ä¸ªå­—æ®µåšCRUDï¼š</p>
<table>
    <tr align="center">         
        <th rowspan="2">Key</th>         
        <th colspan="2">Value</th>
    </tr>
    <tr align="center">                 
        <td>field</td>
        <td>value</td>
    </tr>
    <tr align="center">         
        <td rowspan="2">demo:user:1</td>         
        <td>name</td>
        <td>Jerry</td>
    </tr>
    <tr align="center">                 
        <td>age</td>
        <td>18</td>
    </tr>
    <tr align="center">         
        <td rowspan="2">demo:user:2</td>         
        <td>name</td>
        <td>Tom</td>
    </tr>
    <tr align="center">                 
        <td>age</td>
        <td>20</td>
    </tr>
</table>







<p>Hashç±»å‹å¸¸è§å‘½ä»¤ï¼š</p>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="center">HSET key field value</td>
<td>æ·»åŠ æˆ–ä¿®æ”¹hashç±»å‹keyçš„fieldçš„å€¼</td>
<td><code>HSET demo:user:2 name LiHua</code>ï¼šæŠŠnameçš„valueè®¾ç½®ä¸ºLihua</td>
</tr>
<tr>
<td align="center">HGET key field</td>
<td>è·å–ä¸€ä¸ªhashç±»å‹keyçš„fieldçš„å€¼</td>
<td><code>HGET demo:user:2 name</code>ï¼šè·å–åˆ°valueä¸ºâ€LiHuaâ€</td>
</tr>
<tr>
<td align="center">HMSET</td>
<td>æ‰¹é‡æ·»åŠ å¤šä¸ªhashç±»å‹keyçš„fieldçš„å€¼</td>
<td><code>HMSET demo:user:3 name LiLei age 22</code>ï¼šæ·»åŠ å¤šä¸ªfieldçš„å€¼</td>
</tr>
<tr>
<td align="center">HMGET</td>
<td>æ‰¹é‡è·å–æ ¹æ®å¤šä¸ªhashç±»å‹keyçš„fieldçš„å€¼</td>
<td><code>HMGET demo:user:3 name age</code>ï¼šå¾—åˆ°å¤šä¸ªfieldçš„å€¼ä¸ºâ€LiLeiâ€ â€œ22â€</td>
</tr>
<tr>
<td align="center">HGETALL</td>
<td>è·å–ä¸€ä¸ªhashç±»å‹çš„keyä¸­çš„æ‰€æœ‰çš„fieldå’Œvalue</td>
<td><code>HGETALL demo:user:3</code>ï¼šè·å–åˆ°keyä¸­æ‰€æœ‰çš„fieldå’Œvalue</td>
</tr>
<tr>
<td align="center">HKEYS</td>
<td>è·å–ä¸€ä¸ªhashç±»å‹çš„keyä¸­çš„æ‰€æœ‰çš„field</td>
<td><code>HKEYS demo:user:3</code>ï¼šè·å–keyä¸­æ‰€æœ‰çš„field</td>
</tr>
<tr>
<td align="center">HVALS</td>
<td>è·å–ä¸€ä¸ªhashç±»å‹çš„keyä¸­çš„æ‰€æœ‰çš„value</td>
<td><code>HVALS demo:user:3</code>ï¼šè·å–keyä¸­æ‰€æœ‰çš„value</td>
</tr>
<tr>
<td align="center">HINCRBY</td>
<td>è®©ä¸€ä¸ªhashç±»å‹çš„keyçš„å­—æ®µè‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿</td>
<td><code>HINCRBY demo:user:3 age 2</code>ï¼šageçš„valueåŠ 2ï¼Œç”±22å˜ä¸º24</td>
</tr>
<tr>
<td align="center">HSETNX</td>
<td>æ·»åŠ ä¸€ä¸ªhashç±»å‹çš„keyçš„fieldå€¼ï¼Œ<br>å‰ææ˜¯è¿™ä¸ª<span style="color:red">field</span>ä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ(æ–°å¢æ•ˆæœ)</td>
<td><code>HSETNX demo:user:3 name XXX</code>ï¼šå­˜åœ¨fieldå€¼ä¸æ‰§è¡Œï¼Œè¿”å›0<br><code>HSETNX demo:user:3 sex man</code>ï¼šä¸å­˜åœ¨fieldå€¼æ‰§è¡Œï¼Œè¿”å›1</td>
</tr>
</tbody></table>
<h3 id="2-6-Listç±»å‹"><a href="#2-6-Listç±»å‹" class="headerlink" title="2.6 Listç±»å‹"></a>2.6 Listç±»å‹</h3><p>Redisä¸­çš„Listç±»å‹ä¸javaä¸­çš„LinkListç±»ä¼¼ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ï¼Œæ—¢å¯ä»¥æ”¯æŒæ­£å‘æ£€ç´¢ä¹Ÿå¯ä»¥æ”¯æŒåå‘æ£€ç´¢ã€‚</p>
<p>ç‰¹å¾ä¸LinkListä¹Ÿç±»ä¼¼ï¼š</p>
<ul>
<li><p>æœ‰åº</p>
</li>
<li><p>å…ƒç´ å¯ä»¥é‡å¤</p>
</li>
<li><p>æ’å…¥å’Œåˆ é™¤å¿«</p>
</li>
<li><p>æŸ¥è¯¢é€Ÿåº¦ä¸€èˆ¬</p>
</li>
</ul>
<p>å¸¸ç”¨æ¥å­˜å‚¨ä¸€ä¸ªæœ‰åºæ•°æ®ï¼Œå¦‚ï¼šè¯„è®ºåˆ—è¡¨ã€ç‚¹èµåˆ—è¡¨ç­‰</p>
<p>Listç±»å‹çš„å¸¸è§å‘½ä»¤ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>LPUSH key element</td>
<td>å‘åˆ—è¡¨å·¦ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </td>
<td><code>LPUSH user 1 2 3</code>ï¼š<br>è¡¨ä¸­ä»ç¬¬ä¸€ä½ä¾æ¬¡ä¸º â€œ3â€ â€œ2â€ â€œ1â€</td>
</tr>
<tr>
<td>LPOP key</td>
<td>ç§»é™¤å¹¶è¿”å›åˆ—è¡¨å·¦ä¾§çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ²¡æœ‰åˆ™è¿”å›nil</td>
<td>LPOP user 1</td>
</tr>
<tr>
<td>RPUSH key element</td>
<td>å‘åˆ—è¡¨å³ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </td>
<td><code>RPUSH user 4 5 6</code>ï¼š<br/>è¡¨ä¸­ä»ç¬¬ä¸€ä½ä¾æ¬¡ä¸º â€œ4â€ â€œ5â€ â€œ6â€</td>
</tr>
<tr>
<td>RPOP key</td>
<td>ç§»é™¤å¹¶è¿”å›åˆ—è¡¨å³ä¾§çš„ç¬¬ä¸€ä¸ªå…ƒç´ </td>
<td></td>
</tr>
<tr>
<td>LRANGE key star end</td>
<td>è¿”å›ä¸€æ®µè§’æ ‡èŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ </td>
<td><code>LRANGE 1 star 2</code>ï¼šä»0å¼€å§‹ï¼Œ<br>è·å–åˆ°1~2ä¹‹é—´çš„å…ƒç´ </td>
</tr>
<tr>
<td>BLPOP</td>
<td>ä¸LPOPç±»ä¼¼ï¼Œ<br>åªä¸è¿‡åœ¨æ²¡æœ‰å…ƒç´ æ—¶ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œ<br>è€Œä¸æ˜¯ç›´æ¥è¿”å›nil</td>
<td><code>BLPOP user2 1 100</code>ï¼š<br>ç§»é™¤å¹¶è¿”å›åˆ°å·¦ä¾§çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œ<br>æ²¡æœ‰åˆ™ç­‰å¾…100ç§’ï¼Œè¶…æ—¶è¿”å›nil</td>
</tr>
<tr>
<td>BRPOP</td>
<td>ä¸RPOPç±»ä¼¼ï¼Œ<br/>åªä¸è¿‡åœ¨æ²¡æœ‰å…ƒç´ æ—¶ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œ<br/>è€Œä¸æ˜¯ç›´æ¥è¿”å›nil</td>
<td></td>
</tr>
</tbody></table>
<p>Listç»“æ„æ¨¡æ‹Ÿä¸€ä¸ªæ ˆ</p>
<ul>
<li><p>å…¥å£å’Œå‡ºå£åœ¨åŒä¸€è¾¹</p>
</li>
<li><p>å¦‚ï¼š<code>LPUSH</code>å’Œ<code>LPOP</code>æˆ–è€… <code>RPUSH</code>å’Œ<code>RPOP</code></p>
</li>
</ul>
<p>Listç»“æ„æ¨¡æ‹Ÿä¸€ä¸ªé˜Ÿåˆ—</p>
<ul>
<li><p>å…¥å£å’Œå‡ºå£ä¸åœ¨åŒä¸€è¾¹</p>
</li>
<li><p>å¦‚ï¼š<code>LPUSH</code>å’Œ<code>RPOP</code>  æˆ–è€… <code>RPUSH</code>å’Œ<code>LPOP</code></p>
</li>
</ul>
<p>Listç»“æ„æ¨¡æ‹Ÿä¸€ä¸ªé˜»å¡é˜Ÿåˆ—</p>
<ul>
<li>å…¥å£å’Œå‡ºå£ä¸åœ¨åŒä¸€è¾¹</li>
<li>å‡ºé˜Ÿé‡‡ç”¨<code>BLPOP</code>æˆ–è€…<code>BRPOP</code></li>
<li>å¦‚ï¼š<code>LPUSH</code>å’Œ<code>BRPOP</code>  æˆ–è€… <code>RPUSH</code>å’Œ<code>BLPOP</code></li>
</ul>
<h3 id="2-7-Setç±»å‹"><a href="#2-7-Setç±»å‹" class="headerlink" title="2.7 Setç±»å‹"></a>2.7 Setç±»å‹</h3><p>Redisçš„Setç»“æ„ä¸Javaä¸­çš„Hashsetç±»ä¼¼ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªvalueä¸ºnullçš„HashMapã€‚å› ä¸ºä¹Ÿæ˜¯ä¸€ä¸ªhashè¡¨ï¼Œå› æ­¤å…·å¤‡ä¸Hashsetç±»ä¼¼çš„ç‰¹å¾ï¼š</p>
<ul>
<li>æ— åº</li>
<li>å…ƒç´ ä¸å¯é‡å¤</li>
<li>æŸ¥æ‰¾å¿«</li>
<li>æ”¯æŒäº¤é›†ã€å¹¶é›†ã€å·®é›†ç­‰åŠŸèƒ½</li>
</ul>
<p>Setç±»å‹çš„å¸¸è§å‘½ä»¤ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>SADD key member</td>
<td>å‘setä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </td>
<td><code>SADD s1 a b c</code></td>
</tr>
<tr>
<td>SREM key member</td>
<td>ç§»é™¤setä¸­çš„æŒ‡å®šå…ƒç´ </td>
<td><code>SREM s1 a</code></td>
</tr>
<tr>
<td>SCARD key</td>
<td>è¿”å›setä¸­å…ƒç´ çš„ä¸ªæ•°</td>
<td><code>SCARD s1</code></td>
</tr>
<tr>
<td>SISMEMBER key member</td>
<td>åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºsetä¸­</td>
<td><code>SISMEMBER s1 a</code></td>
</tr>
<tr>
<td>SMEMBERS</td>
<td>è·å–setä¸­çš„æ‰€æœ‰å…ƒç´ </td>
<td><code>SMEMBERS</code></td>
</tr>
<tr>
<td>SINTER key1 key2</td>
<td>æ±‚key1ä¸key2çš„<span style="color:red">äº¤é›†</span></td>
<td></td>
</tr>
<tr>
<td>SDIFF key1 key2</td>
<td>æ±‚key1ä¸key2çš„<span style="color:red">å·®é›†</span></td>
<td></td>
</tr>
<tr>
<td>SUNION key1 key2</td>
<td>æ±‚key1ä¸key2çš„<span style="color:red">å¹¶é›†</span></td>
<td></td>
</tr>
</tbody></table>
<h3 id="2-8-SortedSetç±»å‹"><a href="#2-8-SortedSetç±»å‹" class="headerlink" title="2.8 SortedSetç±»å‹"></a>2.8 SortedSetç±»å‹</h3><p>Redisçš„SortedSetæ˜¯ä¸€ä¸ªå¯æ’åºçš„seté›†åˆï¼Œä¸javaä¸­çš„TreeSetæœ‰äº›ç±»ä¼¼ï¼Œä½†åº•å±‚æ•°æ®ç»“æ„å´å·®åˆ«å¾ˆå¤§Sortedsetä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¸¦æœ‰ä¸€ä¸ªscoreå±æ€§ï¼Œå¯ä»¥åŸºäºscoreå±æ€§å¯¹å…ƒç´ æ’åºï¼Œåº•å±‚çš„å®ç°æ˜¯ä¸€ä¸ªè·³è¡¨(SkipList)åŠ hashè¡¨ã€‚<br>SortedSetå…·å¤‡ä¸‹åˆ—ç‰¹æ€§ï¼š</p>
<ul>
<li><p>å¯æ’åº</p>
</li>
<li><p>å…ƒç´ ä¸é‡å¤</p>
</li>
<li><p>æŸ¥è¯¢é€Ÿåº¦å¿«</p>
</li>
</ul>
<p>å› ä¸ºSortedsetçš„å¯æ’åºç‰¹æ€§ï¼Œç»å¸¸è¢«ç”¨æ¥<strong>å®ç°æ’è¡Œæ¦œ</strong>è¿™æ ·çš„åŠŸèƒ½ã€‚</p>
<p>SortedSetç±»å‹çš„å¸¸è§å‘½ä»¤ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>ZADD key score member</td>
<td>æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ åˆ°sorted setï¼Œ<br>å¦‚æœå·²ç»å­˜åœ¨åˆ™æ›´æ–°å…¶scoreå€¼</td>
<td><code>ZADD SSet 85 Tom 98 Jerry 77 Rose 78 Jack</code>ï¼š<br>å‘SSetä¸­æ·»åŠ å…ƒç´ ï¼Œå¹¶æŒ‰ç…§å‡åºæ’åˆ—</td>
</tr>
<tr>
<td>ZREM key member</td>
<td>åˆ é™¤sorted setä¸­çš„ä¸€ä¸ªæŒ‡å®šå…ƒç´ </td>
<td><code>ZREM SSet Tom</code>ï¼šåˆ é™¤Tom</td>
</tr>
<tr>
<td>ZSCORE key member</td>
<td>è·å–sorted setä¸­çš„æŒ‡å®šå…ƒç´ çš„scoreå€¼</td>
<td></td>
</tr>
<tr>
<td>ZRANK key member</td>
<td>è·å–sorted set ä¸­çš„æŒ‡å®šå…ƒç´ å‡åºçš„æ’å</td>
<td><code>ZRANK SSet Rose</code>ï¼š<br>æŒ‰ç…§å‡åºçš„åºåˆ—ï¼Œä»0å¼€å§‹ï¼Œ<br>è¿”å›Roseçš„æ’å</td>
</tr>
<tr>
<td>Z<span style="color:red">REV</span>RANK key member</td>
<td>è·å–sorted set ä¸­çš„æŒ‡å®šå…ƒç´ é™åºçš„æ’å</td>
<td><code>ZRANK SSet Rose</code>ï¼š<br>æŒ‰ç…§é™åºçš„åºåˆ—ï¼Œä»0å¼€å§‹ï¼Œ<br>è¿”å›Roseçš„æ’å</td>
</tr>
<tr>
<td>ZCARD key</td>
<td>è·å–sorted setä¸­çš„å…ƒç´ ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td>ZCOUNT key min max</td>
<td>ç»Ÿè®¡scoreå€¼åœ¨ç»™å®šèŒƒå›½å†…çš„æ‰€æœ‰å…ƒç´ çš„ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td>ZINCRBY key increment member</td>
<td>è®©sorted setä¸­çš„æŒ‡å®šå…ƒç´ è‡ªå¢ï¼Œ<br>æ­¥é•¿ä¸ºæŒ‡å®šçš„incrementå€¼</td>
<td></td>
</tr>
<tr>
<td>ZRANGE key min max</td>
<td>æŒ‰ç…§scoreå‡åºæ’åºåï¼Œè·å–æŒ‡å®šæ’åèŒƒå›´å†…çš„å…ƒç´ </td>
<td><code>ZCOUNT SSet 0 2</code>ï¼šæŒ‰ç…§å‡åºçš„æƒ…å†µï¼Œ<br/>è·å–0~2èŒƒå›´çš„å…ƒç´ </td>
</tr>
<tr>
<td>Z<span style="color:red">REV</span>RANGE key min max</td>
<td>æŒ‰ç…§scoreçš„é™åºæ’åºåï¼Œè·å–æŒ‡å®šæ’åèŒƒå›´å†…çš„å…ƒç´ </td>
<td><code>ZCOUNT SSet 0 2</code>ï¼šæŒ‰ç…§é™åºçš„æƒ…å†µï¼Œ<br>è·å–0~2èŒƒå›´çš„å…ƒç´ </td>
</tr>
<tr>
<td>ZRANGEBYSCORE key min  max</td>
<td>æŒ‰ç…§scoreæ’åºåï¼Œè·å–æŒ‡å®šscoreèŒƒå›½å†…çš„å…ƒç´ </td>
<td><code>ZRANGEBYSCORE SSet 0 80</code>ï¼š<br>è¿”å›0~80åˆ†æ•°çš„å…ƒç´ </td>
</tr>
<tr>
<td>ZDIFFã€ZINTERã€ZUNION</td>
<td>æ±‚å·®é›†ã€äº¤é›†ã€å¹¶é›†</td>
<td></td>
</tr>
</tbody></table>
<p>æ³¨æ„ï¼šæ‰€æœ‰æ’åé»˜è®¤éƒ½æ˜¯å‡åºï¼Œå¦‚æœé™åºåˆ™åœ¨å‘½ä»¤çš„Zåé¢æ·»åŠ <span style="color:red">REV</span>å³å¯</p>
<p>ä¾‹å¦‚ï¼šZ<span style="color:red">REV</span>RANK</p>
</div><div class="story post-story"><h2 id="3-Redisçš„javaå®¢æˆ·ç«¯"><a href="#3-Redisçš„javaå®¢æˆ·ç«¯" class="headerlink" title="3.Redisçš„javaå®¢æˆ·ç«¯"></a>3.Redisçš„javaå®¢æˆ·ç«¯</h2><p><a target="_blank" rel="noopener" href="https://redis.io/docs/clients/">Rediså®˜ç½‘</a>ä¸­æä¾›äº†å„ç§è¯­è¨€çš„å®¢æˆ·ç«¯</p>
<p>Javaï¼š</p>
<blockquote>
<p><code>Jedis</code>ï¼šä»¥Rediså‘½ä»¤ä½œä¸ºæ–¹æ³•åç§°ï¼Œå­¦ä¹ æˆæœ¬ä½ï¼Œç®€å•å®ç”¨ä½†æ˜¯Jediså®ä¾‹æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹éœ€è¦åŸºäºè¿æ¥æ± æ¥ä½¿ç”¨</p>
<p><code>Lettuce</code>ï¼šåŸºäºNettyå®ç°çš„ï¼Œæ”¯æŒåŒæ­¥ã€å¼‚æ­¥å’Œå“åº”å¼ç¼–ç¨‹æ–¹å¼ï¼Œå¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ”¯æŒRedisçš„å“¨å…µæ¨¡å¼ã€é›†ç¾¤æ¨¡å¼å’Œç®¡é“æ¨¡å¼</p>
<p><code>Redisson</code>ï¼šæ˜¯ä¸€ä¸ªåŸºäºRediså®ç°çš„åˆ†å¸ƒå¼ã€å¯ä¼¸ç¼©çš„Javaæ•°æ®ç»“æ„é›†åˆã€‚åŒ…å«äº†è¯¸å¦‚Mapã€Queueã€LockSemaphoreã€Atomiclongç­‰å¼ºå¤§åŠŸèƒ½</p>
<p>å…¶ä¸­Springæ•´åˆäº†<code>Jedis</code>å’Œ<code>Lettuce</code>ï¼Œåªéœ€å¯¼å…¥åæ ‡<code>Spring Data Redis</code></p>
</blockquote>
<h3 id="3-1-Jediså¿«é€Ÿå…¥é—¨"><a href="#3-1-Jediså¿«é€Ÿå…¥é—¨" class="headerlink" title="3.1 Jediså¿«é€Ÿå…¥é—¨"></a>3.1 Jediså¿«é€Ÿå…¥é—¨</h3><p>Jedisï¼š<a target="_blank" rel="noopener" href="https://github.com/redis/jedis">Jediså®˜ç½‘</a></p>
<p>å¼•å…¥jedisä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>å®Œæ•´ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    	<span class="comment">&lt;!-- jedisä¾èµ– --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- æµ‹è¯•ä¾èµ– --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>       </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>ä»¥ä¸‹åœ¨<code>Test</code>ä¸­è¿›è¡Œï¼š</p>
<ol>
<li>å»ºç«‹è¿æ¥</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BeforeEach</span> <span class="comment">//åœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//å»ºç«‹è¿æ¥</span></span><br><span class="line">        jedis = <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//è®¾ç½®å¯†ç </span></span><br><span class="line">        jedis.auth(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="comment">//é€‰æ‹©åº“</span></span><br><span class="line">        jedis.select(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<ol start="2">
<li>æµ‹è¯•Stringç±»å‹</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">    jedis.set(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">    System.out.println(jedis.get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>é‡Šæ”¾èµ„æº</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AfterEach</span> <span class="comment">//åœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (jedis != <span class="literal">null</span>)&#123;</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å®Œæ•´æµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Jedis jedis;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span> <span class="comment">//åœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//å»ºç«‹è¿æ¥</span></span><br><span class="line">        jedis = <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//è®¾ç½®å¯†ç </span></span><br><span class="line">        jedis.auth(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="comment">//é€‰æ‹©åº“</span></span><br><span class="line">        jedis.select(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">        jedis.set(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">        System.out.println(jedis.get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span> &#123;</span><br><span class="line">        jedis.hset(<span class="string">&quot;demo:user:2&quot;</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line">        jedis.hset(<span class="string">&quot;demo:user:2&quot;</span>,<span class="string">&quot;age&quot;</span>,<span class="string">&quot;18&quot;</span>);</span><br><span class="line">        Map&lt;String, String&gt; map = jedis.hgetAll(<span class="string">&quot;demo:user:2&quot;</span>);</span><br><span class="line">        System.out.println(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span> <span class="comment">//åœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (jedis != <span class="literal">null</span>)&#123;</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>jedisä½¿ç”¨çš„åŸºæœ¬æ­¥éª¤ï¼š</p>
<blockquote>
<ol>
<li><p>å¼•å…¥ä¾èµ–</p>
</li>
<li><p>åˆ›å»ºjediså¯¹è±¡ï¼Œå»ºç«‹è¿æ¥</p>
</li>
<li><p>ä½¿ç”¨jedisçš„æ–¹æ³•åä¸Rediså‘½ä»¤ä¸€è‡´</p>
</li>
<li><p>é‡Šæ”¾èµ„æº</p>
</li>
</ol>
</blockquote>
<h3 id="3-2-Jedisçš„è¿æ¥æ± "><a href="#3-2-Jedisçš„è¿æ¥æ± " class="headerlink" title="3.2 Jedisçš„è¿æ¥æ± "></a>3.2 Jedisçš„è¿æ¥æ± </h3><p>Jedisæœ¬èº«çº¿ç¨‹æ˜¯ä¸å®‰å…¨çš„ï¼Œå¹¶ä¸”é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯è¿æ¥ä¼šæœ‰æ€§èƒ½æŸè€—ï¼Œå› æ­¤æ¨èä½¿ç”¨Jedisè¿æ¥æ± æ›¿ä»£Jedisçš„ç›´è¿æ–¹æ³•</p>
<p>åˆ›å»º<code>JedisConnectionFactory</code>å·¥å…·ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisConnectionFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> JedisPool jedisPool;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//é…ç½®è¿æ¥æ± </span></span><br><span class="line">        <span class="type">JedisPoolConfig</span> <span class="variable">jedisPoolConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">        <span class="comment">//æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">        jedisPoolConfig.setMaxTotal(<span class="number">8</span>);</span><br><span class="line">        <span class="comment">//æœ€å¤§ç©ºé—²è¿æ¥</span></span><br><span class="line">        jedisPoolConfig.setMaxIdle(<span class="number">8</span>);</span><br><span class="line">        <span class="comment">//æœ€å°ç©ºé—²è¿æ¥</span></span><br><span class="line">        jedisPoolConfig.setMinIdle(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//ç­‰å¾…æ—¶é•¿</span></span><br><span class="line">        jedisPoolConfig.setMaxWaitMillis(<span class="number">1000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//åˆ›å»ºè¿æ¥æ± å¯¹è±¡</span></span><br><span class="line">        jedisPool = <span class="keyword">new</span> <span class="title class_">JedisPool</span>(jedisPoolConfig, </span><br><span class="line">                <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">                <span class="number">6379</span>, </span><br><span class="line">                <span class="number">1000</span>,</span><br><span class="line">                <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title function_">getJedis</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jedisPool.getResource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æµ‹è¯•ç±»ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Jedis jedis;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span> <span class="comment">//åœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//å»ºç«‹è¿æ¥</span></span><br><span class="line">        jedis = JedisConnectionFactory.getJedis();</span><br><span class="line">        <span class="comment">//é€‰æ‹©åº“</span></span><br><span class="line">        jedis.select(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span> &#123;</span><br><span class="line">        jedis.hset(<span class="string">&quot;demo:user:2&quot;</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line">        jedis.hset(<span class="string">&quot;demo:user:2&quot;</span>,<span class="string">&quot;age&quot;</span>,<span class="string">&quot;18&quot;</span>);</span><br><span class="line">        Map&lt;String, String&gt; map = jedis.hgetAll(<span class="string">&quot;demo:user:2&quot;</span>);</span><br><span class="line">        System.out.println(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span> <span class="comment">//åœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (jedis != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//closeæ–¹æ³•å½“æ£€æµ‹åˆ°æ˜¯è¿æ¥æ± æ—¶ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„å…³é—­è¿æ¥ï¼Œè€Œæ˜¯å°†å¯¹è±¡å½’è¿˜ç»™è¿æ¥æ± </span></span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-3-åˆè¯†SpringDataRedis"><a href="#3-3-åˆè¯†SpringDataRedis" class="headerlink" title="3.3 åˆè¯†SpringDataRedis"></a>3.3 åˆè¯†SpringDataRedis</h3><p>SpringDataæ˜¯Springä¸­æ•°æ®æ“ä½œçš„æ¨¡å—ï¼ŒåŒ…å«å¯¹å„ç§æ•°æ®åº“çš„é›†æˆï¼Œå…¶ä¸­å¯¹Redisçš„é›†æˆæ¨¡å—å°±å«åš<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-data-redis">SpringDataRedis</a></p>
<blockquote>
<ul>
<li>æä¾›äº†å¯¹ä¸åŒRediså®¢æˆ·ç«¯çš„æ•´åˆ ï¼ˆLettuceå’ŒJedisï¼‰</li>
<li>æä¾›äº†RedisTemplateç»Ÿä¸€APIæ¥æ“ä½œRedis</li>
<li>æ”¯æŒRedisçš„å‘å¸ƒè®¢é˜…æ¨¡å‹</li>
<li>æ”¯æŒRediså“¨å…µå’ŒRedisé›†ç¾¤</li>
<li>æ”¯æŒåŸºäºLettuceçš„å“åº”å¼ç¼–ç¨‹</li>
<li>æ”¯æŒåŸºäºJDKã€JSONã€å­—ç¬¦ä¸²ã€Springå¯¹è±¡çš„æ•°æ®åºåˆ—åŒ–åŠååºåˆ—åŒ–</li>
<li>æ”¯æŒåŸºäºRedisçš„JDKCollectionå®ç°</li>
</ul>
</blockquote>
<p>SpringDataRedisä¸­æä¾›äº†RedisTemplateå·¥å…·ç±»ï¼Œå…¶ä¸­å°è£…äº†å„ç§å¯¹Redisçš„æ“ä½œã€‚å¹¶ä¸”å°†ä¸åŒæ•°æ®ç±»å‹çš„æ“ä½œAPIå°è£…åˆ°äº†ä¸åŒçš„ç±»å‹ä¸­ï¼š</p>
<table>
<thead>
<tr>
<th align="center">API</th>
<th align="center">è¿”å›å€¼ç±»å‹</th>
<th align="center">è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><span style="color:red">redisTemplate</span>.opsForValue()</td>
<td align="center">ValueOperations</td>
<td align="center">æ“ä½œStringç±»å‹æ•°æ®</td>
</tr>
<tr>
<td align="center"><span style="color:red">redisTemplate</span>.opsForHash()</td>
<td align="center">HashOperations</td>
<td align="center">æ“ä½œHashç±»å‹æ•°æ®</td>
</tr>
<tr>
<td align="center"><span style="color:red">redisTemplate</span>.opsForList()</td>
<td align="center">ListOperations</td>
<td align="center">æ“ä½œListç±»å‹æ•°æ®</td>
</tr>
<tr>
<td align="center"><span style="color:red">redisTemplate</span>.opsForSet()</td>
<td align="center">SetOperations</td>
<td align="center">æ“ä½œSetç±»å‹æ•°æ®</td>
</tr>
<tr>
<td align="center"><span style="color:red">redisTemplate</span>.opsForZSet()</td>
<td align="center">ZSetOperations</td>
<td align="center">æ“ä½œSortedSetç±»å‹æ•°æ®</td>
</tr>
<tr>
<td align="center"><span style="color:red">redisTemplate</span></td>
<td align="center"></td>
<td align="center">é€šç”¨å‘½ä»¤</td>
</tr>
</tbody></table>
<h3 id="3-4-SpringDataRediså¿«é€Ÿå…¥é—¨"><a href="#3-4-SpringDataRediså¿«é€Ÿå…¥é—¨" class="headerlink" title="3.4 SpringDataRediså¿«é€Ÿå…¥é—¨"></a>3.4 SpringDataRediså¿«é€Ÿå…¥é—¨</h3><p>SpringBootå·²ç»æä¾›äº†å¯¹SpringDataRedisçš„æ”¯æŒï¼Œå…¶ä¸­Springé»˜è®¤æ”¯æŒ<code>Lettuce</code>ï¼Œå¦‚éœ€ä½¿ç”¨<code>Jedis</code>éœ€è¦é¢å¤–å¯¼å…¥ä¾èµ–</p>
<ol>
<li>å¯¼å…¥ä¾èµ–</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Redisä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>            </span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- è¿æ¥æ± ä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ol start="2">
<li>é…ç½®æ–‡ä»¶</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span> <span class="comment"># æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span> <span class="comment">#æœ€å¤§ç©ºé—²è¿æ¥æ•°</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment">#æœ€å°ç©ºé—²è¿æ¥æ•°</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">100ms</span> <span class="comment"># è¿æ¥ç­‰å¾…æ—¶é—´</span></span><br></pre></td></tr></table></figure>



<ol start="3">
<li>æ³¨å…¥RedisTemplateï¼Œè¿›è¡Œæµ‹è¯•ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisTemplateTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//æ’å…¥ä¸€æ¡Stringç±»å‹çš„æ•°æ®</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;dahuang&quot;</span>);</span><br><span class="line">        <span class="comment">//è·å–Stringç±»å‹çš„æ•°æ®</span></span><br><span class="line">        System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>SpringDataRedisçš„ä½¿ç”¨æ­¥éª¤ï¼š</p>
<blockquote>
<ol>
<li>å¼•å…¥spring-boot-starter-data-redisä¾èµ–</li>
<li>åœ¨application.ymlé…ç½®Redisä»¥åŠè¿æ¥æ± ä¿¡æ¯</li>
<li>æ³¨å…¥RedisTemplate</li>
</ol>
</blockquote>
<h3 id="3-5-SpringDataRedisçš„åºåˆ—åŒ–æ–¹å¼"><a href="#3-5-SpringDataRedisçš„åºåˆ—åŒ–æ–¹å¼" class="headerlink" title="3.5 SpringDataRedisçš„åºåˆ—åŒ–æ–¹å¼"></a>3.5 SpringDataRedisçš„åºåˆ—åŒ–æ–¹å¼</h3><p>RedisTemplateå¯ä»¥æ¥æ”¶ä»»æ„Objectä½œä¸ºå€¼å†™å…¥Redisï¼Œåªä¸è¿‡å†™å…¥å‰ä¼šæŠŠObjectåºåˆ—åŒ–ä¸ºå­—èŠ‚å½¢å¼ï¼Œé»˜è®¤é‡‡ç”¨JDKåºåˆ—åŒ–ï¼Œåˆšæ‰å­˜å…¥çš„æ•°æ®çš„ç»“æœæ˜¯è¿™æ ·ï¼š</p>
<p><img src="https://s2.loli.net/2022/07/12/YNlFqgBsVf56Qmh.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/12/YNlFqgBsVf56Qmh.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220712110421745"></p>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><p>å¯è¯»æ€§å·®</p>
</li>
<li><p>å†…å­˜å ç”¨è¾ƒå¤§</p>
</li>
</ul>
<p>éœ€è¦å¯¼å…¥jacksonä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>å¯ä»¥è‡ªå®šä¹‰RedisTemplateçš„åºåˆ—åŒ–æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span>&#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºRedisTemplate</span></span><br><span class="line">        RedisTemplate&lt;String,Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//è®¾ç½®è¿æ¥å·¥å‚</span></span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="comment">//è®¾ç½®jsonåºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">GenericJackson2JsonRedisSerializer</span> <span class="variable">gjjrs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>();</span><br><span class="line">        <span class="comment">//è®¾ç½®keyçš„åºåˆ—åŒ–</span></span><br><span class="line">        redisTemplate.setKeySerializer(RedisSerializer.string());</span><br><span class="line">        redisTemplate.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line">        <span class="comment">//è®¾ç½®valueçš„åºåˆ—åŒ–</span></span><br><span class="line">        redisTemplate.setValueSerializer(gjjrs);</span><br><span class="line">        redisTemplate.setHashValueSerializer(gjjrs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>åˆ›å»ºä¸€ä¸ªå®ä½“ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>è¿›è¡Œæµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">	redisTemplate.opsForValue().set(<span class="string">&quot;demo:user:3&quot;</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;dahuang&quot;</span>,<span class="number">18</span>));</span><br><span class="line">	<span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> (User) redisTemplate.opsForValue().get(<span class="string">&quot;demo:user:3&quot;</span>);</span><br><span class="line">	System.out.println(<span class="string">&quot;u = &quot;</span> + u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ§åˆ¶å°æ‰“å°ï¼š</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u = User(name=dahuang, age=18)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>Redisä¸­çš„æ•°æ®ï¼š</p>
<blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.redis.pojo.User&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dahuang&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">18</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="3-6-StringRedisTemplate"><a href="#3-6-StringRedisTemplate" class="headerlink" title="3.6 StringRedisTemplate"></a>3.6 StringRedisTemplate</h3><blockquote>
<p>å°½ç®¡jsonçš„åºåˆ—åŒ–æ–¹å¼å¯ä»¥æ»¡è¶³éœ€æ±‚ï¼Œä½†ä»ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜</p>
<p>ä¸ºäº†åœ¨ååºåˆ—åŒ–æ—¶çŸ¥é“å¯¹è±¡çš„ç±»å‹ï¼Œjsonåºåˆ—åŒ–å™¨ä¼šå°†ç±»çš„classç±»å‹å†™å…¥jsonç»“æœä¸­ï¼Œå­˜å…¥Redisï¼Œä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€</p>
<p>ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œå¹¶ä¸ä¼šä½¿ç”¨jsonåºåˆ—åŒ–å™¨æ¥å¤„ç†valueï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨Stringåºåˆ—åŒ–å™¨ï¼Œè¦æ±‚åªèƒ½å­˜å‚¨Stringç±»å‹çš„keyå’Œvalue</p>
<p>å½“å­˜å‚¨javaå¯¹è±¡æ—¶ï¼Œæ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</p>
</blockquote>
<pre class="mermaid">graph LR;
å®ä½“ç±» --> |æ‰‹åŠ¨åºåˆ—åŒ–|jsonå­—ç¬¦ä¸² --> |æ’å…¥|Redis
Redis -->|è·å–| jsonå­—ç¬¦ä¸² --> |æ‰‹åŠ¨ååºåˆ—åŒ–|å®ä½“ç±»</pre>



<p>Springé»˜è®¤æä¾›äº†ä¸€ä¸ªSpringRedisTemplateç±»ï¼Œå®ƒçš„keyå’Œvalueçš„åºåˆ—åŒ–æ–¹å¼é»˜è®¤å°±æ˜¯Stringæ–¹å¼ã€‚çœå»äº†è‡ªå®šä¹‰RedisTemplateçš„è¿‡ç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringRedisTemplateTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="comment">//jsonå·¥å…·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testStringTemplate</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;dahei&quot;</span>, <span class="number">22</span>);</span><br><span class="line">        <span class="comment">//æ‰‹åŠ¨åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(user);</span><br><span class="line">        <span class="comment">//æ’å…¥æ•°æ®</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;demo:user:5&quot;</span>,json);</span><br><span class="line">        <span class="comment">//è·å–æ•°æ®</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;demo:user:5&quot;</span>);</span><br><span class="line">        <span class="comment">//æ‰‹åŠ¨ååºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> mapper.readValue(val, User.class);</span><br><span class="line">        <span class="comment">//æ‰“å°user</span></span><br><span class="line">        System.out.println(<span class="string">&quot;u = &quot;</span> + u);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>RedisTemplateçš„ä¸¤ç§åºåˆ—åŒ–å®è·µæ–¹æ¡ˆï¼š</p>
<blockquote>
<p>æ–¹æ¡ˆä¸€ï¼š</p>
<ol>
<li>è‡ªå®šä¹‰RedisTemplate</li>
<li>ä¿®æ”¹RedisTemplateçš„åºåˆ—åŒ–å™¨ä¸º<code>GenericJackson2JsonRedisSerializer</code></li>
</ol>
<p>æ–¹æ¡ˆäºŒï¼š</p>
<ol>
<li>ä½¿ç”¨StringRedisTemplate</li>
<li>å†™å…¥Redisæ—¶ï¼Œéœ€æ‰‹åŠ¨æŠŠå¯¹è±¡åºåˆ—åŒ–ä¸ºjson</li>
<li>è¯»å–Redisæ—¶ï¼Œæ‰‹åŠ¨æŠŠè¯»å–åˆ°çš„jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</li>
</ol>
</blockquote>
<h3 id="3-7-RedisTemplateæ“ä½œHashç±»å‹"><a href="#3-7-RedisTemplateæ“ä½œHashç±»å‹" class="headerlink" title="3.7 RedisTemplateæ“ä½œHashç±»å‹"></a>3.7 RedisTemplateæ“ä½œHashç±»å‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span> &#123;</span><br><span class="line">    stringRedisTemplate.opsForHash().put(<span class="string">&quot;user:6&quot;</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;dahei&quot;</span>);</span><br><span class="line">    stringRedisTemplate.opsForHash().put(<span class="string">&quot;user:6&quot;</span>,<span class="string">&quot;age&quot;</span>,<span class="string">&quot;22&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    Map&lt;Object, Object&gt; entries = stringRedisTemplate.opsForHash().entries(<span class="string">&quot;user:6&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;entries = &quot;</span> + entries);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="å®æˆ˜ç¯‡"><a href="#å®æˆ˜ç¯‡" class="headerlink" title="å®æˆ˜ç¯‡"></a>å®æˆ˜ç¯‡</h1><img src="https://s2.loli.net/2023/01/18/Sh58HXBdImrpz1M.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/18/Sh58HXBdImrpz1M.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230118132725027.png" style="zoom:50%;" />

<p>æ­¤é¡¹ç›®ä¸ºé»‘é©¬ç‚¹è¯„ï¼Œå¦‚éœ€ï¼Œè¯·æœç´¢é»‘é©¬ç¨‹åºå‘˜è·å–èµ„æº</p>
<p>é¡¹ç›®ç»“æ„ï¼š</p>
<img src="https://s2.loli.net/2023/01/25/Qr2NipyDwUTHoF3.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/Qr2NipyDwUTHoF3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220715091142486.png" style="zoom:67%;" />

<p>application.yamlçš„é…ç½®ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hmdp</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/hmdp?useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">time-between-eviction-runs:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">jackson:</span></span><br><span class="line">    <span class="attr">default-property-inclusion:</span> <span class="string">non_null</span> <span class="comment"># JSONå¤„ç†æ—¶å¿½ç•¥éç©ºå­—æ®µ</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.hmdp.entity</span> <span class="comment"># åˆ«åæ‰«æåŒ…</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.hmdp:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>



</div><div class="story post-story"><h2 id="1-çŸ­ä¿¡ç™»å½•"><a href="#1-çŸ­ä¿¡ç™»å½•" class="headerlink" title="1.çŸ­ä¿¡ç™»å½•"></a>1.çŸ­ä¿¡ç™»å½•</h2><h3 id="1-1-åŸºäºSessionå®ç°çŸ­ä¿¡ç™»å½•æµç¨‹"><a href="#1-1-åŸºäºSessionå®ç°çŸ­ä¿¡ç™»å½•æµç¨‹" class="headerlink" title="1.1 åŸºäºSessionå®ç°çŸ­ä¿¡ç™»å½•æµç¨‹"></a>1.1 åŸºäºSessionå®ç°çŸ­ä¿¡ç™»å½•æµç¨‹</h3><p><img src="https://s2.loli.net/2023/01/23/xHIL8TmeABuoghM.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/xHIL8TmeABuoghM.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-09-46.png"></p>
<h3 id="1-2-å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç "><a href="#1-2-å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç " class="headerlink" title="1.2 å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç "></a>1.2 å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç </h3><p>IUserServiceï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line"></span><br><span class="line">    Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>UserServiceImplä¸­å®ç°<code>sendCode</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">//æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line">        <span class="comment">//ä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);</span><br><span class="line">    <span class="comment">//ä¿å­˜éªŒè¯ç åˆ°Session</span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;code&quot;</span>,code);</span><br><span class="line">    <span class="comment">//å‘é€éªŒè¯ç ï¼Œæ¨¡æ‹Ÿä¸€ä¸‹</span></span><br><span class="line">    log.debug(<span class="string">&quot;å‘é€éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ä¸ºï¼š&quot;</span>+code);</span><br><span class="line">    <span class="comment">//è¿”å›OK</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>UserControllerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;code&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(<span class="meta">@RequestParam(&quot;phone&quot;)</span> String phone, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">//å‘é€çŸ­ä¿¡éªŒè¯ç å¹¶ä¿å­˜éªŒè¯ç </span></span><br><span class="line">    <span class="keyword">return</span> userService.sendCode(phone, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ—¥å¿—æ‰“å°ï¼š</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å‘é€éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ä¸ºï¼š608824</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="1-3-å®ç°çŸ­ä¿¡éªŒè¯ç™»å½•ä¸æ³¨å†Œ"><a href="#1-3-å®ç°çŸ­ä¿¡éªŒè¯ç™»å½•ä¸æ³¨å†Œ" class="headerlink" title="1.3 å®ç°çŸ­ä¿¡éªŒè¯ç™»å½•ä¸æ³¨å†Œ"></a>1.3 å®ç°çŸ­ä¿¡éªŒè¯ç™»å½•ä¸æ³¨å†Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line">    Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span>;</span><br><span class="line">    Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">//æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(loginForm.getPhone())) &#123;</span><br><span class="line">        <span class="comment">//ä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> (String) session.getAttribute(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">null</span> || !code.equals(loginForm.getCode())) &#123;</span><br><span class="line">        <span class="comment">//ä¸ä¸€è‡´ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸€è‡´ï¼ŒæŸ¥è¯¢æ‰‹æœºå·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> query().eq(<span class="string">&quot;phone&quot;</span>, loginForm.getPhone()).one();</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//ä¸å­˜åœ¨ï¼Œæ’å…¥åˆ°æ•°æ®åº“ï¼Œå®Œæˆæ³¨å†Œ</span></span><br><span class="line">        user = createUserByPhone(loginForm.getPhone());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¿å­˜ç”¨æˆ·åˆ°Session</span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">    <span class="comment">//æ¯ä¸ªsessionéƒ½æœ‰å”¯ä¸€çš„idï¼Œä¸éœ€è¦ç™»é™†å‡­è¯</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> User <span class="title function_">createUserByPhone</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setPhone(phone);</span><br><span class="line">    user.setNickName(USER_NICK_NAME_PREFIX + RandomUtil.randomNumbers(<span class="number">10</span>));</span><br><span class="line">    save(user);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> LoginFormDTO loginForm, HttpSession session)</span>&#123;</span><br><span class="line">    <span class="comment">//å®ç°ç™»å½•åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">return</span> userService.login(loginForm,session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-4-å®ç°ç™»å½•æ ¡éªŒæ‹¦æˆªå™¨"><a href="#1-4-å®ç°ç™»å½•æ ¡éªŒæ‹¦æˆªå™¨" class="headerlink" title="1.4 å®ç°ç™»å½•æ ¡éªŒæ‹¦æˆªå™¨"></a>1.4 å®ç°ç™»å½•æ ¡éªŒæ‹¦æˆªå™¨</h3><p><strong>éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯</strong>ï¼š</p>
<p>è°ƒç”¨<code>/user/me</code>æ¥å£è·å–ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œå“åº”ä¸­åŒ…å«äº†æ‰‹æœºå·ã€å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ï¼Œå¹¶ä¸”å‘é€çš„å¤šä½™ä¿¡æ¯å¢åŠ äº†æœåŠ¡å™¨çš„å‹åŠ›ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç”¨æˆ·æ˜µç§°ã€å¤´åƒå’Œidç­‰çš„éƒ¨åˆ†ä¿¡æ¯ã€‚</p>
<p>å®šä¹‰ä¸€ä¸ªUserDtoï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDTO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id; <span class="comment">//id</span></span><br><span class="line">    <span class="keyword">private</span> String nickName;<span class="comment">//æ˜µç§°</span></span><br><span class="line">    <span class="keyword">private</span> String icon;<span class="comment">//å¤´åƒ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å°†<code>UserServiceImpl</code>çš„<code>login</code>æ–¹æ³•ä¸­å­˜å…¥sessionçš„<code>User</code>è½¬æ¢æˆ<code>UserDto</code>ç±»å‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.setAttribute(<span class="string">&quot;user&quot;</span>, BeanUtil.copyProperties(user, UserDTO.class));</span><br></pre></td></tr></table></figure>



<p>æ–°å»º<code>LoginInterceptor</code>æ‹¦æˆªå™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//è·å–session</span></span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        <span class="comment">//è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> (UserDTO) session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">//ä¸å­˜åœ¨ï¼Œæ‹¦æˆª</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//è¿”å›çŠ¶æ€ç 401ï¼Œæœªæˆæƒ</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å­˜åœ¨ï¼Œä¿å­˜åˆ°TheadLocal</span></span><br><span class="line">        UserHolder.saveUser(user);</span><br><span class="line">        <span class="comment">//æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ç§»é™¤ç”¨æˆ·</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æ–°å»º<code>MvcConfig</code>é…ç½®ç±»ï¼Œæ·»åŠ æ‹¦æˆªå™¨å¹¶æ·»åŠ æ’åºè·¯å¾„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .excludePathPatterns( <span class="comment">//æ’é™¤è·¯å¾„</span></span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>UserController</code>ä¸­å®ç°è·å–ç”¨æˆ·ä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/me&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">me</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-5-Sessionå…±äº«é—®é¢˜åˆ†æ"><a href="#1-5-Sessionå…±äº«é—®é¢˜åˆ†æ" class="headerlink" title="1.5 Sessionå…±äº«é—®é¢˜åˆ†æ"></a>1.5 Sessionå…±äº«é—®é¢˜åˆ†æ</h3><p><strong>sessionå…±äº«é—®é¢˜</strong>ï¼šå¤šå°Tomcatä¸èƒ½å…±äº«sessionå­˜å‚¨ç©ºé—´ï¼Œå½“è¯·æ±‚åˆ‡æ¢åˆ°ä¸åŒçš„TomcatæœåŠ¡å™¨æ—¶å¯¼è‡´æ•°æ®å¯¹æ˜¯é—®é¢˜</p>
<p>sessionçš„æ›¿ä»£æ–¹æ¡ˆåº”è¯¥æ»¡è¶³ï¼š</p>
<ul>
<li><p>æ•°æ®å…±äº«</p>
</li>
<li><p>å†…å­˜å­˜å‚¨</p>
</li>
<li><p>keyã€valueç»“æ„</p>
</li>
</ul>
<p>Rediséƒ½èƒ½è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œå¹¶ä¸”å»¶æ—¶ä½</p>
<h3 id="1-6-åŸºäºRediså®ç°å…±äº«Sessionç™»å½•æµç¨‹"><a href="#1-6-åŸºäºRediså®ç°å…±äº«Sessionç™»å½•æµç¨‹" class="headerlink" title="1.6 åŸºäºRediså®ç°å…±äº«Sessionç™»å½•æµç¨‹"></a>1.6 åŸºäºRediså®ç°å…±äº«Sessionç™»å½•æµç¨‹</h3><p><img src="https://s2.loli.net/2023/01/23/qM7r9senj8ydT3Y.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/qM7r9senj8ydT3Y.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-09-46.png"></p>
<p>å¯ä»¥é‡‡ç”¨Stringæ•°æ®ç±»å‹å­˜å‚¨ï¼š</p>
<table>
<thead>
<tr>
<th align="center">key</th>
<th align="center">value</th>
</tr>
</thead>
<tbody><tr>
<td align="center">æ‰‹æœºå·</td>
<td align="center">éªŒè¯ç </td>
</tr>
</tbody></table>
<p>ä¿å­˜ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨<span style="color:red">Stringç»“æ„</span>ï¼Œä»¥<strong>jsonå­—ç¬¦ä¸²</strong>æ¥ä¿å­˜ï¼Œæ¯”è¾ƒç›´è§‚</p>
<p><span style="color:red">Hashç»“æ„</span>å¯ä»¥å°†å¯¹è±¡ä¸­çš„æ¯ä¸€ä¸ªå­—æ®µç‹¬ç«‹å­˜å‚¨ï¼Œå¯ä»¥é’ˆå¯¹å•ä¸ªå­—æ®µåšCRUDï¼Œå¹¶ä¸”å†…å­˜å ç”¨å°‘(<span style="color:red">æ¨è</span>)</p>
<p>ä¿å­˜ç”¨æˆ·åˆ°Redisï¼š</p>
<table>
<thead>
<tr>
<th align="center">key</th>
<th align="center">value</th>
</tr>
</thead>
<tbody><tr>
<td align="center">éšæœºtokenä¸ºkeyå­˜å‚¨ç”¨æˆ·æ•°æ®</td>
<td align="center">{name:Tom}</td>
</tr>
</tbody></table>
<p>æ ¡éªŒç™»å½•çŠ¶æ€ï¼š</p>
<p><img src="https://s2.loli.net/2023/01/23/7P69spqGOZ4btne.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/7P69spqGOZ4btne.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-09-46.png"></p>
<h3 id="1-7-åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•"><a href="#1-7-åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•" class="headerlink" title="1.7 åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•*"></a>1.7 åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•*</h3><p>ä¿®æ”¹<code>UserServiceImpl</code>ä¸­çš„<code>sendCode</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span> &#123;</span><br><span class="line">	<span class="comment">//æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">	<span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line">	<span class="comment">//ä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">	<span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç </span></span><br><span class="line">	<span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);</span><br><span class="line">	<span class="comment">//ä¿å­˜éªŒè¯ç åˆ°Redisï¼Œè®¾ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(RedisConstants.LOGIN_CODE_KEY +phone, <span class="comment">//key</span></span><br><span class="line">			code, <span class="comment">//value</span></span><br><span class="line">			RedisConstants.LOGIN_CODE_TTL, <span class="comment">// 2</span></span><br><span class="line">			TimeUnit.MINUTES);<span class="comment">//æŒ‡å®šå•ä½ä¸ºåˆ†é’Ÿ</span></span><br><span class="line">	<span class="comment">//å‘é€éªŒè¯ç ï¼Œæ¨¡æ‹Ÿä¸€ä¸‹</span></span><br><span class="line">	log.debug(<span class="string">&quot;å‘é€éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ä¸ºï¼š&quot;</span>+code);</span><br><span class="line">	<span class="comment">//è¿”å›OK</span></span><br><span class="line">	<span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä¿®æ”¹<code>UserServiceImpl</code>ä¸­çš„<code>login</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">        <span class="comment">//æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">        <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(loginForm.getPhone())) &#123;</span><br><span class="line">            <span class="comment">//ä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(RedisConstants.LOGIN_CODE_KEY + loginForm.getPhone());</span><br><span class="line">        <span class="keyword">if</span> (code == <span class="literal">null</span> || !code.equals(loginForm.getCode())) &#123;</span><br><span class="line">            <span class="comment">//ä¸ä¸€è‡´ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¸€è‡´ï¼ŒæŸ¥è¯¢æ‰‹æœºå·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> query().eq(<span class="string">&quot;phone&quot;</span>, loginForm.getPhone()).one();</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//ä¸å­˜åœ¨ï¼Œæ’å…¥åˆ°æ•°æ®åº“ï¼Œå®Œæˆæ³¨å†Œ</span></span><br><span class="line">            user = createUserByPhone(loginForm.getPhone());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//éšæœºç”Ÿæˆç™»å½•ä»¤ç‰Œtokenï¼Œ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//å°†Userå¯¹è±¡è½¬æˆUserDtoåœ¨è½¬æ¢æˆMapæ•°æ®ç±»å‹</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);</span><br><span class="line">        <span class="comment">//mapæ•°æ®ç±»å‹çš„é”®å€¼å¯¹éƒ½éœ€è¦æ˜¯Stringç±»å‹çš„</span></span><br><span class="line">        Map&lt;String, Object&gt; userMap = BeanUtil.beanToMap(userDTO,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),</span><br><span class="line">                CopyOptions.create().setIgnoreNullValue(<span class="literal">true</span>) <span class="comment">//å¿½ç•¥ç©ºçš„å€¼</span></span><br><span class="line">                        .setFieldValueEditor((fieldName, fieldValue) -&gt; fieldValue.toString()));<span class="comment">//æ‰€æœ‰valueå€¼è½¬æ¢ä¸ºString</span></span><br><span class="line">        <span class="comment">//ä¿å­˜ç”¨æˆ·åˆ°Redis</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.LOGIN_USER_KEY + token;</span><br><span class="line">        stringRedisTemplate.opsForHash().putAll(key, userMap);</span><br><span class="line">        <span class="comment">//è®¾ç½®æœ‰æ•ˆæœŸ30åˆ†é’Ÿ</span></span><br><span class="line">        stringRedisTemplate.expire(key, <span class="comment">//key</span></span><br><span class="line">                RedisConstants.LOGIN_USER_TTL, <span class="comment">// 30</span></span><br><span class="line">                TimeUnit.MINUTES); <span class="comment">//åˆ†é’Ÿ</span></span><br><span class="line">        <span class="comment">//è¿”å›token</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(token);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p><code>MVcConfig</code>é…ç½®ç±»ä¸­æ³¨å…¥<code>StringRedisTemplate</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>(stringRedisTemplate))</span><br><span class="line">                .excludePathPatterns( <span class="comment">//æ’é™¤è·¯å¾„</span></span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>LoginInterceptor</code>ä¸­è·å–Redisä¸­çš„æ•°æ®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LoginInterceptor</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//è·å–tokenï¼Œå‰ç«¯ä¼šå°†tokenæ”¾å…¥åˆ°è¯·æ±‚å¤´ä¸­</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">            <span class="comment">//è¿”å›çŠ¶æ€ç 401ï¼Œæœªæˆæƒ</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(RedisConstants.LOGIN_USER_KEY + token);</span><br><span class="line">        <span class="comment">//ä¸å­˜åœ¨ï¼Œæ‹¦æˆª</span></span><br><span class="line">        <span class="keyword">if</span> (userMap.isEmpty())&#123;</span><br><span class="line">            <span class="comment">//è¿”å›çŠ¶æ€ç 401ï¼Œæœªæˆæƒ</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å°†mapè½¬æ¢æˆUserDto</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(userMap,<span class="keyword">new</span> <span class="title class_">UserDTO</span>(),<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//å­˜åœ¨ï¼Œä¿å­˜åˆ°TheadLocal</span></span><br><span class="line">        UserHolder.saveUser(user);</span><br><span class="line">        <span class="comment">//åˆ·æ–°æœ‰æ•ˆæœŸ</span></span><br><span class="line">        stringRedisTemplate.expire(RedisConstants.LOGIN_USER_KEY + token, <span class="comment">//key</span></span><br><span class="line">                RedisConstants.LOGIN_USER_TTL, <span class="comment">// 30</span></span><br><span class="line">                TimeUnit.MINUTES); <span class="comment">//åˆ†é’Ÿ</span></span><br><span class="line">        <span class="comment">//æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ç§»é™¤ç”¨æˆ·</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-8-è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜"><a href="#1-8-è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜" class="headerlink" title="1.8 è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜*"></a>1.8 è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜*</h3><p><strong>æ‹¦æˆªå™¨</strong></p>
<blockquote>
<ol>
<li><p>è·å–token</p>
</li>
<li><p>æŸ¥è¯¢Redisçš„ç”¨æˆ·ä¿¡æ¯</p>
<p>ä¸å­˜åœ¨ï¼Œåˆ™æ‹¦æˆª</p>
<p>å­˜åœ¨ï¼Œåˆ™ç»§ç»­</p>
</li>
<li><p>ä¿å­˜åˆ°ThreadLocal</p>
</li>
<li><p>åˆ·æ–°tokençš„æœ‰æ•ˆæœŸ</p>
</li>
<li><p>æ”¾è¡Œ</p>
</li>
</ol>
</blockquote>
<p>æ‹¦æˆªå™¨åªä¼šæ‹¦æˆªç™»å½•çš„è·¯å¾„ï¼Œä»è€Œåˆ·æ–°tokenæœ‰æ•ˆæœŸã€‚</p>
<p>ä½†æ˜¯å…¶ä»–çš„ä¸€äº›ä¸éœ€è¦ç™»å½•ä¹Ÿå¯ä»¥æŸ¥çœ‹çš„é¡µé¢ï¼Œæ¯”å¦‚é¦–é¡µï¼Œåˆ™ä¸ä¼šåˆ·æ–°tokenæœ‰æ•ˆæœŸã€‚</p>
<p>æœ‰å¯èƒ½é•¿æ—¶é—´æŸ¥çœ‹å…¶ä»–é¡µé¢ï¼Œå¯¼è‡´åœ¨æŸ¥çœ‹éœ€è¦ç™»å½•çš„è·¯å¾„ï¼Œtokenè¿‡äº†æœ‰æ•ˆæœŸï¼Œéœ€è¦é‡æ–°ç™»å½•çš„é—®é¢˜</p>
<pre class="mermaid">sequenceDiagram
        ç”¨æˆ·-->>æ‹¦æˆªå™¨1:å‘é€è¯·æ±‚
        note over æ‹¦æˆªå™¨1:æ‹¦æˆªä¸€åˆ‡è·¯å¾„<br>1. è·å–token<br>2. æŸ¥è¯¢Redisçš„ç”¨æˆ·<br>3. ä¿å­˜åˆ°ThreadLocal<br>4. åˆ·æ–°tokençš„æœ‰æ•ˆæœŸ<br>5. æ”¾è¡Œ
        æ‹¦æˆªå™¨1->>æ‹¦æˆªå™¨2:è¿›å…¥
        note over æ‹¦æˆªå™¨2:æ‹¦æˆªéœ€è¦ç™»å½•çš„è·¯å¾„<br>æŸ¥çœ‹token<br>å­˜åœ¨ï¼Œåˆ™æ‹¦æˆª<br>ä¸å­˜åœ¨ï¼Œåˆ™ç»§ç»­
        æ‹¦æˆªå™¨2->>UserController:è¿›å…¥</pre>



<p><code>RefreshTokenInterceptor</code>ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshTokenInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RefreshTokenInterceptor</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//è·å–token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="comment">//tokenä¸å­˜åœ¨ï¼Œç›´æ¥æ”¾è¡Œï¼Œä¸æ·»åŠ åˆ°ThreadLocal</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(RedisConstants.LOGIN_USER_KEY + token);</span><br><span class="line">        <span class="comment">//ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨ï¼Œç›´æ¥æ”¾è¡Œï¼Œä¸æ·»åŠ åˆ°ThreadLocal</span></span><br><span class="line">        <span class="keyword">if</span> (userMap.isEmpty())&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å°†mapè½¬æ¢æˆUserDto</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(userMap,<span class="keyword">new</span> <span class="title class_">UserDTO</span>(),<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//ä¿å­˜åˆ°TheadLocal</span></span><br><span class="line">        UserHolder.saveUser(user);</span><br><span class="line">        <span class="comment">//åˆ·æ–°æœ‰æ•ˆæœŸ</span></span><br><span class="line">        stringRedisTemplate.expire(RedisConstants.LOGIN_USER_KEY + token, <span class="comment">//key</span></span><br><span class="line">                RedisConstants.LOGIN_USER_TTL, <span class="comment">// 30</span></span><br><span class="line">                TimeUnit.MINUTES); <span class="comment">//åˆ†é’Ÿ</span></span><br><span class="line">        <span class="comment">//æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ç§»é™¤ç”¨æˆ·</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>LoginInterceptor</code>ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­ThreadLocalæ˜¯å¦å­˜åœ¨ç”¨æˆ·</span></span><br><span class="line">        <span class="keyword">if</span> (UserHolder.getUser() == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//æ²¡æœ‰ï¼Œæ‹¦æˆªï¼Œè®¾ç½®çŠ¶æ€ç </span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æœ‰ç”¨æˆ·æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>MvcConfig</code>é…ç½®ç±»ä¸­ï¼š</p>
<ol>
<li>å…ˆè¿›è¡Œtokenåˆ·æ–°æ‹¦æˆªï¼Œåˆ·æ–°ç”¨æˆ·æœ‰æ•ˆæœŸï¼›</li>
<li>å†è¿›è¡Œç™»å½•æ‹¦æˆªï¼Œåˆ¤æ–­tokenæ˜¯å¦æœ‰æ•ˆ</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">//tokenåˆ·æ–°æ‹¦æˆªå™¨</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">RefreshTokenInterceptor</span>(stringRedisTemplate))</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>) <span class="comment">//æ‹¦æˆªæ‰€æœ‰è·¯å¾„</span></span><br><span class="line">                .order(<span class="number">0</span>); <span class="comment">// æ³¨å†Œé¡ºåºä¸º0</span></span><br><span class="line">        <span class="comment">//ç™»å½•æ‹¦æˆªå™¨</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .excludePathPatterns( <span class="comment">//æ’é™¤è·¯å¾„</span></span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                ).order(<span class="number">1</span>); <span class="comment">//æ³¨å†Œé¡ºåºä¸º1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div><div class="story post-story"><h2 id="2-å•†æˆ·æŸ¥è¯¢ç¼“å­˜"><a href="#2-å•†æˆ·æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="2.å•†æˆ·æŸ¥è¯¢ç¼“å­˜"></a>2.å•†æˆ·æŸ¥è¯¢ç¼“å­˜</h2><h3 id="2-1-ä»€ä¹ˆæ˜¯ç¼“å­˜"><a href="#2-1-ä»€ä¹ˆæ˜¯ç¼“å­˜" class="headerlink" title="2.1 ä»€ä¹ˆæ˜¯ç¼“å­˜"></a>2.1 ä»€ä¹ˆæ˜¯ç¼“å­˜</h3><p><strong>ç¼“å­˜</strong>å°±æ˜¯æ•°æ®äº¤æ¢çš„ç¼“å†²åŒº(ç§°ä½œCache)ï¼Œæ˜¯è´®å­˜æ•°æ®çš„ä¸´æ—¶åœ°æ–¹ï¼Œä¸€èˆ¬<strong>è¯»å†™æ€§èƒ½è¾ƒé«˜</strong></p>
<pre class="mermaid">graph LR
æµè§ˆå™¨ç¼“å­˜ --> Tomcatåº”ç”¨å±‚ç¼“å­˜ --> æ•°æ®åº“ç¼“å­˜ --> CPUç¼“å­˜
æ•°æ®åº“ç¼“å­˜ --> ç£ç›˜ç¼“å­˜</pre>



<blockquote>
<p>ç¼“å­˜çš„ä½œç”¨</p>
<ul>
<li>é™ä½åç«¯çš„è´Ÿè½½</li>
<li>æé«˜è¯»å†™æ•ˆç‡ï¼Œé™ä½å“åº”æ—¶é—´</li>
</ul>
<p>ç¼“å­˜çš„æˆæœ¬</p>
<ul>
<li>æ•°æ®ä¸€è‡´æ€§æˆæœ¬</li>
<li>ä»£ç ç»´æŠ¤æˆæœ¬</li>
<li>è¿ç»´æˆæœ¬</li>
</ul>
</blockquote>
<h3 id="2-2-æ·»åŠ Redisç¼“å­˜"><a href="#2-2-æ·»åŠ Redisç¼“å­˜" class="headerlink" title="2.2 æ·»åŠ Redisç¼“å­˜"></a>2.2 æ·»åŠ Redisç¼“å­˜</h3><p>ç¼“å­˜çš„ä½œç”¨æ¨¡å‹ï¼š</p>
<pre class="mermaid">sequenceDiagram
        å®¢æˆ·ç«¯->>Redis:è¯·æ±‚
        Redis->>å®¢æˆ·ç«¯:å‘½ä¸­(åˆ†æ”¯1)
        Redis->>æ•°æ®åº“:æœªå‘½ä¸­(åˆ†æ”¯2)
        æ•°æ®åº“->>Redis:å†™ç¼“å­˜
        æ•°æ®åº“->>å®¢æˆ·ç«¯:å“åº”</pre>



<p>æ ¹æ®idæŸ¥è¯¢å•†é“ºç¼“å­˜çš„æµç¨‹ï¼š</p>
<img src="https://s2.loli.net/2023/01/23/Xmb5Qt3y1YSPRfl.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/Xmb5Qt3y1YSPRfl.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-09-46.png" style="zoom:67%;" />



<p><code>IShopService</code>åˆ›å»ºä¸€ä¸ª<code>queryById</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IShopService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;Shop&gt; &#123;</span><br><span class="line">    <span class="comment">// ctrl+bè½¬åˆ°å®ç°ç±»</span></span><br><span class="line">    Result <span class="title function_">queryById</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>åœ¨<code>ShopServiceImpl</code>ä¸­å®ç°<code>queryById</code>æ–¹æ³•ï¼Œä»è€Œå®ç°å•†é“ºä¿¡æ¯ç¼“å­˜ï¼š</p>
<p>è¿™é‡Œé€‰æ‹©è·å–å’Œå­˜å‚¨Redisçš„æ•°æ®ç±»å‹ä¸ºString</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//ä»RedisæŸ¥è¯¢å•†é“ºç¼“å­˜ï¼ŒRedisæ•°æ®ç±»å‹ä¸ºString</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸ä¸ºnull</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//å­˜åœ¨ï¼Œè¿”å›ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸ºnullä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//idä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//idå­˜åœ¨ï¼Œå°†æ•°æ®å†™å…¥Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop));</span><br><span class="line">    <span class="comment">//è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>ShopController</code>ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡idè·å–å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> shopService.queryById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>è¿™é‡Œé€‰æ‹©è·å–å’Œå­˜å‚¨Redisçš„æ•°æ®ç±»å‹ä¸ºHash</p>
<h3 id="2-3-ç¼“å­˜æ›´æ–°ç­–ç•¥"><a href="#2-3-ç¼“å­˜æ›´æ–°ç­–ç•¥" class="headerlink" title="2.3 ç¼“å­˜æ›´æ–°ç­–ç•¥"></a>2.3 ç¼“å­˜æ›´æ–°ç­–ç•¥</h3><table>
<thead>
<tr>
<th align="center"></th>
<th align="center">å†…å­˜æ·˜æ±°</th>
<th align="center">è¶…æ—¶å‰”é™¤</th>
<th>ä¸»åŠ¨æ›´æ–°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">è¯´æ˜</td>
<td align="center">ä¸ç”¨è‡ªå·±ç»´æŠ¤ï¼Œ<br>åˆ©ç”¨Redisçš„å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œ<br>å½“å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨æ·˜æ±°éƒ¨åˆ†æ•°æ®ã€‚<br>ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td>
<td align="center">ç»™ç¼“å­˜æ•°æ®æ·»åŠ TTLæ—¶é—´ï¼Œ<br>åˆ°æœŸåè‡ªåŠ¨åˆ é™¤ç¼“å­˜ã€‚<br>ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td>
<td>ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œ<br>åœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œ<br>æ›´æ–°ç¼“å­˜ã€‚</td>
</tr>
<tr>
<td align="center">ä¸€è‡´æ€§</td>
<td align="center">å·®</td>
<td align="center">ä¸€èˆ¬</td>
<td>å¥½</td>
</tr>
<tr>
<td align="center">ç»´æŠ¤æˆæœ¬</td>
<td align="center">æ— </td>
<td align="center">ä½</td>
<td>é«˜</td>
</tr>
</tbody></table>
<p>ä¸šåŠ¡åœºæ™¯ï¼š</p>
<blockquote>
<ul>
<li><p>ä½ä¸€è‡´æ€§éœ€æ±‚ï¼š</p>
<p>ä½¿ç”¨å†…å­˜æ·˜æ±°æœºåˆ¶ã€‚ä¾‹å¦‚ï¼šåº—é“ºç±»å‹çš„æŸ¥è¯¢ç¼“å­˜</p>
</li>
<li><p>é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼š</p>
<p>ä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä¸ºå…œåº•æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼šåº—é“ºè¯¦æƒ…æŸ¥è¯¢çš„ç¼“å­˜</p>
</li>
</ul>
</blockquote>
<p>ä¸»åŠ¨æ›´æ–°ç­–ç•¥ï¼š</p>
<blockquote>
<ul>
<li><p>æ–¹æ¡ˆä¸€ï¼šCache Aside Pattern(<span style="color:red">å¯æ§æ€§é«˜ï¼Œä¼ä¸šå¼€å‘å¸¸ç”¨</span>)</p>
<p>ç”±ç¼“å­˜çš„è°ƒç”¨è€…ï¼Œåœ¨æ›´æ–°æ•°æ®åº“çš„åŒæ—¶æ›´æ–°ç¼“å­˜ã€‚</p>
</li>
<li><p>æ–¹æ¡ˆäºŒï¼šRead&#x2F;Write Through Pattern</p>
<p>ç¼“å­˜ä¸æ•°æ®åº“æ•´åˆä¸ºä¸€ä¸ªæœåŠ¡ï¼Œç”±æœåŠ¡æ¥ç»´æŠ¤ä¸€è‡´æ€§ã€‚è°ƒç”¨è€…è°ƒç”¨è¯¥æœåŠ¡ï¼Œæ— éœ€å…³å¿ƒç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
</li>
<li><p>æ–¹æ¡ˆä¸‰ï¼šWrite Behind Caching Pattern</p>
<p>è°ƒç”¨è€…åªæ“ä½œç¼“å­˜ï¼Œç”±å…¶å®ƒçº¿ç¨‹å¼‚æ­¥çš„å°†ç¼“å­˜æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´ã€‚</p>
<ul>
<li><p>è¯´æ˜ï¼š</p>
<p>å¯ä»¥å¤šæ¬¡ä¿®æ”¹ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œåœ¨å°†ç¼“å­˜çš„æ•°æ®ä¸€æ¬¡æ€§æ›´æ–°åˆ°æ•°æ®åº“ä¸­</p>
<p>å¦‚æœç¼“å­˜ä¸­çš„æ•°æ®æœªæ›´æ–°åˆ°æ•°æ®åº“æ—¶ï¼Œå‡ºç°å®•æœºæ•°æ®å°±ä¼šå®Œå…¨ä¸¢å¤±</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>:cherry_blossom:æ–¹æ¡ˆä¸€ï¼šCache Aside Pattern</p>
<blockquote>
<p>æ“ä½œç¼“å­˜å’Œæ•°æ®åº“æ—¶æœ‰ä¸‰ä¸ªé—®é¢˜éœ€è¦è€ƒè™‘ï¼š</p>
<ol>
<li><p>åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ</p>
<ul>
<li>æ›´æ–°ç¼“å­˜ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½è¦æ›´æ–°ç¼“å­˜ï¼Œæ— æ•ˆå†™æ“ä½œè¾ƒå¤š:negative_squared_cross_mark:</li>
<li>åˆ é™¤ç¼“å­˜ï¼šæ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶åœ¨æ›´æ–°ç¼“å­˜:white_check_mark:</li>
</ul>
</li>
<li><p>å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ</p>
<ul>
<li>å•ä½“ç³»ï¼Œå°†ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡</li>
<li>åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ©ç”¨TTCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ</li>
</ul>
</li>
<li><p>å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ(æ•°æ®åº“çš„æ•°æ®æ“ä½œç›¸æ¯”Redisçš„æ•°æ®æ“ä½œæ…¢)</p>
<ul>
<li><p>å…ˆåˆ é™¤ç¼“å­˜ï¼Œåœ¨æ“ä½œæ•°æ®åº“</p>
<p>å¼‚å¸¸æƒ…å†µï¼š(<span style="color:red">å‡ºç°æƒ…å†µé«˜</span>)</p>
<p><code>çº¿ç¨‹1</code>åˆ é™¤ç¼“å­˜åï¼Œ<code>çº¿ç¨‹2</code>æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼Œå†æŸ¥è¯¢æ•°æ®åº“ã€‚å°†æ•°æ®åº“ä¸­çš„æ—§æ•°æ®åˆå†™å…¥äº†ç¼“å­˜åï¼Œ<code>çº¿ç¨‹1</code>æ‰å°†æ•°æ®åº“çš„æ•°æ®è¿›è¡Œäº†æ›´æ–°ã€‚å¯¼è‡´<code>çº¿ç¨‹2</code>ä¹‹å‰æ‹¿åˆ°çš„æ•°æ®åº“çš„æ•°æ®ä¸ºæ—§æ•°æ®ã€‚</p>
</li>
<li><p>å…ˆæ“ä½œæ•°æ®åº“ï¼Œåœ¨åˆ é™¤ç¼“å­˜:cherry_blossom:(èƒœå‡º)</p>
<p>å¼‚å¸¸æƒ…å†µï¼š(<span style="color:red">å‡ºç°æƒ…å†µä½</span>)</p>
<p><code>çº¿ç¨‹1</code>æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼Œå†æŸ¥è¯¢æ•°æ®åº“è·å–åˆ°æ—§æ•°æ®åï¼Œ<code>çº¿ç¨‹2</code>è¿™æ—¶æ›´æ–°äº†æ•°æ®åº“çš„æ•°æ®ï¼Œåˆ é™¤äº†ç¼“å­˜åï¼Œ<code>çº¿ç¨‹1</code>æ‰å¼€å§‹å†™å…¥ç¼“å­˜ã€‚å¯¼è‡´çº¿ç¨‹1ä¹‹å‰æ‹¿åˆ°çš„æ•°æ®åº“çš„æ•°æ®ä¸ºæ—§æ•°æ®ã€‚</p>
</li>
</ul>
</li>
</ol>
</blockquote>
<p><span style="color:red">æ€»ç»“</span>ï¼š</p>
<p>ç¼“å­˜æ›´æ–°ç­–ç•¥çš„æœ€ä½³å®è·µæ–¹æ¡ˆ</p>
<blockquote>
<ol>
<li><p>ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨Redisè‡ªå¸¦çš„å†…å­˜æ·˜æ±°æœºåˆ¶</p>
</li>
<li><p>é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä¸ºå…œåº•æ–¹æ¡ˆ</p>
<ul>
<li><p>è¯»æ“ä½œï¼š</p>
<p>ç¼“å­˜å‘½ä¸­ç›´æ¥è¿”å›</p>
<p>ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´</p>
</li>
<li><p>å†™æ“ä½œï¼š</p>
<p>å…ˆå†™æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜</p>
<p>è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§</p>
</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="2-4-æ·»åŠ ç¼“å­˜æ›´æ–°ç­–ç•¥"><a href="#2-4-æ·»åŠ ç¼“å­˜æ›´æ–°ç­–ç•¥" class="headerlink" title="2.4 æ·»åŠ ç¼“å­˜æ›´æ–°ç­–ç•¥"></a>2.4 æ·»åŠ ç¼“å­˜æ›´æ–°ç­–ç•¥</h3><p>ç»™æŸ¥è¯¢å•†é“ºçš„ç¼“å­˜æ·»åŠ <strong>è¶…æ—¶å‰”é™¤</strong>å’Œ<strong>ä¸»åŠ¨æ›´æ–°</strong>çš„ç­–ç•¥</p>
<p>ä¿®æ”¹ShopControllerä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ»¡è¶³ä¸€ä¸‹çš„éœ€æ±‚ï¼š</p>
<blockquote>
<ol>
<li>æ ¹æ®idæŸ¥è¯¢åº—é“ºæ—¶ï¼Œå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå°†æ•°æ®åº“çš„ç»“æœå†™å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´</li>
<li>æ ¹æ®idä¿®æ”¹åº—é“ºæ—¶ï¼Œå…ˆä¿®æ”¹æ•°æ®åº“ï¼Œåœ¨åˆ é™¤ç¼“å­˜</li>
</ol>
</blockquote>
<p>ä¿®æ”¹<code>ShopServiceImpl</code>ä¸­çš„<code>queryById</code>æ–¹æ³•ï¼Œå°†å†™å…¥Redisçš„æ•°æ®è®¾ç½®æœ‰æ•ˆæœŸï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//ä»RedisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸ä¸ºnull</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//å­˜åœ¨ï¼Œè¿”å›ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸ºnullä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//idä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//idå­˜åœ¨ï¼Œå°†æ•°æ®å†™å…¥Redisï¼Œè®¾ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, <span class="comment">//key </span></span><br><span class="line">            JSONUtil.toJsonStr(shop), <span class="comment">// value</span></span><br><span class="line">            RedisConstants.CACHE_SHOP_TTL, <span class="comment">// 30</span></span><br><span class="line">            TimeUnit.MINUTES); <span class="comment">//åˆ†é’Ÿ</span></span><br><span class="line">    <span class="comment">//è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>IShopService</code>ä¸­åˆ›å»º<code>update</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IShopService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;Shop&gt; &#123;</span><br><span class="line">    <span class="comment">// ctrl+bè½¬åˆ°å®ç°ç±»</span></span><br><span class="line">    Result <span class="title function_">queryById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    Result <span class="title function_">update</span><span class="params">(Shop shop)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>ShopServiceImpl</code>ä¸­,å®ç°<code>update</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(Shop shop)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> shop.getId();</span><br><span class="line">    <span class="comment">//åˆ¤æ–­å•†é“ºæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;å•†é“ºidä¸èƒ½ä¸ºç©º&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ›´æ–°æ•°æ®åº“</span></span><br><span class="line">    updateById(shop);</span><br><span class="line">    <span class="comment">//åˆ é™¤ç¼“å­˜ï¼Œä¸‹æ¬¡ç”¨å†å–</span></span><br><span class="line">    stringRedisTemplate.delete(RedisConstants.CACHE_SHOP_KEY + id);</span><br><span class="line">	<span class="comment">//è¿”å›æˆåŠŸä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>ShopController</code>ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateShop</span><span class="params">(<span class="meta">@RequestBody</span> Shop shop)</span> &#123;</span><br><span class="line">    <span class="comment">//æ›´æ–°æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> shopService.update(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-5-ç¼“å­˜ç©¿é€"><a href="#2-5-ç¼“å­˜ç©¿é€" class="headerlink" title="2.5 ç¼“å­˜ç©¿é€"></a>2.5 ç¼“å­˜ç©¿é€</h3><p><strong>ç¼“å­˜ç©¿é€</strong>æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚åˆ°ä¼š<strong>å¤šæ¬¡</strong>æ‰“åˆ°æ•°æ®åº“ã€‚(<strong>å¤šæ¬¡æŸ¥è¯¢ä¸å­˜åœ¨çš„ä¿¡æ¯ï¼Œé¢‘ç¹è¯·æ±‚æ•°æ®åº“ï¼Œæœ‰å¯èƒ½å¯¼è‡´æ•°æ®åº“å´©æºƒ</strong>)</p>
<p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li><p><span style="color:red">ç¼“å­˜ç©ºå¯¹è±¡</span></p>
<p>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿</p>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><p>é¢å¤–çš„å†…å­˜æ¶ˆè€—</p>
</li>
<li><p>å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´</p>
<p>(æŸ¥è¯¢ä¸€ä¸ªidæœªå‘½ä¸­ï¼ŒRediså†™å…¥ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œæ­¤æ—¶æ•°æ®åº“æ’å…¥è¿™ä¸ªidï¼Œå¯¼è‡´ä¿¡æ¯ä¸ä¸€è‡´)</p>
<pre class="mermaid">    sequenceDiagram
        å®¢æˆ·ç«¯->>Redis:è¯·æ±‚
        note left of Redis:æœªå‘½ä¸­
        Redis->>æ•°æ®åº“:è¯·æ±‚
        note left of æ•°æ®åº“:æœªå‘½ä¸­
        æ•°æ®åº“->>Redis:ç¼“å­˜null<br>è®¾ç½®TTL</pre></li>
</ul>
</li>
<li><p><span style="color:red">å¸ƒéš†è¿‡æ»¤</span></p>
<p>ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨è¾ƒå°‘ï¼Œæ²¡æœ‰å¤šä½™çš„key</p>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><p>å®ç°å¤æ‚</p>
</li>
<li><p>å­˜åœ¨è¯¯åˆ¤å¯èƒ½</p>
<pre class="mermaid">    sequenceDiagram
        å®¢æˆ·ç«¯->>å¸ƒéš†è¿‡æ»¤:è¯·æ±‚
        å¸ƒéš†è¿‡æ»¤->>å®¢æˆ·ç«¯:æ‹’ç»
        note left of å¸ƒéš†è¿‡æ»¤:ä¸å­˜åœ¨
        å¸ƒéš†è¿‡æ»¤->>Redis:æ”¾è¡Œï¼Œè¯·æ±‚
        note left of Redis:å­˜åœ¨
        Redis->>å®¢æˆ·ç«¯:è¿”å›
        note over Redis,å®¢æˆ·ç«¯:å‘½ä¸­
        Redis->>æ•°æ®åº“:è¯·æ±‚
        note left of æ•°æ®åº“:æœªå‘½ä¸­
        æ•°æ®åº“->>Redis:ç¼“å­˜æ•°æ®
        æ•°æ®åº“->>å®¢æˆ·ç«¯:è¿”å›æ•°æ®</pre></li>
</ul>
</li>
</ul>
<h3 id="2-6-ç¼“å­˜ç©ºå¯¹è±¡è§£å†³ç¼“å­˜ç©¿é€"><a href="#2-6-ç¼“å­˜ç©ºå¯¹è±¡è§£å†³ç¼“å­˜ç©¿é€" class="headerlink" title="2.6 ç¼“å­˜ç©ºå¯¹è±¡è§£å†³ç¼“å­˜ç©¿é€*"></a>2.6 ç¼“å­˜ç©ºå¯¹è±¡è§£å†³ç¼“å­˜ç©¿é€*</h3><p>å°±æ˜¯å°†ä¹‹å‰åˆ¤æ–­å•†é“ºä¸å­˜åœ¨æ—¶ï¼Œ<code>è¿”å›404ä¿¡æ¯</code>æ”¹ä¸º<code>å°†ç©ºå€¼å†™å…¥Redis</code></p>
<img src="https://s2.loli.net/2023/01/23/IQq65lHoPWDVrJt.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/IQq65lHoPWDVrJt.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-02-28.png" style="zoom:67%;" />



<p><code>ShopServiceImpl</code>ä¸­çš„<code>queryById</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//ä»RedisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸ä¸ºnullå’Œç©ºå­—ç¬¦ä¸²&quot;&quot;çš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//å­˜åœ¨ï¼Œè¿”å›ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‘½ä¸­çš„æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸ºnullä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//idä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key,<span class="comment">//key</span></span><br><span class="line">                <span class="string">&quot;&quot;</span>, <span class="comment">//ç©ºå€¼</span></span><br><span class="line">                RedisConstants.CACHE_NULL_TTL,<span class="comment">// 2</span></span><br><span class="line">                TimeUnit.MINUTES); <span class="comment">//åˆ†é’Ÿ</span></span><br><span class="line">        <span class="comment">//è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//idå­˜åœ¨ï¼Œå°†æ•°æ®å†™å…¥Redisï¼Œè®¾ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, <span class="comment">//key</span></span><br><span class="line">            JSONUtil.toJsonStr(shop), <span class="comment">// value</span></span><br><span class="line">            RedisConstants.CACHE_SHOP_TTL, <span class="comment">// 30</span></span><br><span class="line">            TimeUnit.MINUTES); <span class="comment">//åˆ†é’Ÿ</span></span><br><span class="line">    <span class="comment">//è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ç¼“å­˜ç©¿é€äº§ç”Ÿçš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>ç”¨æˆ·è¯·æ±‚çš„æ•°æ®å†ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä¸æ–­å‘èµ·è¿™æ ·çš„è¯·æ±‚ï¼Œç»™æ•°æ®åº“å¸¦æ¥äº†å·¨å¤§å‹åŠ›</li>
</ul>
<p>ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</p>
<ul>
<li><p>ç¼“å­˜nullå€¼</p>
</li>
<li><p>å¸ƒéš†è¿‡æ»¤</p>
</li>
<li><p>å¢åŠ idçš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœåˆ°idè§„å¾‹</p>
</li>
<li><p>åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ</p>
</li>
</ul>
</blockquote>
<h3 id="2-7-ç¼“å­˜é›ªå´©"><a href="#2-7-ç¼“å­˜é›ªå´©" class="headerlink" title="2.7 ç¼“å­˜é›ªå´©"></a>2.7 ç¼“å­˜é›ªå´©</h3><p><strong>ç¼“å­˜é›ªå´©</strong>æ˜¯æŒ‡åŒä¸€æ—¶é—´<strong>å¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆ</strong>æˆ–è€…<strong>RedisæœåŠ¡å®•æœº</strong>ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å‹åŠ›ã€‚</p>
<pre class="mermaid">sequenceDiagram
        å®¢æˆ·ç«¯->>Redis:è¯·æ±‚
        note over Redis:å®•æœºæˆ–å¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆ
        Redis->>æ•°æ®åº“:å¤§é‡è¯·æ±‚
        note left of æ•°æ®åº“:å¸¦æ¥å·¨å¤§å‹åŠ›
        æ•°æ®åº“->>å®¢æˆ·ç«¯:è¿”å›</pre>

<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<blockquote>
<ul>
<li><p>ç»™ä¸åŒçš„keyçš„TTLæ·»åŠ éšæœºå€¼</p>
</li>
<li><p>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§</p>
</li>
<li><p>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥</p>
</li>
<li><p>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜</p>
</li>
</ul>
</blockquote>
<h3 id="2-8-ç¼“å­˜å‡»ç©¿"><a href="#2-8-ç¼“å­˜å‡»ç©¿" class="headerlink" title="2.8 ç¼“å­˜å‡»ç©¿"></a>2.8 ç¼“å­˜å‡»ç©¿</h3><p><strong>ç¼“å­˜å‡»ç©¿é—®é¢˜</strong>ä¹Ÿå«<strong>çƒ­ç‚¹Kyé—®é¢˜</strong>ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«<strong>é«˜å¹¶å‘è®¿é—®</strong>å¹¶ä¸”<strong>ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„key</strong>çªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚(æœ‰ä¸€ä¸ªkeyå¤±æ•ˆï¼Œå¯¼è‡´å¤§é‡åŒæ—¶çš„å¤šä¸ªè¯·æ±‚è®¿é—®æ•°æ®åº“)</p>
<img src="https://s2.loli.net/2023/01/18/hUFzefXO93P8Ca5.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/18/hUFzefXO93P8Ca5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230118144229645.png" style="zoom:67%;" />

<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li><p>äº’æ–¥é”</p>
<img src="https://s2.loli.net/2023/01/18/FEfBzaUH8sPTnGv.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/18/FEfBzaUH8sPTnGv.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230118144727875.png" style="zoom:67%;" />
</li>
<li><p>é€»è¾‘è¿‡æœŸ</p>
<p>ç»™çƒ­ç‚¹keyè®¾ç½®ä¸€ä¸ªé€»è¾‘æ—¶æ•ˆ(ä¸åœ¨è®¾ç½®TTLï¼Œè€Œæ˜¯åœ¨valueä¸­æ·»åŠ ä¸€ä¸ªæ—¶æ•ˆå­—æ®µexpire)</p>
<table>
<thead>
<tr>
<th>KEY</th>
<th>VALUE</th>
</tr>
</thead>
<tbody><tr>
<td>heima:user:1</td>
<td>{name:â€Jackâ€, age: â€œ21â€, expire:15214223}</td>
</tr>
</tbody></table>
<img src="https://s2.loli.net/2023/01/18/GSQLMtYvE1suIpX.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/18/GSQLMtYvE1suIpX.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230118145709814.png" style="zoom: 67%;" /></li>
</ol>
<table>
<thead>
<tr>
<th>è§£å†³æ–¹æ¡ˆ</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td>äº’æ–¥é”</td>
<td>æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—<br>ä¿è¯ä¸€è‡´æ€§<br>å®ç°ç®€å•</td>
<td>çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å—å½±å“<br>å¯èƒ½æœ‰æ­»é”é£é™©</td>
</tr>
<tr>
<td>é€»è¾‘è¿‡æœŸ</td>
<td>çº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œæ€§èƒ½è¾ƒå¥½</td>
<td>ä¸ä¿è¯ä¸€è‡´æ€§<br>æœ‰é¢å¤–å†…å­˜æ¶ˆè€—(éœ€è¦ç»´æŠ¤expireå­—æ®µ)<br>å®ç°å¤æ‚</td>
</tr>
</tbody></table>
<h3 id="2-9åŸºäºäº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿"><a href="#2-9åŸºäºäº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿" class="headerlink" title="2.9åŸºäºäº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿*"></a>2.9åŸºäºäº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿*</h3><p>éœ€æ±‚ï¼šä¿®æ”¹æ ¹æ®dæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäºäº’æ–¥é”æ–¹å¼æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
<img src="https://s2.loli.net/2023/01/23/cvf5yoYUrlL6uHR.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/cvf5yoYUrlL6uHR.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-02-28.png" style="zoom:67%;" />



<p><strong>ä½¿ç”¨Redisä¸­çš„<code>setnx</code>å®ç°äº’æ–¥é”</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//ä¸Šé”ï¼Œåªæœ‰åœ¨keyå€¼ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯ä»¥è¢«è®¾ç½®;è®¾ç½®é”æ—¶ï¼Œä¸€èˆ¬ä¼šåŠ ä¸Šæœ‰æ•ˆæœŸ,é¿å…äº§ç”Ÿæ­»é”</span><br><span class="line">setnx lock 1</span><br><span class="line">//è§£é”</span><br><span class="line">del lock</span><br></pre></td></tr></table></figure>



<p><code>ShopServiceImpl</code>ä¸­çš„<code>queryById</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> querySolveCacheBreakdownByMutex(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è§£å†³ç¼“å­˜å‡»ç©¿ï¼Œé€šè¿‡äº’æ–¥é”è§£å†³</span></span><br><span class="line"><span class="keyword">private</span> Shop <span class="title function_">querySolveCacheBreakdownByMutex</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//ä»RedisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸ä¸ºnullå’Œç©ºå­—ç¬¦ä¸²&quot;&quot;çš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//å­˜åœ¨ï¼Œè¿”å›ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‘½ä¸­çš„æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lock</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å°è¯•è·å–äº’æ–¥é”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lock);</span><br><span class="line">        <span class="comment">//è·å–å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (!isLock)&#123;</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="comment">//é€’å½’ï¼Œç›´åˆ°èƒ½å¤Ÿè·å–åˆ°shop</span></span><br><span class="line">            <span class="keyword">return</span> querySolveCacheBreakdownByMutex(id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¸ºnullä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢</span></span><br><span class="line">        shop = getById(id);</span><br><span class="line">        <span class="comment">//idä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(key,<span class="comment">//key</span></span><br><span class="line">                                                  <span class="string">&quot;&quot;</span>, <span class="comment">//ç©ºå€¼</span></span><br><span class="line">                                                  RedisConstants.CACHE_NULL_TTL,<span class="comment">// 2</span></span><br><span class="line">                                                  TimeUnit.MINUTES); <span class="comment">//åˆ†é’Ÿ</span></span><br><span class="line">            <span class="comment">//è¿”å›ç©ºä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//idå­˜åœ¨ï¼Œå°†æ•°æ®å†™å…¥Redisï¼Œè®¾ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="comment">//key</span></span><br><span class="line">                                              JSONUtil.toJsonStr(shop), <span class="comment">// value</span></span><br><span class="line">                                              RedisConstants.CACHE_SHOP_TTL, <span class="comment">// 30</span></span><br><span class="line">                                              TimeUnit.MINUTES); <span class="comment">//åˆ†é’Ÿ</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//é‡Šæ”¾é”ï¼Œfinallyçš„æ‰§è¡Œæ—©äºtryé‡Œé¢çš„return</span></span><br><span class="line">        unlock(lock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    <span class="comment">//å°è¯•è·å–äº’æ–¥é”ï¼Œè®¾ç½®æœ‰æ•ˆæ—¶é—´</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key,</span><br><span class="line">                                                                 <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                                                                 <span class="number">10</span>, <span class="comment">//è®¾ç½®10ç§’</span></span><br><span class="line">                                                                 TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦è·å–é”</span></span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    <span class="comment">//è§£é”ï¼Œåˆ é™¤key</span></span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="2-10-åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿"><a href="#2-10-åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿" class="headerlink" title="2.10 åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿*"></a>2.10 åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿*</h3><p>éœ€æ±‚ï¼šä¿®æ”¹æ ¹æ®dæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼Œåˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
<img src="https://s2.loli.net/2023/01/23/VDKlyLJihvgbE7N.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/VDKlyLJihvgbE7N.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-02-28.png" style="zoom:67%;" />

<p><code>Shopç±»</code>ä¸­å¹¶æ²¡æœ‰<code>expireTimeå­—æ®µ</code>ï¼Œåœ¨Shopç±»ä¸­æ·»åŠ æ­¤å­—æ®µä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™æ ·å°±å¯¹åŸæ¥çš„ä¸šåŠ¡é€»è¾‘åšäº†ä¿®æ”¹ã€‚</p>
<p>å¯ä»¥æ–°å»ºä¸€ä¸ª<code>RedisDataç±»</code>ï¼Œæ·»åŠ <code>expireTimeå­—æ®µ</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>ShopServiceImpl</code>ä¸­çš„<code>queryById</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> querySolveCacheBreakdownByExpireTime(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è§£å†³ç¼“å­˜å‡»ç©¿ï¼Œé€šè¿‡é€»è¾‘è¿‡æœŸè§£å†³</span></span><br><span class="line"><span class="keyword">private</span> Shop <span class="title function_">querySolveCacheBreakdownByExpireTime</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//ä»RedisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">redisDataShopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸ºnullå’Œç©ºå­—ç¬¦ä¸²&quot;&quot;çš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(redisDataShopJson)) &#123;</span><br><span class="line">        <span class="comment">//ä¸å­˜åœ¨ï¼Œå°±ä¸æ˜¯çƒ­ç‚¹keyï¼Œä¸€èˆ¬çƒ­ç‚¹å•†é“ºéƒ½ä¼šæå‰å­˜å…¥Redisï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//jsonè½¬å¯¹è±¡</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(redisDataShopJson, RedisData.class);</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span>(!LocalDateTime.now().isAfter(redisData.getExpireTime()))&#123;</span><br><span class="line">        <span class="comment">//æœªè¿‡æœŸï¼Œè¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">lock</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//è·å–äº’æ–¥é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(tryLock(lock))&#123;</span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//æ³¨æ„ï¼éœ€è¦è¿›è¡ŒåŒé‡æ£€æŸ¥ï¼Œå› ä¸ºçº¿ç¨‹båœ¨çº¿ç¨‹aé‡å»ºç¼“å­˜å‰ï¼Œåˆ¤æ–­shopè¿‡æœŸ</span></span><br><span class="line">                <span class="comment">//åœ¨çº¿ç¨‹aé‡Šæ”¾é”åï¼Œå› ä¸ºæŸç§åŸå› çº¿ç¨‹bæ‰å¼€å§‹è·å–äº’æ–¥é”ï¼Œå¯¼è‡´é‡å¤é‡å»ºç¼“å­˜</span></span><br><span class="line">                <span class="comment">//æˆ‘æ‡’</span></span><br><span class="line">                <span class="comment">//é‡å»ºç¼“å­˜</span></span><br><span class="line">                addShop2Redis(shop.getId(), <span class="number">30L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">                unlock(lock);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ— è®ºæ˜¯å¦è¿‡æœŸéƒ½è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆ›å»ºçº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addShop2Redis</span><span class="params">(Long id, Long expireSeconds)</span>&#123;</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢shopä¿¡æ¯</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//å°è£…è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">    redisData.setData(shop);</span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));</span><br><span class="line">    <span class="comment">//å†™å…¥Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(</span><br><span class="line">        RedisConstants.CACHE_SHOP_KEY + id,</span><br><span class="line">        JSONUtil.toJsonStr(redisData));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    <span class="comment">//å°è¯•è·å–äº’æ–¥é”ï¼Œè®¾ç½®æœ‰æ•ˆæ—¶é—´</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key,</span><br><span class="line">                                                                 <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                                                                 <span class="number">10</span>, <span class="comment">//è®¾ç½®10ç§’</span></span><br><span class="line">                                                                 TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦è·å–é”</span></span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    <span class="comment">//è§£é”ï¼Œåˆ é™¤key</span></span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-11-ç¼“å­˜å·¥å…·å°è£…"><a href="#2-11-ç¼“å­˜å·¥å…·å°è£…" class="headerlink" title="2.11 ç¼“å­˜å·¥å…·å°è£…*"></a>2.11 ç¼“å­˜å·¥å…·å°è£…*</h3><p>åŸºäºStringRedisTemplateå°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»ï¼Œæ»¡è¶³ä¸‹åˆ—éœ€æ±‚ï¼š</p>
<ol>
<li>å°†ä»»javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶åŒ</li>
<li>å°†ä»»æ„javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶åŒï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜</li>
<li>æ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</li>
<li>æ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</li>
</ol>
<p>åˆ›å»º<code>CacheClientç±»</code>å°è£…ç¼“å­˜å·¥å…·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheClient</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithExpire</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        <span class="comment">//è®¾ç½®é€»è¾‘è¿‡æœŸ</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">        redisData.setData(value);</span><br><span class="line">        redisData.setExpireTime(LocalDateTime.now().plusSeconds(timeUnit.toSeconds(time)));</span><br><span class="line">        <span class="comment">//å†™å…¥Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¼“å­˜ç©¿é€</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, I&gt; T <span class="title function_">queryWithPenetration</span><span class="params">(String keyPrefix,</span></span><br><span class="line"><span class="params">                        I id, Class&lt;T&gt; type,</span></span><br><span class="line"><span class="params">                        Function&lt;I, T&gt; dbFallback,</span></span><br><span class="line"><span class="params">                        Long time, TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//ä¸ä¸ºnullå’Œ&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json))&#123;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¸º&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(json))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ•°æ®åº“æŸ¥è¯¢</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">        <span class="comment">//ä¸å­˜åœ¨ï¼Œå†™å…¥ç©ºå€¼</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="built_in">this</span>.set(key, <span class="string">&quot;&quot;</span>, RedisConstants.CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å­˜åœ¨</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, t, time, timeUnit);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¼“å­˜å‡»ç©¿åŸºäºäº’æ–¥é”</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, I&gt; T <span class="title function_">queryWithBreakdownByMutex</span><span class="params">(String keyPrefix,</span></span><br><span class="line"><span class="params">                                              I id, Class&lt;T&gt; type,</span></span><br><span class="line"><span class="params">                                              Function&lt;I, T&gt; dbFallback,</span></span><br><span class="line"><span class="params">                                              Long time, TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="comment">//ä»RedisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸ä¸ºnullå’Œç©ºå­—ç¬¦ä¸²&quot;&quot;çš„æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å‘½ä¸­çš„æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lock</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å°è¯•è·å–äº’æ–¥é”</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lock);</span><br><span class="line">            <span class="comment">//è·å–å¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (!isLock)&#123;</span><br><span class="line">                Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                <span class="comment">//é€’å½’ï¼Œç›´åˆ°èƒ½å¤Ÿè·å–åˆ°shop</span></span><br><span class="line">                <span class="keyword">return</span> queryWithBreakdownByMutex(keyPrefix, id, type, dbFallback, time, timeUnit);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//ä¸ºnullä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢</span></span><br><span class="line">            t = dbFallback.apply(id);</span><br><span class="line">            <span class="comment">//idä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">                <span class="built_in">this</span>.set(key, <span class="string">&quot;&quot;</span>, RedisConstants.CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//idå­˜åœ¨ï¼Œå°†æ•°æ®å†™å…¥Redisï¼Œè®¾ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">            <span class="built_in">this</span>.set(key, JSONUtil.toJsonStr(t), time, timeUnit);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”ï¼Œfinallyçš„æ‰§è¡Œæ—©äºtryé‡Œé¢çš„return</span></span><br><span class="line">            unlock(lock);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¼“å­˜å‡»ç©¿åˆ©ç”¨é€»è¾‘è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, I&gt; T <span class="title function_">queryWithBreakdownByExpireTime</span><span class="params">(String keyPrefix,</span></span><br><span class="line"><span class="params">                                              I id, Class&lt;T&gt; type,</span></span><br><span class="line"><span class="params">                                              Function&lt;I, T&gt; dbFallback,</span></span><br><span class="line"><span class="params">                                              Long addTime, TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="comment">//ä»RedisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">redisDataShopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸ºnullå’Œç©ºå­—ç¬¦ä¸²&quot;&quot;çš„æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(redisDataShopJson)) &#123;</span><br><span class="line">            <span class="comment">//ä¸å­˜åœ¨ï¼Œå°±ä¸æ˜¯çƒ­ç‚¹keyï¼Œä¸€èˆ¬çƒ­ç‚¹å•†é“ºéƒ½ä¼šæå‰å­˜å…¥Redisï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//jsonè½¬å¯¹è±¡</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(redisDataShopJson, RedisData.class);</span><br><span class="line">        <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">        <span class="keyword">if</span>(!LocalDateTime.now().isAfter(redisData.getExpireTime()))&#123;</span><br><span class="line">            <span class="comment">//æœªè¿‡æœŸï¼Œè¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">lock</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="comment">//è·å–äº’æ–¥é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span>(tryLock(lock))&#123;</span><br><span class="line">            CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//æ³¨æ„ï¼éœ€è¦è¿›è¡ŒåŒé‡æ£€æŸ¥ï¼Œå› ä¸ºçº¿ç¨‹båœ¨çº¿ç¨‹aé‡å»ºç¼“å­˜å‰ï¼Œåˆ¤æ–­shopè¿‡æœŸ</span></span><br><span class="line">                    <span class="comment">//åœ¨çº¿ç¨‹aé‡Šæ”¾é”åï¼Œå› ä¸ºæŸç§åŸå› çº¿ç¨‹bæ‰å¼€å§‹è·å–äº’æ–¥é”ï¼Œå¯¼è‡´é‡å¤é‡å»ºç¼“å­˜</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//é‡å»ºç¼“å­˜</span></span><br><span class="line">                    <span class="built_in">this</span>.setWithExpire(key, dbFallback.apply(id), addTime, timeUnit);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">                    unlock(lock);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ— è®ºæ˜¯å¦è¿‡æœŸéƒ½è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String lockKey)</span>&#123;</span><br><span class="line">        <span class="comment">//å°è¯•è·å–äº’æ–¥é”ï¼Œè®¾ç½®æœ‰æ•ˆæ—¶é—´</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(lockKey,</span><br><span class="line">                <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="number">10</span>, <span class="comment">//è®¾ç½®10ç§’</span></span><br><span class="line">                TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦è·å–é”</span></span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String lockKey)</span>&#123;</span><br><span class="line">        <span class="comment">//è§£é”ï¼Œåˆ é™¤key</span></span><br><span class="line">        stringRedisTemplate.delete(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>ShopServiceImpl</code>ä¸­çš„<code>queryById</code>æ–¹æ³•ä¸­ï¼Œç›´æ¥è°ƒç”¨<code>CacheClient </code>çš„æ–¹æ³•å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> CacheClient cacheClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//ç¼“å­˜ç©¿é€</span></span><br><span class="line">    <span class="comment">/*Shop shop = cacheClient.queryWithPenetration(</span></span><br><span class="line"><span class="comment">                RedisConstants.CACHE_SHOP_KEY,</span></span><br><span class="line"><span class="comment">                id,</span></span><br><span class="line"><span class="comment">                Shop.class,</span></span><br><span class="line"><span class="comment">                this::getById,</span></span><br><span class="line"><span class="comment">                30L, TimeUnit.MINUTES);*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¼“å­˜å‡»ç©¿åŸºäºäº’æ–¥é”</span></span><br><span class="line">    <span class="comment">/*Shop shop = cacheClient.queryWithBreakdownByMutex(</span></span><br><span class="line"><span class="comment">                RedisConstants.CACHE_SHOP_KEY,</span></span><br><span class="line"><span class="comment">                id,</span></span><br><span class="line"><span class="comment">                Shop.class,</span></span><br><span class="line"><span class="comment">                this::getById,</span></span><br><span class="line"><span class="comment">                30L, TimeUnit.SECONDS);*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¼“å­˜å‡»ç©¿åˆ©ç”¨é€»è¾‘è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> cacheClient.queryWithBreakdownByExpireTime(</span><br><span class="line">        RedisConstants.CACHE_SHOP_KEY,</span><br><span class="line">        id,</span><br><span class="line">        Shop.class,</span><br><span class="line">        <span class="built_in">this</span>::getById,</span><br><span class="line">        <span class="number">30L</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div><div class="story post-story"><h2 id="3-ä¼˜æƒ åˆ¸ç§’æ€"><a href="#3-ä¼˜æƒ åˆ¸ç§’æ€" class="headerlink" title="3.ä¼˜æƒ åˆ¸ç§’æ€"></a>3.ä¼˜æƒ åˆ¸ç§’æ€</h2><h3 id="3-1-å…¨å±€å”¯ä¸€ID"><a href="#3-1-å…¨å±€å”¯ä¸€ID" class="headerlink" title="3.1 å…¨å±€å”¯ä¸€ID"></a>3.1 å…¨å±€å”¯ä¸€ID</h3><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼›</p>
<p>å½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ°<code>tb_voucher_order</code>è¿™å¼ è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDå°±å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p>
<ul>
<li>idçš„è§„å¾‹æ€§å¤ªæ˜æ˜¾</li>
<li>å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</li>
</ul>
<p>å…¨å±€Dç”Ÿæˆå™¨ï¼Œæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸‹åˆ—ç‰¹æ€§ï¼š</p>
<ul>
<li>å”¯ä¸€æ€§</li>
<li>é«˜å¯ç”¨</li>
<li>é«˜æ€§èƒ½</li>
<li>é€’å¢æ€§</li>
<li>å®‰å…¨æ€§</li>
</ul>
<p>ä¸ºäº†å¢åŠ IDçš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥ä½¿ç”¨Redisè‡ªå¢çš„æ•°å€¼ï¼Œè€Œæ˜¯æ‹¼æ¥ä¸€äº›å…¶å®ƒä¿¡æ¯ï¼š</p>
<p><img src="https://s2.loli.net/2023/01/24/mVndfKosv1MWEOi.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/24/mVndfKosv1MWEOi.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-24_23-06-42.png"></p>
<p>IDçš„ç»„æˆéƒ¨åˆ†ï¼š</p>
<ul>
<li>ç¬¦å·ä½ï¼š1bitï¼Œæ°¸è¿œä¸º0</li>
<li>æ—¶é—´æˆ³ï¼š31btï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨69å¹´</li>
<li>åºåˆ—å·ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒID</li>
</ul>
<h3 id="3-2-Rediså®ç°å…¨å±€å”¯ä¸€ID"><a href="#3-2-Rediså®ç°å…¨å±€å”¯ä¸€ID" class="headerlink" title="3.2 Rediså®ç°å…¨å±€å”¯ä¸€ID*"></a>3.2 Rediså®ç°å…¨å±€å”¯ä¸€ID*</h3><p>åˆ›å»º<code>RedisIdWorkerç±»</code>å®ç°å…¨å±€å”¯ä¸€IDï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="comment">//èµ·å§‹æ—¶é—´æˆ³ä¸º2023/1/1 00:00:00</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">START_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1672531200L</span>;</span><br><span class="line">    <span class="comment">//åºåˆ—å·ä½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SN</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdWorker</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span>&#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="comment">//è·å–å½“å‰æ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="comment">//è·å–æ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> current - START_TIMESTAMP;</span><br><span class="line">        <span class="comment">//è·å–ä»Šå¤©çš„æ—¥æœŸ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Redisè‡ªå¢ï¼Œç”Ÿæˆä»Šå¤©çš„åºåˆ—å·</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;inc:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + date;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">increment</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ‹¼æ¥æ—¶é—´æˆ³å’Œåºåˆ—å·</span></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; SN | increment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>å…¨å±€å”¯ä¸€Dç”Ÿæˆç­–ç•¥ï¼š</p>
<ul>
<li>UUID</li>
<li>Redisè‡ªå¢</li>
<li>snowflakeç®—æ³•</li>
<li>æ•°æ®åº“è‡ªå¢</li>
</ul>
<p>Redisè‡ªå¢IDç­–ç•¥ï¼š</p>
<ul>
<li>æ¯å¤©ä¸€ä¸ªkeyï¼Œæ–¹ä¾¿ç»Ÿè®¡è®¢å•é‡</li>
<li>IDæ„é€ ä¸ºæ—¶é—´æˆ³+åºåˆ—å·</li>
</ul>
</blockquote>
<h3 id="3-3-æ·»åŠ ä¼˜æƒ åˆ¸"><a href="#3-3-æ·»åŠ ä¼˜æƒ åˆ¸" class="headerlink" title="3.3 æ·»åŠ ä¼˜æƒ åˆ¸"></a>3.3 æ·»åŠ ä¼˜æƒ åˆ¸</h3><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œåˆ†ä¸ºå¹³ä»·åˆ¸å’Œç‰¹ä»·åˆ¸ã€‚å¹³ä»·åˆ¸(æŠ˜æ‰£å°)å¯ä»¥ä»»æ„è´­ä¹°ï¼Œè€Œç‰¹ä»·åˆ¸(æŠ˜æ‰£å¤§)éœ€è¦ç§’æ€æŠ¢è´­ï¼š</p>
<p>è¡¨å…³ç³»å¦‚ä¸‹ï¼š</p>
<ul>
<li>tb_voucherï¼šä¼˜æƒ åˆ¸çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¼˜æƒ é‡‘é¢ã€ä½¿ç”¨è§„åˆ™ç­‰</li>
<li>tb_seckill_voucherï¼šä¼˜æƒ åˆ¸çš„åº“å­˜ã€å¼€å§‹æŠ¢è´­æ—¶é—´ï¼Œç»“æŸæŠ¢è´­æ—¶é—´ã€‚<strong>ç‰¹ä»·ä¼˜æƒ åˆ¸æ‰éœ€è¦å¡«å†™è¿™äº›ä¿¡æ¯</strong></li>
</ul>
<p>æ·»åŠ ç‰¹ä»·ä¼˜æƒ åˆ¸ä¸šåŠ¡é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherMapper, Voucher&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸ï¼Œmybatis-plusåœ¨æ‰§è¡Œsaveæ–¹æ³•åè‡ªåŠ¨è¿”å›ID</span></span><br><span class="line">        save(voucher);</span><br><span class="line">        <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">        seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">        seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">        seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">        seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">        seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æ·»åŠ ç‰¹ä»·ä¼˜æƒ åˆ¸éœ€è¦åå°æ·»åŠ ï¼Œå¯ä»¥ä½¿ç”¨postmanæ¨¡æ‹Ÿï¼š</p>
<img src="https://s2.loli.net/2023/01/25/fZhVujRP6FcMiON.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/fZhVujRP6FcMiON.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png" style="zoom: 67%;" />



<h3 id="3-4-å®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•"><a href="#3-4-å®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•" class="headerlink" title="3.4 å®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•"></a>3.4 å®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•</h3><p>ä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š</p>
<ul>
<li>ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•</li>
<li>åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•</li>
</ul>
<img src="https://s2.loli.net/2023/01/25/UZpBnJM4FyVqXT5.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/UZpBnJM4FyVqXT5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png" style="zoom:67%;" />



<p>å®ç°<code>VoucherOrderServiceImpl</code>ä¸­çš„<code>seckillVoucher</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">//æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ—¶é—´</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;æœªåœ¨è§„å®šæ—¶é—´å†…&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ£€æŸ¥åº“å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å‡æ‰£åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="comment">//è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-5-åº“å­˜è¶…å–é—®é¢˜åˆ†æ"><a href="#3-5-åº“å­˜è¶…å–é—®é¢˜åˆ†æ" class="headerlink" title="3.5 åº“å­˜è¶…å–é—®é¢˜åˆ†æ"></a>3.5 åº“å­˜è¶…å–é—®é¢˜åˆ†æ</h3><p>åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œæˆ–å¯èƒ½ä¼šå¯¼è‡´åº“å­˜æ•°é‡å˜ä¸ºè´Ÿæ•°ï¼Œå‘ç”Ÿåº“å­˜è¶…å–çš„æƒ…å†µï¼š</p>
<img src="https://s2.loli.net/2023/01/25/hB3SdaQpcP1MtqX.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/hB3SdaQpcP1MtqX.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png" style="zoom:67%;" />



<p>è¶…å–é—®é¢˜æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼š</p>
<blockquote>
<p><strong>æ‚²è§‚é”</strong>ï¼šè®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜<strong>ä¸€å®š</strong>ä¼šå‘ç”Ÿï¼Œå› æ­¤åœ¨æ“ä½œæ•°æ®ä¹‹å‰å…ˆè·å–é”ï¼Œç¡®ä¿çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œã€‚</p>
<ul>
<li>ä¾‹å¦‚Synchronizedã€Lockéƒ½å±äºæ‚²è§‚é”</li>
</ul>
<p><strong>ä¹è§‚é”</strong>ï¼šè®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜<strong>ä¸ä¸€å®š</strong>ä¼šå‘ç”Ÿï¼Œå› æ­¤ä¸åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®æ—¶å»åˆ¤æ–­æœ‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹å¯¹æ•°æ®åšäº†ä¿®æ”¹ã€‚</p>
<ul>
<li>å¦‚æœæ²¡æœ‰ä¿®æ”¹åˆ™è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œè‡ªå·±æ‰æ›´æ–°æ•°æ®ã€‚</li>
<li>å¦‚æœå·²ç»è¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹è¯´æ˜å‘ç”Ÿäº†å®‰å…¨é—®é¢˜ï¼Œæ­¤æ—¶å¯ä»¥é‡è¯•æˆ–å¼‚å¸¸ã€‚</li>
</ul>
</blockquote>
<p><strong>CASæ³•</strong>ï¼š</p>
<img src="https://s2.loli.net/2023/01/25/bcOnadB2UuNXmyW.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/bcOnadB2UuNXmyW.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png" style="zoom:67%;" />

<p>ä¿®æ”¹sqlè¯­å¥å³å¯ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> stock <span class="operator">=</span> stock <span class="operator">-</span> <span class="number">1</span> <span class="keyword">where</span> voucher_id <span class="operator">=</span> ? <span class="keyword">and</span> stock <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure>



<h3 id="3-6-ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜"><a href="#3-6-ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜" class="headerlink" title="3.6 ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜*"></a>3.6 ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜*</h3><p>ä¿®æ”¹<code>VoucherOrderServiceImpl</code>ä¸­çš„<code>seckillVoucher</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ—¶é—´</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æœªåœ¨è§„å®šæ—¶é—´å†…&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ£€æŸ¥åº“å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‡æ‰£åº“å­˜</span></span><br><span class="line">    <span class="comment">//set stock = stock-1 where voucher_id = ? and stock = ?</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">        .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">        .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">        .eq(<span class="string">&quot;stock&quot;</span>, voucher.getStock())</span><br><span class="line">        .update();</span><br><span class="line">    <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="comment">//è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä½†æ˜¯è¿™æ ·åšï¼Œåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚ï¼šåº“å­˜æœ‰100ä¸ªã€æ­¤æ—¶æœ‰100çº¿ç¨‹åŒæ—¶ç§’æ€ï¼Œä¼šå¯¼è‡´åªæœ‰ä¸€ä¸ªçº¿ç¨‹ç§’æ€æˆåŠŸï¼Œå…¶ä½™99ä¸ªçº¿ç¨‹å‡å¤±è´¥ï¼Œ<strong>å¤±è´¥ç‡è¿‡é«˜</strong></p>
</blockquote>
<p>å¯ä»¥æ”¹ä¸ºï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> stock <span class="operator">=</span> stock <span class="operator">-</span> <span class="number">1</span> <span class="keyword">where</span> voucher_id <span class="operator">=</span> ? <span class="keyword">and</span> stock <span class="operator">&gt;</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>å†æ¬¡ä¿®æ”¹<code>VoucherOrderServiceImpl</code>ä¸­çš„<code>seckillVoucher</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ—¶é—´</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;æœªåœ¨è§„å®šæ—¶é—´å†…&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ£€æŸ¥åº“å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‡æ‰£åº“å­˜</span></span><br><span class="line">    <span class="comment">//set stock = stock-1 where voucher_id = ? and stock &gt; 0</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">        .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">        .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">        .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        .update();</span><br><span class="line">    <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="comment">//è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>è¶…å–è¿™æ ·çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>æ‚²è§‚é”ï¼šæ·»åŠ åŒæ­¥é”ï¼Œè®©çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ<ul>
<li>ä¼˜ç‚¹ï¼šç®€å•ç²—æš´</li>
<li>ç¼ºç‚¹ï¼šæ€§èƒ½ä¸€èˆ¬</li>
</ul>
</li>
<li>ä¹è§‚é”ï¼šä¸åŠ é”ï¼Œåœ¨æ›´æ–°æ—¶åˆ¤æ–­æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹åœ¨ä¿®æ”¹<ul>
<li>ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½</li>
<li>ç¼ºç‚¹ï¼šå­˜åœ¨æˆåŠŸç‡ä½çš„é—®é¢˜</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="3-7-å®ç°ä¸€äººä¸€å•åŠŸèƒ½"><a href="#3-7-å®ç°ä¸€äººä¸€å•åŠŸèƒ½" class="headerlink" title="3.7 å®ç°ä¸€äººä¸€å•åŠŸèƒ½*"></a>3.7 å®ç°ä¸€äººä¸€å•åŠŸèƒ½*</h3><p>éœ€æ±‚ï¼šä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•</p>
<img src="https://s2.loli.net/2023/01/25/2JIwgTADmxMrKlZ.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/2JIwgTADmxMrKlZ.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png" style="zoom:67%;" />

<p>æ·»åŠ ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ·»åŠ æ³¨è§£ï¼Œå¼€å¯æš´éœ²ä»£ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAspectJAutoProxy(exposeProxy = true)</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.hmdp.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HmDianPingApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HmDianPingApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;ã€</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹<code>VoucherOrderServiceImpl</code>çš„<code>seckillVoucher</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">//æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ—¶é—´</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;æœªåœ¨è§„å®šæ—¶é—´å†…&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ£€æŸ¥åº“å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//intern()æ–¹æ³•:å¦‚æœå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨ä¸€ä¸ªç­‰äºæ­¤Stringå¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œå°±ç›´æ¥ä»å¸¸é‡æ± ä¸­è¿”å›è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">        <span class="comment">//å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ä¸å­˜åœ¨è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œé‚£ä¹ˆå°±æ–°å»ºå¹¶æ·»åŠ è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œå¹¶è¿”å›æ–°å»ºçš„å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">        <span class="comment">//é”ä½userIdç›¸åŒåœ°è¯·æ±‚ï¼Œåº”è¯¥å…ˆæäº¤äº‹åŠ¡ï¼Œå†é‡Šæ”¾é”</span></span><br><span class="line">        <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">            <span class="comment">//thisè°ƒç”¨ä¼šå¯¼è‡´äº‹åŠ¡ä¸ç”Ÿæ•ˆï¼Œå¯ä»¥é€šè¿‡AopContextè·å–åˆ°Proxyå¯¹è±¡,ä»è€Œå®ç°ä»£ç†.</span></span><br><span class="line">            <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">//æ£€æŸ¥ä¸€äººä¸€å•</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å‡æ‰£åº“å­˜</span></span><br><span class="line">        <span class="comment">//set stock = stock-1 where voucher_id = ? and stock &gt; 0</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="comment">//è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-8-ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜"><a href="#3-8-ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜" class="headerlink" title="3.8 ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜"></a>3.8 ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜</h3><p>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨<strong>å•æœºæƒ…å†µ</strong>ä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åœ¨<strong>é›†ç¾¤æ¨¡å¼</strong>ä¸‹å°±ä¸è¡Œäº†ã€‚</p>
<ol>
<li><p>æˆ‘ä»¬å°†æœåŠ¡å¯åŠ¨ä¸¤ä»½ï¼Œç«¯å£åˆ†åˆ«ä¸º<strong>8081</strong>å’Œ<strong>8082</strong></p>
</li>
<li><p>ç„¶åä¿®æ”¹nginxçš„confç›®å½•ä¸‹çš„nginx.confæ–‡ä»¶ï¼Œé…ç½®åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">	server 127.0.0.1:8081 max_fails=5 fail_timeout=10s weight=1;</span><br><span class="line">	server 127.0.0.1:8082 max_fails=5 fail_timeout=10s weight=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç”¨æˆ·è¯·æ±‚ä¼šåœ¨è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šè´Ÿè½½å‡è¡¡ï¼Œå†æ¬¡æµ‹è¯•ä¸‹æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
</li>
</ol>
<p>ä¸¤ä¸ªæœåŠ¡(ä¸¤ä¸ªè¿›ç¨‹)ï¼Œå¯¼è‡´é”å¤±æ•ˆï¼š</p>
<p><img src="https://s2.loli.net/2023/01/25/Cb5c8MTFtgAQS9x.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/Cb5c8MTFtgAQS9x.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png"></p>
</div><div class="story post-story"><h2 id="4-åˆ†å¸ƒå¼é”"><a href="#4-åˆ†å¸ƒå¼é”" class="headerlink" title="4.åˆ†å¸ƒå¼é”"></a>4.åˆ†å¸ƒå¼é”</h2><h3 id="4-1-åˆ†å¸ƒå¼é”çš„åŸºæœ¬åŸç†"><a href="#4-1-åˆ†å¸ƒå¼é”çš„åŸºæœ¬åŸç†" class="headerlink" title="4.1 åˆ†å¸ƒå¼é”çš„åŸºæœ¬åŸç†"></a>4.1 åˆ†å¸ƒå¼é”çš„åŸºæœ¬åŸç†</h3><p><img src="https://s2.loli.net/2023/01/25/ImCMd7VriUjOu5w.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/ImCMd7VriUjOu5w.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png"></p>
<p><strong>åˆ†å¸ƒå¼é”</strong>ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”ã€‚</p>
<ul>
<li>å¤šè¿›ç¨‹å¯è§</li>
<li>äº’æ–¥</li>
<li>é«˜å¯ç”¨</li>
<li>é«˜æ€§èƒ½</li>
<li>å®‰å…¨æ€§</li>
</ul>
<p>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ˜¯å®ç°å¤šè¿›ç¨‹ä¹‹é—´äº’æ–¥ï¼Œè€Œæ»¡è¶³è¿™ä¸€ç‚¹çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰ä¸‰ç§ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>MySQL</th>
<th>Redis</th>
<th>Zookeeper</th>
</tr>
</thead>
<tbody><tr>
<td>äº’æ–¥</td>
<td>åˆ©ç”¨mysqlæœ¬èº«çš„äº’æ–¥é”æœºåˆ¶</td>
<td>åˆ©ç”¨setnxiè¿™æ ·çš„äº’æ–¥å‘½ä»¤</td>
<td>åˆ©ç”¨èŠ‚ç‚¹çš„å”¯ä¸€æ€§å’Œæœ‰åºæ€§å®ç°äº’æ–¥</td>
</tr>
<tr>
<td>é«˜å¯ç”¨</td>
<td>å¥½</td>
<td>å¥½</td>
<td>å¥½</td>
</tr>
<tr>
<td>é«˜æ€§èƒ½</td>
<td>ä¸€èˆ¬</td>
<td>å¥½</td>
<td>ä¸€èˆ¬</td>
</tr>
<tr>
<td>å®‰å…¨æ€§</td>
<td>æ–­å¼€è¿æ¥ï¼Œè‡ªåŠ¨é‡Šæ”¾é”</td>
<td>åˆ©ç”¨é”è¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸé‡Šæ”¾</td>
<td>ä¸´æ—¶èŠ‚ç‚¹ï¼Œæ–­å¼€è¿æ¥è‡ªåŠ¨é‡Šæ”¾</td>
</tr>
</tbody></table>
<h3 id="4-2-Redisåˆ†å¸ƒå¼é”å®ç°æ€è·¯"><a href="#4-2-Redisåˆ†å¸ƒå¼é”å®ç°æ€è·¯" class="headerlink" title="4.2 Redisåˆ†å¸ƒå¼é”å®ç°æ€è·¯"></a>4.2 Redisåˆ†å¸ƒå¼é”å®ç°æ€è·¯</h3><p>å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼š</p>
<ul>
<li><p>è·å–é”ï¼š</p>
<ul>
<li><p>äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”</p>
</li>
<li><p>éé˜»å¡ï¼šå°è¯•ä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æµåŠ é”ï¼Œåˆ©ç”¨setnxçš„äº’æ–¥ç‰¹æ€§</span></span><br><span class="line">SETNX lock thread1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ·»åŠ é”è¿‡æœŸæ—¶é—´ï¼Œé¿å…æœåŠ¡å®•æœºå¼•èµ·çš„æ­»é”</span></span><br><span class="line">EXPIRE lock 10</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">==&gt;</span></span><br><span class="line">SET lock thread1 NX EX 10</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>é‡Šæ”¾é”ï¼š</p>
<ul>
<li><p>æ‰‹åŠ¨é‡Šæ”¾</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">é‡Šæ”¾é”ï¼Œåˆ é™¤å³å¯</span></span><br><span class="line">DEL key</span><br></pre></td></tr></table></figure>
</li>
<li><p>è¶…æ—¶é‡Šæ”¾ï¼šè·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´</p>
</li>
</ul>
</li>
</ul>
<img src="https://s2.loli.net/2023/01/28/tyvABwoPWT4Gn2e.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/28/tyvABwoPWT4Gn2e.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-28_19-17-46.png" style="zoom:67%;" />

 

<h3 id="4-3-å®ç°Redisåˆ†å¸ƒå¼é”"><a href="#4-3-å®ç°Redisåˆ†å¸ƒå¼é”" class="headerlink" title="4.3 å®ç°Redisåˆ†å¸ƒå¼é”"></a>4.3 å®ç°Redisåˆ†å¸ƒå¼é”</h3><p>éœ€æ±‚ï¼šå®šä¹‰ä¸€ä¸ªç±»ï¼Œå®ç°ä¸‹é¢æ¥å£ï¼Œåˆ©ç”¨Rediså®ç°åˆ†å¸ƒå¼é”åŠŸèƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span>;</span><br><span class="line">    <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å®ç°ILockæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="comment">//ä¸šåŠ¡åç§°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String businessName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String businessName, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.businessName = businessName;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + businessName, String.valueOf(value), timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(KEY_PREFIX + businessName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä¿®æ”¹<code>VoucherOrderServiceImpl</code>ä¸­çš„<code>seckillVoucher</code>æ–¹æ³•ä¸šåŠ¡é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ—¶é—´</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æœªåœ¨è§„å®šæ—¶é—´å†…&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ£€æŸ¥åº“å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line">    <span class="type">SimpleRedisLock</span> <span class="variable">isLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRedisLock</span>(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> isLock.tryLock(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span> (!flag)&#123;</span><br><span class="line">        <span class="comment">//è·å–é”å¤±è´¥ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//thisè°ƒç”¨ä¼šå¯¼è‡´äº‹åŠ¡ä¸ç”Ÿæ•ˆï¼Œå¯ä»¥é€šè¿‡AopContextè·å–åˆ°Proxyå¯¹è±¡,ä»è€Œå®ç°ä»£ç†.</span></span><br><span class="line">        <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="comment">//ç”Ÿæˆä¸€äººä¸€å•çš„è®¢å•</span></span><br><span class="line">        <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">        isLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜"><a href="#4-4-Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜" class="headerlink" title="4.4 Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜"></a>4.4 Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</h3><img src="https://s2.loli.net/2023/01/28/4NxZewbU1j8WkgH.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/28/4NxZewbU1j8WkgH.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-28_19-17-46.png" style="zoom:67%;" />

<img src="https://s2.loli.net/2023/01/28/CNPvc9AgR8J1Xmx.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/28/CNPvc9AgR8J1Xmx.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-28_19-17-46.png" style="zoom: 67%;" />



<p>éœ€æ±‚ï¼šä¿®æ”¹ä¹‹å‰çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œæ»¡è¶³ï¼š</p>
<ol>
<li>åœ¨è·å–é”æ—¶å­˜å…¥çº¿ç¨‹æ ‡ç¤º(å¯ä»¥ç”¨UUIDè¡¨ç¤º)</li>
<li>åœ¨é‡Šæ”¾é”æ—¶å…ˆè·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´<ul>
<li>å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”</li>
<li>å¦‚æœä¸ä¸€è‡´åˆ™ä¸é‡Šæ”¾é”</li>
</ul>
</li>
</ol>
<p>ä¿®æ”¹<code>SimpleRedisLock</code>ç±»ï¼Œæ·»åŠ çº¿ç¨‹æ ‡ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line">    <span class="comment">//ä¸šåŠ¡åç§°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String businessName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String businessName, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.businessName = businessName;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + businessName, value, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–å½“å‰çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">//è·å–valueå€¼</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + businessName);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹çš„é”</span></span><br><span class="line">        <span class="keyword">if</span>(value.equals(result))&#123;</span><br><span class="line">            stringRedisTemplate.delete(KEY_PREFIX + businessName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-5-åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜"><a href="#4-5-åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜" class="headerlink" title="4.5 åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜"></a>4.5 åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</h3><img src="https://s2.loli.net/2023/01/28/TPewK3VD6M5vho8.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/28/TPewK3VD6M5vho8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-28_19-17-46.png" style="zoom:67%;" />



<p>åœ¨é‡Šæ”¾é”æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦ä¸€è‡´æ—¶ï¼Œå› ä¸ºæŸç§åŸå› å¯¼è‡´é˜»å¡ï¼Œç»è¿‡ä¸€æ®µæ—¶é—´åæ‰é‡Šæ”¾é”ï¼Œäº§ç”Ÿçš„åŸå­æ€§é—®é¢˜</p>
<p>åˆ¤æ–­æ˜¯å¦ä¸€è‡´æ—¶å’Œé‡Šæ”¾é”ï¼Œåº”è¯¥ç»‘å®šåœ¨ä¸€èµ·æ‰§è¡Œ</p>
<h3 id="4-6-luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜"><a href="#4-6-luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜" class="headerlink" title="4.6 luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜"></a>4.6 luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</h3><p>Redis:æä¾›äº†Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡Redisiå‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚Luaæ˜¯ä¸€ç§ç¼–<br>ç¨‹è¯­è¨€ï¼Œå®ƒçš„åŸºæœ¬è¯­æ³•å¤§å®¶å¯ä»¥å‚è€ƒç½‘ç«™ï¼š<a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-tutorial.html">Luaæ•™ç¨‹|èœé¸Ÿæ•™ç¨‹</a></p>
<p>è¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--æ‰§è¡Œrediså‘½ä»¤</span></span><br><span class="line">redis.call(<span class="string">&#x27;å‘½ä»¤åç§°&#x27;</span>, <span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;å…¶å®ƒå‚æ•°&#x27;</span>, ...)</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼šæˆ‘ä»¬è¦æ‰§è¡Œ<code>set name jack</code>ï¼Œåˆ™è„šæœ¬æ˜¯è¿™æ ·ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--æ‰§è¡Œset name jack</span></span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦å…ˆæ‰§è¡Œ<code>set name Rose</code>ï¼Œå†æ‰§è¡Œ<code>get name</code>ï¼Œåˆ™è„šæœ¬å¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--å…ˆæ‰§è¡Œset name jack</span></span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br><span class="line"><span class="comment">--å†æ‰§è¡Œget name</span></span><br><span class="line"><span class="keyword">local</span> name redis.call(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"><span class="comment">--è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> name</span><br></pre></td></tr></table></figure>

<p>å†™å¥½è„šæœ¬ä»¥åï¼Œéœ€è¦ç”¨Rediså‘½ä»¤æ¥è°ƒç”¨è„šæœ¬ï¼Œè°ƒç”¨è„šæœ¬çš„å¸¸è§å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt;help @scripting</span><br><span class="line"></span><br><span class="line">EVAL script numkeys key [key ...] arg [arg ...]</span><br><span class="line">summary: Execute a Lua script server side</span><br><span class="line">since: 2.6.0</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œ<code>redis.call(&#39;set&#39;, &#39;name&#39;, &#39;jack&#39;)</code>è¿™ä¸ªè„šæœ¬ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è°ƒç”¨è„šæœ¬ï¼Œè„šæœ¬å†…å®¹ã€éœ€è¦keyå‚æ•°çš„ä¸ªæ•°</span></span><br><span class="line">EVAL &quot;return redis.call(&#x27;set&#x27;,&#x27;name&#x27;,&#x27;jack&#x27;)&quot; 0</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè„šæœ¬ä¸­çš„keyã€valueä¸æƒ³å†™æ­»ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ã€‚keyç±»å‹å‚æ•°ä¼šæ”¾å…¥KEYSæ•°ç»„ï¼Œå…¶å®ƒå‚æ•°ä¼šæ”¾å…¥ARGVæ•°ç»„ï¼Œåœ¨è„šæœ¬ä¸­å¯ä»¥ä»KEYSå’ŒARGVæ•°ç»„è·å–è¿™äº›å‚æ•°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è°ƒç”¨è„šæœ¬</span></span><br><span class="line">EVAL &quot;return redis.call(&#x27;set&#x27;,KEYS[1],ARGV[1])&quot; 1 name Rose</span><br></pre></td></tr></table></figure>

<p>é‡Šæ”¾é”çš„ä¸šåŠ¡æµç¨‹ï¼š</p>
<ol>
<li>è·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤º</li>
<li>åˆ¤æ–­æ˜¯å¦ä¸æŒ‡å®šçš„æ ‡ç¤º(å½“å‰çº¿ç¨‹æ ‡ç¤º)ä¸€è‡´</li>
<li>å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”(åˆ é™¤)</li>
<li>å¦‚æœä¸ä¸€è‡´åˆ™ä»€ä¹ˆéƒ½ä¸åš</li>
</ol>
<p>ç”¨Luaè„šæœ¬å®ç°ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--è¿™é‡Œçš„KEYS[1]å°±æ˜¯é”çš„keyï¼Œè¿™é‡Œçš„ARGV[1]å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line"><span class="comment">--è·å–é”ä¸­çš„æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;GET&#x27;</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">	<span class="comment">--ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”</span></span><br><span class="line">	<span class="keyword">return</span> redis.call(<span class="string">&#x27;DEL&#x27;</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>



<h3 id="4-7-javaè°ƒç”¨luaè„šæœ¬æ”¹è¿›åˆ†å¸ƒå¼é”"><a href="#4-7-javaè°ƒç”¨luaè„šæœ¬æ”¹è¿›åˆ†å¸ƒå¼é”" class="headerlink" title="4.7 javaè°ƒç”¨luaè„šæœ¬æ”¹è¿›åˆ†å¸ƒå¼é”"></a>4.7 javaè°ƒç”¨luaè„šæœ¬æ”¹è¿›åˆ†å¸ƒå¼é”</h3><p>éœ€æ±‚ï¼šåŸºäºLuaè„šæœ¬å®ç°åˆ†å¸ƒå¼é”çš„é‡Šæ”¾é”é€»è¾‘</p>
<p>æç¤ºï¼šRedisTemplateè°ƒç”¨Luaè„šæœ¬çš„APIå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">execute</span><span class="params">(RedisScript&lt;T&gt; script, List&lt;K&gt; keys, Object... args)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.scriptExecutor.execute(script, keys, args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>åœ¨resourcesèµ„æºåŒ…ä¸­åˆ›å»ºluaè„šæœ¬<code>unlock.lua</code>ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--è¿™é‡Œçš„KEYS[1]å°±æ˜¯é”çš„keyï¼Œè¿™é‡Œçš„ARGV[1]å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line"><span class="comment">--è·å–é”ä¸­çš„æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;GET&#x27;</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">	<span class="comment">--ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”</span></span><br><span class="line">	<span class="keyword">return</span> redis.call(<span class="string">&#x27;DEL&#x27;</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>å†æ¬¡æ”¹è¿›<code>SimpleRedisLock</code>ç±»ä¸­çš„<code>unlock</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–luaè„šæœ¬</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/unlock.lua&quot;</span>));</span><br><span class="line">        UNLOCK_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸šåŠ¡åç§°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String businessName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String businessName, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.businessName = businessName;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + businessName, value, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–å½“å‰çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">//è°ƒç”¨luaè„šæœ¬</span></span><br><span class="line">        stringRedisTemplate.execute(</span><br><span class="line">                UNLOCK_SCRIPT,</span><br><span class="line">                Collections.singletonList(KEY_PREFIX + businessName),</span><br><span class="line">                value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯ï¼š</p>
<ul>
<li>åˆ©ç”¨<code>set nx ex</code>è·å–é”ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜çº¿ç¨‹æ ‡ç¤º</li>
<li>é‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­çº¿ç¨‹æ ‡ç¤ºæ˜¯å¦ä¸è‡ªå·±ä¸€è‡´ï¼Œä¸€è‡´åˆ™åˆ é™¤é”</li>
</ul>
<p>ç‰¹æ€§ï¼š</p>
<ul>
<li>åˆ©ç”¨<code>set nx</code>æ»¡è¶³äº’æ–¥æ€§</li>
<li>åˆ©ç”¨<code>set ex</code>ä¿è¯æ•…éšœæ—¶é”ä¾ç„¶èƒ½é‡Šæ”¾ï¼Œé¿å…æ­»é”ï¼Œæé«˜å®‰å…¨æ€§</li>
<li>åˆ©ç”¨Redisé›†ç¾¤ä¿è¯é«˜å¯ç”¨å’Œé«˜å¹¶å‘ç‰¹æ€§</li>
</ul>
<h3 id="4-8-RedissonåŠŸèƒ½ä»‹ç»"><a href="#4-8-RedissonåŠŸèƒ½ä»‹ç»" class="headerlink" title="4.8 RedissonåŠŸèƒ½ä»‹ç»"></a>4.8 RedissonåŠŸèƒ½ä»‹ç»</h3><p>åŸºäº<code>setnx</code>å®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p>
<ul>
<li><p>ä¸å¯é‡å…¥</p>
<ul>
<li>åŒä¸€ä¸ªçº¿ç¨‹æ— æ³•å¤šæ¬¡è·å–åŒä¸€æŠŠé”</li>
</ul>
</li>
<li><p>ä¸å¯é‡è¯•</p>
<ul>
<li>è·å–é”åªå°è¯•ä¸€æ¬¡å°±è¿”å›falseï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶</li>
</ul>
</li>
<li><p>è¶…æ—¶é‡Šæ”¾</p>
<ul>
<li>é”è¶…æ—¶é‡Šæ”¾è™½ç„¶å¯ä»¥é¿å…æ­»é”ï¼Œä½†å¦‚æœæ˜¯ä¸šåŠ¡æ‰§è¡Œè€—æ—¶è¾ƒé•¿ï¼Œä¹Ÿä¼šå¯¼è‡´é”é‡Šæ”¾ï¼Œå­˜åœ¨å®‰å…¨éšæ€</li>
</ul>
</li>
<li><p>ä¸»ä»ä¸€è‡´æ€§</p>
<ul>
<li>å¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œä¸»ä»åŒæ­¥å­˜åœ¨å»¶è¿Ÿï¼Œå½“ä¸»æœºå®•æœºæ—¶ï¼Œå¦‚æœä»å¹¶åŒæ­¥ä¸»ä¸­çš„é”æ•°æ®ï¼Œåˆ™ä¼šå‡ºç°é”å®ç°</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/redisson/redisson">Redisson</a>æ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„javaé©»å†…å­˜æ•°æ®ç½‘æ ¼(In-Memory Data Grid)ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚</p>
<p>åˆ†å¸ƒå¼é”(Lock)å’ŒåŒæ­¥å™¨(Synchronizer)ï¼š</p>
<ol>
<li>å¯é‡å…¥é”(Reentrant Lock)</li>
<li>å…¬å¹³é”(Fair Lock)</li>
<li>è”é”(MultiLock)</li>
<li>çº¢é”(RedLock)</li>
<li>è¯»å†™é”(ReadWriteLock)</li>
<li>ä¿¡å·é‡(Semaphore)</li>
<li>å¯è¿‡æœŸæ€§ä¿¡å·é‡(PermitExpirableSemaphore)</li>
<li>é—­é”(CountDownLatch)</li>
</ol>
<h3 id="4-9-Redissonå¿«é€Ÿå…¥é—¨"><a href="#4-9-Redissonå¿«é€Ÿå…¥é—¨" class="headerlink" title="4.9 Redissonå¿«é€Ÿå…¥é—¨"></a>4.9 Redissonå¿«é€Ÿå…¥é—¨</h3><ol>
<li><p>å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.19.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br></pre></td></tr></table></figure>
</li>
<li><p>é…ç½®Redissonå®¢æˆ·ç«¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//é…ç½®ç±»</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">//æ·»åŠ redisåœ°å€ï¼Œè¿™é‡Œæ·»åŠ äº†å•ç‚¹çš„åœ°å€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨config.useClusterServers()æ·»åŠ é›†ç¾¤åœ°å€</span></span><br><span class="line">        config.useSingleServer()</span><br><span class="line">            .setAddress(<span class="string">&quot;redis://192.168.150.101:6379&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">//åˆ›å»ºå®¢æˆ·ç«¯</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ï¼Œä½¿ç”¨Redissonçš„åˆ†å¸ƒå¼é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">//è·å–é”ï¼ˆå¯é‡å…¥ï¼‰ï¼ŒæŒ‡å®šé”çš„åç§°</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;anyLock&quot;</span>);</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆæœŸé—´ä¼šé‡è¯•ï¼‰ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>,<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­é‡Šæ”¾è·å–æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(isLock) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>å†æ¬¡ä¿®æ”¹<code>VoucherOrderServiceImpl</code>çš„<code>seckillVoucher</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ—¶é—´</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æœªåœ¨è§„å®šæ—¶é—´å†…&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ£€æŸ¥åº“å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">isLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> isLock.tryLock();</span><br><span class="line">    <span class="keyword">if</span> (!flag)&#123;</span><br><span class="line">        <span class="comment">//è·å–é”å¤±è´¥ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//thisè°ƒç”¨ä¼šå¯¼è‡´äº‹åŠ¡ä¸ç”Ÿæ•ˆï¼Œå¯ä»¥é€šè¿‡AopContextè·å–åˆ°Proxyå¯¹è±¡,ä»è€Œå®ç°ä»£ç†.</span></span><br><span class="line">        <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="comment">//ç”Ÿæˆä¸€äººä¸€å•çš„è®¢å•</span></span><br><span class="line">        <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">        isLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-10-Redissonå¯é‡å…¥é”åŸç†"><a href="#4-10-Redissonå¯é‡å…¥é”åŸç†" class="headerlink" title="4.10 Redissonå¯é‡å…¥é”åŸç†"></a>4.10 Redissonå¯é‡å…¥é”åŸç†</h3><p>å¯é‡å…¥é”é‡‡ç”¨çš„æ•°æ®ç»“æ„ä¸ºhashï¼š</p>
<table>
<thead>
<tr>
<th><span style="color:red">KEY</span></th>
<th><span style="color:red">VALUE</span></th>
<th><span style="color:red">VALUE</span></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td><span style="color:brown">field</span></td>
<td><span style="color:brown">value</span></td>
</tr>
<tr>
<td>lock</td>
<td>Thread1</td>
<td>0</td>
</tr>
</tbody></table>
<img src="https://s2.loli.net/2023/01/29/pORBwjfb6o39gql.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/29/pORBwjfb6o39gql.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png" style="zoom:67%;" />

<p>è·å–é”çš„Luaè„šæœ¬ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>];			<span class="comment">--é”çš„key</span></span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">1</span>];		<span class="comment">--çº¿ç¨‹å”¯ä¸€æ ‡è¯†</span></span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>];	<span class="comment">--é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é˜…</span></span><br><span class="line"><span class="comment">--åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="keyword">if</span>(redis.call(<span class="string">&#x27;exists&#x27;</span>,key) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">	<span class="comment">--ä¸å­˜åœ¨ï¼Œè·å–é”</span></span><br><span class="line">	redis.call(<span class="string">&#x27;hset&#x27;</span>,key,threadId,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">	<span class="comment">--è®¾ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">	redis.call(<span class="string">&#x27;expire&#x27;</span>,key,releaseTime);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;<span class="comment">--è¿”å›ç»“æœ</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">--é”å·²ç»å­˜åœ¨ï¼Œåˆ¤æ–­hreadId,æ˜¯å¦æ˜¯è‡ªå·±</span></span><br><span class="line"><span class="keyword">if</span>(redis.call(<span class="string">&#x27;hexists&#x27;</span>,key,threadId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">	<span class="comment">--ä¸å­˜åœ¨ï¼Œè·å–é”é‡å…¥æ¬¡æ•°+1</span></span><br><span class="line">	redis.call(<span class="string">&#x27;hincrby&#x27;</span>,key,threadId,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">	<span class="comment">--è®¾ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">	redis.call(<span class="string">&#x27;expire&#x27;</span>,key,releaseTime);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;<span class="comment">--è¿”å›ç»“æœ</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;<span class="comment">--ä»£ç èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜è·å–é”çš„ä¸æ˜¯è‡ªå·±ï¼Œè·å–é”å¤±è´¥</span></span><br></pre></td></tr></table></figure>

<p>é‡Šæ”¾é”çš„Luaè„šæœ¬ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>];			<span class="comment">--key</span></span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">1</span>];		<span class="comment">--çº¿ç¨‹å”¯-æ ‡è¯†</span></span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>];	<span class="comment">--é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span></span><br><span class="line"><span class="comment">--åˆ¤æ–­å½“å‰é”æ˜¯å¦è¿˜æ˜¯è¢«è‡ªå·±ç‰¹æœ‰</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;HEXISTS&#x27;</span>,key,threadId) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>;<span class="comment">--å¦‚æœå·²ç»ä¸æ˜¯è‡ªå·±ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">--æ˜¯è‡ªå·±çš„é”ï¼Œåˆ™é‡å…¥æ¬¡æ•°-1</span></span><br><span class="line">Local count redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>,key,threadId,<span class="number">-1</span>);</span><br><span class="line"><span class="comment">--åˆ¤æ–­æ˜¯å¦é‡å…¥æ¬¡æ•°æ˜¯å¦å·²ç»ä¸º0</span></span><br><span class="line"><span class="keyword">if</span> (count &gt; <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">	<span class="comment">--å¤§äº0è¯´æ˜ä¸èƒ½é‡Šæ”¾é”ï¼Œé‡ç½®æœ‰æ•ˆæœŸç„¶åè¿”å›</span></span><br><span class="line">	redis.call(EXPIRE<span class="string">&#x27;,key,releaseTime);</span></span><br><span class="line"><span class="string">	return nil;</span></span><br><span class="line"><span class="string">else --ç­‰äº0è¯´æ˜å¯ä»¥é‡Šæ”¾é”ï¼Œç›´æ¥åˆ é™¤</span></span><br><span class="line"><span class="string">	redis.call(&#x27;</span>DEL<span class="string">&#x27;,key);</span></span><br><span class="line"><span class="string">	return nil;</span></span><br><span class="line"><span class="string">end;</span></span><br></pre></td></tr></table></figure>



<p>å¯é‡å…¥é”åŸç†æµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;Lock&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸šåŠ¡1</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">boolean</span> isLock lock.tryLock();</span><br><span class="line">	<span class="keyword">if</span>(!isLock) &#123;</span><br><span class="line">		log.error(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œ1&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			log.info(<span class="string">&quot;è·å–é”æˆåŠŸï¼Œ1&quot;</span>);</span><br><span class="line">			<span class="comment">//æ‰§è¡Œä¸šåŠ¡2</span></span><br><span class="line">            method2();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;é‡Šæ”¾é”ï¼Œ1&quot;</span>);</span><br><span class="line">			lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸šåŠ¡2</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">boolean</span> isLock lock.tryLock();</span><br><span class="line">	<span class="keyword">if</span>(!isLock)&#123;</span><br><span class="line">		log.error(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œ2&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è·å–é”æˆåŠŸï¼Œ2&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;é‡Šæ”¾é”ï¼Œ2&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ‰§è¡Œä¸šåŠ¡1ï¼Œæ£€æŸ¥Redisä¸­æ‰€æ˜¯å¦å­˜åœ¨ThreadId</p>
<ul>
<li>å¦‚æœå­˜åœ¨ï¼Œåˆ™ThreadIdå¯¹åº”çš„Valueå€¼+1ï¼Œæ­¤æ—¶å˜ä¸º1</li>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºTheadIdï¼Œå†å°†ThreadIdå¯¹åº”çš„Valueå€¼+1ï¼Œæ­¤æ—¶å˜ä¸º1</li>
</ul>
<p>ä¹‹åè°ƒç”¨ä¸šåŠ¡2ï¼ŒRedisä¸­æ‰€å¯¹åº”çš„ThreadIdçš„Valueå€¼+2ï¼Œæ­¤æ—¶å˜ä¸º2</p>
<p>åŒæ—¶ä¸šåŠ¡1å®Œæˆï¼Œé‡Šæ”¾é”ï¼ŒRedisä¸­æ‰€å¯¹åº”çš„ThreadIdçš„Valueå€¼-1ï¼Œæ­¤æ—¶åˆå˜ä¸º1</p>
<p>ä¹‹åä¸šåŠ¡2å®Œæˆï¼Œé‡Šæ”¾é”ï¼ŒRedisä¸­æ‰€å¯¹åº”çš„ThreadIdçš„Valueå€¼-1ï¼Œæ­¤æ—¶åˆå˜ä¸º0</p>
<p>å¦‚æœå˜ä¸º0ï¼Œåˆ™åˆ é™¤æ­¤key</p>
</blockquote>
<h3 id="4-11-Redissoné”é‡è¯•å’ŒWatchDogæœºåˆ¶ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ"><a href="#4-11-Redissoné”é‡è¯•å’ŒWatchDogæœºåˆ¶ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ" class="headerlink" title="4.11 Redissoné”é‡è¯•å’ŒWatchDogæœºåˆ¶ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ"></a>4.11 Redissoné”é‡è¯•å’ŒWatchDogæœºåˆ¶ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</h3><p><img src="https://s2.loli.net/2023/01/29/HKLQMA8PkdaFeh2.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/29/HKLQMA8PkdaFeh2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"></p>
<h3 id="4-12-Redissonçš„MultiLockåŸç†"><a href="#4-12-Redissonçš„MultiLockåŸç†" class="headerlink" title="4.12 Redissonçš„MultiLockåŸç†"></a>4.12 Redissonçš„MultiLockåŸç†</h3><img src="https://s2.loli.net/2023/01/30/hznQLSBpjiYMF4X.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/30/hznQLSBpjiYMF4X.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"  />



<p>åœ¨ä¸»ä»é›†ç¾¤ä¸‹ï¼Œå¯¹æ‰€æœ‰ç»“ç‚¹è·å–é”ï¼Œå¦‚æœæœ‰æŸä¸ªç»“ç‚¹å®•æœºï¼Œå°±ä¼šå¯¼è‡´é”æ¶ˆå¤±ï¼Œä½†åˆ«çš„ç»“ç‚¹ä»ç„¶å­˜åœ¨é”ï¼Œå°±ä¸ä¼šæœ‰é‡å¤è·å–é”é—®é¢˜</p>
<p>åœ¨<code>RedisConfig</code>é…ç½®å¤šä¸ªRedisï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//é…ç½®ç±»</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">//æ·»åŠ redisåœ°å€ï¼Œè¿™é‡Œæ·»åŠ äº†å•ç‚¹çš„åœ°å€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨config.useClusterServers()æ·»åŠ é›†ç¾¤åœ°å€</span></span><br><span class="line">        config.useSingleServer()</span><br><span class="line">            .setAddress(<span class="string">&quot;redis://192.168.150.101:6379&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">//åˆ›å»ºå®¢æˆ·ç«¯</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//é…ç½®ç±»</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">//æ·»åŠ redisåœ°å€ï¼Œè¿™é‡Œæ·»åŠ äº†å•ç‚¹çš„åœ°å€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨config.useClusterServers()æ·»åŠ é›†ç¾¤åœ°å€</span></span><br><span class="line">        config.useSingleServer()</span><br><span class="line">            .setAddress(<span class="string">&quot;redis://192.168.150.101:6380&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">//åˆ›å»ºå®¢æˆ·ç«¯</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//é…ç½®ç±»</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">//æ·»åŠ redisåœ°å€ï¼Œè¿™é‡Œæ·»åŠ äº†å•ç‚¹çš„åœ°å€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨config.useClusterServers()æ·»åŠ é›†ç¾¤åœ°å€</span></span><br><span class="line">        config.useSingleServer()</span><br><span class="line">            .setAddress(<span class="string">&quot;redis://192.168.150.101:6381&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">//åˆ›å»ºå®¢æˆ·ç«¯</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æµ‹è¯•è”é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HmDianPingApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient2;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient3;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RLock lock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“å‰ç±»ä¸­çš„æ¯ä¸ª@Testæ–¹æ³•ä¹‹å‰æ‰§è¡Œæ³¨è§£æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock2</span> <span class="operator">=</span> redissonClient2.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock3</span> <span class="operator">=</span> redissonClient3.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºè”é” multiLock</span></span><br><span class="line">        lock = redissonClient.getMultiLock(lock1, lock2, lock3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">//å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆæœŸé—´ä¼šé‡è¯•ï¼‰ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­é‡Šæ”¾è·å–æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span>(isLock) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-13-æ€»ç»“"><a href="#4-13-æ€»ç»“" class="headerlink" title="4.13 æ€»ç»“"></a>4.13 æ€»ç»“</h3><p>ä¸å¯é‡å…¥Redisåˆ†å¸ƒå¼é”ï¼š</p>
<ul>
<li>åŸç†ï¼šåˆ©ç”¨setnxçš„äº’æ–¥æ€§ï¼›åˆ©ç”¨exé¿å…æ­»é”ï¼›é‡Šæ”¾é”æ—¶åˆ¤æ–­çº¿ç¨‹æ ‡ç¤º</li>
<li>ç¼ºé™·ï¼šä¸å¯é‡å…¥ã€æ— æ³•é‡è¯•ã€é”è¶…æ—¶å¤±æ•ˆ</li>
</ul>
<p>å¯é‡å…¥çš„Redisåˆ†å¸ƒå¼é”ï¼š</p>
<ul>
<li>åŸç†ï¼šåˆ©ç”¨hashç»“æ„ï¼Œè®°å½•çº¿ç¨‹æ ‡ç¤ºå’Œé‡å…¥æ¬¡æ•°ï¼›åˆ©ç”¨watchDogå»¶ç»­é”æ—¶é—´ï¼›åˆ©ç”¨ä¿¡å·é‡æ§åˆ¶é”é‡è¯•ç­‰å¾…</li>
<li>ç¼ºé™·ï¼šrediså®•æœºå¼•èµ·é”å¤±æ•ˆé—®é¢˜</li>
</ul>
<p>Redissonçš„multiLock:</p>
<ul>
<li>åŸç†ï¼šå¤šä¸ªç‹¬ç«‹çš„RedisèŠ‚ç‚¹ï¼Œå¿…é¡»åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½è·å–é‡å…¥é”ï¼Œæ‰ç®—è·å–é”æˆåŠŸ</li>
<li>ç¼ºé™·ï¼šè¿ç»´æˆæœ¬é«˜ã€å®ç°å¤æ‚</li>
</ul>
</div><div class="story post-story"><h2 id="5-Redisç§’æ€ä¼˜åŒ–"><a href="#5-Redisç§’æ€ä¼˜åŒ–" class="headerlink" title="5.Redisç§’æ€ä¼˜åŒ–"></a>5.Redisç§’æ€ä¼˜åŒ–</h2><h3 id="5-1-Rediså¼‚æ­¥ç§’æ€æ€è·¯"><a href="#5-1-Rediså¼‚æ­¥ç§’æ€æ€è·¯" class="headerlink" title="5.1 Rediså¼‚æ­¥ç§’æ€æ€è·¯"></a>5.1 Rediså¼‚æ­¥ç§’æ€æ€è·¯</h3><p><img src="https://s2.loli.net/2023/01/30/eETKOUhIz7Hj3Bi.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/30/eETKOUhIz7Hj3Bi.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"></p>
<p>å°†ç§’æ€ä¼˜æƒ åˆ¸åº“å­˜æ”¾å…¥Redisä¸­ï¼š</p>
<table>
<thead>
<tr>
<th>KEY</th>
<th>VALUE</th>
</tr>
</thead>
<tbody><tr>
<td>stock:vid:10</td>
<td>100</td>
</tr>
</tbody></table>
<p>å°†<strong>ä¸‹å•çš„ç”¨æˆ·id</strong>æ”¾å…¥ä¹Ÿæ”¾å…¥åˆ°Redisçš„<strong>seté›†åˆ</strong>ä¸­ï¼š</p>
<table>
<thead>
<tr>
<th>KEY</th>
<th>VALUE</th>
</tr>
</thead>
<tbody><tr>
<td>order:vid:10</td>
<td>1, 2, 3, 4, 5, 6</td>
</tr>
</tbody></table>
<p><img src="https://s2.loli.net/2023/01/30/BORgEAqbCX82vKG.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/30/BORgEAqbCX82vKG.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"></p>
<h3 id="5-2-åŸºäºRediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­"><a href="#5-2-åŸºäºRediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­" class="headerlink" title="5.2 åŸºäºRediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­"></a>5.2 åŸºäºRediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­</h3><p>æ”¹è¿›ç§’æ€ä¸šåŠ¡ï¼Œæé«˜å¹¶å‘æ€§èƒ½</p>
<p>éœ€æ±‚ï¼š</p>
<ul>
<li>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</li>
<li>åŸºäºluaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ</li>
<li>å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸då’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</li>
<li>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</li>
</ul>
<p>åœ¨<code>VoucherServiceImpl</code>ä¸­ä¿®æ”¹<code>addSeckillVoucher</code>æ–¹æ³•å‘Redisä¸­æ·»åŠ ä¼˜æƒ åˆ¸ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸ï¼Œmybatis-plusåœ¨æ‰§è¡Œsaveæ–¹æ³•åè‡ªåŠ¨è¿”å›ID</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">//ä¿å­˜ç§’æ€åº“å­˜åˆ°Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue()</span><br><span class="line">                .set(RedisConstants.SECKILL_STOCK_KEY + voucher.getId(),</span><br><span class="line">                        voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»º<code>seckill.lua</code>è„šæœ¬ï¼Œåˆ¤æ–­åº“å­˜ã€ä¸€äººä¸€å•ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>];  <span class="comment">--ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>];     <span class="comment">--ç”¨æˆ·id</span></span><br><span class="line"><span class="comment">--æ‹¼æ¥key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId;</span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId;</span><br><span class="line"></span><br><span class="line"><span class="comment">--åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹å•</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--ç”¨æˆ·å·²ç»ä¸‹å•ï¼Œè¿”å›2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--å‡æ‰£åº“å­˜</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">--å°†ç”¨æˆ·idæ’å…¥åˆ°setåˆé›†ä¸­</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>



<p>é‡å†™<code>VoucherOrderServiceImpl</code>çš„<code>seckillVoucher</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–luaè„šæœ¬</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SECKILL_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//è®¾ç½®è„šæœ¬ä½ç½®</span></span><br><span class="line">        SECKILL_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/seckill.lua&quot;</span>));</span><br><span class="line">        <span class="comment">//è®¾ç½®è¿”å›å€¼ç±»å‹</span></span><br><span class="line">        SECKILL_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">//æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">                SECKILL_SCRIPT,</span><br><span class="line">                Collections.emptyList(),</span><br><span class="line">                voucherId.toString(), userId.toString());</span><br><span class="line">        <span class="comment">//å¼‚å¸¸ä¿¡æ¯ï¼Œè¿”å›å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(result == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ¨¡æ‹Ÿï¼Œç”Ÿæˆè®¢å•å·</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">order</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(order);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-3-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€å¼‚æ­¥ä¸‹å•"><a href="#5-3-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€å¼‚æ­¥ä¸‹å•" class="headerlink" title="5.3 åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€å¼‚æ­¥ä¸‹å•"></a>5.3 åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€å¼‚æ­¥ä¸‹å•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line">    <span class="comment">//å…¨å±€å”¯ä¸€ID</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line">    <span class="comment">//redissonåˆ†å¸ƒå¼é”</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line">    <span class="comment">//ä»£ç†å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> IVoucherOrderService proxy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–luaè„šæœ¬</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SECKILL_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//è®¾ç½®è„šæœ¬ä½ç½®</span></span><br><span class="line">        SECKILL_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/seckill.lua&quot;</span>));</span><br><span class="line">        <span class="comment">//è®¾ç½®è¿”å›å€¼ç±»å‹</span></span><br><span class="line">        SECKILL_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span>*<span class="number">1024</span>);</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–å•çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åœ¨springå®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™æ‰§è¡Œè¯¥æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//è·å–é˜Ÿåˆ—çš„è®¢å•ä¿¡æ¯ï¼Œæ²¡æœ‰è®¢å•åˆ™é˜»å¡ç­‰å¾…</span></span><br><span class="line">                    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                    <span class="comment">//å¤„ç†è®¢å•</span></span><br><span class="line">                    handleVoucherOrder(voucherOrder);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸»æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">//æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">                SECKILL_SCRIPT,</span><br><span class="line">                Collections.emptyList(),</span><br><span class="line">                voucherId.toString(), userId.toString());</span><br><span class="line">        <span class="comment">//å¼‚å¸¸ä¿¡æ¯ï¼Œè¿”å›å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(result == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–ä¸»çº¿ç¨‹ä»£ç†å¯¹è±¡</span></span><br><span class="line">        proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="comment">//åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">//åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">        orderTasks.add(voucherOrder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å†æ¬¡è¿›è¡Œé€»è¾‘åˆ¤æ–­ï¼Œäº’æ–¥çš„å¤„ç†è®¢å•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">isLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//å°è¯•è·å–é”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> isLock.tryLock();</span><br><span class="line">        <span class="keyword">if</span> (!flag)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è·å–é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//ç”Ÿæˆä¸€äººä¸€å•çš„è®¢å•</span></span><br><span class="line">            proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            isLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ“ä½œæ•°æ®åº“ï¼Œç”Ÿæˆè®¢å•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="comment">//æ£€æŸ¥ä¸€äººä¸€å•</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å‡æ‰£åº“å­˜</span></span><br><span class="line">        <span class="comment">//set stock = stock-1 where voucher_id = ? and stock &gt; 0</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId())</span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä»æ•°æ®åº“ç”Ÿæˆè®¢å•</span></span><br><span class="line">        save(voucherOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ol>
<li>å…ˆåˆ©ç”¨Rediså®Œæˆåº“å­˜ä½™é‡ã€ä¸€äººä¸€å•åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡</li>
<li>å†å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•</li>
</ol>
<p>åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ç§’æ€å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ</p>
<ul>
<li>å†…å­˜é™åˆ¶é—®é¢˜</li>
<li>æ•°æ®å®‰å…¨é—®é¢˜</li>
</ul>
</div><div class="story post-story"><h2 id="6-Redisæ¶ˆæ¯é˜Ÿåˆ—"><a href="#6-Redisæ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="6.Redisæ¶ˆæ¯é˜Ÿåˆ—"></a>6.Redisæ¶ˆæ¯é˜Ÿåˆ—</h2><h3 id="6-1-æ¶ˆæ¯é˜Ÿåˆ—"><a href="#6-1-æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="6.1 æ¶ˆæ¯é˜Ÿåˆ—"></a>6.1 æ¶ˆæ¯é˜Ÿåˆ—</h3><p>æ¶ˆæ¯é˜Ÿåˆ—(<strong>M</strong>essage <strong>Q</strong>ueue)ï¼Œå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚</p>
<p>æœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬3ä¸ªè§’è‰²ï¼š</p>
<ul>
<li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯ä»£ç†(Message Broker)</li>
<li>ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/30/DqTYk1EBjdxWNr4.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/30/DqTYk1EBjdxWNr4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"></p>
<p>Redisæä¾›äº†ä¸‰ç§ä¸åŒçš„æ–¹å¼æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<ul>
<li>listç»“æ„ï¼šåŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—</li>
<li>PubSubï¼šåŸºæœ¬çš„ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¨¡å‹</li>
<li>Streamï¼šæ¯”è¾ƒå®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>List</th>
<th>PubSub</th>
<th>Stream</th>
</tr>
</thead>
<tbody><tr>
<td>æ¶ˆæ¯æŒä¹…åŒ–</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>é˜»å¡è¯»å–</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>æ¶ˆæ¯å †ç§¯å¤„ç†</td>
<td>å—é™äºå†…å­˜ç©ºé—´ï¼Œå¯ä»¥<br/>åˆ©ç”¨å¤šæ¶ˆè´¹è€…åŠ å¿«å¤„ç†</td>
<td>å—é™äºæ¶ˆè´¹è€…ç¼“å†²åŒº</td>
<td>å—é™äºé˜Ÿåˆ—é•¿åº¦ï¼Œå¯ä»¥åˆ©ç”¨æ¶ˆè´¹<br/>è€…ç»„æé«˜æ¶ˆè´¹é€Ÿåº¦ï¼Œå‡å°‘å †ç§¯</td>
</tr>
<tr>
<td>æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>æ¶ˆæ¯å›æº¯</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
</tbody></table>
<h3 id="6-2-åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—"><a href="#6-2-åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="6.2 åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—"></a>6.2 åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h3><p>æ¶ˆæ¯é˜Ÿåˆ—(Message Queue)ï¼Œå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚</p>
<p>è€ŒRedisçš„listæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—æ•ˆæœã€‚</p>
<p>é˜Ÿåˆ—æ˜¯å…¥å£å’Œå‡ºå£ä¸åœ¨ä¸€è¾¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼š<strong>LPUSHç»“åˆRPOP</strong> æˆ–è€… <strong>RPUSHç»“åˆLPOP</strong>æ¥å®ç°ã€‚</p>
<p>ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶RPOPæˆ–LPOPæ“ä½œä¼šè¿”å›nullï¼Œå¹¶ä¸åƒJVMçš„é˜»å¡é˜Ÿåˆ—é‚£æ ·ä¼šé˜»å¡å¹¶ç­‰å¾…æ¶ˆæ¯ã€‚</p>
<p>å› æ­¤è¿™é‡Œåº”è¯¥ä½¿ç”¨<strong>BRPOP</strong>æˆ–è€…<strong>BLPOP</strong>æ¥å®è§†é˜»å¡æ•ˆæœã€‚</p>
<p>åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—çš„ä¼˜ç¼ºç‚¹ï¼š</p>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>åˆ©ç”¨Rediså­˜å‚¨ï¼Œä¸å—é™äºJVMå†…å­˜ä¸Šé™</li>
<li>åŸºäºRedisçš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿è¯</li>
<li>å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±ï¼šç§»é™¤é˜Ÿåˆ—åï¼Œä¼šåˆ é™¤æ•°æ®ã€‚å¦‚æœæ­¤æ—¶å®•æœºï¼Œé€ æˆæ•°æ®ä¸¢å¤±</li>
<li>åªæ”¯æŒå•æ¶ˆè´¹è€…</li>
</ul>
</blockquote>
<h3 id="6-3-PubSubå®ç°æ¶ˆæ¯é˜Ÿåˆ—"><a href="#6-3-PubSubå®ç°æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="6.3 PubSubå®ç°æ¶ˆæ¯é˜Ÿåˆ—"></a>6.3 PubSubå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h3><p>PubSub(å‘å¸ƒè®¢é˜…)æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªchannelï¼Œç”Ÿäº§è€…å‘å¯¹åº”channelå‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯ã€‚</p>
<ul>
<li><code>SUBSCRIBE channel[channel]</code>ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“</li>
<li><code>PUBLISH channel msg</code>ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯</li>
<li><code>PSUBSCRIBE pattern[pattern]</code>ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“</li>
</ul>
<img src="https://s2.loli.net/2023/01/30/Ui5ACYH2r1WNo9E.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/30/Ui5ACYH2r1WNo9E.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"  />



<p>åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ</p>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</li>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li>
<li>æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±</li>
</ul>
</blockquote>
<h3 id="6-4-Streamçš„å•æ¶ˆè´¹æ¨¡å¼"><a href="#6-4-Streamçš„å•æ¶ˆè´¹æ¨¡å¼" class="headerlink" title="6.4 Streamçš„å•æ¶ˆè´¹æ¨¡å¼"></a>6.4 Streamçš„å•æ¶ˆè´¹æ¨¡å¼</h3><p>Streamæ˜¯Redis5.0å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
<p>å‘é€æ¶ˆæ¯çš„å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xadd key [nomkstream] [maxlen|minid [=|~] threshold [limit count]] *|ID field value</span><br></pre></td></tr></table></figure>

<ul>
<li><code>[nomkstream]</code>ï¼šå¦‚æœé˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œæ˜¯å¦è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—ï¼Œé»˜è®¤æ˜¯è‡ªåŠ¨åˆ›å»º</li>
<li><code>[maxlen|minid [=|~] threshold [limit count]]</code>ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—çš„æœ€å¤§æ¶ˆæ¯æ•°é‡</li>
<li><code>*|ID</code>ï¼šæ¶ˆæ¯çš„å”¯ä¸€Idï¼Œ*ä»£è¡¨ç”±Redisè‡ªåŠ¨ç”Ÿæˆã€‚æ ¼å¼æ˜¯â€æ—¶é—´æˆ³-é€’å¢æ•°å­—â€ï¼Œä¾‹å¦‚â€1644804662707-0â€</li>
<li><code>field value</code>ï¼šå‘é€åˆ°é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œç§°ä¸ºEntryã€‚æ ¼å¼å°±æ˜¯å¤šä¸ªkey-valueé”®å€¼å¯¹</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#åˆ›å»ºåä¸ºusersçš„é˜Ÿåˆ—ï¼Œå¹¶å‘å…¶ä¸­å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š&#123;name=jack,age=21&#125;ï¼Œå¹¶ä¸”ä½¿ç”¨é‚£redisè‡ªåŠ¨ç”Ÿæˆid</span></span></span><br><span class="line">127.0.0.1:6379&gt; XADD users name jack age 21</span><br><span class="line">&quot;1644805700523-0&quot;</span><br></pre></td></tr></table></figure>



<p>è¯»å–æ¶ˆæ¯ï¼šXREAD</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xread [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] ID [ID ...]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>[COUNT count]</code>ï¼šæ¯æ¬¡è¯»å–æ¶ˆæ¯çš„æœ€å¤§æ•°é‡</li>
<li><code>[BLOCK milliseconds]</code>ï¼šå½“æ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œæ˜¯å¦é˜»å¡ã€é˜»å¡æ—¶é•¿</li>
<li><code>STREAMS key [key ...]</code>ï¼šè¦ä»å“ªä¸ªé˜Ÿåˆ—è¯»å–æ¶ˆæ¯ï¼Œkeyå°±æ˜¯é˜Ÿåˆ—å</li>
<li><code>ID [ID ...]</code>ï¼šèµ·å§‹idï¼Œåªè¿”å›å¤§äºè¯¥IDçš„æ¶ˆæ¯<ul>
<li>0ï¼šä»£è¡¨ä»ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹</li>
<li>$ï¼šä»£è¡¨ä»æœ€æ–°çš„æ¶ˆæ¯å¼€å§‹</li>
</ul>
</li>
</ul>
<p>ä¾‹å¦‚ï¼Œä½¿ç”¨XREADè¯»å–ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; XREAD COUNT 1 STREAMS users 0</span><br><span class="line">1)	1) &quot;users&quot;</span><br><span class="line">	2)	1)	1) &quot;1644805700523-0&quot;</span><br><span class="line">			2)	1) &quot;name</span><br><span class="line">				2) &quot;jack&quot;</span><br><span class="line">				3) &quot;age&quot;</span><br><span class="line">				4) &quot;21&quot;</span><br></pre></td></tr></table></figure>

<p>XREADé˜»å¡æ–¹å¼ï¼Œè¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; XREAD COUNT 1 BLOCK 1000 STREAMS users $</span><br><span class="line">(nil)</span><br><span class="line">(1.07s)</span><br></pre></td></tr></table></figure>



<p>åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ªç¯çš„è°ƒç”¨XREADé˜»å¡æ–¹å¼æ¥æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯ï¼Œä»è€Œå®ç°æŒç»­ç›‘å¬é˜Ÿåˆ—çš„æ•ˆæœï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">//å°è¯•è¯»å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæœ€å¤šé˜»å¡2ç§’</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.xecute(<span class="string">&quot;XREAD COUNT 1 BLOCK 2000 STREAMS users $&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">    	<span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">    handleMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼Œå½“æˆ‘ä»¬æŒ‡å®šèµ·å§‹IDä¸º$æ—¶ï¼Œä»£è¡¨è¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœæˆ‘ä»¬å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œåˆæœ‰è¶…è¿‡1æ¡ä»¥ä¸Šçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—ï¼Œåˆ™ä¸‹æ¬¡è·å–æ—¶ä¹Ÿåªèƒ½è·å–åˆ°æœ€æ–°çš„ä¸€æ¡ï¼Œä¼šå‡ºç°<strong>æ¼è¯»æ¶ˆæ¯</strong>çš„é—®é¢˜ã€‚</p>
</blockquote>
<p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹ï¼š</p>
<blockquote>
<ul>
<li>æ¶ˆæ¯å¯å›æ½®</li>
<li>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li>
</ul>
</blockquote>
<h3 id="6-5-Streamçš„æ¶ˆè´¹è€…ç»„æ¨¡å¼"><a href="#6-5-Streamçš„æ¶ˆè´¹è€…ç»„æ¨¡å¼" class="headerlink" title="6.5 Streamçš„æ¶ˆè´¹è€…ç»„æ¨¡å¼"></a>6.5 Streamçš„æ¶ˆè´¹è€…ç»„æ¨¡å¼</h3><p>æ¶ˆè´¹è€…ç»„(Consumer Group)ï¼šå°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚</p>
<p>å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p>
<ul>
<li><p>æ¶ˆæ¯åˆ†æµ</p>
<p>é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šåˆ†æµç»™ç»„å†…çš„ä¸åŒæ¶ˆè´¹è€…ï¼Œè€Œä¸æ˜¯é‡å¤æ¶ˆè´¹ï¼Œä»è€ŒåŠ å¿«æ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦</p>
</li>
<li><p>æ¶ˆæ¯æ ‡ç¤º</p>
<p>æ¶ˆè´¹è€…ç»„ä¼šç»´æŠ¤ä¸€ä¸ªæ ‡ç¤ºï¼Œè®°å½•æœ€åä¸€ä¸ªè¢«å¤„ç†çš„æ¶ˆæ¯ï¼Œå“ªæ€•æ¶ˆè´¹è€…å®•æœºé‡å¯ï¼Œè¿˜ä¼šä»æ ‡ç¤ºä¹‹åè¯»å–æ¶ˆæ¯ã€‚ç¡®ä¿æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æ¶ˆè´¹</p>
</li>
<li><p>æ¶ˆæ¯ç¡®è®¤</p>
<p>æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œæ¶ˆæ¯å¤„äºpendingçŠ¶æ€ï¼Œå¹¶å­˜å…¥ä¸€ä¸ªpending-listã€‚å½“å¤„ç†å®Œæˆåéœ€è¦é€šè¿‡XACKæ¥ç¡®è®¤æ¶ˆæ¯ï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºå·²å¤„ç†ï¼Œæ‰ä¼šä»pending-Listç§»é™¤ã€‚</p>
</li>
</ul>
<p>åˆ›å»ºæ¶ˆè´¹è€…ç»„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE key groupName ID [MKSTREAM]</span><br></pre></td></tr></table></figure>

<ul>
<li>keyï¼šé˜Ÿåˆ—åç§°</li>
<li>groupNameï¼šæ¶ˆè´¹è€…ç»„åç§°</li>
<li>IDï¼šèµ·å§‹IDæ ‡ç¤ºï¼Œ<code>$</code>ä»£è¡¨é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ<code>0</code>åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯</li>
<li>MKSTREAMï¼šé˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—</li>
</ul>
<p>å…¶å®ƒå¸¸è§å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åˆ é™¤æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„</span></span><br><span class="line">XGROUP DESTORY key groupName</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹è€…</span></span><br><span class="line">XGROUP CREATECONSUMER key groupname consumername</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åˆ é™¤æ¶ˆè´¹è€…ç»„ä¸­çš„æŒ‡å®šæ¶ˆè´¹è€…</span></span><br><span class="line">XGROUP DELCONSUMER key groupname consumername</span><br></pre></td></tr></table></figure>



<p>ä»æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>group</code>ï¼šæ¶ˆè´¹ç»„åç§°</li>
<li><code>consumer</code>ï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</li>
<li><code>count</code>ï¼šæœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡</li>
<li><code>BLOCK milliseconds</code>ï¼šå½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´</li>
<li><code>NOACK</code>ï¼šæ— éœ€æ‰‹åŠ¨ACK,è·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤</li>
<li><code>STREAMS  key</code>ï¼šæŒ‡å®šé˜Ÿåˆ—åç§°</li>
<li><code>ID</code>ï¼šè·å–æ¶ˆæ¯çš„èµ·å§‹ID:<ul>
<li><code>&quot;&gt;&quot;</code>ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹</li>
<li>å…¶å®ƒï¼šæ ¹æ®æŒ‡å®šidä»pending-listä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-Listä¸­çš„ç¬¬ä¸€ä¸ª<br>æ¶ˆæ¯å¼€å§‹</li>
</ul>
</li>
</ul>
<p>ACKï¼Œæ¶ˆæ¯ç¡®è®¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SACK stream.orders g1 id</span><br></pre></td></tr></table></figure>



<p>æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯çš„åŸºæœ¬æ€è·¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">	<span class="comment">//å°è¯•ç›‘å¬é˜Ÿåˆ—ï¼Œä½¿ç”¨é˜»å¡æ¨¡å¼ï¼Œæœ€é•¿ç­‰å¾…2000æ¯«ç§’</span></span><br><span class="line">	<span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span>(msg == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//nullè¯´æ˜æ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡</span></span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line">     &#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å¤„ç†æ¶ˆæ¯ï¼Œå®Œæˆåä¸€å®šè¦ACK</span></span><br><span class="line">		handleMessage(msg);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 STREAMS s1 0&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(msg == nu11) &#123;</span><br><span class="line">                <span class="comment">//nullè¯´æ˜æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½å·²ç¡®è®¤ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//è¯´æ˜æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œå†æ²ˆå¤„ç†</span></span><br><span class="line">                handleMessage(msg)ï¼›</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">                <span class="comment">//å†æ¬¡å‡ºç°å¼‚å¸¸ï¼Œè®°çµæ—¥å¿—ï¼Œç»§ç»­å¾ªç¯</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„<code>XREADGROUP</code>å‘½ä»¤ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æ²¡æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li>
<li>æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡</li>
</ul>
<h3 id="6-6-åŸºäºStreamæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€"><a href="#6-6-åŸºäºStreamæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€" class="headerlink" title="6.6 åŸºäºStreamæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€"></a>6.6 åŸºäºStreamæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€</h3><p>éœ€æ±‚ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.orders</li>
<li>ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘stream.ordersä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«voucherldã€userldã€orderld</li>
<li>é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–stream.ordersä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•</li>
</ol>
<p>åˆ›å»ºåä¸º<code>stream.orders</code>æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE stream.orders g1 0 MKSTREAM</span><br></pre></td></tr></table></figure>

<p>åˆ›å»º<code>seckillStream</code>çš„Luaè„šæœ¬ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>];  <span class="comment">--ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>];     <span class="comment">--ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>];    <span class="comment">--è®¢å•id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--æ‹¼æ¥key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId;</span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId;</span><br><span class="line"></span><br><span class="line"><span class="comment">--åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹å•</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--ç”¨æˆ·å·²ç»ä¸‹å•ï¼Œè¿”å›2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--å‡æ‰£åº“å­˜</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">--å°†ç”¨æˆ·idæ’å…¥åˆ°setåˆé›†ä¸­</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId);</span><br><span class="line"></span><br><span class="line"><span class="comment">--å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼ŒXADD stream.orders * k1 v1 k2 v2 Â·Â·Â·</span></span><br><span class="line">redis.call(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­æ”¹è¿›<code>VoucherOrderServiceImpl</code>ç±»ä¸­çš„ <code>seckillVoucher</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line">    <span class="comment">//å…¨å±€å”¯ä¸€ID</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line">    <span class="comment">//redissonåˆ†å¸ƒå¼é”</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line">    <span class="comment">//ä»£ç†å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> IVoucherOrderService proxy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–luaè„šæœ¬</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SECKILL_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//è®¾ç½®è„šæœ¬ä½ç½®</span></span><br><span class="line">        SECKILL_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/seckillStream.lua&quot;</span>));</span><br><span class="line">        <span class="comment">//è®¾ç½®è¿”å›å€¼ç±»å‹</span></span><br><span class="line">        SECKILL_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–å•çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åœ¨springå®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™æ‰§è¡Œè¯¥æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;stream.orders&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ï¼Œæ²¡æœ‰è®¢å•åˆ™é˜»å¡ç­‰å¾…2ç§’</span></span><br><span class="line">                    <span class="comment">//XREADGROUP GROUP c1 COUNT 1 BLOCK 2000 STREAMS streams.order &gt;</span></span><br><span class="line">                    List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                            Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                            StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">2</span>)),</span><br><span class="line">                            StreamOffset.create(queueName, ReadOffset.lastConsumed())</span><br><span class="line">                    );</span><br><span class="line">                    <span class="comment">//åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦è·å–æˆåŠŸ</span></span><br><span class="line">                    <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                        <span class="comment">//è·å–å¤±è´¥ï¼Œè¿›å…¥ä¸‹æ¬¡å¾ªç¯</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//è§£ææ¶ˆæ¯ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                    MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                    Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                    <span class="comment">//è·å–æˆåŠŸï¼Œåˆ™å¤„ç†è®¢å•</span></span><br><span class="line">                    handleVoucherOrder(voucherOrder);</span><br><span class="line">                    <span class="comment">//å®ŒæˆACKç¡®è®¤</span></span><br><span class="line">                    <span class="comment">//SACK stream.orders g1 id</span></span><br><span class="line">                    stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                    handlePendingList();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//pending-listæ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePendingList</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                    <span class="comment">//XREADGROUP GROUP c1 COUNT 1 STREAMS streams.order 0</span></span><br><span class="line">                    List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                            Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                            StreamReadOptions.empty().count(<span class="number">1</span>),</span><br><span class="line">                            StreamOffset.create(queueName, ReadOffset.from(<span class="string">&quot;0&quot;</span>))</span><br><span class="line">                    );</span><br><span class="line">                    <span class="comment">//åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦è·å–æˆåŠŸ</span></span><br><span class="line">                    <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                        <span class="comment">//è·å–å¤±è´¥ï¼Œpending-listä¸­æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//è§£ææ¶ˆæ¯ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                    MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                    Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                    <span class="comment">//è·å–æˆåŠŸï¼Œå¤„ç†å¼‚å¸¸çš„è®¢å•</span></span><br><span class="line">                    handleVoucherOrder(voucherOrder);</span><br><span class="line">                    <span class="comment">//å®ŒæˆACKç¡®è®¤</span></span><br><span class="line">                    <span class="comment">//SACK stream.orders g1 id</span></span><br><span class="line">                    stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;å¤„ç†pending-listè®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸»æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">                SECKILL_SCRIPT,</span><br><span class="line">                Collections.emptyList(),</span><br><span class="line">                voucherId.toString(), userId.toString(), String.valueOf(orderId));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¼‚å¸¸ä¿¡æ¯ï¼Œè¿”å›å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(result == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–ä¸»çº¿ç¨‹ä»£ç†å¯¹è±¡</span></span><br><span class="line">        proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å†æ¬¡è¿›è¡Œé€»è¾‘åˆ¤æ–­ï¼Œäº’æ–¥çš„å¤„ç†è®¢å•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">isLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//å°è¯•è·å–é”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> isLock.tryLock();</span><br><span class="line">        <span class="keyword">if</span> (!flag)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è·å–é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//ç”Ÿæˆä¸€äººä¸€å•çš„è®¢å•</span></span><br><span class="line">            proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            isLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ“ä½œæ•°æ®åº“ï¼Œç”Ÿæˆè®¢å•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="comment">//æ£€æŸ¥ä¸€äººä¸€å•</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å‡æ‰£åº“å­˜</span></span><br><span class="line">        <span class="comment">//set stock = stock-1 where voucher_id = ? and stock &gt; 0</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId())</span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä»æ•°æ®åº“ç”Ÿæˆè®¢å•</span></span><br><span class="line">        save(voucherOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div><div class="story post-story"><h2 id="6-è¾¾äººæ¢åº—"><a href="#6-è¾¾äººæ¢åº—" class="headerlink" title="6.è¾¾äººæ¢åº—"></a>6.è¾¾äººæ¢åº—</h2><h3 id="6-1-å‘å¸ƒæ¢åº—ç¬”è®°"><a href="#6-1-å‘å¸ƒæ¢åº—ç¬”è®°" class="headerlink" title="6.1 å‘å¸ƒæ¢åº—ç¬”è®°"></a>6.1 å‘å¸ƒæ¢åº—ç¬”è®°</h3><p>æ¢åº—ç¬”è®°ç±»ä¼¼ç‚¹è¯„ç½‘ç«™çš„è¯„ä»·ï¼Œå¾€å¾€æ˜¯å›¾æ–‡ç»“åˆã€‚å¯¹åº”çš„è¡¨æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>tb_blogï¼šæ¢åº—ç¬”è®°è¡¨ï¼ŒåŒ…å«ç¬”è®°ä¸­çš„æ ‡é¢˜ã€æ–‡å­—ã€å›¾ç‰‡ç­‰</li>
<li>tb_blog_commentsï¼šå…¶ä»–ç”¨æˆ·å¯¹æ¢åº—ç¬”è®°çš„è¯„ä»·</li>
</ul>
<p>å›¾ç‰‡ä¸Šä¼ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;blog&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">uploadImage</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile image)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–åŸå§‹æ–‡ä»¶åç§°</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> image.getOriginalFilename();</span><br><span class="line">            <span class="comment">// ç”Ÿæˆæ–°æ–‡ä»¶å</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> createNewFileName(originalFilename);</span><br><span class="line">            <span class="comment">// ä¿å­˜æ–‡ä»¶</span></span><br><span class="line">            image.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, fileName));</span><br><span class="line">            <span class="comment">// è¿”å›ç»“æœ</span></span><br><span class="line">            log.debug(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œ&#123;&#125;&quot;</span>, fileName);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(fileName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¿å­˜blogï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IBlogService blogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(<span class="meta">@RequestBody</span> Blog blog)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        blog.setUserId(user.getId());</span><br><span class="line">        <span class="comment">// ä¿å­˜æ¢åº—åšæ–‡</span></span><br><span class="line">        blogService.save(blog);</span><br><span class="line">        <span class="comment">// è¿”å›id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-2-æŸ¥çœ‹æ¢åº—ç¬”è®°"><a href="#6-2-æŸ¥çœ‹æ¢åº—ç¬”è®°" class="headerlink" title="6.2 æŸ¥çœ‹æ¢åº—ç¬”è®°"></a>6.2 æŸ¥çœ‹æ¢åº—ç¬”è®°</h3><p><code>BlogController</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IBlogService blogService;</span><br><span class="line">	<span class="comment">//è·å–çƒ­ç‚¹ç¬”è®°åˆ—è¡¨</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hot&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> blogService.queryHotBlog(current);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//é€šè¿‡idè·å–ç¬”è®°</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> blogService.queryBlogById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>BlogServiceImpl</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢</span></span><br><span class="line">        Page&lt;Blog&gt; page = query()</span><br><span class="line">                .orderByDesc(<span class="string">&quot;liked&quot;</span>)</span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">        <span class="comment">// è·å–å½“å‰é¡µæ•°æ®</span></span><br><span class="line">        List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">        records.forEach(blog -&gt;&#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">            blog.setName(user.getNickName());</span><br><span class="line">            blog.setIcon(user.getIcon());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (blog == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç¬”è®°ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">        blog.setName(user.getNickName());</span><br><span class="line">        blog.setIcon(user.getIcon());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-3-ç‚¹èµåŠŸèƒ½"><a href="#6-3-ç‚¹èµåŠŸèƒ½" class="headerlink" title="6.3 ç‚¹èµåŠŸèƒ½"></a>6.3 ç‚¹èµåŠŸèƒ½</h3><p>éœ€æ±‚ï¼š</p>
<ul>
<li>åŒä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ</li>
<li>å¦‚æœå½“å‰ç”¨æˆ·å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤ºï¼ˆå‰ç«¯å·²å®ç°ï¼Œåˆ¤æ–­å­—æ®µBlogç±»çš„isLikeå±æ€§ï¼‰</li>
</ul>
<p>å®ç°æ­¥éª¤ï¼š</p>
<ol>
<li>ç»™Blogç±»ä¸­æ·»åŠ ä¸€ä¸ªisLikeå­—æ®µï¼Œæ ‡ç¤ºæ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµ</li>
<li>ä¿®æ”¹ç‚¹èµåŠŸèƒ½ï¼Œåˆ©ç”¨Redisçš„seté›†åˆåˆ¤æ–­æ˜¯å¦ç‚¹èµè¿‡ï¼Œæœªç‚¹èµè¿‡åˆ™ç‚¹èµæ•°+1ï¼Œå·²ç‚¹èµè¿‡åˆ™ç‚¹èµæ•°-1</li>
<li>ä¿®æ”¹æ ¹æ®idæŸ¥è¯¢Blogçš„ä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li>
<li>ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢Blogä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li>
</ol>
<p>ä¿®æ”¹<code>BlogServiceImpl</code>ï¼Œæ·»åŠ blogæ˜¯å¦å·²ç‚¹èµåŠŸèƒ½ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢</span></span><br><span class="line">        Page&lt;Blog&gt; page = query()</span><br><span class="line">                .orderByDesc(<span class="string">&quot;liked&quot;</span>)</span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">        <span class="comment">// è·å–å½“å‰é¡µæ•°æ®</span></span><br><span class="line">        List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">        records.forEach(blog -&gt;&#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">            blog.setName(user.getNickName());</span><br><span class="line">            blog.setIcon(user.getIcon());</span><br><span class="line">            <span class="comment">//è®¾ç½®å½“å‰blogæ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">            isLikedBlog(blog);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (blog == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç¬”è®°ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">        blog.setName(user.getNickName());</span><br><span class="line">        blog.setIcon(user.getIcon());</span><br><span class="line">        <span class="comment">//è®¾ç½®æŸ¥è¯¢çš„blogæ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">        isLikedBlog(blog);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isLikedBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        <span class="comment">//éœ€è¦åˆ¤æ–­ï¼Œæ²¡æœ‰ç™»å½•æ‹¦æˆªå™¨æ‹¦æˆªè·¯å¾„</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä»Redisä¸­æŸ¥è¯¢æ˜¯å¦ç‚¹èµè¿‡</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + blog.getId();</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">        blog.setIsLike(BooleanUtil.isTrue(isMember));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æ·»åŠ ç‚¹èµåŠŸèƒ½ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸éœ€è¦åˆ¤æ–­ï¼Œå› ä¸ºæœ‰ç™»å½•æ‹¦æˆªå™¨æ‹¦æˆªè·¯å¾„</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//ä»Redisä¸­æŸ¥è¯¢æ˜¯å¦ç‚¹èµè¿‡</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">        <span class="comment">//å¦‚æœæœªç‚¹èµï¼Œåˆ™ç‚¹èµ</span></span><br><span class="line">        <span class="keyword">if</span> (BooleanUtil.isFalse(isMember))&#123;</span><br><span class="line">            <span class="comment">//æ›´æ–°æ•°æ®åº“ä¸­blogçš„ç‚¹èµé‡</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update()</span><br><span class="line">                    .setSql(<span class="string">&quot;liked = liked + 1&quot;</span>)</span><br><span class="line">                    .eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">            <span class="comment">//å¦‚æœæ›´æ–°æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (isSuccess)&#123;</span><br><span class="line">                <span class="comment">//å°†userIdæ”¾å…¥åˆ°Redisçš„seté›†åˆä¸­</span></span><br><span class="line">                stringRedisTemplate.opsForSet().add(key, userId.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœå·²ç»ç‚¹èµï¼Œåˆ™å–æ¶ˆç‚¹èµ</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//æ›´æ–°æ•°æ®åº“ä¸­blogçš„ç‚¹èµé‡</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update()</span><br><span class="line">                    .setSql(<span class="string">&quot;liked = liked - 1&quot;</span>)</span><br><span class="line">                    .eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">            <span class="comment">//å¦‚æœæ›´æ–°æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (isSuccess)&#123;</span><br><span class="line">                <span class="comment">//ä»Redisçš„seté›†åˆä¸­ç§»é™¤userId</span></span><br><span class="line">                stringRedisTemplate.opsForSet().remove(key, userId.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-4-ç‚¹èµæ’è¡Œæ¦œ"><a href="#6-4-ç‚¹èµæ’è¡Œæ¦œ" class="headerlink" title="6.4 ç‚¹èµæ’è¡Œæ¦œ"></a>6.4 ç‚¹èµæ’è¡Œæ¦œ</h3><p>åœ¨æ¢åº—ç¬”è®°çš„è¯¦æƒ…é¡µé¢ï¼Œåº”è¯¥æŠŠç»™è¯¥ç¬”è®°ç‚¹èµçš„äººæ˜¾ç¤ºå‡ºæ¥ï¼Œæ¯”å¦‚æœ€æ—©ç‚¹èµçš„TOP5ï¼Œå½¢æˆç‚¹èµæ’è¡Œæ¦œï¼š</p>
<p>éœ€æ±‚ï¼šæŒ‰ç…§ç‚¹èµæ—¶é—´å…ˆåæ’åºï¼Œè¿”å›Top5çš„ç”¨æˆ·</p>
<table>
<thead>
<tr>
<th></th>
<th>List</th>
<th>Set</th>
<th>SortedSet</th>
</tr>
</thead>
<tbody><tr>
<td>æ’åºæ–¹å¼</td>
<td>æŒ‰æ·»åŠ é¡ºåºæ’åº</td>
<td>æ— æ³•æ’åº</td>
<td>æ ¹æ®scoreå€¼æ’åº</td>
</tr>
<tr>
<td>å”¯ä¸€æ€§</td>
<td>ä¸å”¯ä¸€</td>
<td>å”¯ä¸€</td>
<td>å”¯ä¸€</td>
</tr>
<tr>
<td>æŸ¥æ‰¾æ–¹å¼</td>
<td>æŒ‰ç´¢å¼•æŸ¥æ‰¾æˆ–é¦–å°¾æŸ¥æ‰¾</td>
<td>æ ¹æ®å…ƒç´ æŸ¥æ‰¾</td>
<td>æ ¹æ®å…ƒç´ æŸ¥æ‰¾</td>
</tr>
</tbody></table>
<p>Sortedsetçš„å¯æ’åºç‰¹æ€§ï¼Œå¯ä»¥ç”¨æ¥<strong>å®ç°æ’è¡Œæ¦œ</strong>è¿™æ ·çš„åŠŸèƒ½ã€‚</p>
<p>æ·»åŠ ç‚¹èµç”¨æˆ·ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zadd key vlaue score</span><br></pre></td></tr></table></figure>

<p>è·å–scoreå‰äº”åçš„ç”¨æˆ·ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zscore key 0 4</span><br></pre></td></tr></table></figure>



<p>ä»<code>set</code>é›†åˆæ”¹è¿›ä¸º<code>SortSet</code>é›†åˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢</span></span><br><span class="line">        Page&lt;Blog&gt; page = query()</span><br><span class="line">                .orderByDesc(<span class="string">&quot;liked&quot;</span>)</span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">        <span class="comment">// è·å–å½“å‰é¡µæ•°æ®</span></span><br><span class="line">        List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">        records.forEach(blog -&gt;&#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">            blog.setName(user.getNickName());</span><br><span class="line">            blog.setIcon(user.getIcon());</span><br><span class="line">            <span class="comment">//è®¾ç½®å½“å‰blogæ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">            isLikedBlog(blog);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (blog == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç¬”è®°ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">        blog.setName(user.getNickName());</span><br><span class="line">        blog.setIcon(user.getIcon());</span><br><span class="line">        <span class="comment">//è®¾ç½®æŸ¥è¯¢çš„blogæ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">        isLikedBlog(blog);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸éœ€è¦åˆ¤æ–­ï¼Œå› ä¸ºæœ‰ç™»å½•æ‹¦æˆªå™¨æ‹¦æˆªè·¯å¾„</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//ä»Redisä¸­æŸ¥è¯¢æ˜¯å¦ç‚¹èµè¿‡</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;</span><br><span class="line">        <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">        <span class="comment">//å¦‚æœæœªç‚¹èµï¼Œåˆ™ç‚¹èµ</span></span><br><span class="line">        <span class="keyword">if</span> (score == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//æ›´æ–°æ•°æ®åº“ä¸­blogçš„ç‚¹èµé‡</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update()</span><br><span class="line">                    .setSql(<span class="string">&quot;liked = liked + 1&quot;</span>)</span><br><span class="line">                    .eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">            <span class="comment">//å¦‚æœæ›´æ–°æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (isSuccess)&#123;</span><br><span class="line">                <span class="comment">//å°†userIdæ”¾å…¥åˆ°Redisçš„sortedSeté›†åˆä¸­,ä»¥æ—¶é—´æˆ³ä¸ºscore</span></span><br><span class="line">                stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœå·²ç»ç‚¹èµï¼Œåˆ™å–æ¶ˆç‚¹èµ</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//æ›´æ–°æ•°æ®åº“ä¸­blogçš„ç‚¹èµé‡</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update()</span><br><span class="line">                    .setSql(<span class="string">&quot;liked = liked - 1&quot;</span>)</span><br><span class="line">                    .eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">            <span class="comment">//å¦‚æœæ›´æ–°æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (isSuccess)&#123;</span><br><span class="line">                <span class="comment">//ä»Redisçš„seté›†åˆä¸­ç§»é™¤userId</span></span><br><span class="line">                stringRedisTemplate.opsForZSet().remove(key, userId.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isLikedBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        <span class="comment">//éœ€è¦åˆ¤æ–­ï¼Œæ²¡æœ‰ç™»å½•æ‹¦æˆªå™¨æ‹¦æˆªè·¯å¾„</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä»Redisä¸­æŸ¥è¯¢æ˜¯å¦ç‚¹èµè¿‡</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + blog.getId();</span><br><span class="line">        <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">        blog.setIsLike(score != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>åœ¨ <code>BlogServiceImpl</code> æ·»åŠ ç‚¹èµæ’è¡Œæ¦œåŠŸèƒ½ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;</span><br><span class="line">        <span class="comment">//æŸ¥è¯¢ç‚¹èµå‰5çš„userId</span></span><br><span class="line">        Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0L</span>, <span class="number">4L</span>);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºnullæˆ–è€…ä¸ºç©ºï¼Œåˆ™è¿”å›ç©ºåˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">if</span> (top5 == <span class="literal">null</span> || top5.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è§£æuserId</span></span><br><span class="line">        List&lt;Long&gt; userIds = top5</span><br><span class="line">                .stream()</span><br><span class="line">                .map(Long::valueOf)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="type">String</span> <span class="variable">join</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, userIds);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–userDtoä¿¡æ¯ï¼Œè·å–çš„ä¿¡æ¯åº”è¯¥ä¹Ÿè¦æŒ‰ç…§å…ˆåé¡ºåº</span></span><br><span class="line">        <span class="comment">//WHERE id IN 5,1 ORDER BY FIELD(id,5,1)</span></span><br><span class="line">        List&lt;UserDTO&gt; top5List = userService.query()</span><br><span class="line">                .in(<span class="string">&quot;id&quot;</span>, userIds)</span><br><span class="line">                .last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + join + <span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">                .stream()</span><br><span class="line">                .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(top5List);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





</div><div class="story post-story"><h2 id="7-å¥½å‹å…³æ³¨"><a href="#7-å¥½å‹å…³æ³¨" class="headerlink" title="7.å¥½å‹å…³æ³¨"></a>7.å¥½å‹å…³æ³¨</h2><h3 id="7-1-å…³æ³¨å’Œå–å…³"><a href="#7-1-å…³æ³¨å’Œå–å…³" class="headerlink" title="7.1 å…³æ³¨å’Œå–å…³"></a>7.1 å…³æ³¨å’Œå–å…³</h3><p>åœ¨æ¢åº—å›¾æ–‡çš„è¯¦æƒ…é¡µé¢ä¸­ï¼Œå¯ä»¥å…³æ³¨å‘å¸ƒç¬”è®°çš„ä½œè€…ï¼š</p>
<ol>
<li>å°è¯•å…³æ³¨ç”¨æˆ·</li>
<li>æ˜¯å¦å·²ç»å…³æ³¨ç”¨æˆ·</li>
</ol>
<p>éœ€æ±‚ï¼šåŸºäºè¯¥è¡¨æ•°æ®ç»“æ„ï¼Œå®ç°ä¸¤ä¸ªæ¥å£ï¼š</p>
<ol>
<li>å…³æ³¨å’Œå–å…³æ¥å£</li>
<li>åˆ¤æ–­æ˜¯å¦å…³æ³¨çš„æ¥å£</li>
</ol>
<p>å…³æ³¨æ˜¯Userä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯åšä¸»ä¸ç²‰ä¸çš„å…³ç³»ï¼Œæ•°æ®åº“ä¸­æœ‰ä¸€å¼ tb_followè¡¨æ¥æ ‡ç¤º</p>
<p>åœ¨<code>FollowServiceImpl</code>ä¸­å®ç°å…³æ³¨å’Œå–æ¶ˆå…³æ³¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;FollowMapper, Follow&gt; <span class="keyword">implements</span> <span class="title class_">IFollowService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId)</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).count();</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦å¤§äº0</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(count &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (BooleanUtil.isTrue(isFollow)) &#123;</span><br><span class="line">            <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">            follow.setUserId(userId);</span><br><span class="line">            follow.setFollowUserId(followUserId);</span><br><span class="line">            <span class="comment">//ä¿å­˜</span></span><br><span class="line">            save(follow);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//delete from tb_follow where userId = ? and follow_user_id = ?</span></span><br><span class="line">            remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                    .eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId)</span><br><span class="line">                    .eq(<span class="string">&quot;user_id&quot;</span>, userId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-2-å…±åŒå…³æ³¨"><a href="#7-2-å…±åŒå…³æ³¨" class="headerlink" title="7.2 å…±åŒå…³æ³¨"></a>7.2 å…±åŒå…³æ³¨</h3><p>éœ€æ±‚ï¼šåˆ©ç”¨Redisä¸­æ°å½“çš„æ•°æ®ç»“æ„ï¼Œå®ç°å…±åŒå…³æ³¨åŠŸèƒ½ã€‚åœ¨åšä¸»ä¸ªäººé¡µé¢å±•ç¤ºå‡ºå½“å‰ç”¨æˆ·ä¸åšä¸»çš„å…±åŒå¥½å‹ã€‚</p>
<p>Redisä¸­çš„seté›†åˆæ”¯æŒäº¤é›†ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä¹‹å‰çš„<strong>å…³æ³¨å’Œå–å…³</strong>ä»¥åŠ<strong>æ˜¯å¦å·²ç»å…³æ³¨</strong>ï¼Œè¿›è¡Œæ”¹è¿›</p>
<p>åœ¨ <code>FollowServiceImpl</code>ä¸­<code>isFollow()</code> å’Œ <code>follow()</code>æ–¹æ³•ï¼Œå°†å…³æ³¨åˆ—è¡¨æ·»åŠ åˆ°Redisçš„seté›†åˆä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;FollowMapper, Follow&gt; <span class="keyword">implements</span> <span class="title class_">IFollowService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//å…ˆä»Redisä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»å…³æ³¨äº†</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet()</span><br><span class="line">                .isMember(RedisConstants.FOLLOW_KEY + userId, followUserId.toString());</span><br><span class="line">        <span class="keyword">if</span> (BooleanUtil.isTrue(isMember))&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId)</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).count();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦å¤§äº0</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//ä»Redisæ·»åŠ å…³æ³¨</span></span><br><span class="line">            stringRedisTemplate.opsForSet()</span><br><span class="line">                    .add(RedisConstants.FOLLOW_KEY + userId, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(count &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (BooleanUtil.isTrue(isFollow)) &#123;</span><br><span class="line">            <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">            follow.setUserId(userId);</span><br><span class="line">            follow.setFollowUserId(followUserId);</span><br><span class="line">            <span class="comment">//ä¿å­˜</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line">            <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">                <span class="comment">//ä»Redisæ·»åŠ å…³æ³¨</span></span><br><span class="line">                stringRedisTemplate.opsForSet()</span><br><span class="line">                        .add(RedisConstants.FOLLOW_KEY + userId, followUserId.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//delete from tb_follow where userId = ? and follow_user_id = ?</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                    .eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId)</span><br><span class="line">                    .eq(<span class="string">&quot;user_id&quot;</span>, userId));</span><br><span class="line">            <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">                <span class="comment">//ä»Redisä¸­ç§»é™¤å…³æ³¨</span></span><br><span class="line">                stringRedisTemplate.opsForSet()</span><br><span class="line">                        .remove(RedisConstants.FOLLOW_KEY + userId, followUserId.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>åœ¨ <code>FollowServiceImpl</code> å®ç°å…±åŒå…³æ³¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;FollowMapper, Follow&gt; <span class="keyword">implements</span> <span class="title class_">IFollowService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">commonFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line"></span><br><span class="line">        Set&lt;String&gt; common = stringRedisTemplate.opsForSet().intersect(</span><br><span class="line">                RedisConstants.FOLLOW_KEY + userId,</span><br><span class="line">                RedisConstants.FOLLOW_KEY + followUserId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºnullæˆ–è€…ä¸ºç©ºï¼Œåˆ™è¿”å›ç©ºåˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">if</span> (common == <span class="literal">null</span> || common.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è§£æuserId</span></span><br><span class="line">        List&lt;Long&gt; userIds = common</span><br><span class="line">                .stream()</span><br><span class="line">                .map(Long::valueOf)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–userDtoä¿¡æ¯</span></span><br><span class="line">        List&lt;UserDTO&gt; commonList = userService.listByIds(userIds)</span><br><span class="line">                .stream()</span><br><span class="line">                .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(commonList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-3-å…³æ³¨æ¨é€Feedæµå®ç°åˆ†æ"><a href="#7-3-å…³æ³¨æ¨é€Feedæµå®ç°åˆ†æ" class="headerlink" title="7.3 å…³æ³¨æ¨é€Feedæµå®ç°åˆ†æ"></a>7.3 å…³æ³¨æ¨é€Feedæµå®ç°åˆ†æ</h3><p>å…³æ³¨æ¨é€ä¹Ÿå«åšFeedæµï¼Œç›´è¯‘ä¸ºæŠ•å–‚ã€‚ä¸ºç”¨æˆ·æŒç»­çš„æä¾›â€œæ²‰æµ¸å¼â€çš„ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯ã€‚</p>
<p><img src="https://s2.loli.net/2023/02/01/hMULzRu8p7GYkti.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/01/hMULzRu8p7GYkti.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-01_13-55-47.png"></p>
<p>Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼ï¼š</p>
<ul>
<li><p>Timelineï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨ã€‚ä¾‹å¦‚æœ‹å‹åœˆ</p>
<ul>
<li>ä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ã€‚å¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•</li>
<li>ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½</li>
</ul>
</li>
<li><p>æ™ºèƒ½æ’åºï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ã€‚æ¨é€ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·</p>
<ul>
<li>ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·</li>
<li>ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½èµ·åˆ°åä½œç”¨</li>
</ul>
</li>
</ul>
<p>æœ¬ä¾‹ä¸­çš„ä¸ªäººé¡µé¢ï¼Œæ˜¯<strong>åŸºäºå…³æ³¨çš„å¥½å‹</strong>æ¥åšFeedæµï¼Œå› æ­¤é‡‡ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</p>
<ul>
<li><p>æ‹‰æ¨¡å¼ï¼šä¹Ÿå«åšè¯»æ‰©æ•£ã€‚</p>
<img src="https://s2.loli.net/2023/02/01/5mRbF9h174cjed6.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/01/5mRbF9h174cjed6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-01_13-55-47.png"  />
</li>
<li><p>æ¨æ¨¡å¼ï¼šä¹Ÿå«åšå†™æ‰©æ•£ã€‚</p>
<img src="https://s2.loli.net/2023/02/01/IBtNOXDMHAwvdVn.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/01/IBtNOXDMHAwvdVn.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-01_13-55-47.png" style="zoom:67%;" />
</li>
<li><p>æ¨æ‹‰ç»“åˆï¼šä¹Ÿå«åšè¯»å†™æ··åˆï¼Œå…¼å…·æ¨å’Œæ‹‰ä¸¤ç§æ¨¡å¼çš„ä¼˜ç‚¹ã€‚</p>
<p><img src="https://s2.loli.net/2023/02/01/iuSzEwRbmflLOPB.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/01/iuSzEwRbmflLOPB.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-01_13-55-47.png"></p>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>æ‹‰æ¨¡å¼</th>
<th>æ¨æ¨¡å¼</th>
<th>æ¨æ‹‰ç»“åˆ</th>
</tr>
</thead>
<tbody><tr>
<td>å†™æ¯”ä¾‹</td>
<td>ä½</td>
<td>é«˜</td>
<td>ä¸­</td>
</tr>
<tr>
<td>è¯»æ¯”ä¾‹</td>
<td>é«˜</td>
<td>ä½</td>
<td>ä¸­</td>
</tr>
<tr>
<td>ç”¨æˆ·è¯»å–å»¶è¿Ÿ</td>
<td>é«˜</td>
<td>ä½</td>
<td>ä½</td>
</tr>
<tr>
<td>å®ç°éš¾åº¦</td>
<td>å¤æ‚</td>
<td>ç®€å•</td>
<td>å¾ˆå¤æ‚</td>
</tr>
<tr>
<td>ä½¿ç”¨åœºæ™¯</td>
<td>å¾ˆå°‘ä½¿ç”¨</td>
<td>ç”¨æˆ·é‡å°‘ï¼Œæ²¡æœ‰å¤§V</td>
<td>è¿‡åƒä¸‡çš„ç”¨æˆ·é‡ï¼Œæœ‰å¤§V</td>
</tr>
</tbody></table>
<h3 id="7-4-æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±"><a href="#7-4-æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±" class="headerlink" title="7.4 æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±"></a>7.4 æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±</h3><p>éœ€æ±‚ï¼š</p>
<ol>
<li>ä¿®æ”¹æ–°å¢æ¢åº—ç¬”è®°çš„ä¸šåŠ¡ï¼Œåœ¨ä¿å­˜blogåˆ°æ•°æ®åº“çš„åŒæ—¶ï¼Œæ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±(æ¨æ¨¡å¼)</li>
<li>æ”¶ä»¶ç®±æ»¡è¶³å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ’åºï¼Œå¿…é¡»ç”¨Redisçš„æ•°æ®ç»“æ„å®ç°</li>
<li>æŸ¥è¯¢æ”¶ä»¶ç®±æ•°æ®æ—¶ï¼Œå¯ä»¥å®ç°åˆ†é¡µæŸ¥è¯¢</li>
</ol>
<p>Feedæµä¸­çš„æ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œæ‰€ä»¥æ•°æ®çš„è§’æ ‡ä¹Ÿåœ¨å˜åŒ–ï¼Œå› æ­¤ä¸èƒ½é‡‡ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼ã€‚</p>
<p>Feedæµçš„æ»šåŠ¨åˆ†é¡µï¼š</p>
<p><img src="https://s2.loli.net/2023/02/01/mu9A6DCEkPVXN4T.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/01/mu9A6DCEkPVXN4T.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-01_13-55-47.png"></p>
<p>ä¿å­˜blogåˆ°æ•°æ®åº“ï¼Œå°†blogçš„idæ”¾å…¥ç²‰ä¸æ”¶ä»¶ç®±ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IFollowService followService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        blog.setUserId(userId);</span><br><span class="line">        <span class="comment">//å°†blogä¿å­˜åˆ°æ•°æ®åº“</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(blog);</span><br><span class="line">        <span class="keyword">if</span> (!isSuccess) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ–°å¢å›¾ä¹¦å¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æŸ¥è¯¢åˆ°æ‰€æœ‰ç²‰ä¸</span></span><br><span class="line">        List&lt;Follow&gt; followList = followService.query().eq(<span class="string">&quot;follow_user_id&quot;</span>, userId).list();</span><br><span class="line">        <span class="comment">//éå†å°†blogçš„idæ”¾å…¥åˆ°ç²‰ä¸çš„Redisçš„sortedseté›†åˆä¸­</span></span><br><span class="line">        <span class="keyword">for</span> (Follow follow : followList) &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">            stringRedisTemplate.opsForZSet()</span><br><span class="line">                    .add(RedisConstants.FEED_KEY + id,</span><br><span class="line">                            blog.getId().toString(),</span><br><span class="line">                            System.currentTimeMillis());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-5-æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±æ€è·¯"><a href="#7-5-æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±æ€è·¯" class="headerlink" title="7.5 æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±æ€è·¯"></a>7.5 æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±æ€è·¯</h3><p>éœ€æ±‚ï¼šåœ¨ä¸ªäººä¸»é¡µçš„â€œå…³æ³¨â€å¡ç‰‡ä¸­ï¼ŒæŸ¥è¯¢å¹¶å±•ç¤ºæ¨é€çš„Blogä¿¡æ¯ï¼š</p>
<p>Redisçš„sortedSeté›†åˆçš„æ»šåŠ¨åˆ†é¡µå‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZREVRANGEBYSCORE feed:userId max min WITHSCORES LIMIT offset count</span><br></pre></td></tr></table></figure>

<p>åˆ†é¡µæŸ¥è¯¢å‚æ•°ï¼š</p>
<ul>
<li>maxï¼šä¸Šä¸€æ¬¡æŸ¥è¯¢çš„æœ€å°æ—¶é—´æˆ³ | å½“å‰æ—¶é—´(score)</li>
<li>minï¼šæœ€å°æ—¶é—´æˆ³ï¼Œå›ºå®šä¸º0</li>
<li>offsetï¼šä¸Šä¸€æ¬¡çš„ç»“æœä¸­ï¼Œä¸æœ€å°å€¼ä¸€æ ·çš„å…ƒç´ çš„ä¸ªæ•°(åç§»é‡)</li>
<li>countï¼šåˆ†é¡µå¤§å°ï¼Œå›ºå®šä¸º3</li>
</ul>
<h3 id="7-6-å®ç°æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢"><a href="#7-6-å®ç°æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢" class="headerlink" title="7.6 å®ç°æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢"></a>7.6 å®ç°æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢</h3><p>å°è£…æ»šåŠ¨åˆ†é¡µæ•°æ®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScoreResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;?&gt; list;</span><br><span class="line">    <span class="keyword">private</span> Integer offset;</span><br><span class="line">    <span class="keyword">private</span> Long minTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>BlogServiceImpl</code>ä¸­å®ç°è·å–æ¨æ–‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(Integer offset, Long maxTime)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//è·å–æ»šåŠ¨åˆ†é¡µæ•°æ®</span></span><br><span class="line">        Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">                .reverseRangeByScoreWithScores(</span><br><span class="line">                        RedisConstants.FEED_KEY + userId,</span><br><span class="line">                        <span class="number">0</span>, maxTime,</span><br><span class="line">                        offset, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºnullæˆ–è€…ä¸ºç©ºï¼Œåˆ™è¿”å›ç©ºåˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">if</span> (typedTuples == <span class="literal">null</span> || typedTuples.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è§£æå‡ºblogIdåˆ—è¡¨ã€minTimeæœ€å°æ—¶é—´æˆ³ã€offsetåç§»é‡</span></span><br><span class="line">        List&lt;Long&gt; blogIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typedTuples.size());</span><br><span class="line">        <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        offset = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; typedTuple : typedTuples) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">blogIdStr</span> <span class="operator">=</span> typedTuple.getValue();</span><br><span class="line">            blogIds.add(Long.valueOf(blogIdStr));</span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> typedTuple.getScore().longValue();</span><br><span class="line">            <span class="keyword">if</span> (time == minTime)&#123;</span><br><span class="line">                offset++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                minTime = time;</span><br><span class="line">                offset = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">join</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, blogIds);</span><br><span class="line">        <span class="comment">//æ ¹æ®blogIdï¼Œè·å¾—æŒ‰ç…§é¡ºåºçš„blogListåˆ—è¡¨</span></span><br><span class="line">        List&lt;Blog&gt; blogList = query()</span><br><span class="line">                .in(<span class="string">&quot;id&quot;</span>, blogIds)</span><br><span class="line">                .last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + join + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ·»åŠ æ˜¯å¦å·²ç‚¹èµï¼Œä»¥åŠåå­—ã€å¤´åƒ</span></span><br><span class="line">        <span class="keyword">for</span> (Blog blog : blogList) &#123;</span><br><span class="line">            queryUserToBlog(blog);</span><br><span class="line">            isLikedBlog(blog);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å°è£…æ•°æ®ï¼Œè¿”å›</span></span><br><span class="line">        <span class="type">ScoreResult</span> <span class="variable">scoreResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScoreResult</span>();</span><br><span class="line">        scoreResult.setList(blogList);</span><br><span class="line">        scoreResult.setOffset(offset);</span><br><span class="line">        scoreResult.setMinTime(minTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(scoreResult);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isLikedBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        <span class="comment">//éœ€è¦åˆ¤æ–­ï¼Œæ²¡æœ‰ç™»å½•æ‹¦æˆªå™¨æ‹¦æˆªè·¯å¾„</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä»Redisä¸­æŸ¥è¯¢æ˜¯å¦ç‚¹èµè¿‡</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + blog.getId();</span><br><span class="line">        <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">        blog.setIsLike(score != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">queryUserToBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">        blog.setName(user.getNickName());</span><br><span class="line">        blog.setIcon(user.getIcon());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div><div class="story post-story"><h2 id="8-é™„è¿‘çš„å•†æˆ·"><a href="#8-é™„è¿‘çš„å•†æˆ·" class="headerlink" title="8.é™„è¿‘çš„å•†æˆ·"></a>8.é™„è¿‘çš„å•†æˆ·</h2><h3 id="8-1-GEOæ•°æ®ç»“æ„"><a href="#8-1-GEOæ•°æ®ç»“æ„" class="headerlink" title="8.1 GEOæ•°æ®ç»“æ„"></a>8.1 GEOæ•°æ®ç»“æ„</h3><p>GEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚</p>
<p>Redisåœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ã€‚å¸¸è§çš„å‘½ä»¤æœ‰ï¼š</p>
<blockquote>
<ul>
<li><code>GEOADD</code>ï¼šæ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦(longitude)ã€çº¬åº¦(latitude)ã€å€¼(member)</li>
<li><code>GEODIST</code>ï¼šè®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›</li>
<li><code>GEOHASH</code>ï¼šå°†æŒ‡å®šmemberçš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›</li>
<li><code>GEOPOS</code>ï¼šè¿”å›æŒ‡å®šmemberçš„åæ ‡</li>
<li><code>GEORADIUS</code>ï¼šæŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚6.2ä»¥åå·²åºŸå¼ƒ</li>
<li><code>GEOSEARCH</code>ï¼šåœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢member,å¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©å½¢ã€‚6.2.æ–°åŠŸèƒ½</li>
<li><code>GEOSEARCHSTORE</code>ï¼šä¸<code>GEOSEARCH</code>åŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyã€‚6.2.æ–°åŠŸèƒ½</li>
</ul>
</blockquote>
<p>ç»ƒä¹ Redisçš„GEOåŠŸèƒ½<br>éœ€æ±‚ï¼š</p>
<ol>
<li><p>æ·»åŠ ä¸‹é¢å‡ æ¡æ•°æ®ï¼š</p>
<ul>
<li><p>åŒ—äº¬å—ç«™(116.378248, 39.865275)</p>
</li>
<li><p>åŒ—äº¬ç«™(116.42803, 39.903738)</p>
</li>
<li><p>åŒ—äº¬è¥¿ç«™(116.322287, 39.893729)</p>
</li>
</ul>
</li>
<li><p>è®¡ç®—åŒ—äº¬è¥¿ç«™åˆ°åŒ—äº¬ç«™çš„è·ç¦»</p>
</li>
<li><p>æœç´¢å¤©å®‰é—¨(116.397904, 39.909005)é™„è¿‘10kmå†…çš„æ‰€æœ‰ç«è½¦ç«™ï¼Œå¹¶æŒ‰ç…§è·ç¦»å‡åºæ’åº</p>
</li>
</ol>
<p>æ·»åŠ æ•°æ®ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geoadd g1 116.378248 39.865275 bjnz 116.42803 39.903738 bjz 116.322287 39.893729 bjxz</span><br></pre></td></tr></table></figure>

<p>è®¡ç®—åŒ—äº¬è¥¿ç«™åˆ°åŒ—äº¬ç«™çš„è·ç¦»(km)ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geodist g1 bjxz bjz km</span><br></pre></td></tr></table></figure>

<p>æœç´¢å¤©å®‰é—¨é™„è¿‘10kmå†…çš„æ‰€æœ‰ç«è½¦ç«™ï¼Œå¹¶æŒ‰ç…§è·ç¦»å‡åºæ’åºï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geosearch g1 fromlonlat 116.397904 39.909005 byradius 10 km withdist</span><br></pre></td></tr></table></figure>



<h3 id="8-2-å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO"><a href="#8-2-å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO" class="headerlink" title="8.2 å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO"></a>8.2 å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</h3><p>åœ¨é¦–é¡µä¸­ç‚¹å‡»æŸä¸ªé¢‘é“ï¼Œå³å¯çœ‹åˆ°é¢‘é“ä¸‹çš„å•†æˆ·ï¼š</p>
<p>æŒ‰ç…§å•†æˆ·ç±»å‹åšåˆ†ç»„ï¼Œç±»å‹ç›¸åŒçš„å•†æˆ·ä½œä¸ºåŒä¸€ç»„ï¼Œä»¥typeldä¸ºkeyå­˜å…¥åŒä¸€ä¸ªGEOé›†åˆä¸­å³å¯</p>
<table>
<thead>
<tr>
<th>KEY</th>
<th>VALUE</th>
<th>SCORE</th>
</tr>
</thead>
<tbody><tr>
<td>shop:geo:1</td>
<td>ç«é”…</td>
<td>â€¦</td>
</tr>
<tr>
<td></td>
<td>çƒ§çƒ¤</td>
<td>â€¦</td>
</tr>
<tr>
<td>shop:geo:2</td>
<td>KTV1</td>
<td>â€¦</td>
</tr>
<tr>
<td></td>
<td>KTV2</td>
<td>â€¦</td>
</tr>
</tbody></table>
<p>ä»æ•°æ®åº“ä¸­è·å–shopåˆ—è¡¨ï¼Œä»¥typeIdä¸ºkeyï¼Œå•†å®¶çš„idä¸ºvalueï¼Œå­˜å…¥ç»çº¬åº¦ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testQueryShop2Redis</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Shop&gt; list = shopService.list();</span><br><span class="line">    <span class="comment">//ä»¥typeIdå°†shopåˆ†ç»„</span></span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="comment">//åˆ†æ‰¹å®Œæˆå†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">//è·å–ç±»å‹d</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="comment">//è·å–åŒç±»å‹çš„åº—é“ºçš„é›†åˆ</span></span><br><span class="line">        List&lt;Shop&gt; value = entry.getValue();</span><br><span class="line">        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(value.size());</span><br><span class="line">        <span class="comment">//å†™å…¥redis</span></span><br><span class="line">        <span class="keyword">for</span> (Shop shop : value) &#123;</span><br><span class="line">            locations.add(<span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(</span><br><span class="line">                shop.getId().toString(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(),shop.getY()))</span><br><span class="line">                         );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-3-å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½"><a href="#8-3-å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½" class="headerlink" title="8.3 å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½"></a>8.3 å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</h3><p>SpringDataRedisçš„2.3.9ç‰ˆæœ¬å¹¶ä¸æ”¯æŒRedis6.2æä¾›çš„GEOSEARCHå‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æç¤ºå…¶ç‰ˆæœ¬ï¼Œä¿®æ”¹è‡ªå·±çš„POMæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æ’é™¤redisè€ç‰ˆæœ¬ä¾èµ– --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- æ·»åŠ redisæ–°ç‰ˆæœ¬ä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>ShopServiceImpl</code>çš„ <code>queryShopByType()</code>æ–¹æ³• å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;ShopMapper, Shop&gt; <span class="keyword">implements</span> <span class="title class_">IShopService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœåæ ‡ä¸ºnullï¼Œåˆ™ç›´æ¥è¿”å›æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span> || y == <span class="literal">null</span>) &#123;</span><br><span class="line">            Page&lt;Shop&gt; page = query()</span><br><span class="line">                    .eq(<span class="string">&quot;type_id&quot;</span>, typeId)</span><br><span class="line">                    .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;Shop&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">            <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current-<span class="number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo()</span><br><span class="line">                .search(</span><br><span class="line">                        RedisConstants.SHOP_GEO_KEY + typeId,</span><br><span class="line">                        GeoReference.fromCoordinate(x, y),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">5</span> * <span class="number">1000</span>),</span><br><span class="line">                        RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs()</span><br><span class="line">                                .includeDistance()</span><br><span class="line">                                .limit(end));<span class="comment">//æˆªå–0~endä¸ªæ•°æ®</span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸ºç©ºçš„æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">if</span> (results == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; content = results.getContent();</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> content.size();</span><br><span class="line">        <span class="comment">//æˆªå–çš„æ•°æ®æœ‰å¯èƒ½ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (from &gt;= size)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æˆªå–from~endçš„æ•°æ®</span></span><br><span class="line">        List&lt;Long&gt; shopIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(size);</span><br><span class="line">        List&lt;Double&gt; distances = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(size);</span><br><span class="line">        content.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class="line">            <span class="comment">//è·å–shopId</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">shopIdStr</span> <span class="operator">=</span> result.getContent().getName();</span><br><span class="line">            shopIds.add(Long.valueOf(shopIdStr));</span><br><span class="line">            <span class="comment">//è·å–è·ç¦»</span></span><br><span class="line">            <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> result.getDistance().getValue();</span><br><span class="line">            distances.add(distance);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">join</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, shopIds);</span><br><span class="line">        <span class="comment">//æ ¹æ®shopIdï¼Œè·å¾—æŒ‰ç…§é¡ºåºçš„shopListåˆ—è¡¨</span></span><br><span class="line">        List&lt;Shop&gt; shopList = query()</span><br><span class="line">                .in(<span class="string">&quot;id&quot;</span>, shopIds)</span><br><span class="line">                .last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + join + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">        <span class="comment">//å°†è·ç¦»æ”¾å…¥shopä¸­</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; shopList.size(); i++) &#123;</span><br><span class="line">            shopList.get(i).setDistance(distances.get(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(shopList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div><div class="story post-story"><h2 id="9-ç”¨æˆ·ç­¾åˆ°"><a href="#9-ç”¨æˆ·ç­¾åˆ°" class="headerlink" title="9.ç”¨æˆ·ç­¾åˆ°"></a>9.ç”¨æˆ·ç­¾åˆ°</h2><h3 id="9-1-BitMapåŠŸèƒ½"><a href="#9-1-BitMapåŠŸèƒ½" class="headerlink" title="9.1 BitMapåŠŸèƒ½"></a>9.1 BitMapåŠŸèƒ½</h3><p>ç”¨<code>tb_user_sign</code>è¡¨æ¥å­˜å‚¨ç”¨æˆ·ç­¾åˆ°ä¿¡æ¯</p>
<p>æˆ‘ä»¬æŒ‰æœˆæ¥ç»Ÿè®¡ç”¨æˆ·ç­¾åˆ°ä¿¡æ¯ï¼Œç­¾åˆ°è®°å½•ä¸º1ï¼Œæœªç­¾åˆ°åˆ™è®°å½•ä¸º0.</p>
<p><img src="https://s2.loli.net/2023/02/02/QnP8IXoHdGU9NW7.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/02/QnP8IXoHdGU9NW7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-02_20-40-50.png"></p>
<p>æŠŠæ¯ä¸€ä¸ªbitä½å¯¹åº”å½“æœˆçš„æ¯ä¸€å¤©ï¼Œå½¢æˆäº†æ˜ å°„å…³ç³»ã€‚ç”¨0å’Œ1æ ‡ç¤ºä¸šåŠ¡çŠ¶æ€ï¼Œè¿™ç§æ€è·¯å°±ç§°ä¸ºä½å›¾(BitMap)ã€‚</p>
<p>Redisä¸­æ˜¯åˆ©ç”¨stringç±»å‹æ•°æ®ç»“æ„å®ç°<strong>BitMap</strong>ï¼Œå› æ­¤æœ€å¤§ä¸Šé™æ˜¯512Mï¼Œè½¬æ¢ä¸ºbitåˆ™æ˜¯$2^{32}$ä¸ªbitä½ã€‚</p>
<p>BitMapçš„æ“ä½œå‘½ä»¤æœ‰ï¼š</p>
<blockquote>
<ul>
<li><code>SETBIT</code>ï¼šå‘æŒ‡å®šä½ç½®(offset)å­˜å…¥ä¸€ä¸ª0æˆ–1</li>
<li><code>GETBIT</code>ï¼šè·å–æŒ‡å®šä½ç½®(offset)çš„bitå€¼</li>
<li><code>BITCOUNT</code>ï¼šç»Ÿè®¡BitMapä¸­å€¼ä¸º1çš„bitä½çš„æ•°é‡</li>
<li><code>BITFIELD</code>ï¼šæ“ä½œ(æŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢)BitMapä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®(offset)çš„å€¼</li>
<li><code>BITFIELD_RO</code>ï¼šè·å–BitMapä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›</li>
<li><code>BTOP</code>ï¼šå°†å¤šä¸ªBitMapçš„ç»“æœåšä½è¿ç®—(ä¸ã€æˆ–ã€å¼‚æˆ–)</li>
<li><code>BITPOS</code>ï¼šæŸ¥æ‰¾bitæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª0æˆ–1å‡ºç°çš„ä½ç½®</li>
</ul>
</blockquote>
<h3 id="9-2-å®ç°ç­¾åˆ°åŠŸèƒ½"><a href="#9-2-å®ç°ç­¾åˆ°åŠŸèƒ½" class="headerlink" title="9.2 å®ç°ç­¾åˆ°åŠŸèƒ½"></a>9.2 å®ç°ç­¾åˆ°åŠŸèƒ½</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="comment">//è·å–å¹´æœˆ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">format</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.USER_SIGN_KEY + userId + format;</span><br><span class="line">        <span class="comment">//è·å–æœ¬æœˆçš„ç¬¬å‡ å¤©</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">day</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">		<span class="comment">//åˆ¤æ–­ä»Šå¤©æ˜¯å¦å·²ç»ç­¾åˆ°è¿‡</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().getBit(key, day - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (BooleanUtil.isTrue(isSuccess))&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä½ ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//ç­¾åˆ°</span></span><br><span class="line">        stringRedisTemplate.opsForValue().setBit(key, day-<span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="9-3-ç»Ÿè®¡è¿ç»­ç­¾åˆ°"><a href="#9-3-ç»Ÿè®¡è¿ç»­ç­¾åˆ°" class="headerlink" title="9.3 ç»Ÿè®¡è¿ç»­ç­¾åˆ°"></a>9.3 ç»Ÿè®¡è¿ç»­ç­¾åˆ°</h3><p>è¿ç»­ç­¾åˆ°å¤©æ•°ï¼šä»æœ€åä¸€æ¬¡ç­¾åˆ°å¼€å§‹å‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€æ¬¡æœªç­¾åˆ°ä¸ºæ­¢ï¼Œè®¡ç®—æ€»çš„ç­¾åˆ°æ¬¡æ•°ï¼Œå°±æ˜¯è¿ç»­ç­¾åˆ°å¤©æ•°ã€‚</p>
<p>å®ç°è¿ç»­ç­¾åˆ°ç»Ÿè®¡åŠŸèƒ½ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="comment">//è·å–å¹´æœˆ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">format</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.USER_SIGN_KEY + userId + format;</span><br><span class="line">        <span class="comment">//è·å–æœ¬æœˆçš„ç¬¬å‡ å¤©</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">day</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">        <span class="comment">//è·å–æœ¬æœˆæˆªè‡³ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰çš„ç­¾åˆ°è®°å½•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªåè¿›åˆ¶çš„æ•°å­—</span></span><br><span class="line">        <span class="comment">//BITFIELD sign:userId:yyyyMM GET day 0</span></span><br><span class="line">        List&lt;Long&gt; values = stringRedisTemplate.opsForValue()</span><br><span class="line">                .bitField(</span><br><span class="line">                        key,</span><br><span class="line">                        BitFieldSubCommands.create()</span><br><span class="line">                                .get(BitFieldSubCommands.BitFieldType.unsigned(day))</span><br><span class="line">                                .valueAt(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">if</span> (values == <span class="literal">null</span> || values.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è·å–bit</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">num</span> <span class="operator">=</span> values.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//ä»åå¾€å‰ï¼Œå¦‚æœä¸ºæœ€åä¸€ä½ä¸º0ï¼Œåˆ™é€€å‡ºå¾ªç¯</span></span><br><span class="line">        <span class="keyword">while</span> ((num &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//ä¸ä¸º0ï¼Œè¯´æ˜å·²ç­¾åˆ°</span></span><br><span class="line">            count++;</span><br><span class="line">            <span class="comment">//numæ— ç¬¦å·å³ç§»1ä½</span></span><br><span class="line">            num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div><div class="story post-story"><h2 id="10-UVç»Ÿè®¡"><a href="#10-UVç»Ÿè®¡" class="headerlink" title="10.UVç»Ÿè®¡"></a>10.UVç»Ÿè®¡</h2><h3 id="10-1-HyperLogLogçš„ç”¨æ³•"><a href="#10-1-HyperLogLogçš„ç”¨æ³•" class="headerlink" title="10.1 HyperLogLogçš„ç”¨æ³•"></a>10.1 HyperLogLogçš„ç”¨æ³•</h3><p><strong>UV</strong>ï¼šå…¨ç§°Unique Visitorï¼Œä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚1å¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡ã€‚</p>
<p><strong>PV</strong>ï¼šå…¨ç§°Page Viewï¼Œä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PV,ç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡ã€‚</p>
<p>UVç»Ÿè®¡åœ¨æœåŠ¡ç«¯åšä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºè¦åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»Ÿè®¡è¿‡äº†ï¼Œéœ€è¦å°†ç»Ÿè®¡è¿‡çš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜ã€‚ä½†æ˜¯å¦‚æœæ¯ä¸ªè®¿é—®çš„ç”¨æˆ·éƒ½ä¿å­˜åˆ°Redisä¸­ï¼Œæ•°æ®é‡ä¼šéå¸¸ææ€–ã€‚</p>
<p><strong>Hyperloglog</strong>(HLL)æ˜¯ä»Loglogç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨äºç¡®å®šéå¸¸å¤§çš„é›†åˆçš„åŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ã€‚</p>
<p>ç›¸å…³ç®—æ³•åŸç†å¤§å®¶å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903785744056333#heading-0">https://juejin.cn/post/6844903785744056333#heading-0</a></p>
<p>Redisä¸­çš„HLLæ˜¯åŸºäºstringç»“æ„å®ç°çš„ï¼Œå•ä¸ªHLLçš„å†…å­˜æ°¸è¿œå°äº16kbï¼Œå†…å­˜å ç”¨ä½çš„ä»¤äººå‘æŒ‡ï¼ä½œä¸ºä»£ä»·ï¼Œå…¶æµ‹é‡ç»“æœæ˜¯æ¦‚ç‡æ€§çš„ï¼Œæœ‰å°äº0.81%çš„è¯¯å·®ã€‚ä¸è¿‡å¯¹äºUVç»Ÿè®¡æ¥è¯´ï¼Œè¿™å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚</p>
<p>æ·»åŠ æ•°æ®ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfadd h1 e1 e2 e3</span><br></pre></td></tr></table></figure>

<p>ç»Ÿè®¡UVï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfcount h1</span><br></pre></td></tr></table></figure>



<h3 id="10-2-æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡"><a href="#10-2-æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡" class="headerlink" title="10.2 æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡"></a>10.2 æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡</h3><p>æˆ‘ä»¬ç›´æ¥åˆ©ç”¨å•å…ƒæµ‹è¯•ï¼Œå‘HyperLogLogä¸­æ·»åŠ 100ä¸‡æ¡æ•°æ®ï¼Œçœ‹çœ‹å†…å­˜å ç”¨å’Œç»Ÿè®¡æ•ˆæœå¦‚ä½•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testHyperLogLog</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//å‡†å²›æ•°ç»„ï¼Œè£…ç”¨æˆ·æ•°æ˜</span></span><br><span class="line">    String[] users = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">1000</span>];</span><br><span class="line">    <span class="comment">//æ•°ç»„è§’æ ‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">100000</span>; i++)&#123;</span><br><span class="line">        <span class="comment">//èµ‹å€¼</span></span><br><span class="line">        users[index++] = <span class="string">&quot;user_&quot;</span> + i;</span><br><span class="line">        <span class="comment">//æ¯1000æ¡å‘é€ä¸€æ¬¡</span></span><br><span class="line">        <span class="keyword">if</span>(i%<span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            index = <span class="number">0</span>;</span><br><span class="line">            stringRedisTemplate.opsForHyperLogLog().add(<span class="string">&quot;hll1&quot;</span>,users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç»Ÿè®¡æ•°é‡</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> stringRedisTemplate.opsForHyperLogLog().size(<span class="string">&quot;hll1&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;size = &quot;</span> + size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¾“å‡ºï¼šsize &#x3D; 99839</p>
</blockquote>

</div>
  </div>
  
  
    
    <div class='footer'>
       <!-- å‚è€ƒèµ„æ–™ã€ç›¸å…³èµ„æ–™ç­‰ -->
      
       <!-- ç›¸å…³æ–‡ç«  -->
      
      <!-- ç‰ˆæƒå£°æ˜ç»„ä»¶ -->
      
        
          
          <div class="copyright license">
            <div class="license-title">Redisçš„å­¦ä¹ ç¬”è®°</div>
            <div class="license-link"><a href="http://example.com/2022/08/06/Java/Redis/">http://example.com/2022/08/06/Java/Redis/</a>
            </div>
            <div class="license-meta">
              <div class="license-meta-item">
                <div class="license-meta-title">æœ¬æ–‡ä½œè€…</div>
                <div class="license-meta-text">ä¸€ä¸ªå°åƒåœ¾</div>
              </div>
              <div class="license-meta-item">
                <div class="license-meta-title">å‘å¸ƒäº</div>
                <div class="license-meta-text">2022å¹´8æœˆ6æ—¥</div>
              </div>
              
              <div class="license-meta-item">
                <div class="license-meta-title">æ›´æ–°äº</div>
                <div class="license-meta-text">2023å¹´2æœˆ6æ—¥</div>
              </div>
              
              
              <div class="license-meta-item">
                <div class="license-meta-title">è®¸å¯åè®®</div>
                <div class="license-meta-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh#" target="_blank">CC BY-NC-SA 4.0</a></div>
              </div>
            </div>
            <div class="license-statement">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…ã€‚</div>
          </div>
        
      
      <!-- æ‰“èµç»„ä»¶ -->
      
    </div>
  
  
    


  <div class='article-meta' id="bottom">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateModified" datetime="2023-02-06T21:48:39+08:00">
  <a class='notlink'>
    <i class="fa-solid fa-edit fa-fw" aria-hidden="true"></i>
    <p>æ›´æ–°äºï¼š2023å¹´2æœˆ6æ—¥</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Java/" rel="nofollow"><i class="fa-solid fa-hashtag fa-fw" aria-hidden="true"></i><p>Java</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="nofollow"><i class="fa-solid fa-hashtag fa-fw" aria-hidden="true"></i><p>æ•°æ®åº“</p></a></div>
  <span hidden itemprop="keywords">Java æ•°æ®åº“</span>


        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://example.com/2022/08/06/Java/Redis/&title=Redisçš„å­¦ä¹ ç¬”è®° - æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼&summary="
          
          >
          
            <img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qq.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qq.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://example.com/2022/08/06/Java/Redis/&title=Redisçš„å­¦ä¹ ç¬”è®° - æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼&summary="
          
          >
          
            <img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qzone.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qzone.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="http://service.weibo.com/share/share.php?url=http://example.com/2022/08/06/Java/Redis/&title=Redisçš„å­¦ä¹ ç¬”è®° - æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼&summary="
          
          >
          
            <img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/weibo.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/weibo.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
          
        </a>
      
    
      
    
      
    
  </div>
</div>



        
      
    </div>
    <!-- Custom Files bottomMeta begin -->
    
    <!-- Custom Files bottomMeta end -->
  </div>


  
  

  
    <div class="prev-next">
      
        <a class='prev' href='/2022/08/06/Java/SpringBoot%E6%A1%86%E6%9E%B6/'>
          <p class='title'><i class="fa-solid fa-chevron-left" aria-hidden="true"></i>SpringBootæ¡†æ¶çš„å­¦ä¹ ç¬”è®°</p>
          <p class='content'>1.çƒ­éƒ¨ç½²2.é…ç½®é«˜çº§2.1 è‡ªå®šä¹‰beanå±æ€§ç»‘å®šå¯¼å…¥lombokåæ ‡ï¼š
1234&lt;dependency&gt;    &lt;groupId&gt;org.projectlombok&...</p>
        </a>
      
      
        <a class='next' href='/2022/08/06/Java/MyBatis-Plus%E6%A1%86%E6%9E%B6/'>
          <p class='title'>2022å¹´8æœˆ6æ—¥<i class="fa-solid fa-chevron-right" aria-hidden="true"></i></p>
          <p class='content'>

1.åˆè¯†MyBatis-PlusMyBatis-Plusæ˜¯MyBatisçš„å¢å¼ºå·¥å…·ï¼Œåœ¨MyBatisçš„åŸºç¡€ä¸Šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œä¸ºäº†ç®€åŒ–å¼€å‘ï¼Œæé«˜æ•ˆç‡è€Œç”Ÿ
å®˜ç½‘ï¼šMyBatis-Plus
ç‰¹æ€§...</p>
        </a>
      
    </div>
  
  <!-- Custom Files postEnd begin-->
  
  <!-- Custom Files postEnd end-->
</article>


  

  





</div>
<aside id='l_side' itemscope itemtype="http://schema.org/WPSideBar">
  

  
    
    
      
    
  


<div class="widget-sticky pjax">

  
  


  <section class="widget toc-wrapper desktop mobile " id="toc-div" >
    
  <header>
    
      <i class="fa-solid fa-list fa-fw" aria-hidden="true"></i><span class='name'>æœ¬æ–‡ç›®å½•</span>
    
  </header>


    <div class='content'>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%88%9D%E8%AF%86Redis"><span class="toc-text">1.åˆè¯†Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E8%AE%A4%E8%AF%86NoSql"><span class="toc-text">1.1 è®¤è¯†NoSql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%AE%A4%E8%AF%86Redis"><span class="toc-text">1.2 è®¤è¯†Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Redis%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E5%85%B6%E9%85%8D%E7%BD%AE"><span class="toc-text">1.3 Redisçš„å®‰è£…åŠå…¶é…ç½®</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Redis%E5%91%BD%E4%BB%A4"><span class="toc-text">2.Rediså‘½ä»¤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="toc-text">2.1 Redisæ•°æ®ç»“æ„ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Redis%E9%80%9A%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-text">2.2 Redisé€šç”¨å‘½ä»¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-String%E7%B1%BB%E5%9E%8B"><span class="toc-text">2.3 Stringç±»å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Key%E7%9A%84%E5%B1%82%E7%BA%A7%E6%A0%BC%E5%BC%8F"><span class="toc-text">2.4 Keyçš„å±‚çº§æ ¼å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Hash%E7%B1%BB%E5%9E%8B"><span class="toc-text">2.5 Hashç±»å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-List%E7%B1%BB%E5%9E%8B"><span class="toc-text">2.6 Listç±»å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-Set%E7%B1%BB%E5%9E%8B"><span class="toc-text">2.7 Setç±»å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-SortedSet%E7%B1%BB%E5%9E%8B"><span class="toc-text">2.8 SortedSetç±»å‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Redis%E7%9A%84java%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">3.Redisçš„javaå®¢æˆ·ç«¯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Jedis%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">3.1 Jediså¿«é€Ÿå…¥é—¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Jedis%E7%9A%84%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-text">3.2 Jedisçš„è¿æ¥æ± </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%88%9D%E8%AF%86SpringDataRedis"><span class="toc-text">3.3 åˆè¯†SpringDataRedis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-SpringDataRedis%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">3.4 SpringDataRediså¿«é€Ÿå…¥é—¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-SpringDataRedis%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E6%96%B9%E5%BC%8F"><span class="toc-text">3.5 SpringDataRedisçš„åºåˆ—åŒ–æ–¹å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-StringRedisTemplate"><span class="toc-text">3.6 StringRedisTemplate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-RedisTemplate%E6%93%8D%E4%BD%9CHash%E7%B1%BB%E5%9E%8B"><span class="toc-text">3.7 RedisTemplateæ“ä½œHashç±»å‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95"><span class="toc-text">1.çŸ­ä¿¡ç™»å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%9F%BA%E4%BA%8ESession%E5%AE%9E%E7%8E%B0%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="toc-text">1.1 åŸºäºSessionå®ç°çŸ­ä¿¡ç™»å½•æµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%AE%9E%E7%8E%B0%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-text">1.2 å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%AE%9E%E7%8E%B0%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%99%BB%E5%BD%95%E4%B8%8E%E6%B3%A8%E5%86%8C"><span class="toc-text">1.3 å®ç°çŸ­ä¿¡éªŒè¯ç™»å½•ä¸æ³¨å†Œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-text">1.4 å®ç°ç™»å½•æ ¡éªŒæ‹¦æˆªå™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-Session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">1.5 Sessionå…±äº«é—®é¢˜åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-%E5%9F%BA%E4%BA%8ERedis%E5%AE%9E%E7%8E%B0%E5%85%B1%E4%BA%ABSession%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="toc-text">1.6 åŸºäºRediså®ç°å…±äº«Sessionç™»å½•æµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-%E5%9F%BA%E4%BA%8ERedis%E5%AE%9E%E7%8E%B0%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95"><span class="toc-text">1.7 åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•*</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8-%E8%A7%A3%E5%86%B3%E7%8A%B6%E6%80%81%E7%99%BB%E5%BD%95%E5%88%B7%E6%96%B0%E9%97%AE%E9%A2%98"><span class="toc-text">1.8 è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜*</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%95%86%E6%88%B7%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"><span class="toc-text">2.å•†æˆ·æŸ¥è¯¢ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98"><span class="toc-text">2.1 ä»€ä¹ˆæ˜¯ç¼“å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%B7%BB%E5%8A%A0Redis%E7%BC%93%E5%AD%98"><span class="toc-text">2.2 æ·»åŠ Redisç¼“å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-text">2.3 ç¼“å­˜æ›´æ–°ç­–ç•¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E6%B7%BB%E5%8A%A0%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-text">2.4 æ·»åŠ ç¼“å­˜æ›´æ–°ç­–ç•¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-text">2.5 ç¼“å­˜ç©¿é€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E7%BC%93%E5%AD%98%E7%A9%BA%E5%AF%B9%E8%B1%A1%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-text">2.6 ç¼“å­˜ç©ºå¯¹è±¡è§£å†³ç¼“å­˜ç©¿é€*</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-text">2.7 ç¼“å­˜é›ªå´©</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-text">2.8 ç¼“å­˜å‡»ç©¿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9%E5%9F%BA%E4%BA%8E%E4%BA%92%E6%96%A5%E9%94%81%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-text">2.9åŸºäºäº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿*</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-%E5%88%A9%E7%94%A8%E9%80%BB%E8%BE%91%E8%BF%87%E6%9C%9F%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-text">2.10 åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿*</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11-%E7%BC%93%E5%AD%98%E5%B7%A5%E5%85%B7%E5%B0%81%E8%A3%85"><span class="toc-text">2.11 ç¼“å­˜å·¥å…·å°è£…*</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80"><span class="toc-text">3.ä¼˜æƒ åˆ¸ç§’æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID"><span class="toc-text">3.1 å…¨å±€å”¯ä¸€ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Redis%E5%AE%9E%E7%8E%B0%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID"><span class="toc-text">3.2 Rediså®ç°å…¨å±€å”¯ä¸€ID*</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%B7%BB%E5%8A%A0%E4%BC%98%E6%83%A0%E5%88%B8"><span class="toc-text">3.3 æ·»åŠ ä¼˜æƒ åˆ¸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95"><span class="toc-text">3.4 å®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">3.5 åº“å­˜è¶…å–é—®é¢˜åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E4%B9%90%E8%A7%82%E9%94%81%E8%A7%A3%E5%86%B3%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98"><span class="toc-text">3.6 ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜*</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E5%8A%9F%E8%83%BD"><span class="toc-text">3.7 å®ç°ä¸€äººä¸€å•åŠŸèƒ½*</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E7%9A%84%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="toc-text">3.8 ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">4.åˆ†å¸ƒå¼é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-text">4.1 åˆ†å¸ƒå¼é”çš„åŸºæœ¬åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-text">4.2 Redisåˆ†å¸ƒå¼é”å®ç°æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%AE%9E%E7%8E%B0Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">4.3 å®ç°Redisåˆ†å¸ƒå¼é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%AF%AF%E5%88%A0%E9%97%AE%E9%A2%98"><span class="toc-text">4.4 Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text">4.5 åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-lua%E8%84%9A%E6%9C%AC%E8%A7%A3%E5%86%B3%E5%A4%9A%E6%9D%A1%E5%91%BD%E4%BB%A4%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text">4.6 luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-java%E8%B0%83%E7%94%A8lua%E8%84%9A%E6%9C%AC%E6%94%B9%E8%BF%9B%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">4.7 javaè°ƒç”¨luaè„šæœ¬æ”¹è¿›åˆ†å¸ƒå¼é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-Redisson%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-text">4.8 RedissonåŠŸèƒ½ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-9-Redisson%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">4.9 Redissonå¿«é€Ÿå…¥é—¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-10-Redisson%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-text">4.10 Redissonå¯é‡å…¥é”åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-11-Redisson%E9%94%81%E9%87%8D%E8%AF%95%E5%92%8CWatchDog%E6%9C%BA%E5%88%B6%EF%BC%9F%EF%BC%9F%EF%BC%9F%EF%BC%9F%EF%BC%9F%EF%BC%9F"><span class="toc-text">4.11 Redissoné”é‡è¯•å’ŒWatchDogæœºåˆ¶ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-12-Redisson%E7%9A%84MultiLock%E5%8E%9F%E7%90%86"><span class="toc-text">4.12 Redissonçš„MultiLockåŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-13-%E6%80%BB%E7%BB%93"><span class="toc-text">4.13 æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Redis%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96"><span class="toc-text">5.Redisç§’æ€ä¼˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Redis%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E6%80%9D%E8%B7%AF"><span class="toc-text">5.1 Rediså¼‚æ­¥ç§’æ€æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%9F%BA%E4%BA%8ERedis%E5%AE%8C%E6%88%90%E7%A7%92%E6%9D%80%E8%B5%84%E6%A0%BC%E5%88%A4%E6%96%AD"><span class="toc-text">5.2 åŸºäºRediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E5%9F%BA%E4%BA%8E%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E7%A7%92%E6%9D%80%E5%BC%82%E6%AD%A5%E4%B8%8B%E5%8D%95"><span class="toc-text">5.3 åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€å¼‚æ­¥ä¸‹å•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">6.Redisæ¶ˆæ¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">6.1 æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%9F%BA%E4%BA%8EList%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">6.2 åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-PubSub%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">6.3 PubSubå®ç°æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-Stream%E7%9A%84%E5%8D%95%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F"><span class="toc-text">6.4 Streamçš„å•æ¶ˆè´¹æ¨¡å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-Stream%E7%9A%84%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E6%A8%A1%E5%BC%8F"><span class="toc-text">6.5 Streamçš„æ¶ˆè´¹è€…ç»„æ¨¡å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E5%9F%BA%E4%BA%8EStream%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80"><span class="toc-text">6.6 åŸºäºStreamæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97"><span class="toc-text">6.è¾¾äººæ¢åº—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%8F%91%E5%B8%83%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0"><span class="toc-text">6.1 å‘å¸ƒæ¢åº—ç¬”è®°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E6%9F%A5%E7%9C%8B%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0"><span class="toc-text">6.2 æŸ¥çœ‹æ¢åº—ç¬”è®°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD"><span class="toc-text">6.3 ç‚¹èµåŠŸèƒ½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C"><span class="toc-text">6.4 ç‚¹èµæ’è¡Œæ¦œ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8"><span class="toc-text">7.å¥½å‹å…³æ³¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E5%85%B3%E6%B3%A8%E5%92%8C%E5%8F%96%E5%85%B3"><span class="toc-text">7.1 å…³æ³¨å’Œå–å…³</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8"><span class="toc-text">7.2 å…±åŒå…³æ³¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E5%85%B3%E6%B3%A8%E6%8E%A8%E9%80%81Feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90"><span class="toc-text">7.3 å…³æ³¨æ¨é€Feedæµå®ç°åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E6%8E%A8%E9%80%81%E5%88%B0%E7%B2%89%E4%B8%9D%E6%94%B6%E4%BB%B6%E7%AE%B1"><span class="toc-text">7.4 æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-%E6%BB%9A%E5%8A%A8%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%94%B6%E4%BB%B6%E7%AE%B1%E6%80%9D%E8%B7%AF"><span class="toc-text">7.5 æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-%E5%AE%9E%E7%8E%B0%E6%BB%9A%E5%8A%A8%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-text">7.6 å®ç°æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%99%84%E8%BF%91%E7%9A%84%E5%95%86%E6%88%B7"><span class="toc-text">8.é™„è¿‘çš„å•†æˆ·</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-GEO%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">8.1 GEOæ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%AF%BC%E5%85%A5%E5%BA%97%E9%93%BA%E6%95%B0%E6%8D%AE%E5%88%B0GEO"><span class="toc-text">8.2 å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E5%AE%9E%E7%8E%B0%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7%E5%8A%9F%E8%83%BD"><span class="toc-text">8.3 å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0"><span class="toc-text">9.ç”¨æˆ·ç­¾åˆ°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-BitMap%E5%8A%9F%E8%83%BD"><span class="toc-text">9.1 BitMapåŠŸèƒ½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%AE%9E%E7%8E%B0%E7%AD%BE%E5%88%B0%E5%8A%9F%E8%83%BD"><span class="toc-text">9.2 å®ç°ç­¾åˆ°åŠŸèƒ½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-%E7%BB%9F%E8%AE%A1%E8%BF%9E%E7%BB%AD%E7%AD%BE%E5%88%B0"><span class="toc-text">9.3 ç»Ÿè®¡è¿ç»­ç­¾åˆ°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-UV%E7%BB%9F%E8%AE%A1"><span class="toc-text">10.UVç»Ÿè®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-HyperLogLog%E7%9A%84%E7%94%A8%E6%B3%95"><span class="toc-text">10.1 HyperLogLogçš„ç”¨æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-%E6%B5%8B%E8%AF%95%E7%99%BE%E4%B8%87%E6%95%B0%E6%8D%AE%E7%9A%84%E7%BB%9F%E8%AE%A1"><span class="toc-text">10.2 æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡</span></a></li></ol></li></ol>
    </div>
  </section>

  

</div>


<!-- æ²¡æœ‰ pjax å ä½ä¼šæŠ¥é”™ ä¸‡æ¶çš„ pjax -->

  <div class="pjax">
    <!-- pjaxå ä½ -->
  </div>

  <div class="pjax">
    <!-- pjaxå ä½ -->
  </div>

  <div class="pjax">
    <!-- pjaxå ä½ -->
  </div>

  <div class="pjax">
    <!-- pjaxå ä½ -->
  </div>

  <div class="pjax">
    <!-- pjaxå ä½ -->
  </div>

  <div class="pjax">
    <!-- pjaxå ä½ -->
  </div>

  <div class="pjax">
    <!-- pjaxå ä½ -->
  </div>

  <div class="pjax">
    <!-- pjaxå ä½ -->
  </div>

  <!-- Custom Files side begin -->
  
  <!-- Custom Files side end -->
</aside>



          <!--æ­¤æ–‡ä»¶ç”¨æ¥å­˜æ”¾ä¸€äº›ä¸æ–¹ä¾¿å–å€¼çš„å˜é‡-->
<!--æ€è·¯å¤§æ¦‚æ˜¯å°†å€¼è—åˆ°é‡åŠ è½½çš„åŒºåŸŸå†…-->

<pjax>
<script>
  window.pdata={}
  pdata.ispage=true;
  pdata.commentPath="";
  pdata.commentPlaceholder="";
  pdata.commentConfig={};
  //  see: /layout/_partial/scripts/_ctrl/coverCtrl.ejs
  
    // header
    var l_header=document.getElementById("l_header");
    
    l_header.classList.add("show");
    
    
      // cover
      var cover_wrapper=document.querySelector('#l_cover .cover-wrapper');
      var scroll_down=document.getElementById('scroll-down');
      cover_wrapper.id="none";
      cover_wrapper.style.display="none";
      scroll_down.style.display="none";
    
  
</script>
</pjax>
        </div>
        
  
  <footer class="footer clearfix"  itemscope itemtype="http://schema.org/WPFooter">
    <br><br>
    
      
        <div class="aplayer-container">
          


        </div>
      
    
      
        <br>
        <div class="social-wrapper" itemprop="about" itemscope itemtype="http://schema.org/Thing">
          
            
          
            
          
            
          
        </div>
      
    
      
        <div><p>åšå®¢å†…å®¹éµå¾ª <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™… (CC BY-NC-SA 4.0) åè®®</a></p>
</div>
      
    
      
        
      
    
      
        æœ¬ç«™ä½¿ç”¨
        <a href="https://github.com/volantis-x/hexo-theme-volantis/tree/5.5.0" target="_blank" class="codename">Volantis</a>
        ä½œä¸ºä¸»é¢˜
      
    
      
        <div class='copyright'>
        <p><a href="/">Copyright Â© since 2022 ä¸€ä¸ªå°åƒåœ¾</a></p>

        </div>
      
    
    <!-- Custom Files footer begin-->
    
    <!-- Custom Files footer end-->
  </footer>



  <script src='https://unpkg.com/mermaid@8.13.8/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


        <a id="s-top" class="fa-solid fa-arrow-up fa-fw" href="/" onclick="return false;" title="top"></a>
      </div>
    </div>
    <div>
      <script>
  /******************** volantis.dom ********************************/
  // é¡µé¢é€‰æ‹©å™¨ å°†domå¯¹è±¡ç¼“å­˜èµ·æ¥ see: /source/js/app.js etc.
  volantis.dom.bodyAnchor = volantis.dom.$(document.getElementById("safearea")); // é¡µé¢ä¸»ä½“
  volantis.dom.topBtn = volantis.dom.$(document.getElementById('s-top')); // å‘ä¸Š
  volantis.dom.wrapper = volantis.dom.$(document.getElementById('wrapper')); // æ•´ä¸ªå¯¼èˆªæ 
  volantis.dom.coverAnchor = volantis.dom.$(document.querySelector('#l_cover .cover-wrapper')); // 1ä¸ª
  volantis.dom.switcher = volantis.dom.$(document.querySelector('#l_header .switcher .s-search')); // æœç´¢æŒ‰é’®   ç§»åŠ¨ç«¯ 1ä¸ª
  volantis.dom.header = volantis.dom.$(document.getElementById('l_header')); // ç§»åŠ¨ç«¯å¯¼èˆªæ 
  volantis.dom.search = volantis.dom.$(document.querySelector('#l_header .m_search')); // æœç´¢æ¡† æ¡Œé¢ç«¯ ç§»åŠ¨ç«¯ 1ä¸ª
  volantis.dom.mPhoneList = volantis.dom.$(document.querySelectorAll('#l_header .m-phone .list-v')); //  æ‰‹æœºç«¯ å­èœå• å¤šä¸ª
</script>

<script>
  
  volantis.css("https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fortawesome/fontawesome-free/css/all.min.css");
  
  
  
</script>

<!-- required -->


<!-- internal -->

<script src="/js/app.af2d54c8.js"></script>





  













<div id="rightmenu-wrapper">
  <ul class="list-v rightmenu" id="rightmenu-content">
    
  <li class='navigation menuNavigation-Content'>


    <a class="nav icon-only fix-cursor-default" onclick="history.back()"><i class="fa-solid fa-arrow-left fa-fw"></i></a>



    <a class="nav icon-only fix-cursor-default" onclick="history.forward()"><i class="fa-solid fa-arrow-right fa-fw"></i></a>



    <a class="nav icon-only fix-cursor-default" onclick="window.location.reload()"><i class="fa-solid fa-redo fa-fw"></i></a>



    <a class="nav icon-only fix-cursor-default" onclick="VolantisApp.scrolltoElement(volantis.dom.bodyAnchor)"><i class="fa-solid fa-arrow-up fa-fw"></i></a>


  </li>


    <hr class="menuLoad-Content" >



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="copyPaste" data-event="copyPaste" data-group="inputBox">
      <i class="fa-solid fa-paste fa-fw"></i>
      ç²˜è´´æ–‡æœ¬
    </span>
  </li>



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="copyAll" data-event="copyAll" data-group="inputBox">
      <i class="fa-solid fa-object-ungroup fa-fw"></i>
      å…¨é€‰æ–‡æœ¬
    </span>
  </li>



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="copyCut" data-event="copyCut" data-group="inputBox">
      <i class="fa-solid fa-cut fa-fw"></i>
      å‰ªåˆ‡æ–‡æœ¬
    </span>
  </li>



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="copyText" data-event="copyText" data-group="seletctText">
      <i class="fa-solid fa-copy fa-fw"></i>
      å¤åˆ¶æ–‡æœ¬
    </span>
  </li>



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="searchWord" data-event="OpenSearch(__text__)" data-group="seletctText">
      <i class="fa-solid fa-search fa-fw"></i>
      ç«™å†…æœç´¢
    </span>
  </li>



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="bingSearch" data-event="window.open(`https://cn.bing.com/search?q=${__text__}`)" data-group="seletctText">
      <i class="fa-solid fa-search fa-fw"></i>
      å¿…åº”æœç´¢
    </span>
  </li>



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="openTab" data-event="window.open(__link__)" data-group="elementCheck">
      <i class="fa-solid fa-external-link-square-alt fa-fw"></i>
      æ–°æ ‡ç­¾é¡µæ‰“å¼€
    </span>
  </li>



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="copyLink" data-event="copyLink" data-group="elementCheck">
      <i class="fa-solid fa-link fa-fw"></i>
      å¤åˆ¶é“¾æ¥åœ°å€
    </span>
  </li>



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="copyImg" data-event="copyImg" data-group="elementImage">
      <i class="fa-solid fa-image fa-fw"></i>
      å¤åˆ¶å›¾ç‰‡
    </span>
  </li>



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="googleImg" data-event="window.open(`https://www.google.com.hk/searchbyimage?image_url=${__link__}`)" data-group="elementImage">
      <i class="fa-solid fa-images fa-fw"></i>
      è°·æ­Œè¯†å›¾
    </span>
  </li>



    <hr class="menuLoad-Content" >



  <li class="menuLoad-Content">
    <a class="vlts-menu fix-cursor-default" id="source_docs" target="_blank" rel="noopener" href="https://github.com/volantis-x/volantis-docs/" data-group="link">
      <i class="fa-solid fa-code-branch fa-fw"></i>
      æœ¬ç«™æºç 
    </a>
  </li>



  <li class="menuLoad-Content">
    <a class="vlts-menu fix-cursor-default" id="source_theme" target="_blank" rel="noopener" href="https://github.com/volantis-x/hexo-theme-volantis/" data-group="link">
      <i class="fa-solid fa-code-branch fa-fw"></i>
      ä¸»é¢˜æºç 
    </a>
  </li>



    <hr class="menuLoad-Content" >



    <hr class="menuLoad-Content" >



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="printMode" data-event="printMode" data-group="articlePage">
      <i class="fa-solid fa-print fa-fw"></i>
      æ‰“å°é¡µé¢
    </span>
  </li>



  <li class="menuLoad-Content">
    <span class="vlts-menu fix-cursor-default event" id="readMode" data-event="readMode" data-group="articlePage">
      <i class="fa-solid fa-book-open fa-fw"></i>
      é˜…è¯»æ¨¡å¼
    </span>
  </li>


<div id="menuMusic">
  <li class='music name menuOption-Content'>
    <p class='nav music-title fix-cursor-default'></p>
  </li>
  <li class='music ctrl'>
    <a class='nav icon-only backward fix-cursor-default' href="/" onclick="return false;" title="backward">
      <i class='fa-solid fa-step-backward fa-fw'></i>
    </a>
    <a class='nav icon-only toggle fix-cursor-default' href="/" onclick="return false;" title="toggle">
      <i class='fa-solid fa-play fa-fw'></i>
    </a>
    <a class='nav icon-only forward fix-cursor-default' href="/" onclick="return false;" title="forward">
      <i class='fa-solid fa-step-forward fa-fw'></i>
    </a>
  </li>
  <li class='music volume'>
    <div class='nav volume'>
      <div class="aplayer-volume-bar-wrap">
        <div class="aplayer-volume-bar fix-cursor-pointer">
          <div class="aplayer-volume"></div>
          <i class='left fa-solid fa-volume-off fa-fw'></i>
          <i class='right fa-solid fa-volume-up fa-fw'></i>
        </div>
      </div>
    </div>
  </li>
</div>

  </ul>
</div>
<script src="/js/plugins/rightMenus.4d580c89.js"></script>
<script>
  const RightMenusFunction = {};
  












  <!-- RightMenusFunction['copyPaste'] = (fun) => {fun()} -->





  <!-- RightMenusFunction['copyAll'] = (fun) => {fun()} -->





  <!-- RightMenusFunction['copyCut'] = (fun) => {fun()} -->





  <!-- RightMenusFunction['copyText'] = (fun) => {fun()} -->





  RightMenusFunction['searchWord'] = (__text__) => {OpenSearch(__text__)}





  RightMenusFunction['bingSearch'] = (__text__) => {window.open(`https://cn.bing.com/search?q=${__text__}`)}





  RightMenusFunction['openTab'] = (__link__) => {window.open(__link__)}





  <!-- RightMenusFunction['copyLink'] = (fun) => {fun()} -->





  <!-- RightMenusFunction['copyImg'] = (fun) => {fun()} -->





  RightMenusFunction['googleImg'] = (__link__) => {window.open(`https://www.google.com.hk/searchbyimage?image_url=${__link__}`)}















  <!-- RightMenusFunction['printMode'] = (fun) => {fun()} -->





  <!-- RightMenusFunction['readMode'] = (fun) => {fun()} -->





</script>



<!-- rightmenuè¦åœ¨darkmodeä¹‹å‰ï¼ˆToggleButtonï¼‰ darkmodeè¦åœ¨commentsä¹‹å‰ï¼ˆvolantis.dark.pushï¼‰-->



<script>
  function loadIssuesJS() {
    
      const sites_api = document.getElementById('sites-api');
      if (sites_api != undefined && typeof SitesJS === 'undefined') {
        volantis.js("/js/plugins/tags/sites.76bf19b8.js")
      }
    
    
      const friends_api = document.getElementById('friends-api');
      if (friends_api != undefined && typeof FriendsJS === 'undefined') {
        volantis.js("/js/plugins/tags/friends.f372da57.js")
      }
    
    
      const contributors_api = document.getElementById('contributors-api');
      if (contributors_api != undefined && typeof ContributorsJS === 'undefined') {
        volantis.js("/js/plugins/tags/contributors.aec80453.js")
      }
    
  };
  loadIssuesJS()
  volantis.pjax.push(()=>{
    loadIssuesJS();
  })

</script>




  <script defer src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/vanilla-lazyload/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>




  

<script>
  window.FPConfig = {
	delay: 0,
	ignoreKeywords: ["#"],
	maxRPS: 6,
	hoverDelay: 0
  };
</script>
<script defer src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/flying-pages/flying-pages.min.js"></script>





   <script type="text/javascript">
  function pjax_scrollrebeal() {
    ScrollReveal().reveal("#l_main .reveal", {
      distance: "32px",
      duration: "800",
      interval: "20",
      scale: "1",
      easing: "ease-out",
    });
  }
  function init_scrollrebeal() {
    if (typeof ScrollReveal == "undefined") {
      volantis.requestAnimationFrame(init_scrollrebeal);
    } else {
      pjax_scrollrebeal();
    }
  }
  volantis.js("https://unpkg.com/volantis-static@0.0.1654736714924/libs/scrollreveal/dist/scrollreveal.min.js");
  document.addEventListener("DOMContentLoaded", init_scrollrebeal);
  volantis.pjax.push(
    pjax_scrollrebeal,
    "pjax_scrollrebeal",
    (setRequestAnimationFrame = false)
  );
</script>











<!-- optional -->

  <script>
  const SearchServiceDataPathRoot = ("/" || "/").endsWith("/") ?
    "/" || "/" :
    "//" || "/";
  const SearchServiceDataPath = SearchServiceDataPathRoot + "content.json";

  function loadSearchScript() {
    // see: layout/_partial/scripts/_ctrl/cdnCtrl.ejs
    return volantis.js("/js/search/hexo.0e52f222.js");
  }

  function loadSearchService() {
    loadSearchScript();
    document.querySelectorAll(".input.u-search-input").forEach((e) => {
      e.removeEventListener("focus", loadSearchService, false);
    });

    document.querySelectorAll(".u-search-form").forEach((e) => {
      e.addEventListener("submit", (event) => {
        event.preventDefault();
      }, false);
    });
  }

  // æ‰“å¼€å¹¶æœç´¢ å­—ç¬¦ä¸² s
  function OpenSearch(s) {
    if (typeof SearchService === 'undefined')
      loadSearchScript().then(() => {
        SearchService.setQueryText(s);
        SearchService.search();
      });
    else {
      SearchService.setQueryText(s);
      SearchService.search();
    }
  }

  // è®¿é—®å«æœ‰ ?s=xxx  çš„é“¾æ¥æ—¶æ‰“å¼€æœç´¢ // ä¸æœç´¢å¼•æ“ structured data ç›¸å…³: /scripts/helpers/structured-data/lib/config.js
  if (window.location.search && /^\?s=/g.test(window.location.search)) {
    let queryText = decodeURI(window.location.search)
      .replace(/\ /g, "-")
      .replace(/^\?s=/g, "");
    OpenSearch(queryText);
  }

  // æœç´¢è¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶åŠ è½½æœç´¢
  document.querySelectorAll(".input.u-search-input").forEach((e) => {
    e.addEventListener("focus", loadSearchService, false);
  });
</script>







  <script>



  function pjax_highlightjs_copyCode(){
    if (!(document.querySelector(".highlight .code pre") ||
      document.querySelector(".article pre code"))) {
      return;
    }
    VolantisApp.utilCopyCode(".highlight .code pre, .article pre code")
  }
  volantis.requestAnimationFrame(pjax_highlightjs_copyCode)
  volantis.pjax.push(pjax_highlightjs_copyCode)

</script>












  <script>
  function load_swiper() {
    if (!document.querySelectorAll(".swiper-container")[0]) return;
    volantis.css("https://unpkg.com/volantis-static@0.0.1654736714924/libs/swiper/swiper-bundle.min.css");
    volantis.js("https://unpkg.com/volantis-static@0.0.1654736714924/libs/swiper/swiper-bundle.min.js").then(() => {
      pjax_swiper();
    });
  }

  load_swiper();

  function pjax_swiper() {
    volantis.swiper = new Swiper('.swiper-container', {
      slidesPerView: 'auto',
      spaceBetween: 8,
      centeredSlides: true,
      loop: true,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
    });
  }

  volantis.pjax.push(() => {
    if (!document.querySelectorAll(".swiper-container")[0]) return;
    if (typeof volantis.swiper === "undefined") {
      load_swiper();
    } else {
      pjax_swiper();
    }
  });
</script>


<!-- pjax æ ‡ç­¾å¿…é¡»å­˜åœ¨äºæ‰€æœ‰é¡µé¢ å¦åˆ™ pjax error -->
<pjax>

</pjax>

<script>
  function listennSidebarTOC() {
    const navItems = document.querySelectorAll(".toc li");
    if (!navItems.length) return;
    let targets = []
    const sections = [...navItems].map((element) => {
      const link = element.querySelector(".toc-link");
      const target = document.getElementById(
        decodeURI(link.getAttribute("href")).replace("#", "")
      );
      targets.push(target)
      // è§£é™¤ a æ ‡ç­¾ href çš„ é”šç‚¹å®šä½, a æ ‡ç­¾ href çš„ é”šç‚¹å®šä½ ä¼šéšæœºå¯ç”¨?? äº§ç”Ÿé”™ä½???
      link.setAttribute("onclick","return false;")
      link.setAttribute("toc-action","toc-"+decodeURI(link.getAttribute("href")).replace("#", ""))
      link.setAttribute("href","/")
      // é…ç½® ç‚¹å‡» è§¦å‘æ–°çš„é”šç‚¹å®šä½
      link.addEventListener("click", (event) => {
        event.preventDefault();
        // è¿™é‡Œçš„ addTop æ˜¯é€šè¿‡é”™ä½ä½¿å¾— toc è‡ªåŠ¨å±•å¼€.
        volantis.scroll.to(target,{addTop: 5, observer:true})
        // Anchor id
        history.pushState(null, document.title, "#" + target.id);
      });
      return target;
    });

    function activateNavByIndex(target) {
      if (target.classList.contains("active-current")) return;

      document.querySelectorAll(".toc .active").forEach((element) => {
        element.classList.remove("active", "active-current");
      });
      target.classList.add("active", "active-current");
      let parent = target.parentNode;
      while (!parent.matches(".toc")) {
        if (parent.matches("li")) parent.classList.add("active");
        parent = parent.parentNode;
      }
    }

    // æ–¹æ¡ˆä¸€ï¼š
    volantis.activateNavIndex=0
    activateNavByIndex(navItems[volantis.activateNavIndex])
    volantis.scroll.push(()=>{
      if (targets[0].getBoundingClientRect().top >= 0) {
        volantis.activateNavIndex = 0
      }else if (targets[targets.length-1].getBoundingClientRect().top < 0) {
        volantis.activateNavIndex = targets.length-1
      } else {
        for (let index = 0; index < targets.length; index++) {
          const target0 = targets[index];
          const target1 = targets[(index+1)%targets.length];
          if (target0.getBoundingClientRect().top < 0&&target1.getBoundingClientRect().top >= 0) {
            volantis.activateNavIndex=index
            break;
          }
        }
      }
      activateNavByIndex(navItems[volantis.activateNavIndex])
    })

    // æ–¹æ¡ˆäºŒï¼š
    // IntersectionObserver ä¸æ˜¯å®Œç¾ç²¾ç¡®åˆ°åƒç´ çº§åˆ« ä¹Ÿä¸æ˜¯ä½å»¶æ—¶æ€§çš„
    // function findIndex(entries) {
    //   let index = 0;
    //   let entry = entries[index];
    //   if (entry.boundingClientRect.top > 0) {
    //     index = sections.indexOf(entry.target);
    //     return index === 0 ? 0 : index - 1;
    //   }
    //   for (; index < entries.length; index++) {
    //     if (entries[index].boundingClientRect.top <= 0) {
    //       entry = entries[index];
    //     } else {
    //       return sections.indexOf(entry.target);
    //     }
    //   }
    //   return sections.indexOf(entry.target);
    // }
    // function createIntersectionObserver(marginTop) {
    //   marginTop = Math.floor(marginTop + 10000);
    //   let intersectionObserver = new IntersectionObserver(
    //     (entries, observe) => {
    //       let scrollHeight = document.documentElement.scrollHeight;
    //       if (scrollHeight > marginTop) {
    //         observe.disconnect();
    //         createIntersectionObserver(scrollHeight);
    //         return;
    //       }
    //       let index = findIndex(entries);
    //       activateNavByIndex(navItems[index]);
    //     }, {
    //       rootMargin: marginTop + "px 0px -100% 0px",
    //       threshold: 0,
    //     }
    //   );
    //   sections.forEach((element) => {
    //     element && intersectionObserver.observe(element);
    //   });
    // }
    // createIntersectionObserver(document.documentElement.scrollHeight);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    volantis.requestAnimationFrame(listennSidebarTOC)
  });
  document.addEventListener("pjax:success", ()=>{
    volantis.requestAnimationFrame(listennSidebarTOC)
  });
</script>

<script>
  try {
    // https://web.dev/content-visibility/
    // https://www.caniuse.com/?search=content-visibility
    // https://infrequently.org/2020/12/content-visibility-scroll-fix/
    // https://infrequently.org/2020/12/resize-resilient-deferred-rendering/

    // å¤‡æ³¨ ç›®å‰å·²çŸ¥çš„é—®é¢˜:
    // åŠ¨æ€ä¿®æ”¹å¯¼è‡´çš„å†…å®¹é«˜åº¦å˜åŒ–(ä¾‹å¦‚è¯„è®ºæ¡†å¼‚æ­¥æ¸²æŸ“çš„å¤–éƒ¨ç›’å­é«˜åº¦å˜åŒ–) æ— æ³•æå‰è·çŸ¥, è¿›è€Œå¯¼è‡´çš„é¦–æ¬¡æ»šåŠ¨æ¡è·³åŠ¨æ— æ³•å»é™¤ (wontfix) äº‹å®ä¸Šä¸ä½¿ç”¨ content-visibility ä¹Ÿä¼šæœ‰è·³åŠ¨, ä¸è¿‡æ˜¯æ¯”ä½¿ç”¨ content-visibility è·³åŠ¨æå‰
    // scrollreveal æ’ä»¶æ½œåœ¨é—®é¢˜ ç›®å‰å°šä¸æ˜ç¡®

    let eqIsh = (a, b, fuzz = 2) => {
      return Math.abs(a - b) <= fuzz;
    };

    let rectNotEQ = (a, b) => {
      return !eqIsh(a.width, b.width) || !eqIsh(a.height, b.height);
    };

    // Keep a map of elements and the dimensions of
    // their place-holders, re-setting the element's
    // intrinsic size when we get updated measurements
    // from observers.
    let spaced = new WeakMap();

    // Only call this when known cheap, post layout
    let reserveSpace = (el, rect = el.getClientBoundingRect()) => {
      let old = spaced.get(el);
      // Set intrinsic size to prevent jumping on un-painting:
      //    https://drafts.csswg.org/css-sizing-4/#intrinsic-size-override
      if (!old || rectNotEQ(old, rect)) {
        spaced.set(el, rect);
        el.style["contain-intrinsic-size"] = `${rect.width}px ${rect.height}px`;
      }
    };

    let iObs = new IntersectionObserver(
      (entries, o) => {
        entries.forEach((entry) => {
          // We don't care if the element is intersecting or
          // has been laid out as our page structure ensures
          // they'll get the right width.
          reserveSpace(entry.target, entry.boundingClientRect);
        });
      },
      { rootMargin: "500px 0px 500px 0px" }
    );

    let rObs = new ResizeObserver((entries, o) => {
      entries.forEach((entry) => {
        reserveSpace(entry.target, entry.contentRect);
      });
    });

    let resizeResilientDeferredRendering = (Selector) => {
      let articles = document.querySelectorAll(Selector);

      if (articles.length) {
        articles.forEach((el) => {
          iObs.observe(el);
          rObs.observe(el);
        });

        // Workaround for Chrome bug, part 2.
        //
        // Re-enable browser management of rendering for the
        // first article after the first paint. Double-rAF
        // to ensure we get called after a layout.
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            articles[0].style["content-visibility"] = "auto";
          });
        });
      }
    };

    let contentVisibilityScrollFix = () => {
      if (!("content-visibility" in document.documentElement.style)) {
        return;
      }
      resizeResilientDeferredRendering(".post-story");
    };
    contentVisibilityScrollFix();
    volantis.pjax.push(contentVisibilityScrollFix);
  } catch (error) {
    console.log(error);
  }
</script>


<script>
  document.onreadystatechange = function () {
    if (document.readyState == 'complete') {
      // é¡µé¢åŠ è½½å®Œæ¯• æ ·å¼åŠ è½½å¤±è´¥ï¼Œæˆ–æ˜¯å½“å‰ç½‘é€Ÿæ…¢ï¼Œæˆ–æ˜¯å¼€å¯äº†çœæµæ¨¡å¼
      const { saveData, effectiveType } = navigator.connection || navigator.mozConnection || navigator.webkitConnection || {}
      if (getComputedStyle(document.querySelector("#safearea"), null)["display"] == "none" || saveData || /2g/.test(effectiveType)) {
        document.querySelectorAll(".reveal").forEach(function (e) {
          e.style["opacity"] = "1";
        });
        document.querySelector("#safearea").style["display"] = "block";
      }
    }
  }
</script>


  <script type="application/ld+json">[{"@context":"http://schema.org","@type":"Organization","name":"æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼","url":"http://example.com/","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},{"@context":"http://schema.org","@type":"Person","name":"ä¸€ä¸ªå°åƒåœ¾","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"http://example.com/","sameAs":["https://github.com/volantis-x"],"description":"ä¸€ä¸ªä¸èµ·çœ¼çš„å°åšå®¢"},{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"http://example.com/","name":"æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼"}},{"@type":"ListItem","position":2,"item":{"@id":"http://example.com/categories/Java/","name":"Java"}},{"@type":"ListItem","position":3,"item":{"@id":"http://example.com/2022/08/06/Java/Redis/","name":"Redisçš„å­¦ä¹ ç¬”è®°"}}]},{"@context":"http://schema.org","@type":"WebSite","name":"æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼","url":"http://example.com/","keywords":null,"description":"ä¸€ä¸ªä¸èµ·çœ¼çš„å°åšå®¢","author":{"@type":"Person","name":"ä¸€ä¸ªå°åƒåœ¾","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"http://example.com/","description":"ä¸€ä¸ªä¸èµ·çœ¼çš„å°åšå®¢"},"publisher":{"@type":"Organization","name":"æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼","url":"http://example.com/","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},"potentialAction":{"@type":"SearchAction","name":"Site Search","target":{"@type":"EntryPoint","urlTemplate":"http://example.com?s={search_term_string}"},"query-input":"required name=search_term_string"}},{"@context":"http://schema.org","@type":"BlogPosting","headline":"Redisçš„å­¦ä¹ ç¬”è®°","description":"ä¸€ä¸ªä¸èµ·çœ¼çš„å°åšå®¢","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2022/08/06/Java/Redis/"},"author":{"@type":"Person","name":"ä¸€ä¸ªå°åƒåœ¾","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"http://example.com/"},"publisher":{"@type":"Organization","name":"æ´»ç€å°±æ˜¯ä¸ºäº†æ‘¸é±¼ğŸŸï¼ï¼ï¼","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},"url":"http://example.com/2022/08/06/Java/Redis/","wordCount":0,"datePublished":"2022-08-06T11:11:16.304Z","dateModified":"2023-02-06T13:48:39.866Z","articleSection":"Java","keywords":"Java,æ•°æ®åº“","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}}]</script>



      
        <!--
  pjaxé‡è½½åŒºåŸŸæ¥å£ï¼š
  1.  <pjax></pjax> æ ‡ç­¾ pjax æ ‡ç­¾å¿…é¡»å­˜åœ¨äºæ‰€æœ‰é¡µé¢ å¦åˆ™ pjax error
  2.  script[data-pjax]
  3.  .pjax-reload script
  4.  .pjax
-->



<script src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/pjax/pjax.min.js"></script>


<script>
    var pjax;
    document.addEventListener('DOMContentLoaded', function () {
      pjax = new Pjax({
        elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([pjax-fancybox]):not([onclick="return false;"]):not([onclick="return!1"]):not([target="_blank"]):not([target="view_window"]):not([href$=".xml"])',
        selectors: [
          "head title",
          "head meta[name=keywords]",
          "head meta[name=description]",
          
          "#l_main",
          "#pjax-header-nav-list",
          ".pjax",
          "pjax", // <pjax></pjax> æ ‡ç­¾
          "script[data-pjax], .pjax-reload script" // scriptæ ‡ç­¾æ·»åŠ data-pjax æˆ– scriptæ ‡ç­¾å¤–å±‚æ·»åŠ .pjax-reload çš„scriptä»£ç æ®µé‡è½½
        ],
        cacheBust: false,   // url åœ°å€è¿½åŠ æ—¶é—´æˆ³ï¼Œç”¨ä»¥é¿å…æµè§ˆå™¨ç¼“å­˜
        timeout: 5000,
        
      });
    });

    document.addEventListener('pjax:send', function (e) {
      //window.stop(); // ç›¸å½“äºç‚¹å‡»äº†æµè§ˆå™¨çš„åœæ­¢æŒ‰é’®

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      // ä½¿ç”¨ volantis.pjax.send æ–¹æ³•ä¼ å…¥pjax:sendå›è°ƒå‡½æ•° å‚è§layout/_partial/scripts/global.ejs
      volantis.pjax.method.send.start();
    });

    document.addEventListener('pjax:complete', function () {
      // ä½¿ç”¨ volantis.pjax.push æ–¹æ³•ä¼ å…¥é‡è½½å‡½æ•° å‚è§layout/_partial/scripts/global.ejs
      volantis.pjax.method.complete.start();
    });

    document.addEventListener('pjax:error', function (e) {
      if(volantis.debug) {
        console.error(e);
        console.log('pjax error: \n' + JSON.stringify(e));
      }else{
        // ä½¿ç”¨ volantis.pjax.error æ–¹æ³•ä¼ å…¥pjax:errorå›è°ƒå‡½æ•° å‚è§layout/_partial/scripts/global.ejs
        volantis.pjax.method.error.start();
        window.location.href = e.triggerElement.href;
      }
    });
</script>

      
    </div>
    <!-- import body_end begin-->
    <!-- import body_end end-->
    <!-- Custom Files bodyEnd begin-->
    
    <!-- Custom Files bodyEnd end-->
  </body>
</html>
