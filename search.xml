<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>(每日LeetCode)1797. 设计一个验证系统</title>
      <link href="/2023/02/09/%E6%AF%8F%E6%97%A5LeetCode/2023-2/1797%20%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E9%AA%8C%E8%AF%81%E7%B3%BB%E7%BB%9F/"/>
      <url>/2023/02/09/%E6%AF%8F%E6%97%A5LeetCode/2023-2/1797%20%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E9%AA%8C%E8%AF%81%E7%B3%BB%E7%BB%9F/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>你需要设计一个包含验证码的验证系统。每一次验证中，用户会收到一个新的验证码，这个验证码在 currentTime 时刻之后 timeToLive 秒过期。如果验证码被更新了，那么它会在 currentTime （可能与之前的 currentTime 不同）时刻延长 timeToLive 秒。</p><p>请你实现 AuthenticationManager 类：</p><ul><li><code>AuthenticationManager(int timeToLive)</code> 构造 AuthenticationManager 并设置 timeToLive 参数。</li><li><code>generate(string tokenId, int currentTime)</code> 给定 tokenId ，在当前时间 currentTime 生成一个新的验证码。</li><li><code>renew(string tokenId, int currentTime)</code> 将给定 tokenId 且 未过期 的验证码在 currentTime 时刻更新。如果给定 tokenId 对应的验证码不存在或已过期，请你忽略该操作，不会有任何更新操作发生。</li><li><code>countUnexpiredTokens(int currentTime)</code> 请返回在给定 currentTime 时刻，未过期 的验证码数目。<br>如果一个验证码在时刻 t 过期，且另一个操作恰好在时刻 t 发生（renew 或者 countUnexpiredTokens 操作），过期事件 优先于 其他操作。</li></ul></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2021/02/25/copy-of-pc68_q2.png" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2021/02/25/copy-of-pc68_q2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 67%;" /><blockquote><p>输入：<br>[“AuthenticationManager”, “renew”, “generate”, “countUnexpiredTokens”, “generate”, “renew”, “renew”, “countUnexpiredTokens”]<br>[[5], [“aaa”, 1], [“aaa”, 2], [6], [“bbb”, 7], [“aaa”, 8], [“bbb”, 10], [15]]<br>输出：<br>[null, null, null, 1, null, null, null, 0]</p><p>解释：<br>AuthenticationManager authenticationManager &#x3D; new AuthenticationManager(5); &#x2F;&#x2F; 构造 AuthenticationManager ，设置 timeToLive &#x3D; 5 秒。<br>authenticationManager.renew(“aaa”, 1); &#x2F;&#x2F; 时刻 1 时，没有验证码的 tokenId 为 “aaa” ，没有验证码被更新。<br>authenticationManager.generate(“aaa”, 2); &#x2F;&#x2F; 时刻 2 时，生成一个 tokenId 为 “aaa” 的新验证码。<br>authenticationManager.countUnexpiredTokens(6); &#x2F;&#x2F; 时刻 6 时，只有 tokenId 为 “aaa” 的验证码未过期，所以返回 1 。<br>authenticationManager.generate(“bbb”, 7); &#x2F;&#x2F; 时刻 7 时，生成一个 tokenId 为 “bbb” 的新验证码。<br>authenticationManager.renew(“aaa”, 8); &#x2F;&#x2F; tokenId 为 “aaa” 的验证码在时刻 7 过期，且 8 &gt;&#x3D; 7 ，所以时刻 8 的renew 操作被忽略，没有验证码被更新。<br>authenticationManager.renew(“bbb”, 10); &#x2F;&#x2F; tokenId 为 “bbb” 的验证码在时刻 10 没有过期，所以 renew 操作会执行，该 token 将在时刻 15 过期。<br>authenticationManager.countUnexpiredTokens(15); &#x2F;&#x2F; tokenId 为 “bbb” 的验证码在时刻 15 过期，tokenId 为 “aaa” 的验证码在时刻 7 过期，所有验证码均已过期，所以返回 0 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：哈希表"><a href="#代码-cpp-：哈希表" class="headerlink" title="代码(cpp)：哈希表"></a>代码(cpp)：哈希表</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AuthenticationManager</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//&lt;tokenId, expiryTime&gt;</span></span><br><span class="line">    unordered_map&lt;string, <span class="type">int</span>&gt; map;</span><br><span class="line">    <span class="type">int</span> timeToLive;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//初始化，设置有效期</span></span><br><span class="line">    <span class="built_in">AuthenticationManager</span>(<span class="type">int</span> timeToLive) &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;timeToLive = timeToLive;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置token以及过期时间</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">generate</span><span class="params">(string tokenId, <span class="type">int</span> currentTime)</span> </span>&#123;</span><br><span class="line">        map[tokenId] = currentTime + <span class="keyword">this</span>-&gt;timeToLive;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将未过期的token刷新</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">renew</span><span class="params">(string tokenId, <span class="type">int</span> currentTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(map.<span class="built_in">find</span>(tokenId) != map.<span class="built_in">end</span>() &amp;&amp; map[tokenId] &gt; currentTime) &#123;</span><br><span class="line">            map[tokenId] = currentTime + <span class="keyword">this</span>-&gt;timeToLive;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//计算当前时间未过期的token数量</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">countUnexpiredTokens</span><span class="params">(<span class="type">int</span> currentTime)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; [_, expiryTime] : map) &#123;</span><br><span class="line">            count += expiryTime &gt; currentTime ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1233. 删除子文件夹</title>
      <link href="/2023/02/08/%E6%AF%8F%E6%97%A5LeetCode/2023-2/1233%20%E5%88%A0%E9%99%A4%E5%AD%90%E6%96%87%E4%BB%B6%E5%A4%B9/"/>
      <url>/2023/02/08/%E6%AF%8F%E6%97%A5LeetCode/2023-2/1233%20%E5%88%A0%E9%99%A4%E5%AD%90%E6%96%87%E4%BB%B6%E5%A4%B9/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>你是一位系统管理员，手里有一份文件夹列表 folder，你的任务是要删除该列表中的所有 子文件夹，并以 任意顺序 返回剩下的文件夹。</p><p>如果文件夹 folder[i] 位于另一个文件夹 folder[j] 下，那么 folder[i] 就是 folder[j] 的 子文件夹 。</p><p>文件夹的「路径」是由一个或多个按以下格式串联形成的字符串：’&#x2F;‘ 后跟一个或者多个小写英文字母。</p><p>例如，”&#x2F;leetcode” 和 “&#x2F;leetcode&#x2F;problems” 都是有效的路径，而空字符串和 “&#x2F;“ 不是。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：folder &#x3D; [“&#x2F;a”,”&#x2F;a&#x2F;b”,”&#x2F;c&#x2F;d”,”&#x2F;c&#x2F;d&#x2F;e”,”&#x2F;c&#x2F;f”]<br>输出：[“&#x2F;a”,”&#x2F;c&#x2F;d”,”&#x2F;c&#x2F;f”]<br>解释：”&#x2F;a&#x2F;b&#x2F;“ 是 “&#x2F;a” 的子文件夹，而 “&#x2F;c&#x2F;d&#x2F;e” 是 “&#x2F;c&#x2F;d” 的子文件夹。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">removeSubfolders</span><span class="params">(vector&lt;string&gt;&amp; folder)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">sort</span>(folder.<span class="built_in">begin</span>(), folder.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">        vector&lt;string&gt; ans;</span><br><span class="line"></span><br><span class="line">        string temp = <span class="string">&quot; &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; str : folder) &#123;</span><br><span class="line">            <span class="comment">//获取temp的位置</span></span><br><span class="line">            <span class="type">int</span> pos = str.<span class="built_in">find</span>(temp);</span><br><span class="line">            <span class="comment">//不在开头或者不存在，说明是一个新的文件夹</span></span><br><span class="line">            <span class="keyword">if</span>(pos != <span class="number">0</span>) &#123;</span><br><span class="line">                temp = str;</span><br><span class="line">                ans.<span class="built_in">emplace_back</span>(str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//判断同级文件夹中是否存在相同的前缀文件</span></span><br><span class="line">            <span class="comment">// /a/b和/a/bb</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(str[temp.<span class="built_in">size</span>()] != <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                    temp = str;</span><br><span class="line">                    ans.<span class="built_in">emplace_back</span>(str);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(n)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2023/02/07/Java/JUC/"/>
      <url>/2023/02/07/Java/JUC/</url>
      
        <content type="html"><![CDATA[<hr><hr><div class="story post-story"><h2 id="1-基本概念"><a href="#1-基本概念" class="headerlink" title="1.基本概念"></a>1.基本概念</h2><h3 id="1-1-进程与线程"><a href="#1-1-进程与线程" class="headerlink" title="1.1 进程与线程"></a>1.1 进程与线程</h3><p><strong>进程</strong></p><ul><li><p>程序由指令和数据组成，但这些指令要运行，数据要读写，就必须将指令加载至CPU，数据加载至内存。</p><p>在指令运行过程中还需要用到磁盘、网络等设备。进程就是用来加载指令、管理内存、管理I&#x2F;O的</p></li><li><p><strong>当一个程序被运行，从磁盘加载这个程序的代码至内存，这时就开启了一个进程</strong>。</p></li><li><p><strong>进程就可以视为程序的一个实例</strong>。大部分程序可以同时运行多个实例进程(例如记事本、画图、浏览器等），也有的程序只能启动一个实例进程（例如网易云音乐、360安全卫士等）</p></li></ul><p><strong>线程</strong></p><ul><li><strong>一个进程之内可以分为一到多个线程。</strong></li><li>一个线程就是一个指令流，将指令流中的一条条指令以一定的顺序交给CPU执行</li><li>Java中，<strong>线程作为最小调度单位</strong>，<strong>进程作为资源分配的最小单位</strong>。在windows中进程是不活动的，只是作为线程的容器</li></ul><h3 id="1-2-并行与并发"><a href="#1-2-并行与并发" class="headerlink" title="1.2 并行与并发"></a>1.2 并行与并发</h3><p><strong>并发</strong></p><p><strong>单核cpu</strong>下，线程实际还是<strong>串行执行</strong>的。操作系统中有一个组件叫做任务调度器，将cpu的时间片（windows 下时间片最小约为15毫秒）分给不同的线程使用，只是由于<strong>cpu在线程间（时间片很短）的切换线程非常快</strong>，<strong>人类感觉是同时运行的</strong>。</p><p>总结为一句话就是：<strong>微观串行，宏观并行</strong>，一般会将这种线程轮流使用cpu的做法称为<strong>并发</strong>(concurrent)</p><p><strong>并行</strong></p><p><strong>多核cpu</strong>下，每个核(core)都可以调度运行线程，这时候线程可以是<strong>并行</strong>的。</p><p>总的来说，</p><ul><li>并发(concurrent)：是<strong>一个人</strong>同一时间应对多件事情的能力</li><li>并行(parallel)：是<strong>一群人</strong>各自同时做多件事情的能力</li></ul><h3 id="1-3-异步与同步"><a href="#1-3-异步与同步" class="headerlink" title="1.3 异步与同步"></a>1.3 异步与同步</h3><p>从方法调用的角度来讲，</p><ul><li>如果<strong>需要等待结果返回</strong>，才能继续运行就是<strong>同步</strong></li><li><strong>不需要等待结果返回</strong>，就能继续运行就是<strong>异步</strong></li><li>注意：同步在多线程中还有另外一层意思，是让多个线程步调一致</li></ul><p>注意事项：</p><ul><li><strong>单核cpu</strong>下，<strong>多线程不能实际提高程序运行效率</strong>，只是为了能够在不同的任务之间切换，不同线程轮流使<br>用cpu，<strong>不至于一个线程总占用cpu，别的线程没法干活</strong></li><li><strong>多核cpu</strong>可以<strong>并行跑多个线程</strong>，但<strong>能否提高程序运行效率还是要分情况</strong>的<ul><li>有些任务，经过精心设计，将任务拆分，并行执行，当然可以提高程序的运行效率。但不是所有计算<br>任务都能拆分</li><li>也不是所有任务都需要拆分，任务的目的如果不同，谈拆分和效率没啥意义</li></ul></li><li><strong>I&#x2F;O操作不占用cpu</strong>，只是我们一般拷贝文件使用的是<strong>阻塞I&#x2F;O</strong>，这时相当于<strong>线程虽然不用cpu，但需要</strong><br><strong>一直等待I&#x2F;O结束</strong>，没能充分利用线程。所以才有后面的<strong>非阻塞I&#x2F;O</strong>和<strong>异步I&#x2F;O</strong>优化</li></ul></div><div class="story post-story"><h2 id="2-Java线程"><a href="#2-Java线程" class="headerlink" title="2.Java线程"></a>2.Java线程</h2><h3 id="2-1-创建线程"><a href="#2-1-创建线程" class="headerlink" title="2.1 创建线程"></a>2.1 创建线程</h3><h4 id="2-1-1-Thread"><a href="#2-1-1-Thread" class="headerlink" title="2.1.1 Thread"></a>2.1.1 Thread</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//创建线程对象，可以添加线程名称也可以不写</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//执行任务</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-2-使用Runnable配合Thread"><a href="#2-1-2-使用Runnable配合Thread" class="headerlink" title="2.1.2 使用Runnable配合Thread"></a>2.1.2 使用Runnable配合Thread</h4><p>把<strong>线程</strong>和<strong>任务</strong>（要执行的代码）分开</p><ul><li>Thread：代表线程</li><li>Runnable：可运行的任务（线程要执行的代码）</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//创建任务</span></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//执行任务</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//将任务放入新的线程中</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">    <span class="comment">//执行任务</span></span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用Lambda表达式可以简化：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test03</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//参数1：要执行的任务，参数2：线程名称</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="comment">//执行任务</span></span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-3-Runnable与Thread的关系"><a href="#2-1-3-Runnable与Thread的关系" class="headerlink" title="2.1.3 Runnable与Thread的关系"></a>2.1.3 Runnable与Thread的关系</h4><p>Thread对象中的<code>run()</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Runnable target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line">        target.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>单独使用Thread：</p><ul><li><p>相当于重写了<code>run()</code>方法，</p></li><li><p>是把线程和任务合并在了一起</p></li></ul><p>使用Runnable配合Thread： </p><ul><li><p>相当于把Runnable的任务传入<code>target</code>中，调用<code>run()</code>方法会进行判断如果<code>target</code>不为空，则执行任务</p></li><li><p>是把线程和任务分开了</p></li></ul><p>用Runnable 更容易与线程池等高级API 配合</p><p>用Runnable 让任务类脱离了Thread继承体系，更灵活</p></blockquote></div>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1604. 警告一小时内使用相同员工卡大于等于三次的人</title>
      <link href="/2023/02/07/%E6%AF%8F%E6%97%A5LeetCode/2023-2/1604%20%E8%AD%A6%E5%91%8A%E4%B8%80%E5%B0%8F%E6%97%B6%E5%86%85%E4%BD%BF%E7%94%A8%E7%9B%B8%E5%90%8C%E5%91%98%E5%B7%A5%E5%8D%A1%E5%A4%A7%E4%BA%8E%E7%AD%89%E4%BA%8E%E4%B8%89%E6%AC%A1%E7%9A%84%E4%BA%BA/"/>
      <url>/2023/02/07/%E6%AF%8F%E6%97%A5LeetCode/2023-2/1604%20%E8%AD%A6%E5%91%8A%E4%B8%80%E5%B0%8F%E6%97%B6%E5%86%85%E4%BD%BF%E7%94%A8%E7%9B%B8%E5%90%8C%E5%91%98%E5%B7%A5%E5%8D%A1%E5%A4%A7%E4%BA%8E%E7%AD%89%E4%BA%8E%E4%B8%89%E6%AC%A1%E7%9A%84%E4%BA%BA/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>力扣公司的员工都使用员工卡来开办公室的门。每当一个员工使用一次他的员工卡，安保系统会记录下员工的名字和使用时间。如果一个员工在一小时时间内使用员工卡的次数大于等于三次，这个系统会自动发布一个 警告 。</p><p>给你字符串数组 keyName 和 keyTime ，其中 [keyName[i], keyTime[i]] 对应一个人的名字和他在 某一天 内使用员工卡的时间。</p><p>使用时间的格式是 24小时制 ，形如 “HH:MM” ，比方说 “23:51” 和 “09:49” 。</p><p>请你返回去重后的收到系统警告的员工名字，将它们按 字典序升序 排序后返回。</p><p>请注意 “10:00” - “11:00” 视为一个小时时间范围内，而 “23:51” - “00:10” 不被视为一小时内，因为系统记录的是某一天内的使用情况。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：keyName &#x3D; [“daniel”,”daniel”,”daniel”,”luis”,”luis”,”luis”,”luis”], keyTime &#x3D; [“10:00”,”10:40”,”11:00”,”09:00”,”11:00”,”13:00”,”15:00”]<br>输出：[“daniel”]<br>解释：”daniel” 在一小时内使用了 3 次员工卡（”10:00”，”10:40”，”11:00”）。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：哈希-排序"><a href="#代码-cpp-：哈希-排序" class="headerlink" title="代码(cpp)：哈希+排序"></a>代码(cpp)：哈希+排序</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">alertNames</span><span class="params">(vector&lt;string&gt;&amp; keyName, vector&lt;string&gt;&amp; keyTime)</span> </span>&#123;</span><br><span class="line">        map&lt;string, vector&lt;<span class="type">int</span>&gt;&gt;  map;</span><br><span class="line"><span class="comment">//遍历，将时间转换为分钟，便于计算以及排序!!!</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; keyName.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            string time = keyTime[i];</span><br><span class="line">            <span class="type">int</span> hour = (time[<span class="number">0</span>] -<span class="string">&#x27;0&#x27;</span>)*<span class="number">10</span> + (time[<span class="number">1</span>] - <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            <span class="type">int</span> minute = (time[<span class="number">3</span>] -<span class="string">&#x27;0&#x27;</span>)*<span class="number">10</span> + (time[<span class="number">4</span>] - <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            map[keyName[i]].<span class="built_in">emplace_back</span>(hour*<span class="number">60</span> + minute);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        vector&lt;string&gt; ans;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; [k, v] : map) &#123;</span><br><span class="line">            <span class="built_in">sort</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> left = <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> right = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">while</span>(right &lt; v.<span class="built_in">size</span>()) &#123;</span><br><span class="line">                <span class="keyword">if</span>(v[right++] - v[left++] &lt;= <span class="number">60</span>) &#123;</span><br><span class="line">                    ans.<span class="built_in">emplace_back</span>(k);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                    </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sort</span>(ans.<span class="built_in">begin</span>(), ans.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">return</span> ans;       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：<em>O</em>(nlogn)，其中 n 是数组 keyName 和 keyTime 的长度</p><p>然后判断每个员工是否收到系统警告，需要进行排序和遍历的操作，最坏情况下，排序的时间复杂度是O(nlogn)，遍历的时间复杂度是 O(n)，因此时间复杂度是 O(nlogn)。</p></li><li><p>空间复杂度：O(n)</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2331. 计算布尔二叉树的值</title>
      <link href="/2023/02/06/%E6%AF%8F%E6%97%A5LeetCode/2023-2/2331%20%E8%AE%A1%E7%AE%97%E5%B8%83%E5%B0%94%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E5%80%BC/"/>
      <url>/2023/02/06/%E6%AF%8F%E6%97%A5LeetCode/2023-2/2331%20%E8%AE%A1%E7%AE%97%E5%B8%83%E5%B0%94%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E5%80%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一棵 完整二叉树 的根，这棵树有以下特征：</p><p>叶子节点 要么值为 0 要么值为 1 ，其中 0 表示 False ，1 表示 True 。<br>非叶子节点 要么值为 2 要么值为 3 ，其中 2 表示逻辑或 OR ，3 表示逻辑与 AND 。<br>计算 一个节点的值方式如下：</p><p>如果节点是个叶子节点，那么节点的 值 为它本身，即 True 或者 False 。<br>否则，计算 两个孩子的节点值，然后将该节点的运算符对两个孩子值进行 运算 。<br>返回根节点 root 的布尔运算值。</p><p>完整二叉树 是每个节点有 0 个或者 2 个孩子的二叉树。</p><p>叶子节点 是没有孩子的节点。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2022/05/16/example1drawio1.png" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2022/05/16/example1drawio1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 50%;" /><blockquote><p>输入：root &#x3D; [2,1,3,null,null,0,1]<br>输出：true<br>解释：上图展示了计算过程。<br>AND 与运算节点的值为 False AND True &#x3D; False 。<br>OR 运算节点的值为 True OR False &#x3D; True 。<br>根节点的值为 True ，所以我们返回 true 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">evaluateTree</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> choice = root-&gt;val;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(choice == <span class="number">0</span> || choice == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> choice;</span><br><span class="line">        </span><br><span class="line">        <span class="type">bool</span> left = <span class="built_in">evaluateTree</span>(root-&gt;left);</span><br><span class="line">        <span class="type">bool</span> right = <span class="built_in">evaluateTree</span>(root-&gt;right);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(choice == <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">return</span> left || right;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(choice == <span class="number">3</span>)</span><br><span class="line">            <span class="keyword">return</span> left &amp;&amp; right;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)，其中 n 表示树中节点的数目。对于每个节点我们只需遍历一次即可，因此时间复杂度为 O(n)。</li><li>空间复杂度：O(n)，其中 n 表示树中节点的数目。按照题目要求，含有 n 个节点的完整二叉树的深度最多为 n&#x2F;2，最少为 O(logn)，因此递归的最大深度为 n&#x2F;2，因此空间复杂度为 O(n)。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1798. 你能构造出连续值的最大数目</title>
      <link href="/2023/02/04/%E6%AF%8F%E6%97%A5LeetCode/2023-2/1798%20%E4%BD%A0%E8%83%BD%E6%9E%84%E9%80%A0%E5%87%BA%E8%BF%9E%E7%BB%AD%E5%80%BC%E7%9A%84%E6%9C%80%E5%A4%A7%E6%95%B0%E7%9B%AE/"/>
      <url>/2023/02/04/%E6%AF%8F%E6%97%A5LeetCode/2023-2/1798%20%E4%BD%A0%E8%83%BD%E6%9E%84%E9%80%A0%E5%87%BA%E8%BF%9E%E7%BB%AD%E5%80%BC%E7%9A%84%E6%9C%80%E5%A4%A7%E6%95%B0%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<p>题目：</p><p>给你一个长度为 n 的整数数组 coins ，它代表你拥有的 n 个硬币。第 i 个硬币的值为 coins[i] 。如果你从这些硬币中选出一部分硬币，它们的和为 x ，那么称，你可以 构造 出 x 。</p><p>请返回从 0 开始（包括 0 ），你最多能 构造 出多少个连续整数。</p><p>你可能有多个相同值的硬币。</p><p>示例：</p><blockquote><p>输入：coins &#x3D; [1,1,1,4]<br>输出：8<br>解释：你可以得到以下这些值：</p><ul><li>0：什么都不取 []</li><li>1：取 [1]</li><li>2：取 [1,1]</li><li>3：取 [1,1,1]</li><li>4：取 [4]</li><li>5：取 [4,1]</li><li>6：取 [4,1,1]</li><li>7：取 [4,1,1,1]</li></ul><p>从 0 开始，你可以构造出 8 个连续整数。</p></blockquote><p>思路：</p><p>大佬的思路~~</p><p><strong>有序</strong>是一个强大的性质，如果对数组排序不影响答案的话，可以尝试将数组排序后，再重新思考，看看能否发现新的思路。</p><img src="https://pic.leetcode.cn/1675089725-wbrBLD-1798.png" class="lazyload" data-srcset="https://pic.leetcode.cn/1675089725-wbrBLD-1798.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1798.png" style="zoom: 33%;" /><p>代码(cpp)：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getMaximumConsecutive</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; coins)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">sort</span>(coins.<span class="built_in">begin</span>(), coins.<span class="built_in">end</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> ans = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; coin :coins) &#123;</span><br><span class="line">            <span class="keyword">if</span> (coin &gt; ans)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ans += coin;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>复杂度分析：</p><ul><li>时间复杂度：O(nlogn)</li><li>空间复杂度：O(1)</li></ul>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8的学习笔记</title>
      <link href="/2023/02/04/Java/Java8/"/>
      <url>/2023/02/04/Java/Java8/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="1-Lambda表达式"><a href="#1-Lambda表达式" class="headerlink" title="1.Lambda表达式"></a>1.Lambda表达式</h2><h3 id="1-1-体验Lambda表达式"><a href="#1-1-体验Lambda表达式" class="headerlink" title="1.1 体验Lambda表达式"></a>1.1 体验Lambda表达式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;新线程开始执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//体验Lambda表达式</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Lambda表达式开始执行&quot;</span>);</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Lambda表达式优点：简化匿名内部类，使代码更加精简</p></blockquote><h3 id="1-2-Lambda的标准格式"><a href="#1-2-Lambda的标准格式" class="headerlink" title="1.2 Lambda的标准格式"></a>1.2 Lambda的标准格式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(参数类型 参数名) -&gt; &#123;</span><br><span class="line">代码体;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>格式说明：</p><ul><li><code>(参数类型 参数名)</code>：参数列表</li><li><code>代码体;</code>：方法体</li><li><code>-&gt;</code>：分隔参数列表和方法体</li></ul><p>Lambda只能有且仅有一个抽象方法的接口，不然会报错，不支持多个抽象方法的接口</p><h3 id="1-3-Lambda的使用"><a href="#1-3-Lambda的使用" class="headerlink" title="1.3 Lambda的使用"></a>1.3 Lambda的使用</h3><p>创建接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    String <span class="title function_">eat</span><span class="params">(String food)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        toEat((String food) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;开始吃&quot;</span> + food);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;吃了&quot;</span> + food;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">toEat</span><span class="params">(Person person)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> person.eat(<span class="string">&quot;西瓜&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;result = &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果：</p><blockquote><p>开始吃西瓜<br>result &#x3D; 吃了西瓜</p></blockquote><p>执行排序以及遍历：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    list.add(<span class="number">2</span>);</span><br><span class="line">    list.add(<span class="number">5</span>);</span><br><span class="line">    list.add(<span class="number">1</span>);</span><br><span class="line">    list.add(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*list.sort(new Comparator&lt;Integer&gt;() &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public int compare(Integer o1, Integer o2) &#123;</span></span><br><span class="line"><span class="comment">                return o1 - o2;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        list.forEach(new Consumer&lt;Integer&gt;() &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public void accept(Integer integer) &#123;</span></span><br><span class="line"><span class="comment">                System.out.println(&quot;integer = &quot; + integer);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);*/</span></span><br><span class="line"></span><br><span class="line">    list.sort((Integer a, Integer b) -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> a - b;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    list.forEach((Integer val) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;val = &quot;</span> + val);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果：</p><blockquote><p>val &#x3D; 1<br>val &#x3D; 2<br>val &#x3D; 3<br>val &#x3D; 5</p></blockquote><h3 id="1-4-Lambda的实现原理"><a href="#1-4-Lambda的实现原理" class="headerlink" title="1.4 Lambda的实现原理"></a>1.4 Lambda的实现原理</h3><p>创建接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">driver</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用匿名内部类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        driver(<span class="keyword">new</span> <span class="title class_">Car</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">driver</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;汽车开始行驶&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">driver</span><span class="params">(Car car)</span> &#123;</span><br><span class="line">        car.driver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>原理：匿名内部类在编译后会形成一个新的类带有<code>$</code>，实现Car接口的抽象方法</p></blockquote><p>改为使用Lambda表达式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        driver(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;汽车开始行驶&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">driver</span><span class="params">(Car car)</span> &#123;</span><br><span class="line">        car.driver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>原理：</p><ol><li>Lambda表达式会在类中生成一个私有静态方法</li><li>还会形成一个匿名内部类，实现接口的抽象方法</li><li>会在接口的抽象方法里调用Lambda表达式的私有静态方法</li></ol></blockquote><h3 id="1-5-Lambda的省略格式"><a href="#1-5-Lambda的省略格式" class="headerlink" title="1.5 Lambda的省略格式"></a>1.5 Lambda的省略格式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="type">int</span> a) -&gt; &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在Lambda标准格式的基础上，使用省路写法的规则为：</p><ol><li><p><strong>小括号内参数的类型</strong>可以省略</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(a) -&gt; &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>如果<strong>小括号内有且仅有一个参数</strong>，则小括号可以省略</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a -&gt; &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>如果<strong>大括号内有且仅有一个语句</strong>，可以同时省略大括号、return关键字及语句分号</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a -&gt; <span class="keyword">new</span> <span class="title class_">Object</span>()</span><br></pre></td></tr></table></figure></li></ol><p>练习：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    list.add(<span class="number">2</span>);</span><br><span class="line">    list.add(<span class="number">5</span>);</span><br><span class="line">    list.add(<span class="number">1</span>);</span><br><span class="line">    list.add(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    list.sort((a, b) -&gt; a - b);</span><br><span class="line"></span><br><span class="line">    list.forEach(val -&gt; System.out.println(<span class="string">&quot;val = &quot;</span> + val));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-6-Lambda的使用前提"><a href="#1-6-Lambda的使用前提" class="headerlink" title="1.6 Lambda的使用前提"></a>1.6 Lambda的使用前提</h3><p>Lambda的语法非常简洁，但是Lambda表达式不是随便使用的，使用时有几个条件要特别注意：</p><ol><li>方法的参数或局部变量类型<strong>必须为接口</strong>才能使用Lambda</li><li>接口中有且<strong>仅有一个抽象方法</strong></li><li>只有一个抽象方法的接口称为函数式接口，我们就能使用Lambda</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span><span class="comment">//检测这个接口是不是只有一个抽象方法,即函数式接口</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Flyable</span> &#123;</span><br><span class="line"><span class="comment">//接口中有且仅有一任抽象方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//public abstract void eat1(); // 报错</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="2-接口"><a href="#2-接口" class="headerlink" title="2.接口"></a>2.接口</h2><h3 id="2-1-接口的默认方法与静态方法"><a href="#2-1-接口的默认方法与静态方法" class="headerlink" title="2.1 接口的默认方法与静态方法"></a>2.1 接口的默认方法与静态方法</h3><p>JDK 8以前的接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">interface 接口名 &#123;</span><br><span class="line">静态常量;</span><br><span class="line">抽象方法;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JDK 8对接口的增强，接口还可以有默认方法和静态方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">interface 接口名 &#123;</span><br><span class="line">静态常量;</span><br><span class="line">抽象方法;</span><br><span class="line">默认方法;</span><br><span class="line">静态方法;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>默认方法的定义</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">interface 接口名 &#123;</span><br><span class="line"><span class="keyword">default</span> 返回值类型 方法名([参数类型 参数]) &#123;</span><br><span class="line">    代码;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>练习：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我是默认方法&quot;</span>);    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">implements</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="comment">//可重写默认方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意：接口中的<strong>默认方法</strong>实现类<strong>不必重写</strong>，可以直接使用，实现类<strong>也可以根据需要重写</strong>。这样就方便接口的扩展。</p></blockquote><p><strong>静态方法的定义</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">interface 接口名 &#123;</span><br><span class="line"><span class="keyword">default</span> 返回值类型 方法名([参数类型 参数]) &#123;</span><br><span class="line">    代码;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>练习：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我是静态方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">implements</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="comment">//不可重写静态方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        A.test();</span><br><span class="line"></span><br><span class="line">        <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>();</span><br><span class="line">        <span class="comment">//a.test(); //报错</span></span><br><span class="line">        <span class="comment">//B.test(); //报错</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意：静态方法不能被重写，只有由接口名调用</p></blockquote><p><strong>默认方法与静态方法的区别</strong>：</p><ol><li>默认方法通过<strong>实例调用</strong>，静态方法通过<strong>接口名调用</strong>。</li><li>默认方法<strong>可以被继承</strong>，实现类<strong>可以直接使用接口默认方法</strong>，也<strong>可以重写接口默认方法</strong>。</li><li>静态方法<strong>不能被继承</strong>，实现类<strong>不能重写接口静态方法</strong>，<strong>只能使用接口名调用</strong>。</li></ol><h3 id="2-2-常用内置函数式接口"><a href="#2-2-常用内置函数式接口" class="headerlink" title="2.2 常用内置函数式接口"></a>2.2 常用内置函数式接口</h3><p>我们知道使用Lambda表达式的前提是需要有函数式接口。</p><p>而Lambda使用时不关心接口名，抽象方法名，只关心抽象方法的参数列表和返回值类型。</p><p>因此为了让我们便用Lambda方使，JDK提供了大量常用的函数式接口。</p><p>它们主要在<code>java.util.function</code>包中。下面是最常用的几个接口：</p><ul><li><p>Supplier接口</p></li><li><p>Consumer接口</p></li><li><p>Function接口</p></li><li><p>Predicate接口</p></li></ul><h4 id="2-2-1-Supplier接口"><a href="#2-2-1-Supplier接口" class="headerlink" title="2.2.1 Supplier接口"></a>2.2.1 Supplier接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Supplier</span>&lt;T&gt; &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title function_">get</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用Lambda表达式返回数组元素最大值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> getMax(() -&gt; &#123;</span><br><span class="line">            <span class="type">int</span>[] arr = &#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>&#125;;</span><br><span class="line">            Arrays.sort(arr);</span><br><span class="line">            <span class="keyword">return</span> arr[arr.length - <span class="number">1</span>];</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;integer = &quot;</span> + integer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getMax</span><span class="params">(Supplier&lt;T&gt; supplier)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> supplier.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-2-Consumer接口"><a href="#2-2-2-Consumer接口" class="headerlink" title="2.2.2 Consumer接口"></a>2.2.2 Consumer接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Consumer</span>&lt;T&gt; &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(T t)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用Lambda表达式将一个字符串的大写转换成小写：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test03</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        change(<span class="string">&quot;AAA&quot;</span>, str -&gt; System.out.println(str.toLowerCase()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">change</span><span class="params">(String str, Consumer&lt;String&gt; consumer)</span> &#123;</span><br><span class="line">        consumer.accept(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>andThen()方法：</p><p>使用Lambda表达式将一个字符串的大写转换成小写，再将字符串的小写转换成大写：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test03</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        printToLower(<span class="string">&quot;AAA&quot;</span>,</span><br><span class="line">                str -&gt; System.out.println(str.toLowerCase()),</span><br><span class="line">                str -&gt; System.out.println(str.toUpperCase()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printToLower</span><span class="params">(</span></span><br><span class="line"><span class="params">        String str, </span></span><br><span class="line"><span class="params">        Consumer&lt;String&gt; c1, </span></span><br><span class="line"><span class="params">        Consumer&lt;String&gt; c2)</span> &#123;</span><br><span class="line">        <span class="comment">//先执行c1再执行c2</span></span><br><span class="line">        c1.andThen(c2).accept(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-3-Function接口"><a href="#2-2-3-Function接口" class="headerlink" title="2.2.3 Function接口"></a>2.2.3 Function接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Function</span>&lt;T,R&gt; &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> R <span class="title function_">apply</span><span class="params">(T t)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用Lambda表达式将字符串转成数字：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> str2Int(<span class="string">&quot;11&quot;</span>, str -&gt; Integer.parseInt(str));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;integer = &quot;</span> + integer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">str2Int</span><span class="params">(String str, Function&lt;String, Integer&gt; function)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> function.apply(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>andThen()方法：</p><p>使用Lambda表达式将字符串转成数字，第二个操作将这个数字乘以5：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test05</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLong</span> <span class="operator">=</span> isLongName(<span class="string">&quot;迪丽热巴&quot;</span>, str -&gt; str.length() &gt; <span class="number">3</span> );</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;isLong = &quot;</span> + isLong);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isLongName</span><span class="params">(String name, Predicate&lt;String&gt; predicate)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> predicate.test(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-4-Predicate接口"><a href="#2-2-4-Predicate接口" class="headerlink" title="2.2.4 Predicate接口"></a>2.2.4 Predicate接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Predicate</span>&lt;T&gt; &#123;</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">test</span><span class="params">(T t)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用Lambda判断一个人名如果超过3个字就认为是很长的名字：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test05</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLong</span> <span class="operator">=</span> isLongName(<span class="string">&quot;迪丽热巴&quot;</span>, str -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> str.length() &gt; <span class="number">3</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;isLong = &quot;</span> + isLong);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isLongName</span><span class="params">(String name, Predicate&lt;String&gt; predicate)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> predicate.test(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>and()方法：</p><p>使用Lambda表达式判断一个字特串中即包含’W’,也包含’H’：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test05</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isContain</span> <span class="operator">=</span> isContainsHAndW(<span class="string">&quot;Hello World&quot;</span>,</span><br><span class="line">                str -&gt; str.contains(<span class="string">&quot;H&quot;</span>),</span><br><span class="line">                str -&gt; str.contains(<span class="string">&quot;W&quot;</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;isContain = &quot;</span> + isContain);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isContainsHAndW</span><span class="params">(</span></span><br><span class="line"><span class="params">            String str,</span></span><br><span class="line"><span class="params">            Predicate&lt;String&gt; p1,</span></span><br><span class="line"><span class="params">            Predicate&lt;String&gt; p2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> p1.and(p2).test(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>and()方法，相当于”&amp;”；还有一个or()方法，相当于”|”</p></div><div class="story post-story"><h2 id="3-引用"><a href="#3-引用" class="headerlink" title="3.引用"></a>3.引用</h2><h3 id="3-1-方法引用"><a href="#3-1-方法引用" class="headerlink" title="3.1 方法引用"></a>3.1 方法引用</h3><p>使用Lambda表达式求一个数组的和：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="number">2</span>);</span><br><span class="line">        list.add(<span class="number">5</span>);</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">        list.add(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> getSum(list, nums -&gt; &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (Integer num : nums) &#123;</span><br><span class="line">                sum += num;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;result = &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">getSum</span><span class="params">(</span></span><br><span class="line"><span class="params">            List&lt;Integer&gt; list,</span></span><br><span class="line"><span class="params">            Function&lt;List&lt;Integer&gt;, Integer&gt; function)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> function.apply(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方法引用的格式：</p><ul><li>符号表示：<code>::</code></li><li>符号说明：双雪号为方法号引用运算符，而它所在的表达式被称为方法引用。</li><li>应用场景：如果Lambda所要实现的方案，已经有其他方法存在相同方案，那么则可以使用方法引用。</li></ul><p>改用方法引用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="number">2</span>);</span><br><span class="line">        list.add(<span class="number">5</span>);</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">        list.add(<span class="number">3</span>);</span><br><span class="line"><span class="comment">//方法引用</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> getSum(list, Test01::getSum);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;result = &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">getSum</span><span class="params">(List&lt;Integer&gt; list)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Integer integer : list) &#123;</span><br><span class="line">            sum += integer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">getSum</span><span class="params">(</span></span><br><span class="line"><span class="params">            List&lt;Integer&gt; list,</span></span><br><span class="line"><span class="params">            Function&lt;List&lt;Integer&gt;, Integer&gt; function)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> function.apply(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>让这个指定的方法去重写接口的抽象方法，到时候调用接口的抽象方法就是调用传递过去的这个方法</p></blockquote><p>常见引用方式：</p><blockquote><p>方法引用在JDK 8中用方式相当活，有以下几种形式：</p><ol><li><code>instanceName::methodName</code>：对象::方法名</li><li><code>ClassName::saticName</code>：类名::静态方法</li><li><code>ClassName::methodName</code>：类名::普通方法</li><li><code>Class::new</code>：类名::new 调用的构造器</li><li><code>TypeName[]::new</code>：String[]::new 调用数组的构造器</li></ol></blockquote></div><div class="story post-story"><h2 id="4-Stream流"><a href="#4-Stream流" class="headerlink" title="4.Stream流"></a>4.Stream流</h2><p>Stream流式思想类似于工厂车间的生产流水线，Stream流不是一种数据结构，不保存数据，而是对数据进行加工处理。</p><p>Stream可以看作是流水线上的一个工序。在流水线上，通过多个工序让一个原材料加工成一个商品。</p><p>Stream API能让我们快速完成许多复杂的操作，如筛选、切片、映射、查找、去除重复、统计、匹配和归约.</p><p>基本使用：</p><ol><li>拿到所有姓张的</li><li>拿到名字长度为3个字的</li><li>打印这些数据</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        Collections.addAll(list, <span class="string">&quot;张无忌&quot;</span>, <span class="string">&quot;周芷若&quot;</span>, <span class="string">&quot;赵敏&quot;</span>, <span class="string">&quot;张强&quot;</span>, <span class="string">&quot;张三丰&quot;</span>);</span><br><span class="line"></span><br><span class="line">        list.stream()</span><br><span class="line">                .filter(name -&gt; name.startsWith(<span class="string">&quot;张&quot;</span>))</span><br><span class="line">                .filter(name -&gt; name.length() == <span class="number">3</span>)</span><br><span class="line">                .forEach(name -&gt; System.out.println(<span class="string">&quot;name = &quot;</span> + name));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-1-获取Stream流的两种方式"><a href="#4-1-获取Stream流的两种方式" class="headerlink" title="4.1 获取Stream流的两种方式"></a>4.1 获取Stream流的两种方式</h3><p><img src="https://img-blog.csdnimg.cn/20201231164144228.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pob3VoZW5nemhl,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20201231164144228.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pob3VoZW5nemhl,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><ol><li><p>根据Collection获取流：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    Stream&lt;String&gt; streamList = list.stream();</span><br><span class="line"></span><br><span class="line">    Set&lt;String&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    Stream&lt;String&gt; streamSet = set.stream();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Map无法直接使用stream()</span></span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//Map转换成Set&lt;Entry&lt;String, String&gt;&gt;</span></span><br><span class="line">    Stream&lt;Map.Entry&lt;String, String&gt;&gt; streamMap1 = map.entrySet().stream();</span><br><span class="line">    <span class="comment">//Map转换成Set&lt;String&gt;</span></span><br><span class="line">    Stream&lt;String&gt; streamMap2 = map.keySet().stream();</span><br><span class="line">    <span class="comment">//Map转换成Collection&lt;String&gt;</span></span><br><span class="line">    Stream&lt;String&gt; streamMap3 = map.values().stream();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Stream中的静态方法<code>of()</code>获取流：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Stream&lt;String&gt; stream = Stream.of(<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>, <span class="string">&quot;cc&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    Integer[] arr = &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>&#125;;</span><br><span class="line">    Stream&lt;Integer&gt; streamArr = Stream.of(arr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">///基本数据类型的数组不可以，会将整个数组看做一个元素进行操作</span></span><br><span class="line">    <span class="comment">/*int[] arr = &#123;1, 3, 2&#125;;</span></span><br><span class="line"><span class="comment">        Stream&lt;int[]&gt; streamArr = Stream.of(arr);*/</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="4-2-Stream的常用方法"><a href="#4-2-Stream的常用方法" class="headerlink" title="4.2 Stream的常用方法"></a>4.2 Stream的常用方法</h3><p>Stream流模型的操作很丰富，这里介绍一些常用的API。这些方法可以被分成两种：</p><table><thead><tr><th>方法名</th><th>作用</th><th>种类</th></tr></thead><tbody><tr><td>long count()</td><td>统计个数</td><td>终结</td></tr><tr><td>void forEach()</td><td>逐个处理</td><td>终结</td></tr><tr><td>Stream fiter()</td><td>过滤</td><td>函数拼接</td></tr><tr><td>Stream limit()</td><td>取用前几个</td><td>函数拼接</td></tr><tr><td>Stream skip()</td><td>跳过前几个</td><td>函数拼接</td></tr><tr><td>Stream map()</td><td>映射</td><td>函数拼接</td></tr><tr><td>Stream concat()</td><td>组合</td><td>函数拼接</td></tr></tbody></table><ul><li>终结方法：返回值类型不再是Stream类型的方法，不再支持销式调用。本小节中，终结方法包括<code>count</code>和<code>forEach</code>方法。</li><li>非终结方法：返回值送型仍然是Stream送型的方法，支持链式调用。（除了终结方法外，其余方法均为非终结方法</li></ul><p>注意：</p><ol><li>Stream只能操作一次</li><li>Stream方法返回的是新的流</li><li>Stream不调用终结方法，中间的操作不会执行</li></ol><h4 id="4-2-1-forEach方法"><a href="#4-2-1-forEach方法" class="headerlink" title="4.2.1 forEach方法"></a>4.2.1 forEach方法</h4><p>遍历元素并打印：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">forEach</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    Collections.addAll(list, <span class="string">&quot;迪丽热巴&quot;</span>, <span class="string">&quot;宋远桥&quot;</span>, <span class="string">&quot;苏星河&quot;</span>,<span class="string">&quot;老子&quot;</span>,<span class="string">&quot;庄子&quot;</span>,<span class="string">&quot;孙子&quot;</span>);</span><br><span class="line">    <span class="comment">//Lambda表达式</span></span><br><span class="line">    list.stream().forEach(str -&gt; System.out.println(str));</span><br><span class="line">    <span class="comment">//方法引用</span></span><br><span class="line">    list.stream().forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-2-count方法"><a href="#4-2-2-count方法" class="headerlink" title="4.2.2 count方法"></a>4.2.2 count方法</h4><p>计算元素个数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">count</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    Collections.addAll(list, <span class="string">&quot;迪丽热巴&quot;</span>, <span class="string">&quot;宋远桥&quot;</span>, <span class="string">&quot;苏星河&quot;</span>,<span class="string">&quot;老子&quot;</span>,<span class="string">&quot;庄子&quot;</span>,<span class="string">&quot;孙子&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> list.stream().count();</span><br><span class="line">    System.out.println(<span class="string">&quot;count = &quot;</span> + count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-3-filter方法"><a href="#4-2-3-filter方法" class="headerlink" title="4.2.3 filter方法"></a>4.2.3 filter方法</h4><p>获取<strong>名字为3个字的人名</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">filter</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    Collections.addAll(list, <span class="string">&quot;迪丽热巴&quot;</span>, <span class="string">&quot;宋远桥&quot;</span>, <span class="string">&quot;苏星河&quot;</span>,<span class="string">&quot;老子&quot;</span>,<span class="string">&quot;庄子&quot;</span>,<span class="string">&quot;孙子&quot;</span>);</span><br><span class="line"></span><br><span class="line">    list.stream()</span><br><span class="line">        .filter(name -&gt; name.length() == <span class="number">3</span>)</span><br><span class="line">        .forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-limit方法"><a href="#4-2-4-limit方法" class="headerlink" title="4.2.4 limit方法"></a>4.2.4 limit方法</h4><p>截取前三个人：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">limit</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    Collections.addAll(list, <span class="string">&quot;迪丽热巴&quot;</span>, <span class="string">&quot;宋远桥&quot;</span>, <span class="string">&quot;苏星河&quot;</span>,<span class="string">&quot;老子&quot;</span>,<span class="string">&quot;庄子&quot;</span>,<span class="string">&quot;孙子&quot;</span>);</span><br><span class="line"></span><br><span class="line">    list.stream()</span><br><span class="line">        .limit(<span class="number">3</span>)</span><br><span class="line">        .forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-5-skip方法"><a href="#4-2-5-skip方法" class="headerlink" title="4.2.5 skip方法"></a>4.2.5 skip方法</h4><p>跳过前三个人：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">skip</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    Collections.addAll(list, <span class="string">&quot;迪丽热巴&quot;</span>, <span class="string">&quot;宋远桥&quot;</span>, <span class="string">&quot;苏星河&quot;</span>,<span class="string">&quot;老子&quot;</span>,<span class="string">&quot;庄子&quot;</span>,<span class="string">&quot;孙子&quot;</span>);</span><br><span class="line"></span><br><span class="line">    list.stream()</span><br><span class="line">        .skip(<span class="number">3</span>)</span><br><span class="line">        .forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-6-map方法"><a href="#4-2-6-map方法" class="headerlink" title="4.2.6 map方法"></a>4.2.6 map方法</h4><p>String类型转换成Integer类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//初始化String类型的Stream</span></span><br><span class="line">    Stream&lt;String&gt; stringStream = Stream.of(<span class="string">&quot;11&quot;</span>,<span class="string">&quot;22&quot;</span>,<span class="string">&quot;33&quot;</span>);</span><br><span class="line">    <span class="comment">//转换成Integer类型，将元素+10的结果打印</span></span><br><span class="line">    stringStream</span><br><span class="line">        .map(Integer::parseInt)</span><br><span class="line">        .forEach(s -&gt; System.out.println(s+<span class="number">10</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-7-sorted方法"><a href="#4-2-7-sorted方法" class="headerlink" title="4.2.7 sorted方法"></a>4.2.7 sorted方法</h4><p>按照降序排列：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sorted</span><span class="params">()</span> &#123;</span><br><span class="line">    Stream&lt;Integer&gt; stream = Stream.of(<span class="number">33</span>,<span class="number">22</span>,<span class="number">11</span>,<span class="number">55</span>);</span><br><span class="line">    <span class="comment">//默认按照升序排列</span></span><br><span class="line">    <span class="comment">//stream.sorted().forEach(System.out::println);</span></span><br><span class="line">    <span class="comment">//按照降序排列</span></span><br><span class="line">    stream.sorted((a, b) -&gt; b-a)</span><br><span class="line">        .forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-8-distinct方法"><a href="#4-2-8-distinct方法" class="headerlink" title="4.2.8 distinct方法"></a>4.2.8 distinct方法</h4><p>去除重复元素：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">distinct</span><span class="params">()</span> &#123;</span><br><span class="line">    Stream&lt;Integer&gt; stream = Stream.of(<span class="number">33</span>, <span class="number">22</span>, <span class="number">11</span>, <span class="number">55</span>, <span class="number">22</span>, <span class="number">33</span>, <span class="number">55</span>);</span><br><span class="line"></span><br><span class="line">    stream.distinct()</span><br><span class="line">        .forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现自定义对象去重：</p><p>需要重写Person类的<code>equals()</code>方法和<code>hashCode()</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) o;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(name, person.name) &amp;&amp; Objects.equals(age, person.age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(name, age);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>自定义对象去重：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">distinct</span><span class="params">()</span> &#123;</span><br><span class="line">    Stream&lt;Person&gt; stream = Stream.of(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;大黄&quot;</span>, <span class="number">20</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;大黄&quot;</span>, <span class="number">20</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;大黑&quot;</span>, <span class="number">18</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;大黑&quot;</span>, <span class="number">18</span>));</span><br><span class="line"></span><br><span class="line">    stream.distinct()</span><br><span class="line">        .forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-9-match方法"><a href="#4-2-9-match方法" class="headerlink" title="4.2.9 match方法"></a>4.2.9 match方法</h4><p>集合中的元素的匹配条件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">match</span><span class="params">()</span> &#123;</span><br><span class="line">    Stream&lt;Integer&gt; stream = Stream.of(<span class="number">5</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//boolean result = stream.allMatch(e -&gt; e &gt; 0);//allMatch:元素是否全部满足条件</span></span><br><span class="line">    <span class="comment">//boolean result = stream.anyMatch(e -&gt; e &gt; 5);//anyMatch:元表是否任意有一个满足条件</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> stream.noneMatch(e -&gt; e &lt; <span class="number">0</span>);<span class="comment">//noneMatch:是否全部不满足条件</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;result = &quot;</span> + result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-10-find方法"><a href="#4-2-10-find方法" class="headerlink" title="4.2.10 find方法"></a>4.2.10 find方法</h4><p>寻找集合中的第一个元素：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">find</span><span class="params">()</span> &#123;</span><br><span class="line">    Stream&lt;Integer&gt; stream = Stream.of(<span class="number">33</span>,<span class="number">11</span>,<span class="number">22</span>,<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    Optional&lt;Integer&gt; first = stream.findFirst();</span><br><span class="line">    <span class="comment">//Optional&lt;Integer&gt; first = stream.findAny(); //与findFirst()相同</span></span><br><span class="line">    System.out.println(<span class="string">&quot;first.get() = &quot;</span> + first.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-11-max和min方法"><a href="#4-2-11-max和min方法" class="headerlink" title="4.2.11 max和min方法"></a>4.2.11 max和min方法</h4><p>分别获取最大值、最小值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">minAndMax</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//按照某种排序(升序或者降序)后，获取集合最后一个元素</span></span><br><span class="line">    Optional&lt;Integer&gt; max = Stream.of(<span class="number">5</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">1</span>).max((o1, o2) -&gt; o1 - o2);</span><br><span class="line">    System.out.println(<span class="string">&quot;max.get() = &quot;</span> + max.get());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//按照某种排序(升序或者降序)后，获取集合第一个元素</span></span><br><span class="line">    Optional&lt;Integer&gt; min = Stream.of(<span class="number">5</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">1</span>).min((o1, o2) -&gt; o1 - o2);</span><br><span class="line">    System.out.println(<span class="string">&quot;min.get() = &quot;</span> + min.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-12-reduce方法"><a href="#4-2-12-reduce方法" class="headerlink" title="4.2.12 reduce方法"></a>4.2.12 reduce方法</h4><p>获取集合的总和：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">()</span> &#123;</span><br><span class="line">    Stream&lt;Integer&gt; stream = Stream.of(<span class="number">4</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Lambda表达式</span></span><br><span class="line">    <span class="comment">//Integer reduce = stream.reduce(0, (sum, num) -&gt; sum + num);</span></span><br><span class="line">    <span class="comment">//方法引用</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">reduce</span> <span class="operator">=</span> stream.reduce(<span class="number">0</span>, Integer::sum);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;reduce = &quot;</span> + reduce);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-13-map和reduce组合使用"><a href="#4-2-13-map和reduce组合使用" class="headerlink" title="4.2.13 map和reduce组合使用"></a>4.2.13 map和reduce组合使用</h4><p>求年龄总和：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">reduceAndMap</span><span class="params">()</span> &#123;</span><br><span class="line">    Stream&lt;Person&gt; stream = Stream.of(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;刘德许&quot;</span>, <span class="number">58</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;张学友&quot;</span>, <span class="number">56</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;郭富城&quot;</span>, <span class="number">54</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;黎明&quot;</span>, <span class="number">52</span>));</span><br><span class="line"></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">reduce</span> <span class="operator">=</span> stream</span><br><span class="line">        <span class="comment">//.map(person -&gt; person.getAge()) //Lambda表达式</span></span><br><span class="line">        .map(Person::getAge) <span class="comment">//方法引用</span></span><br><span class="line">        .reduce(<span class="number">0</span>, Integer::sum);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;reduce = &quot;</span> + reduce);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-14-mapTolnt方法"><a href="#4-2-14-mapTolnt方法" class="headerlink" title="4.2.14 mapTolnt方法"></a>4.2.14 mapTolnt方法</h4><p>如果需要将<code>Stream&lt;Integer&gt;</code>中的<code>Integer</code>类型数据转成<code>int</code>类型，可以使用mapToInt方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">map2Int</span><span class="params">()</span> &#123;</span><br><span class="line">    Stream&lt;Integer&gt; stream = Stream.of(<span class="number">4</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//转换成基本类型int</span></span><br><span class="line">    <span class="comment">//IntStream intStream = stream.mapToInt(a -&gt; a.intValue()); //Lambda表达式</span></span><br><span class="line">    <span class="type">IntStream</span> <span class="variable">intStream</span> <span class="operator">=</span> stream.mapToInt(Integer::intValue); <span class="comment">//方法引用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历打印</span></span><br><span class="line">    intStream.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-15-concat方法"><a href="#4-2-15-concat方法" class="headerlink" title="4.2.15 concat方法"></a>4.2.15 concat方法</h4><p>如果有两个流，希望合并成为一个流，那么可以使用Stream接口的静态方法<code>concat</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">concat</span><span class="params">()</span> &#123;</span><br><span class="line">    Stream&lt;String&gt; stream1 = Stream.of(<span class="string">&quot;大黄&quot;</span>);</span><br><span class="line">    Stream&lt;String&gt; stream2 = Stream.of(<span class="string">&quot;大黑&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Stream&lt;String&gt; concat = Stream.concat(stream1, stream2);</span><br><span class="line"></span><br><span class="line">    concat.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-16-综合案例"><a href="#4-2-16-综合案例" class="headerlink" title="4.2.16 综合案例"></a>4.2.16 综合案例</h4><ol><li>第一个队伍只要名字为3个字的成员姓名；</li><li>第一个队伍筛选之后只要前3个人；</li><li>第二个队伍只要姓张的成员姓名；</li><li>第二个队伍筛选之后不要前2个人；</li><li>将两个队伍合并为一个队伍；</li><li>根据姓名创建Person对象；</li><li>打印整个队伍的Person对象信息。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//第一个队伍</span></span><br><span class="line">    List&lt;String&gt; list1 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">7</span>);</span><br><span class="line">    Collections.addAll(list1, <span class="string">&quot;迪丽热巴&quot;</span>, <span class="string">&quot;宋远桥&quot;</span>, <span class="string">&quot;苏星河&quot;</span>, <span class="string">&quot;老子&quot;</span>, <span class="string">&quot;庄子&quot;</span>, <span class="string">&quot;孙子&quot;</span>, <span class="string">&quot;洪七公&quot;</span>);</span><br><span class="line">    <span class="comment">//第二个队伍</span></span><br><span class="line">    List&lt;String&gt; list2 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">7</span>);</span><br><span class="line">    Collections.addAll(list2, <span class="string">&quot;古力娜扎&quot;</span>, <span class="string">&quot;张无忌&quot;</span>, <span class="string">&quot;张三丰&quot;</span>, <span class="string">&quot;赵丽颗&quot;</span>, <span class="string">&quot;张二狗&quot;</span>, <span class="string">&quot;张天爱&quot;</span>, <span class="string">&quot;张三&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Stream&lt;String&gt; stream1 = list1.stream()</span><br><span class="line">        .filter(name -&gt; name.length() == <span class="number">3</span>)</span><br><span class="line">        .limit(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    Stream&lt;String&gt; stream2 = list2.stream()</span><br><span class="line">        .filter(name -&gt; name.contains(<span class="string">&quot;张&quot;</span>))</span><br><span class="line">        .skip(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    Stream.concat(stream1, stream2)</span><br><span class="line">        .map(name -&gt; <span class="keyword">new</span> <span class="title class_">Person</span>(name, <span class="number">18</span>))</span><br><span class="line">        .forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-collect方法"><a href="#4-3-collect方法" class="headerlink" title="4.3 collect方法"></a>4.3 collect方法</h3><h4 id="4-3-1-保存到集合中"><a href="#4-3-1-保存到集合中" class="headerlink" title="4.3.1 保存到集合中"></a>4.3.1 保存到集合中</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">save2Collection</span><span class="params">()</span> &#123;</span><br><span class="line">    Stream&lt;String&gt; stream1 = Stream.of(<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>, <span class="string">&quot;cc&quot;</span>);</span><br><span class="line">    List&lt;String&gt; list = stream1.collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    Stream&lt;String&gt; stream2 = Stream.of(<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>, <span class="string">&quot;cc&quot;</span>);</span><br><span class="line">    Set&lt;String&gt; set = stream2.collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">    Stream&lt;String&gt; stream3 = Stream.of(<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>, <span class="string">&quot;cc&quot;</span>);</span><br><span class="line">    <span class="comment">//收集到指定集合ArrayList中</span></span><br><span class="line">    ArrayList&lt;String&gt; collect = stream3</span><br><span class="line">        .collect(Collectors.toCollection(ArrayList::<span class="keyword">new</span>));</span><br><span class="line"></span><br><span class="line">    Stream&lt;String&gt; stream4 = Stream.of(<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>, <span class="string">&quot;cc&quot;</span>, <span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>, <span class="string">&quot;cc&quot;</span>);</span><br><span class="line">    <span class="comment">//收集到指定集合hashSet中，并且会去除重复元素</span></span><br><span class="line">    HashSet&lt;String&gt; hashSet = stream4</span><br><span class="line">        .collect(Collectors.toCollection(HashSet::<span class="keyword">new</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-2-保存到数组中"><a href="#4-3-2-保存到数组中" class="headerlink" title="4.3.2 保存到数组中"></a>4.3.2 保存到数组中</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">save2Array</span><span class="params">()</span> &#123;</span><br><span class="line">    Stream&lt;String&gt; stream = Stream.of(<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>, <span class="string">&quot;cc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//需要手动转换到相应的数据类型</span></span><br><span class="line">    <span class="comment">//String[] array = (String[]) stream.toArray();</span></span><br><span class="line"></span><br><span class="line">    String[] array = stream.toArray(String[]::<span class="keyword">new</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-2-聚合计算"><a href="#4-3-2-聚合计算" class="headerlink" title="4.3.2 聚合计算"></a>4.3.2 聚合计算</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Stream&lt;Student&gt; stream = Stream.of(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黄&quot;</span>, <span class="number">20</span>, <span class="number">88</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黑&quot;</span>, <span class="number">18</span>, <span class="number">90</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大白&quot;</span>, <span class="number">22</span>, <span class="number">75</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大红&quot;</span>, <span class="number">25</span>, <span class="number">78</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取最大得分</span></span><br><span class="line">    <span class="comment">/*Optional&lt;Student&gt; max = stream</span></span><br><span class="line"><span class="comment">                .collect(Collectors.maxBy((s1, s2) -&gt; s1.getScore() - s2.getScore()));</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;max.get() = &quot; + max.get());*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取最小得分</span></span><br><span class="line">    <span class="comment">/*Optional&lt;Student&gt; min = stream</span></span><br><span class="line"><span class="comment">                .collect(Collectors.minBy((s1, s2) -&gt; s1.getScore() - s2.getScore()));</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;min.get() = &quot; + min.get());*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//得分总和</span></span><br><span class="line">    <span class="comment">/*Integer sum = stream.collect(Collectors.summingInt(Student::getScore));</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;sum = &quot; + sum);*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//得分平均</span></span><br><span class="line">    <span class="comment">/*Double avg = stream.collect(Collectors.averagingInt(Student::getScore));</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;avg = &quot; + avg);*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//统计数量</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> stream.collect(Collectors.counting());</span><br><span class="line">    System.out.println(<span class="string">&quot;count = &quot;</span> + count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-3-分组"><a href="#4-3-3-分组" class="headerlink" title="4.3.3 分组"></a>4.3.3 分组</h4><p>通过年龄分组：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Stream&lt;Student&gt; stream = Stream.of(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黄&quot;</span>, <span class="number">20</span>, <span class="number">88</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黑&quot;</span>, <span class="number">18</span>, <span class="number">90</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大白&quot;</span>, <span class="number">20</span>, <span class="number">75</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大红&quot;</span>, <span class="number">18</span>, <span class="number">78</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//通过年龄分组</span></span><br><span class="line">    Map&lt;Integer, List&lt;Student&gt;&gt; groupByAge = stream.collect(Collectors.groupingBy(Student::getAge));</span><br><span class="line"></span><br><span class="line">    groupByAge.forEach((age, studentList) -&gt; System.out.println(age + <span class="string">&quot; = &quot;</span> + studentList));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-4-多级分组"><a href="#4-3-4-多级分组" class="headerlink" title="4.3.4 多级分组"></a>4.3.4 多级分组</h4><p>先通过年龄分组，之后再通过得分分组：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Stream&lt;Student&gt; stream = Stream.of(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黄&quot;</span>, <span class="number">20</span>, <span class="number">88</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黑&quot;</span>, <span class="number">18</span>, <span class="number">55</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大白&quot;</span>, <span class="number">20</span>, <span class="number">59</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大红&quot;</span>, <span class="number">18</span>, <span class="number">40</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先通过年龄分组，之后再通过得分分组</span></span><br><span class="line">    Map&lt;Integer, Map&lt;String, List&lt;Student&gt;&gt;&gt; map = stream</span><br><span class="line">        .collect(Collectors.groupingBy(</span><br><span class="line">            Student::getAge,</span><br><span class="line">            Collectors.groupingBy((student) -&gt;</span><br><span class="line">                                  student.getScore() &gt;= <span class="number">60</span> ? <span class="string">&quot;及格&quot;</span> : <span class="string">&quot;不及格&quot;</span></span><br><span class="line">                                 )));</span><br><span class="line"></span><br><span class="line">    map.forEach((age, groupByScore) -&gt; &#123;</span><br><span class="line">        groupByScore.forEach((isPass, studentList) -&gt;</span><br><span class="line">                             System.out.println(age + <span class="string">&quot; : &quot;</span> + isPass + <span class="string">&quot; : &quot;</span> + studentList));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-5-分区"><a href="#4-3-5-分区" class="headerlink" title="4.3.5 分区"></a>4.3.5 分区</h4><p>通过Student是否及格，分区：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Stream&lt;Student&gt; stream = Stream.of(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黄&quot;</span>, <span class="number">20</span>, <span class="number">88</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黑&quot;</span>, <span class="number">18</span>, <span class="number">55</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大白&quot;</span>, <span class="number">20</span>, <span class="number">59</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大红&quot;</span>, <span class="number">18</span>, <span class="number">40</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    Map&lt;Boolean, List&lt;Student&gt;&gt; collect = stream.collect(Collectors</span><br><span class="line">                                                         .partitioningBy(student -&gt; student.getScore() &gt;= <span class="number">60</span>));</span><br><span class="line"></span><br><span class="line">    collect.forEach((bool, studentList) -&gt;</span><br><span class="line">                    System.out.println(bool + <span class="string">&quot; = &quot;</span> + studentList));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-6-拼接"><a href="#4-3-6-拼接" class="headerlink" title="4.3.6 拼接"></a>4.3.6 拼接</h4><p>通过<code>,</code>将Student的名字拼接：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Stream&lt;Student&gt; stream = Stream.of(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黄&quot;</span>, <span class="number">20</span>, <span class="number">88</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黑&quot;</span>, <span class="number">18</span>, <span class="number">55</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大白&quot;</span>, <span class="number">20</span>, <span class="number">59</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大红&quot;</span>, <span class="number">18</span>, <span class="number">40</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">join</span> <span class="operator">=</span> stream</span><br><span class="line">        .map(Student::getName)</span><br><span class="line">        .collect(Collectors.joining(<span class="string">&quot;,&quot;</span>));</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;join = &quot;</span> + join);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>增加前缀 <code>start:</code>和后缀 <code>:end</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Stream&lt;Student&gt; stream = Stream.of(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黄&quot;</span>, <span class="number">20</span>, <span class="number">88</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大黑&quot;</span>, <span class="number">18</span>, <span class="number">55</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大白&quot;</span>, <span class="number">20</span>, <span class="number">59</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大红&quot;</span>, <span class="number">18</span>, <span class="number">40</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">join</span> <span class="operator">=</span> stream</span><br><span class="line">        .map(Student::getName)</span><br><span class="line">        .collect(Collectors.joining(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;start:&quot;</span>, <span class="string">&quot;:end&quot;</span>));</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;join = &quot;</span> + join);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-并行的Stream流"><a href="#4-4-并行的Stream流" class="headerlink" title="4.4 并行的Stream流"></a>4.4 并行的Stream流</h3><h4 id="4-4-1-获取并行Stream流"><a href="#4-4-1-获取并行Stream流" class="headerlink" title="4.4.1 获取并行Stream流"></a>4.4.1 获取并行Stream流</h4><p>集合转为并行Stream流：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    List&lt;String&gt; list1 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//方式一:</span></span><br><span class="line">    Stream&lt;String&gt; stringStream = list1.parallelStream();</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; list2 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//方式二:</span></span><br><span class="line">    Stream&lt;String&gt; parallel = list2.stream().parallel();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并行Stream测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Stream&lt;Integer&gt; stream = Stream.of(<span class="number">5</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    stream.parallel().forEach(num -&gt; </span><br><span class="line">                              System.out.println(Thread.currentThread() + <span class="string">&quot; num = &quot;</span> + num));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>串行Stream是单线程，效率没有多线程的并行Stream高</p><p>Stream并行处理的过程会分而治之，也就是将一个大任务切分成多个小任务，这表示每个任务都是一个操作</p></blockquote><h4 id="4-4-2-并行Stream线程安全问题"><a href="#4-4-2-并行Stream线程安全问题" class="headerlink" title="4.4.2 并行Stream线程安全问题"></a>4.4.2 并行Stream线程安全问题</h4><p>ArrayList集合是线程不安全的，</p><p>在并行Stream中，对ArrayList的操作加同步锁：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">arrayList</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    IntStream.rangeClosed(<span class="number">1</span>,<span class="number">1000</span>) <span class="comment">//生成1~1000的流</span></span><br><span class="line">        .parallel().forEach(num -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (o) &#123;</span><br><span class="line">            list.add(num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;list.size() = &quot;</span> + list.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用线程安全的Vector集合：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">vector</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; vector = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    IntStream.rangeClosed(<span class="number">1</span>,<span class="number">1000</span>) <span class="comment">//生成1~1000的流</span></span><br><span class="line">        .parallel().forEach(vector::add);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;vector.size() = &quot;</span> + vector.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用synchronizedList，构造一个线程安全的 List 对象：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">synchronizedList</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    List&lt;Integer&gt; synchronizedList = Collections.synchronizedList(list);</span><br><span class="line"></span><br><span class="line">    IntStream.rangeClosed(<span class="number">1</span>,<span class="number">1000</span>) <span class="comment">//生成1~1000的流</span></span><br><span class="line">        .parallel().forEach(synchronizedList::add);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;synchronizedList.size() = &quot;</span> + synchronizedList.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用collect方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">collect</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; list = IntStream.rangeClosed(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">        .parallel() <span class="comment">//并行Stream</span></span><br><span class="line">        .boxed() <span class="comment">//将基本类型转为包装类</span></span><br><span class="line">        .collect(Collectors.toList()); <span class="comment">//基本类型无法放入list中</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;list.size() = &quot;</span> + list.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-4-3-并行Stream的原理"><a href="#4-4-3-并行Stream的原理" class="headerlink" title="4.4.3 并行Stream的原理"></a>4.4.3 并行Stream的原理</h4><p>parallelStream使用的是Fork&#x2F;Join框架，Fork&#x2F;Join框架自JDK1.7引入，Fork&#x2F;Join框架可以将一个大任务所分为很<br>多小任到来异步执行。</p><p>主要包含三个模块：</p><ol><li>线程池：ForkJoinPool</li><li>任务对象：ForkJoinTask</li><li>执行任务的线程：ForkJoinWorkerThread</li></ol><p><strong>Fork&#x2F;Join框架原理</strong>：</p><ul><li><p>分治法：</p><ul><li>分而治之，将大任务分为多个小任务，小任务又分为更小的任务，直到符合某种条件后停止。再将多个小结果分别结合成大结果，最后汇聚成总结果</li></ul></li><li><p>工作窃取算法：</p><ul><li><p>Fork&#x2F;Join最核心的地方就是利用了现代硬件设备多核，在一个操作时候会有空闲的cpu,那么如何利用好这个空闲的cpu就成了提高性能的关键，<strong>工作窃取(work-stealing)算法</strong>就是整Fork&#x2F;Join框架的核心理念</p></li><li><p>Fork&#x2F;Join工作窃取(work-stealing)算法是指某个线程从其他队列里窃取任务来执行，</p></li></ul></li></ul></div><div class="story post-story"><h2 id="5-Optional类"><a href="#5-Optional类" class="headerlink" title="5.Optional类"></a>5.Optional类</h2><p>Optional是一个没有子类的工具类，Optional是一个可以为null的容器对象</p><p>它的作用主要就是为了解决避免Null检查，防止NullPointerException</p><h3 id="5-1-Optional的基本用法"><a href="#5-1-Optional的基本用法" class="headerlink" title="5.1 Optional的基本用法"></a>5.1 Optional的基本用法</h3><table><thead><tr><th>方法</th><th>效果</th><th></th></tr></thead><tbody><tr><td>Optional<T> of( T value )</td><td>只能传入值，不能传入null</td><td>静态方法</td></tr><tr><td>Optional<T> ofNullable( T value )</td><td>既可以传入值，又可以传入null</td><td>静态方法</td></tr><tr><td>Optional<T> empty()</td><td>返回一个无值(null)的Optional</td><td>静态方法</td></tr><tr><td>boolean isPresent()</td><td>判断是否有具体值，有值返回true，null返回flase</td><td>实例方法</td></tr><tr><td>T get()</td><td>获取值，为null则报错</td><td>实例方法</td></tr><tr><td>T orElse( T other )</td><td>获取值，为null则返回other的值</td><td>实例方法</td></tr></tbody></table><h3 id="5-2-Optional的高级用法"><a href="#5-2-Optional的高级用法" class="headerlink" title="5.2 Optional的高级用法"></a>5.2 Optional的高级用法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Optional&lt;String&gt; optional = Optional.of(<span class="string">&quot;凤姐&quot;</span>);</span><br><span class="line">    Optional&lt;String&gt; empty = Optional.empty();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果有值，则调用Lambda表达式</span></span><br><span class="line">    optional.ifPresent(value -&gt; System.out.println(<span class="string">&quot;有值: value = &quot;</span> + value));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果有值，则调用第一个参数的Lambda表达式</span></span><br><span class="line">    <span class="comment">//如果没有值，则调用第二个参数的Lambda表达式</span></span><br><span class="line">    <span class="comment">//注意：此方法为JDK9中新增的方法</span></span><br><span class="line">    optional.ifPresentOrElse(</span><br><span class="line">        value -&gt; System.out.println(<span class="string">&quot;有值: value = &quot;</span> + value),</span><br><span class="line">        () -&gt; System.out.println(<span class="string">&quot;没有值&quot;</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="6-新日期时间API"><a href="#6-新日期时间API" class="headerlink" title="6.新日期时间API"></a>6.新日期时间API</h2><p>旧版日期时间API存在的问题：</p><ol><li>设计很差：在面java.util和java.sql的包中都有日期类，java.util.Date同时包含日期和时间，而java.sql.Date仅包含日期。此外用于格式化和解析的类在java.text包中定义</li><li>非线程安全：java.util.Date是非线程安全的，所有的日期类都是可变的，这是java日期类最大的问题之一</li><li>时区处理麻烦：日期类并不提供国际化，没有时区支持，因java引入了java.util.Calendari和java.util.TimeZone类，但他们同样存在上述所有的问题</li></ol><p>新日期时间API介绍：</p><p>JDK8中增加了一套全新的日期时间API，这套API设计合理，是线程安全的。新的日期及时间API位于java.time<br>包中，下面些关键类。</p><ul><li><code>LocalDate</code>：表示日期，包含年月日，格式为 2023-02-06</li><li><code>LocalTime</code>：表示时间，包含时分秒，格式为18:58:54.158549300</li><li><code>LocalDateTime</code>：表示日期时间，包含年月日，时分秒，格式为 2023-02-06T18:58:54.158</li><li><code>DateTimeFormatter</code>：日期时间格式化类</li><li><code>Instant</code>：时间戳，表示一个特定的时间瞬间</li><li><code>Duration</code>：用于计算2个时间(LocalTime，时分秒)的距高</li><li><code>Period</code>：用于计算2个日期(LocalDate，年月日)的距离</li><li><code>ZonedDateTime</code>：包含时区的时间</li></ul><h3 id="6-1-LocalDate"><a href="#6-1-LocalDate" class="headerlink" title="6.1 LocalDate"></a>6.1 LocalDate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">localDate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//指定年月日</span></span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> LocalDate.of(<span class="number">2023</span>, <span class="number">2</span>, <span class="number">6</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;date = &quot;</span> + date);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取今天的年月日</span></span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">now</span> <span class="operator">=</span> LocalDate.now();</span><br><span class="line">    System.out.println(<span class="string">&quot;现在日期 = &quot;</span> + now);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;今年 = &quot;</span> + now.getYear());</span><br><span class="line">    System.out.println(<span class="string">&quot;今月 = &quot;</span> + now.getMonthValue());</span><br><span class="line">    System.out.println(<span class="string">&quot;今日 = &quot;</span> + now.getDayOfMonth());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-2-LocalTime"><a href="#6-2-LocalTime" class="headerlink" title="6.2 LocalTime"></a>6.2 LocalTime</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">localTime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//指定20点30分30秒</span></span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalTime.of(<span class="number">20</span>, <span class="number">30</span>, <span class="number">30</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;time = &quot;</span> + time);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取现在的时间</span></span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalTime.now();</span><br><span class="line">    System.out.println(<span class="string">&quot;现在时间 = &quot;</span> + now);</span><br><span class="line"></span><br><span class="line">    System.out.println(now.getHour() + <span class="string">&quot;时&quot;</span>);</span><br><span class="line">    System.out.println(now.getMinute() + <span class="string">&quot;分&quot;</span>);</span><br><span class="line">    System.out.println(now.getSecond() + <span class="string">&quot;秒&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-3-LocalDateTime"><a href="#6-3-LocalDateTime" class="headerlink" title="6.3 LocalDateTime"></a>6.3 LocalDateTime</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">localDateTime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//指定2023-02-06 00:00</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">dateTime</span> <span class="operator">=</span> LocalDateTime.of(<span class="number">2023</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;dateTime = &quot;</span> + dateTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取现在的日期时间，同理也可以获取相应的年月日时分秒</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    System.out.println(<span class="string">&quot;now = &quot;</span> + now);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改日期后会返回一个新的日期对象，不会修改之前的日期对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改年份</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">otherDateTime</span> <span class="operator">=</span> now.withYear(<span class="number">2025</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//增加2年</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">dateTime1</span> <span class="operator">=</span> now.plusYears(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//减去2年</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">dateTime2</span> <span class="operator">=</span> now.minusYears(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//now时间是否在dateTime1之后</span></span><br><span class="line">    System.out.println(now.isAfter(dateTime1));</span><br><span class="line">    <span class="comment">//now时间是否在dateTime2之前</span></span><br><span class="line">    System.out.println(now.isBefore(dateTime2));</span><br><span class="line">    <span class="comment">//now时间是否等于dateTime1</span></span><br><span class="line">    System.out.println(now.isEqual(dateTime1));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-4-时间的格式化与解析"><a href="#6-4-时间的格式化与解析" class="headerlink" title="6.4 时间的格式化与解析"></a>6.4 时间的格式化与解析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">//指定格式，一定要注意大小写！！</span></span><br><span class="line">    <span class="type">DateTimeFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//格式化</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">format</span> <span class="operator">=</span> now.format(formatter);</span><br><span class="line">    System.out.println(<span class="string">&quot;format = &quot;</span> + format);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">dateTime</span> <span class="operator">=</span> LocalDateTime.parse(format, formatter);</span><br><span class="line">    System.out.println(<span class="string">&quot;dateTime = &quot;</span> + dateTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-5-Instant"><a href="#6-5-Instant" class="headerlink" title="6.5 Instant"></a>6.5 Instant</h3><p>instant时间戳&#x2F;时间线，内部保存了从1970年1月1日00：00：00以来的秒和纳秒</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Instant</span> <span class="variable">now</span> <span class="operator">=</span> Instant.now();</span><br><span class="line">    System.out.println(<span class="string">&quot;now = &quot;</span> + now); <span class="comment">//2023-02-06T11:56:18.123353300Z</span></span><br><span class="line"></span><br><span class="line">    System.out.println(now.plusSeconds(<span class="number">20</span>)); <span class="comment">//加20秒</span></span><br><span class="line">    System.out.println(now.minusSeconds(<span class="number">20</span>)); <span class="comment">//减去20秒</span></span><br><span class="line"></span><br><span class="line">    System.out.println(now.getEpochSecond()); <span class="comment">//得到秒</span></span><br><span class="line">    System.out.println(now.getNano()); <span class="comment">//得到纳秒</span></span><br><span class="line"></span><br><span class="line">    System.out.println(System.currentTimeMillis()); <span class="comment">//时间戳</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-6-计算日期时间差"><a href="#6-6-计算日期时间差" class="headerlink" title="6.6 计算日期时间差"></a>6.6 计算日期时间差</h3><p>Duration&#x2F;Period类：计算日期时间差。</p><ul><li><code>Duration</code>：用于计算2个时间(LocalTime,时分秒)的距离</li><li><code>Period</code>：用于计算2个日期(LocalDate,年月日)的距离</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">duration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalTime.now();</span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalTime.of(<span class="number">12</span>, <span class="number">30</span>, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Duration</span> <span class="variable">duration</span> <span class="operator">=</span> Duration.between(now, time);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;相差天数 = &quot;</span> + duration.toDays());</span><br><span class="line">    System.out.println(<span class="string">&quot;相差小时 = &quot;</span> + duration.toHours());</span><br><span class="line">    System.out.println(<span class="string">&quot;相差分钟 = &quot;</span> + duration.toMinutes());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">period</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">now</span> <span class="operator">=</span> LocalDate.now();</span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> LocalDate.of(<span class="number">2020</span>, <span class="number">8</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="type">Period</span> <span class="variable">period</span> <span class="operator">=</span> Period.between(date,now);</span><br><span class="line">    System.out.println(<span class="string">&quot;相差的年 = &quot;</span> + period.getYears());</span><br><span class="line">    System.out.println(<span class="string">&quot;相差的月 = &quot;</span> + period.getMonths());</span><br><span class="line">    System.out.println(<span class="string">&quot;相差的日 = &quot;</span> + period.getDays());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-7-时间矫正器"><a href="#6-7-时间矫正器" class="headerlink" title="6.7 时间矫正器"></a>6.7 时间矫正器</h3><p>有时我们可能需要获取例如：将日期调整到下一个月的第一天等操作。可以通过时间校正器来进行。</p><ul><li><code>TemporalAdjuster</code>：时间校正器</li><li><code>TemporalAdjusters</code>：该类通过静态方法提供了大量的常用<code>TemporalAdjuster</code>的实现</li></ul><p>设置为下个月的第一天：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//方式一:Lambda表达式</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">firstDayOfNextMonth</span> <span class="operator">=</span> now.with(temporal -&gt; &#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">dateTime</span> <span class="operator">=</span> (LocalDateTime) temporal;</span><br><span class="line">        <span class="comment">//设置为下个月的第一天</span></span><br><span class="line">        <span class="keyword">return</span> dateTime.plusMonths(<span class="number">1</span>).withDayOfMonth(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(<span class="string">&quot;firstDayOfNextMonth = &quot;</span> + firstDayOfNextMonth);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//方式二:使用TemporalAdjusters工具类</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">firstDayOfNextMonth1</span> <span class="operator">=</span> now</span><br><span class="line">        .with(TemporalAdjusters.firstDayOfNextMonth());</span><br><span class="line">    System.out.println(<span class="string">&quot;firstDayOfNextMonth1 = &quot;</span> + firstDayOfNextMonth1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-8-日期时间的时区"><a href="#6-8-日期时间的时区" class="headerlink" title="6.8 日期时间的时区"></a>6.8 日期时间的时区</h3><p>Java8中加入了对时区的支持，LocalDate、LocalTime、LocalDateTime是不带时区的，带时区的日期时间类分别<br>为：ZonedDate、ZonedTime、ZonedDateTime</p><p>其中每个时区都对应看ID，ID的格式为”区域&#x2F;城市”，例如：Asia&#x2F;Shanghai等。</p><p>Zoneld：该类中包含了所有的时区信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//获取所有时区的ID</span></span><br><span class="line">    <span class="comment">//ZoneId.getAvailableZoneIds().forEach(System.out::println);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建世界标准时间</span></span><br><span class="line">    <span class="type">ZonedDateTime</span> <span class="variable">standard</span> <span class="operator">=</span> ZonedDateTime.now(Clock.systemUTC());</span><br><span class="line">    System.out.println(<span class="string">&quot;standard = &quot;</span> + standard);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取当地带有时区的时间</span></span><br><span class="line">    <span class="type">ZonedDateTime</span> <span class="variable">now</span> <span class="operator">=</span> ZonedDateTime.now();</span><br><span class="line">    System.out.println(<span class="string">&quot;now = &quot;</span> + now);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用指定时区创建时间</span></span><br><span class="line">    <span class="type">ZonedDateTime</span> <span class="variable">AmericaDateTime</span> <span class="operator">=</span> ZonedDateTime.now(ZoneId.of(<span class="string">&quot;America/Vancouver&quot;</span>));</span><br><span class="line">    System.out.println(<span class="string">&quot;AmericaDateTime = &quot;</span> + AmericaDateTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="7-注解"><a href="#7-注解" class="headerlink" title="7.注解"></a>7.注解</h2><h3 id="7-1-重复注解"><a href="#7-1-重复注解" class="headerlink" title="7.1 重复注解"></a>7.1 重复注解</h3><p>自从Java 5中引入注解以来，注解开始变得非常流行，并在各个框架和项目中被广泛使用。不过注解有一个很大的<br>限制是：在<strong>同一个地方不能多次使用同一个注解</strong>，JDK 8引入了重复注解的概念，允许在同一个地方多次使用同一<br>个注解。在JDK8中使用<code>@Repeatable</code>注解定义重复注解</p><p>重复注解使用步骤：</p><ol><li><p>定义重复的注解容器注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//重复注解容器</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span> <span class="comment">//vm运行期间也会保留注解，可以使用反射机制读取注解的信息</span></span><br><span class="line"><span class="meta">@interface</span> MyTests &#123;</span><br><span class="line">    MyTest[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>定义一个可以重复的注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可重复的注解</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Repeatable(MyTests.class)</span></span><br><span class="line"><span class="meta">@interface</span> MyTest &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置多个重复的注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MyTest(&quot;test1&quot;)</span></span><br><span class="line"><span class="meta">@MyTest(&quot;test2&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="meta">@MyTest(&quot;test3&quot;)</span></span><br><span class="line">    <span class="meta">@MyTest(&quot;test4&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>解析重复注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="comment">//获取类上的重复注解</span></span><br><span class="line">        <span class="comment">//getAnnotationsByType()为获取重复注解的方法</span></span><br><span class="line">        MyTest[] annotationsByType = Test.class</span><br><span class="line">            .getAnnotationsByType(MyTest.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (MyTest myTest : annotationsByType) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;myTest = &quot;</span> + myTest);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取类中方法上的重复注解</span></span><br><span class="line">        MyTest[] myTests = Test.class.getMethod(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">            .getAnnotationsByType(MyTest.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (MyTest myTest : myTests) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;myTest = &quot;</span> + myTest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="7-2-类型注解"><a href="#7-2-类型注解" class="headerlink" title="7.2 类型注解"></a>7.2 类型注解</h3><p>JDK 8为<code>@Target</code>元注解新增了两种类型：<code>TYPE_PARAMETER</code>、<code>TYPE_USE</code>,</p><ul><li><code>TYPE_PARAMETER</code>：表示该注解能写在类型参故的声明语句中。<ul><li>类型参数声明，如：<code>&lt;T&gt;</code>、<code>&lt;T extends Person&gt;</code></li></ul></li><li><code>TYPE_USE</code>：表示注解可以再任何用到类型的地方使用</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test02</span> &lt;<span class="meta">@TypeParam</span> T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="meta">@NotNull</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;<span class="meta">@TypeParam</span> E <span class="keyword">extends</span> <span class="title class_">Integer</span>&gt; <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="meta">@NotNull</span> <span class="type">int</span> num)</span> &#123;</span><br><span class="line">         <span class="meta">@NotNull</span> <span class="type">Integer</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE_PARAMETER)</span></span><br><span class="line"><span class="meta">@interface</span> TypeParam &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE_USE)</span></span><br><span class="line"><span class="meta">@interface</span> NotNull &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 基础 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1145. 二叉树着色游戏</title>
      <link href="/2023/02/03/%E6%AF%8F%E6%97%A5LeetCode/2023-2/1145%20%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9D%80%E8%89%B2%E6%B8%B8%E6%88%8F/"/>
      <url>/2023/02/03/%E6%AF%8F%E6%97%A5LeetCode/2023-2/1145%20%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9D%80%E8%89%B2%E6%B8%B8%E6%88%8F/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>有两位极客玩家参与了一场「二叉树着色」的游戏。游戏中，给出二叉树的根节点 root，树上总共有 n 个节点，且 n 为奇数，其中每个节点上的值从 1 到 n 各不相同。</p><p>最开始时：</p><p>「一号」玩家从 [1, n] 中取一个值 x（1 &lt;&#x3D; x &lt;&#x3D; n）；<br>「二号」玩家也从 [1, n] 中取一个值 y（1 &lt;&#x3D; y &lt;&#x3D; n）且 y !&#x3D; x。<br>「一号」玩家给值为 x 的节点染上红色，而「二号」玩家给值为 y 的节点染上蓝色。</p><p>之后两位玩家轮流进行操作，「一号」玩家先手。每一回合，玩家选择一个被他染过色的节点，将所选节点一个 未着色 的邻节点（即左右子节点、或父节点）进行染色（「一号」玩家染红色，「二号」玩家染蓝色）。</p><p>如果（且仅在此种情况下）当前玩家无法找到这样的节点来染色时，其回合就会被跳过。</p><p>若两个玩家都没有可以染色的节点时，游戏结束。着色节点最多的那位玩家获得胜利 ✌️。</p><p>现在，假设你是「二号」玩家，根据所给出的输入，假如存在一个 y 值可以确保你赢得这场游戏，则返回 true ；若无法获胜，就请返回 false 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2019/08/01/1480-binary-tree-coloring-game.png" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2019/08/01/1480-binary-tree-coloring-game.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 50%;" /><blockquote><p>输入：root &#x3D; [1,2,3,4,5,6,7,8,9,10,11], n &#x3D; 11, x &#x3D; 3<br>输出：true<br>解释：第二个玩家可以选择值为 2 的节点。</p></blockquote></div><div class="story post-story"><h2 id="思路：DFS"><a href="#思路：DFS" class="headerlink" title="思路：DFS"></a>思路：DFS</h2><p>无非存在两种情况：</p><ul><li><p>把红色结点的父节点染成蓝色</p><p>无需计算蓝色的总数，只需要先获取红色的总数即可</p><p>红色总数：包括红色主结点及一下的子节点总数</p><p>蓝色总数：<code>countBlue = n - countRed</code></p></li><li><p>把红色结点的子节点染成蓝色</p><p>先获取蓝色的总数，无需计算红色的总数</p><p>蓝色总数：<code>countBlue = max(红色的左结点蓝色的总数, 红色的右结点蓝色的总数)</code></p><p>红色总数：<code>countRed = n - countBlue</code></p></li></ul><p>上述情况中，只要存在一种可以使<code>countBlue &gt; countRed</code>，则返回true</p><p>否则，返回false</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">btreeGameWinningMove</span><span class="params">(TreeNode* root, <span class="type">int</span> n, <span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> countRed = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> countBlue = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//找到val为x的结点</span></span><br><span class="line">        <span class="keyword">auto</span> xNode = <span class="built_in">getNodeByVal</span>(root, x);</span><br><span class="line">        <span class="comment">//获取xNode结点下的总结点数</span></span><br><span class="line">        countRed = <span class="built_in">getCount</span>(xNode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//给red的父节点染成蓝色的情况</span></span><br><span class="line">        <span class="keyword">if</span>(n - countRed &gt; countRed)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//获取xNode结点的 左右子节点 中 的 总结点数最大的结点数</span></span><br><span class="line">        countBlue = <span class="built_in">max</span>(<span class="built_in">getCount</span>(xNode-&gt;left), <span class="built_in">getCount</span>(xNode-&gt;right));</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//给red的某个子节点染成蓝色的情况</span></span><br><span class="line">        <span class="keyword">return</span> countBlue &gt; n-countBlue;         </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">TreeNode* <span class="title">getNodeByVal</span><span class="params">(TreeNode* root, <span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        queue&lt;TreeNode*&gt; queue;</span><br><span class="line">        queue.<span class="built_in">emplace</span>(root);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(!queue.<span class="built_in">empty</span>())&#123;</span><br><span class="line">            <span class="keyword">auto</span> node = queue.<span class="built_in">front</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(node-&gt;val == x)</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line"></span><br><span class="line">            queue.<span class="built_in">pop</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(node-&gt;left != <span class="literal">nullptr</span>)</span><br><span class="line">                queue.<span class="built_in">emplace</span>(node-&gt;left);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(node-&gt;right != <span class="literal">nullptr</span>)</span><br><span class="line">                queue.<span class="built_in">emplace</span>(node-&gt;right);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getCount</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        queue&lt;TreeNode*&gt; queue;</span><br><span class="line">        queue.<span class="built_in">emplace</span>(root);</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(!queue.<span class="built_in">empty</span>())&#123;</span><br><span class="line">            <span class="keyword">auto</span> node = queue.<span class="built_in">front</span>();</span><br><span class="line">            queue.<span class="built_in">pop</span>();</span><br><span class="line">            count++;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(node-&gt;left != <span class="literal">nullptr</span>)</span><br><span class="line">                queue.<span class="built_in">emplace</span>(node-&gt;left);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(node-&gt;right != <span class="literal">nullptr</span>)</span><br><span class="line">                queue.<span class="built_in">emplace</span>(node-&gt;right);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2325. 解密消息</title>
      <link href="/2023/02/01/%E6%AF%8F%E6%97%A5LeetCode/2023-2/2325%20%E8%A7%A3%E5%AF%86%E6%B6%88%E6%81%AF/"/>
      <url>/2023/02/01/%E6%AF%8F%E6%97%A5LeetCode/2023-2/2325%20%E8%A7%A3%E5%AF%86%E6%B6%88%E6%81%AF/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你字符串 key 和 message ，分别表示一个加密密钥和一段加密消息。解密 message 的步骤如下：</p><p>使用 key 中 26 个英文小写字母第一次出现的顺序作为替换表中的字母 顺序 。<br>将替换表与普通英文字母表对齐，形成对照表。<br>按照对照表 替换 message 中的每个字母。<br>空格 ‘ ‘ 保持不变。</p><p>例如，key &#x3D; “happy boy”（实际的加密密钥会包含字母表中每个字母 至少一次），据此，可以得到部分对照表（’h’ -&gt; ‘a’、’a’ -&gt; ‘b’、’p’ -&gt; ‘c’、’y’ -&gt; ‘d’、’b’ -&gt;</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2022/05/08/ex1new4.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2022/05/08/ex1new4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:67%;" /><blockquote><p>输入：key &#x3D; “the quick brown fox jumps over the lazy dog”, message &#x3D; “vkbs bs t suepuv”<br>输出：”this is a secret”<br>解释：对照表如上图所示。<br>提取 “the quick brown fox jumps over the lazy dog” 中每个字母的首次出现可以得到替换表。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">decodeMessage</span><span class="params">(string key, string message)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">char</span>&gt; <span class="title">map</span><span class="params">(<span class="number">26</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> pos = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; k : key)&#123;</span><br><span class="line">            <span class="keyword">if</span>(k == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> temp = k - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span>(map[temp] == <span class="number">0</span>)&#123;</span><br><span class="line">                map[temp] = pos++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string ans = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; m : message)&#123;</span><br><span class="line">            <span class="keyword">if</span>(m == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                ans.<span class="built_in">push_back</span>(m);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                ans.<span class="built_in">push_back</span>(map[m-<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n+m)，其中 m和n 分别是字符串 key 和 message 的长度</li><li>空间复杂度：O(C)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2319. 判断矩阵是否是一个 X 矩阵</title>
      <link href="/2023/01/31/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2319%20%E5%88%A4%E6%96%AD%E7%9F%A9%E9%98%B5%E6%98%AF%E5%90%A6%E6%98%AF%E4%B8%80%E4%B8%AA%20X%20%E7%9F%A9%E9%98%B5/"/>
      <url>/2023/01/31/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2319%20%E5%88%A4%E6%96%AD%E7%9F%A9%E9%98%B5%E6%98%AF%E5%90%A6%E6%98%AF%E4%B8%80%E4%B8%AA%20X%20%E7%9F%A9%E9%98%B5/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>如果一个正方形矩阵满足下述 全部 条件，则称之为一个 X 矩阵 ：</p><ul><li>矩阵对角线上的所有元素都 不是 0</li><li>矩阵中所有其他元素都是 0</li></ul><p>给你一个大小为 n x n 的二维整数数组 grid ，表示一个正方形矩阵。如果 grid 是一个 X 矩阵 ，返回 true ；</p><p>否则，返回 false 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2022/05/03/ex1.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2022/05/03/ex1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:67%;" /><blockquote><p>输入：grid &#x3D; [[2,0,0,1],[0,3,1,0],[0,5,2,0],[4,0,0,2]]<br>输出：true<br>解释：矩阵如上图所示。<br>X 矩阵应该满足：绿色元素（对角线上）都不是 0 ，红色元素都是 0 。<br>因此，grid 是一个 X 矩阵。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">checkXMatrix</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; grid)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = grid.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i == j || i == n<span class="number">-1</span>-j)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(grid[i][j] == <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(grid[i][j] != <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n^2)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1669. 合并两个链表</title>
      <link href="/2023/01/30/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1669%20%E5%90%88%E5%B9%B6%E4%B8%A4%E4%B8%AA%E9%93%BE%E8%A1%A8/"/>
      <url>/2023/01/30/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1669%20%E5%90%88%E5%B9%B6%E4%B8%A4%E4%B8%AA%E9%93%BE%E8%A1%A8/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你两个链表 list1 和 list2 ，它们包含的元素分别为 n 个和 m 个。</p><p>请你将 list1 中下标从 a 到 b 的全部节点都删除，并将list2 接在被删除节点的位置。</p><p>下图中蓝色边和节点展示了操作后的结果：</p><img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/11/28/fig1.png" class="lazyload" data-srcset="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/11/28/fig1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:67%;" /><p>请你返回结果链表的头指针。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/11/28/merge_linked_list_ex1.png" class="lazyload" data-srcset="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/11/28/merge_linked_list_ex1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:67%;" /><blockquote><p>输入：list1 &#x3D; [0,1,2,3,4,5], a &#x3D; 3, b &#x3D; 4, list2 &#x3D; [1000000,1000001,1000002]<br>输出：[0,1,2,1000000,1000001,1000002,5]<br>解释：我们删除 list1 中下标为 3 和 4 的两个节点，并将 list2 接在该位置。上图中蓝色的边和节点为答案链表。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ListNode* <span class="title">mergeInBetween</span><span class="params">(ListNode* list1, <span class="type">int</span> a, <span class="type">int</span> b, ListNode* list2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> ptr = list1;</span><br><span class="line">        <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">        ListNode* headPtr = <span class="literal">nullptr</span>;</span><br><span class="line">        ListNode* tailPtr = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">//分别获取到a-1指针和b+1指针</span></span><br><span class="line">        <span class="keyword">while</span>(ptr != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(pos == a<span class="number">-1</span>)&#123;</span><br><span class="line">                headPtr = ptr;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(pos == b+<span class="number">1</span>)&#123;</span><br><span class="line">                tailPtr = ptr;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ptr = ptr-&gt;next;</span><br><span class="line">            pos++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将list1的a-1指针指向list2的头节点</span></span><br><span class="line">        headPtr-&gt;next = list2;</span><br><span class="line">        <span class="comment">//获取到到list2的尾节点指针</span></span><br><span class="line">        ptr = list2;</span><br><span class="line">        <span class="keyword">while</span>(ptr-&gt;next != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">            ptr = ptr-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将list2的尾节点指向list1的b+1结点</span></span><br><span class="line">        ptr-&gt;next = tailPtr;</span><br><span class="line">        <span class="keyword">return</span> list1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n + m)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2315. 统计星号</title>
      <link href="/2023/01/29/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2315%20%E7%BB%9F%E8%AE%A1%E6%98%9F%E5%8F%B7/"/>
      <url>/2023/01/29/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2315%20%E7%BB%9F%E8%AE%A1%E6%98%9F%E5%8F%B7/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个字符串 s ，每 两个 连续竖线 ‘|’ 为 一对 。换言之，第一个和第二个 ‘|’ 为一对，第三个和第四个 ‘|’ 为一对，以此类推。</p><p>请你返回 不在 竖线对之间，s 中 ‘*’ 的数目。</p><p>注意，每个竖线 ‘|’ 都会 恰好 属于一个对。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “l|<em>e</em>et|c**o|*de|”<br>输出：2<br>解释：不在竖线对之间的字符加粗加斜体后，得到字符串：”l|<em>e</em>et|c**o|*de|” 。<br>第一和第二条竖线 ‘|’ 之间的字符不计入答案。<br>同时，第三条和第四条竖线 ‘|’ 之间的字符也不计入答案。<br>不在竖线对之间总共有 2 个星号，所以我们返回 2 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">countAsterisks</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; c : s)&#123;</span><br><span class="line">            <span class="keyword">if</span>(c == <span class="string">&#x27;|&#x27;</span>)&#123;</span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(count%<span class="number">2</span> == <span class="number">0</span> &amp;&amp; c == <span class="string">&#x27;*&#x27;</span>)&#123;</span><br><span class="line">                ans++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2309. 兼具大小写的最好英文字母</title>
      <link href="/2023/01/27/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2309%20%E5%85%BC%E5%85%B7%E5%A4%A7%E5%B0%8F%E5%86%99%E7%9A%84%E6%9C%80%E5%A5%BD%E8%8B%B1%E6%96%87%E5%AD%97%E6%AF%8D/"/>
      <url>/2023/01/27/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2309%20%E5%85%BC%E5%85%B7%E5%A4%A7%E5%B0%8F%E5%86%99%E7%9A%84%E6%9C%80%E5%A5%BD%E8%8B%B1%E6%96%87%E5%AD%97%E6%AF%8D/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个由英文字母组成的字符串 s ，请你找出并返回 s 中的 最好 英文字母。返回的字母必须为大写形式。如果不存在满足条件的字母，则返回一个空字符串。</p><p>最好 英文字母的大写和小写形式必须 都 在 s 中出现。</p><p>英文字母 b 比另一个英文字母 a 更好 的前提是：英文字母表中，b 在 a 之 后 出现。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “arRAzFif”<br>输出：”R”<br>解释：<br>字母 ‘R’ 是大写和小写形式都出现的最好英文字母。<br>注意 ‘A’ 和 ‘F’ 的大写和小写形式也都出现了，但是 ‘R’ 比 ‘F’ 和 ‘A’ 更好。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：哈希表-位运算"><a href="#代码-cpp-：哈希表-位运算" class="headerlink" title="代码(cpp)：哈希表+位运算"></a>代码(cpp)：哈希表+位运算</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">greatestLetter</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">count</span><span class="params">(<span class="number">26</span>)</span></span>;</span><br><span class="line">        string ans = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; c : s)&#123;</span><br><span class="line">            <span class="comment">//islower()：判断是否为小写字母</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">islower</span>(c))</span><br><span class="line">                count[c-<span class="string">&#x27;a&#x27;</span>] |= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                count[c-<span class="string">&#x27;A&#x27;</span>] |= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">25</span>; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">            <span class="keyword">if</span>(count[i] == <span class="number">3</span>)&#123;</span><br><span class="line">                ans.<span class="built_in">push_back</span>(<span class="string">&#x27;A&#x27;</span>+i);</span><br><span class="line">                <span class="keyword">return</span> ans;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n+C)，n为s字符串的长度，C为26个字母集</li><li>空间复杂度：O(C)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1663. 具有给定数值的最小字符串</title>
      <link href="/2023/01/26/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1663%20%E5%85%B7%E6%9C%89%E7%BB%99%E5%AE%9A%E6%95%B0%E5%80%BC%E7%9A%84%E6%9C%80%E5%B0%8F%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
      <url>/2023/01/26/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1663%20%E5%85%B7%E6%9C%89%E7%BB%99%E5%AE%9A%E6%95%B0%E5%80%BC%E7%9A%84%E6%9C%80%E5%B0%8F%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>小写字符 的 数值 是它在字母表中的位置（从 1 开始），因此 a 的数值为 1 ，b 的数值为 2 ，c 的数值为 3 ，以此类推。</p><p>字符串由若干小写字符组成，字符串的数值 为各字符的数值之和。例如，字符串 “abe” 的数值等于 1 + 2 + 5 &#x3D; 8 。</p><p>给你两个整数 n 和 k 。返回 长度 等于 n 且 数值 等于 k 的 字典序最小 的字符串。</p><p>注意，如果字符串 x 在字典排序中位于 y 之前，就认为 x 字典序比 y 小，有以下两种情况：</p><p>x 是 y 的一个前缀；<br>如果 i 是 x[i] !&#x3D; y[i] 的第一个位置，且 x[i] 在字母表中的位置比 y[i] 靠前。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：n &#x3D; 3, k &#x3D; 27<br>输出：”aay”<br>解释：字符串的数值为 1 + 1 + 25 &#x3D; 27，它是数值满足要求且长度等于 3 字典序最小的字符串。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：贪心"><a href="#代码-cpp-：贪心" class="headerlink" title="代码(cpp)：贪心"></a>代码(cpp)：贪心</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">getSmallestString</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//初始化string字符串全为&#x27;a&#x27;</span></span><br><span class="line">        <span class="function">string <span class="title">ans</span><span class="params">(n, <span class="string">&#x27;a&#x27;</span>)</span></span>;</span><br><span class="line">        k -= n;</span><br><span class="line">        <span class="comment">//从后往前遍历，优先添加后面的字符</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = n<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">            <span class="keyword">if</span>(k &lt; <span class="number">25</span>)&#123;</span><br><span class="line">                ans[i] += k;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                ans[i] += <span class="number">25</span>;</span><br><span class="line">                k -= <span class="number">25</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1828. 统计一个圆中点的数目</title>
      <link href="/2023/01/24/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1828%20%E7%BB%9F%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%9C%86%E4%B8%AD%E7%82%B9%E7%9A%84%E6%95%B0%E7%9B%AE/"/>
      <url>/2023/01/24/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1828%20%E7%BB%9F%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%9C%86%E4%B8%AD%E7%82%B9%E7%9A%84%E6%95%B0%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个数组 points ，其中 points[i] &#x3D; [xi, yi] ，表示第 i 个点在二维平面上的坐标。多个点可能会有 相同 的坐标。</p><p>同时给你一个数组 queries ，其中 queries[j] &#x3D; [xj, yj, rj] ，表示一个圆心在 (xj, yj) 且半径为 rj 的圆。</p><p>对于每一个查询 queries[j] ，计算在第 j 个圆 内 点的数目。如果一个点在圆的 边界上 ，我们同样认为它在圆 内 。</p><p>请你返回一个数组 answer ，其中 answer[j]是第 j 个查询的答案。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2021/03/25/chrome_2021-03-25_22-34-16.png" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2021/03/25/chrome_2021-03-25_22-34-16.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 50%;" /><blockquote><p>输入：points &#x3D; [[1,3],[3,3],[5,3],[2,2]], queries &#x3D; [[2,3,1],[4,3,1],[1,1,2]]<br>输出：[3,2,2]<br>解释：所有的点和圆如上图所示。<br>queries[0] 是绿色的圆，queries[1] 是红色的圆，queries[2] 是蓝色的圆。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>判断圆心到点points的距离是否小于等于半径</p><p>$\sqrt{(x^2_1-x^2_2)+(y^2_1-y^2_2)} &lt;&#x3D; R$</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">countPoints</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; points, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; queries)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = queries.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> m = points.<span class="built_in">size</span>();</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">ans</span><span class="params">(n)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; m; j++)&#123;</span><br><span class="line">                <span class="type">int</span> temp = <span class="built_in">pow</span>(queries[i][<span class="number">0</span>]-points[j][<span class="number">0</span>], <span class="number">2</span>) + <span class="built_in">pow</span>(queries[i][<span class="number">1</span>]-points[j][<span class="number">1</span>], <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">pow</span>(temp, <span class="number">0.5</span>) &lt;= queries[i][<span class="number">2</span>])&#123;</span><br><span class="line">                    ans[i]++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n^2)</li><li>空间复杂度：O(n)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2303. 计算应缴税款总额</title>
      <link href="/2023/01/23/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2303%20%E8%AE%A1%E7%AE%97%E5%BA%94%E7%BC%B4%E7%A8%8E%E6%AC%BE%E6%80%BB%E9%A2%9D/"/>
      <url>/2023/01/23/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2303%20%E8%AE%A1%E7%AE%97%E5%BA%94%E7%BC%B4%E7%A8%8E%E6%AC%BE%E6%80%BB%E9%A2%9D/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个下标从 0 开始的二维整数数组 brackets ，其中 brackets[i] &#x3D; [upperi, percenti] ，表示第 i 个税级的上限是 upperi ，征收的税率为 percenti 。税级按上限 从低到高排序（在满足 0 &lt; i &lt; brackets.length 的前提下，upperi-1 &lt; upperi）。</p><p>税款计算方式如下：</p><p>不超过 upper0 的收入按税率 percent0 缴纳<br>接着 upper1 - upper0 的部分按税率 percent1 缴纳<br>然后 upper2 - upper1 的部分按税率 percent2 缴纳<br>以此类推<br>给你一个整数 income 表示你的总收入。返回你需要缴纳的税款总额。与标准答案误差不超 10-5 的结果将被视作正确答案。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：brackets &#x3D; [[3,50],[7,10],[12,25]], income &#x3D; 10<br>输出：2.65000<br>解释：<br><code>前 $3 的税率为 50% 。需要支付税款 $3 * 50% = $1.50 。 接下来 $7 - $3 = $4 的税率为 10% 。需要支付税款 $4 * 10% = $0.40 。 最后 $10 - $7 = $3 的税率为 25% 。需要支付税款 $3 * 25% = $0.75 。 需要支付的税款总计 $1.50 + $0.40 + $0.75 = $2.65 。</code></p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">calculateTax</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; brackets, <span class="type">int</span> income)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(income == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> pre = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; brackets.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(pre &gt; income)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ans += (<span class="built_in">min</span>(income, brackets[i][<span class="number">0</span>])-pre)*brackets[i][<span class="number">1</span>];</span><br><span class="line">            pre = brackets[i][<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">double</span>(ans)*<span class="number">0.01</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1817. 查找用户活跃分钟数</title>
      <link href="/2023/01/20/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1817%20%E6%9F%A5%E6%89%BE%E7%94%A8%E6%88%B7%E6%B4%BB%E8%B7%83%E5%88%86%E9%92%9F%E6%95%B0/"/>
      <url>/2023/01/20/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1817%20%E6%9F%A5%E6%89%BE%E7%94%A8%E6%88%B7%E6%B4%BB%E8%B7%83%E5%88%86%E9%92%9F%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你用户在 LeetCode 的操作日志，和一个整数 k 。日志用一个二维整数数组 logs 表示，其中每个 logs[i] &#x3D; [IDi, timei] 表示 ID 为 IDi 的用户在 timei 分钟时执行了某个操作。</p><p>多个用户 可以同时执行操作，单个用户可以在同一分钟内执行 多个操作 。</p><p>指定用户的 用户活跃分钟数（user active minutes，UAM） 定义为用户对 LeetCode 执行操作的 唯一分钟数 。 即使一分钟内执行多个操作，也只能按一分钟计数。</p><p>请你统计用户活跃分钟数的分布情况，统计结果是一个长度为 k 且 下标从 1 开始计数 的数组 answer ，对于每个 j（1 &lt;&#x3D; j &lt;&#x3D; k），answer[j] 表示 用户活跃分钟数 等于 j 的用户数。</p><p>返回上面描述的答案数组 answer 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：logs &#x3D; [[1,1],[2,2],[2,3]], k &#x3D; 4<br>输出：[1,1,0,0]<br>解释：<br>ID&#x3D;1 的用户仅在分钟 1 执行单个操作。因此，该用户的用户活跃分钟数为 1<br>ID&#x3D;2 的用户执行操作的分钟分别是：2 和 3 。因此，该用户的用户活跃分钟数为 2<br>1 个用户的用户活跃分钟数是 1 ，1 个用户的用户活跃分钟数是 2<br>因此，answer[1] &#x3D; 1 ，answer[2] &#x3D; 1 ，其余的值都是 0</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：哈希-set去重"><a href="#代码-cpp-：哈希-set去重" class="headerlink" title="代码(cpp)：哈希+set去重"></a>代码(cpp)：哈希+set去重</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">findingUsersActiveMinutes</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; logs, <span class="type">int</span> k)</span> </span>&#123;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, set&lt;<span class="type">int</span>&gt;&gt; map;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; log : logs)&#123;</span><br><span class="line">            map[log[<span class="number">0</span>]].<span class="built_in">emplace</span>(log[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">ans</span><span class="params">(k)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; [_, set] : map)&#123;</span><br><span class="line">            ans[set.<span class="built_in">size</span>()<span class="number">-1</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n+k)，其中 n 是数组 logs 的长度，k 是给定的整数。</p></li><li><p>空间复杂度：O(n)。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2299. 强密码检验器 II</title>
      <link href="/2023/01/19/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2299%20%E5%BC%BA%E5%AF%86%E7%A0%81%E6%A3%80%E9%AA%8C%E5%99%A8%20II/"/>
      <url>/2023/01/19/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2299%20%E5%BC%BA%E5%AF%86%E7%A0%81%E6%A3%80%E9%AA%8C%E5%99%A8%20II/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>如果一个密码满足以下所有条件，我们称它是一个 强 密码：</p><p>它有至少 8 个字符。<br>至少包含 一个小写英文 字母。<br>至少包含 一个大写英文 字母。<br>至少包含 一个数字 。<br>至少包含 一个特殊字符 。特殊字符为：”!@#$%^&amp;*()-+” 中的一个。<br>它 不 包含 2 个连续相同的字符（比方说 “aab” 不符合该条件，但是 “aba” 符合该条件）。<br>给你一个字符串 password ，如果它是一个 强 密码，返回 true，否则返回 false 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：password &#x3D; “IloveLe3tcode!”<br>输出：true<br>解释：密码满足所有的要求，所以我们返回 true 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：位运算"><a href="#代码-cpp-：位运算" class="headerlink" title="代码(cpp)：位运算"></a>代码(cpp)：位运算</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">strongPasswordCheckerII</span><span class="params">(string password)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//密码长度至少为8</span></span><br><span class="line">        <span class="keyword">if</span>(password.<span class="built_in">size</span>() &lt; <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span> pri = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; c : password)&#123;</span><br><span class="line">            <span class="comment">//不能出现连续相同的字符</span></span><br><span class="line">            <span class="keyword">if</span>(c == pri)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                pri = c;</span><br><span class="line"><span class="comment">//检查包含的字符</span></span><br><span class="line">            <span class="keyword">if</span>(c &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;z&#x27;</span>)</span><br><span class="line">                ans |= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(c &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line">                ans |= <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(c &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">                ans |= <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                ans |= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ans == <span class="number">15</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)，其中 n 为密码的长度。</li><li>空间复杂度：O(1)。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1814. 统计一个数组中好对子的数目</title>
      <link href="/2023/01/17/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1814%20%E7%BB%9F%E8%AE%A1%E4%B8%80%E4%B8%AA%E6%95%B0%E7%BB%84%E4%B8%AD%E5%A5%BD%E5%AF%B9%E5%AD%90%E7%9A%84%E6%95%B0%E7%9B%AE/"/>
      <url>/2023/01/17/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1814%20%E7%BB%9F%E8%AE%A1%E4%B8%80%E4%B8%AA%E6%95%B0%E7%BB%84%E4%B8%AD%E5%A5%BD%E5%AF%B9%E5%AD%90%E7%9A%84%E6%95%B0%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个数组 nums ，数组中只包含非负整数。定义 rev(x) 的值为将整数 x 各个数字位反转得到的结果。比方说 rev(123) &#x3D; 321 ， rev(120) &#x3D; 21 。我们称满足下面条件的下标对 (i, j) 是 好的 ：</p><p>0 &lt;&#x3D; i &lt; j &lt; nums.length<br>nums[i] + rev(nums[j]) &#x3D;&#x3D; nums[j] + rev(nums[i])<br>请你返回好下标对的数目。由于结果可能会很大，请将结果对 109 + 7 取余 后返回。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [42,11,1,97]<br>输出：2<br>解释：两个坐标对为：</p><ul><li>(0,3)：42 + rev(97) &#x3D; 42 + 79 &#x3D; 121, 97 + rev(42) &#x3D; 97 + 24 &#x3D; 121 。</li><li>(1,2)：11 + rev(1) &#x3D; 11 + 1 &#x3D; 12, 1 + rev(11) &#x3D; 1 + 11 &#x3D; 12 。</li></ul></blockquote></div><div class="story post-story"><h2 id="思路：哈希表"><a href="#思路：哈希表" class="headerlink" title="思路：哈希表"></a>思路：哈希表</h2><p><code>nums[i] + rev(nums[j]) == nums[j] + rev(nums[i])</code></p><p>可以推导出：</p><p><code>nums[i] - rev(nums[i]) == nums[j] - rev(nums[j])</code></p><p>所以，只要有<code>nums[i] - rev(nums[i])</code>相等的，那就是一对好对子</p><p>利用哈希表记录结果都为<code>nums[i] - rev(nums[i])</code>的个数</p><p>并且可能会存在有<strong>多个结果相同的坐标</strong></p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">rev</span><span class="params">(<span class="type">int</span> num)</span></span>&#123;</span><br><span class="line">        <span class="type">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(num)&#123;</span><br><span class="line">            res = res*<span class="number">10</span> + num%<span class="number">10</span>;</span><br><span class="line">            num /= <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">countNicePairs</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> mod = <span class="number">1e9</span>+<span class="number">7</span>;</span><br><span class="line">        <span class="type">long</span> ans = <span class="number">0</span>;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; map;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; num : nums)&#123;</span><br><span class="line">            <span class="type">int</span> revNum = <span class="built_in">rev</span>(num);</span><br><span class="line">            ans = (ans+map[num-revNum]) % mod;</span><br><span class="line">            map[num-revNum]++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(n)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1813. 句子相似性 III</title>
      <link href="/2023/01/16/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1813%20%E5%8F%A5%E5%AD%90%E7%9B%B8%E4%BC%BC%E6%80%A7%20III/"/>
      <url>/2023/01/16/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1813%20%E5%8F%A5%E5%AD%90%E7%9B%B8%E4%BC%BC%E6%80%A7%20III/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>一个句子是由一些单词与它们之间的单个空格组成，且句子的开头和结尾没有多余空格。比方说，”Hello World” ，”HELLO” ，”hello world hello world” 都是句子。每个单词都 只 包含大写和小写英文字母。</p><p>如果两个句子 sentence1 和 sentence2 ，可以通过往其中一个句子插入一个任意的句子（可以是空句子）而得到另一个句子，那么我们称这两个句子是 相似的 。比方说，sentence1 &#x3D; “Hello my name is Jane” 且 sentence2 &#x3D; “Hello Jane” ，我们可以往 sentence2 中 “Hello” 和 “Jane” 之间插入 “my name is” 得到 sentence1 。</p><p>给你两个句子 sentence1 和 sentence2 ，如果 sentence1 和 sentence2 是相似的，请你返回 true ，否则返回 false 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><p>示例1：</p><blockquote><p>输入：sentence1 &#x3D; “My name is Haley”, sentence2 &#x3D; “My Haley”<br>输出：true<br>解释：可以往 sentence2 中 “My” 和 “Haley” 之间插入 “name is” ，得到 sentence1 。</p></blockquote><p>示例2：</p><blockquote><p>输入：sentence1 &#x3D; “of”, sentence2 &#x3D; “A lot of words”<br>输出：false<br>解释：没法往这两个句子中的一个句子只插入一个句子就得到另一个句子。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：双指针"><a href="#代码-cpp-：双指针" class="headerlink" title="代码(cpp)：双指针"></a>代码(cpp)：双指针</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//第一种方法stringstream</span></span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">split</span><span class="params">(string&amp; s)</span> </span>&#123;</span><br><span class="line">        vector&lt;string&gt; words;</span><br><span class="line">        stringstream ss;</span><br><span class="line">        ss &lt;&lt; s;</span><br><span class="line">        string str;</span><br><span class="line">        <span class="keyword">while</span> (ss &gt;&gt; str) </span><br><span class="line">            words.<span class="built_in">emplace_back</span>(str);</span><br><span class="line">        <span class="keyword">return</span> words;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//第二种方法isstringstream</span></span><br><span class="line">    <span class="comment">/*vector&lt;string&gt; split2(string s)&#123;</span></span><br><span class="line"><span class="comment">        vector&lt;string&gt; words;</span></span><br><span class="line"><span class="comment">        istringstream iss(s);</span></span><br><span class="line"><span class="comment">        string str;</span></span><br><span class="line"><span class="comment">        while (iss &gt;&gt; str) </span></span><br><span class="line"><span class="comment">            words.emplace_back(str);        </span></span><br><span class="line"><span class="comment">        return words;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">    <span class="comment">//第三种方法遍历</span></span><br><span class="line"><span class="comment">/*vector&lt;string&gt; split3(string&amp; s)&#123;</span></span><br><span class="line"><span class="comment">        vector&lt;string&gt; wordList;</span></span><br><span class="line"><span class="comment">        for(int i = 0; i &lt; s.size(); i++)&#123;</span></span><br><span class="line"><span class="comment">            if(s[i] != &#x27; &#x27;)&#123;</span></span><br><span class="line"><span class="comment">                string temp = &quot;&quot;;</span></span><br><span class="line"><span class="comment">                while(i &lt; s.size() &amp;&amp; s[i] != &#x27; &#x27;)</span></span><br><span class="line"><span class="comment">                    temp.push_back(s[i++]);</span></span><br><span class="line"><span class="comment">                wordList.emplace_back(temp);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        return wordList;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">areSentencesSimilar</span><span class="params">(string sentence1, string sentence2)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//将第一个参数指定为长度最短的</span></span><br><span class="line">        <span class="keyword">if</span> (sentence1.<span class="built_in">size</span>() &gt; sentence2.<span class="built_in">size</span>()) </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">areSentencesSimilar</span>(sentence2, sentence1);</span><br><span class="line">        </span><br><span class="line">        vector&lt;string&gt; words1 = <span class="built_in">split</span>(sentence1);</span><br><span class="line">        vector&lt;string&gt; words2 = <span class="built_in">split</span>(sentence2);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> shortSize = words1.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> longSize = words2.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//先从左边遍历</span></span><br><span class="line">        <span class="keyword">while</span>(left &lt; shortSize &amp;&amp; words1[left] == words2[left])</span><br><span class="line">            left++;</span><br><span class="line">        <span class="comment">//再从右边遍历</span></span><br><span class="line">        <span class="keyword">while</span>(right &lt; shortSize-left &amp;&amp; words1[(shortSize<span class="number">-1</span>)-right] == words2[(longSize<span class="number">-1</span>)-right])</span><br><span class="line">            right++;</span><br><span class="line">        <span class="keyword">return</span> left+right == shortSize;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(m+n)，其中 m 是 sentence1 的长度，n 是 sentence2的长度。</p></li><li><p>空间复杂度：O(m+n)</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2293. 极大极小游戏</title>
      <link href="/2023/01/15/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2293%20%E6%9E%81%E5%A4%A7%E6%9E%81%E5%B0%8F%E6%B8%B8%E6%88%8F/"/>
      <url>/2023/01/15/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2293%20%E6%9E%81%E5%A4%A7%E6%9E%81%E5%B0%8F%E6%B8%B8%E6%88%8F/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个下标从 0 开始的整数数组 nums ，其长度是 2 的幂。</p><p>对 nums 执行下述算法：</p><p>设 n 等于 nums 的长度，如果 n &#x3D;&#x3D; 1 ，终止 算法过程。否则，创建 一个新的整数数组 newNums ，新数组长度为 n &#x2F; 2 ，下标从 0 开始。<br>对于满足 0 &lt;&#x3D; i &lt; n &#x2F; 2 的每个 偶数 下标 i ，将 newNums[i] 赋值 为 min(nums[2 * i], nums[2 * i + 1]) 。<br>对于满足 0 &lt;&#x3D; i &lt; n &#x2F; 2 的每个 奇数 下标 i ，将 newNums[i] 赋值 为 max(nums[2 * i], nums[2 * i + 1]) 。<br>用 newNums 替换 nums 。<br>从步骤 1 开始 重复 整个过程。<br>执行算法后，返回 nums 中剩下的那个数字。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2022/04/13/example1drawio-1.png" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2022/04/13/example1drawio-1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:50%;" /><blockquote><p>输入：nums &#x3D; [1,3,5,2,4,8,2,2]<br>输出：1<br>解释：重复执行算法会得到下述数组。<br>第一轮：nums &#x3D; [1,5,4,2]<br>第二轮：nums &#x3D; [1,4]<br>第三轮：nums &#x3D; [1]<br>1 是最后剩下的那个数字，返回 1 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：BFS"><a href="#代码-cpp-：BFS" class="headerlink" title="代码(cpp)：BFS"></a>代码(cpp)：BFS</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minMaxGame</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(nums.<span class="built_in">size</span>() &gt; <span class="number">1</span>)&#123;</span><br><span class="line">            vector&lt;<span class="type">int</span>&gt; temp;</span><br><span class="line">            <span class="type">bool</span> flag = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; nums.<span class="built_in">size</span>(); i+=<span class="number">2</span>)&#123;</span><br><span class="line">                <span class="type">int</span> num = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">                    num = <span class="built_in">min</span>(nums[i], nums[i+<span class="number">1</span>]);</span><br><span class="line">                    flag = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    num = <span class="built_in">max</span>(nums[i], nums[i+<span class="number">1</span>]);</span><br><span class="line">                    flag = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                temp.<span class="built_in">emplace_back</span>(num);</span><br><span class="line">            &#125;</span><br><span class="line">            nums = <span class="built_in">move</span>(temp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nums[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，其中 n 是数组 nums 的长度。第一次循环的时间复杂度为 O(n)，下一次循环时问题规模减半，所以总体复杂度为 O(n)+O(n&#x2F;2)+O( n&#x2F;4)+⋯+O(1)&#x3D;O(n)。</p></li><li><p>空间复杂度：O(n)，其中 n 是数组 nums 的长度。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1807. 替换字符串中的括号内容</title>
      <link href="/2023/01/12/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1807%20%E6%9B%BF%E6%8D%A2%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E7%9A%84%E6%8B%AC%E5%8F%B7%E5%86%85%E5%AE%B9/"/>
      <url>/2023/01/12/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1807%20%E6%9B%BF%E6%8D%A2%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E7%9A%84%E6%8B%AC%E5%8F%B7%E5%86%85%E5%AE%B9/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个字符串 s ，它包含一些括号对，每个括号中包含一个 非空 的键。</p><p>比方说，字符串 “(name)is(age)yearsold” 中，有 两个 括号对，分别包含键 “name” 和 “age” 。<br>你知道许多键对应的值，这些关系由二维字符串数组 knowledge 表示，其中 knowledge[i] &#x3D; [keyi, valuei] ，表示键 keyi 对应的值为 valuei 。</p><p>你需要替换 所有 的括号对。当你替换一个括号对，且它包含的键为 keyi 时，你需要：</p><p>将 keyi 和括号用对应的值 valuei 替换。<br>如果从 knowledge 中无法得知某个键对应的值，你需要将 keyi 和括号用问号 “?” 替换（不需要引号）。<br>knowledge 中每个键最多只会出现一次。s 中不会有嵌套的括号。</p><p>请你返回替换 所有 括号对后的结果字符串。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><p>示例1：</p><blockquote><p>输入：s &#x3D; “(name)is(age)yearsold”, knowledge &#x3D; [[“name”,”bob”],[“age”,”two”]]<br>输出：”bobistwoyearsold”<br>解释：<br>键 “name” 对应的值为 “bob” ，所以将 “(name)” 替换为 “bob” 。<br>键 “age” 对应的值为 “two” ，所以将 “(age)” 替换为 “two” 。</p></blockquote><p>示例2：</p><blockquote><p>输入：s &#x3D; “hi(name)”, knowledge &#x3D; [[“a”,”b”]]<br>输出：”hi?”<br>解释：由于不知道键 “name” 对应的值，所以用 “?” 替换 “(name)” 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">evaluate</span><span class="params">(string s, vector&lt;vector&lt;string&gt;&gt;&amp; knowledge)</span> </span>&#123;</span><br><span class="line">        unordered_map&lt;string, string&gt; map;</span><br><span class="line">        <span class="comment">//建立哈希表</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; kv : knowledge)&#123;</span><br><span class="line">            map[kv[<span class="number">0</span>]] = kv[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string ans = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            string temp = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="comment">//如果没有到&#x27;(&#x27;，加把字符加入到ans中</span></span><br><span class="line">            <span class="keyword">if</span>(s[i] != <span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">                ans.<span class="built_in">push_back</span>(s[i]);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                i++;</span><br><span class="line">                <span class="comment">//获得括号中的字符串</span></span><br><span class="line">                <span class="keyword">while</span>(i &lt; s.<span class="built_in">size</span>() &amp;&amp; s[i] != <span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">                    temp.<span class="built_in">push_back</span>(s[i++]);</span><br><span class="line"><span class="comment">//哈希表中是否存在匹配的</span></span><br><span class="line">                string str = map[temp];</span><br><span class="line">                <span class="keyword">if</span>(str.<span class="built_in">empty</span>())</span><br><span class="line">                    ans.<span class="built_in">push_back</span>(<span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ans.<span class="built_in">append</span>(str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n+k)，其中 n 是字符串 s 的长度，k 是字符串数组 knowledge 中所有字符串的长度之和</li><li>空间复杂度：O(n+k)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2283. 判断一个数的数字计数是否等于数位的值</title>
      <link href="/2023/01/11/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2283%20%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E6%95%B0%E7%9A%84%E6%95%B0%E5%AD%97%E8%AE%A1%E6%95%B0%E6%98%AF%E5%90%A6%E7%AD%89%E4%BA%8E%E6%95%B0%E4%BD%8D%E7%9A%84%E5%80%BC/"/>
      <url>/2023/01/11/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2283%20%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E6%95%B0%E7%9A%84%E6%95%B0%E5%AD%97%E8%AE%A1%E6%95%B0%E6%98%AF%E5%90%A6%E7%AD%89%E4%BA%8E%E6%95%B0%E4%BD%8D%E7%9A%84%E5%80%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个下标从 0 开始长度为 n 的字符串 num ，它只包含数字。</p><p>如果对于 每个 0 &lt;&#x3D; i &lt; n 的下标 i ，都满足数位 i 在 num 中出现了 num[i]次，那么请你返回 true ，否则返回 false 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：num &#x3D; “030”<br>输出：false<br>解释：<br>num[0] &#x3D; ‘0’ 。数字 0 应该出现 0 次，但是在 num 中出现了一次。<br>num[1] &#x3D; ‘3’ 。数字 1 应该出现 3 次，但是在 num 中出现了零次。<br>num[2] &#x3D; ‘0’ 。数字 2 在 num 中出现了 0 次。<br>下标 0 和 1 都违反了题目要求，所以返回 false 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">digitCount</span><span class="params">(string num)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">map</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; n : num)&#123;</span><br><span class="line">            map[n-<span class="string">&#x27;0&#x27;</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; num.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map[i] != num[i]-<span class="string">&#x27;0&#x27;</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(10)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1806. 还原排列的最少操作步数</title>
      <link href="/2023/01/09/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1806%20%E8%BF%98%E5%8E%9F%E6%8E%92%E5%88%97%E7%9A%84%E6%9C%80%E5%B0%91%E6%93%8D%E4%BD%9C%E6%AD%A5%E6%95%B0/"/>
      <url>/2023/01/09/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1806%20%E8%BF%98%E5%8E%9F%E6%8E%92%E5%88%97%E7%9A%84%E6%9C%80%E5%B0%91%E6%93%8D%E4%BD%9C%E6%AD%A5%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个偶数 n ，已知存在一个长度为 n 的排列 perm ，其中 perm[i] &#x3D;&#x3D; i（下标 从 0 开始 计数）。</p><p>一步操作中，你将创建一个新数组 arr ，对于每个 i ：</p><ul><li>如果 i % 2 &#x3D;&#x3D; 0 ，那么 arr[i] &#x3D; perm[i &#x2F; 2]</li><li>如果 i % 2 &#x3D;&#x3D; 1 ，那么 arr[i] &#x3D; perm[n &#x2F; 2 + (i - 1) &#x2F; 2]</li><li>然后将 arr 赋值给 perm 。</li></ul><p>要想使 perm 回到排列初始值，至少需要执行多少步操作？返回最小的 非零 操作步数。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：n &#x3D; 4<br>输出：2<br>解释：最初，perm &#x3D; [0,1,2,3]<br>第 1 步操作后，perm &#x3D; [0,2,1,3]<br>第 2 步操作后，perm &#x3D; [0,1,2,3]<br>所以，仅需执行 2 步操作</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">reinitializePermutation</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">perm</span><span class="params">(n)</span></span>;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">collation</span><span class="params">(n)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">            perm[i] = i;</span><br><span class="line">            collation[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">//如果要调用move构造，那么一定要传一个临时变量</span></span><br><span class="line">            <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">arr</span><span class="params">(n)</span></span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i%<span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">                    arr[i] = perm[i/<span class="number">2</span>];</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    arr[i] = perm[n/<span class="number">2</span>+(i<span class="number">-1</span>)/<span class="number">2</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            ans++;<span class="comment">//次数加1</span></span><br><span class="line">            perm = <span class="built_in">move</span>(arr);</span><br><span class="line"><span class="comment">//如果不相等，重复上面操作直到相等，返回操作次数</span></span><br><span class="line">            <span class="keyword">if</span>(perm == collation)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n^2)，其中 n 表示给定的元素。根据方法二的推论可以知道最多需要经过 nn 次变换即可回到初始状态，每次变换需要的时间复杂度为 O(n)，因此总的时间复杂度为 O(n^2)。</li><li>空间复杂度：O(n)，其中 n 表示给定的元素。我们需要存储每次变换中的过程变量，需要的空间为 O(n)。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2185. 统计包含给定前缀的字符串</title>
      <link href="/2023/01/08/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2185%20%E7%BB%9F%E8%AE%A1%E5%8C%85%E5%90%AB%E7%BB%99%E5%AE%9A%E5%89%8D%E7%BC%80%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
      <url>/2023/01/08/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2185%20%E7%BB%9F%E8%AE%A1%E5%8C%85%E5%90%AB%E7%BB%99%E5%AE%9A%E5%89%8D%E7%BC%80%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个字符串数组 words 和一个字符串 pref 。</p><p>返回 words 中以 pref 作为 前缀 的字符串的数目。</p><p>字符串 s 的 前缀 就是  s 的任一前导连续字符串。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：words &#x3D; [“pay”,”attention”,”practice”,”attend”], pref &#x3D; “at”<br>输出：2<br>解释：以 “at” 作为前缀的字符串有两个，分别是：”attention” 和 “attend” 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">prefixCount</span><span class="params">(vector&lt;string&gt;&amp; words, string pref)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = words.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; word : words)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; pref.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(word[i] != pref[i])&#123;</span><br><span class="line">                    ans--;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n*m)，n为words的长度，m为pref的长度</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1658. 将 x 减到 0 的最小操作数</title>
      <link href="/2023/01/07/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1658%20%E5%B0%86%20x%20%E5%87%8F%E5%88%B0%200%20%E7%9A%84%E6%9C%80%E5%B0%8F%E6%93%8D%E4%BD%9C%E6%95%B0/"/>
      <url>/2023/01/07/%E6%AF%8F%E6%97%A5LeetCode/2023-1/1658%20%E5%B0%86%20x%20%E5%87%8F%E5%88%B0%200%20%E7%9A%84%E6%9C%80%E5%B0%8F%E6%93%8D%E4%BD%9C%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数数组 nums 和一个整数 x 。每一次操作时，你应当移除数组 nums 最左边或最右边的元素，然后从 x 中减去该元素的值。请注意，需要 修改 数组以供接下来的操作使用。</p><p>如果可以将 x 恰好 减到 0 ，返回 最小操作数 ；否则，返回 -1 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [1,1,4,2,3], x &#x3D; 5<br>输出：2<br>解释：最佳解决方案是移除后两个元素，将 x 减到 0 。</p></blockquote></div><div class="story post-story"><h2 id="思路：滑动窗口"><a href="#思路：滑动窗口" class="headerlink" title="思路：滑动窗口"></a>思路：滑动窗口</h2><p>计算出nums数组的总和<code>sum</code>，数组nums的元素个数为<code>n</code></p><p>初始化指针<code>left</code> &#x3D; -1, <code>right</code> &#x3D; 0</p><p>初始化左边的总和<code>lSum</code>为<code>0</code>(left为-1，没有元素)，右边的总和<code>rSum</code>为<code>sum</code>(right为0开始，n-0即为sum)</p><p>以<code>nums = [2,1,4,1,3], x = 5</code>示例：</p><p>只要<code>lSum+rSum &gt; x</code>，就需要rSum减去nums[right]，right指针+1移动到下一位置，依次往复</p><p>直到<code>lSum+rSum &gt; x</code>条件不成立：</p><ul><li>存在<code>lSum+rSum == x</code>的情况，得到操作次数((left+1)+(n-right))</li><li>存在<code>lSum+rSum &lt; x</code>的情况，就说明右边的总和不能恰好等于x，就需要加上左边的元素</li></ul><p>过程：</p><p>起始：left &#x3D; -1，lSum &#x3D; 0； rSum &#x3D; sum &#x3D; 11，right &#x3D; 0</p><ol><li><p>left &#x3D; -1，lSum &#x3D; 0； rSum &#x3D; 11-nums[right] &#x3D; 9，right &#x3D; 1</p></li><li><p>left &#x3D; -1，lSum &#x3D; 0； rSum &#x3D; 9-nums[right] &#x3D; 8，right &#x3D; 2</p></li><li><p>left &#x3D; -1，lSum &#x3D; 0； rSum &#x3D; 8-nums[right] &#x3D; 4，right &#x3D; 3 </p><p>此时存在<code>lSum+rSum &lt; x</code>的情况，left &#x3D; left+1 &#x3D; 0，lSum &#x3D; 0+nums[left] &#x3D; 2</p><p>此时状态：left &#x3D; 0，lSum &#x3D; 2； rSum &#x3D; 4，right &#x3D; 3</p></li><li><p>left &#x3D; 0，lSum &#x3D; 2； rSum &#x3D; 4-nums[right] &#x3D; 3，right &#x3D; 4</p><p>此时存在<code>lSum+rSum == x</code>的情况，获得操作次数ans &#x3D; (left+1)+(n-right) &#x3D; 2</p></li></ol></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minOperations</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = nums.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> sum = <span class="built_in">accumulate</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>(), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(sum &lt; x)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>; </span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> lSum = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> rSum = sum;</span><br><span class="line">        <span class="type">int</span> right = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = n+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> left = <span class="number">-1</span>; left &lt; n; left++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(left != <span class="number">-1</span>)</span><br><span class="line">                lSum += nums[left];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(right &lt; n &amp;&amp; lSum + rSum &gt; x)</span><br><span class="line">                rSum -= nums[right++];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(lSum + rSum == x)</span><br><span class="line">                ans = <span class="built_in">min</span>(ans, (left + <span class="number">1</span>) + (n - right));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ans &gt; n)</span><br><span class="line">            ans = <span class="number">-1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2180. 统计各位数字之和为偶数的整数个数</title>
      <link href="/2023/01/06/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2180%20%E7%BB%9F%E8%AE%A1%E5%90%84%E4%BD%8D%E6%95%B0%E5%AD%97%E4%B9%8B%E5%92%8C%E4%B8%BA%E5%81%B6%E6%95%B0%E7%9A%84%E6%95%B4%E6%95%B0%E4%B8%AA%E6%95%B0/"/>
      <url>/2023/01/06/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2180%20%E7%BB%9F%E8%AE%A1%E5%90%84%E4%BD%8D%E6%95%B0%E5%AD%97%E4%B9%8B%E5%92%8C%E4%B8%BA%E5%81%B6%E6%95%B0%E7%9A%84%E6%95%B4%E6%95%B0%E4%B8%AA%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个正整数 num ，请你统计并返回 小于或等于 num 且各位数字之和为 偶数 的正整数的数目。</p><p>正整数的 各位数字之和 是其所有位上的对应数字相加的结果。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：num &#x3D; 30<br>输出：14<br>解释：<br>只有 14 个整数满足小于等于 30 且各位数字之和为偶数，分别是：<br>2、4、6、8、11、13、15、17、19、20、22、24、26 和 28 。</p><ul><li>例如13，各位上之和为：1+3 &#x3D; 4，结果为偶数</li></ul></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">countEven</span><span class="params">(<span class="type">int</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">2</span>; i &lt;= num; i++)&#123;</span><br><span class="line">            <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> temp = i;</span><br><span class="line">            <span class="keyword">while</span>(temp)&#123;</span><br><span class="line">                sum += temp%<span class="number">10</span>;</span><br><span class="line">                temp /= <span class="number">10</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(sum%<span class="number">2</span> == <span class="number">0</span>)&#123;</span><br><span class="line">                ans++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(num×lognum)。我们总共需要枚举 num 个正整数，而判断每个正整数的各位数字之和是否为偶数需要 O(lognum) 的时间复杂度。</p></li><li><p>空间复杂度：O(1)</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2042. 检查句子中的数字是否递增</title>
      <link href="/2023/01/03/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2042%20%E6%A3%80%E6%9F%A5%E5%8F%A5%E5%AD%90%E4%B8%AD%E7%9A%84%E6%95%B0%E5%AD%97%E6%98%AF%E5%90%A6%E9%80%92%E5%A2%9E/"/>
      <url>/2023/01/03/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2042%20%E6%A3%80%E6%9F%A5%E5%8F%A5%E5%AD%90%E4%B8%AD%E7%9A%84%E6%95%B0%E5%AD%97%E6%98%AF%E5%90%A6%E9%80%92%E5%A2%9E/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>句子是由若干 token 组成的一个列表，token 间用 单个 空格分隔，句子没有前导或尾随空格。每个 token 要么是一个由数字 0-9 组成的不含前导零的 正整数 ，要么是一个由小写英文字母组成的 单词 。</p><p>示例，”a puppy has 2 eyes 4 legs” 是一个由 7 个 token 组成的句子：”2” 和 “4” 是数字，其他像 “puppy” 这样的 tokens 属于单词。<br>给你一个表示句子的字符串 s ，你需要检查 s 中的 全部 数字是否从左到右严格递增（即，除了最后一个数字，s 中的 每个 数字都严格小于它 右侧 的数字）。</p><p>如果满足题目要求，返回 true ，否则，返回 false 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><p><img src="https://assets.leetcode.com/uploads/2021/09/30/example1.png" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2021/09/30/example1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="example-1"></p><blockquote><p>输入：s &#x3D; “1 box has 3 blue 4 red 6 green and 12 yellow marbles”<br>输出：true<br>解释：句子中的数字是：1, 3, 4, 6, 12 。<br>这些数字是按从左到右严格递增的 1 &lt; 3 &lt; 4 &lt; 6 &lt; 12 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">areNumbersAscending</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> pre = <span class="number">-1</span>;</span><br><span class="line">        <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(pos &lt; s.<span class="built_in">size</span>())&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">isdigit</span>(s[pos]))&#123;</span><br><span class="line">                <span class="type">int</span> num = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span>(pos &lt; s.<span class="built_in">size</span>() &amp;&amp; <span class="built_in">isdigit</span>(s[pos]))&#123;</span><br><span class="line">                    num = num*<span class="number">10</span> + s[pos]-<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                    pos++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(num &gt; pre)&#123;</span><br><span class="line">                    pre = num;</span><br><span class="line">                    num = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            pos++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2351. 第一个出现两次的字母</title>
      <link href="/2023/01/01/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2351%20%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%87%BA%E7%8E%B0%E4%B8%A4%E6%AC%A1%E7%9A%84%E5%AD%97%E6%AF%8D/"/>
      <url>/2023/01/01/%E6%AF%8F%E6%97%A5LeetCode/2023-1/2351%20%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%87%BA%E7%8E%B0%E4%B8%A4%E6%AC%A1%E7%9A%84%E5%AD%97%E6%AF%8D/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个由小写英文字母组成的字符串 s ，请你找出并返回第一个出现 两次 的字母。</p><p>注意：</p><p>如果 a 的 第二次 出现比 b 的 第二次 出现在字符串中的位置更靠前，则认为字母 a 在字母 b 之前出现两次。<br>s 包含至少一个出现两次的字母。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “abccbaacz”<br>输出：”c”<br>解释：<br>字母 ‘a’ 在下标 0 、5 和 6 处出现。<br>字母 ‘b’ 在下标 1 和 4 处出现。<br>字母 ‘c’ 在下标 2 、3 和 7 处出现。<br>字母 ‘z’ 在下标 8 处出现。<br>字母 ‘c’ 是第一个出现两次的字母，因为在所有字母中，’c’ 第二次出现的下标是最小的。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：哈希表"><a href="#代码-cpp-：哈希表" class="headerlink" title="代码(cpp)：哈希表"></a>代码(cpp)：哈希表</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">repeatedCharacter</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">map</span><span class="params">(<span class="number">26</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; c : s)&#123;</span><br><span class="line">            <span class="keyword">if</span>(++map[c-<span class="string">&#x27;a&#x27;</span>] == <span class="number">2</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(26)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2037. 使每位学生都有座位的最少移动次数</title>
      <link href="/2022/12/31/%E6%AF%8F%E6%97%A5LeetCode/2022-12/2037%20%E4%BD%BF%E6%AF%8F%E4%BD%8D%E5%AD%A6%E7%94%9F%E9%83%BD%E6%9C%89%E5%BA%A7%E4%BD%8D%E7%9A%84%E6%9C%80%E5%B0%91%E7%A7%BB%E5%8A%A8%E6%AC%A1%E6%95%B0/"/>
      <url>/2022/12/31/%E6%AF%8F%E6%97%A5LeetCode/2022-12/2037%20%E4%BD%BF%E6%AF%8F%E4%BD%8D%E5%AD%A6%E7%94%9F%E9%83%BD%E6%9C%89%E5%BA%A7%E4%BD%8D%E7%9A%84%E6%9C%80%E5%B0%91%E7%A7%BB%E5%8A%A8%E6%AC%A1%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>一个房间里有 n 个座位和 n 名学生，房间用一个数轴表示。给你一个长度为 n 的数组 seats ，其中 seats[i] 是第 i 个座位的位置。同时给你一个长度为 n 的数组 students ，其中 students[j] 是第 j 位学生的位置。</p><p>你可以执行以下操作任意次：</p><p>增加或者减少第 i 位学生的位置，每次变化量为 1 （也就是将第 i 位学生从位置 x 移动到 x + 1 或者 x - 1）<br>请你返回使所有学生都有座位坐的 最少移动次数 ，并确保没有两位学生的座位相同。</p><p>请注意，初始时有可能有多个座位或者多位学生在 同一 位置。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：seats &#x3D; [3,1,5], students &#x3D; [2,7,4]<br>输出：4<br>解释：学生移动方式如下：</p><ul><li>第一位学生从位置 2 移动到位置 1 ，移动 1 次。</li><li>第二位学生从位置 7 移动到位置 5 ，移动 2 次。</li><li>第三位学生从位置 4 移动到位置 3 ，移动 1 次。<br> 总共 1 + 2 + 1 &#x3D; 4 次移动。</li></ul></blockquote></div><div class="story post-story"><h2 id="思路：排序"><a href="#思路：排序" class="headerlink" title="思路：排序"></a>思路：排序</h2><p>因为座位seats和学生students都是相同长度n，所以一定是一一对应的</p><p>将seats和students分别排序，seats[i]和studentsp[i]之间的移动距离一定是最近的</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minMovesToSeat</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; seats, vector&lt;<span class="type">int</span>&gt;&amp; students)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">sort</span>(seats.<span class="built_in">begin</span>(), seats.<span class="built_in">end</span>());</span><br><span class="line">        <span class="built_in">sort</span>(students.<span class="built_in">begin</span>(), students.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; students.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            ans += <span class="built_in">abs</span>(seats[i]-students[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2032. 至少在两个数组中出现的值</title>
      <link href="/2022/12/29/%E6%AF%8F%E6%97%A5LeetCode/2022-12/2032%20%E8%87%B3%E5%B0%91%E5%9C%A8%E4%B8%A4%E4%B8%AA%E6%95%B0%E7%BB%84%E4%B8%AD%E5%87%BA%E7%8E%B0%E7%9A%84%E5%80%BC/"/>
      <url>/2022/12/29/%E6%AF%8F%E6%97%A5LeetCode/2022-12/2032%20%E8%87%B3%E5%B0%91%E5%9C%A8%E4%B8%A4%E4%B8%AA%E6%95%B0%E7%BB%84%E4%B8%AD%E5%87%BA%E7%8E%B0%E7%9A%84%E5%80%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你三个整数数组 nums1、nums2 和 nums3 ，请你构造并返回一个 元素各不相同的 数组，且由 至少 在 两个 数组中出现的所有值组成。数组中的元素可以按 任意 顺序排列。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums1 &#x3D; [1,1,3,2], nums2 &#x3D; [2,3], nums3 &#x3D; [3]<br>输出：[3,2]<br>解释：至少在两个数组中出现的所有值为：</p><ul><li>– 3 ，在全部三个数组中都出现过。</li><li>– 2 ，在数组 nums1 和 nums2 中出现过。</li></ul></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：哈希表-二进制"><a href="#代码-cpp-：哈希表-二进制" class="headerlink" title="代码(cpp)：哈希表+二进制"></a>代码(cpp)：哈希表+二进制</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">twoOutOfThree</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums1, vector&lt;<span class="type">int</span>&gt;&amp; nums2, vector&lt;<span class="type">int</span>&gt;&amp; nums3)</span> </span>&#123;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; map;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; num : nums1)&#123;</span><br><span class="line">            map[num] |= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; num : nums2)&#123;</span><br><span class="line">            map[num] |= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; num : nums3)&#123;</span><br><span class="line">            map[num] |= <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; ans;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; [num, count] : map)&#123;</span><br><span class="line">            <span class="comment">//111 101 110 011四种可能</span></span><br><span class="line">            <span class="keyword">if</span>(count == <span class="number">3</span> || count &gt; <span class="number">4</span>)&#123;</span><br><span class="line">                ans.<span class="built_in">emplace_back</span>(num);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(nums1+nums2+nums3)</li><li>空间复杂度：O(nums1+nums2+nums3)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1750. 删除字符串两端相同字符后的最短长度</title>
      <link href="/2022/12/28/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1750%20%E5%88%A0%E9%99%A4%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%A4%E7%AB%AF%E7%9B%B8%E5%90%8C%E5%AD%97%E7%AC%A6%E5%90%8E%E7%9A%84%E6%9C%80%E7%9F%AD%E9%95%BF%E5%BA%A6/"/>
      <url>/2022/12/28/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1750%20%E5%88%A0%E9%99%A4%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%A4%E7%AB%AF%E7%9B%B8%E5%90%8C%E5%AD%97%E7%AC%A6%E5%90%8E%E7%9A%84%E6%9C%80%E7%9F%AD%E9%95%BF%E5%BA%A6/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个只包含字符 ‘a’，’b’ 和 ‘c’ 的字符串 s ，你可以执行下面这个操作（5 个步骤）任意次：</p><p>选择字符串 s 一个 非空 的前缀，这个前缀的所有字符都相同。<br>选择字符串 s 一个 非空 的后缀，这个后缀的所有字符都相同。<br>前缀和后缀在字符串中任意位置都不能有交集。<br>前缀和后缀包含的所有字符都要相同。<br>同时删除前缀和后缀。<br>请你返回对字符串 s 执行上面操作任意次以后（可能 0 次），能得到的 最短长度 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “aabccabba”<br>输出：3<br>解释：最优操作序列为：</p><ul><li>选择前缀 “aa” 和后缀 “a” 并删除它们，得到 s &#x3D; “bccabb” 。</li><li>选择前缀 “b” 和后缀 “bb” 并删除它们，得到 s &#x3D; “cca” 。</li></ul></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：双指针"><a href="#代码-cpp-：双指针" class="headerlink" title="代码(cpp)：双指针"></a>代码(cpp)：双指针</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minimumLength</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right = s.<span class="built_in">size</span>()<span class="number">-1</span>;</span><br><span class="line"><span class="comment">//如果前缀和后缀相同</span></span><br><span class="line">        <span class="keyword">while</span>(left &lt; right &amp;&amp; s[left] == s[right])&#123;</span><br><span class="line">            <span class="keyword">auto</span> temp = s[left];</span><br><span class="line">            <span class="comment">//寻找和前缀相同并且连续的字符</span></span><br><span class="line">            <span class="keyword">while</span>(left &lt;= right &amp;&amp; s[left] == temp)</span><br><span class="line">                left++;</span><br><span class="line">            <span class="comment">//寻找和后缀相同并且连续的字符</span></span><br><span class="line">            <span class="keyword">while</span>(left &lt;= right &amp;&amp; s[right] == temp)</span><br><span class="line">                right--;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> right-left+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2027. 转换字符串的最少操作次数</title>
      <link href="/2022/12/27/%E6%AF%8F%E6%97%A5LeetCode/2022-12/2027%20%E8%BD%AC%E6%8D%A2%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%9C%80%E5%B0%91%E6%93%8D%E4%BD%9C%E6%AC%A1%E6%95%B0/"/>
      <url>/2022/12/27/%E6%AF%8F%E6%97%A5LeetCode/2022-12/2027%20%E8%BD%AC%E6%8D%A2%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%9C%80%E5%B0%91%E6%93%8D%E4%BD%9C%E6%AC%A1%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个字符串 s ，由 n 个字符组成，每个字符不是 ‘X’ 就是 ‘O’ 。</p><p>一次 操作 定义为从 s 中选出 三个连续字符 并将选中的每个字符都转换为 ‘O’ 。注意，如果字符已经是 ‘O’ ，只需要保持 不变 。</p><p>返回将 s 中所有字符均转换为 ‘O’ 需要执行的 最少 操作次数。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “XXOX”<br>输出：2<br>解释：XXOX -&gt; OOOX -&gt; OOOO<br>第一次操作，选择前 3 个字符，并将这些字符转换为 ‘O’ 。<br>然后，选中后 3 个字符，并执行转换。最终得到的字符串全由字符 ‘O’ 组成。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minimumMoves</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(s[i] == <span class="string">&#x27;X&#x27;</span>)&#123;</span><br><span class="line">                ans++;</span><br><span class="line">                i += <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;      </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1759. 统计同构子字符串的数目</title>
      <link href="/2022/12/26/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1759%20%E7%BB%9F%E8%AE%A1%E5%90%8C%E6%9E%84%E5%AD%90%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%95%B0%E7%9B%AE/"/>
      <url>/2022/12/26/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1759%20%E7%BB%9F%E8%AE%A1%E5%90%8C%E6%9E%84%E5%AD%90%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%95%B0%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个字符串 s ，返回 s 中 同构子字符串 的数目。由于答案可能很大，只需返回对 109 + 7 取余 后的结果。</p><p>同构字符串 的定义为：如果一个字符串中的所有字符都相同，那么该字符串就是同构字符串。</p><p>子字符串 是字符串中的一个连续字符序列。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “abbcccaa”<br>输出：13<br>解释：同构子字符串如下所列：<br>“a”   出现 3 次。<br>“aa”  出现 1 次。<br>“b”   出现 2 次。<br>“bb”  出现 1 次。<br>“c”   出现 3 次。<br>“cc”  出现 2 次。<br>“ccc” 出现 1 次。<br>3 + 1 + 2 + 1 + 3 + 2 + 1 &#x3D; 13</p></blockquote></div><div class="story post-story"><h2 id="思路：双指针"><a href="#思路：双指针" class="headerlink" title="思路：双指针"></a>思路：双指针</h2><p>遍历获得的每个字符串相同的子串的字符个数</p><p>通过公式：$m×(m+1)&#x2F;2$，计算出现的次数</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">countHomogenous</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">long</span> mod = <span class="number">1e9</span> + <span class="number">7</span>;</span><br><span class="line">        <span class="type">long</span> ans = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>()+<span class="number">1</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i == s.<span class="built_in">size</span>() || s[left] != s[i])&#123;</span><br><span class="line">                <span class="type">long</span> temp = i-left;</span><br><span class="line">                ans = (ans + (temp+<span class="number">1</span>)*temp/<span class="number">2</span>) % mod;</span><br><span class="line">                left = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1753. 移除石子的最大得分</title>
      <link href="/2022/12/21/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1753%20%E7%A7%BB%E9%99%A4%E7%9F%B3%E5%AD%90%E7%9A%84%E6%9C%80%E5%A4%A7%E5%BE%97%E5%88%86/"/>
      <url>/2022/12/21/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1753%20%E7%A7%BB%E9%99%A4%E7%9F%B3%E5%AD%90%E7%9A%84%E6%9C%80%E5%A4%A7%E5%BE%97%E5%88%86/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>你正在玩一个单人游戏，面前放置着大小分别为 <code>a</code>、<code>b</code> 和 <code>c</code> 的 <strong>三堆</strong> 石子。</p><p>每回合你都要从两个 <strong>不同的非空堆</strong> 中取出一颗石子，并在得分上加 <code>1</code> 分。当存在 <strong>两个或更多</strong> 的空堆时，游戏停止。</p><p>给你三个整数 <code>a</code> 、<code>b</code> 和 <code>c</code> ，返回可以得到的 <strong>最大分数</strong> 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：a &#x3D; 4, b &#x3D; 4, c &#x3D; 6<br>输出：7<br>解释：石子起始状态是 (4, 4, 6) ，最优的一组操作是：</p><ul><li>从第一和第二堆取，石子状态现在是 (3, 3, 6)</li><li>从第一和第三堆取，石子状态现在是 (2, 3, 5)</li><li>从第一和第三堆取，石子状态现在是 (1, 3, 4)</li><li>从第一和第三堆取，石子状态现在是 (0, 3, 3)</li><li>从第二和第三堆取，石子状态现在是 (0, 2, 2)</li><li>从第二和第三堆取，石子状态现在是 (0, 1, 1)</li><li>从第二和第三堆取，石子状态现在是 (0, 0, 0)</li></ul><p>总分：7 分 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：贪心"><a href="#代码-cpp-：贪心" class="headerlink" title="代码(cpp)：贪心"></a>代码(cpp)：贪心</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maximumScore</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; v&#123;a, b, c&#125;;</span><br><span class="line">        <span class="built_in">sort</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>());</span><br><span class="line">        <span class="comment">//每次选择最大的两个堆取</span></span><br><span class="line">        <span class="keyword">while</span>(v[<span class="number">1</span>] != <span class="number">0</span>)&#123;</span><br><span class="line">            ans++;</span><br><span class="line">            v[<span class="number">1</span>]--;</span><br><span class="line">            v[<span class="number">2</span>]--;</span><br><span class="line">            <span class="built_in">sort</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1785. 构成特定和需要添加的最少元素</title>
      <link href="/2022/12/16/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1785%20%E6%9E%84%E6%88%90%E7%89%B9%E5%AE%9A%E5%92%8C%E9%9C%80%E8%A6%81%E6%B7%BB%E5%8A%A0%E7%9A%84%E6%9C%80%E5%B0%91%E5%85%83%E7%B4%A0/"/>
      <url>/2022/12/16/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1785%20%E6%9E%84%E6%88%90%E7%89%B9%E5%AE%9A%E5%92%8C%E9%9C%80%E8%A6%81%E6%B7%BB%E5%8A%A0%E7%9A%84%E6%9C%80%E5%B0%91%E5%85%83%E7%B4%A0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数数组 <code>nums</code> ，和两个整数 <code>limit</code> 与 <code>goal</code> 。数组 <code>nums</code> 有一条重要属性：<code>abs(nums[i]) &lt;= limit</code> 。</p><p>返回使数组元素总和等于 <code>goal</code> 所需要向数组中添加的 <strong>最少元素数量</strong> ，添加元素 <strong>不应改变</strong> 数组中 <code>abs(nums[i]) &lt;= limit</code> 这一属性。</p><p>注意，如果 <code>x &gt;= 0</code> ，那么 <code>abs(x)</code> 等于 <code>x</code> ；否则，等于 <code>-x</code> 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [1,-1,1], limit &#x3D; 3, goal &#x3D; -4<br>输出：2<br>解释：可以将 -2 和 -3 添加到数组中，数组的元素总和变为 1 - 1 + 1 - 2 - 3 &#x3D; -4 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minElements</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> limit, <span class="type">int</span> goal)</span> </span>&#123;</span><br><span class="line">        <span class="type">long</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; num : nums)&#123;</span><br><span class="line">            sum += num;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> temp = <span class="built_in">abs</span>(sum-goal);</span><br><span class="line">        <span class="keyword">if</span>(temp%limit == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">abs</span>(sum-goal)/limit;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">abs</span>(sum-goal)/limit + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1945. 字符串转化后的各位数字之和</title>
      <link href="/2022/12/15/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1945%20%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E5%8C%96%E5%90%8E%E7%9A%84%E5%90%84%E4%BD%8D%E6%95%B0%E5%AD%97%E4%B9%8B%E5%92%8C/"/>
      <url>/2022/12/15/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1945%20%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E5%8C%96%E5%90%8E%E7%9A%84%E5%90%84%E4%BD%8D%E6%95%B0%E5%AD%97%E4%B9%8B%E5%92%8C/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个由小写字母组成的字符串 <code>s</code> ，以及一个整数 <code>k</code> 。</p><p>首先，用字母在字母表中的位置替换该字母，将 <code>s</code> <strong>转化</strong> 为一个整数（也就是，<code>&#39;a&#39;</code> 用 <code>1</code> 替换，<code>&#39;b&#39;</code> 用 <code>2</code> 替换，… <code>&#39;z&#39;</code> 用 <code>26</code> 替换）。接着，将整数 <strong>转换</strong> 为其 <strong>各位数字之和</strong> 。共重复 <strong>转换</strong> 操作 <strong><code>k</code> 次</strong> 。</p><p>例如，如果 <code>s = &quot;zbax&quot;</code> 且 <code>k = 2</code> ，那么执行下述步骤后得到的结果是整数 <code>8</code> ：</p><ul><li><strong>转化：</strong><code>&quot;zbax&quot; ➝ &quot;(26)(2)(1)(24)&quot; ➝ &quot;262124&quot; ➝ 262124</code></li><li><strong>转换 #1</strong>：<code>262124 ➝ 2 + 6 + 2 + 1 + 2 + 4 ➝ 17</code></li><li><strong>转换 #2</strong>：<code>17 ➝ 1 + 7 ➝ 8</code></li></ul><p>返回执行上述操作后得到的结果整数。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “leetcode”, k &#x3D; 2<br>输出：6<br>解释：操作如下：</p><ul><li><p>转化：”leetcode” ➝ “(12)(5)(5)(20)(3)(15)(4)(5)” ➝ “12552031545” ➝ 12552031545</p></li><li><p>转换 #1：12552031545 ➝ 1 + 2 + 5 + 5 + 2 + 0 + 3 + 1 + 5 + 4 + 5 ➝ 33</p></li><li><p>转换 #2：33 ➝ 3 + 3 ➝ 6</p></li></ul><p>因此，结果整数为 6 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getLucky</span><span class="params">(string s, <span class="type">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; c : s)&#123;</span><br><span class="line">            <span class="type">int</span> temp = c-<span class="string">&#x27;a&#x27;</span>+<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(temp)&#123;</span><br><span class="line">                ans += temp%<span class="number">10</span>;</span><br><span class="line">                temp /= <span class="number">10</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; k<span class="number">-1</span>; i++)&#123;</span><br><span class="line">            <span class="type">int</span> temp = ans;</span><br><span class="line">            ans = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>(temp)&#123;</span><br><span class="line">                ans += temp%<span class="number">10</span>;</span><br><span class="line">                temp /= <span class="number">10</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(n)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)2011. 执行操作后的变量值</title>
      <link href="/2022/12/15/%E6%AF%8F%E6%97%A5LeetCode/2022-12/2011%20%E6%89%A7%E8%A1%8C%E6%93%8D%E4%BD%9C%E5%90%8E%E7%9A%84%E5%8F%98%E9%87%8F%E5%80%BC/"/>
      <url>/2022/12/15/%E6%AF%8F%E6%97%A5LeetCode/2022-12/2011%20%E6%89%A7%E8%A1%8C%E6%93%8D%E4%BD%9C%E5%90%8E%E7%9A%84%E5%8F%98%E9%87%8F%E5%80%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>存在一种仅支持 4 种操作和 1 个变量 <code>X</code> 的编程语言：</p><ul><li><code>++X</code> 和 <code>X++</code> 使变量 <code>X</code> 的值 <strong>加</strong> <code>1</code></li><li><code>--X</code> 和 <code>X--</code> 使变量 <code>X</code> 的值 <strong>减</strong> <code>1</code></li></ul><p>最初，<code>X</code> 的值是 <code>0</code></p><p>给你一个字符串数组 <code>operations</code> ，这是由操作组成的一个列表，返回执行所有操作后， <code>X</code> 的 <strong>最终值</strong> 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：operations &#x3D; [“–X”,”X++”,”X++”]<br>输出：1<br>解释：操作按下述步骤执行：<br>最初，X &#x3D; 0<br>–X：X 减 1 ，X &#x3D;  0 - 1 &#x3D; -1<br>X++：X 加 1 ，X &#x3D; -1 + 1 &#x3D;  0<br>X++：X 加 1 ，X &#x3D;  0 + 1 &#x3D;  1</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">finalValueAfterOperations</span><span class="params">(vector&lt;string&gt;&amp; operations)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; operation : operations)&#123;</span><br><span class="line">            <span class="keyword">if</span>(operation[<span class="number">1</span>] == <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">                x++;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                x--;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1971. 寻找图中是否存在路径</title>
      <link href="/2022/12/15/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1971%20%E5%AF%BB%E6%89%BE%E5%9B%BE%E4%B8%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E8%B7%AF%E5%BE%84/"/>
      <url>/2022/12/15/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1971%20%E5%AF%BB%E6%89%BE%E5%9B%BE%E4%B8%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E8%B7%AF%E5%BE%84/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>有一个具有 <code>n</code> 个顶点的 <strong>双向</strong> 图，其中每个顶点标记从 <code>0</code> 到 <code>n - 1</code>（包含 <code>0</code> 和 <code>n - 1</code>）。图中的边用一个二维整数数组 <code>edges</code> 表示，其中 <code>edges[i] = [ui, vi]</code> 表示顶点 <code>ui</code> 和顶点 <code>vi</code> 之间的双向边。 每个顶点对由 <strong>最多一条</strong> 边连接，并且没有顶点存在与自身相连的边。</p><p>请你确定是否存在从顶点 <code>source</code> 开始，到顶点 <code>destination</code> 结束的 <strong>有效路径</strong> 。</p><p>给你数组 <code>edges</code> 和整数 <code>n</code>、<code>source</code> 和 <code>destination</code>，如果从 <code>source</code> 到 <code>destination</code> 存在 <strong>有效路径</strong> ，则返回 <code>true</code>，否则返回 <code>false</code> 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><p><img src="https://assets.leetcode.com/uploads/2021/08/14/validpath-ex2.png" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2021/08/14/validpath-ex2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><blockquote><p>输入：n &#x3D; 6, edges &#x3D; [[0,1],[0,2],[3,5],[5,4],[4,3]], source &#x3D; 0, destination &#x3D; 5<br>输出：false<br>解释：不存在由顶点 0 到顶点 5 的路径.</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：BFS"><a href="#代码-cpp-：BFS" class="headerlink" title="代码(cpp)：BFS"></a>代码(cpp)：BFS</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">validPath</span><span class="params">(<span class="type">int</span> n, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; edges, <span class="type">int</span> source, <span class="type">int</span> destination)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(source == destination)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">dp</span>(n);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; edges.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">dp[edges[i][<span class="number">0</span>]].<span class="built_in">emplace_back</span>(edges[i][<span class="number">1</span>]);</span><br><span class="line">            dp[edges[i][<span class="number">1</span>]].<span class="built_in">emplace_back</span>(edges[i][<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; queue;</span><br><span class="line">        queue.<span class="built_in">emplace</span>(source);</span><br><span class="line">        <span class="function">vector&lt;<span class="type">bool</span>&gt; <span class="title">flag</span><span class="params">(n, <span class="literal">false</span>)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>(!queue.<span class="built_in">empty</span>())&#123;</span><br><span class="line">            <span class="keyword">auto</span> cur = queue.<span class="built_in">front</span>();</span><br><span class="line">            queue.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; dp[cur].<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">                <span class="type">int</span> temp = dp[cur][i];</span><br><span class="line">                <span class="keyword">if</span>(temp == destination)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(!flag[temp])&#123;</span><br><span class="line">                    queue.<span class="built_in">emplace</span>(temp);</span><br><span class="line">                    flag[temp] = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n+m)，其中 n 表示图中顶点的数目，m 表示图中边的数目</li><li>空间复杂度：O(n+m)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1832. 判断句子是否为全字母句</title>
      <link href="/2022/12/13/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1832%20%E5%88%A4%E6%96%AD%E5%8F%A5%E5%AD%90%E6%98%AF%E5%90%A6%E4%B8%BA%E5%85%A8%E5%AD%97%E6%AF%8D%E5%8F%A5/"/>
      <url>/2022/12/13/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1832%20%E5%88%A4%E6%96%AD%E5%8F%A5%E5%AD%90%E6%98%AF%E5%90%A6%E4%B8%BA%E5%85%A8%E5%AD%97%E6%AF%8D%E5%8F%A5/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p><strong>全字母句</strong> 指包含英语字母表中每个字母至少一次的句子。</p><p>给你一个仅由小写英文字母组成的字符串 <code>sentence</code> ，请你判断 <code>sentence</code> 是否为 <strong>全字母句</strong> 。</p><p>如果是，返回 <code>true</code> ；否则，返回 <code>false</code> 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：sentence &#x3D; “thequickbrownfoxjumpsoverthelazydog”<br>输出：true<br>解释：sentence 包含英语字母表中每个字母至少一次。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">checkIfPangram</span><span class="params">(string sentence)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(sentence.<span class="built_in">size</span>() &lt; <span class="number">26</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">map</span><span class="params">(<span class="number">26</span>)</span></span>;</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt;sentence.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map[sentence[i]-<span class="string">&#x27;a&#x27;</span>]++ == <span class="number">0</span>)</span><br><span class="line">                count++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count == <span class="number">26</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(C)，C为26字母</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1781. 所有子字符串美丽值之和</title>
      <link href="/2022/12/12/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1781%20%E6%89%80%E6%9C%89%E5%AD%90%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BE%8E%E4%B8%BD%E5%80%BC%E4%B9%8B%E5%92%8C/"/>
      <url>/2022/12/12/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1781%20%E6%89%80%E6%9C%89%E5%AD%90%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BE%8E%E4%B8%BD%E5%80%BC%E4%B9%8B%E5%92%8C/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>一个字符串的 <strong>美丽值</strong> 定义为：出现频率最高字符与出现频率最低字符的出现次数之差。</p><p>比方说，<code>&quot;abaacc&quot;</code> 的美丽值为 <code>3 - 1 = 2</code> 。</p><p>给你一个字符串 <code>s</code> ，请你返回它所有子字符串的 <strong>美丽值</strong> 之和。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “aabcb”<br>输出：5<br>解释：美丽值不为零的字符串包括 [“aab”,”aabc”,”aabcb”,”abcb”,”bcb”] ，每一个字符串的美丽值都为 1 。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>获得s字符串所有的组合</p><p>利用哈希表记录字母出现的次数，依次计算相应的美丽值，返回总和</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">beautySum</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>(); i++)&#123; <span class="comment">//定义字符串的开头</span></span><br><span class="line">            <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">map</span><span class="params">(<span class="number">26</span>)</span></span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = i; j &lt; s.<span class="built_in">size</span>(); j++)&#123; <span class="comment">//每一次遍历就是一次字符串的尾部</span></span><br><span class="line">                map[s[j]-<span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> maxNum = <span class="number">0</span>;</span><br><span class="line">                <span class="type">int</span> minNum = INT_MAX;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; m : map)&#123; <span class="comment">//获取当前字符串中字母的出现最大、最小次数</span></span><br><span class="line">                    <span class="keyword">if</span>(m == <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    maxNum = <span class="built_in">max</span>(maxNum, m);</span><br><span class="line">                    minNum = <span class="built_in">min</span>(minNum, m);</span><br><span class="line">                &#125;</span><br><span class="line">                ans += maxNum-minNum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(C*n^2^)，其中 C 是 s 的元素种类，n 是 s 的长度。</li><li>空间复杂度：O(C)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1827. 最少操作使数组递增</title>
      <link href="/2022/12/11/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1827%20%E6%9C%80%E5%B0%91%E6%93%8D%E4%BD%9C%E4%BD%BF%E6%95%B0%E7%BB%84%E9%80%92%E5%A2%9E/"/>
      <url>/2022/12/11/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1827%20%E6%9C%80%E5%B0%91%E6%93%8D%E4%BD%9C%E4%BD%BF%E6%95%B0%E7%BB%84%E9%80%92%E5%A2%9E/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数数组 nums （下标从 0 开始）。每一次操作中，你可以选择数组中一个元素，并将它增加 1 。</p><p>比方说，如果 nums &#x3D; [1,2,3] ，你可以选择增加 nums[1] 得到 nums &#x3D; [1,3,3] 。<br>请你返回使 nums 严格递增 的 最少 操作次数。</p><p>我们称数组 nums 是 严格递增的 ，当它满足对于所有的 0 &lt;&#x3D; i &lt; nums.length - 1 都有 nums[i] &lt; nums[i+1] 。一个长度为 1 的数组是严格递增的一种特殊情况。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [1,1,1]<br>输出：3<br>解释：你可以进行如下操作：</p><ol><li>增加 nums[2] ，数组变为 [1,1,2] 。</li><li>增加 nums[1] ，数组变为 [1,2,2] 。</li><li>增加 nums[2] ，数组变为 [1,2,3] 。</li></ol></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minOperations</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(nums.<span class="built_in">size</span>() == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; nums.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[i] &lt;= nums[i<span class="number">-1</span>])&#123;</span><br><span class="line">                ans += nums[i<span class="number">-1</span>] - nums[i] + <span class="number">1</span>;</span><br><span class="line">                nums[i] = nums[i<span class="number">-1</span>] + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1780. 判断一个数字是否可以表示成三的幂的和</title>
      <link href="/2022/12/09/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1780%20%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E6%95%B0%E5%AD%97%E6%98%AF%E5%90%A6%E5%8F%AF%E4%BB%A5%E8%A1%A8%E7%A4%BA%E6%88%90%E4%B8%89%E7%9A%84%E5%B9%82%E7%9A%84%E5%92%8C/"/>
      <url>/2022/12/09/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1780%20%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E6%95%B0%E5%AD%97%E6%98%AF%E5%90%A6%E5%8F%AF%E4%BB%A5%E8%A1%A8%E7%A4%BA%E6%88%90%E4%B8%89%E7%9A%84%E5%B9%82%E7%9A%84%E5%92%8C/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数 n ，如果你可以将 n 表示成<strong>若干个不同的三的幂之和</strong>，请你返回 true ，否则请返回 false 。</p><p>对于一个整数 y ，如果存在整数 x 满足 y &#x3D;&#x3D; 3x ，我们称这个整数 y 是三的幂。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：n &#x3D; 91<br>输出：true<br>解释：91 &#x3D; 3^0^ + 3^2^ + 3^4^</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：三进制模拟"><a href="#代码-cpp-：三进制模拟" class="headerlink" title="代码(cpp)：三进制模拟"></a>代码(cpp)：三进制模拟</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">checkPowersOfThree</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(n)&#123;</span><br><span class="line">            <span class="keyword">if</span>(n % <span class="number">3</span> == <span class="number">2</span>) <span class="comment">//只能存在一种3的幂之和，不能为两个</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            n /= <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(logn)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1812. 判断国际象棋棋盘中一个格子的颜色</title>
      <link href="/2022/12/08/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1812%20%E5%88%A4%E6%96%AD%E5%9B%BD%E9%99%85%E8%B1%A1%E6%A3%8B%E6%A3%8B%E7%9B%98%E4%B8%AD%E4%B8%80%E4%B8%AA%E6%A0%BC%E5%AD%90%E7%9A%84%E9%A2%9C%E8%89%B2/"/>
      <url>/2022/12/08/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1812%20%E5%88%A4%E6%96%AD%E5%9B%BD%E9%99%85%E8%B1%A1%E6%A3%8B%E6%A3%8B%E7%9B%98%E4%B8%AD%E4%B8%80%E4%B8%AA%E6%A0%BC%E5%AD%90%E7%9A%84%E9%A2%9C%E8%89%B2/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个坐标 <code>coordinates</code> ，它是一个字符串，表示国际象棋棋盘中一个格子的坐标。下图是国际象棋棋盘示意图。</p><img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2021/04/03/chessboard.png" class="lazyload" data-srcset="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2021/04/03/chessboard.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 33%;" /></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：coordinates &#x3D; “a1”<br>输出：false<br>解释：如上图棋盘所示，”a1” 坐标的格子是黑色的，所以返回 false 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">squareIsWhite</span><span class="params">(string coordinates)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (coordinates[<span class="number">0</span>]+coordinates[<span class="number">1</span>])%<span class="number">2</span> != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(1)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1775. 通过最少操作次数使数组的和相等</title>
      <link href="/2022/12/07/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1775%20%E9%80%9A%E8%BF%87%E6%9C%80%E5%B0%91%E6%93%8D%E4%BD%9C%E6%AC%A1%E6%95%B0%E4%BD%BF%E6%95%B0%E7%BB%84%E7%9A%84%E5%92%8C%E7%9B%B8%E7%AD%89/"/>
      <url>/2022/12/07/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1775%20%E9%80%9A%E8%BF%87%E6%9C%80%E5%B0%91%E6%93%8D%E4%BD%9C%E6%AC%A1%E6%95%B0%E4%BD%BF%E6%95%B0%E7%BB%84%E7%9A%84%E5%92%8C%E7%9B%B8%E7%AD%89/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你两个长度可能不等的整数数组 nums1 和 nums2 。两个数组中的所有值都在 1 到 6 之间（包含 1 和 6）。</p><p>每次操作中，你可以选择 任意 数组中的任意一个整数，将它变成 1 到 6 之间 任意 的值（包含 1 和 6）。</p><p>请你返回使 nums1 中所有数的和与 nums2 中所有数的和相等的最少操作次数。如果无法使两个数组的和相等，请返回 -1 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums1 &#x3D; [1,2,3,4,5,6], nums2 &#x3D; [1,1,2,2,2,2]<br>输出：3<br>解释：你可以通过 3 次操作使 nums1 中所有数的和与 nums2 中所有数的和相等。以下数组下标都从 0 开始。</p><ul><li>将 nums2[0] 变为 6 。 nums1 &#x3D; [1,2,3,4,5,6], nums2 &#x3D; [6,1,2,2,2,2] 。</li><li>将 nums1[5] 变为 1 。 nums1 &#x3D; [1,2,3,4,5,1], nums2 &#x3D; [6,1,2,2,2,2] 。</li><li>将 nums1[2] 变为 2 。 nums1 &#x3D; [1,2,2,4,5,1], nums2 &#x3D; [6,1,2,2,2,2] 。</li></ul></blockquote></div><div class="story post-story"><h2 id="思路：贪心"><a href="#思路：贪心" class="headerlink" title="思路：贪心"></a>思路：贪心</h2><p>分别获取nums1,nums2的总和，选择出最大值max，最小值min</p><p>将nums1,nums2排序后，</p><ul><li><p>属于最大值max的数组，从后往前遍历</p></li><li><p>属于最小值min的数组，从前往后遍历</p></li></ul><p>如果min的数组中的当前元素可以增加量 大于 max的数组中的当前元素可以减小量</p><ul><li>min加上增加量</li></ul><p>同理，如果小于</p><ul><li>max减去减小量</li></ul><p>直到 min &gt;&#x3D; max 为止，返回次数</p><p>或者增加量、减小量为0时，因为无法在增加或者减小了，返回-1</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">update</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; maxNums, vector&lt;<span class="type">int</span>&gt;&amp; minNums, <span class="type">int</span> max, <span class="type">int</span> min)</span></span>&#123;</span><br><span class="line">        <span class="type">int</span> maxRight = maxNums.<span class="built_in">size</span>()<span class="number">-1</span>;</span><br><span class="line">        <span class="type">int</span> minLeft = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(max &gt; min)&#123;</span><br><span class="line">            <span class="type">int</span> maxTemp = <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> minTemp = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>(minLeft &lt; minNums.<span class="built_in">size</span>())</span><br><span class="line">                minTemp = <span class="number">6</span> - minNums[minLeft];</span><br><span class="line">            <span class="keyword">if</span>(maxRight &gt;= <span class="number">0</span>)</span><br><span class="line">                maxTemp = maxNums[maxRight] - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(maxTemp == <span class="number">0</span> &amp;&amp; minTemp == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(maxTemp &gt; minTemp)&#123;</span><br><span class="line">                max -= maxTemp;</span><br><span class="line">                maxRight--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;    </span><br><span class="line">                min += minTemp;</span><br><span class="line">                minLeft++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            count++;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minOperations</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums1, vector&lt;<span class="type">int</span>&gt;&amp; nums2)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">sort</span>(nums1.<span class="built_in">begin</span>(), nums1.<span class="built_in">end</span>());</span><br><span class="line">        <span class="built_in">sort</span>(nums2.<span class="built_in">begin</span>(), nums2.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> num1Sum = <span class="built_in">accumulate</span>(nums1.<span class="built_in">begin</span>(), nums1.<span class="built_in">end</span>(), <span class="number">0</span>);</span><br><span class="line">        <span class="type">int</span> num2Sum = <span class="built_in">accumulate</span>(nums2.<span class="built_in">begin</span>(), nums2.<span class="built_in">end</span>(), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span>(num1Sum &gt; num2Sum)&#123;</span><br><span class="line">            ans = <span class="built_in">update</span>(nums1, nums2, num1Sum, num2Sum);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            ans = <span class="built_in">update</span>(nums2, nums1, num2Sum, num1Sum);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(nums1+nums2)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1805. 字符串中不同整数的数目</title>
      <link href="/2022/12/06/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1805%20%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E4%B8%8D%E5%90%8C%E6%95%B4%E6%95%B0%E7%9A%84%E6%95%B0%E7%9B%AE/"/>
      <url>/2022/12/06/%E6%AF%8F%E6%97%A5LeetCode/2022-12/1805%20%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E4%B8%8D%E5%90%8C%E6%95%B4%E6%95%B0%E7%9A%84%E6%95%B0%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<p>题目：</p><p>给你一个字符串 word ，该字符串由数字和小写英文字母组成。</p><p>请你用空格替换每个不是数字的字符。例如，”a123bc34d8ef34” 将会变成 “ 123  34 8  34” 。注意，剩下的这些整数为（相邻彼此至少有一个空格隔开）：”123”、”34”、”8” 和 “34” 。</p><p>返回对 word 完成替换后形成的 不同 整数的数目。</p><p>只有当两个整数的 不含前导零 的十进制表示不同， 才认为这两个整数也不同。</p><p>示例：</p><blockquote><p>输入：word &#x3D; “a123bc34d8ef34”<br>输出：3<br>解释：不同的整数有 “123”、”34” 和 “8” 。注意，”34” 只计数一次。</p></blockquote><p>代码(CPP)：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    unordered_set&lt;string&gt; set;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">numDifferentIntegers</span><span class="params">(string word)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; word.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">isdigit</span>(word[i]))&#123;</span><br><span class="line">                <span class="comment">//得到数字的第一位的位置</span></span><br><span class="line">                <span class="type">int</span> begin = i;</span><br><span class="line">                <span class="comment">//得到数字的后一位的位置</span></span><br><span class="line">                <span class="keyword">while</span>(i &lt; word.<span class="built_in">size</span>() &amp;&amp; <span class="built_in">isdigit</span>(word[i]))&#123;</span><br><span class="line">                    i++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">int</span> end = i;</span><br><span class="line">                <span class="comment">//除去开头的0</span></span><br><span class="line">                <span class="keyword">while</span>(begin &lt; end<span class="number">-1</span> &amp;&amp; word[begin] == <span class="string">&#x27;0&#x27;</span>)&#123;</span><br><span class="line">                    begin++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                string str = word.<span class="built_in">substr</span>(begin, end-begin);</span><br><span class="line">                set.<span class="built_in">insert</span>(str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> set.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>复杂度分析：</p><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(n)</li></ul>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1758. 生成交替二进制字符串的最少操作数</title>
      <link href="/2022/11/29/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1758%20%E7%94%9F%E6%88%90%E4%BA%A4%E6%9B%BF%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%9C%80%E5%B0%91%E6%93%8D%E4%BD%9C%E6%95%B0/"/>
      <url>/2022/11/29/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1758%20%E7%94%9F%E6%88%90%E4%BA%A4%E6%9B%BF%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%9C%80%E5%B0%91%E6%93%8D%E4%BD%9C%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个仅由字符 ‘0’ 和 ‘1’ 组成的字符串 s 。一步操作中，你可以将任一 ‘0’ 变成 ‘1’ ，或者将 ‘1’ 变成 ‘0’ 。</p><p>交替字符串 定义为：如果字符串中不存在相邻两个字符相等的情况，那么该字符串就是交替字符串。例如，字符串 “010” 是交替字符串，而字符串 “0100” 不是。</p><p>返回使 s 变成 交替字符串 所需的 最少 操作数。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “0100”<br>输出：1<br>解释：如果将最后一个字符变为 ‘1’ ，s 就变成 “0101” ，即符合交替字符串定义。</p></blockquote></div><div class="story post-story"><h2 id="思路：模拟"><a href="#思路：模拟" class="headerlink" title="思路：模拟"></a>思路：模拟</h2><p>一共两种方式：”01”和”10”</p><p>用这两种方式遍历s，来得到最小替换次数</p></div><div class="story post-story"><h2 id="代码：-CPP"><a href="#代码：-CPP" class="headerlink" title="代码：(CPP)"></a>代码：(CPP)</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minOperations</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans1 = <span class="number">0</span>;   <span class="comment">//&quot;01&quot;</span></span><br><span class="line">        <span class="type">int</span> ans2 = <span class="number">0</span>;   <span class="comment">//&quot;10&quot;</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">if</span>(s[i] == <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">                    ans1++;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ans2++;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span>(s[i] == <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                    ans1++;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ans2++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(ans1, ans2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1732. 找到最高海拔</title>
      <link href="/2022/11/19/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1732%20%E6%89%BE%E5%88%B0%E6%9C%80%E9%AB%98%E6%B5%B7%E6%8B%94/"/>
      <url>/2022/11/19/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1732%20%E6%89%BE%E5%88%B0%E6%9C%80%E9%AB%98%E6%B5%B7%E6%8B%94/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>有一个自行车手打算进行一场公路骑行，这条路线总共由 n + 1 个不同海拔的点组成。自行车手从海拔为 0 的点 0 开始骑行。</p><p>给你一个长度为 n 的整数数组 gain ，其中 gain[i] 是点 i 和点 i + 1 的 净海拔高度差（0 &lt;&#x3D; i &lt; n）。请你返回 最高点的海拔 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：gain &#x3D; [-5,1,5,0,-7]<br>输出：1<br>解释：海拔高度依次为 [0,-5,-4,1,1,-6] 。最高海拔为 1 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">largestAltitude</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; gain)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> pri = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; g : gain)&#123;</span><br><span class="line">            pri += g;</span><br><span class="line">            ans = <span class="built_in">max</span>(ans, pri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)775. 全局倒置与局部倒置</title>
      <link href="/2022/11/16/%E6%AF%8F%E6%97%A5LeetCode/2022-11/775%20%E5%85%A8%E5%B1%80%E5%80%92%E7%BD%AE%E4%B8%8E%E5%B1%80%E9%83%A8%E5%80%92%E7%BD%AE/"/>
      <url>/2022/11/16/%E6%AF%8F%E6%97%A5LeetCode/2022-11/775%20%E5%85%A8%E5%B1%80%E5%80%92%E7%BD%AE%E4%B8%8E%E5%B1%80%E9%83%A8%E5%80%92%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个长度为 n 的整数数组 nums ，表示由范围 [0, n - 1] 内所有整数组成的一个排列。</p><p>全局倒置 的数目等于满足下述条件不同下标对 (i, j) 的数目：</p><ul><li><code>0 &lt;= i &lt; j &lt; n</code></li><li><code>nums[i] &gt; nums[j]</code></li></ul><p>局部倒置 的数目等于满足下述条件的下标 i 的数目：</p><ul><li><code>0 &lt;= i &lt; n - 1</code></li><li><code>nums[i] &gt; nums[i + 1]</code></li></ul><p>当数组 nums 中 全局倒置 的数量等于 局部倒置 的数量时，返回 true ；否则，返回 false 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [1,2,0]<br>输出：false<br>解释：有 2 个全局倒置，和 1 个局部倒置。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>局部倒置一定是全局倒置，全局倒置不一定是局部倒置。</p><p>所以只要<strong>存在</strong>一个<strong>非局部倒置</strong>的全局倒置，那就不相等，返回false</p><p>不存在这样的全局倒置，返回true</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isIdealPermutation</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> temp = nums[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">2</span>; i &lt; nums.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(temp &gt; nums[i])</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">//如果有比temp还大的数字，替换。因为更大的数字有更大的可能找到小的数字</span></span><br><span class="line">            temp = <span class="built_in">max</span>(temp, nums[i<span class="number">-1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1710. 卡车上的最大单元数</title>
      <link href="/2022/11/15/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1710%20%E5%8D%A1%E8%BD%A6%E4%B8%8A%E7%9A%84%E6%9C%80%E5%A4%A7%E5%8D%95%E5%85%83%E6%95%B0/"/>
      <url>/2022/11/15/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1710%20%E5%8D%A1%E8%BD%A6%E4%B8%8A%E7%9A%84%E6%9C%80%E5%A4%A7%E5%8D%95%E5%85%83%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>请你将一些箱子装在 一辆卡车 上。给你一个二维数组 boxTypes ，其中 boxTypes[i] &#x3D; [numberOfBoxesi, numberOfUnitsPerBoxi] ：</p><ul><li><p>numberOfBoxesi 是类型 i 的箱子的数量。</p></li><li><p>numberOfUnitsPerBoxi 是类型 i 每个箱子可以装载的单元数量。</p></li></ul><p>整数 truckSize 表示卡车上可以装载 箱子 的 最大数量 。只要箱子数量不超过 truckSize ，你就可以选择任意箱子装到卡车上。</p><p>返回卡车可以装载 单元 的 最大 总数。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：boxTypes &#x3D; [[1,3],[2,2],[3,1]], truckSize &#x3D; 4<br>输出：8<br>解释：箱子的情况如下：</p><ul><li>1 个第一类的箱子，里面含 3 个单元。</li><li>2 个第二类的箱子，每个里面含 2 个单元。</li><li>3 个第三类的箱子，每个里面含 1 个单元。</li></ul><p>可以选择第一类和第二类的所有箱子，以及第三类的一个箱子。<br>单元总数 &#x3D; (1 * 3) + (2 * 2) + (1 * 1) &#x3D; 8</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：贪心"><a href="#代码-cpp-：贪心" class="headerlink" title="代码(cpp)：贪心"></a>代码(cpp)：贪心</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maximumUnits</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; boxTypes, <span class="type">int</span> truckSize)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">sort</span>(boxTypes.<span class="built_in">begin</span>(), boxTypes.<span class="built_in">end</span>(),[](<span class="keyword">auto</span>&amp; x, <span class="keyword">auto</span>&amp; y)&#123;</span><br><span class="line">            <span class="keyword">return</span> x[<span class="number">1</span>] &gt; y[<span class="number">1</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; boxTypes.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(truckSize - boxTypes[i][<span class="number">0</span>] &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                ans += truckSize*boxTypes[i][<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                truckSize -= boxTypes[i][<span class="number">0</span>];</span><br><span class="line">                ans += boxTypes[i][<span class="number">0</span>]*boxTypes[i][<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2022/11/14/Java/JVM/"/>
      <url>/2022/11/14/Java/JVM/</url>
      
        <content type="html"><![CDATA[<hr><hr><div class="story post-story"><h2 id="1-内存结构"><a href="#1-内存结构" class="headerlink" title="1.内存结构"></a>1.内存结构</h2><h3 id="1-1-程序计数器"><a href="#1-1-程序计数器" class="headerlink" title="1.1 程序计数器"></a>1.1 程序计数器</h3><p>Program Counter Register程序计数器(寄存器)</p><p>作用：记录下一条jvm指令的执行地址</p><p>特点：</p><ul><li>线程是私有的(在多线程中，每个线程都一个程序计数器)</li><li>程序计数器不会存在内存溢出</li></ul><h3 id="1-2-虚拟机栈"><a href="#1-2-虚拟机栈" class="headerlink" title="1.2 虚拟机栈"></a>1.2 虚拟机栈</h3><p><strong>栈和栈帧</strong></p><p>栈：线程运行需要的内存空间</p><p>栈帧：每个方法运行需要的内存</p><ul><li>方法运行时需要的内存：参数、局部变量、返回地址</li></ul><p><strong>定义</strong></p><p><code>Java Virtual Machine Stacks</code>(Java虚拟机栈)</p><ul><li>每个线程运行时所需的内存，称之为虚拟机栈</li><li>每个栈由多个栈帧(Frame)组成，对应着每次方法调用时所占用的内存</li><li>每个线程只能有一个<strong>活动栈帧</strong>，对应着当前正在执行的那个方法</li></ul><p><strong>栈的演示</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throw</span> InterruptedException&#123;</span><br><span class="line">method1();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span>&#123;</span><br><span class="line">method2(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>&#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> a + b;</span><br><span class="line"><span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行顺序：</p><ol><li><p>执行main主方法，将main主方法入栈。</p><p>此时活动栈帧为main</p></li><li><p>调用method1方法，将method1方法申请一块内存，入栈。开始执行method1方法。</p><p>此时活动栈帧为method1</p></li><li><p>调用method2方法，将method2方法申请一块内存(参数，局部变量，返回地址)，入栈。</p><p>此时活动栈帧为method2</p></li><li><p>method2方法执行完毕，释放内存，出栈。开始执行method1方法</p><p>此时活动栈帧为method1</p></li><li><p>method1方法执行完毕，释放内存，出栈。开始执行main主方法</p><p>此时活动栈帧为main</p></li><li><p>main主方法执行完毕，释放内存，出栈。</p></li><li><p>执行结束。</p></li></ol><p><strong>相关问题</strong></p><ul><li><p>垃圾回收是否涉及到栈内存？</p><ul><li>不会，方法执行完毕后，会自动释放内存</li></ul></li><li><p>栈内存分配越大越好吗？</p><ul><li><p><code>-Xss[size]</code>：linux系统默认为1024KB</p><p>分配1mb栈内存：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xss1m</span><br><span class="line">-Xss1024k</span><br></pre></td></tr></table></figure></li><li><p>不是，分配内存越大，线程数越少</p></li></ul></li><li><p>方法内的局部变量是否线程安全？</p><ul><li>线程是否安全看变量是否共享，每个局部变量都在各自的栈帧中，线程不共享</li><li>类中的static成员变量在方法区是共享的，导致线程不安全</li></ul></li></ul></div>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1684. 统计一致字符串的数目</title>
      <link href="/2022/11/13/%E6%AF%8F%E6%97%A5LeetCode/2022-11/791%20%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8E%92%E5%BA%8F/"/>
      <url>/2022/11/13/%E6%AF%8F%E6%97%A5LeetCode/2022-11/791%20%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8E%92%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定两个字符串 order 和 s 。order 的所有单词都是 唯一 的，并且以前按照一些自定义的顺序排序。</p><p>对 s 的字符进行置换，使其与排序的 order 相匹配。更具体地说，如果在 order 中的字符 x 出现字符 y 之前，那么在排列后的字符串中， x 也应该出现在 y 之前。</p><p>返回 满足这个性质的 s 的任意排列 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入: order &#x3D; “cba”, s &#x3D; “abcd”<br>输出: “cbad”<br>解释:<br>“a”、“b”、“c”是按顺序出现的，所以“a”、“b”、“c”的顺序应该是“c”、“b”、“a”。<br>因为“d”不是按顺序出现的，所以它可以在返回的字符串中的任何位置。“dcba”、“cdba”、“cbda”也是有效的输出。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：哈希表"><a href="#代码-cpp-：哈希表" class="headerlink" title="代码(cpp)：哈希表"></a>代码(cpp)：哈希表</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">customSortString</span><span class="params">(string order, string s)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">map</span><span class="params">(<span class="number">26</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; c : s)&#123;</span><br><span class="line">            map[c-<span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        string ans = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; o : order)&#123;</span><br><span class="line">            <span class="keyword">while</span>(map[o-<span class="string">&#x27;a&#x27;</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                ans.<span class="built_in">push_back</span>(o);</span><br><span class="line">                map[o-<span class="string">&#x27;a&#x27;</span>]--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">while</span>(map[i] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                ans.<span class="built_in">push_back</span>(<span class="string">&#x27;a&#x27;</span>+i);</span><br><span class="line">                map[i]--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(n)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)790. 多米诺和托米诺平铺</title>
      <link href="/2022/11/12/%E6%AF%8F%E6%97%A5LeetCode/2022-11/790%20%E5%A4%9A%E7%B1%B3%E8%AF%BA%E5%92%8C%E6%89%98%E7%B1%B3%E8%AF%BA%E5%B9%B3%E9%93%BA/"/>
      <url>/2022/11/12/%E6%AF%8F%E6%97%A5LeetCode/2022-11/790%20%E5%A4%9A%E7%B1%B3%E8%AF%BA%E5%92%8C%E6%89%98%E7%B1%B3%E8%AF%BA%E5%B9%B3%E9%93%BA/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>有两种形状的瓷砖：一种是 2 x 1 的多米诺形，另一种是形如 “L” 的托米诺形。两种形状都可以旋转。\</p><img src="https://assets.leetcode.com/uploads/2021/07/15/lc-domino.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2021/07/15/lc-domino.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:67%;" /><p>给定整数 n ，返回可以平铺 2 x n 的面板的方法的数量。返回对 109 + 7 取模 的值。</p><p>平铺指的是每个正方形都必须有瓷砖覆盖。两个平铺不同，当且仅当面板上有四个方向上的相邻单元中的两个，使得恰好有一个平铺有一个瓷砖占据两个正方形。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2021/07/15/lc-domino1.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2021/07/15/lc-domino1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:50%;" /><blockquote><p>输入: n &#x3D; 3<br>输出: 5<br>解释: 五种不同的方法如上所示。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><img src="https://pic.leetcode.cn/1668157188-nBzesC-790-5.png" class="lazyload" data-srcset="https://pic.leetcode.cn/1668157188-nBzesC-790-5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 67%;" /></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码 (cpp)："></a>代码 (cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> MOD = <span class="number">1e9</span> + <span class="number">7</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">numTilings</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">1</span>) </span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> f[n + <span class="number">1</span>];</span><br><span class="line">        f[<span class="number">0</span>] = f[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        f[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">3</span>; i &lt;= n; ++i)&#123;</span><br><span class="line">            f[i] = (f[i - <span class="number">1</span>] * <span class="number">2</span> + f[i - <span class="number">3</span>]) % MOD;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> f[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(n)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1704. 判断字符串的两半是否相似</title>
      <link href="/2022/11/11/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1704%20%E5%88%A4%E6%96%AD%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E4%B8%A4%E5%8D%8A%E6%98%AF%E5%90%A6%E7%9B%B8%E4%BC%BC/"/>
      <url>/2022/11/11/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1704%20%E5%88%A4%E6%96%AD%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E4%B8%A4%E5%8D%8A%E6%98%AF%E5%90%A6%E7%9B%B8%E4%BC%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个偶数长度的字符串 s 。将其拆分成长度相同的两半，前一半为 a ，后一半为 b 。</p><p>两个字符串 相似 的前提是它们都含有相同数目的元音（’a’，’e’，’i’，’o’，’u’，’A’，’E’，’I’，’O’，’U’）。注意，s 可能同时含有大写和小写字母。</p><p>如果 a 和 b 相似，返回 true ；否则，返回 false 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “textbook”<br>输出：false<br>解释：a &#x3D; “text” 且 b &#x3D; “book” 。a 中有 1 个元音，b 中有 2 个元音。因此，a 和 b 不相似。<br>注意，元音 o 在 b 中出现两次，记为 2 个。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">halvesAreAlike</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        string vowel = <span class="string">&quot;aeiouAEIOU&quot;</span>;</span><br><span class="line">        unordered_map&lt;<span class="type">char</span>, <span class="type">int</span>&gt; map;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; v : vowel)&#123;</span><br><span class="line">            map[v]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> size = s.<span class="built_in">size</span>()/<span class="number">2</span>;</span><br><span class="line">        <span class="type">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map[s[i]] == <span class="number">1</span>)</span><br><span class="line">                left++;</span><br><span class="line">            <span class="keyword">if</span>(map[s[size+i]] == <span class="number">1</span>)</span><br><span class="line">                right++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> left == right;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)864. 获取所有钥匙的最短路径</title>
      <link href="/2022/11/10/%E6%AF%8F%E6%97%A5LeetCode/2022-11/864%20%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E9%92%A5%E5%8C%99%E7%9A%84%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84/"/>
      <url>/2022/11/10/%E6%AF%8F%E6%97%A5LeetCode/2022-11/864%20%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E9%92%A5%E5%8C%99%E7%9A%84%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个二维网格 grid ，其中：</p><ul><li><p>‘.’ 代表一个空房间</p></li><li><p>‘#’ 代表一堵</p></li><li><p>‘@’ 是起点</p></li><li><p>小写字母代表钥匙</p></li><li><p>大写字母代表锁</p></li></ul><p>我们从起点开始出发，一次移动是指向四个基本方向之一行走一个单位空间。我们不能在网格外面行走，也无法穿过一堵墙。如果途经一个钥匙，我们就把它捡起来。除非我们手里有对应的钥匙，否则无法通过锁。</p><p>假设 k 为 钥匙&#x2F;锁 的个数，且满足 1 &lt;&#x3D; k &lt;&#x3D; 6，字母表中的前 k 个字母在网格中都有自己对应的一个小写和一个大写字母。换言之，每个锁有唯一对应的钥匙，每个钥匙也有唯一对应的锁。另外，代表钥匙和锁的字母互为大小写并按字母顺序排列。</p><p>返回获取所有钥匙所需要的移动的最少次数。如果无法获取所有钥匙，返回 -1 。</p><h3 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h3><p><img src="https://assets.leetcode.com/uploads/2021/07/23/lc-keys2.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2021/07/23/lc-keys2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><blockquote><p>输入：grid &#x3D; [“@.a.#”,”###.#”,”b.A.B”]<br>输出：8<br>解释：目标是获得所有钥匙，而不是打开所有锁。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：BFS"><a href="#代码-cpp-：BFS" class="headerlink" title="代码(cpp)：BFS"></a>代码(cpp)：BFS</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">shortestPathAllKeys</span><span class="params">(vector&lt;string&gt;&amp; grid)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> first, end;    <span class="comment">//记录起始地点</span></span><br><span class="line">        <span class="type">int</span> all_k = <span class="number">0</span>;<span class="comment">//记录钥匙的总数</span></span><br><span class="line">        <span class="type">int</span> dir[<span class="number">4</span>][<span class="number">2</span>] = &#123;&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">-1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,&#123;<span class="number">0</span>,<span class="number">-1</span>&#125;&#125;;</span><br><span class="line">        <span class="type">int</span> m = grid.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> n = grid[<span class="number">0</span>].<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++)&#123;</span><br><span class="line">                <span class="type">char</span> c = grid[i][j];</span><br><span class="line">                <span class="keyword">if</span>(c == <span class="string">&#x27;@&#x27;</span>)&#123; <span class="comment">//获取起始地点的位置</span></span><br><span class="line">                    first = i;</span><br><span class="line">                    end = j;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">islower</span>(c)) <span class="comment">//如果为小写则钥匙总数加1</span></span><br><span class="line">                    all_k++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//记录已经遍历过的状态[x][y][k]</span></span><br><span class="line">        vector&lt;vector&lt;vector&lt;<span class="type">bool</span>&gt;&gt;&gt; <span class="built_in">flag</span>(m, vector&lt;vector&lt;<span class="type">bool</span>&gt;&gt;(n, <span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt;(<span class="number">1</span> &lt;&lt; all_k)));</span><br><span class="line">        flag[first][end][<span class="number">0</span>] = <span class="literal">true</span>;<span class="comment">//将起始地点标记</span></span><br><span class="line">        </span><br><span class="line">        queue&lt;tuple&lt;<span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>&gt;&gt; queue;</span><br><span class="line">        queue.<span class="built_in">emplace</span>(first, end, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//BFS</span></span><br><span class="line">        <span class="keyword">while</span>(!queue.<span class="built_in">empty</span>())&#123; </span><br><span class="line">            <span class="type">int</span> size = queue.<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++)&#123;</span><br><span class="line">                <span class="keyword">auto</span> [temp_x, temp_y, temp_k] = queue.<span class="built_in">front</span>();</span><br><span class="line">                queue.<span class="built_in">pop</span>();</span><br><span class="line">                <span class="comment">//遍历4个方向</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">                    <span class="type">int</span> x = temp_x + dir[j][<span class="number">0</span>];</span><br><span class="line">                    <span class="type">int</span> y = temp_y + dir[j][<span class="number">1</span>];</span><br><span class="line">                    <span class="comment">//如果超出范围，则跳过</span></span><br><span class="line">                    <span class="keyword">if</span> (x &lt; <span class="number">0</span> || y &lt; <span class="number">0</span> || x &gt;= m || y &gt;= n)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    </span><br><span class="line">                    <span class="type">char</span> c = grid[x][y];</span><br><span class="line">                    <span class="comment">//如果为&#x27;#&#x27;或者已有的钥匙无法打开门，则跳过</span></span><br><span class="line">                    <span class="keyword">if</span> (c == <span class="string">&#x27;#&#x27;</span> || (<span class="built_in">isupper</span>(c) &amp;&amp; (temp_k &gt;&gt; (c - <span class="string">&#x27;A&#x27;</span>) &amp; <span class="number">1</span>) == <span class="number">0</span>))</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="type">int</span> k = temp_k;</span><br><span class="line">                    <span class="comment">//如果遇到钥匙，则捡起，并判断是否已经找到全部的钥匙</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">islower</span>(c)) &#123;</span><br><span class="line">                        k |= <span class="number">1</span> &lt;&lt; (c - <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">                        <span class="comment">//如果已经找到全部钥匙，则返回</span></span><br><span class="line">                        <span class="keyword">if</span>(k == (<span class="number">1</span>&lt;&lt;all_k)<span class="number">-1</span>) </span><br><span class="line">                            <span class="keyword">return</span> ans;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//如果此位置没有被标记，则加入到队列中</span></span><br><span class="line">                    <span class="keyword">if</span> (!flag[x][y][k]) &#123;</span><br><span class="line">                        flag[x][y][k] = <span class="literal">true</span>;</span><br><span class="line">                        queue.<span class="built_in">emplace</span>(x, y, k);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//步数+1</span></span><br><span class="line">            ans++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(mn⋅2^k^)，其中 m 和 n 是网格的行数和列数，k 是网格中钥匙的数量。</p></li><li><p>空间复杂度：O(mn⋅2^k^)。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1684. 统计一致字符串的数目</title>
      <link href="/2022/11/08/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1684%20%E7%BB%9F%E8%AE%A1%E4%B8%80%E8%87%B4%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%95%B0%E7%9B%AE/"/>
      <url>/2022/11/08/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1684%20%E7%BB%9F%E8%AE%A1%E4%B8%80%E8%87%B4%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%95%B0%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个由不同字符组成的字符串 allowed 和一个字符串数组 words 。如果一个字符串的每一个字符都在 allowed 中，就称这个字符串是 一致字符串 。</p><p>请你返回 words 数组中 一致字符串 的数目。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：allowed &#x3D; “cad”, words &#x3D; [“cc”,”acd”,”b”,”ba”,”bac”,”bad”,”ac”,”d”]<br>输出：4<br>解释：字符串 “cc”，”acd”，”ac” 和 “d” 是一致字符串。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">countConsistentStrings</span><span class="params">(string allowed, vector&lt;string&gt;&amp; words)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">bool</span>&gt; <span class="title">map</span><span class="params">(<span class="number">26</span>, <span class="literal">false</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; a : allowed)&#123;</span><br><span class="line">            map[a-<span class="string">&#x27;a&#x27;</span>] = <span class="literal">true</span>;        </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="type">bool</span> flag = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span>(string&amp; word : words)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">char</span>&amp; w : word)&#123;</span><br><span class="line">                <span class="keyword">if</span>(!map[w-<span class="string">&#x27;a&#x27;</span>])&#123;</span><br><span class="line">                    flag = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                flag = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">                ans++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n + m)，其中 n 是字符串 allowed 的长度，m是字符串 words[i] 的长度。</li><li>空间复杂度：O(C)。C&lt;&#x3D;26</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)816. 模糊坐标</title>
      <link href="/2022/11/07/%E6%AF%8F%E6%97%A5LeetCode/2022-11/816%20%E6%A8%A1%E7%B3%8A%E5%9D%90%E6%A0%87/"/>
      <url>/2022/11/07/%E6%AF%8F%E6%97%A5LeetCode/2022-11/816%20%E6%A8%A1%E7%B3%8A%E5%9D%90%E6%A0%87/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>我们有一些二维坐标，如 “(1, 3)” 或 “(2, 0.5)”，然后我们移除所有逗号，小数点和空格，得到一个字符串S。返回所有可能的原始字符串到一个列表中。</p><p>原始的坐标表示法不会存在多余的零，所以不会出现类似于”00”, “0.0”, “0.00”, “1.0”, “001”, “00.01”或一些其他更小的数来表示坐标。此外，一个小数点前至少存在一个数，所以也不会出现“.1”形式的数字。</p><p>最后返回的列表可以是任意顺序的。而且注意返回的两个数字中间（逗号之后）都有一个空格。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>示例 2:<br>输入: “(00011)”<br>输出:  [“(0.001, 1)”, “(0, 0.011)”]<br>解释:<br>0.0, 00, 0001 或 00.01 是不被允许的。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：模拟"><a href="#代码-cpp-：模拟" class="headerlink" title="代码(cpp)：模拟"></a>代码(cpp)：模拟</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">getPoint</span><span class="params">(string num)</span></span>&#123;</span><br><span class="line">        vector&lt;string&gt; temp;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= num.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            string integer = num.<span class="built_in">substr</span>(<span class="number">0</span>, i);</span><br><span class="line">            string decimal = num.<span class="built_in">substr</span>(i);</span><br><span class="line">            <span class="keyword">if</span>(integer != <span class="string">&quot;0&quot;</span> &amp;&amp; integer[<span class="number">0</span>] == <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span>(!decimal.<span class="built_in">empty</span>() &amp;&amp; decimal.<span class="built_in">back</span>() == <span class="string">&#x27;0&#x27;</span>)&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(decimal.<span class="built_in">empty</span>())</span><br><span class="line">                temp.<span class="built_in">emplace_back</span>(integer);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                temp.<span class="built_in">emplace_back</span>(integer+<span class="string">&#x27;.&#x27;</span>+decimal);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">ambiguousCoordinates</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        vector&lt;string&gt; ans;</span><br><span class="line">        s = s.<span class="built_in">substr</span>(<span class="number">1</span>,s.<span class="built_in">size</span>() <span class="number">-2</span>);</span><br><span class="line">        string temp;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; s.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; x : <span class="built_in">getPoint</span>(s.<span class="built_in">substr</span>(<span class="number">0</span>, i)))&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; y : <span class="built_in">getPoint</span>(s.<span class="built_in">substr</span>(i)))&#123;</span><br><span class="line">                    ans.<span class="built_in">emplace_back</span>(<span class="string">&quot;(&quot;</span>+x+<span class="string">&quot;, &quot;</span>+y+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n^3^)</li><li>空间复杂度：O(n^3^)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1678. 设计 Goal 解析器</title>
      <link href="/2022/11/06/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1678%20%E8%AE%BE%E8%AE%A1%20Goal%20%E8%A7%A3%E6%9E%90%E5%99%A8/"/>
      <url>/2022/11/06/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1678%20%E8%AE%BE%E8%AE%A1%20Goal%20%E8%A7%A3%E6%9E%90%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>请你设计一个可以解释字符串 command 的 Goal 解析器 。command 由 “G”、”()” 和&#x2F;或 “(al)” 按某种顺序组成。Goal 解析器会将 “G” 解释为字符串 “G”、”()” 解释为字符串 “o” ，”(al)” 解释为字符串 “al” 。然后，按原顺序将经解释得到的字符串连接成一个字符串。</p><p>给你字符串 command ，返回 Goal 解析器 对 command 的解释结果。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：command &#x3D; “G()(al)”<br>输出：”Goal”<br>解释：Goal 解析器解释命令的步骤如下所示：<br>G -&gt; G<br>() -&gt; o<br>(al) -&gt; al<br>最后连接得到的结果是 “Goal”</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">interpret</span><span class="params">(string command)</span> </span>&#123;</span><br><span class="line">        string ans = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; command.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(command[i] == <span class="string">&#x27;G&#x27;</span>)</span><br><span class="line">                ans.<span class="built_in">push_back</span>(<span class="string">&#x27;G&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span>(command[i] == <span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">                ans.<span class="built_in">push_back</span>(<span class="string">&#x27;o&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span>(command[i] == <span class="string">&#x27;a&#x27;</span>)&#123;</span><br><span class="line">                ans.<span class="built_in">append</span>(<span class="string">&quot;al&quot;</span>);</span><br><span class="line">                i += <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(n)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1106. 解析布尔表达式</title>
      <link href="/2022/11/05/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1106%20%E8%A7%A3%E6%9E%90%E5%B8%83%E5%B0%94%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
      <url>/2022/11/05/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1106%20%E8%A7%A3%E6%9E%90%E5%B8%83%E5%B0%94%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个以字符串形式表述的 布尔表达式（boolean） expression，返回该式的运算结果。</p><p>有效的表达式需遵循以下约定：</p><ul><li><code>&quot;t&quot;</code>，运算结果为 True</li><li><code>&quot;f&quot;</code>，运算结果为 False</li><li><code>&quot;!(expr)&quot;</code>，运算过程为对内部表达式 expr 进行逻辑 非的运算（NOT）</li><li><code>&quot;&amp;(expr1,expr2,...)&quot;</code>，运算过程为对 2 个或以上内部表达式 expr1, expr2, … 进行逻辑 与的运算(AND)</li><li><code>&quot;|(expr1,expr2,...)&quot;</code>，运算过程为对 2 个或以上内部表达式 expr1, expr2, … 进行逻辑 或的运算(OR)</li></ul></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：expression &#x3D; “|(&amp;(t,f,t),!(t))”<br>输出：false</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：栈"><a href="#代码-cpp-：栈" class="headerlink" title="代码(cpp)：栈"></a>代码(cpp)：栈</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">parseBoolExpr</span><span class="params">(string expression)</span> </span>&#123;</span><br><span class="line">        stack&lt;<span class="type">char</span>&gt; stk;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; ch : expression)&#123;</span><br><span class="line">            <span class="keyword">if</span>(ch == <span class="string">&#x27;,&#x27;</span>) <span class="comment">//跳过&#x27;,&#x27;</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span>(ch != <span class="string">&#x27;)&#x27;</span>) <span class="comment">//将&#x27;!&#x27;&#x27;、&#x27;|&#x27;、&#x27;&amp;&#x27;压栈</span></span><br><span class="line">                stk.<span class="built_in">emplace</span>(ch);</span><br><span class="line">            <span class="keyword">else</span>&#123;<span class="comment">//如果为&#x27;)&#x27;</span></span><br><span class="line">                <span class="comment">//统计括号中true和false的个数</span></span><br><span class="line">                <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">                <span class="type">int</span> f = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span>(stk.<span class="built_in">top</span>() != <span class="string">&#x27;(&#x27;</span>)&#123; <span class="comment">//如果不为&#x27;(&#x27;</span></span><br><span class="line">                    <span class="keyword">auto</span> temp = stk.<span class="built_in">top</span>();</span><br><span class="line">                    stk.<span class="built_in">pop</span>();</span><br><span class="line">                    <span class="keyword">if</span>(temp == <span class="string">&#x27;t&#x27;</span>)</span><br><span class="line">                        t++;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        f++;</span><br><span class="line">                &#125;</span><br><span class="line">                stk.<span class="built_in">pop</span>(); <span class="comment">//将&#x27;(&#x27;出栈</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">auto</span> optator = stk.<span class="built_in">top</span>(); <span class="comment">//获取运算符</span></span><br><span class="line">                stk.<span class="built_in">pop</span>();</span><br><span class="line"><span class="comment">//运算符操作，并将结果入栈</span></span><br><span class="line">                <span class="keyword">switch</span>(optator)&#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;!&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span>(f == <span class="number">0</span>)</span><br><span class="line">                            stk.<span class="built_in">emplace</span>(<span class="string">&#x27;f&#x27;</span>);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            stk.<span class="built_in">emplace</span>(<span class="string">&#x27;t&#x27;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;|&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span>(t &gt; <span class="number">0</span>)</span><br><span class="line">                            stk.<span class="built_in">emplace</span>(<span class="string">&#x27;t&#x27;</span>);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            stk.<span class="built_in">emplace</span>(<span class="string">&#x27;f&#x27;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;&amp;&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span>(f == <span class="number">0</span>)</span><br><span class="line">                            stk.<span class="built_in">emplace</span>(<span class="string">&#x27;t&#x27;</span>);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            stk.<span class="built_in">emplace</span>(<span class="string">&#x27;f&#x27;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> stk.<span class="built_in">top</span>() == <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)</p></li><li><p>空间复杂度：O(n)</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)754. 到达终点数字</title>
      <link href="/2022/11/04/%E6%AF%8F%E6%97%A5LeetCode/2022-11/754%20%E5%88%B0%E8%BE%BE%E7%BB%88%E7%82%B9%E6%95%B0%E5%AD%97/"/>
      <url>/2022/11/04/%E6%AF%8F%E6%97%A5LeetCode/2022-11/754%20%E5%88%B0%E8%BE%BE%E7%BB%88%E7%82%B9%E6%95%B0%E5%AD%97/</url>
      
        <content type="html"><![CDATA[<p>题目：</p><p>在一根无限长的数轴上，你站在0的位置。终点在target的位置。</p><p>你可以做一些数量的移动 numMoves :</p><p>每次你可以选择向左或向右移动。<br>第 i 次移动（从  i &#x3D;&#x3D; 1 开始，到 i &#x3D;&#x3D; numMoves ），在选择的方向上走 i 步。<br>给定整数 target ，返回 到达目标所需的 最小 移动次数(即最小 numMoves ) 。</p><p>示例：</p><blockquote><p>输入: target &#x3D; 2<br>输出: 3<br>解释:<br>第一次移动，从 0 到 1 。<br>第二次移动，从 1 到 -1 。<br>第三次移动，从 -1 到 2 。</p></blockquote><p>代码(cpp)：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">reachNumber</span><span class="params">(<span class="type">int</span> target)</span> </span>&#123;</span><br><span class="line">        target = <span class="built_in">abs</span>(target);</span><br><span class="line">        <span class="type">int</span> k = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(target &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            k++;</span><br><span class="line">            target -= k;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(target%<span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> k;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> k + <span class="number">1</span> + k%<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1668. 最大重复子字符串</title>
      <link href="/2022/11/03/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1668%20%E6%9C%80%E5%A4%A7%E9%87%8D%E5%A4%8D%E5%AD%90%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
      <url>/2022/11/03/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1668%20%E6%9C%80%E5%A4%A7%E9%87%8D%E5%A4%8D%E5%AD%90%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
      
        <content type="html"><![CDATA[<p>题目：</p><p>给你一个字符串 sequence ，如果字符串 word 连续重复 k 次形成的字符串是 sequence 的一个子字符串，那么单词 word 的 重复值为 k 。单词 word 的 最大重复值 是单词 word 在 sequence 中最大的重复值。如果 word 不是 sequence 的子串，那么重复值 k 为 0 。</p><p>给你一个字符串 sequence 和 word ，请你返回 最大重复值 k 。</p><p>示例：</p><blockquote><p>输入：sequence &#x3D; “ababc”, word &#x3D; “ab”<br>输出：2<br>解释：”abab” 是 “ababc” 的子字符串。</p></blockquote><p>思路：KMP</p><p>先用KMP找到重复一次的字串，如果存在就找重复两次的字串，依次递加</p><p>代码(cpp)：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxRepeating</span><span class="params">(string sequence, string word)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        string temp = word;</span><br><span class="line">        <span class="keyword">while</span>(sequence.<span class="built_in">find</span>(word) != string::npos)&#123;</span><br><span class="line">            word.<span class="built_in">append</span>(temp);</span><br><span class="line">            ans++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1662. 检查两个字符串数组是否相等</title>
      <link href="/2022/11/01/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1662%20%E6%A3%80%E6%9F%A5%E4%B8%A4%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%95%B0%E7%BB%84%E6%98%AF%E5%90%A6%E7%9B%B8%E7%AD%89/"/>
      <url>/2022/11/01/%E6%AF%8F%E6%97%A5LeetCode/2022-11/1662%20%E6%A3%80%E6%9F%A5%E4%B8%A4%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%95%B0%E7%BB%84%E6%98%AF%E5%90%A6%E7%9B%B8%E7%AD%89/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你两个字符串数组 word1 和 word2 。如果两个数组表示的字符串相同，返回 true ；否则，返回 false 。</p><p>数组表示的字符串 是由数组中的所有元素 按顺序 连接形成的字符串。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：word1 &#x3D; [“ab”, “c”], word2 &#x3D; [“a”, “bc”]<br>输出：true<br>解释：<br>word1 表示的字符串为 “ab” + “c” -&gt; “abc”<br>word2 表示的字符串为 “a” + “bc” -&gt; “abc”<br>两个字符串相同，返回 true</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">arrayStringsAreEqual</span><span class="params">(vector&lt;string&gt;&amp; word1, vector&lt;string&gt;&amp; word2)</span> </span>&#123;</span><br><span class="line">        string str1 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; word1.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            str1.<span class="built_in">append</span>(word1[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string str2 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; word2.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            str2.<span class="built_in">append</span>(word2[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(str1.<span class="built_in">size</span>() != str2.<span class="built_in">size</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; str1.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(str1[i] != str2[i])</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)784. 字母大小写全排列</title>
      <link href="/2022/10/30/%E6%AF%8F%E6%97%A5LeetCode/2022-10/784%20%E5%AD%97%E6%AF%8D%E5%A4%A7%E5%B0%8F%E5%86%99%E5%85%A8%E6%8E%92%E5%88%97/"/>
      <url>/2022/10/30/%E6%AF%8F%E6%97%A5LeetCode/2022-10/784%20%E5%AD%97%E6%AF%8D%E5%A4%A7%E5%B0%8F%E5%86%99%E5%85%A8%E6%8E%92%E5%88%97/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个字符串 <code>s</code> ，通过将字符串 <code>s</code> 中的每个字母转变大小写，我们可以获得一个新的字符串。</p><p>返回 <em>所有可能得到的字符串集合</em> 。以 <strong>任意顺序</strong> 返回输出。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “a1b2”<br>输出：[“a1b2”, “a1B2”, “A1b2”, “A1B2”]</p></blockquote></div><div class="story post-story"><h2 id="思路：DFS"><a href="#思路：DFS" class="headerlink" title="思路：DFS"></a>思路：DFS</h2><p>获取到字符串s中每个字母的位置，并且如果是大写字母的话，改为小写字母，统一为小写字母</p><p>利用dfs，得到所有可能的字符串</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;string&gt; ans;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(string s, vector&lt;<span class="type">int</span>&gt;&amp; index, <span class="type">int</span> pos)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = pos; i &lt; index.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            string temp = s;</span><br><span class="line">            temp[index[i]] -= <span class="number">32</span>;</span><br><span class="line">            ans.<span class="built_in">emplace_back</span>(temp);</span><br><span class="line">            <span class="built_in">dfs</span>(temp, index, i+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">letterCasePermutation</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; index;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">isdigit</span>(s[i]))</span><br><span class="line">                index.<span class="built_in">emplace_back</span>(i);</span><br><span class="line">                <span class="keyword">if</span>(s[i] &gt;= <span class="number">65</span> &amp;&amp; s[i] &lt;= <span class="number">90</span>)</span><br><span class="line">                    s[i] += <span class="number">32</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ans.<span class="built_in">emplace_back</span>(s);</span><br><span class="line">        <span class="built_in">dfs</span>(s, index, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1773. 统计匹配检索规则的物品数量</title>
      <link href="/2022/10/29/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1773%20%E7%BB%9F%E8%AE%A1%E5%8C%B9%E9%85%8D%E6%A3%80%E7%B4%A2%E8%A7%84%E5%88%99%E7%9A%84%E7%89%A9%E5%93%81%E6%95%B0%E9%87%8F/"/>
      <url>/2022/10/29/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1773%20%E7%BB%9F%E8%AE%A1%E5%8C%B9%E9%85%8D%E6%A3%80%E7%B4%A2%E8%A7%84%E5%88%99%E7%9A%84%E7%89%A9%E5%93%81%E6%95%B0%E9%87%8F/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个数组 items ，其中 items[i] &#x3D; [typei, colori, namei] ，描述第 i 件物品的类型、颜色以及名称。</p><p>另给你一条由两个字符串 ruleKey 和 ruleValue 表示的检索规则。</p><p>如果第 i 件物品能满足下述条件之一，则认为该物品与给定的检索规则 匹配 ：</p><p>ruleKey &#x3D;&#x3D; “type” 且 ruleValue &#x3D;&#x3D; typei 。<br>ruleKey &#x3D;&#x3D; “color” 且 ruleValue &#x3D;&#x3D; colori 。<br>ruleKey &#x3D;&#x3D; “name” 且 ruleValue &#x3D;&#x3D; namei 。<br>统计并返回 匹配检索规则的物品数量 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：items &#x3D; [[“phone”,”blue”,”pixel”],[“computer”,”silver”,”phone”],[“phone”,”gold”,”iphone”]], ruleKey &#x3D; “type”, ruleValue &#x3D; “phone”<br>输出：2<br>解释：只有两件物品匹配检索规则，这两件物品分别是 [“phone”,”blue”,”pixel”] 和 [“phone”,”gold”,”iphone”] 。注意，[“computer”,”silver”,”phone”] 未匹配检索规则。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">countMatches</span><span class="params">(vector&lt;vector&lt;string&gt;&gt;&amp; items, string ruleKey, string ruleValue)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> pos;</span><br><span class="line">        <span class="keyword">if</span>(ruleKey == <span class="string">&quot;type&quot;</span>)</span><br><span class="line">            pos = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(ruleKey == <span class="string">&quot;color&quot;</span>)</span><br><span class="line">            pos = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pos = <span class="number">2</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; items.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(items[i][pos] == ruleValue)&#123;</span><br><span class="line">                ans++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)</p></li><li><p>空间复杂度：O(1)</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)907. 子数组的最小值之和</title>
      <link href="/2022/10/28/%E6%AF%8F%E6%97%A5LeetCode/2022-10/907%20%E5%AD%90%E6%95%B0%E7%BB%84%E7%9A%84%E6%9C%80%E5%B0%8F%E5%80%BC%E4%B9%8B%E5%92%8C/"/>
      <url>/2022/10/28/%E6%AF%8F%E6%97%A5LeetCode/2022-10/907%20%E5%AD%90%E6%95%B0%E7%BB%84%E7%9A%84%E6%9C%80%E5%B0%8F%E5%80%BC%E4%B9%8B%E5%92%8C/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个整数数组 arr，找到 min(b) 的总和，其中 b 的范围为 arr 的每个（连续）子数组。</p><p>由于答案可能很大，因此 返回答案模 10^9 + 7 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：arr &#x3D; [3,1,2,4]<br>输出：17<br>解释：<br>子数组为 [3]，[1]，[2]，[4]，[3,1]，[1,2]，[2,4]，[3,1,2]，[1,2,4]，[3,1,2,4]。<br>最小值为 3，1，2，4，1，1，2，1，1，1，和为 17。</p></blockquote></div><div class="story post-story"><h2 id="思路：单调栈"><a href="#思路：单调栈" class="headerlink" title="思路：单调栈"></a>思路：单调栈</h2><p>举例：<code>arr = [11,81,94,43,3]</code></p><ul><li><p>对于11，左边没有更小值，右边更小值为3，那么，只能以11为起点，终点可以选11，81，94，43，共4个数组，对答案的贡献就是<code>4*11=44</code></p></li><li><p>对于81，左边更小值为11，右边更小值为43，那么，可以以81为起点，81，94为终点，共两个数组，</p><p>对答案的贡献为<code>2*81=162</code></p></li><li><p>对于94，左边更小值为81，右边更小值为43，只能以自身为起点终点，共一个数组，</p><p>贡献<code>94</code></p></li><li><p>对于43，左边更小值为11，右边更小值为3，可以以81，94，43为起点，43为终点，共三个数组，</p><p>对答案的贡献为<code>3*43=129</code></p></li><li><p>对于3，左边没有更小值，右边没有更小值，可以以11，81，94，43，3为起点，3为终点，共五个数组，</p><p>对答案的贡献为<code>5*3=15</code></p></li></ul><p>最终结果就是累加起来，<code>44+162+94+129+15=444</code></p><p>更一般来说，如果当前位置坐标为<code>i</code>，左边更小值位置为<code>left</code>，右边为<code>right</code>，<br>则贡献就是<code>(i-left)*(right-i)*arr[i]</code>。特别地，如果左边没有更小值，<code>left=-1</code>，如果右边没有更小值，<code>right=size</code>。</p><blockquote><p>作者：heren1229<br>链接：<a href="https://leetcode.cn/problems/sum-of-subarray-minimums/solution/dan-diao-zhan-by-heren1229-j8nz/">https://leetcode.cn/problems/sum-of-subarray-minimums/solution/dan-diao-zhan-by-heren1229-j8nz/</a><br>来源：力扣（LeetCode）<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">sumSubarrayMins</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; arr)</span> </span>&#123;</span><br><span class="line">        <span class="type">long</span> ans = <span class="number">0</span>;</span><br><span class="line">        arr.<span class="built_in">emplace_back</span>(<span class="number">-1</span>);</span><br><span class="line">        stack&lt;<span class="type">int</span>&gt; stk;</span><br><span class="line">        stk.<span class="built_in">emplace</span>(<span class="number">-1</span>);</span><br><span class="line">        <span class="type">long</span> mod = <span class="number">1e9</span>+<span class="number">7</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">while</span>(stk.<span class="built_in">size</span>() &gt; <span class="number">1</span> &amp;&amp; arr[stk.<span class="built_in">top</span>()] &gt;= arr[i])&#123;</span><br><span class="line">                <span class="type">int</span> t = stk.<span class="built_in">top</span>();</span><br><span class="line">                stk.<span class="built_in">pop</span>();</span><br><span class="line">                ans += (<span class="type">long</span>)arr[t]*(i-t)*(t-stk.<span class="built_in">top</span>()); </span><br><span class="line">            &#125;</span><br><span class="line">            stk.<span class="built_in">emplace</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans%mod;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)，其中 n 为 arr 的长度。在 arr[i] 的视角看，i 在二重循环中最多入栈出栈各一次，因此整个二重循环的时间复杂度为 O(n)。</li><li>空间复杂度：O(n)。最坏情况下，栈里面有 O(n) 个元素。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1822. 数组元素积的符号</title>
      <link href="/2022/10/27/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1822%20%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E7%A7%AF%E7%9A%84%E7%AC%A6%E5%8F%B7/"/>
      <url>/2022/10/27/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1822%20%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E7%A7%AF%E7%9A%84%E7%AC%A6%E5%8F%B7/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>已知函数 signFunc(x) 将会根据 x 的正负返回特定值：</p><p>如果 x 是正数，返回 1 。<br>如果 x 是负数，返回 -1 。<br>如果 x 是等于 0 ，返回 0 。<br>给你一个整数数组 nums 。令 product 为数组 nums 中所有元素值的乘积。</p><p>返回 signFunc(product) 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [-1,-2,-3,-4,3,2,1]<br>输出：1<br>解释：数组中所有值的乘积是 144 ，且 signFunc(144) &#x3D; 1</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">arraySign</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; num : nums)&#123;</span><br><span class="line">            <span class="keyword">if</span>(num == <span class="number">0</span>)&#123;</span><br><span class="line">                count = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(num &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(count%<span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(count == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)934. 最短的桥</title>
      <link href="/2022/10/25/%E6%AF%8F%E6%97%A5LeetCode/2022-10/934%20%E6%9C%80%E7%9F%AD%E7%9A%84%E6%A1%A5/"/>
      <url>/2022/10/25/%E6%AF%8F%E6%97%A5LeetCode/2022-10/934%20%E6%9C%80%E7%9F%AD%E7%9A%84%E6%A1%A5/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个大小为 n x n 的二元矩阵 grid ，其中 1 表示陆地，0 表示水域。</p><p>岛 是由四面相连的 1 形成的一个最大组，即不会与非组内的任何其他 1 相连。grid 中 恰好存在两座岛 。</p><p>你可以将任意数量的 0 变为 1 ，以使两座岛连接起来，变成 一座岛 。</p><p>返回必须翻转的 0 的最小数目。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：grid &#x3D; [[0,1,0],[0,0,0],[0,0,1]]<br>输出：2</p></blockquote></div><div class="story post-story"><h2 id="思路：BFS"><a href="#思路：BFS" class="headerlink" title="思路：BFS"></a>思路：BFS</h2><p>可以确定的是grid数组中只有两个岛屿(1表示岛，0表示海)</p><p>可以遍历岛其中一个岛后，由此岛利用BFS，得到另一个岛之间所需搭桥数</p><p>以示例为例：</p><table><thead><tr><th>0</th><th>1</th><th>0</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td></tr><tr><td>0</td><td>0</td><td>1</td></tr></tbody></table><p>先找到第一个岛屿，并(利用BFS)将其<strong>整个岛</strong>都标记为-1：</p><table><thead><tr><th>0</th><th><span style="color:red">-1</span></th><th>0</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td></tr><tr><td>0</td><td>0</td><td>1</td></tr></tbody></table><p>利用BFS搜索另一个岛：</p><p>第一次，ans &#x3D; 0时：</p><table><thead><tr><th><span style="color:red">-1</span></th><th><span style="color:red">-1</span></th><th><span style="color:red">-1</span></th></tr></thead><tbody><tr><td>0</td><td><span style="color:red">-1</span></td><td>0</td></tr><tr><td>0</td><td>0</td><td>1</td></tr></tbody></table><p>第二次，ans &#x3D; 1时：</p><table><thead><tr><th><span style="color:red">-1</span></th><th><span style="color:red">-1</span></th><th><span style="color:red">-1</span></th></tr></thead><tbody><tr><td><span style="color:red">-1</span></td><td><span style="color:red">-1</span></td><td><span style="color:red">-1</span></td></tr><tr><td>0</td><td><span style="color:red">-1</span></td><td>1</td></tr></tbody></table><p>第三次，ans &#x3D; 2 时，找到另一个岛屿，返回结果：</p><table><thead><tr><th><span style="color:red">-1</span></th><th><span style="color:red">-1</span></th><th><span style="color:red">-1</span></th></tr></thead><tbody><tr><td><span style="color:red">-1</span></td><td><span style="color:red">-1</span></td><td><span style="color:red">-1</span></td></tr><tr><td>0</td><td><span style="color:red">-1</span></td><td><span style="color:blue">1</span></td></tr></tbody></table></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">shortestBridge</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; grid)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> size = grid.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> dir[<span class="number">4</span>][<span class="number">2</span>]&#123;&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">-1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,<span class="number">-1</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">        queue&lt;pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt;&gt; qu1;</span><br><span class="line">        queue&lt;pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt;&gt; qu2;</span><br><span class="line"><span class="comment">//获取到第一个岛屿的位置</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; size; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(grid[i][j] == <span class="number">1</span>)&#123;</span><br><span class="line">                    grid[i][j] = <span class="number">-1</span>;   <span class="comment">//标记-1</span></span><br><span class="line">                    qu1.<span class="built_in">emplace</span>(i, j); <span class="comment">//入队</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!qu1.<span class="built_in">empty</span>())&#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//遍历数组，将于第一个岛屿相连的岛屿保存入队到qu2中，并标记-1</span></span><br><span class="line">        <span class="keyword">while</span>(!qu1.<span class="built_in">empty</span>())&#123;</span><br><span class="line">            <span class="keyword">auto</span> [x, y] = qu1.<span class="built_in">front</span>();</span><br><span class="line">            qu2.<span class="built_in">emplace</span>(x, y); <span class="comment">//将相连的岛屿入队到qu2中</span></span><br><span class="line">            qu1.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="comment">//遍历该岛屿的4个方向</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">                <span class="type">int</span> new_x = x + dir[i][<span class="number">0</span>];</span><br><span class="line">                <span class="type">int</span> new_y = y + dir[i][<span class="number">1</span>];</span><br><span class="line">                <span class="comment">//边界判断</span></span><br><span class="line">                <span class="keyword">if</span>(new_x &lt; <span class="number">0</span> || new_y &lt; <span class="number">0</span> || new_x &gt;= size || new_y &gt;= size)&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;  </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//如果是岛屿</span></span><br><span class="line">                <span class="keyword">if</span>(grid[new_x][new_y] == <span class="number">1</span>)&#123;</span><br><span class="line">                    qu1.<span class="built_in">emplace</span>(new_x, new_y); <span class="comment">//入队</span></span><br><span class="line">                    grid[new_x][new_y] = <span class="number">-1</span>;   <span class="comment">//标记为-1</span></span><br><span class="line">                &#125;                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(!qu2.<span class="built_in">empty</span>())&#123;</span><br><span class="line">            <span class="comment">//如果桥数为ans时，两个岛屿是否可以相连</span></span><br><span class="line">            <span class="type">int</span> n = qu2.<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">                <span class="keyword">auto</span> [x, y] = qu2.<span class="built_in">front</span>();</span><br><span class="line">                qu2.<span class="built_in">pop</span>();</span><br><span class="line">                <span class="comment">//遍历该岛屿的4个方向</span></span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">                    <span class="type">int</span> new_x = x + dir[i][<span class="number">0</span>];</span><br><span class="line">                    <span class="type">int</span> new_y = y + dir[i][<span class="number">1</span>];</span><br><span class="line"><span class="comment">//边界判断</span></span><br><span class="line">                    <span class="keyword">if</span>(new_x &lt; <span class="number">0</span> || new_y &lt; <span class="number">0</span> || new_x &gt;= size || new_y &gt;= size)&#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//如果已经被标记</span></span><br><span class="line">                    <span class="keyword">if</span>(grid[new_x][new_y] == <span class="number">-1</span>)&#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//如果为1到了岛屿</span></span><br><span class="line">                    <span class="keyword">if</span>(grid[new_x][new_y] == <span class="number">1</span>)&#123;</span><br><span class="line">                        <span class="keyword">return</span> ans;     <span class="comment">//返回桥数</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//如果为0，是海</span></span><br><span class="line">                    <span class="keyword">if</span>(grid[new_x][new_y] == <span class="number">0</span>)&#123;</span><br><span class="line">                        qu2.<span class="built_in">emplace</span>(new_x, new_y); <span class="comment">//入队</span></span><br><span class="line">                        grid[new_x][new_y] = <span class="number">-1</span>;   <span class="comment">//标记为-1</span></span><br><span class="line">                    &#125;               </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//桥数+1</span></span><br><span class="line">            ans++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度: O(n^2)<em>O</em>(<em>n</em>2)</li><li>空间复杂度: O(n^2)<em>O</em>(<em>n</em>2)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1768. 交替合并字符串</title>
      <link href="/2022/10/23/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1768%20%E4%BA%A4%E6%9B%BF%E5%90%88%E5%B9%B6%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
      <url>/2022/10/23/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1768%20%E4%BA%A4%E6%9B%BF%E5%90%88%E5%B9%B6%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你两个字符串 word1 和 word2 。请你从 word1 开始，通过交替添加字母来合并字符串。如果一个字符串比另一个字符串长，就将多出来的字母追加到合并后字符串的末尾。</p><p>返回 合并后的字符串 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：word1 &#x3D; “abc”, word2 &#x3D; “pqr”<br>输出：”apbqcr”<br>解释：字符串合并情况如下所示：<br>word1：  a   b   c<br>word2：    p   q   r<br>合并后：  a p b q c r</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">mergeAlternately</span><span class="params">(string word1, string word2)</span> </span>&#123;</span><br><span class="line">        string ans = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> size = <span class="built_in">min</span>(word1.<span class="built_in">size</span>(), word2.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++)&#123;</span><br><span class="line">            ans.<span class="built_in">push_back</span>(word1[i]);</span><br><span class="line">            ans.<span class="built_in">push_back</span>(word2[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(size &lt; word1.<span class="built_in">size</span>())&#123;</span><br><span class="line">            ans.<span class="built_in">push_back</span>(word1[size++]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>(size &lt; word2.<span class="built_in">size</span>())&#123;</span><br><span class="line">            ans.<span class="built_in">push_back</span>(word2[size++]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(m+n)</li><li>空间复杂度：O(m+n)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)901. 股票价格跨度</title>
      <link href="/2022/10/21/%E6%AF%8F%E6%97%A5LeetCode/2022-10/901%20%E8%82%A1%E7%A5%A8%E4%BB%B7%E6%A0%BC%E8%B7%A8%E5%BA%A6/"/>
      <url>/2022/10/21/%E6%AF%8F%E6%97%A5LeetCode/2022-10/901%20%E8%82%A1%E7%A5%A8%E4%BB%B7%E6%A0%BC%E8%B7%A8%E5%BA%A6/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>编写一个 StockSpanner 类，它收集某些股票的每日报价，并返回该股票当日价格的跨度。</p><p>今天股票价格的跨度被定义为股票价格小于或等于今天价格的最大连续日数（从今天开始往回数，包括今天）。</p><p>例如，如果未来7天股票的价格是 [100, 80, 60, 70, 60, 75, 85]，那么股票跨度将是 [1, 1, 1, 2, 1, 4, 6]。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：[“StockSpanner”,”next”,”next”,”next”,”next”,”next”,”next”,”next”], [[],[100],[80],[60],[70],[60],[75],[85]]<br>输出：[null,1,1,1,2,1,4,6]<br>解释：<br>首先，初始化 S &#x3D; StockSpanner()，然后：<br>S.next(100) 被调用并返回 1，<br>S.next(80) 被调用并返回 1，<br>S.next(60) 被调用并返回 1，<br>S.next(70) 被调用并返回 2，<br>S.next(60) 被调用并返回 1，<br>S.next(75) 被调用并返回 4，<br>S.next(85) 被调用并返回 6。</p><p>注意 (例如) S.next(75) 返回 4，因为截至今天的最后 4 个价格<br>(包括今天的价格 75) 小于或等于今天的价格。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StockSpanner</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">StockSpanner</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;stk.<span class="built_in">emplace</span>(<span class="number">-1</span>, INT_MAX);</span><br><span class="line">        <span class="keyword">this</span>-&gt;idx = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">next</span><span class="params">(<span class="type">int</span> price)</span> </span>&#123;</span><br><span class="line">        idx++;</span><br><span class="line">        <span class="keyword">while</span> (price &gt;= stk.<span class="built_in">top</span>().second) &#123;</span><br><span class="line">            stk.<span class="built_in">pop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> ret = idx - stk.<span class="built_in">top</span>().first;</span><br><span class="line">        stk.<span class="built_in">emplace</span>(idx, price);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    stack&lt;pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt;&gt; stk; </span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，其中 n 为调用 next 函数的次数，每个 price 值最多都会入栈出栈各 11 次。</p></li><li><p>空间复杂度：O(n)，栈中最多有 n 个元素。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1700. 无法吃午餐的学生数量</title>
      <link href="/2022/10/19/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1700%20%E6%97%A0%E6%B3%95%E5%90%83%E5%8D%88%E9%A4%90%E7%9A%84%E5%AD%A6%E7%94%9F%E6%95%B0%E9%87%8F/"/>
      <url>/2022/10/19/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1700%20%E6%97%A0%E6%B3%95%E5%90%83%E5%8D%88%E9%A4%90%E7%9A%84%E5%AD%A6%E7%94%9F%E6%95%B0%E9%87%8F/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>学校的自助午餐提供圆形和方形的三明治，分别用数字 0 和 1 表示。所有学生站在一个队列里，每个学生要么喜欢圆形的要么喜欢方形的。<br>餐厅里三明治的数量与学生的数量相同。所有三明治都放在一个 栈 里，每一轮：</p><p>如果队列最前面的学生 喜欢 栈顶的三明治，那么会 拿走它 并离开队列。<br>否则，这名学生会 放弃这个三明治 并回到队列的尾部。<br>这个过程会一直持续到队列里所有学生都不喜欢栈顶的三明治为止。</p><p>给你两个整数数组 students 和 sandwiches ，其中 sandwiches[i] 是栈里面第 i 个三明治的类型（i &#x3D; 0 是栈的顶部）， students[j] 是初始队列里第 j 名学生对三明治的喜好（j &#x3D; 0 是队列的最开始位置）。请你返回无法吃午餐的学生数量。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：students &#x3D; [1,1,0,0], sandwiches &#x3D; [0,1,0,1]<br>输出：0<br>解释：</p><ul><li>最前面的学生放弃最顶上的三明治，并回到队列的末尾，学生队列变为 students &#x3D; [1,0,0,1]。</li><li>最前面的学生放弃最顶上的三明治，并回到队列的末尾，学生队列变为 students &#x3D; [0,0,1,1]。</li><li>最前面的学生拿走最顶上的三明治，剩余学生队列为 students &#x3D; [0,1,1]，三明治栈为 sandwiches &#x3D; [1,0,1]。</li><li>最前面的学生放弃最顶上的三明治，并回到队列的末尾，学生队列变为 students &#x3D; [1,1,0]。</li><li>最前面的学生拿走最顶上的三明治，剩余学生队列为 students &#x3D; [1,0]，三明治栈为 sandwiches &#x3D; [0,1]。</li><li>最前面的学生放弃最顶上的三明治，并回到队列的末尾，学生队列变为 students &#x3D; [0,1]。</li><li>最前面的学生拿走最顶上的三明治，剩余学生队列为 students &#x3D; [1]，三明治栈为 sandwiches &#x3D; [1]。</li><li>最前面的学生拿走最顶上的三明治，剩余学生队列为 students &#x3D; []，三明治栈为 sandwiches &#x3D; []。<br>所以所有学生都有三明治吃。</li></ul></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">countStudents</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; students, vector&lt;<span class="type">int</span>&gt;&amp; sandwiches)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">v</span><span class="params">(<span class="number">2</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; students.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            v[students[i]]++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; sandwiches.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(--v[sandwiches[i]] == <span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">return</span> sandwiches.<span class="built_in">size</span>()-i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><p>时间复杂度：O(n)</p><p>空间复杂度：O(1)</p></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)902. 最大为 N 的数字组合</title>
      <link href="/2022/10/18/%E6%AF%8F%E6%97%A5LeetCode/2022-10/902%20%E6%9C%80%E5%A4%A7%E4%B8%BA%20N%20%E7%9A%84%E6%95%B0%E5%AD%97%E7%BB%84%E5%90%88/"/>
      <url>/2022/10/18/%E6%AF%8F%E6%97%A5LeetCode/2022-10/902%20%E6%9C%80%E5%A4%A7%E4%B8%BA%20N%20%E7%9A%84%E6%95%B0%E5%AD%97%E7%BB%84%E5%90%88/</url>
      
        <content type="html"><![CDATA[<p>题目：</p><p>给定一个按 非递减顺序 排列的数字数组 digits 。你可以用任意次数 digits[i] 来写的数字。例如，如果 digits &#x3D; [‘1’,’3’,’5’]，我们可以写数字，如 ‘13’, ‘551’, 和 ‘1351315’。</p><p>返回 可以生成的小于或等于给定整数 n 的正整数的个数 。</p><p>示例：</p><blockquote><p>输入：digits &#x3D; [“1”,”3”,”5”,”7”], n &#x3D; 100<br>输出：20<br>解释：<br>可写出的 20 个数字是：<br>1, 3, 5, 7, 11, 13, 15, 17, 31, 33, 35, 37, 51, 53, 55, 57, 71, 73, 75, 77.</p></blockquote><p>代码(cpp)：时间超时摆烂~~</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">atMostNGivenDigitSet</span><span class="params">(vector&lt;string&gt;&amp; digits, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dfs</span>(digits, n, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">dfs</span><span class="params">(vector&lt;string&gt;&amp; digits, <span class="type">int</span> n, string num)</span></span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; digits.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            string temp = num;</span><br><span class="line">            temp.<span class="built_in">append</span>(digits[i]);</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">stoll</span>(temp) &gt; n) <span class="keyword">break</span>;</span><br><span class="line">            ans += <span class="built_in">dfs</span>(digits, n, temp)+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)904. 水果成篮</title>
      <link href="/2022/10/17/%E6%AF%8F%E6%97%A5LeetCode/2022-10/904%20%E6%B0%B4%E6%9E%9C%E6%88%90%E7%AF%AE/"/>
      <url>/2022/10/17/%E6%AF%8F%E6%97%A5LeetCode/2022-10/904%20%E6%B0%B4%E6%9E%9C%E6%88%90%E7%AF%AE/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>你正在探访一家农场，农场从左到右种植了一排果树。这些树用一个整数数组 fruits 表示，其中 fruits[i] 是第 i 棵树上的水果 种类 。</p><p>你想要尽可能多地收集水果。然而，农场的主人设定了一些严格的规矩，你必须按照要求采摘水果：</p><ul><li><p>你只有 两个 篮子，并且每个篮子只能装 单一类型 的水果。每个篮子能够装的水果总量没有限制。</p></li><li><p>你可以选择任意一棵树开始采摘，你必须从 每棵 树（包括开始采摘的树）上 恰好摘一个水果 。采摘的水果应当符合篮子中的水果类型。每采摘一次，你将会向右移动到下一棵树，并继续采摘。</p></li><li><p>一旦你走到某棵树前，但水果不符合篮子的水果类型，那么就必须停止采摘。</p></li></ul><p>给你一个整数数组 fruits ，返回你可以收集的水果的 最大 数目。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：fruits &#x3D; [3,3,3,1,2,1,1,2,3,3,4]<br>输出：5<br>解释：可以采摘 [1,2,1,1,2] 这五棵树。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">totalFruit</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; fruits)</span> </span>&#123;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; map;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> left = <span class="number">0</span>, right = <span class="number">0</span>; left &lt; fruits.<span class="built_in">size</span>(); left++)&#123;            </span><br><span class="line">            map[fruits[left]]++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(map.<span class="built_in">size</span>() &gt; <span class="number">2</span>)&#123;</span><br><span class="line">                <span class="keyword">auto</span> temp = fruits[right++];</span><br><span class="line">                <span class="keyword">if</span>(--map[temp] == <span class="number">0</span>)</span><br><span class="line">                    map.<span class="built_in">erase</span>(temp);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ans = <span class="built_in">max</span>(ans, left - right + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度 O(n)</p></li><li><p>空间复杂度 O(1)</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1441. 用栈操作构建数组</title>
      <link href="/2022/10/15/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1441%20%E7%94%A8%E6%A0%88%E6%93%8D%E4%BD%9C%E6%9E%84%E5%BB%BA%E6%95%B0%E7%BB%84/"/>
      <url>/2022/10/15/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1441%20%E7%94%A8%E6%A0%88%E6%93%8D%E4%BD%9C%E6%9E%84%E5%BB%BA%E6%95%B0%E7%BB%84/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个数组 target 和一个整数 n。每次迭代，需要从  list &#x3D; { 1 , 2 , 3 …, n } 中依次读取一个数字。</p><p>请使用下述操作来构建目标数组 target ：</p><ul><li>“Push”：从 list 中读取一个新元素， 并将其推入数组中。</li><li>“Pop”：删除数组中的最后一个元素。</li><li>如果目标数组构建完成，就停止读取更多元素。</li></ul><p>题目数据保证目标数组严格递增，并且只包含 1 到 n 之间的数字。</p><p>请返回构建目标数组所用的操作序列。如果存在多个可行方案，返回任一即可。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：target &#x3D; [1,3], n &#x3D; 3<br>输出：[“Push”,”Push”,”Pop”,”Push”]<br>解释：<br>读取 1 并自动推入数组 -&gt; [1]<br>读取 2 并自动推入数组，然后删除它 -&gt; [1]<br>读取 3 并自动推入数组 -&gt; [1,3]</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">buildArray</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; target, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        vector&lt;string&gt; ans;</span><br><span class="line">        <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(pos == target.<span class="built_in">size</span>())</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ans.<span class="built_in">emplace_back</span>(<span class="string">&quot;Push&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(target[pos] != i)</span><br><span class="line">                ans.<span class="built_in">emplace_back</span>(<span class="string">&quot;Pop&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                pos++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="时间复杂度："><a href="#时间复杂度：" class="headerlink" title="时间复杂度："></a>时间复杂度：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)769. 最多能完成排序的块</title>
      <link href="/2022/10/13/%E6%AF%8F%E6%97%A5LeetCode/2022-10/769%20%E6%9C%80%E5%A4%9A%E8%83%BD%E5%AE%8C%E6%88%90%E6%8E%92%E5%BA%8F%E7%9A%84%E5%9D%97/"/>
      <url>/2022/10/13/%E6%AF%8F%E6%97%A5LeetCode/2022-10/769%20%E6%9C%80%E5%A4%9A%E8%83%BD%E5%AE%8C%E6%88%90%E6%8E%92%E5%BA%8F%E7%9A%84%E5%9D%97/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个长度为 n 的整数数组 arr ，它表示在 [0, n - 1] 范围内的整数的排列。</p><p>我们将 arr 分割成若干 块 (即分区)，并对每个块单独排序。将它们连接起来后，使得连接的结果和按升序排序后的原数组相同。</p><p>返回数组能分成的最多块数量。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入: arr &#x3D; [4,3,2,1,0]<br>输出: 1<br>解释:<br>将数组分成2块或者更多块，都无法得到所需的结果。<br>例如，分成 [4, 3], [2, 1, 0] 的结果是 [3, 4, 0, 1, 2]，这不是有序的数组。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxChunksToSorted</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; arr)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> temp = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            temp = <span class="built_in">max</span>(temp, arr[i]);</span><br><span class="line">            <span class="keyword">if</span>(temp == i)&#123;</span><br><span class="line">                ans++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)，其中 n 是数组 arr 的长度。</li><li>空间复杂度：O(1)。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)817. 链表组件</title>
      <link href="/2022/10/12/%E6%AF%8F%E6%97%A5LeetCode/2022-10/817%20%E9%93%BE%E8%A1%A8%E7%BB%84%E4%BB%B6/"/>
      <url>/2022/10/12/%E6%AF%8F%E6%97%A5LeetCode/2022-10/817%20%E9%93%BE%E8%A1%A8%E7%BB%84%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定链表头结点 head，该链表上的每个结点都有一个 唯一的整型值 。同时给定列表 nums，该列表是上述链表中整型值的一个子集。</p><p>返回列表 nums 中组件的个数，这里对组件的定义为：链表中一段最长连续结点的值（该值必须在列表 nums 中）构成的集合。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入: head &#x3D; [0,1,2,3,4], nums &#x3D; [0,3,1,4]<br>输出: 2<br>解释: 链表中，0 和 1 是相连接的，3 和 4 是相连接的，所以 [0, 1] 和 [3, 4] 是两个组件，故返回 2。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">numComponents</span><span class="params">(ListNode* head, vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; map;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; num : nums)</span><br><span class="line">            map[num]++;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(head != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map.<span class="built_in">find</span>(head-&gt;val) == map.<span class="built_in">end</span>())&#123;</span><br><span class="line">                <span class="keyword">if</span>(count != <span class="number">0</span>)&#123;</span><br><span class="line">                    ans++;</span><br><span class="line">                    count = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                count++;</span><br><span class="line"></span><br><span class="line">            head = head-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(count != <span class="number">0</span>)</span><br><span class="line">            ans++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，需要遍历一遍链表。</p></li><li><p>空间复杂度：O(m)，其中 m 是数组 nums 的长度，需要一个哈希集合来存储 nums 的元素。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1790. 仅执行一次字符串交换能否使两个字符串相等</title>
      <link href="/2022/10/11/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1790%20%E4%BB%85%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BA%A4%E6%8D%A2%E8%83%BD%E5%90%A6%E4%BD%BF%E4%B8%A4%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9B%B8%E7%AD%89/"/>
      <url>/2022/10/11/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1790%20%E4%BB%85%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BA%A4%E6%8D%A2%E8%83%BD%E5%90%A6%E4%BD%BF%E4%B8%A4%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9B%B8%E7%AD%89/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你长度相等的两个字符串 s1 和 s2 。一次 字符串交换 操作的步骤如下：选出某个字符串中的两个下标（不必不同），并交换这两个下标所对应的字符。</p><p>如果对 其中一个字符串 执行 最多一次字符串交换 就可以使两个字符串相等，返回 true ；否则，返回 false 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s1 &#x3D; “bank”, s2 &#x3D; “kanb”<br>输出：true<br>解释：例如，交换 s2 中的第一个和最后一个字符可以得到 “bank”</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">areAlmostEqual</span><span class="params">(string s1, string s2)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> index = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s1.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(s1[i] == s2[i])</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(index == <span class="number">-1</span>)</span><br><span class="line">                index = i;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(index == <span class="number">-2</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(s1[i] != s2[index] || s2[i] != s1[index])</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                index = <span class="number">-2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> index &lt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度: O(n)</li><li>空间复杂度: O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>汇编的学习笔记</title>
      <link href="/2022/10/09/%E8%AE%A1%E7%AE%97%E6%9C%BA4%E4%BB%B6%E5%A5%97/%E6%B1%87%E7%BC%96/"/>
      <url>/2022/10/09/%E8%AE%A1%E7%AE%97%E6%9C%BA4%E4%BB%B6%E5%A5%97/%E6%B1%87%E7%BC%96/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="1-访问寄存器和内存"><a href="#1-访问寄存器和内存" class="headerlink" title="1.访问寄存器和内存"></a>1.访问寄存器和内存</h2><h3 id="寄存器及数据存储"><a href="#寄存器及数据存储" class="headerlink" title="寄存器及数据存储"></a>寄存器及数据存储</h3><p>CPU的组成：</p><ul><li><p>运算器进行信息处理</p></li><li><p><strong>寄存器</strong>进行信息存储</p></li><li><p>控制器协调各种器件进行工作</p></li></ul><p>在8086CPU中有14个寄存器：</p><ul><li><strong>通用寄存器</strong>：AX、BX、CX、DX</li><li>变址寄存器：SI、DI</li><li>指针寄存器：SP、BP</li><li>指令指针寄存器：IP</li><li>段寄存器：CS、SS、DS、ES</li><li>标志寄存器：PSW</li><li>并且所有寄存器都是<strong>16位</strong>的，可以存放<strong>两个字节</strong></li></ul><p>以通用寄存器AX为例：</p><p>一个16位寄存器存储一个16位的数据</p><ul><li>最大值位<code>2^16 - 1</code>，转换位16进制为<code>FFFFH</code></li></ul><p>注意：</p><ul><li>二进制后缀为<code>B</code></li><li>八进制后缀为<code>E</code></li><li>十进制后缀为<code>D</code></li><li>十六进制后缀为<code>H</code></li></ul><p>例如：</p><ul><li>在AX中存储<code>18D</code>，转换为十六进制就为<code>12H</code>，转换为二进制就为<code>10010B</code></li><li>在AX中存储<code>20000D</code>，转换为十六进制就为<code>4E20H</code>，转换为二进制就为<code>0100111000100000B</code></li></ul><p>8086上一代的CPU中的寄存器都是<strong>8位</strong>的，如何保证程序的兼容性？</p><ul><li><p>可以将通用寄存器均分为两个独立的8位寄存器使用</p><p>AX可以分为AH和AL</p><p>AX为<code>0~15</code>位可以细分为AH为<code>8~15</code>位以及AL位<code>0~7</code>位</p></li></ul><p>例如：</p><table><thead><tr><th align="center">寄存器</th><th align="center">寄存器中的数据</th><th align="center">所表示的值</th></tr></thead><tbody><tr><td align="center">AX</td><td align="center"><span style="color:red">01001110</span>00100000</td><td align="center">20000(4E20H)</td></tr><tr><td align="center">AH</td><td align="center"><span style="color:red">01001110</span></td><td align="center">78(4EH)</td></tr><tr><td align="center">AL</td><td align="center">00100000</td><td align="center">32(20H)</td></tr></tbody></table><p>同样：</p><ul><li>BX可以细分为BH和BL</li><li>CX可以细分为CH和CL</li><li>DX可以细分为DH和DL</li></ul><p>8086是16位CPU</p><ul><li>8086的<strong>字长</strong>为16bit</li></ul><p>一个字可以存在一个16位寄存器中：</p><ul><li>这个字的高位字节存在这个寄存器的高8位寄存器<code>8~15</code></li><li>这个字的低位字节存在这个寄存器的低8位寄存器<code>0~7</code></li></ul><h3 id="mov和add指令"><a href="#mov和add指令" class="headerlink" title="mov和add指令"></a>mov和add指令</h3><table><thead><tr><th align="center">汇编指令</th><th>控制CPU完成的操作</th><th align="center">高级语言描述</th></tr></thead><tbody><tr><td align="center">mov ax, 18</td><td>将18送入AX</td><td align="center">AX &#x3D; 18</td></tr><tr><td align="center">mov ah, 78</td><td>将78送入AH</td><td align="center">AH &#x3D; 78</td></tr><tr><td align="center">add ax, 8</td><td>将寄存器AX中的数值加8</td><td align="center">AX +&#x3D; 8</td></tr><tr><td align="center">mov ax, bx</td><td>将寄存器BX的数据送入寄存器AX</td><td align="center">AX &#x3D; BX</td></tr><tr><td align="center">add ax, bx</td><td>将AX， BX中的内容相加，将结果存入AX中</td><td align="center">AX +&#x3D; BX</td></tr></tbody></table><p>注意：汇编指令不区分大小写</p><h3 id="确定物理地址的方法"><a href="#确定物理地址的方法" class="headerlink" title="确定物理地址的方法"></a>确定物理地址的方法</h3><blockquote><p>CPU访问内存单元时要给出内存单元的地址。</p><p>所有的内存单元构成的存储空间是一个一维的线性空间。</p><p>每一个内存单元在这个空间中都有唯一的地址，这个唯一的地址称为物理地切</p></blockquote><p>事实</p><p>8086有20位地址总线，可传送20位地址，<strong>寻址能力为1M</strong>。</p><p>8086是16位结构的CPU</p><ul><li>运算器一次最多可以处理16位的数据，寄存器的最大宽度为16位。</li><li>在8086内部处理的、传输、暂存的地址也是16位，<strong>寻址能力也只有64KB</strong>！</li></ul><p>8086如何在寻址空间上的矛盾？</p><p>可以通过<strong>地址加法器</strong>用<strong>两个16位地址</strong>(段地址、偏移地址)合成一个<strong>20位的物理地址</strong></p><p>地址加法器合成物理地址的方法</p><ul><li><p><code>物理地址 = 段地址*16 + 偏移地址</code></p></li><li><p>就是将(16进制的)段地址左移一位，加上偏移地址</p></li><li><p>例如：</p><p>​     段地址：  1230<span style="color:red">0</span></p><p>+偏移地址：   00C8</p><p>-—————————–</p><p>物理地址：   123CB</p></li></ul><h3 id="内存的分段表示法"><a href="#内存的分段表示法" class="headerlink" title="内存的分段表示法"></a>内存的分段表示法</h3><p>8086CPU使用<code>物理地址 = 段地址*16 + 偏移地址</code>的方法给出内存单元的物理地址</p><p>内存并没有分段，<strong>段的划分来自于CPU！</strong></p><p>内存分段方案：</p><ul><li><p>起始地址(基础地址)：10000H</p><p>段地址：1000H</p><p><code>10000H~100FFH</code>单元组成一个段</p><p>大小：100H(因为<code>10000H~100FFH</code>之间有100H)</p></li><li><p>起始地址(基础地址)：分别为10000H和10080H</p><p>段地址：分别为1000H和1008H</p><p><code>10000H~1007FH</code>单元组成一个段以及<code>10080H~100FFH</code>单元组成一个段</p><p>大小均为：80H(因为<code>10000H~1007FH</code>以及<code>10080H~100FFH</code>之间都有80H)</p></li></ul><ol><li><p>段地址*16必然是16倍数，所以一个段的起始地址也一定是16的倍数</p></li><li><p>偏移地址为16位，16位地址的寻址能力为64K，所以一个段的长度最大为64K</p></li><li><p>偏移地址16位，变化范围为<code>0~FFFFH</code></p><p>给定段地址<code>2000H</code>，用偏移地址寻址的范围是：<code>20000H~2FFFFH</code>，共64K</p></li></ol><table><thead><tr><th>物理地址</th><th>段地址</th><th>偏移地址</th></tr></thead><tbody><tr><td>21F60H</td><td>2000H</td><td>1F60H</td></tr><tr><td></td><td>2100H</td><td>0F60H</td></tr><tr><td></td><td>21F0H</td><td>0060H</td></tr><tr><td></td><td>21F6H</td><td>0000H</td></tr><tr><td></td><td>1F00H</td><td>2F60H</td></tr></tbody></table><p>注意：存储单元地址表示：<code>段地址:偏移地址</code></p><p>有专用的寄存器存放段地址：</p><p>4个段寄存器：</p><ul><li>CS：代码段寄存器</li><li>DS：数据段寄存器</li><li>SS：栈段寄存器</li><li>ES：附加段寄存器</li></ul><h3 id="DeBug的使用"><a href="#DeBug的使用" class="headerlink" title="DeBug的使用"></a>DeBug的使用</h3><p>Debug是Dos系统中的著名的调试程序， 也可以运行在windows系统实模式下。<br>使用Debug程序，可以查看CPU各种寄存器中的内容、内存的情况，并旦在机器指令级跟踪程序的运行！</p><p>注意：汇编时默认是十进制,debug工具中默认的是十六进制</p><p>在DOS提提示符下输入命令：<code>debug</code></p><p>Debug能做的：</p><ul><li><p><code>r</code>：查看、改变CPU寄存器的内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r [寄存器] 回车 [要修改的内容]</span><br></pre></td></tr></table></figure></li><li><p><code>d</code>：查看内存中的内容</p></li><li><p><code>e</code>：改变内存中的内容</p></li><li><p><code>u</code>：将内存中的机器指令翻译成汇编指令</p></li><li><p><code>a</code>：以汇编指令在内容中写入机器指令</p></li><li><p><code>t</code>：执行机器指令</p></li><li><p><code>q</code>：退出Debug</p></li></ul><h3 id="CS、IP与代码段"><a href="#CS、IP与代码段" class="headerlink" title="CS、IP与代码段"></a>CS、IP与代码段</h3><ul><li><p>CS：代码段寄存器</p></li><li><p>IP：指令指针寄存器</p></li><li><p><code>CS:IP</code>：CPU将内存中CS:IP指向的内容当作指令执行</p></li></ul><p>8086PC读取和执行指令演示：</p><img src="https://s2.loli.net/2022/10/10/gnG38hVCsxmXDL7.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/10/gnG38hVCsxmXDL7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="QQ图片20221010171551.png" style="zoom:67%;" /><p>8086PC工作过程的简要描述：</p><ol><li>从CS:IP指向内存单元读取指令，读取的指令进入指令缓冲器；</li><li>IP&#x3D;IP + 所读取指令的长度，从而指向下一条指令；</li><li>执行指令。转到步骤1，重复这个过程。</li></ol><p>DeBug的指令读取和执行演示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 0123H</span><br><span class="line">mov bx, 0003H</span><br><span class="line">mov ax, bx</span><br><span class="line">add ax, bx</span><br></pre></td></tr></table></figure><ol><li><code>a [地址]</code>：写入汇编指令</li><li><code>u [地址]</code>：查看代码</li><li><code>t </code>：执行<code>CS:IP</code>处的代码(IP指向下一条指令地址，重复输入<code>t</code>指令)</li></ol><p>所以，内存中<code>D8 23 01 BB 03 00 89 D8 01 DB</code>这一串数据，是作为<strong>一般数据</strong>还是用作<strong>指令</strong>？</p><ul><li>CPU将<code>CS:IP</code>指向的内存单元中的内容看作<strong>指令</strong></li></ul><h3 id="jmp指令"><a href="#jmp指令" class="headerlink" title="jmp指令"></a>jmp指令</h3><p>执行何处的指令，取决于<code>CS:IP</code></p><p>所以，我们可以通过改变CS、IP中的内容，来控制CPU要执行的目标指令</p><p>那如何改变CS、IP的值呢？</p><ul><li><p>方式一：</p><p>DeBug中可以使用<code>r</code>命令改变寄存器中的值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rcs</span><br><span class="line">rip</span><br></pre></td></tr></table></figure><p>但是DeBug是<strong>调试手段</strong>，并非程序方式！</p></li><li><p>方式二：</p><p>用指令修改</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov cs, 2000H</span><br><span class="line">mov ip, 0H</span><br></pre></td></tr></table></figure><p>这是错误的:x:，8086CPU不提供CS和IP修改的指令</p></li><li><p>方式三：</p><p>转移指令jmp</p><ul><li><p>同时修改CS、IP的内容：<code>jmp 段地址:偏移地址</code></p><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmp 2AE3:3</span><br></pre></td></tr></table></figure></li><li><p>仅修改IP的内容：<code>jmp 某一合法寄存器</code></p><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmp ax ;类似于 mox ip, ax</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/10/10/uWeHAtQnI1jw2oy.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/10/uWeHAtQnI1jw2oy.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="QQ图片20221010183650.png" style="zoom:67%;" /></li><li><p>从20000H开始，执行的序列是：</p><ol><li>mov ax, 6622H</li><li>jmp 1000:3</li><li>mov ax, 0000</li><li>mov bx, ax</li><li>jmp bx</li><li>mov ax, 0123H</li><li>转到第3步，开始循环！</li></ol></li></ul></li></ul><h3 id="内存中字的存储"><a href="#内存中字的存储" class="headerlink" title="内存中字的存储"></a>内存中字的存储</h3><p>对8086CPU，16位作为一个<strong>字</strong></p><p>16位的字存储在一个16位的寄存器中，如何存储？</p><ul><li>高8位放高字节，低8位放低字节</li></ul><p>16位的字在内存中需要2个连续字节存储，怎么存放？</p><ul><li><p>低位字节存放低地址单元，高位字节存放高地址单元</p><p>例如：</p><ul><li>20000D(4E20H)存放0、1两个单元</li><li>18D(0012H)存放在2、3单元</li></ul></li></ul><p>字单元：由两个地址连续的内存单元组成，存放一个字型数据(16位)</p><p>原理：在一个字单元中，低地址单元存放低位字节，高地址单元存放高位字节</p><table><thead><tr><th align="center">地址</th><th></th></tr></thead><tbody><tr><td align="center">0</td><td>20H</td></tr><tr><td align="center">1</td><td>4EH</td></tr><tr><td align="center">2</td><td>12H</td></tr><tr><td align="center">3</td><td>00H</td></tr><tr><td align="center">4</td><td></td></tr><tr><td align="center">5</td><td></td></tr></tbody></table><ul><li>在起始地址为0的(最小的)单元中，存放的(由下往上读)是4E20H</li><li>在起始地址为2的单元中，存放的是0012H</li></ul><p>问题：</p><ul><li>0地址单元中存放的<strong>字节型</strong>数据是<code>20H</code></li><li>0地址单元中存放的<strong>字型</strong>数据是<code>4E20H</code></li><li>2地址单元中存放的<strong>字节型</strong>数据是<code>12H</code></li><li>2地址单元中存放的<strong>字型</strong>数据是<code>0012H</code></li></ul><h3 id="DS和-实现字的传送"><a href="#DS和-实现字的传送" class="headerlink" title="DS和[]实现字的传送"></a>DS和[]实现字的传送</h3><p>CPU要读取一个内存单元的时候，必须要先给出这个内存单元的地址</p><p>在8086PC中，内存地址由段地址和偏移地址组成(段地址:偏移地址)</p><p>DS和[address]配合：</p><ul><li><p>用DS寄存器存放要访问的数据的<strong>段地址</strong></p></li><li><p>偏移地址用[]形式直接给出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov bx, 1000H</span><br><span class="line">mov ds, bx</span><br><span class="line">mov al, [0]    ;将10000H(1000:0)的数据读到al中</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov bx, 1000H</span><br><span class="line">mov ds, bx</span><br><span class="line">mov [0], al    ;将al的数据写到10000H(1000:0)中</span><br></pre></td></tr></table></figure></li></ul><p>将段地址送入DS的两种方式</p><ul><li><p>方式一：:x:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov ds, 1000H  ;8086CPU不支持将数据直接送入Ds</span><br></pre></td></tr></table></figure></li><li><p>方式二：:white_check_mark:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov bx, 1000H  ;先将数据放入通用寄存器中</span><br><span class="line">mov ds, bx     ;通过通用寄存器送入DS中</span><br></pre></td></tr></table></figure></li></ul><p>内存：</p><table><thead><tr><th>地址</th><th>数据</th></tr></thead><tbody><tr><td>10000H</td><td>23</td></tr><tr><td>10001H</td><td>11</td></tr><tr><td>10002H</td><td>22</td></tr><tr><td>10003H</td><td>66</td></tr></tbody></table><p>指令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 1000H  ;1</span><br><span class="line">mov ds, ax     ;2</span><br><span class="line">mov ax, [0]    ;3</span><br><span class="line">mov bx, [2]    ;4</span><br><span class="line">mov cx, [1]    ;5</span><br><span class="line">add bx, [1]    ;6</span><br><span class="line">add cx, [2]    ;7</span><br></pre></td></tr></table></figure><ol><li>AX &#x3D; 1000H</li><li>DS &#x3D; AX ; DS &#x3D; 1000H</li><li>AX &#x3D; 1123</li><li>BX &#x3D; 6622</li><li>CX &#x3D; 2211</li><li>BX +&#x3D; 2211 ; BX &#x3D; 8833</li><li>CX +&#x3D; 6622 ; CX &#x3D; 8833</li></ol><h3 id="DS与数据段"><a href="#DS与数据段" class="headerlink" title="DS与数据段"></a>DS与数据段</h3><p>对于8086PC机，可以根据需要将一组内存单元定义为一个段</p><ul><li>物理地址 &#x3D; 段地址*16 + 偏移地址</li><li>将一组长度为N(N &lt;&#x3D; 64K)、地址连续、起始地址为16的倍数的内存单元当作专门存储数据的内存空间，从而定义了一个数据段</li></ul><p>例如：用123B0H~123B9H的空间来存放数据</p><ul><li>段地址：123BH     起始偏移地址：0000H  长度：10字节</li><li>段地址：1230H     起始偏移地址：00B0H  长度：10字节</li></ul><p>处理方法：<code>DS:[address]</code></p><ul><li>用DS存放数据段的段地址</li><li>用相关指令(mov、add、sub…)访问数据段中的具体单元，单元地址由[address]指出</li></ul><p>累加数据段中的前3个<strong>单元</strong>中的数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 123BH</span><br><span class="line">mov ds, ax</span><br><span class="line">mov al, 0</span><br><span class="line">add al, [0]</span><br><span class="line">add al, [1]</span><br><span class="line">add al, [2]</span><br></pre></td></tr></table></figure><p>累加数据段中的前3个<strong>字型</strong>中的数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 123BH</span><br><span class="line">mov ds, ax</span><br><span class="line">mov ax, 0</span><br><span class="line">add ax, [0]</span><br><span class="line">add ax, [1]</span><br><span class="line">add ax, [2]</span><br></pre></td></tr></table></figure><p>总结：</p><ol><li>字在内存中存储时 ，要用两个地址连续的内存单元来存放，字的低位字节存放在低地址单元中，高位字节存放再高地址单元中。&amp;#x20;</li><li>用mov指令要访问内存单元，可以在mov指令中只给出单元的偏移地址，此时，段地址默认在Ds奇存器中。&amp;#x20;</li><li>laddressj表示一个偏移地址为address的内存单元。&amp;#x20;</li><li>在内存和寄存器之间传送字型数据时，高地址单元和高8位寄存器、低地址单元和低8位奇存器相对应。&amp;#x20;</li><li>mov、add、sub是具有两个操作对象的指令，访问内存中的数据段 （对照：jmp是具有一个操作对象的指令，对应内存中的代码段）。&amp;#x20;</li><li>可以根据自己的推测，在Debug中实验指令的新格式。</li></ol><h3 id="栈及栈操作的实现"><a href="#栈及栈操作的实现" class="headerlink" title="栈及栈操作的实现"></a>栈及栈操作的实现</h3><p>CPU提供的栈机制：</p><ul><li>现如今的CPU中都有栈的设计</li><li>8086CPU提供相关的指令，支持用栈的方式访问内存空间</li><li>基于8086CPU的编程，可以将一段内存当作栈来使用。&amp;#x20;</li></ul><p>PUSH(入栈)和POP(出栈)指令&amp;#x20;</p><ul><li><code>push ax</code> ：将ax中的数据送入栈中&amp;#x20;</li><li><code>pop ax</code>：从栈顶取出数据送入ax(以字为单位对栈进行操作)</li></ul><p>问题：</p><ul><li><p>CPU如何知道一段内存空间被当作栈使用？</p></li><li><p>执行push和pop的时候，如何知道哪个单元是栈顶单元？</p><p>8086CPU中，有两个与栈相关的寄存器：</p><ul><li>栈段寄存器SS：存放栈顶的段地址</li><li>栈顶指针寄存器SP：存放栈顶的偏移地址</li><li>任何时刻，<code>SS:SP</code>指向栈顶元素</li></ul></li></ul><p>栈的操作：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 1000H</span><br><span class="line">mov ss, ax</span><br><span class="line">mov sp, 0010H     ;(栈顶)SS:SP为10010H(1000:0010),此时栈为空</span><br><span class="line">mov ax, 001AH</span><br><span class="line">mov bx, 001BH</span><br><span class="line">push ax.          ;此时栈顶地址为1000EH</span><br><span class="line">push bx  ;此时栈顶地址为1000CH</span><br><span class="line">pop ax  ;此时栈顶地址为1000EH</span><br><span class="line">pop bx  ;此时栈顶地址为10010H，此时栈为空</span><br><span class="line">;并且此时ax与bx的数据发生了交换</span><br></pre></td></tr></table></figure><p>push指令和pop指令的执行过程：</p><p>push ax</p><ol><li>SP -&#x3D; 2</li><li>将ax中的内容送入SS:SP指向的内存单元，SS:SP此时指向新的栈顶</li></ol><p>pop ax</p><ol><li>将SS:SP指向的内存单元处的数据送入ax中&amp;#x20;</li><li>SP +&#x3D; 2，SS:SP指向当前栈顶下面的单元，以当前栈顶下面的单元为新的栈顶</li></ol><p>栈顶超界问题：</p><ul><li><p>如果能够保证在入栈、出栈时，栈顶不会超出栈空间？</p><ul><li><p>8086CPU不保证对栈顶操作不会越界</p><p>8086CPU只知道栈顶在何处(SS:SP所指示的)，不知道程序安排的栈空间有多大</p><p>所以靠自己</p></li></ul></li></ul><p>总结：</p><ul><li><p>push、pop 实质上就是一种内存传送指令，可以在寄存器和内存之间传送数据，与mov指令不同的是，push和pop指令访问的内存单元的地址不是在指令中给出的，而是由SS:SP指出的。</p></li><li><p>执行push和pop指令时，SP中的内容自动改变。</p></li><li><p>8086CPU提供的栈操作机制：&amp;#x20;</p><p>在SS，SP中存放栈顶的段地址和偏移地址，入栈和出栈指 令根据SS:SP指示的地址，按照栈的方式访问内存单元。&amp;#x20;</p><p><strong>push指令的执行步骤</strong>：</p><ol><li>SP -&#x3D; 2</li><li>向SS:SP指向的字单元中送入数据。</li></ol><p><strong>pop指令的执行步骤</strong>：</p><ol><li>从SS:SP指向的字单元中读取数据；</li><li>SP +&#x3D; 2</li></ol></li></ul></div><div class="story post-story"><h2 id="2-汇编语言程序"><a href="#2-汇编语言程序" class="headerlink" title="2.汇编语言程序"></a>2.汇编语言程序</h2><h3 id="用汇编语言写源程序"><a href="#用汇编语言写源程序" class="headerlink" title="用汇编语言写源程序"></a>用汇编语言写源程序</h3><p>汇编语言编写程序的工作过程：</p><ul><li>程序员-&gt;汇编程序-&gt;编译器-&gt;机器码-&gt;计算机执行</li></ul><p>伪指令：</p><ul><li>没有对应的机器码的指令，最终不会被CPU所执行</li><li>伪指令是由编译器来执行的指令，编译器根据伪指令来进行相关的编译工作</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">assume cs:codesg</span><br><span class="line">code segment</span><br><span class="line">;汇编指令…</span><br><span class="line">codesg ends</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>汇编指令：</p><ul><li><p>对应有机器码的指令，可以被编译为机器指令，最终被CPU执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 0123H</span><br><span class="line">mov bx, 0456H</span><br><span class="line">add ax, bx</span><br><span class="line">add ax, ax</span><br><span class="line"></span><br><span class="line">mov ax, 4C00h</span><br><span class="line">int 21h</span><br></pre></td></tr></table></figure></li></ul><p>汇编程序：包含汇编指令和伪指令的文本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">assume cs:codesg</span><br><span class="line">code segment</span><br><span class="line">mov ax, 0123H</span><br><span class="line">mov bx, 0456H</span><br><span class="line">add ax, bx</span><br><span class="line">add ax, ax</span><br><span class="line"></span><br><span class="line">mov ax, 4C00h</span><br><span class="line">int 21h</span><br><span class="line">codesg ends</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>其中，下面的部分程序为程序返回(return 0;)</p><ul><li><p>程序结束运行后，将CPU的控制权交还给使它得以运行的程序(常为DOS系统)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 4C00h</span><br><span class="line">int 21h</span><br></pre></td></tr></table></figure></li></ul><p>解释：</p><ul><li><p>段定义：</p><ul><li><p>一个汇编程序是由多个段组成的，这些段被用来存放代码、数据或或当作栈空间来使用。&amp;#x20;</p></li><li><p>一个有意义的汇编程序中至少要有一个段，这个段用来存放代码。&amp;#x20;</p></li><li><p>定义程序中的段：每个段都需要有段名&amp;#x20;</p><ul><li><code>段名 segment</code>：段的开始&amp;#x20;</li><li>…</li><li><code>段名 ends</code>：一段的结束</li></ul></li></ul></li><li><p>end(不是ends)</p><ul><li><p>汇编程序的结束标记。若程序结尾处不加end，编译器在编译程序 时，无法知道程序在何处结束</p></li><li><p>assume(假设)</p><p>含义是假设某一段寄存器和程序中的某一个用 <code>segment … ends</code> 定义的段相关联</p><p>assume cs:codesg指CS寄存器与codesg关联，将定义的codesg当作程序的代码段使用。</p></li></ul></li></ul><p>如何写出一个程序？</p><blockquote><ol><li>定义一个段&amp;#x20;</li><li>实现处理任务&amp;#x20;</li><li>指出程序在何结束&amp;#x20;</li><li>段与段寄存器关联&amp;#x20;</li><li>加上程序返回的代码</li></ol></blockquote><p>举例：求2^3</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">assume cs:abc</span><br><span class="line">abc segment</span><br><span class="line">mov ax,2</span><br><span class="line">add ax,ax</span><br><span class="line">add ax,ax</span><br><span class="line"></span><br><span class="line">mov ax,4c00h</span><br><span class="line">int 21h</span><br><span class="line">abc ends</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h3 id="由源程序到程序运行"><a href="#由源程序到程序运行" class="headerlink" title="由源程序到程序运行"></a>由源程序到程序运行</h3><p>过程：</p><ul><li><code>源程序文件.asm</code>—编译—&gt;<code>目标文件.obj</code>—连接—&gt;<code>可执行文件.exe</code>—&gt;运行程序</li></ul><p>编译：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masm XXX.asm</span><br></pre></td></tr></table></figure><p>会出现：</p><blockquote><ul><li><p><code>Object filename[XXX.OBJ]:</code></p><p>目标文件<code>(*.OBJ)</code>了是我们对一个源程序进行编译要得到的最终结果。</p></li><li><p><code>Source Listing [NUL.LST]:</code></p><p>列表文件<code>(*.LST)</code>是编译器将源程序编译为目标文件的过程中产生的中间结果。</p></li><li><p><code>Cross-reference [NUL.CRT]:</code></p><p>交叉引用文件<code>(*.CRF)</code>同列表文件一样，是编译器将源程序编译为目标文件过程中产生的中问结果。</p></li></ul></blockquote><p>连接：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">link XXX.obj</span><br></pre></td></tr></table></figure><p>会出现：</p><blockquote><ul><li><p><code>Run File [XXX.EXE]:</code></p><p>可执行文件<code>(.EXE)</code>是我们对一个程序进行连接要得到的最终结果。</p></li><li><p><code>List File [NUL.MAP]:</code></p><p>映像文件<code>(.MAP)</code>是连接程序将目标文件连接为可执行文件过程中产生的中间结果。</p></li><li><p><code>Libraries [.LIB]:</code></p><p>库文件<code>(.LIB)</code>里包含了一些可以调用的子程序，如果我们的程序中调用了某一个库文件中的子程序，就需要在连接的时候，将这个库文件和我们的目标文件连接到一起，生成可执行文件。</p></li></ul></blockquote><p>运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XXX.exe</span><br></pre></td></tr></table></figure><h3 id="用Debug跟踪程序的执行"><a href="#用Debug跟踪程序的执行" class="headerlink" title="用Debug跟踪程序的执行"></a>用Debug跟踪程序的执行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug XXX.exe</span><br></pre></td></tr></table></figure><p>命令：</p><ul><li>r命令：查看所有寄存器</li><li>u命令：查看程序被装在哪个位置</li><li>t命令：执行一行汇编指令</li><li>p命令：类似于t命令，但遇子程序、中断等时，直接执行，然后显示结果</li><li>g命令：从指定地址开始运行程序，直到遇到断点或程序正常结束</li><li>q命令：退出debug</li></ul><p>小结：</p><ul><li>程序加载后，DS中存放着程序所在内存区的段地址，这个内存区的偏移地址为0，则程序所在的内存区的地址为：<code>DS:0</code></li><li>这个内存区的前256个字节(100H)存PSP(程序段前缀)，DOS用来和程序进行通信。</li><li>从256字节处向后的空间存放的是程序，CS的值为DS+10H。</li><li>程序加载后，CX中存放代码的长度(字节)。</li></ul><p>程序执行处于开发周期的运行方式：</p><ul><li>运行Debug时，command程序加载Debug.exe。debug 将程序加载入内存，程序运行结束后要返回到Debug中，使用Q命令退出Debug，将返回到command中。</li></ul><h3 id="…-和-…"><a href="#…-和-…" class="headerlink" title="[…]和(…)"></a>[…]和(…)</h3><p>一个内存单元的描述：</p><ul><li><p>内存单元的地址</p><ul><li>段地址</li><li>偏移地址</li></ul></li><li><p>内存单元的长度(类型)</p></li></ul><p>[]:汇编语法规定表示一个内存单元</p><p>():(为方便学习作出的约定)表示一个<strong>内存单元或寄存器</strong>中的<strong>内容</strong></p><ul><li>()中只能是物理地址或寄存器</li></ul><table><thead><tr><th align="left">描述对象</th><th align="left">描述方法</th></tr></thead><tbody><tr><td align="left">ax中的内容为0010H</td><td align="left">(ax)&#x3D;0010H</td></tr><tr><td align="left">2000:1000处的内容为0010H</td><td align="left">(21000H)&#x3D;0010H</td></tr><tr><td align="left">mov ax,[2]的功能</td><td align="left">(ax)&#x3D;((ds)*16+2)</td></tr><tr><td align="left">add ax,2 的功能</td><td align="left">((ds)*16+2)&#x3D;(ax)</td></tr><tr><td align="left">mov [2],ax的功能</td><td align="left">((ds)*16+2)&#x3D;(ax)</td></tr><tr><td align="left">add ax,bx的功能</td><td align="left">(ax)&#x3D;(ax)+(bx)</td></tr><tr><td align="left">push ax的功能</td><td align="left">(sp)&#x3D;(sp)-2<br>((ss)*16+(sp))&#x3D;(ax)</td></tr><tr><td align="left">pop ax 的功能</td><td align="left">(sp)&#x3D;(sp)+2<br>(ax)&#x3D;((ss)*16+(sp))</td></tr></tbody></table><h3 id="Loop指令"><a href="#Loop指令" class="headerlink" title="Loop指令"></a>Loop指令</h3><p>功能：实现循环</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  assume cs:code</span><br><span class="line">code segment</span><br><span class="line">mov ax, 2</span><br><span class="line">mov cx, 11</span><br><span class="line">s:add ax, ax</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>数据不加<code>H</code>，默认为十进制</p><p>数据不能以字母开头，如果数据为ffffh需要在前面加上0为：<code>0ffffh</code></p><p>CPU执行loop指令要进行的操作</p><ul><li><p>(cx)&#x3D;(cx)-1</p></li><li><p>判断cx中的值</p><ul><li>为零，则向下执行</li><li>不为零，转至标号处执行程序</li></ul></li></ul><p>注意：cx中要提前存放循环次数(如果设置为10，那么循环次数就为10次)，(cx)影响着loop指令的执行</p><h3 id="段前缀的使用"><a href="#段前缀的使用" class="headerlink" title="段前缀的使用"></a>段前缀的使用</h3><p>Debug中，<code>mov al, [0]</code>的功能是将DS:0的存储的单元的值专递给AL</p><p>但是已经编译好的程序中，Dubug后，使用u命令查看代码，<code>mov al, [0]</code>变成了将常量0传给AL<code>mov al, 00</code></p><p>解决办法：</p><p>在[idata]前显式写上段寄存器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 2000H</span><br><span class="line">mov ds, ax</span><br><span class="line">mov al, ds:[0]</span><br></pre></td></tr></table></figure><p>这些出现在访问内存单元的指令中，用于显式地指明内存单元的段地址的“ds:”、“cs:”、“ss:”或“es:” ，在汇编语言中称为<strong>段前缀</strong>。</p><p>访问连续的内存单元</p><p>计算ffff:0~ffff:b字节单元中的数据和，结果存储在dx中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">assume sc:code</span><br><span class="line">code segment</span><br><span class="line">mov ax, 0ffffh</span><br><span class="line">mov ds, ax;段地址</span><br><span class="line"></span><br><span class="line">mov dx, 0;结果</span><br><span class="line">mov bx, 0;偏移地址</span><br><span class="line">mov cx, 12;循环次数</span><br><span class="line"></span><br><span class="line">s:  mov al, ds:[bx];获取某一内存单元数据</span><br><span class="line">mov ah, 0;将高8位置为0</span><br><span class="line">add dx, ax;累加</span><br><span class="line">inc bx;地址+1</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>将内存ffff:0~ffff:b中的内存拷贝到0:200～0:20单元中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">mov bx, 0;偏移地址</span><br><span class="line">mov cx, 12;循环次数</span><br><span class="line"></span><br><span class="line">s:  mov ax, 0ffffh</span><br><span class="line">mov ds, ax;将ffffh段地址送入ds</span><br><span class="line">mov dl, ds:[bx];将ffff:[bx]内存单元数据保存到dl</span><br><span class="line"></span><br><span class="line">mov ax, 0020h</span><br><span class="line">mov ds, ax;将ds的段地址改为0020h</span><br><span class="line">mov [bx], dl;将dl的数据送入0020:[bx]中</span><br><span class="line"></span><br><span class="line">inc bx;地址+1</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end </span><br></pre></td></tr></table></figure><h3 id="在代码段中使用数据"><a href="#在代码段中使用数据" class="headerlink" title="在代码段中使用数据"></a>在代码段中使用数据</h3><p>在程序中直接写地址是危险的，因为在计算机中每一段内存干什么的都是明确的</p><p>在程序的段中存放数据，运行时由操作系统分配空间。&amp;#x20;</p><p>段的类别 ：数据贸、代码段、 栈段&amp;#x20;</p><p>各种段中均可以有数据可以在单个的段中安置，也可以将数据、代码、栈放入不同的段中。</p><p>编程计算以下8个数据的和，结果存在ax寄存器中&amp;#x20;</p><p>0123H,0456H,0789H,0abcH,0defH,0fedH,0cbaH,0987H</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">dw 0123H,0456H,0789H,0abcH,0defH,0fedH,0cbaH,0987H</span><br><span class="line"></span><br><span class="line">mov bx, 0;偏移地址</span><br><span class="line">mov ax, 0</span><br><span class="line">mov cx, 8;循环次数</span><br><span class="line"></span><br><span class="line">s:add ax, cs:[bx];累加</span><br><span class="line">add bx, 2;地址+2，要取的是字而非字节</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end</span><br></pre></td></tr></table></figure><ul><li><code>dw</code>：定义一个字</li><li><code>db</code>：定义一个字节</li><li><code>dd</code>：定义一个双字</li></ul><p><strong>但是这个代码有问题！！</strong></p><p>Dubug后，偏移地址IP是从0000开始的，但是从0000开始的是数据，只有到0010才是真正的代码</p><p>所以，要让数据从CS:0000开始，让代码从CS:0010开始</p><p>改进：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">dw 0123H,0456H,0789H,0abcH,0defH,0fedH,0cbaH,0987H</span><br><span class="line"></span><br><span class="line">start:mov bx, 0;偏移地址</span><br><span class="line">mov ax, 0</span><br><span class="line">mov cx, 8;循环次数</span><br><span class="line"></span><br><span class="line">s:add ax, cs:[bx];累加</span><br><span class="line">add bx, 2;地址+2，要取的是字而非字节</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>与上面的区别就是多了两个 <code>start</code>(可以自定义，也可以为begin)</p><ul><li><p>开头的<code>start:</code>：定义一个标号，指示代码开始的位置，程序加载后，<code>CS:IP</code>执行要执行的第一条指令的start处</p></li><li><p>结尾的<code>end start</code>：end的作用处理通知编译器程序结束外，还可以通知编译器程序入口在哪里</p></li><li><p>相当于C中的main函数，来指定IP的偏移</p></li></ul><p>这就有了程序的一般框架：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">数据</span><br><span class="line">begin:</span><br><span class="line">代码</span><br><span class="line">code ends</span><br><span class="line">end begin</span><br></pre></td></tr></table></figure><h3 id="在代码段中使用栈"><a href="#在代码段中使用栈" class="headerlink" title="在代码段中使用栈"></a>在代码段中使用栈</h3><p>完成下面的程序，利用栈，将程序中定义的数据逆序存放</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">dw 0123H,0456H,0789H,0abcH,0defH,0fedH,0cbaH,0987H</span><br><span class="line">dw 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">start:</span><br><span class="line">mov ax, cs   </span><br><span class="line">mov ss, ax;设置栈的段地址</span><br><span class="line">mov sp, 30h;设置栈的偏移地址(起始地址)</span><br><span class="line"></span><br><span class="line">mov bx, 0;设置数据段的起始地址</span><br><span class="line">mov cx, 8;循环次数</span><br><span class="line">s:push cs:[bx];压栈</span><br><span class="line">add bx, 2;移动到下一个字的内存地址，地址+2</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov bx, 0;设置数据段的起始地址</span><br><span class="line">mov cx, 8;循环次数</span><br><span class="line">u:  pop cs:[bx];出栈，并直接给数据段赋值</span><br><span class="line">add bx, 2;移动到下一个字的内存地址，地址+2</span><br><span class="line">loop u</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="将数据、代码、栈放入不同段"><a href="#将数据、代码、栈放入不同段" class="headerlink" title="将数据、代码、栈放入不同段"></a>将数据、代码、栈放入不同段</h3><p>数据、栈和代码都在一个段。  </p><p>程序显得混乱， 编程和阅读时都要注意何处是数据，何处是栈， 何处是代码， 只应用于要处理 的数据很少，用到的栈空间也小， 加上没有多长的代码</p><p>将数据、栈和代码放在不同段中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data, ss:stack</span><br><span class="line">data segment</span><br><span class="line">dw 0123H,0456H,0789H,0abcH,0defH,0fedH,0cbaH,0987H</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">dw 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">;初始化段寄存器</span><br><span class="line">mov ax, stack</span><br><span class="line">mov ss, ax;ss放入栈段</span><br><span class="line">mov sp, 20h;设置栈顶</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax;ds放入数据段</span><br><span class="line">;入栈</span><br><span class="line">mov bx, 0;数据的起始地址</span><br><span class="line">mov cx, 8;循环次数</span><br><span class="line">s:push [bx]</span><br><span class="line">add bx, 2;地址+2，字型</span><br><span class="line">loop s</span><br><span class="line">;出栈</span><br><span class="line">mov bx, 0</span><br><span class="line">mov cx, 8</span><br><span class="line">u:pop [bx]</span><br><span class="line">add bx, 2</span><br><span class="line">loop u</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="3-内存寻址方式"><a href="#3-内存寻址方式" class="headerlink" title="3.内存寻址方式"></a>3.内存寻址方式</h2><h3 id="处理字符问题"><a href="#处理字符问题" class="headerlink" title="处理字符问题"></a>处理字符问题</h3><p>汇编程序中，用<code>&#39;……&#39;</code>的方式指明数据是以字符的形式给出的，编译器将把它们转化为相对应的ASCII码</p><table><thead><tr><th align="left">大写</th><th align="left">二进制</th><th align="left">小写</th><th align="left">二进制</th></tr></thead><tbody><tr><td align="left">A</td><td align="left">01000001</td><td align="left">a</td><td align="left">01100001</td></tr><tr><td align="left">B</td><td align="left">01000010</td><td align="left">b</td><td align="left">01100010</td></tr><tr><td align="left">C</td><td align="left">01000011</td><td align="left">c</td><td align="left">01100011</td></tr><tr><td align="left">D</td><td align="left">01000100</td><td align="left">d</td><td align="left">01100100</td></tr></tbody></table><p>由表可知：小写字母的ASCII码值比大写字母的ASCII码值大20H</p><p>大小写转换问题：</p><ul><li>第一个字符串：小写字母转换为大写字母</li><li>第二个字符串：大写字母转换为小写字母</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data</span><br><span class="line">data segment</span><br><span class="line">db ‘BaSiC’</span><br><span class="line">db ‘iNfOrMaTiOn’</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line"></span><br><span class="line">mov bx, 0;数据段段起始地址</span><br><span class="line">mov cx, 5;循环次数</span><br><span class="line">s:mov al, [bx];获取到当前地址的字符</span><br><span class="line">and al, 11011111B;and运算，变为大写</span><br><span class="line">mov [bx], al;送入当前地址</span><br><span class="line">inc bx</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov bx, 5;数据段起始地址</span><br><span class="line">mov cx, 11;循环次数</span><br><span class="line">u:mov al, [bx];获取到当前地址到字符</span><br><span class="line">or al, 00100000B;or运算，变为小写</span><br><span class="line">mov [bx], al;送入当前地址</span><br><span class="line">inc bx</span><br><span class="line">loop u</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="bx-idata-方式寻址"><a href="#bx-idata-方式寻址" class="headerlink" title="[bx+idata]方式寻址"></a>[bx+idata]方式寻址</h3><p>[bx+idata]表示一个内存单元，它的偏移地址为(bx)+idata</p><p><code>mov ax, [bx+200]</code>的含义：</p><ul><li>将一个内存单元的内容送入ax</li><li>这个内存单元的长度为2字节(字单元)，存放一个字</li><li>内存单元的段地址在ds中，偏移地址为200+bx中的数值</li></ul><p>数学化的描述为：(ax)&#x3D;((ds)*16+200+(bx))</p><p>其他写法：</p><ul><li><code>mov ax, [200+bx]</code></li><li><code>mov ax, 200[bx]</code></li><li><code>mov ax, [bx].200</code></li></ul><p>用[bx+idata]的方式进行数组的处理</p><p>问题：大小写转换问题</p><ul><li>第一个字符串：小写字母转换为大写字母</li><li>第二个字符串：大写字母转换为小写字母</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data</span><br><span class="line">data segment</span><br><span class="line">db ‘BaSiC’</span><br><span class="line">db ‘MinIX’</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">;同时操作两个字符串</span><br><span class="line">mov bx, 0;数据段段起始地址</span><br><span class="line">mov cx, 5;循环次数</span><br><span class="line">s:mov al, [bx];获取到当前地址的字符</span><br><span class="line">and al, 11011111B;and运算，变为大写</span><br><span class="line">mov [bx], al;送入当前地址</span><br><span class="line"></span><br><span class="line">mov al, [bx+5];获取到当前地址到字符</span><br><span class="line">or al, 00100000B;or运算，变为小写</span><br><span class="line">mov [bx+5], al;送入当前地址</span><br><span class="line">inc bx</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>等价于C：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> a[<span class="number">5</span>] = <span class="string">&quot;BaSiC&quot;</span>;</span><br><span class="line"><span class="type">char</span> b[<span class="number">5</span>] = <span class="string">&quot;MinIx&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(i &lt; <span class="number">5</span>)</span><br><span class="line">&#123;</span><br><span class="line">a[i] = a[i] &amp; <span class="number">0xDF</span>;</span><br><span class="line">b[i] = b[i] | <span class="number">0x20</span>;</span><br><span class="line">i++l</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SI和DI寄存器"><a href="#SI和DI寄存器" class="headerlink" title="SI和DI寄存器"></a>SI和DI寄存器</h3><p>SI和DI是8086CPU中和BX功能相近的寄存器</p><ul><li>BX：通过寄存器，在计算存储器地址时，常作为基地址寄存器用</li><li>SI：source index， 源变址寄存器</li><li>DI：destination index，目标变址寄存器</li><li>区别：SI和DI不能够分成两个8位寄存器来使用</li></ul><p>DI和SI也可以实现相同的功能：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mov bx, 0</span><br><span class="line">mov ax, [bx]</span><br><span class="line"></span><br><span class="line">mov si, 0</span><br><span class="line">mov ax, [si]</span><br><span class="line"></span><br><span class="line">mov di, 0</span><br><span class="line">mov ax, [di]</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mov bx, 0</span><br><span class="line">mov ax, [bx+123]</span><br><span class="line"></span><br><span class="line">mov si, 0</span><br><span class="line">mov ax, [si+123]</span><br><span class="line"></span><br><span class="line">mov di, 0</span><br><span class="line">mov ax, [di+123]</span><br></pre></td></tr></table></figure><p>SI和DI的应用：</p><p>问题：用寄存器SI和DI实现将字符串<code>welcome to masm!</code>复制到它后面的数据区中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data</span><br><span class="line">data segment</span><br><span class="line">db &#x27;welcome to masm!&#x27;</span><br><span class="line">db &#x27;................&#x27;</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line"></span><br><span class="line">mov si, 0</span><br><span class="line">mov di, 16</span><br><span class="line">mov cx, 8</span><br><span class="line">s:mov ax, [si]</span><br><span class="line">mov [di], ax</span><br><span class="line">add si, 2</span><br><span class="line">add di, 2</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="bx-si-和-bx-di-方式寻址"><a href="#bx-si-和-bx-di-方式寻址" class="headerlink" title="[bx+si]和[bx+di]方式寻址"></a>[bx+si]和[bx+di]方式寻址</h3><p>[bx+si]表示一个内存单元</p><ul><li>偏移地址为(bx)+(si)</li></ul><p>指令<code>mov ax, [bx+si]</code>的含义</p><ul><li>数学化的描述为：(ax)&#x3D;((ds)*16+(bx)+(si))</li></ul><p>其他写法：</p><ul><li><code>mov ax, [bx][si]</code></li></ul><p>感觉像二维数组</p><h3 id="bx-si-idata-和-bx-di-idata-方式寻址"><a href="#bx-si-idata-和-bx-di-idata-方式寻址" class="headerlink" title="[bx+si+idata]和[bx+di+idata]方式寻址"></a>[bx+si+idata]和[bx+di+idata]方式寻址</h3><p><code>mov ax, [bx+si+idata]</code>的含义</p><ul><li>数学化的描述：(ax) &#x3D; ((ds)*16+(bx)+(si)+idata)</li></ul><p>其他写法：</p><ul><li><code>mov ax, [bx+200+si]</code></li><li><code>mov ax, [200+bx+si]</code></li><li><code>mov ax, 200[bx][si]</code></li><li><code>mov ax, [bx].200[si]</code></li><li><code>mov ax, [bx][si].200</code></li></ul><h3 id="不同的寻址方式的灵活应用"><a href="#不同的寻址方式的灵活应用" class="headerlink" title="不同的寻址方式的灵活应用"></a>不同的寻址方式的灵活应用</h3><table><thead><tr><th>形式</th><th>名称</th><th>意义</th><th>示例</th></tr></thead><tbody><tr><td>[idata]</td><td>直接寻址</td><td>用于直接定位一个内存单元</td><td>mov ax, [200]</td></tr><tr><td>[bx]</td><td>寄存器间接寻址</td><td>用于间接定位一个内存单元</td><td>mox bx, 0<br>mov ax, [bx+200]</td></tr><tr><td>[bx+idata]</td><td>寄存器相对寻址</td><td>可在一个起始地址的基础上用变量间接定位一个内存单元</td><td>mov bx, 4<br>mov ax, [bx+200]</td></tr><tr><td>[bx+si]</td><td>基地址变址寻址</td><td></td><td>mov ax, [bx+si]</td></tr><tr><td>[bx+si+idata]</td><td>相对基地址变址寻址</td><td></td><td>mov ax, [bx+si+200]</td></tr></tbody></table><p>案例：</p><p>编程将data段中的每个单词的开头一个字母变成大写字母</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data</span><br><span class="line">data segment</span><br><span class="line">db &#x27;1.file          &#x27;    ;每个长度为16</span><br><span class="line">db &#x27;2.edit          &#x27;</span><br><span class="line">db &#x27;3.search        &#x27;</span><br><span class="line">db &#x27;4.view          &#x27;</span><br><span class="line">db &#x27;5.options       &#x27;</span><br><span class="line">db &#x27;6.help          &#x27;</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line"></span><br><span class="line">mov cx, 6           ;设置循环次数</span><br><span class="line">mov bx, 0;设置起始地址</span><br><span class="line"></span><br><span class="line">s: add al, [bx][2]</span><br><span class="line">and al, 11011111B</span><br><span class="line">mov [bx][2], al</span><br><span class="line">add bx, 16          ;移动到下一个字符串的起始地址</span><br><span class="line">loop s</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>编程将每个单词都改为大写字母</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data, ss:stack</span><br><span class="line">data segment</span><br><span class="line">db &#x27;ibm             &#x27;    ;每个长度为16</span><br><span class="line">db &#x27;dec             &#x27;</span><br><span class="line">db &#x27;doc             &#x27;</span><br><span class="line">db &#x27;vax             &#x27;</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">dw 0,0,0,0,0,0,0,0</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov ax, stack</span><br><span class="line">mov ss, ax</span><br><span class="line"></span><br><span class="line">mov cx, 4           ;设置i层的循环次数</span><br><span class="line">mov bx, 0</span><br><span class="line"></span><br><span class="line">i: mov si, 0</span><br><span class="line">push cx            ;用栈保存i层的循环次数</span><br><span class="line">mov cx, 3           ;设置j层的循环次数</span><br><span class="line"></span><br><span class="line">j:add al, [bx][si]</span><br><span class="line">and al, 11011111B</span><br><span class="line">mov [bx][si], al</span><br><span class="line">inc si</span><br><span class="line">loop j</span><br><span class="line"></span><br><span class="line">add bx, 16</span><br><span class="line">pop cx             ;从栈拿出i层的循环次数</span><br><span class="line">loop i</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="不同的寻址方式的演示"><a href="#不同的寻址方式的演示" class="headerlink" title="不同的寻址方式的演示"></a>不同的寻址方式的演示</h3><p>内存的寻址方式：</p><table><thead><tr><th>寻址方式</th><th>名称</th><th>常用格式举例</th></tr></thead><tbody><tr><td>[idata]</td><td>直接寻址</td><td><code>[idata]</code></td></tr><tr><td>[bx]<br/>[si]<br/>[di]<br/>[bp]</td><td>寄存器间接寻址</td><td><code>[bx]</code></td></tr><tr><td>[bx+idata]<br>[si+idata]<br>[di+idata]<br>[dp+idata]</td><td>寄存器相对寻址</td><td>用于结构体：<code>[bx].idata</code><br>用于数组：<code>idata[si]</code>或<code>idata[di]</code><br>用于二维数组：<code>[bx][idata]</code></td></tr><tr><td>[bx+si]<br/>[bx+di]<br/>[bp+si]<br/>[bp+di]</td><td>基地址变址寻址</td><td>用于二维数组：<code>[bx][si]</code></td></tr><tr><td>[bx+si+idata]<br/>[bx+di+idata]<br/>[bp+si+idata]<br/>[bp+di+idata]</td><td>相对基址变址寻址</td><td>用于表格(结构)中的数组项：<code>[bx].idata[si]</code><br>用于二维数组：<code>idata[bx][si]</code></td></tr></tbody></table><p>直接寻址过程：</p><img src="https://s2.loli.net/2022/10/15/QrC4jq1AITi3oLh.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/15/QrC4jq1AITi3oLh.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="QQ图片20221015141303.png" style="zoom:67%;" /><p>寄存器间接寻址过程：</p><img src="https://s2.loli.net/2022/10/15/CVvFb9DIZceT6XA.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/15/CVvFb9DIZceT6XA.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="QQ图片20221015142744.png" style="zoom:67%;" /><p>寄存器相对寻址过程：</p><h3 id="用于内存寻址的寄存器"><a href="#用于内存寻址的寄存器" class="headerlink" title="用于内存寻址的寄存器"></a>用于内存寻址的寄存器</h3><p>错误的指令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mov ax, [cx]</span><br><span class="line">mov ax, [ax]</span><br><span class="line">mov ax, [dx]</span><br><span class="line">mov ax, [ds]</span><br><span class="line"></span><br><span class="line">mov ax, [bx+bp]</span><br><span class="line">mov ax, [si+di]</span><br></pre></td></tr></table></figure><p>正确的指令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mov ax, [si]</span><br><span class="line">mov ax, [di]</span><br><span class="line"></span><br><span class="line">mov ax, [bx]</span><br><span class="line">mov ax, [bx+si]</span><br><span class="line">mov ax, [bx+di]</span><br><span class="line"></span><br><span class="line">mov ax, [bp]</span><br><span class="line">mov ax, [bp+si]</span><br><span class="line">mov ax, [bp+di]</span><br></pre></td></tr></table></figure><ul><li>只有bx、bp、si、di可以在<code>[]</code>中对内存单元寻址</li><li>bx以外的通用寄存器、段寄存器不可以用在<code>[]</code>中</li></ul><p>bx和bp的区别：</p><ul><li>bx默认指ds段</li><li>bp默认指ss段</li></ul><table><thead><tr><th>指令</th><th>解释</th></tr></thead><tbody><tr><td>mov ax, [bp]</td><td>(ax)&#x3D;((ss)*16+(bp))，默认</td></tr><tr><td>mov ax, ds:[bp]</td><td>(ax)&#x3D;((ds)*16+(bp))</td></tr><tr><td>mov ax, es:[bp]</td><td>(ax)&#x3D;((es)*16+(bp))</td></tr><tr><td>mov ax, [bx]</td><td>(ax)&#x3D;((ds)*16+(bx))，默认</td></tr><tr><td>mov ax, ss:[bx]</td><td>(ax)&#x3D;((ss)*16+(bx))</td></tr></tbody></table><h3 id="在哪里？有多长？"><a href="#在哪里？有多长？" class="headerlink" title="在哪里？有多长？"></a>在哪里？有多长？</h3><ol><li><p>立即数(idata)</p><ul><li>对于直接包含在机器指令中的数据，称为立即数(idata)，数据包含在指令中</li><li><code>mov ax, 1</code>的机器码为<code>B80100</code>其中的<code>0100</code></li></ul></li><li><p>寄存器</p><ul><li>指令要处理的数据在寄存器中，在汇编指令中给出相应的寄存器名</li></ul></li><li><p>内存：段地址(SA)和偏移地址(EA)</p><ul><li>指令要处理的数据内存中，由<code>SA:EA</code>确定内存单元</li></ul></li><li><p>字word操作</p><ul><li><code>mov ax, 1</code></li></ul></li><li><p>字节byte操作</p><ul><li><code>mov al, 1</code></li></ul></li><li><p>用word ptr或byte ptr指明</p><ul><li><code>mov word ptr ds:[0], 1</code></li><li><code>mov byte ptr ds:[0], 1</code></li><li>在<strong>没有寄存器</strong>参与的内存单元访问指令中，用word ptr或byte ptr<strong>显性地指明所要访问的内存单元长度</strong>是很有必要的，否则，CPU无法得知要访问的单元是字单元，还是字节单元</li></ul></li></ol><h3 id="寻址方式的综合应用"><a href="#寻址方式的综合应用" class="headerlink" title="寻址方式的综合应用"></a>寻址方式的综合应用</h3><p>关于姚明2001年的一条记录：</p><ul><li>姓名：Yao</li><li>生日：’19800912’</li><li>球衣号码：15</li><li>场均得分：32</li><li>效力球队：SHH</li></ul><p>到了2002年，姚明的信息有了变化：</p><ul><li>球衣号码变换成了11号</li><li>场均得分为13</li><li>效力球队：HOU</li></ul><p>任务：编程修改内存中的过时数据</p><p>2001年数据：</p><table><thead><tr><th></th><th>si</th><th>数据</th></tr></thead><tbody><tr><td>seg:60</td><td>+00</td><td>‘Yao’</td></tr><tr><td></td><td>+03</td><td>‘19800912’</td></tr><tr><td></td><td>+0C</td><td>15</td></tr><tr><td></td><td>+0E</td><td>32</td></tr><tr><td></td><td>+10</td><td>‘SHH’</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mov ax, seg</span><br><span class="line">mov ds, ax</span><br><span class="line">mov bx, 60h</span><br><span class="line"></span><br><span class="line">mov word ptr [bx+0ch], 11</span><br><span class="line">mov word ptr [bx+0eh], 32</span><br><span class="line"></span><br><span class="line">mov si, 0</span><br><span class="line">mov byte ptr [bx+10h+si], &#x27;H&#x27;</span><br><span class="line">inc si</span><br><span class="line">mov byte ptr [bx+10h+si], &#x27;O&#x27;</span><br><span class="line">inc si</span><br><span class="line">mov byte ptr [bx+10h+si], &#x27;U&#x27;</span><br></pre></td></tr></table></figure><p>等价于C：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Player</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">char</span> name[<span class="number">3</span>];</span><br><span class="line"><span class="type">char</span> birthday[<span class="number">9</span>];</span><br><span class="line"><span class="type">int</span> num;</span><br><span class="line"><span class="type">int</span> score;</span><br><span class="line"><span class="type">char</span> team[<span class="number">3</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Player</span> <span class="title">yao</span> =</span> &#123;<span class="string">&quot;Yao&quot;</span>, <span class="string">&quot;19800912&quot;</span>, <span class="number">15</span>, <span class="number">32</span>, <span class="string">&quot;SHH&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    yao.num = <span class="number">11</span>;</span><br><span class="line">    yao.score = <span class="number">13</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    yao.team[i] = <span class="string">&#x27;H&#x27;</span>;</span><br><span class="line">    i++;</span><br><span class="line">    yao.team[i] = <span class="string">&#x27;O&#x27;</span>;</span><br><span class="line">    i++;</span><br><span class="line">    yao.team[i] = <span class="string">&#x27;U&#x27;</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中结构体<code>yao</code>等价于上面汇编中的<code>bx</code></p><ul><li><code>yao.num = 11;</code> &lt;&#x3D;&gt; <code>mov word ptr [bx].0ch, 11</code> &lt;&#x3D;&gt;  <code>mov word ptr [bx+0ch], 11</code></li><li><code>yao.team[i] = &#39;H&#39;;</code> &lt;&#x3D;&gt; <code>mov byte ptr [bx].10h[si], &#39;H&#39;</code> &lt;&#x3D;&gt; <code>mov byte ptr [bx+10h+si], &#39;H&#39;</code></li></ul><h3 id="用div指令实现除法"><a href="#用div指令实现除法" class="headerlink" title="用div指令实现除法"></a>用div指令实现除法</h3><blockquote><p>被除数：(默认)放在AX或DX和AX中</p><p>除数：8位或16位，在寄存器或内存单元中</p><p>指令格式：</p><ul><li><p><code>div [除数]</code></p></li><li><p>举例：<code>div 寄存器</code> 或 <code>div 内存单元</code></p></li></ul></blockquote><table><thead><tr><th>被除数</th><th>AX</th><th>DX和AX</th></tr></thead><tbody><tr><td>除数</td><td>8位内存或寄存器</td><td>16位内存或寄存器</td></tr><tr><td>商</td><td>AL</td><td>AX</td></tr><tr><td>余数</td><td>AH</td><td>DX</td></tr></tbody></table><p>例如：</p><table><thead><tr><th>示例指令</th><th>被除数</th><th>除数</th><th>商</th><th>余数</th></tr></thead><tbody><tr><td>div bl</td><td>(ax)</td><td>(bl)</td><td>(al)</td><td>(ah)</td></tr><tr><td>div byte ptr ds:[0]</td><td>(ax)</td><td>((ds)*16+0)</td><td>(al)</td><td>(ah)</td></tr><tr><td>div byte ptr [bx+si+8]</td><td>(ax)</td><td>((ds)*16+(bx)+(si)+8)</td><td>(al)</td><td>(ah)</td></tr><tr><td>div bx</td><td>(dx)*10000H+(ax)</td><td>(bx)</td><td>(ax)</td><td>(dx)</td></tr><tr><td>div word ptr es:[0]</td><td>(dx)*10000H+(ax)</td><td>((es)*16+0)</td><td>(ax)</td><td>(dx)</td></tr><tr><td>div word ptr [bx+si+8]</td><td>(dx)*10000H+(ax)</td><td>((ds)*16+(bx)+(si)+8)</td><td>(ax)</td><td>(dx)</td></tr></tbody></table><p>注意：提前在默认的寄存器中设置好<strong>被除数</strong>，且默认寄存器不作别的用处</p><p>示例：</p><p>编程利用除法指令计算100001&#x2F;100</p><p>分析：</p><ul><li>100001D &#x3D; 186A1H</li><li>被除数转换成16进制为5位，需要进行16位的除法</li><li>dx和ax两个寄存器联合存放186A1H</li><li>用bx存放除数100D &#x3D; 64H</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov dx, 1H</span><br><span class="line">mov ax, 86A1H</span><br><span class="line">mov bx, 64H</span><br><span class="line">div bx</span><br><span class="line">;ax中存放商</span><br><span class="line">;dx中存放余数</span><br></pre></td></tr></table></figure><p>编程利用除法指令计算1001&#x2F;100</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 3E9H</span><br><span class="line">mov bx, 64H</span><br><span class="line">div bx</span><br><span class="line">;al中存放商</span><br><span class="line">;ah中存放余数</span><br></pre></td></tr></table></figure><p>在内存单元中实现除法</p><p>双字型数据的定义：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data segment</span><br><span class="line">db 1;定义字节类型为01H，在data:0处，占1个字节</span><br><span class="line">dw 1;定义字类型为0001H，在data:1处，占2个字节</span><br><span class="line">dd 1;定义双字类型为00000001H，在data:3处，占4个字节</span><br><span class="line">data ends</span><br></pre></td></tr></table></figure><p>例子：用div计算data中的第一个数据除以第二个数据，将商存放在第三个数据的存储单元中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">data segment</span><br><span class="line">dd 100001</span><br><span class="line">dw 100</span><br><span class="line">dw 0</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line"></span><br><span class="line">mov ax, ds:[0]</span><br><span class="line">mov dx, ds:[2]</span><br><span class="line">div word ptr ds:[4]</span><br><span class="line">mov word ptr ds:[6], ax</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="用dup设置内存空间"><a href="#用dup设置内存空间" class="headerlink" title="用dup设置内存空间"></a>用dup设置内存空间</h3><p>dup和db、dw、dd等数据定义伪指令配合使用，用来进行数据的重复</p><p>示例：</p><table><thead><tr><th>指令</th><th>功能</th><th>相当于</th></tr></thead><tbody><tr><td>db 3 dup(0)</td><td>定义了3个字节，它们的值都是0</td><td>db 0,0,0</td></tr><tr><td>db 3 dup(0,1,2)</td><td>定义了9个字节，有0、1、2重复3次构成</td><td>db 0,1,2,0,1,2,0,1,2</td></tr><tr><td>db 3 dup(‘abc’,’ABC’)</td><td>定义了18个字节，构成’abcABCabcABCabcABC’</td><td>db ‘abcABCabcABCabcABC’</td></tr></tbody></table><p>格式：</p><ul><li><code>db 重复次数 dup(重复的字节型数据)</code></li><li><code>dw 重复次数 dup(重复的字型数据)</code></li><li><code>dd 重复次数 dup(重复的双字型数据)</code></li></ul></div><div class="story post-story"><h2 id="4-流程转移与子程序"><a href="#4-流程转移与子程序" class="headerlink" title="4.流程转移与子程序"></a>4.流程转移与子程序</h2><h3 id="“转移”综述"><a href="#“转移”综述" class="headerlink" title="“转移”综述"></a>“转移”综述</h3><p>一般情况下指令是顺序地逐条执行的，而在实际中，常需要改变程序的执行流程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 0</span><br><span class="line">jmp short, s</span><br><span class="line">add ax, 1</span><br><span class="line">s:inc ax</span><br></pre></td></tr></table></figure><p>转移指令：</p><ul><li>可以控制CPU执行内存中某处代码的指令</li><li>可以修改IP，或同时修改CS和IP的指令</li></ul><p>转移指令的分类</p><ul><li>按转移行为<ul><li>段内转移：只修改IP，如<code>jmp ax</code></li><li>段间转移：同时修改CS和IP，如<code>jmp 1000:0</code></li></ul></li><li>根据指令对IP修改的范围不同<ul><li>段内短转移：IP修改范围为-128~127</li><li>段内近转移：IP修改范围为-32768~32767</li></ul></li><li>按转移指令<ul><li>无条件转移指令(如：jmp)</li><li>条件转移指令(如：jcxz)</li><li>循环指令(如：loop)</li><li>过程</li><li>中断</li></ul></li></ul><h3 id="操作符offset"><a href="#操作符offset" class="headerlink" title="操作符offset"></a>操作符offset</h3><p>用<code>offset</code>取得标号的偏移地址</p><p>格式：<code>offset 标号</code></p><p>例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">assume  cs:code</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, offset start;相当于mov ax, 0</span><br><span class="line">s:mov ax, offset s;相当于mov ax, 3</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>问题：有如下程序段，添加2条指令，使该程序在运行中将s处的一条指令复制到s0处</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">s:mov ax, bx;该指令占用2字节</span><br><span class="line">mov si, offset s</span><br><span class="line">mov di, offset s0</span><br><span class="line"></span><br><span class="line">mov ax, cs[si] ;需要添加的指令1</span><br><span class="line">mov cs[di], ax;需要添加的指令2</span><br><span class="line"></span><br><span class="line">s0:nop;nop的机器码占一个字节，起占位作用</span><br><span class="line">nop</span><br><span class="line">code ends</span><br><span class="line">ends</span><br></pre></td></tr></table></figure><h3 id="jmp指令-1"><a href="#jmp指令-1" class="headerlink" title="jmp指令"></a>jmp指令</h3><p>jmp指令的功能</p><ul><li>无条件转移，可以只修改IP，也可以同时修改CS和IP</li></ul><p>jmp指令要给出两种信息：</p><ul><li>转移的目的地址</li><li>转移的距离<ul><li>段间转移(远转移)：<code>jmp 2000:1000</code></li><li>段内短转移：<code>jmp short 标号</code>;IP的修改范围为-128~127，8位的位移</li><li>段内近转移：<code>jmp near ptr 标号</code>;IP的修改范围为-32768~32767，16位的位移</li></ul></li></ul><table><thead><tr><th>地址</th><th>机器码</th><th>指令</th></tr></thead><tbody><tr><td>076A:0000</td><td>B80000</td><td>mov ax, 0000</td></tr><tr><td>076A:0003</td><td>EB<span style="color:red">03</span></td><td>jmp short s</td></tr><tr><td>076A:<span style="color:red">0005</span></td><td>050100</td><td>add ax, 0001</td></tr><tr><td>076A:0008</td><td>40</td><td>s: inc ax</td></tr></tbody></table><p>跳转的偏移地址等于(IP)+03 &#x3D; 0008，03为机器码中的03，IP此时为05</p><p>jmp short 的机器指令中，包含的是跳转到指令的相对位置，而不是转移的目标地址</p><p>两种段内转移</p><blockquote><p>短转移：”jmp short 标号”</p><ul><li>功能：(IP)&#x3D;(IP)+8位位移</li><li>原理：<ol><li>8位位移&#x3D;”标号”处的地址-jmp指令后的第一个字节的地址；</li><li>short指明此处的位移为8位位移；</li><li>8位位移的范国为-128~127，用<strong>补码</strong>表示；</li><li>8位位移由编译程序在编译时算出。</li></ol></li></ul><p>近转移：指令”jmp near ptr标号”</p><ul><li>功能：(IP)&#x3D;(IP)+16位位移</li><li>原理：<ol><li>16位位移&#x3D;”标号”处的地址-jmp指令后的第一个字节的地址；</li><li>near ptr指明此处的位移为16位位移，进行的是段内近转移；</li><li>16位位移的范国为-32769~32767，用补码表示；</li><li>16位位移由编译程序,在编译时算出。</li></ol></li></ul><p>远转移：<code>jmp far ptr 标号</code></p><ul><li>far ptr指明了跳转的目的地址，包含了标号段地址CS和偏移地址IP</li></ul></blockquote><p>转移地址在寄存器中的jmp指令</p><ul><li>指令格式：<code>jmp 16位寄存器</code></li><li>功能：IP &#x3D; (16位寄存器)</li><li>例子：<code>jmp ax</code></li></ul><h3 id="其他转移指令"><a href="#其他转移指令" class="headerlink" title="其他转移指令"></a>其他转移指令</h3><p>jcxz指令</p><ul><li><p>格式：<code>jcxz 标号</code></p></li><li><p>功能：如果(cx) &#x3D; 0，则跳转到标号处执行，与”jmp short 标号”类似</p><p>​当(cx) !&#x3D; 0，什么也不做</p></li></ul><p>loop指令</p><ul><li><p>格式：<code>loop 标号</code></p></li><li><p>指令操作：</p><ol><li><p>(cx) -&#x3D; (cx)</p></li><li><p>当(cx) !&#x3D; 0时，则转移到标号处执行</p><p>当(cx) &#x3D; 0时，程序向下执行</p></li></ol></li></ul><p>在它们对应的机器码中不包含转移的目的地址，而包含的是到目的地址的位移。</p><ul><li>如果loop s的机器码中包含的是s的地址，则就对程序段在内存中的偏移地址有了严格的限制，易引发错误</li><li>当机器码中包含的是转移的位移，无论s处的指令的实际地址是多少，loop指令转移的相对位移是不变的。</li></ul><p>这样的设计 ，方便了程序段在内存中的浮动装配</p><h3 id="call指令和ret指令"><a href="#call指令和ret指令" class="headerlink" title="call指令和ret指令"></a>call指令和ret指令</h3><ul><li>调用子程序：call程序</li><li>返回：ret指令</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 0</span><br><span class="line">call s</span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">s:add ax, 1</span><br><span class="line">ret</span><br></pre></td></tr></table></figure><p>实质：流程转移指令，它们都修改IP，或同时修改CS和IP</p><p>格式：<code>all 标号</code></p><p>CPU执行call指令，进行两步操作</p><ol><li><p>将当前的IP或CS和IP压入栈中</p><p>(sp) &#x3D; (sp)-2</p><p>((ss)*16+(sp)) &#x3D; (IP)</p></li><li><p>转移到标号处执行指令</p><p>(IP) &#x3D; (IP) + 16位位移</p></li></ol><p>相当于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push IP</span><br><span class="line">jmp near ptr 标号</span><br></pre></td></tr></table></figure><p>指令<code>call far ptr 标号</code>，实现的是段间转移</p><p>CPU执行”call far ptr 标号”时的操作：</p><ol><li><p>(sp) &#x3D; (sp) - 2</p><p>((ss)*16+(sp)) &#x3D; (CS)</p><p>(sp) &#x3D; (sp) - 2</p><p>((ss)*16+(sp)) &#x3D; (IP)</p></li><li><p>(CS) &#x3D; 标号所在的段地址 </p><p>(IP) &#x3D; 标号所在的偏移地址</p></li></ol><p>相当于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">push CS</span><br><span class="line">push IP</span><br><span class="line">jmp far ptr 标号</span><br></pre></td></tr></table></figure><p>还有<code>call 寄存器</code>、<code>call word ptr 内存单元</code>、<code>call dword ptr 内存单元</code>等</p><p>返回指令ret和retf：</p><table><thead><tr><th></th><th>ret指令</th><th>retf指令</th></tr></thead><tbody><tr><td>功能</td><td>用栈的数据，修改IP的内容</td><td>用栈的数据，修改IP的内容以及CS的内容</td></tr><tr><td>相当于</td><td>pop IP</td><td>pop IP<br>pop CS</td></tr></tbody></table><p>call和ret配合使用：</p><p>例子：计算2的N次方，计算前，N由CX提供</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ss:stack</span><br><span class="line">stack segment</span><br><span class="line">db 16 dup(0)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, stack</span><br><span class="line">mov ss, ax</span><br><span class="line">mov sp, 16</span><br><span class="line"></span><br><span class="line">mov ax, 1</span><br><span class="line">mov cx, 10</span><br><span class="line">call s</span><br><span class="line">mov bx, ax</span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">s:add ax, ax</span><br><span class="line">loop s</span><br><span class="line">ret</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="mul指令"><a href="#mul指令" class="headerlink" title="mul指令"></a>mul指令</h3><p>格式：<code>mul 寄存器</code>或<code>mul 内存单元</code></p><table><thead><tr><th></th><th>8位乘法</th><th>16位乘法</th></tr></thead><tbody><tr><td>被乘数(默认)</td><td>AL</td><td>AX</td></tr><tr><td>乘数</td><td>8位寄存器或内存字节单元</td><td>16位寄存器或内存字单元</td></tr><tr><td>结果</td><td>AX</td><td>DX(高位) + AX(低位)</td></tr><tr><td>例子</td><td>mul bl<br><code>(ax) = (al)*(bl)</code><br><br>mul byte ptr ds:[0]<br><code>(ax) = (al)*((ds)*16+0)</code></td><td>mul word ptr [bx+si+8]<br/><code>(ax) = (ax)*16+((ds)*16+(bx)+(si)+8)</code>结果的低16位<br/><code>(dx) = (ax)*16+((ds)*16+(bx)+(si)+8)</code>结果的高16位</td></tr></tbody></table><p>举例：</p><p>计算100*10</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov al, 100</span><br><span class="line">mov bl, 10</span><br><span class="line">mov bl</span><br><span class="line">;结果在ax中</span><br></pre></td></tr></table></figure><p>计算100*10000</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 10000</span><br><span class="line">mov bx, 100</span><br><span class="line">mul bx</span><br><span class="line">;结果在dx和ax中</span><br><span class="line">;(dx)=000FH,(ax)=4240H</span><br><span class="line">;即，F4240H=1000000</span><br></pre></td></tr></table></figure><h3 id="模块化程序设计"><a href="#模块化程序设计" class="headerlink" title="模块化程序设计"></a>模块化程序设计</h3><p>用寄存器传递参数</p><p>编程任务：计算data段中第一组数据的3次方，结果保存在后面一组dword单元中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">data segment</span><br><span class="line">dw 1,2,3,4,5,6,7,8</span><br><span class="line">dd 0,0,0,0,0,0,0,0</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov si, 0</span><br><span class="line">mov di, 16</span><br><span class="line"></span><br><span class="line">mov cx, 8</span><br><span class="line">s:mov bx, [si]</span><br><span class="line">call cube</span><br><span class="line">mov [di], ax</span><br><span class="line">mov [di].2, dx</span><br><span class="line">add si, 2</span><br><span class="line">add di, 4</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">cube:</span><br><span class="line">mov ax, bx</span><br><span class="line">mul bx</span><br><span class="line">mul bx</span><br><span class="line">ret</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>如果传递的数据有3个及其以上，寄存器不够怎么办？</p><p>用内存单元批量传递参数</p><p>例子：将data段中的字符串转为大写</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">data segment</span><br><span class="line">db &#x27;conversation&#x27;</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov si, 0</span><br><span class="line">mov cx, 12</span><br><span class="line">call capital</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">capital:</span><br><span class="line">and byte ptr [si], 11011111B</span><br><span class="line">inc si</span><br><span class="line">loop capital</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>用栈传递参数</p><p>例子：计算(a-b)^3，a、b为字类型</p><ul><li>进入子程序前，参数a、b入栈</li><li>调用子程序，将使栈顶存放IP</li></ul><p>设，a&#x3D;3，b&#x3D;1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, 1</span><br><span class="line">push ax</span><br><span class="line">mov ax, 3</span><br><span class="line">push ax</span><br><span class="line">call difcube</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">difcube:</span><br><span class="line">push bp</span><br><span class="line">mov bp, sp</span><br><span class="line">mov ax, [bp+4]</span><br><span class="line">sub ax, [bp+6]</span><br><span class="line">mov bp, ax</span><br><span class="line">mul bp</span><br><span class="line">mul bp</span><br><span class="line">;计算结果在dx和ax中</span><br><span class="line">pop bp</span><br><span class="line">ret 4;指令ret n的含义 pop ip  add sp, n</span><br><span class="line">code ends</span><br><span class="line">ends start</span><br></pre></td></tr></table></figure><h3 id="寄存器冲突问题"><a href="#寄存器冲突问题" class="headerlink" title="寄存器冲突问题"></a>寄存器冲突问题</h3><p>编程：将data段中的字符串转化为大写</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">data segment</span><br><span class="line">db &#x27;conversation&#x27;,0</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov si, 0</span><br><span class="line">call capital</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">capital:</span><br><span class="line">mov ch, 0</span><br><span class="line">mov cl, [si]        </span><br><span class="line">jcxz ok;如果cx为0，则跳转到ret</span><br><span class="line">and byte ptr [si], 11011111B</span><br><span class="line">inc si</span><br><span class="line">jmp short capital</span><br><span class="line">ok:ret</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>子程序标准框架：</p><blockquote><p>子程序开始：子程序中使用的寄存器入栈</p><p>​子程序内容</p><p>​子程序使用的寄存器出栈</p><p>​返回(ret、retf)</p></blockquote><p>编程：将data段中的多个字符串转化为大写</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">data segment</span><br><span class="line">db &#x27;word&#x27;,0</span><br><span class="line">db &#x27;unix&#x27;,0</span><br><span class="line">db &#x27;wind&#x27;,0</span><br><span class="line">db &#x27;good&#x27;,0</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov si, 0</span><br><span class="line">mov cx, 4</span><br><span class="line"></span><br><span class="line">s:call capital</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">capital:</span><br><span class="line">push cx</span><br><span class="line">push si</span><br><span class="line">change:</span><br><span class="line">mov ch, 0</span><br><span class="line">mov cl, [si]</span><br><span class="line">jcxz ok;如果cx为0，则跳转到ret</span><br><span class="line">and byte ptr [si], 11011111B</span><br><span class="line">inc si</span><br><span class="line">jmp short change</span><br><span class="line">ok:pop si</span><br><span class="line">pop cx</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="标志寄存器"><a href="#标志寄存器" class="headerlink" title="标志寄存器"></a>标志寄存器</h3><p>标志寄存器的结构</p><ul><li><p>flag寄存器是按位起作用的，也就是说，它的每一位都有专门的含义，记录特定的信息。</p></li><li><p>8086CPU中没有使用flag的1、3、5. 12、13、14、15位，这些位不具有任何含义。</p></li><li><p>标志寄存器的作用</p></li><li><p>用来存储相关指令的某些执行结果</p></li><li><p>用来为CPU执行相关指令提供行为依据</p></li><li><p>用来控制CPU的相关工作方式</p></li></ul><p>直接访问标志寄存器的方法</p><ul><li><code>pushf</code>：将标志寄存器的值压栈</li><li><code>popf</code>：从栈中弹出数据，送入标志寄存器中</li></ul><table><thead><tr><th></th><th>标志</th><th>值为1</th><th>值为0</th><th>意义</th></tr></thead><tbody><tr><td>Overflow</td><td>OF</td><td>OV</td><td>NV</td><td>溢出</td></tr><tr><td>Direction</td><td>DF</td><td>DN</td><td>UP</td><td>方向</td></tr><tr><td>Sign</td><td>SF</td><td>NG</td><td>PL</td><td>符号</td></tr><tr><td>Zero</td><td>ZF</td><td>ZR</td><td>NZ</td><td>零值</td></tr><tr><td>Parity</td><td>PF</td><td>PE</td><td>PO</td><td>奇偶</td></tr><tr><td>Carry</td><td>CF</td><td>CY</td><td>NC</td><td>进位</td></tr></tbody></table><p>零标志：</p><p>ZF标记相关指令的计算结果是否为0</p><ul><li>ZF&#x3D;1，表示结果是0，1表示逻辑真</li><li>ZF&#x3D;0，表示结果不是0，0表示逻辑假</li></ul><p>示例：</p><table><thead><tr><th>指令</th><th>执行结果</th></tr></thead><tbody><tr><td>mov  ax, 1<br>add ax, 0</td><td>ZF&#x3D;0，表示结果是0</td></tr><tr><td>mov ax, 1<br>or ax, 0</td><td>ZF&#x3D;1，表示结果不是0</td></tr></tbody></table><p>在8086CPU的指令集中，有的指令的执行是影响标志寄存器的，比如：add、sub、mul、div、inc、or、and等，它们大都是运算指令，进行逻辑或算术运算；</p><p>有的指令的执行对标志寄存器没有影响，比如：mov、push、pop等，它们大都是传送指令。</p><p>使用一条指令的时候，要注意这条指令的全部功能，其中包括执行结果对标记寄存器的哪些标志位选成影响。</p><p>奇偶标志：</p><p>PF记录指今执行后，结果的所有二进制位中1的个数：</p><ul><li>1的个数为偶数，PF&#x3D;1</li><li>1的个数为奇数，PF&#x3D;0</li></ul><table><thead><tr><th>指令</th><th>执行结果</th></tr></thead><tbody><tr><td>mov al, 1<br>add al, 10</td><td>结果为0000 1011B &#x3D; 0000 0001B + 0000 1010B<br>其中有3(奇数)个1，则PF&#x3D;0；</td></tr><tr><td>mov al, 1<br>or al, 2</td><td>结果为00000011B &#x3D; 0000 0001B or 0000 0010B<br>其中有2(偶数)个1，则PF&#x3D;1；</td></tr></tbody></table><p>符号标志：</p><p>SF记录指令执行后，将结果视为有符号数</p><ul><li><p>结果为負，SF&#x3D;1</p></li><li><p>结果为非负，SF &#x3D; 0</p></li></ul><p>示例：</p><table><thead><tr><th>指令</th><th>执行结果</th></tr></thead><tbody><tr><td>mov  al, 10000001B<br>add al, 1</td><td>结果ax为10000010B，为负数，则SF&#x3D;1</td></tr><tr><td>sub ax, ax</td><td>结果ax为0，为非负数，故SF&#x3D;0</td></tr></tbody></table><p>进位标志：</p><p>在进行无符号数运算的时候，CF记录了运算结果的最高有效位向更高位的进位值，或从更高位的借位值。</p><p>CF记录指令执行后：</p><ul><li>有进位或借位，CF&#x3D;1</li><li>无进位或借位，CF&#x3D;0</li></ul><p>示例：</p><table><thead><tr><th>指令</th><th>执行结果</th></tr></thead><tbody><tr><td>mov al, 98H<br>add al, al</td><td>(al)&#x3D;30H，CF&#x3D;1，CF记录了最高有效位向更高位进位值</td></tr><tr><td>add al, al</td><td>(al)&#x3D;60H，CF&#x3D;0，CF记录了最高有效向更高位的进位值</td></tr><tr><td>sub al, 98H</td><td>(al)&#x3D;C8H，CF&#x3D;1，CF记录了向更高位的借位值</td></tr></tbody></table><p>溢出标志：</p><p>在进行有符号数运算的时候，如结果超过了机器所能表示的范国称为溢出</p><p>OF记录有符号数操作指令执行后，</p><ul><li>有溢出，OF&#x3D;1</li><li>无溢出，OF&#x3D;0</li></ul><p>示例：</p><table><thead><tr><th>指令</th><th>执行结果</th></tr></thead><tbody><tr><td>mov al, 98<br>add al, 99</td><td>(al) &#x3D; 197，超出了8位有符号数的范围(-128~127)，OF&#x3D;1</td></tr><tr><td>mov al, 0F0H<br>add al,88H</td><td>(al) &#x3D; (-16)+(-120) &#x3D; -136，有溢出，OF&#x3D;1</td></tr></tbody></table><p>CF和OF的区别：</p><ul><li><p>CF是对无符号数运算有意义的进&#x2F; 借位标志位</p></li><li><p>OF是对有符号数运算有意义的溢出标志位</p></li></ul><p>应用：</p><table><thead><tr><th>指令</th><th>执行结果</th></tr></thead><tbody><tr><td>mov al, 0F0H<br>add al, 88H</td><td>CF&#x3D;1，OF&#x3D;1，当无符号数运算有进位，当有符号数运算有溢出</td></tr></tbody></table><p>综合：一条指令会带来多个寄存器的变化</p><table><thead><tr><th>指令</th><th>CF</th><th>OF</th><th>SF</th><th>ZF</th><th>PF</th></tr></thead><tbody><tr><td>sub al, al</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>mov al, 10h</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>add al, 90h</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>mov al, 80h</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>add al, 80h</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>mov al, 0FCh</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>add al, 05h</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>mov al, 7Dh</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>add al, 0Bh</td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><h3 id="带进-借-位的加减法"><a href="#带进-借-位的加减法" class="headerlink" title="带进(借)位的加减法"></a>带进(借)位的加减法</h3><p>adc带进位加法指令，它利用了CF位上记录的进位值</p><ul><li>格式：<code>adc 操作对象1, 操作对象2</code></li><li>功能：操作对象1-操作对象1+操作对象2+CF&amp;#x20;</li><li>例：<code>adc ax,bx</code> 实现的功能是：(ax)&#x3D;(ax)+(bx)+CF</li></ul><table><thead><tr><th align="left">指令</th><th align="left">mov al, 98H<br>add al, al<br>adc al, 3</th><th align="left">mov ax, 1<br>add ax, ax<br>adc ax, 3</th><th align="left">mov ax, 2<br>mov bx, 1<br>sub bx, ax<br>adc ax, 1</th></tr></thead><tbody><tr><td align="left">结果</td><td align="left">(ax)&#x3D;34H</td><td align="left">(ax)&#x3D;5</td><td align="left">(ax)&#x3D;4</td></tr><tr><td align="left">解释</td><td align="left">adc执行时，相当于计算：<br>(ax)+3&#x3D;CF&#x3D;30H+3+1&#x3D;34H</td><td align="left">adc执行时，相当于计算：<br>(ax)+3+CF&#x3D;2+3+0&#x3D;5</td><td align="left">adc执行时，相当于计算：<br>(ax)+1+CF&#x3D;2+1+1&#x3D;4</td></tr></tbody></table><p>大数相加</p><p>问题：8086指令提供add指令 ，完成8位或16位如法，有更大的数相加时，如何做？</p><p>例子：编程计算1EF000H+201000H，结果放在ax(高16位)和bx(低16位)中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 001EH.   ;存放高16位</span><br><span class="line">mov bx, 0F000H;存放低16位</span><br><span class="line">add bx, 1000H;将低16位相加</span><br><span class="line">adc ax, 0020H;将高16位相加，以及进位1</span><br></pre></td></tr></table></figure><p>例子：编程计算1E F000 1000H+20 1000 1EF0H，结果放在ax(高16位)、bx(次高16位)、cx(低16位)中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mov cx, 1000H</span><br><span class="line">add cx, 1EF0H</span><br><span class="line"></span><br><span class="line">mov bx, 0F000H</span><br><span class="line">adc bx, 1000H</span><br><span class="line"></span><br><span class="line">mov ax, 001EH</span><br><span class="line">adc ax, 0020H</span><br></pre></td></tr></table></figure><p>问题：编写一个子程序，对两个128位数据进行相加。&amp;#x20;</p><ul><li>名称：add128&amp;#x20;</li><li>功能：两个逆序存放的128位数据进行相加</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov si, 0</span><br><span class="line">mov di, 16</span><br><span class="line">mov cx, 8</span><br><span class="line">call add128</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">add128:</span><br><span class="line">push ax</span><br><span class="line">push cx</span><br><span class="line">push si</span><br><span class="line">push di</span><br><span class="line">s:</span><br><span class="line">sub ax, ax</span><br><span class="line">mov ax, [si]</span><br><span class="line">adc ax, [di]</span><br><span class="line">mov [si], ax</span><br><span class="line">inc si</span><br><span class="line">inc si</span><br><span class="line">inc di</span><br><span class="line">inc di</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">pop di</span><br><span class="line">pop si</span><br><span class="line">pop cx</span><br><span class="line">pop ax</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>sub ax, ax是否可替换为mov ax, 0，或者是否可以不用写？</p><ul><li>sub ax, ax可以将CF置为0</li></ul><p>两个inc di是否可替换为add di, 2</p><ul><li>inc不会导致CF的值变化，add可能会导致进位，使CF变为1</li></ul><p>sbb指令</p><p>sbb：带借位减法指令</p><ul><li>格式：sbb 操作对象1, 操作对象2</li><li>功能： 操作对象1&#x3D;操作对象1-操作对象2-CF</li><li>与sub区别：利用CF位上记录的借位值&amp;#x20;</li><li>比如：<code>sbb ax, bx</code></li><li>实现功能：(ax)&#x3D;(ax)-(bx)-CF</li><li>应用：对任意大的数据进行减法运算&amp;#x20;</li></ul><p>例如：计算003E 1000H-0020 2000H结果放在ax，bx中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov bx, 1000H</span><br><span class="line">mov ax, 003EH</span><br><span class="line"></span><br><span class="line">sub bx, 2000H</span><br><span class="line">sbb ax, 0020H</span><br></pre></td></tr></table></figure><h3 id="cmp和条件转移指令"><a href="#cmp和条件转移指令" class="headerlink" title="cmp和条件转移指令"></a>cmp和条件转移指令</h3><p>cmp指令</p><ul><li>格式：<code>cmp操作对象1,操作对象2</code></li><li>功能：计算操作对象1-操作对象2&amp;#x20;</li><li>cmp 是比较指令，功能相当于减法指令，只是不保存结果</li><li>cmp 指令执行后，将对标志寄存器产生影响。</li></ul><table><thead><tr><th align="left">指令</th><th align="left">cmp ax, ax</th><th align="left">mov ax, 8<br>mov bx, 3<br>cmp ax, bx</th></tr></thead><tbody><tr><td align="left">功能</td><td align="left">做(ax)-(ax)的运算，结果为0，但并不在ax中保存 ，仅影响flag的相关各位。</td><td align="left">(ax)&#x3D;8,(bx)&#x3D;3</td></tr><tr><td align="left">标志寄存器</td><td align="left">ZF&#x3D;1,PF&#x3D;1,SF&#x3D;0,CF&#x3D;0,OF&#x3D;0</td><td align="left">ZF&#x3D;0,PF&#x3D;1,SF&#x3D;0,CF&#x3D;0,OF&#x3D;0</td></tr></tbody></table><p>指令：cmp ax, bx</p><table><thead><tr><th align="left">比较关系</th><th align="left">(ax)?(bx)</th><th align="left">(ax)-(bx)特点</th><th align="left">标志寄存器</th></tr></thead><tbody><tr><td align="left">等于</td><td align="left">(ax)&#x3D;(bx)</td><td align="left">0</td><td align="left">ZF&#x3D;1</td></tr><tr><td align="left">不等于</td><td align="left">(ax)!&#x3D;(bx)</td><td align="left">!&#x3D;0</td><td align="left">ZF&#x3D;0</td></tr><tr><td align="left">小于</td><td align="left">(ax)&lt;(bx)</td><td align="left">将产生借位</td><td align="left">CF&#x3D;1</td></tr><tr><td align="left">大于等于</td><td align="left">(ax)&gt;&#x3D;(bx)</td><td align="left">不必借位</td><td align="left">CF&#x3D;0</td></tr><tr><td align="left">大于</td><td align="left">(ax)&gt;(bx)</td><td align="left">既不用借位，结果不为0</td><td align="left">CF&#x3D;0且ZF&#x3D;0</td></tr><tr><td align="left">小于等于</td><td align="left">(ax)&lt;&#x3D;(bx)</td><td align="left">或者借位，或者结果为0</td><td align="left">CF&#x3D;1或ZF&#x3D;1</td></tr></tbody></table><p>条件转移指令&amp;#x20;</p><p>根据单个标志位转移的指令：</p><table><thead><tr><th align="left">指令</th><th align="left">含义</th><th align="left">测试条件</th></tr></thead><tbody><tr><td align="left">je&#x2F;jz</td><td align="left">相等&#x2F;结果为0</td><td align="left">ZF&#x3D;1</td></tr><tr><td align="left">jne&#x2F;jnz</td><td align="left">不等&#x2F;结果不为0</td><td align="left">ZF&#x3D;0</td></tr><tr><td align="left">js</td><td align="left">结果为负</td><td align="left">SF&#x3D;1</td></tr><tr><td align="left">jns</td><td align="left">结果非负</td><td align="left">SF&#x3D;0</td></tr><tr><td align="left">jo</td><td align="left">结果溢出</td><td align="left">OF&#x3D;1</td></tr><tr><td align="left">jno</td><td align="left">结果溢出</td><td align="left">OF&#x3D;0</td></tr><tr><td align="left">jp</td><td align="left">奇偶位为1</td><td align="left">PF&#x3D;1</td></tr><tr><td align="left">jnp</td><td align="left">奇偶位不为1</td><td align="left">PF&#x3D;0</td></tr><tr><td align="left">jb&#x2F;jnae&#x2F;jc</td><td align="left">低于&#x2F;不高于等于&#x2F;有借位</td><td align="left">CF&#x3D;1</td></tr><tr><td align="left">jnb&#x2F;jae&#x2F;jnc</td><td align="left">不低于&#x2F;高于等于&#x2F;无借位</td><td align="left">CF&#x3D;0</td></tr></tbody></table><p>根据无符号数比较结果进行转移的指令：</p><table><thead><tr><th align="left">指令</th><th align="left">含义</th><th align="left">测试条件</th></tr></thead><tbody><tr><td align="left">jb&#x2F;jnae&#x2F;jc</td><td align="left">低于则转移</td><td align="left">CF&#x3D;1</td></tr><tr><td align="left">jnb&#x2F;jae&#x2F;jnc</td><td align="left">不低于则转移</td><td align="left">CF&#x3D;0</td></tr><tr><td align="left">jna&#x2F;jbe</td><td align="left">不高于则转移</td><td align="left">CF&#x3D;1或ZF&#x3D;1</td></tr><tr><td align="left">ja&#x2F;jnbe</td><td align="left">高于则转移</td><td align="left">CF&#x3D;0且ZF&#x3D;0</td></tr></tbody></table><p>根据有符号数比较结果进行转移的指令：</p><table><thead><tr><th>指令</th><th>含义</th><th>测试条件</th></tr></thead><tbody><tr><td>jl&#x2F;jnge</td><td>小于则转移</td><td>SF&#x3D;1且OF&#x3D;0</td></tr><tr><td>jnl&#x2F;jge</td><td>不小于转移</td><td>SF&#x3D;0且OF&#x3D;0</td></tr><tr><td>jle&#x2F;jng</td><td>小于等于转移</td><td>SF&#x3D;0或OF&#x3D;1</td></tr><tr><td>jnle&#x2F;jg</td><td>不小于等于则转移</td><td>SF&#x3D;1且OF&#x3D;1</td></tr></tbody></table><p>参数说明：</p><ul><li><p>j-Jmup；e-Equal；n-Not；b-Below；a-Above；L-less；</p><p>g-Greater；s-Sign；c-carry；p-Parity；o-overflow；z-Zero</p></li></ul><p>条件转移指令的使用</p><p>jxxx系列指令和cmp指令配合，构造条件转移指令</p><ul><li><p>不必再考虑cmp指令对相关标志位的影响和jxxx指令对相关标志位的检测</p></li><li><p>可以直接考處arap和alua看令配合使用时表现出来的迎租合义。</p></li></ul><p>jxxx系列指令和cmp指令配合实现高级语言中if语句的功能</p><p>例如：如果(ah)&#x3D;(bh)，则(ah)&#x3D;(ah)+(ah)，否则(ah)&#x3D;(ah)+(bh)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cmp ah, bh</span><br><span class="line">je s</span><br><span class="line">add ah, bh</span><br><span class="line">jmp short ok</span><br><span class="line">s:add ah, ah</span><br><span class="line">ok:ret</span><br></pre></td></tr></table></figure><p>等价于C：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(a == b)&#123;</span><br><span class="line">a += a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">a += b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>例如：如果(ax)&#x3D;0，则(ax)&#x3D;(ax)+1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add ax, 0</span><br><span class="line">jnz s</span><br><span class="line">inc ax</span><br><span class="line">s:ret</span><br></pre></td></tr></table></figure><p>等价于C：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(a == <span class="number">0</span>)&#123;</span><br><span class="line">a++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="条件转移指令应用"><a href="#条件转移指令应用" class="headerlink" title="条件转移指令应用"></a>条件转移指令应用</h3><p>请编程实现如下统计，用ax保存统计结果</p><ol><li>统计数值为8的字节的个数</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data</span><br><span class="line">data segment</span><br><span class="line">db8,11,8,1,8,5,63,38</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov ax, 0</span><br><span class="line">mov bx, 0</span><br><span class="line">mov cx, 8</span><br><span class="line"></span><br><span class="line">s:cmp byte ptr [bx], 8</span><br><span class="line">jne next;不为0，ze</span><br><span class="line">inc ax</span><br><span class="line">next:</span><br><span class="line">inc bx</span><br><span class="line">loop s</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="DF标志和串传送指令"><a href="#DF标志和串传送指令" class="headerlink" title="DF标志和串传送指令"></a>DF标志和串传送指令</h3><p>编程：将data段中的第一个字符串复制到它后面的空间中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data </span><br><span class="line">data segment</span><br><span class="line">db &#x27;Welcome to masm!&#x27;</span><br><span class="line">db 16 dup(0)</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov si, 0</span><br><span class="line">mov di, 16</span><br><span class="line">mov cx, 8</span><br><span class="line"></span><br><span class="line">S:mov ax, [si]</span><br><span class="line">mov [di], ax</span><br><span class="line">add si, 2</span><br><span class="line">add di, 2</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>DF：方向标志位</p><ul><li>功能<ul><li>在串处理指令中，控制每次操作后si、di的增减</li><li>DF&#x3D;0：每次操作后si，di递增</li><li>DF&#x3D;1：每次操作后si，di递减</li></ul></li><li>对DF位进行设置的指令：<ul><li>cld指令：将标志寄存器的DF位设为0(clear)</li><li>std指令：将标志寄存器的DF位设为1(setup)</li></ul></li></ul><p>串传送指令1：morsb</p><blockquote><p>功能：(以字节为单位传送)</p><ol><li><p><code>((es)*16+(di)) = ((ds)*16+(si))</code></p></li><li><p>如果DF&#x3D;0则：(si)&#x3D;(si)+1</p><p>​(di)&#x3D;(di)+1</p><p>如果DF&#x3D;1则：(si)&#x3D;(si)-1</p><p>​                        (di)&#x3D;(di)-1</p></li></ol></blockquote><p>串传送指令2：movsw</p><blockquote><p>功能：(以字为单位传送)</p><ol><li><p><code>((es)*16+(di))=((ds)*16+(si)</code></p></li><li><p>如果DF&#x3D;0则：(si)&#x3D;(si)+2</p><p>​(di)&#x3D;(di)+2</p><p>如果DF&#x3D;1则：(si)&#x3D;(si)-2</p><p>​(di)&#x3D;(di)-2</p></li></ol></blockquote><p>编程：将data段中的第一个字符串复制到它后面的空间中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data </span><br><span class="line">data segment</span><br><span class="line">db &#x27;Welcome to masm!&#x27;</span><br><span class="line">db 16 dup(0)</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov es, ax</span><br><span class="line">mov si, 0</span><br><span class="line">mov di, 16</span><br><span class="line">mov cx, 8</span><br><span class="line">cld</span><br><span class="line"></span><br><span class="line">S:movsw</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>rep指令</p><ul><li><p>rep指令常和串传送指令配合使用</p></li><li><p>功能：根据cx的值，重复执行后面的指令</p></li><li><p>用法：<code>rep movsb</code>等价于<code>s: movsb  loop s</code></p><p>​           <code>rep movsw</code>等价于<code>s: movsw  loop s</code></p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data </span><br><span class="line">data segment</span><br><span class="line">db &#x27;Welcome to masm!&#x27;</span><br><span class="line">db 16 dup(0)</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov es, ax</span><br><span class="line">mov si, 0</span><br><span class="line">mov di, 16</span><br><span class="line">mov cx, 8</span><br><span class="line">cld</span><br><span class="line">rep movsw</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>实例：用串传送指令，将F000H段中的最后的16给字符复制到data段中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data</span><br><span class="line">data segment</span><br><span class="line">db 16 dup(0)</span><br><span class="line">data ends</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov es, ax</span><br><span class="line">mov ax, 0F000H</span><br><span class="line">mov ds, ax</span><br><span class="line"></span><br><span class="line">mov di, 15;数据段的最后一个字符的位置为16</span><br><span class="line">mov si, 0FFFFH;F000H段最后一个字符的位置为F000:FFFF</span><br><span class="line"></span><br><span class="line">mov cx, 16</span><br><span class="line">std;设置为递减(-1)</span><br><span class="line">ref movsb</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">    int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="5-中断及其应用"><a href="#5-中断及其应用" class="headerlink" title="5.中断及其应用"></a>5.中断及其应用</h2><h3 id="移位指令"><a href="#移位指令" class="headerlink" title="移位指令"></a>移位指令</h3><blockquote><p>逻辑左移：<code>SHL OPR, CNT</code></p><p>逻辑右移：<code>SHR OPR, CNT</code></p><p>循环左移：<code>ROL OPR, CNT</code></p><p>循环右移：<code>ROR OPR, CNT</code></p><p>算数左移：<code>SAL OPR, CNT</code></p><p>算数右移：<code>SAR OPR, CNT</code></p><p>带进位循环左移：<code>RCL OPR, CNT</code></p><p>带进位循环右移：<code>RCR OPR, CNT</code></p><p>注意：S,SH-Shit；L-Left；R-Right；R,Ro-Rotate；C-Carry</p></blockquote><p><code>SHL OPR, CNT</code>，将OPR逻辑左移CNT位</p><ol><li>将寄存器或内存单元中的数据向左移位</li><li>将最后移出的一位写入CF中</li><li>最低位用0补充</li></ol><p>shl指令操作示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov al, 01010001B</span><br><span class="line">mov cl, 3;移动位数大于1时，必须要使用cl来存放移动位数</span><br><span class="line">shl al, cl</span><br><span class="line">;结果(al)=10100010B</span><br><span class="line">;CF=0</span><br></pre></td></tr></table></figure><p>常用方法：</p><ul><li><p>将X逻辑左移一位，相当于执行X&#x3D;X*2</p></li><li><p>将X逻辑右移一位，相当于执行X&#x3D;X&#x2F;2</p></li></ul><h3 id="操作显存数据"><a href="#操作显存数据" class="headerlink" title="操作显存数据"></a>操作显存数据</h3><p>屏幕上的内容&#x3D;显存数据</p><p>其中，B8000h~BFFFFh，共32K的空间，是80*25 彩色字符模式第0页的显示缓冲区。</p><p>显示缓冲区的结构</p><table><thead><tr><th>行数</th><th>各行所需字节数</th><th>显示缓冲区地址范围</th></tr></thead><tbody><tr><td>0</td><td>160(A0H)</td><td>B800:0000~B800:009F</td></tr><tr><td>1</td><td>160(A0H)</td><td>B800:0000~B800:013F</td></tr><tr><td>…</td><td>…</td><td>…</td></tr><tr><td>24</td><td>160(A0H)</td><td>B800:0F00~B800:0F9F</td></tr></tbody></table><p>要显示的每个字符所要占2个字节</p><ul><li><p>低字节位：要显示符号的ASCII</p></li><li><p>高字节位：显示属性字节</p><table><thead><tr><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>0</th></tr></thead><tbody><tr><td>BL</td><td>R</td><td>G</td><td>B</td><td>I</td><td>R</td><td>G</td><td>B</td></tr><tr><td>闪烁</td><td>背景</td><td>背景</td><td>背景</td><td>高亮</td><td>前景</td><td>前景</td><td>前景</td></tr></tbody></table></li></ul><p>显示信息最<strong>直接</strong>的方式：</p><p>例子：在屏幕中间显示一段语句，白底蓝字</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data</span><br><span class="line">data segment</span><br><span class="line">db &#x27;Welcome to masm!&#x27;</span><br><span class="line">data ends</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov ax, 0B800H</span><br><span class="line">mov es, ax;设定显存的段地址</span><br><span class="line">mov si, 0</span><br><span class="line">mov di, 160*12+80-16;指定显示的地址为屏幕正中间</span><br><span class="line"></span><br><span class="line">mov cx, 16;设置循环次数</span><br><span class="line">s:mov al, [si]</span><br><span class="line">mov es:[di], al;ACSII</span><br><span class="line"></span><br><span class="line">inc di</span><br><span class="line">mov al, 71H</span><br><span class="line">mov es:[di], al;显示属性</span><br><span class="line">inc di</span><br><span class="line">inc si</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="描述内存单元的标号"><a href="#描述内存单元的标号" class="headerlink" title="描述内存单元的标号"></a>描述内存单元的标号</h3><p>代码段中的标号可以用来标记指令、段的起始地址</p><p>代码段中的数据也可以用标号</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">a: db 1,2,3,4,5,6,7,8</span><br><span class="line">b: dw 0</span><br><span class="line">start:</span><br><span class="line">mov si, offset a</span><br><span class="line">mov bx, offset b</span><br><span class="line"></span><br><span class="line">mov cx, 8</span><br><span class="line">s:mov al, cs:[si]</span><br><span class="line">mov ah, 0</span><br><span class="line">add cs:[bx], ax</span><br><span class="line">inc si</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>去冒号的<strong>数据标号</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">a db 1,2,3,4,5,6,7,8;a代表地址为code:0，长度为字节的内存单元</span><br><span class="line">b dw 0;b代表地址为code:8，长度为字的内存单元</span><br><span class="line">start:</span><br><span class="line">mov al, a[si];等价于mov al, cs:0[si]</span><br><span class="line">mov al, a[3];等价于mov al, cs:0[3]</span><br><span class="line">mov al, a[bx+si+3];等价于mov al, cs:0[bx+si+3]</span><br><span class="line"></span><br><span class="line">mov ax, b;等价于mov ax, cs:[8]</span><br><span class="line">mov b, 2;等价于mov word ptr cs:[8], 2</span><br><span class="line">inc b;等价于inc word ptr cs:[8]</span><br><span class="line">;mov al, b;报错</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>在code 段中使用的标号a、b后面没有”:”，它们同时描述内存地址和单元长度的标号。</p><ul><li>标号a<ul><li>地址code:0</li><li>以后的内存单元都是字节</li></ul></li><li>标号b<ul><li>地址code:8</li><li>以后的内存单元都是字</li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data</span><br><span class="line">data segment</span><br><span class="line">a db 1,2,3,4,5,6,7,8</span><br><span class="line">b dw 0</span><br><span class="line">data ends</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov si, 0</span><br><span class="line"></span><br><span class="line">mov cx, 8</span><br><span class="line">s:mov al, a[si]</span><br><span class="line">mov ah, 0</span><br><span class="line">mov b, ax</span><br><span class="line">inc si</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>扩展用法：将标号当作数据来定义</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data segment</span><br><span class="line">a db 1,2,3,4,5,6,7,8</span><br><span class="line">b dw 0</span><br><span class="line">c dw a,b;存放每段数据的起始地址(指针数组)</span><br><span class="line">;等价于c dw offset a, offset b</span><br><span class="line">data ends</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data segment</span><br><span class="line">a db 1,2,3,4,5,6,7,8</span><br><span class="line">b dw 0</span><br><span class="line">c dd a,b;存放每段数据的起始地址(指针数组)</span><br><span class="line">;等价于c dw offset a, seg a, offset b, seg b (seg操作符：取段地址)</span><br><span class="line">data ends</span><br></pre></td></tr></table></figure><h3 id="数据的直接定址表"><a href="#数据的直接定址表" class="headerlink" title="数据的直接定址表"></a>数据的直接定址表</h3><p>问题：以十六进制的形式在屏幕中间显示给定的byte型数据</p><p>分析：先将一个byte的高4位和低4位分开，显示对应的数码字符</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov al, 2Bh;00101100b</span><br><span class="line">call showbyte</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">showbyte:</span><br><span class="line">jmp short show</span><br><span class="line">table db &#x27;0123456789ABCDEF&#x27;;字符表</span><br><span class="line">show:</span><br><span class="line">push bx</span><br><span class="line">push es</span><br><span class="line">push cx</span><br><span class="line"></span><br><span class="line">mov ah, al</span><br><span class="line">mov cl, 4</span><br><span class="line">shr ah, cl;右移4位，得到2Bh的高4位 00000010b=2h</span><br><span class="line">and al, 00001111B;and运算，得到2Bh的低4位 00001100b=Bh</span><br><span class="line">;用高4位的值(ah)作为相对于table的偏移，取得对应的字符并显示</span><br><span class="line">mov bl, ah</span><br><span class="line">mov bh, 0;(bx)=2h</span><br><span class="line">mov ah, table[bx];(ah)存放的&#x27;2&#x27;</span><br><span class="line">mov bx, 0B800h</span><br><span class="line">mov es, bx;显存的段地址</span><br><span class="line">mov es:[160*12+40*2], ah</span><br><span class="line">;用低4位的值(al)作为相对于table的偏移，取得对应的字符</span><br><span class="line">mov bl, al</span><br><span class="line">mov bh, 0;(bx)=Bh</span><br><span class="line">mov al, table[bx];(al)存放的&#x27;B&#x27;</span><br><span class="line">mov es:[160*12+40*2+2], al</span><br><span class="line"></span><br><span class="line">pop cx</span><br><span class="line">pop es</span><br><span class="line">pop bx</span><br><span class="line">ret</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p>优点：</p><ul><li>算法清晰和简洁</li><li>加快运算速度</li><li>使程度易于扩充</li></ul><h3 id="代码的直接定址表"><a href="#代码的直接定址表" class="headerlink" title="代码的直接定址表"></a>代码的直接定址表</h3><p>问题：</p><p>实现一个子程序setscreen，为显示输出提供如下功能</p><ol><li>清屏</li><li>设置颜色</li><li>设置背景颜色</li><li>向上滚动一行</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">    mov al, 1                           ;功能号</span><br><span class="line">    mov ah, 1                           ;属性</span><br><span class="line">    call setscreen</span><br><span class="line"></span><br><span class="line">    mov 4c00h</span><br><span class="line">    int 21h</span><br><span class="line">setscreen:</span><br><span class="line">    jmp short set</span><br><span class="line">    ;fun1:清屏 fun2:颜色 fun3:背景颜色 fun4:向上滚动一行</span><br><span class="line">    table dw fun1, fun2, fun3, fun4</span><br><span class="line">set:</span><br><span class="line">    push bx</span><br><span class="line"></span><br><span class="line">    cmp ah, 3</span><br><span class="line">    ja sret                             ;大于3，则退出</span><br><span class="line">    mov bl, ah</span><br><span class="line">    mov bh, 0</span><br><span class="line">    add bx, bx</span><br><span class="line">    call word ptr table[bx]</span><br><span class="line">sret:</span><br><span class="line">    pop bx</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">fun1:                                   ;清屏</span><br><span class="line">    push bx</span><br><span class="line">    push cx</span><br><span class="line">    push es</span><br><span class="line"></span><br><span class="line">    mov bx, 0B800h              </span><br><span class="line">    mov es, bx                          ;设置显存的段地址</span><br><span class="line">    mov bx, 0</span><br><span class="line">    mov cx, 2000</span><br><span class="line">fun11:</span><br><span class="line">    mov byte ptr es:[bx], &#x27;&#x27;            ;将显存上的字符设为空格符</span><br><span class="line">    add bx, 2                           ;略过字节属性</span><br><span class="line">    loop fun11</span><br><span class="line"></span><br><span class="line">    pop es</span><br><span class="line">    pop cx</span><br><span class="line">    pop bx</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">fun2:                                   ;设置前景颜色</span><br><span class="line">    push bx</span><br><span class="line">    push cx</span><br><span class="line">    push es</span><br><span class="line"></span><br><span class="line">    mov bx, 0B800h              </span><br><span class="line">    mov es, bx                          ;设置显存的段地址</span><br><span class="line">    mov bx, 1</span><br><span class="line">    mov cx, 2000</span><br><span class="line">fun21:</span><br><span class="line">    and byte ptr es:[bx], 11111000b     ;将前景颜色置为黑</span><br><span class="line">    or es:[bx], al                      ;设置前景颜色</span><br><span class="line">    add bx, 2                           ;略过字符</span><br><span class="line">    loop fun21</span><br><span class="line"></span><br><span class="line">    pop es</span><br><span class="line">    pop cx</span><br><span class="line">    pop bx</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">fun3:                                   ;设置背景颜色</span><br><span class="line">    push bx</span><br><span class="line">    push cx</span><br><span class="line">    push es</span><br><span class="line"></span><br><span class="line">    mov bx, 0B800h              </span><br><span class="line">    mov es, bx                          ;设置显存的段地址</span><br><span class="line">    mov bx, 1</span><br><span class="line">    mov cx, 2000</span><br><span class="line">fun31:</span><br><span class="line">    and byte ptr es:[bx], 10001111b     ;将背景颜色置为黑</span><br><span class="line">    or es:[bx], al                      ;设置背景颜色</span><br><span class="line">    add bx, 2                           ;略过字符</span><br><span class="line">    loop fun31</span><br><span class="line"></span><br><span class="line">    pop es</span><br><span class="line">    pop cx</span><br><span class="line">    pop bx</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">fun4:                                   ;向上滚动一行</span><br><span class="line">    push bx</span><br><span class="line">    push cx</span><br><span class="line">    push es</span><br><span class="line"></span><br><span class="line">    mov si, 0B800h             </span><br><span class="line">    mov es, si                          ;设置显存的段地址</span><br><span class="line">    mov ds, si</span><br><span class="line">    mov si, 160                         ;ds:si</span><br><span class="line">    mov di, 0                           ;es:di</span><br><span class="line">    </span><br><span class="line">    cld</span><br><span class="line">    mov cx, 24</span><br><span class="line">fun41:                                  ;向上移动一行</span><br><span class="line">    push cx</span><br><span class="line">    mov cx, 160</span><br><span class="line">    rep movsb</span><br><span class="line">    pop cx</span><br><span class="line">    loop fun41</span><br><span class="line"></span><br><span class="line">    mov cx, 80</span><br><span class="line">    mov si, 0</span><br><span class="line">fun43:                                  ;将最后一行置为空格符</span><br><span class="line">    mov byte ptr es:[160*24+si], &#x27; &#x27;</span><br><span class="line">    add si, 2</span><br><span class="line">    loop fun43</span><br><span class="line"></span><br><span class="line">    pop es</span><br><span class="line">    pop cx</span><br><span class="line">    pop bx</span><br><span class="line">    ret</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="中断的概念"><a href="#中断的概念" class="headerlink" title="中断的概念"></a>中断的概念</h3><blockquote><p>中断：CPU不在接着(刚执行完的指令)向下执行，而是转去处理中断信息</p><p>内中断：由CPU内部发生的事</p><p>外中断：由外部设备发生的事</p></blockquote><img src="https://s2.loli.net/2022/10/20/wdPzEkUOLFGu4Am.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/20/wdPzEkUOLFGu4Am.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221020095353923.png" style="zoom:67%;" /><p>CPU内部产生的中断信息：</p><ul><li>除法错误，比如：执行div指令产生的除法溢出</li><li>单步执行</li><li>执行into指令</li><li>执行int指令</li></ul><p>8086的中断类型码：</p><ol><li>除法错误：0</li><li>单步执行：1</li><li>执行into指令：4</li><li>执行int n指令，立即数n为中断类型码</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ss:stack, ds:data</span><br><span class="line">stack segment</span><br><span class="line">db 200h dup(0)</span><br><span class="line">stack ends</span><br><span class="line">data segment</span><br><span class="line">msg db 13, 10, &#x27;hello world!&#x27;, 10, 13, &#x27;$&#x27;</span><br><span class="line">data ends</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">lea dx, msg;lea就是目标地址传送指令：将一个近地址指针写入到指定的寄存器</span><br><span class="line">mov ah, 9</span><br><span class="line">int 21h;调用中断的9号功能</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p><strong>中断处理程序</strong></p><p>CPU收到中断信息怎么办？</p><ul><li>执行中断处理程序</li></ul><p>中断处理程序在哪里？</p><ul><li>中断信息和其处理程序的入口地址之间有某种联系，CPU根据中断信息可以找到要执行的处理程序。</li></ul><p>中断向量表。</p><ul><li>由中断类型码，查表得到中断处理程序的入口地址，从而定位中断处理程序。</li></ul><p>8086CPU的中断向量表：</p><ul><li><code>(IP)=(N*4)，(CS)=(N*4+2)</code>，N为中断类型码</li></ul><p>中断过程：</p><ul><li>中断过程由CPU的硬件自动完成</li><li>用中断类型码找到中断向量，并用它设置CS和IP</li></ul><p>8086CPU的中断过程：</p><ol><li>从中断信息中取得中断类型码 (取得中断类型码N)</li><li>标志寄存器的值入栈——中断过程中要改变标志寄存器的值，需要先行保护 (pushf)</li><li>设置标志寄存器的第8位TF和第9位IF的值为0 (TF&#x3D;0, IF&#x3D;0)</li><li>CS的内容入栈 (push CS)</li><li>IP的内容入栈 (push IP)</li><li>从中断向量表读取中断处理程序的入口地址，设置IP和CS  (<code>(IP)=(N*4)，(CS)=(N*4+2)</code>)</li></ol><h3 id="编制中断处理程序"><a href="#编制中断处理程序" class="headerlink" title="编制中断处理程序"></a>编制中断处理程序</h3><p>CPU随时都可能检测到中断信息 ，所以中断处理程序必须常驻内存(一直存储在内存某段空间之中)。</p><p>中断处理程序的入口地址，即中断向量，必须存储在对应的中断向量表表项中(0000:0000~0000:03FF)。</p><p><strong>除法错误中断</strong></p><p>编与一个0号中断处理程序，它的功能是在屏幕中间显示”overflow!”后，然后返回到操作系统</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">asssume cs:code</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">;安装do0程序</span><br><span class="line">mov ax, cs</span><br><span class="line">mov ds, ax</span><br><span class="line">mov si, offset do0;指向源地址ds:si为cs:do0</span><br><span class="line">mov ax, 0</span><br><span class="line">mov es, ax</span><br><span class="line">mov di, 200h;指向目标地址es:di为0000:0200</span><br><span class="line">mov cx, offset do0end - offset do0;循环次数</span><br><span class="line">cld;正向传输</span><br><span class="line">rep movsb;从ds:si复制到es:di</span><br><span class="line">;设置中断向量表</span><br><span class="line">mov ax, 0</span><br><span class="line">mov es, ax</span><br><span class="line">;将0号中断要指向的地址更改为指向do0</span><br><span class="line">mov word ptr es:[0*4], 200h;设置偏移地址</span><br><span class="line">mov word ptr es:[0*4+2], 0;设置段地址</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">do0:</span><br><span class="line">jmp short do0start</span><br><span class="line">db &#x27;overflow!&#x27;</span><br><span class="line">do0start:</span><br><span class="line">mov ax, cs</span><br><span class="line">mov ds, ax</span><br><span class="line">mov si, 202h;设置ds:si为cs:0202,为字符串的起始地址</span><br><span class="line"></span><br><span class="line">mov ax, 0B800h</span><br><span class="line">mov es, ax</span><br><span class="line">mov di, 12*160+36*2;设置es:di为B800:07C8，设置在屏幕中间</span><br><span class="line">mov cx, 9;设置字符串循环次数</span><br><span class="line">s:;循环复制到显存</span><br><span class="line">mov al, [si]</span><br><span class="line">    mov es:[di], al</span><br><span class="line">    inc si</span><br><span class="line">    add di, 2</span><br><span class="line">    loop s</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">do0end:nop</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="单步中断"><a href="#单步中断" class="headerlink" title="单步中断"></a>单步中断</h3><p><strong>Dubug中的t命令</strong></p><ul><li><p>程序的正常执行：取指令、改变CS:IP、执行指令、取指令…</p></li><li><p>Debug提供了单步中断的中断处理程序，功能为显示所有寄存器中的内容后等待输入命令。</p></li><li><p>是什么，让CPU能执行一条指令就停下来？</p><ul><li>Debug利用了<strong>CPU提供</strong>的单步中断的功能</li><li>使用t命令时，Debug将TF标志设为1，使CPU工作在单步中断方式下…</li></ul></li></ul><p><strong>自定义单步中断处理程序</strong>，还可以实现特殊的功能</p><p>两个和中断相关的奇存器标志位：</p><ul><li><p>TF-陷阱标志(Trap flag)：用于调试时的单步方式操作。当TF&#x3D;1时，每条指令执行完后产生陷阱，由系统控制计算机；当TF&#x3D;0时，CPU正常工作，不产生陷阱。</p></li><li><p>IF-中断标志(Interrupt flag)：当IF&#x3D;1时，分许CPU响应可屏蔽中断请求；当IF&#x3D;0时，关闭中断。</p></li></ul><p>CPU在执行完一条指令之后，如果检测到标志寄存器的TF位为1，则产生单步中断(中断类型码为1 ，引发中断过程，执行中断处理程序)。</p><p>中断过程：</p><ol><li><p>取得中断类型码1</p></li><li><p>标志奇在器入栈，TF、IF设置为0</p><p>为什么要TF、IF设置为0？</p><ul><li>中断处理程序也由一条条<strong>指令组成</strong>的。</li><li>如果在执行中断处理程序之前，TF&#x3D;1，则CPU在<strong>执行完中断处理程序的第一条指令</strong>后，<strong>又要产生单步中断</strong>，<strong>转去执行单步中断的中断处理程序的第一条指令</strong></li><li>上面的过程将陷入一个永远不能结束的循环CPU永远执行单步中断处理程序的第一夅指令</li><li>所以，在进入中断处理程序之前，设置TF&#x3D;0</li></ul></li><li><p>CS、IP入栈</p></li><li><p><code>(IP)=(1*4), (CS)=(1*4+2)</code></p></li></ol><p>中断不响应的情况</p><p>一般情况下，CPU在执行完当前指令后，如果检测到中断信息，就响应中断，引发中断过程。</p><p>在有些情况下，CPU 在执行完当前指令后，即便是发生中断，也不会响应。</p><p>例：在执行完向ss寄存器(栈基地址)传送数据的指令后，即便是发生中断，CPU也不会响应。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 1000</span><br><span class="line">mov ss, ax</span><br><span class="line">mov sp, 10</span><br><span class="line">mov ax, 0;执行t命令后会将mov ss, ax和mov sp,10一口气执行完，到达此行</span><br></pre></td></tr></table></figure><ul><li>原因：ss:sp联合指向栈项，而对它们的设置应该<strong>连续完成</strong></li><li>以保证对栈的正确操作</li></ul><p>下面这种写法是错位的！！应该杜绝</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 1000</span><br><span class="line">mov ss, ax</span><br><span class="line">mov ax, 0</span><br><span class="line">mov sp, 10</span><br></pre></td></tr></table></figure><h3 id="由int指令引发的中断"><a href="#由int指令引发的中断" class="headerlink" title="由int指令引发的中断"></a>由int指令引发的中断</h3><p>int格式：<code>int n</code>，n为中断类型码</p><ul><li>功能：引发中断过程</li><li>int指令与call指令相似，都是调用一段程序</li><li>执行<code>int n</code>时，pushf、push CS、push IP</li></ul><p><strong>编写供应用程序调用的中断例程</strong></p><p>编程时，可以用int指令调用子程序</p><ul><li>此程序即中断处理程序，简称为中断例程</li><li>可以自定义中断例程，实现特定功能</li></ul><p><strong>示例：中断7ch的中断例程的编写和安装</strong></p><p>写7ch的中断例程，完成特定任务</p><ul><li>求一个word型数据的平方</li><li>参数(ax)&#x3D;要计算的数据</li><li>返回值：dx,ax存放结果的高、低16位</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">;安装中断例程</span><br><span class="line">mov ax, cs</span><br><span class="line">mov ds, ax</span><br><span class="line">mov si, offset do7c</span><br><span class="line"></span><br><span class="line">mov ax, 0</span><br><span class="line">mov es, ax</span><br><span class="line">movdi, 200h</span><br><span class="line"></span><br><span class="line">mov cx, offset do7cend-offset do7c </span><br><span class="line">cld</span><br><span class="line">rep movsb</span><br><span class="line">;设置中断向量表</span><br><span class="line">mov ax, 0</span><br><span class="line">mov es, ax</span><br><span class="line">mov word ptr es:[7ch*4], 200h</span><br><span class="line">mov word ptr es:[7ch*4+2], 0</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">;中断例程</span><br><span class="line">do7c:</span><br><span class="line">mul ax</span><br><span class="line">;执行iret时，pop IP、pop CS、popf</span><br><span class="line">    iret;中断返回。使程序返回到原来发⽣中断的地⽅。其作⽤是从中断中恢复中断前的状态</span><br><span class="line">do7cend:nop</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p><strong>中断处理程序的常规步骤</strong>：</p><blockquote><ol><li>保存用到的寄存器</li><li>处理中断</li><li>恢复用到的寄存器</li><li>用iret指令返回</li></ol></blockquote><h3 id="BIOS和DOS中断处理"><a href="#BIOS和DOS中断处理" class="headerlink" title="BIOS和DOS中断处理"></a>BIOS和DOS中断处理</h3><p><strong>BIOS——基本输入输出系统</strong></p><p>BIOS，是在系统板的ROM中存放着一套程应</p><ul><li>容量：8KB</li><li>地址：从FE000H开始</li><li>BIOS中的主要内容<ol><li>硬件系统的检测和初始化程序</li><li>外部中断和内部中断的中断例程</li><li>用于对硬件设备进行I&#x2F;O操作的中断例程</li><li>其他和硬件系统相关的中断例程</li></ol></li></ul><p>使用BIOS功能调用 ，程序员不用了解硬件操作细节，直接使用指令设置参数，并中断调用BIOS例程，即可完成相关工作！</p><p>使用BIOS功能调用：</p><ol><li>方便编程</li><li>能出简洁、可读性好、易于移植的程序</li></ol><p><strong>BIOS中断调用示例</strong></p><p>任务：在屏幕的5行12列显示3个红底高亮闪烁绿色的’a’</p><p>使用BIOS的10h中断</p><ul><li>(ah)&#x3D;2时，调用10h中断例程的2号子程序，设置光标位置</li><li>(ah)&#x3D;9时，调用第10h中断例程的9号子程序，在光标位置显示字符</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">mov ah, 2;设置光标功能2</span><br><span class="line">mov bh, 0;第0页</span><br><span class="line">mov dh, 5;dh中方行号</span><br><span class="line">mov dl, 12;dl中方列号</span><br><span class="line">int 10h</span><br><span class="line"></span><br><span class="line">mov ah, 9;显示字符功能9</span><br><span class="line">mov al, &#x27;a&#x27;;字符</span><br><span class="line">mov bl, 11001010b;颜色属性</span><br><span class="line">mov bh, 0;第0页</span><br><span class="line">mov cx, 3;字符重复个数</span><br><span class="line">int 10h</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><strong>其他的BIOS中断:</strong></p><ol><li>显示服务(Video Service——INT 10H)</li><li>直接磁盘服务(Direct Disk Service——INT 13H)</li><li>串行口服务(Serial Port Service——INT 14H)</li><li>杂项系统服务(Miscellaneous System Service——INT 15H)</li><li>键盘服务(Keyboard Service——INT 16H)</li><li>并行口服务(Parallel Port Service——INT 17H)</li><li>时钟服务(Clock Service——INT 1AH)</li><li>直接系统服务(Direct System Service)</li></ol><p><strong>DOS中断：</strong></p><ol><li>INT 20H一终止程序运行</li><li>INT 21H一功能调用</li><li>INT 22H一终止处理程序的地址</li><li>INT 23H—Ctrl+C 处理异常</li><li>INT 24H一致命错误处理程亮</li><li>INT 25H一读磁盘扇区(忽略逻辑结构)</li><li>INT 26H一写磁盘扇区(忽略逻辑结构)</li><li>INT 27H一终止、并驻留在内存</li><li>INT 28H—DOS 空闲</li><li>INT 2FH一多重中断服务</li><li>INT 33H一鼠标功能</li></ol><p><strong>BIOS和DOS在所提供的中断</strong></p><ul><li><p>例程中包舍了许多子程序，这些子程序实现了程序员在编程的时常用到的功能。</p></li><li><p>和硬件设备相关的DOS中断例程中，一般都调用BIOS的中断例程。</p></li></ul><p><strong>int 21h DOS中断例程的应用</strong></p><p>4ch号功能：程序返回</p><ul><li>功能号在ah，返回结果保存在al</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov ah, 4ch</span><br><span class="line">mov al, 0</span><br><span class="line">int 21h</span><br></pre></td></tr></table></figure><p>09h号功能：在光标位置显示字符串</p><ul><li>ds:bx指向要显示的字符串(用’$’结束)</li></ul><p>编程在屏幕中显示字符串：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data</span><br><span class="line">data segment</span><br><span class="line">masm db &#x27;Welcom to masm!$&#x27;</span><br><span class="line">data ends</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line">mov dx, masm</span><br><span class="line">mov ah, 9</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p><strong>BIOS和DOS中断例程的安装过程</strong></p><ol><li>CPU一加电，初始化(CS)&#x3D;0FFFFH ,(IP)&#x3D;0，自动从FFFF:0单元开始执行程序。FFFF:0处有一条转跳指令，CPU执行该指令后，转去执行B1OS中的硬件系统检测和初始化程序。</li><li>初始化程序将建立BIOS 所支持的中断向量，即将BIOS提供的中断例程的入口地址登记在中断向量表中。</li><li>硬件系统检测和初始化完成后，调用int 19h进行操作系统的引导 。从此将计算机交由操作系统控制。</li><li>DOS启动后，除完成其它工作外，还将它所提供的中断例程装入内存，并建立相应的中断向量。</li></ol><h3 id="端口的读写"><a href="#端口的读写" class="headerlink" title="端口的读写"></a>端口的读写</h3><p>使用端口访问外设：以发声为例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov al, 08h;设置声音的频率</span><br><span class="line">out 44h, al</span><br><span class="line">out 42h, al</span><br><span class="line">in al, 61h;读设备控制器端口原值</span><br><span class="line">mov ah, al;保存原值</span><br><span class="line">or al, 3;打开扬声器和定时器</span><br><span class="line">out 61h, al;接通扬声器，发声</span><br><span class="line">mov cx, 60000;延时</span><br><span class="line">delay:</span><br><span class="line">nop</span><br><span class="line">loop delay</span><br><span class="line">mov al, ah;恢复端口原值</span><br><span class="line">out 61h, al</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><p><strong>CPU的邻居</strong></p><p>CPU可以直接读写3个地方的数据</p><ul><li>CPU内部的寄存器</li><li>内存单元</li><li>端口：<ol><li>各种接口、网卡、显卡等</li><li>主板上的接口芯片</li><li>其他芯片</li></ol></li></ul><p>各种芯片工作时，都有一些寄存器由CPU读写</p><p>从CPU角度，将各寄存器当端口，并统一编址</p><p>CPU用统一的方法与各种设备通信</p><p>读写内存与寄存器的指令</p><ul><li>mov、add、push</li></ul><p>读写端口的指令</p><ul><li>in：CPU从端口读取数据</li><li>out：CPU往端口写入数据</li></ul><p><strong>端口的读写</strong></p><p>访问端口的方法：</p><ul><li><code>in al, 60h</code>：从60h号端口读入一个字节</li></ul><p>执行时与总线相关的操作：</p><ol><li>CPU通过地址线将地址信息60h交出</li><li>CPU通过控制线发出<strong>端口读命令</strong>，选中端口所在的芯片，并通知要从中读取数据</li><li>端口所在的芯片将60h端口中的数据通过数据总线送入CPU。</li></ol><p><strong>端口的读写过程演示</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">in al, 20h;机器码为E420</span><br><span class="line">out 21h, al;机器码为E621</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/10/21/eQgS4GEtiJN6m78.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/21/eQgS4GEtiJN6m78.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="QQ图片20221021183453.png" style="zoom:67%;" /><p><strong>端口的读写指令示例</strong></p><p>对0~255以内的端口进行读写，端口号立即数给出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">in al, 20h;从20h端口读入一个字节</span><br><span class="line">out 21h, al;往21h端口写入一个字节</span><br></pre></td></tr></table></figure><p>对256~65535的端口进行读写时，端口号放在dx中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov dx, 3f8h;将端口号3f8h送入dx</span><br><span class="line">in al, dx;从3f8h端口读入一个字节</span><br><span class="line">out dx, al;向3f8h端口写入一个字节</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li><p>在in和out指令中，只能使用ax或al来存放从端口中读入的数据或要发送到端口中的数据。</p></li><li><p>访问8位端口时用al，访问16位端口时用ax。</p></li></ul><h3 id="操作CMOS-RAM芯片"><a href="#操作CMOS-RAM芯片" class="headerlink" title="操作CMOS RAM芯片"></a>操作CMOS RAM芯片</h3><p><strong>CMOS RAM芯片</strong></p><ul><li>包含一个实时钟和一个有128个存储单元的RAM存储器。</li><li>128个字节的RAM中存储：内部实时钟、系统配置信息、相关的程序(用于开机时配置系统信息)</li><li>CMOS RAM芯片<strong>靠电池供电</strong>，<strong>关机后其内部的实时钟仍可正常工作</strong>，RAM中的信息不丢失。</li><li>该芯片内部有两个端口，端口地址为20h和71h，CPU通过这两个端口读写CMOS RAM<ul><li>70h地址端口，存放要访问的CMOS RAM单元的地址</li><li>71h数据端口，存放从选定的单元中读取的数据，或要写入到其中的数据</li></ul></li><li>读取CMOS RAM的两个步骤：<ol><li>将要读取的单元地址送入70h地址端口</li><li>从数据端口71h读出指定单元的内容</li></ol></li></ul><p><strong>提取CMOS RAM中存储的时间信息</strong></p><p>当前时间在CMOS RAM中用6个字节存放</p><table><thead><tr><th>内容</th><th>秒</th><th></th><th>分</th><th></th><th>时</th><th></th><th></th><th>日</th><th>月</th><th>年</th></tr></thead><tbody><tr><td>地址</td><td>00</td><td>01</td><td>02</td><td>03</td><td>04</td><td>05</td><td>06</td><td>07</td><td>08</td><td>09</td></tr></tbody></table><p>注意：这六个信息的长度都为1个字节</p><p>例如：今天为10月21日(时间信息用BCD码存放)</p><table><thead><tr><th>2</th><th>1</th><th>1</th><th>0</th></tr></thead><tbody><tr><td>0010</td><td>0001</td><td>0001</td><td>0000</td></tr></tbody></table><p>在屏幕上显示当前月份</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov al, 8</span><br><span class="line">out 70h, al;首先要向地址端口70h写入要访问的单元地址，8单元存放的为月份</span><br><span class="line">in al, 71h;在从数据端口71h中取得指定单元中的数据中的月份，放到al中</span><br><span class="line"></span><br><span class="line">mov ah, al</span><br><span class="line">mov cl, 4</span><br><span class="line">shr ah, cl;获取高4位，月份的十位数</span><br><span class="line">and al, 00001111b;获取低4位，月份的个位数</span><br><span class="line"></span><br><span class="line">add ah, 30h;获取十位数所对应的ASCII码</span><br><span class="line">add al, 30h;获取个位数所对应的ASCII码</span><br><span class="line">mov bx, 0B800h</span><br><span class="line">mov byte ptr es:[160*12+40*2], ah;写入屏幕中间</span><br><span class="line">mov byte ptr es:[160*12+40*2+2], al</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="外设连接与中断"><a href="#外设连接与中断" class="headerlink" title="外设连接与中断"></a>外设连接与中断</h3><p>外中断：由外部设备发生的事件引起的中断</p><p>可屏蔽中断：</p><ul><li>可屏蔽中断是CPU 可以不响应的外中断。</li><li>CPU 是否响应可屏蔽中断，要看标志奇存器的IF位的设置。</li><li>当CPU检测到可屏蔽中断信息时：<ul><li>如果IF&#x3D;1，则CPU在执行完当前指令后响应中断，引发中断过程；</li><li>如果IF0&#x3D;0，则不响应可屏蔽中断。</li></ul></li></ul><p>不可屏蔽中断：</p><ul><li>不可屏蔽中断是CPU必须响应的外中断</li><li>当CPU检测到不可屏蔽中断信息时，则在执行完当前指令后，立即响应，引发中断过程</li><li>对于8086CPU不可屏蔽中断的中断类型码固定为2</li></ul><p>几乎所有由外设引发的外中断，都是可屏蔽中断，比如键盘输入、打印机请求。</p><p>不可屏蔽中断在系统中有必须处理的紧急情况发生时用来通知CPU的中断信息</p><p><strong>外中断处理过程</strong></p><p>可屏蔽中断所引发的中断过程：</p><ol><li><p>取中断类型码n</p><p>注意：可屏蔽中断信息来自于CPU外部，中断类型码是通过数据总线送入CPU</p><p>对比内中断：中断类型码是在CPU内部产生的</p></li><li><p>标志寄存器入栈，IF&#x3D;0，TF&#x3D;0</p><p>将IF置0的原因：进入中断处理程序后，禁止其他的可屏蔽中断</p><p>如果在中断处理程序中需要处理可屏蔽中断，可以用指令将IF置1</p></li><li><p>CS、IP入栈</p></li><li><p><code>(IP)=(n*4)，CS=(n*4+2)</code></p></li></ol><p>由此转去执行中断处理程序。</p><p>不可屏蔽中断的中断过程：</p><ol><li><p>标志奇存器入栈，IF&#x3D;0， TF&#x3D;0</p></li><li><p>CS、IP入栈；</p></li><li><p>(IP)&#x3D;(8)，(CS)&#x3D;(0AH).</p><p>中断值固定为2，不必取中断码</p></li></ol><p>8086CPU提供的设置IF的指令：</p><ul><li><code>sti</code>：用于设置IF&#x3D;1</li><li><code>cli</code>：用于设置 IF&#x3D;0</li></ul><h3 id="PC机键盘的处理过程"><a href="#PC机键盘的处理过程" class="headerlink" title="PC机键盘的处理过程"></a>PC机键盘的处理过程</h3><p>键盘输入的处理过程</p><ol><li><p>键盘输入</p><ul><li><p>键盘上的每一个键相当于一个开关，键盘中有一个芯片对键盎上的每—个键的开关状态进行扫描。</p></li><li><p>按下一个键时的操作：</p><ul><li>开关接通，该芯片就产生一个扫描鸡，扫描码说明了按下的键在键盘上的位置。</li><li>扫描码被送入主板上的相关接口芯片的寄存器中，该寄存器的端口地址为60H。</li></ul></li><li><p>松开按下的键时的操作：</p><ul><li>产生一个扫描码，扫描码说明了松开的键在键密上的位置。</li><li>松开按键时产生的扫描码也被送入60H 端口中。</li></ul></li><li><p>扫描码：长度为一个字节的编码</p><ul><li><p>按下一个键时产生的扫描码一一通码，通码的第7位为0</p></li><li><p>松开一个键时产生的扫描码一一断码，断码的第7位为1</p></li><li><p>例：G键的通码为22H，断码为a2H</p><p>g键的通码：0010 0010</p><p>g键的断码：1010 0010</p><p>公式：<code>通码+80h=断码</code></p></li></ul></li></ul></li><li><p>引发9号中断</p><ul><li><p>键盘的输入到达60H端口时 ，相关的芯片就会向CPU发出中断类型码为9的可屏蔽中断信息。</p></li><li><p>CPU检测到该中断信息后 ，如果IF&#x3D;1，则响应中断，引发中断过程，转去执行<code>int 9</code>中断例程。</p></li><li><p>输入的的字符键值如何保存？</p><ul><li>有BIOS键盘缓冲区 ！</li><li>BIOS键盘缓冲区：是系统启动后，BIOS用于存放<code>int 9</code>中断例程所接收的键盘输入的内存区。</li><li>Bos键盘缓冲区：可以存储15个键盎输入，一个键盘输入用<strong>一个字单元</strong>存放，<strong>高位字节存放扫描码，低位字节存放字符码</strong></li></ul></li><li><p>输入了控制键和切换键，如何处理？</p><ul><li><p><code>0040:17</code>：键盘状态字节</p><table><thead><tr><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>0</th></tr></thead><tbody><tr><td>Insert</td><td>CapsLock</td><td>NumLock</td><td>ScrollLock</td><td>Alt</td><td>Ctrl</td><td>左shift</td><td>右shift</td></tr></tbody></table></li></ul></li></ul></li><li><p>执行<code>int 9</code>中断例程</p><ul><li>B1OS 中提供的处理键盘输入的<code>int 9</code>中断例程的工作<ol><li>读出60H 端口中的扫描码</li><li>根据扫描码分情况对待<ul><li>如果是字符键的扫描码，将该扣描码和它所对应的字符码(即：ASCI码)送入内存中的BIOS键盎缓冲区；</li><li>如果是控制键(比如：Ctrl)和切换键(比如：CapsLock)的扫描码，则将其转变为状态字节(用二进制位记录控制键和切换键状态的字节)写入内存中存储状态字节的单元</li></ul></li><li>对键盘系统进行相关的控制，如向相关芯片发出应答信息</li></ol></li></ul></li></ol><p><strong>输入’a’的处理过程</strong></p><img src="https://s2.loli.net/2022/10/21/A7Z1BnXO8JuSDLM.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/21/A7Z1BnXO8JuSDLM.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="QQ图片20221021203636.png" style="zoom:67%;" /><h3 id="定制键盘输入处理"><a href="#定制键盘输入处理" class="headerlink" title="定制键盘输入处理"></a>定制键盘输入处理</h3><p>键盘输入的处理过程</p><ol><li>键盘产生扫描码</li><li>扫描码送入60h端口</li><li>引发9 号中断</li></ol><p>以上都是由硬件系统完成的</p><ol start="4"><li>CPU执行<code>int 9</code>中断例程 ，处理键盘输入<ul><li>DOS系统提供<code>int 9</code>中断例程</li><li>或者按照开发需求定制处理键盘的输入</li></ul></li></ol><p><strong>编程任务</strong></p><ul><li>在屏幕中间依次显示’a’~’z’，并可以让人看清。</li><li>在显示的过程中，按下Esc键后，改变显示的颜色。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ss:stack, ds:data</span><br><span class="line">stack segment</span><br><span class="line">db 128 dup(0)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">dw 0, 0</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, stack</span><br><span class="line">mov ss, ax</span><br><span class="line">mov sp, 128</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line"></span><br><span class="line">;改中断例程入口地址</span><br><span class="line">mov ax, 0</span><br><span class="line">mov es, ax</span><br><span class="line">push es:[9*4]</span><br><span class="line">pop ds:[0]</span><br><span class="line">push es:[9*4+2]</span><br><span class="line">pop ds:[2]</span><br><span class="line">mov word ptr es:[9*4], offset int9</span><br><span class="line">mov es:[9*4+2], cs</span><br><span class="line"></span><br><span class="line">;在同一位置依次显示字符a~z</span><br><span class="line">mov ax, 0B800h</span><br><span class="line">mov es, ax</span><br><span class="line">mov ah, &#x27;a&#x27;</span><br><span class="line">s:mov es:[160*12+40*2], ah</span><br><span class="line">call delay</span><br><span class="line">inc ah</span><br><span class="line">cmp ah, &#x27;z&#x27;</span><br><span class="line">jna s</span><br><span class="line"></span><br><span class="line">;恢复原来的地址</span><br><span class="line">push ds:[0]</span><br><span class="line">pop es:[9*4]</span><br><span class="line">push ds:[2]</span><br><span class="line">pop es:[9*4+2]</span><br><span class="line"></span><br><span class="line">mov 4c00h</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">;定义延时函数，设置一个循环函数</span><br><span class="line">delay:</span><br><span class="line">push ax</span><br><span class="line">push dx</span><br><span class="line"></span><br><span class="line">mov dx, 10h</span><br><span class="line">mov ax, 0</span><br><span class="line">s1:sub ax, 1</span><br><span class="line">sbb dx, 0</span><br><span class="line">cmp ax, 0</span><br><span class="line">jne s1</span><br><span class="line">cmp dx, 0</span><br><span class="line">jne s1</span><br><span class="line"></span><br><span class="line">pop dx</span><br><span class="line">pop ax</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line">;定义中断例程</span><br><span class="line">int9:</span><br><span class="line">push ax</span><br><span class="line">push bx</span><br><span class="line"></span><br><span class="line">in al, 60h</span><br><span class="line">pushf</span><br><span class="line">pushf</span><br><span class="line">pop bx</span><br><span class="line">and bh, 11111100b</span><br><span class="line">push bx</span><br><span class="line">popf</span><br><span class="line">call dword ptr ds:[0]</span><br><span class="line"></span><br><span class="line">cmp al, 1</span><br><span class="line">jne int9ret</span><br><span class="line"></span><br><span class="line">mov ax, 0B800h</span><br><span class="line">mov es, ax</span><br><span class="line">inc byte ptr es:[...]</span><br><span class="line">int9ret:</span><br><span class="line">pop es</span><br><span class="line">pop bx</span><br><span class="line">pop ax</span><br><span class="line">iret</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="改写中断例程的方法"><a href="#改写中断例程的方法" class="headerlink" title="改写中断例程的方法"></a>改写中断例程的方法</h3><h3 id="用中断响应外设"><a href="#用中断响应外设" class="headerlink" title="用中断响应外设"></a>用中断响应外设</h3><p>以典型输入设计——键盘操作为例：</p><table><thead><tr><th>硬件中断int 16h</th><th>BIOS中断int 16h</th><th>DOS中断int 21h</th></tr></thead><tbody><tr><td>由键盘上按下或松开个键时，<br>如果中断是允许的，<br>就会产生int 9h中断，<br>并转到BIOS的键盘中断处理程序。</td><td>G10s中断提供基本的鍵盘操作，<br>功能号(AH)&#x3D;<br>00H、10H从键盘读入字符<br/>01H、11H读取键盘状态<br/>024、12H读取键盘标志<br/>03H设置重复率<br/>04H设置键盘点击<br/>05H字符及其扫描码进栈在使用功能键和变换键的程序中很重要。</td><td>DOs中断提供丰富、便捷的功能调用功能号(AH)&#x3D;<br/>01H从键盘输入一个字符并回显<br/>06H读键盘字符<br/>07H从键盘输入一个字符不回显<br/>08H从键盘输入一个字符，不回显，检测CTRL-Break<br/>0AH输入字符到指定地址的缓冲区<br/>0BH读键盘状态<br/>0CH清除键盘缓冲区，并调用一种键盎功能</td></tr></tbody></table><p><strong>对键盘输入的处理的int 9h中断和int 16h中断</strong></p><h3 id="字符的输入输出"><a href="#字符的输入输出" class="headerlink" title="字符的输入输出"></a>字符的输入输出</h3><p>问题：设计一个最基本的字符串输入程序，需要具备下面的功能</p><ol><li>在输入的同时需要显示这个字符串</li><li>一般在输入回车符后，字符串输入结束</li><li>能够删除已经输入的字符一一用退格键</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code, ds:data</span><br><span class="line">data segment</span><br><span class="line">db 32 dup(?);?表示所定义的变量未指定初值,就是说定义的单元不存新数据</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">mov ax, data</span><br><span class="line">mov ds, ax</span><br><span class="line"></span><br><span class="line">mov si, 0</span><br><span class="line">mov dh, 12</span><br><span class="line">mov dl, 20</span><br><span class="line"></span><br><span class="line">call getstr</span><br><span class="line"></span><br><span class="line">mov ax, 4c00h</span><br><span class="line">int 21h</span><br><span class="line">;子程序：读取字符</span><br><span class="line">getstr:</span><br><span class="line">push ax</span><br><span class="line">getstrs:</span><br><span class="line">;读取键盘输入</span><br><span class="line">mov ah, 0</span><br><span class="line">int 16h</span><br><span class="line">;小于20h为非字符</span><br><span class="line">cmp al, 20h</span><br><span class="line">jb nochar</span><br><span class="line">;字符al入栈</span><br><span class="line">mov ah, 0</span><br><span class="line">call charstack</span><br><span class="line">;字符显示</span><br><span class="line">mov ah, 2</span><br><span class="line">call charstack</span><br><span class="line"></span><br><span class="line">jmp getstrs</span><br><span class="line">;处理非字符</span><br><span class="line">nochar:</span><br><span class="line">;退格键的扫描码</span><br><span class="line">cmp ah, 0eh</span><br><span class="line">je backspace</span><br><span class="line">;回车键的扫描码</span><br><span class="line">cmp ah, 1ch</span><br><span class="line">je enter</span><br><span class="line">jmp getstrs</span><br><span class="line">;退格键</span><br><span class="line">backspace:</span><br><span class="line">;字符出栈</span><br><span class="line">mov  ah, 1</span><br><span class="line">call charstack</span><br><span class="line">;字符显示</span><br><span class="line">mov ah, 2</span><br><span class="line">call cahrstack</span><br><span class="line"></span><br><span class="line">jmp getstrs</span><br><span class="line">;回车键</span><br><span class="line">enter:</span><br><span class="line">mov al, 0</span><br><span class="line">;0字符入栈</span><br><span class="line">mov ah, 0</span><br><span class="line">call cahrstack</span><br><span class="line">;显示字符</span><br><span class="line">mov ah, 2</span><br><span class="line">call cahrstack</span><br><span class="line">;退出getstr子程序</span><br><span class="line">pop ax</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line">;子程序：字符操作</span><br><span class="line">charstack:</span><br><span class="line">jmp short charstart</span><br><span class="line">table dw charpush, charpop, charshow</span><br><span class="line">top dw 0</span><br><span class="line">charstart:</span><br><span class="line">push bx</span><br><span class="line">push dx</span><br><span class="line">push di</span><br><span class="line">push es</span><br><span class="line"></span><br><span class="line">cmp ah, 2</span><br><span class="line">ja sret</span><br><span class="line">;通过ah在table中跳转到对应功能的地址</span><br><span class="line">mov bl, ah</span><br><span class="line">mov bh, 0</span><br><span class="line">add bx, bx</span><br><span class="line">jmp word ptr table[bx]</span><br><span class="line"></span><br><span class="line">;字符入栈</span><br><span class="line">charpush:</span><br><span class="line">;字符入栈</span><br><span class="line">mov bx, top</span><br><span class="line">mov [si][bx], al</span><br><span class="line">;字符数+1</span><br><span class="line">inc top</span><br><span class="line">jmp sret</span><br><span class="line"></span><br><span class="line">;字符出栈</span><br><span class="line">charpop:</span><br><span class="line">cmp top, 0</span><br><span class="line">je sret</span><br><span class="line">;字符数-1</span><br><span class="line">dec top;dec指令：自减</span><br><span class="line">;获取出栈的字符，保存在al中</span><br><span class="line">mov bx, top</span><br><span class="line">mov al, [si][bx]</span><br><span class="line">jmp sret</span><br><span class="line"></span><br><span class="line">;显示栈中的字符,在(dh)行(di)列显示</span><br><span class="line">charshow:</span><br><span class="line">mov bx, 0B800h</span><br><span class="line">mov es, bx</span><br><span class="line">mov al, 160</span><br><span class="line">mov ah, 0</span><br><span class="line">mul dh</span><br><span class="line">mov di, ax</span><br><span class="line">add dl, al</span><br><span class="line">mov dh, 0</span><br><span class="line">add di, dx</span><br><span class="line">;将已经复制的字符数置为0</span><br><span class="line">mov bx, 0</span><br><span class="line"></span><br><span class="line">charshows:</span><br><span class="line">cmp bx, top</span><br><span class="line">jne noempty</span><br><span class="line">mov byte ptr es:[di], &#x27; &#x27;</span><br><span class="line">jmp sret</span><br><span class="line"></span><br><span class="line">noempty:</span><br><span class="line">;复制到的显存中</span><br><span class="line">mov al, [si][bx]</span><br><span class="line">mov es:[di], al</span><br><span class="line">;将下一个字符置为空格符</span><br><span class="line">mov btye ptr es:[di+2], &#x27; &#x27;</span><br><span class="line">;已经复制的字符数+1</span><br><span class="line">inc bx</span><br><span class="line">;移动到下一个字符位置</span><br><span class="line">add di, 2</span><br><span class="line">jmp charshows</span><br><span class="line"></span><br><span class="line">sret:</span><br><span class="line">pop es</span><br><span class="line">pop di</span><br><span class="line">pop dx</span><br><span class="line">pop bx</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><h3 id="磁盘读写"><a href="#磁盘读写" class="headerlink" title="磁盘读写"></a>磁盘读写</h3><p>BIOS提供的磁盘直接服务——<code>int 13h</code></p><p><strong>对磁盘进行读操作</strong></p><blockquote><p>入口参数：</p><ul><li><p>(ah)&#x3D;2 (2表示读扇区)</p></li><li><p>(al)&#x3D;读取的扇区数</p></li><li><p>(ch)&#x3D;磁道号，(cl)&#x3D;扇区号</p></li><li><p>(dh)&#x3D;磁头号(对于软盘即面号，一个面用一个磁头来读写)</p></li><li><p>(dl)&#x3D;驱动器号：软盘从0号开始，0：软驱A，1：软驱B；</p><p>​硬盘从80h开始，80h：硬盘C，81h：硬盘D</p></li><li><p><code>es:bx</code>指向接收从扇区读入数据的内存区</p></li></ul><p>返回参数；</p><ul><li>操作成功：(ah)&#x3D;0，(al)&#x3D;读入的扇区数</li><li>操作失败：(ah)&#x3D;出错代码</li></ul></blockquote><p>例子：读入c盘0面0道1扇区的内容道内存单元0:200h</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 0</span><br><span class="line">mov es, ax</span><br><span class="line">mov bx, 200h;读入0:200h</span><br><span class="line">mov al, 1;1个扇区</span><br><span class="line">mov ch, 0;0磁道</span><br><span class="line">mov cl, 1;1扇区</span><br><span class="line">mov dl, 80h;C盘</span><br><span class="line">mov dh, 0;0面</span><br><span class="line">mov ah, 2;读扇区</span><br><span class="line">int 13h</span><br></pre></td></tr></table></figure><p><strong>DOS中断对磁盘文件的支持——<code>int 21h</code></strong></p><p>部分功能：</p><table><thead><tr><th>目录控制功能</th><th>磁盘管理功能</th></tr></thead><tbody><tr><td>39H：创建目录<br>3AH：删除目录<br>3BH：设置当前目录<br>47H：读取当前目录</td><td>0DH：磁盘复位<br>2EH：设置校验标志<br>0EH：选择磁盘<br>36H：读取驱动器分配信息<br>19H：读取当前驱动器<br>54H：读取校验标志<br>1BH,1CH：读取驱动器数据</td></tr></tbody></table><p>举例：功能39H</p><ul><li>功能描述：用指定的驱动器和路径创建一个新目录</li><li>入口参数：<ul><li>AH &#x3D;39H</li><li>DS:DX&#x3D;指定路径的字符串地址(以0为字符串的结束标志)</li></ul></li><li>出口参数：<br>CF&#x3D;0——创建成功，否则，AX&#x3D;错误号(03H或05H)，其含义见错误代码表</li></ul><h3 id="让计算机唱歌"><a href="#让计算机唱歌" class="headerlink" title="让计算机唱歌"></a>让计算机唱歌</h3><p><strong>与”计算机唱歌”有关的硬件及控制</strong></p><p><img src="https://s2.loli.net/2022/10/22/hIy7uP1liBk93F8.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/22/hIy7uP1liBk93F8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221022204845431.png"></p><p>8253芯片(定时&#x2F;计数器)的设置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mov al, 0b6h;8253初始化</span><br><span class="line">out 43h, al;43H时8253芯片控制口的端口地址</span><br><span class="line">mov dx, 12h</span><br><span class="line">mov ax, 34dch</span><br><span class="line">div word ptr [si];计算分频值，赋给ax，[si]中存放声音的频率值</span><br><span class="line">out 42h, al;先送低8位到计数器，42h是8253芯片通道2的端口地址</span><br><span class="line">mov al, ah</span><br><span class="line">out 42h, al;后送高8位计数器</span><br></pre></td></tr></table></figure><p>设置8255芯片(并行I&#x2F;O)，控制扬声器的开&#x2F;关</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">in al, 61h;读取8255 B端口原值</span><br><span class="line">mov ah, al ;保存原值</span><br><span class="line">or al, 3;使低两位置1，以便打开开关</span><br><span class="line">out 61h, al ;开扬声器，发声</span><br><span class="line">...;延时，保持时间</span><br><span class="line">mov al, ah</span><br><span class="line">out 61h, al;恢复扬声器端口原值</span><br></pre></td></tr></table></figure><p><strong>翻译乐谱</strong></p><p>音符和发音频率(HZ)的对应关系：</p><table><thead><tr><th>低音符</th><th>频率</th><th>中音符</th><th>频率</th><th>高音符</th><th>频率</th></tr></thead><tbody><tr><td>1</td><td>138</td><td>1</td><td>262</td><td>1</td><td>524</td></tr><tr><td>2</td><td>147</td><td>2</td><td>294</td><td>2</td><td>587</td></tr><tr><td>3</td><td>165</td><td>3</td><td>330</td><td>3</td><td>659</td></tr><tr><td>4</td><td>175</td><td>4</td><td>349</td><td>4</td><td>698</td></tr><tr><td>5</td><td>196</td><td>5</td><td>392</td><td>5</td><td>784</td></tr><tr><td>6</td><td>220</td><td>6</td><td>440</td><td>6</td><td>880</td></tr><tr><td>7</td><td>247</td><td>7</td><td>494</td><td>7</td><td>988</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">;新年好&quot;数字化&quot;乐谱</span><br><span class="line">data segment</span><br><span class="line">mus_freq dw 262,262,262,196</span><br><span class="line"> dw 330,330,330,262</span><br><span class="line"> dw 262,330,392,392</span><br><span class="line"> dw 349,330,294</span><br><span class="line"> dw 294,330,349,349</span><br><span class="line"> dw 330,294,330,262</span><br><span class="line"> dw 262,330,294,196</span><br><span class="line"> dw 247,294,262,-1</span><br><span class="line"> </span><br><span class="line">mus_time dw 3 dup(12,12,25,25),12,12,50</span><br><span class="line"> dw 3 dup(12,12,25,25),12,12,50 </span><br><span class="line">data ends</span><br></pre></td></tr></table></figure><p><strong>演凑程序</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="0-总结"><a href="#0-总结" class="headerlink" title="0.总结"></a>0.总结</h2><p>在8086CPU中有14个寄存器：</p><ul><li><strong>通用寄存器</strong>：AX、BX、CX、DX</li><li>变址寄存器：SI、DI</li><li>指针寄存器：SP、BP</li><li>指令指针寄存器：IP</li><li>段寄存器：CS、SS、DS、ES</li><li>标志寄存器：PSW</li><li>并且所有寄存器都是<strong>16位</strong>的，可以存放<strong>两个字节</strong></li></ul><table><thead><tr><th>段寄存器</th><th></th><th></th></tr></thead><tbody><tr><td>CS</td><td>代码段寄存器</td><td>CS:IP</td></tr><tr><td>DS</td><td>数据段寄存器</td><td></td></tr><tr><td>SS</td><td>堆栈段寄存器</td><td>SS:SP</td></tr><tr><td>ES</td><td>附加段寄存器</td><td></td></tr></tbody></table><table><thead><tr><th>指针寄存器</th><th></th><th></th></tr></thead><tbody><tr><td>SP</td><td>堆栈指针</td><td>SP指向栈顶，SS:SP</td></tr><tr><td>BP</td><td>基数指针</td><td></td></tr><tr><td>IP</td><td>指令指针</td><td>存储下一条指令的偏移地址，CS:IP</td></tr></tbody></table><table><thead><tr><th>变址寄存器</th><th></th><th></th></tr></thead><tbody><tr><td>SI</td><td>源变址</td><td>串操作指令，si和ds联用</td></tr><tr><td>DI</td><td>目的变址</td><td>串操作指令，di和es联用</td></tr></tbody></table><ul><li>si和di可以和bx、bp联用。使用bx时段地址在ds中；使用bp时段地址在ss中</li><li>si和di在单独使用时，段地址默认在ds中</li><li>si和di不能够分成两个8位寄存器来使用</li></ul><p>数据传送指令：</p><table><thead><tr><th>指令</th><th></th><th></th></tr></thead><tbody><tr><td>mov</td><td>移动</td><td></td></tr><tr><td>posh</td><td>压栈</td><td></td></tr><tr><td>pop</td><td>出栈</td><td></td></tr><tr><td>lds</td><td></td><td></td></tr><tr><td>les</td><td></td><td></td></tr><tr><td>lahf</td><td></td><td></td></tr><tr><td>sahf</td><td></td><td></td></tr><tr><td>pushf</td><td>将标志寄存器值压栈</td><td></td></tr><tr><td>popf</td><td>将标志寄存器值出栈</td><td></td></tr></tbody></table><p>算数运算指令：</p><table><thead><tr><th>指令</th><th></th><th></th></tr></thead><tbody><tr><td>add</td><td></td><td></td></tr><tr><td>adc</td><td></td><td></td></tr><tr><td>inc</td><td>加1</td><td></td></tr><tr><td>aaa</td><td></td><td></td></tr><tr><td>daa</td><td></td><td></td></tr><tr><td>sub</td><td></td><td></td></tr><tr><td>sbb</td><td></td><td></td></tr><tr><td>dec</td><td>减1</td><td></td></tr><tr><td>neg</td><td></td><td></td></tr><tr><td>cmp</td><td></td><td></td></tr><tr><td>aas</td><td></td><td></td></tr><tr><td>das</td><td></td><td></td></tr><tr><td>mul</td><td></td><td></td></tr><tr><td>imul</td><td></td><td></td></tr><tr><td>amm</td><td></td><td></td></tr><tr><td>div</td><td></td><td></td></tr><tr><td>idiv</td><td></td><td></td></tr><tr><td>aad</td><td></td><td></td></tr><tr><td>cbw</td><td></td><td></td></tr><tr><td>cwd</td><td></td><td></td></tr></tbody></table><p>逻辑指令：</p><table><thead><tr><th>指令</th><th></th><th></th></tr></thead><tbody><tr><td>and</td><td>和运算</td><td></td></tr><tr><td>test</td><td></td><td></td></tr><tr><td>or</td><td>或运算</td><td></td></tr><tr><td>xor</td><td></td><td></td></tr><tr><td>not</td><td></td><td></td></tr><tr><td>shl</td><td>左移</td><td></td></tr><tr><td>shr</td><td>右移</td><td></td></tr><tr><td>sah</td><td></td><td></td></tr><tr><td>sar</td><td></td><td></td></tr><tr><td>rol</td><td></td><td></td></tr><tr><td>ror</td><td></td><td></td></tr><tr><td>rcl</td><td></td><td></td></tr><tr><td>rcr</td><td></td><td></td></tr></tbody></table><p>串操作指令：</p><table><thead><tr><th>指令</th><th></th><th></th></tr></thead><tbody><tr><td>movsb</td><td></td><td></td></tr><tr><td>movsw</td><td></td><td></td></tr><tr><td>rep</td><td></td><td></td></tr><tr><td>jmp</td><td></td><td></td></tr><tr><td>loop</td><td></td><td></td></tr><tr><td>call</td><td></td><td></td></tr><tr><td>ret</td><td></td><td></td></tr><tr><td>int</td><td></td><td></td></tr></tbody></table></div>]]></content>
      
      
      <categories>
          
          <category> 计算机4件套 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 汇编 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)856. 括号的分数</title>
      <link href="/2022/10/09/%E6%AF%8F%E6%97%A5LeetCode/2022-10/856%20%E6%8B%AC%E5%8F%B7%E7%9A%84%E5%88%86%E6%95%B0/"/>
      <url>/2022/10/09/%E6%AF%8F%E6%97%A5LeetCode/2022-10/856%20%E6%8B%AC%E5%8F%B7%E7%9A%84%E5%88%86%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个平衡括号字符串 S，按下述规则计算该字符串的分数：</p><ul><li><code>()</code> 得 1 分。</li><li><code>AB</code> 得 A + B 分，其中 A 和 B 是平衡括号字符串。</li><li><code>(A)</code> 得 2 * A 分，其中 A 是平衡括号字符串。</li></ul></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入： “(()(()))”<br>输出： 6</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">scoreOfParentheses</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        stack&lt;<span class="type">int</span>&gt; stk;</span><br><span class="line">        stk.<span class="built_in">emplace</span>(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(s[i] == <span class="string">&#x27;(&#x27;</span>)&#123;</span><br><span class="line">                stk.<span class="built_in">emplace</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">auto</span> t = stk.<span class="built_in">top</span>();</span><br><span class="line">                stk.<span class="built_in">pop</span>();</span><br><span class="line">                </span><br><span class="line">                stk.<span class="built_in">top</span>() += <span class="built_in">max</span>(t*<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> stk.<span class="built_in">top</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)，其中 n 是字符串的长度。</li><li>空间复杂度：O(n)。栈需要 O(n) 的空间。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL的学习笔记</title>
      <link href="/2022/10/08/Java/MySQL/"/>
      <url>/2022/10/08/Java/MySQL/</url>
      
        <content type="html"><![CDATA[<h1 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h1><ul><li><p>DDL：数据定义语言 </p></li><li><p>DML：数据操作语言</p></li><li><p>DQL：数据查询语言</p></li><li><p>DCL：数据控制语言</p></li></ul><div class="story post-story"><h2 id="1-存储引擎"><a href="#1-存储引擎" class="headerlink" title="1.存储引擎"></a>1.存储引擎</h2><h3 id="1-1-MySQL体系结构"><a href="#1-1-MySQL体系结构" class="headerlink" title="1.1 MySQL体系结构"></a>1.1 MySQL体系结构</h3><ul><li><p>连接层</p><p>最上层是一些客户端和链接服务，主要完成一些类似于连接处理、授权认证、及相关的安全方案。服务器也会为安全接入的每个客户端验证它所具有的操作权限。</p></li><li><p>服务层</p><p>第二层架构主要完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化，部分内置西数的执行。所有跨存储引擎的功能也在这一层实现，如过程、函数等。</p></li><li><p>引擎层</p><p>存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API和存储引擎进行通信。不同的存储引擎具有不同的功能，这样我们可以根据自己的需要，来选取合适的存储引擎</p></li><li><p>存储层</p><p>主要是将数据存储在文件系统之上，并完成与存储引擎的交互</p></li></ul><h3 id="1-2-存储引擎简介"><a href="#1-2-存储引擎简介" class="headerlink" title="1.2 存储引擎简介"></a>1.2 存储引擎简介</h3><p>存储引擎就是存储数据、建立索引、更新&#x2F;查询数据等技术的实现方式。存储引擎是基于表的，而不是基于库的，所以存储引擎也可被称为表类型</p><ol><li><p>在创建表时，指定存储引擎</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 表名(</span><br><span class="line">  字段 字段类型[COMMENT 字段注释],</span><br><span class="line">  ......</span><br><span class="line">)ENGINE<span class="operator">=</span>INNODB[COMMENT 表注释];</span><br></pre></td></tr></table></figure></li><li><p>查看当前数据库支持的存储引擎</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW ENGINES;</span><br></pre></td></tr></table></figure></li></ol><h3 id="1-3-存储引擎特点"><a href="#1-3-存储引擎特点" class="headerlink" title="1.3 存储引擎特点"></a>1.3 存储引擎特点</h3><ul><li><p>InnoDB</p><blockquote><ul><li>介绍</li></ul></blockquote></li></ul><blockquote><p>  InnoDB是一种兼顾高可靠性和高性能的通用存储引擎，在 MySQL5.5 之后，InnoDB是默认的 MySQL 存储引擎</p><ul><li><p>特点</p><p>DML操作遵循ACID模型，支持<strong>事务</strong></p><p><strong>行级锁</strong>，提高并发访问性能</p><p>支持<strong>外键</strong> FOREIGN KEY约束，保证数据的完整性和正确性；</p></li><li><p>文件</p><p><code>xxx.ibd</code>：xxx代表的是表名，innoDB引擎的每张表都会对应这样一个表空间文件，存储该表的表结构(frm、sdi)、数据和索引。<br>参数：<code>innodb file_per_table</code></p></li></ul></blockquote><ul><li><p>MyISAM</p><blockquote><ul><li>介绍</li></ul></blockquote></li></ul><blockquote><p>  MyISAM是MySQL早期的默认存储引擎。</p><ul><li><p>特点</p><p>不支持事务，不支持外键</p><p>支持表锁，不支持行锁</p><p>访问速度快</p></li><li><p>文件<br><code>xxx.sdi</code>：存储表结构信息<br><code>xxx.MYD</code>：存储数据<br><code>xxx.MYI</code>：存储索引</p></li></ul></blockquote><ul><li><p>Memory</p><blockquote><ul><li><p>介绍</p><p>Memory引擎的表数据时存储在内存中的，由于受到硬件问题、或断电问题的影响，只能将这些表作为临时表或缓存使用</p></li><li><p>特点</p><p>内存存放</p><p>hash索引（默认）</p></li><li><p>文件</p><p><code>xxx.sdi</code>：存储表结构信息</p></li></ul></blockquote></li></ul><table><thead><tr><th align="center">特点</th><th align="center">InnoDB</th><th align="center">MyISAM</th><th align="center">Memory</th></tr></thead><tbody><tr><td align="center">存储限制</td><td align="center">64TB</td><td align="center">有</td><td align="center">有</td></tr><tr><td align="center">事务安全</td><td align="center"><strong>支持</strong></td><td align="center">-</td><td align="center">-</td></tr><tr><td align="center">锁机制</td><td align="center"><strong>行锁</strong></td><td align="center">表锁</td><td align="center">表锁</td></tr><tr><td align="center">B+tree索引</td><td align="center">支持</td><td align="center">支持</td><td align="center">支持</td></tr><tr><td align="center">Hash索引</td><td align="center">-</td><td align="center">-</td><td align="center">支持</td></tr><tr><td align="center">全文索引</td><td align="center">支持(5.6版本后)</td><td align="center">支持</td><td align="center">-</td></tr><tr><td align="center">空间使用</td><td align="center">高</td><td align="center">低</td><td align="center">N&#x2F;A</td></tr><tr><td align="center">内存使用</td><td align="center">高</td><td align="center">低</td><td align="center">中等</td></tr><tr><td align="center">批量插入速度</td><td align="center">低</td><td align="center">高</td><td align="center">高</td></tr><tr><td align="center">支持外键</td><td align="center"><strong>支持</strong></td><td align="center">-</td><td align="center">-</td></tr></tbody></table><h3 id="1-4-存储引擎的应用场景"><a href="#1-4-存储引擎的应用场景" class="headerlink" title="1.4 存储引擎的应用场景"></a>1.4 存储引擎的应用场景</h3><p>在选择存储引擎时，应该根据应用系统的特点选择合适的存储引1擎。对于复杂的应用系统，还可以根据实际情况选择多种存储引擎进行组合。</p><ul><li><p>InnoDB：</p><p>是MySQL的默认存储引擎，支持事务、外键。如果应用对事务的完整性有比较高的要求，在并发条件下要求数据的一致性，数据操作除了插入和查询之外，还包含很多的更新、脚除操作，那么innoDB存储引擎是比较合适的选择。</p></li><li><p>MyISAM：(MongoDB取代)</p><p>如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，井且对事务的完整性、并发性要求不是很高，那么选择这个存储引擎是非常合适的。</p></li><li><p>MEMORY：(Redis取代)</p><p>将所有数据保存在内存中，访问速度快，通常用于临时表及缓存。MEMORY的缺陷就是对表的大小有限制，太大的表无法缓存在内存中，而且无法保障数据的安全性。</p></li></ul></div><div class="story post-story"><h2 id="2-索引"><a href="#2-索引" class="headerlink" title="2.索引"></a>2.索引</h2><h3 id="2-1-概述"><a href="#2-1-概述" class="headerlink" title="2.1 概述"></a>2.1 概述</h3><p>索引(index)是帮助MySQL **高效获取数据的数据结构(有序)**。在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用(指向)数据， 这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。</p><p>优缺点：</p><table><thead><tr><th align="center">优势</th><th align="center">劣势</th></tr></thead><tbody><tr><td align="center">据检索的效率，降低数据库的IO成本</td><td align="center">索引列也是要占用空间的。</td></tr><tr><td align="center">通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗</td><td align="center">索引大大提高了查询效率，同时却也降低更新表的速度，如对表进行INSERT、UPDATE、DELETE时，效率降低。</td></tr></tbody></table><h3 id="2-2-结构"><a href="#2-2-结构" class="headerlink" title="2.2 结构"></a>2.2 结构</h3><p>MySQL的索引是在存储引擎层实现的，不同的存储引擎有不同的结构，主要包含以下几种：</p><table><thead><tr><th>索引结构</th><th>描述</th></tr></thead><tbody><tr><td>B+Tree索引</td><td>最常见的索引类型，大部分引擎都支持 B+树索引</td></tr><tr><td>Hash索引</td><td>底层数据结构是用哈希表实现的，只有精确匹配索引列的查询才有效,不支持范围查询</td></tr><tr><td>R-Tree(空间索引)</td><td>空间索引是MyISAN引擎的一个特殊索引类型，主要用于地理空问数据类型，通常使用较少</td></tr><tr><td>Full-Text(全文索引)</td><td>是一种通过建立倒排索引,快速匹配文档的方式。类似于Lucene、Solr、ES</td></tr></tbody></table><table><thead><tr><th>索引</th><th>InnoDB</th><th>MyISAM</th><th>Memory</th></tr></thead><tbody><tr><td>B+Tree索引</td><td>:white_check_mark:</td><td>:white_check_mark:</td><td>:white_check_mark:</td></tr><tr><td>Hash索引</td><td>:x:</td><td>:x:</td><td>:white_check_mark:</td></tr><tr><td>R-Tree索引</td><td>:x:</td><td>:white_check_mark:</td><td>:x:</td></tr><tr><td>Full-Text索引</td><td>5.6版本后:white_check_mark:</td><td>:white_check_mark:</td><td>:x:</td></tr></tbody></table><p>我们平常所说的索引，如果没有特别指明，都是指B+树结构组织的索引。</p><p><strong>二叉树：</strong></p><img src="https://s2.loli.net/2022/10/08/clGrwayNSAYbVPi.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/08/clGrwayNSAYbVPi.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221008163852043.png" style="zoom:67%;" /><p>二叉树缺点：顺序插入时，会形成一个链表，查询性能大大降低。大数据量情况下，层级较深，检索速度慢。</p><p>红黑树：大数据量情况下，层级较深，检索速度慢。</p><p><strong>B-Tree(多路平衡查找树)</strong></p><p>以一颗最大度数为5的(5阶)B-Tree为例：</p><p>注意：数的度数指的是一个结点的子节点数</p><img src="https://s2.loli.net/2022/10/08/wdhgr3pmaDU6Lnj.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/08/wdhgr3pmaDU6Lnj.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221008164715771.png" style="zoom: 50%;" /><p><strong>B+Tree</strong></p><p>以一颗最大度数为4的(4阶)B-Tree为例：</p><img src="https://s2.loli.net/2022/10/08/QzROMgSdqV3wjFD.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/08/QzROMgSdqV3wjFD.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221008164831179.png" style="zoom:67%;" /><p>相对于B-Tree的区别：</p><ul><li>所有的数据都会出现在叶子节点</li><li>叶子节点形成一个单向链表</li></ul><p>而MySQL索引数据结构对经典的B+Tree进行了优化。在原B+Tree的基础上，增加一个指向相邻叶子节点的链表指针，就形成了带有顺序指针的B+Tree，提高区间访问的性能。</p><img src="https://s2.loli.net/2022/10/08/FilXt48mcz1bUyL.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/08/FilXt48mcz1bUyL.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221008165043053.png" style="zoom:50%;" /><p><strong>Hash</strong></p><p>哈希索引就是采用一定的hash算法，将键值换算成新的hash值，映射到对应的槽位上，然后存储在hash表中。</p><img src="https://s2.loli.net/2022/10/08/GVer2oA9wFHzsY5.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/08/GVer2oA9wFHzsY5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221008165246360.png" style="zoom: 67%;" /><ul><li><strong>Hash索引特点</strong></li></ul><ol><li>Hash索引只能用于对等比较(&#x3D;，in)，不支持范围查询(between，&gt;，＜，…)</li><li>无法利用索引完成排序操作</li><li>查询效率高，通常只需要一次检索就可以了，效率通常要高于B+tree索引</li></ol><ul><li><p><strong>存储引擎支持</strong></p><p>在MySQL中，支持hash索引的是Memory引擎，而InnoDB中具有自适应hash功能，hash索引是存储引擎根据B+Tree索引l在指定条件下自动构建的。</p></li></ul><p><strong>思考</strong>：</p><p>为什么InnoDB存储引擎选择使用Bttree索引结构？</p><ul><li>相对于二叉树，层级更少，搜索效率高；</li><li>对于B-tree，无论是叶子节点还是非叶子节点，都会保存数据，这样导致一页中存储的键值减少，指针跟着减少，要同样保存大量数据，只能增加树的高度，导致性能降低;</li><li>相对于Hash索引，B+Tree支持范围匹配及排序操作;</li></ul><h3 id="2-3-分类"><a href="#2-3-分类" class="headerlink" title="2.3 分类"></a>2.3 分类</h3><table><thead><tr><th>分类</th><th>含义</th><th>特点</th><th>关键字</th></tr></thead><tbody><tr><td>主键索引</td><td>针对于表中主键创建的索引</td><td>默认自动创建，只能有一个</td><td>PRIMARY</td></tr><tr><td>唯一索引</td><td>避免同一个表中某数据列中的值重复</td><td>可以有多个</td><td>UNIQUE</td></tr><tr><td>常规索引</td><td>快速定位特定数据</td><td>可以有多个</td><td></td></tr><tr><td>全文索引</td><td>全文泰引查找的是文本中的关键词，<br>而不是比较索引中的值</td><td>可以有多个</td><td>FULLTEXT</td></tr></tbody></table><p>在InnoDB存储引擎中，根据索引的存储形式，又可以分为以下两种：</p><table><thead><tr><th align="center">分类</th><th>含义</th><th>特点</th></tr></thead><tbody><tr><td align="center">聚集索引<br>(Clustered Index)</td><td>将数据存储与索引放到了一块，<br>索引结构的叶子节点保存了<strong>行数据</strong></td><td>必须有,而且只有一个</td></tr><tr><td align="center">二级索引<br>(Secondary Index)</td><td>将数据与索引分开存储，<br>索引结构的叶子节点关联的是<strong>对应的主键</strong></td><td>可以存在多个</td></tr></tbody></table><p>聚集索引选取规则：</p><ul><li>如果存在主键，主键索引就是聚集索引。</li><li>如果不存在主键，将使用第一个唯一(UNIQUE)索引作为聚集索引。</li><li>如果表没有主键，或没有合适的唯一索引，则innoDB会自动生成一个rowid作为隐藏的聚集索引。</li></ul><img src="https://s2.loli.net/2022/10/08/a4lDPfys69TCV5d.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/08/a4lDPfys69TCV5d.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221008170642178.png" style="zoom: 50%;" /><p>以<code>select * from user where name=&#39;Arm&#39;</code>为例：</p><img src="https://s2.loli.net/2022/10/08/vJzsdKWxCeAVjtY.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/08/vJzsdKWxCeAVjtY.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221008171306986.png" style="zoom: 67%;" /><p>回表查询：先通过<strong>二级索引</strong>查询到主键id，再通过主键id通过<strong>聚集索引</strong>查询</p><p><strong>思考</strong>：</p><p>以下SQL语句，那个执行效率高？</p><ul><li><code>select * from user where id=10</code></li><li><code>select * from user where name=&#39;Arm&#39;</code></li></ul><p>注意：id为主键，name为字段(有索引)</p><p>通过id(主键)查询效率高</p><p>InnoDB主键索引的B+tree高度为多高呢？</p><ul><li><p>假设：</p><p>一行数据大小为1k，一页中可以存储16行这样的数据。InnoDB的指针占用6个字节的空间，主键即使为bigint， 占用字节数为8。</p></li><li><p>高度为2：<br><code>n*8+（n+1)*6=16*1024</code>，算出n约为 1170<br><code>1171* 16=18736</code></p></li><li><p>高度为3<br><code>1171* 1171*16=21939856</code></p></li></ul><h3 id="2-4-语法"><a href="#2-4-语法" class="headerlink" title="2.4 语法"></a>2.4 语法</h3><ul><li><p>创建索引：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> [<span class="keyword">UNIQUE</span><span class="operator">|</span>FULLTEXT] index index_name <span class="keyword">on</span> table_name(index_col_name, …);</span><br></pre></td></tr></table></figure></li></ul><p>参数说明：</p><blockquote><p><code>UNIQUE</code>：唯一索引，该字段不能出现重复数据</p><p><code>FULLTEXT</code>：全文索引</p><p>如果不加，则是常规索引</p><p>如果一个索引只关联一个字段叫做单列索引</p><p>如果一个索引只关联多个字段叫做联合索引</p></blockquote><p>查看索引：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> table_name;</span><br></pre></td></tr></table></figure><p>删除索引：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> index index_name <span class="keyword">on</span> table_name; </span><br></pre></td></tr></table></figure><p>案例需求：</p><ol><li>name宇段为姓名字段，该宇段的值可能会重复，为该宇段创建索引。</li><li>phone手机号字段的值，是非空，且唯一的，为该宇段创建唯一索引。</li><li>为profession、age、status创建联合素引。</li><li>为email建立合适的索引来提升查询效率。(常规索引)</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_user_name <span class="keyword">on</span> tb_user(name);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">unique</span> index idx_user_phone <span class="keyword">on</span> tb_user(phone);</span><br><span class="line"><span class="keyword">create</span> index idx_user_pro_age_sta <span class="keyword">on</span> tb_user(profession, age, status);</span><br><span class="line"><span class="keyword">create</span> index idx_email <span class="keyword">on</span> tb_user(email);</span><br></pre></td></tr></table></figure><h3 id="2-5-SQL性能分析"><a href="#2-5-SQL性能分析" class="headerlink" title="2.5 SQL性能分析"></a>2.5 SQL性能分析</h3><p><strong>SQL的执行频率</strong></p><p>MvSOL 客户媏连接成功后，通过 <code>show [session|global] status</code> 命令可以提供服务器状态信息。通过指令，可以查看当前数据库的INSERT、UPDATE、DELETE、SELECT的访问频次：&amp;#x20;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> ‘Com_______’;</span><br></pre></td></tr></table></figure><h4 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h4><p>慢查询日志记录了所有执行时间超过指定参数(long_query_time， 单位：秒，默认10秒)的所有SQL语句的日志。&amp;#x20;</p><p>MySQL的慢查询日志默认没有开启：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> ‘show_query_log’;</span><br></pre></td></tr></table></figure><p>需要在MySQL的配置文件(&#x2F;etc&#x2F;my.cnf)中配置如下信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#开启MySQL慢日志查询开关</span><br><span class="line">slow_query_log=1</span><br><span class="line">#设置慢日志的时间为2秒，SQL语句执行时间超过2秒就会视为慢查询，记录慢查询日志</span><br><span class="line">long_query_time=2</span><br></pre></td></tr></table></figure><p>配置完毕之后，重新启动MySQL服务器进行测试，查看慢日志文件中记录的信息<code>/var/lib/mysql/locathost-slow.log</code></p><h4 id="profile详情"><a href="#profile详情" class="headerlink" title="profile详情"></a>profile详情</h4><p>show profiles 能够在做SQL优化时帮助我们了解时间都耗费到哪里去了。</p><p>通过have_profiling參数，能够看到当前MySQL是否支持profile操作：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@have</span>_profiling;</span><br></pre></td></tr></table></figure><p>默认profiling是关闭的，可以通过set语句在session&#x2F;global级别开启profiling：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> profiling <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>查看是否开启profiling：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@profiling</span>;</span><br></pre></td></tr></table></figure><p>查看SQL语句耗时情况：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#查看每一条<span class="keyword">SQL</span>语句的基本情况</span><br><span class="line"><span class="keyword">show</span> profiles;</span><br><span class="line"></span><br><span class="line">#查看指定query_id的<span class="keyword">SQL</span>语句的各个阶段的耗时情况</span><br><span class="line"><span class="keyword">show</span> profile <span class="keyword">for</span> query query_id;</span><br><span class="line"></span><br><span class="line">#查看指定query_id的<span class="keyword">SQL</span>语句CPU的使用情况</span><br><span class="line"><span class="keyword">show</span> profile cpu <span class="keyword">for</span> query query_id;</span><br></pre></td></tr></table></figure><h4 id="explain执行计划"><a href="#explain执行计划" class="headerlink" title="explain执行计划"></a>explain执行计划</h4><p>EXPLAIN 或者 DESC 命令获取 MySQL 如何执行 SELECT 语句的信息，包括在 SELECT 语句执行过程中表如何连接和连接的顺序。</p><p>语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#直接在<span class="keyword">select</span>语句之前加上关键字explain<span class="operator">/</span><span class="keyword">desc</span></span><br><span class="line">explain <span class="keyword">select</span> 字段列表 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 条件;</span><br></pre></td></tr></table></figure><p>EXPLAIN 执行计划各字段含义：</p><blockquote><ul><li><p><strong>Id</strong></p><p>select查询的序列号，表示查询中执行select子句或者是操作表的顺序(id相同，执行顺序从上到下；id不同，值越大，越先执行)。</p></li><li><p><strong>select_type</strong></p><p>表示 SELECT 的类型，常见的取值有 SIMPLE（简单表，即不使用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、UNION (UNION 中的第二个或者后面的查询语句）、SUBQUERY (SELECT&#x2F;WHERE之后包含了子查询）等</p></li><li><p><strong>type</strong></p><p>表示连接类型，性能由好到差的连接类型为NULL、system、const、eq_ref、ref、range、index、all 。</p></li><li><p><strong>possible key</strong></p><p>显示可能应用在这张表上的索引，一个或对个</p></li><li><p><strong>key</strong><br>实际使用的索引，如果为NULL，则没有使用索引。</p></li><li><p><strong>key_len</strong></p><p>表示索引中使用的字节数，该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下，长度越短越好。</p></li><li><p><strong>rows</strong></p><p>MySQL认为必须要执行查询的行数，在innodb引擎的表中，是一个估计值，可能并不总是准确的。</p></li><li><p><strong>filtered</strong></p><p>表示返回结果的行数占需读取行数的百分比，filtered 的值越大越好。</p></li></ul></blockquote><h3 id="2-6-使用规则"><a href="#2-6-使用规则" class="headerlink" title="2.6 使用规则"></a>2.6 使用规则</h3><h4 id="验证索引效率"><a href="#验证索引效率" class="headerlink" title="验证索引效率"></a>验证索引效率</h4><p>未建立索引之前，(大约对<strong>1千万的数据量</strong>)执行如下SQL语句，查看SQL的耗时：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_sku <span class="keyword">where</span> sn<span class="operator">=</span><span class="string">&#x27;100000003145001&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>耗时：大约20s</p></blockquote><p>针对字段创建索引：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_sku_sn <span class="keyword">on</span> tb_sku(sn);</span><br></pre></td></tr></table></figure><p>再次执行上面的SQL语句，耗时：大约0.01s</p><h4 id="最左前缀法则"><a href="#最左前缀法则" class="headerlink" title="最左前缀法则"></a>最左前缀法则</h4><p>如果索引了多列(联合索引)，要遵守最左前缀法则。</p><p>最左前缀法则指的是查询<strong>从索引的最左列开始，并且不跳过索引中的列</strong>。</p><p>如果从索引的最左列开始**跳跃某一列，索引将部分失效(后面的字段索引失效)**。</p><p>已经创建好的联合索引：<code>idx_user_pro_age_sta</code>(依次为profession、age、status)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> profession<span class="operator">=</span><span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">31</span> <span class="keyword">and</span> status<span class="operator">=</span><span class="string">&#x27;0&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>使用了联合索引<code>idx_user_pro_age_sta</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> profession<span class="operator">=</span><span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">31</span>;</span><br></pre></td></tr></table></figure><blockquote><p>依然使用了联合索引<code>idx_user_pro_age_sta</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> profession<span class="operator">=</span><span class="string">&#x27;软件工程&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>仍然使用了联合索引<code>idx_user_pro_age_sta</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> age<span class="operator">=</span><span class="number">31</span> <span class="keyword">and</span> status<span class="operator">=</span><span class="string">&#x27;0&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p><strong>没有使用联合索引</strong>，而是使用了全表扫描。</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> status<span class="operator">=</span><span class="string">&#x27;0&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>依然没有使用联合索引</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> profession<span class="operator">=</span><span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">and</span> status<span class="operator">=</span><span class="string">&#x27;0&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>会使用联合索引。profession走了索引，而status没有走索引，索引部分失效</p></blockquote><p>范围查询</p><p>联合索引中，出现范围查询<code>&gt;</code>、<code>&lt;</code>，范围查询右侧的列索引失效</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb <span class="keyword">user</span> <span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">and</span> age <span class="operator">&gt;</span><span class="number">30</span> <span class="keyword">and</span> status<span class="operator">=</span> <span class="string">&#x27;0&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>status索引失效</p></blockquote><p>使用<code>&lt;=</code>、<code>&gt;=</code>，则不会失效：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb <span class="keyword">user</span> <span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">and</span> age <span class="operator">&gt;=</span><span class="number">30</span> <span class="keyword">and</span> status <span class="operator">=</span><span class="string">&#x27;0&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>status索引不会失效</p></blockquote><h4 id="索引失效情况"><a href="#索引失效情况" class="headerlink" title="索引失效情况"></a>索引失效情况</h4><ul><li><strong>索引列运算</strong></li></ul><p>不要在索引列上进行运算操作，索引将失效</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- substring():截取字段</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> <span class="built_in">substring</span>(phone,<span class="number">10</span>,<span class="number">2</span>) <span class="operator">=</span> <span class="string">&#x27;15&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p><code>idx_user_phone</code>索引失效</p></blockquote><ul><li><strong>字符串不加引号</strong></li></ul><p>字符串类型字段使用时，不加引号，索引将失效</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> phone<span class="operator">=</span><span class="number">17799990015</span></span><br></pre></td></tr></table></figure><blockquote><p>虽然可以查询，但是<code>idx_user_phone</code>索引会失效</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb <span class="keyword">user</span> <span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">30</span> <span class="keyword">and</span> status <span class="operator">=</span><span class="number">0</span>:</span><br></pre></td></tr></table></figure><blockquote><p>联合索引中的status失效</p></blockquote><ul><li><strong>模糊查询</strong></li></ul><p>如果仅仅是尾部模糊匹配，索引不会失效，如果是<strong>头部模糊匹配</strong>，索引失效</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb <span class="keyword">user</span> <span class="keyword">where</span> profession <span class="keyword">like</span> <span class="string">&#x27;%工程&#x27;</span></span><br></pre></td></tr></table></figure><blockquote><p>索引失效</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb <span class="keyword">user</span> <span class="keyword">where</span> profession <span class="keyword">like</span> <span class="string">&#x27;软件%&#x27;</span></span><br></pre></td></tr></table></figure><blockquote><p>索引生效</p></blockquote><ul><li><strong>or连接的条件</strong></li></ul><p>用or分割开的条件，如果or前的条件中的列有索引，而<strong>后面的列中没有索引</strong>，那么涉及的索引都不会被用到。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">10</span> <span class="keyword">or</span> age <span class="operator">=</span> <span class="number">23</span>;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> phone <span class="operator">=</span> <span class="string">&#x27;77799990017&#x27;</span> <span class="keyword">or</span> age <span class="operator">=</span> <span class="number">23</span>;</span><br></pre></td></tr></table></figure><blockquote><p>由于age没有索引，所以即使id、phone有索引，索引也会失效。所以<strong>需要针对于age也要建立索引</strong>。</p></blockquote><ul><li>数据分布影响</li></ul><p>如果MySQL评估使用索引比全表更慢，则不会使用索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> phone <span class="operator">&gt;=</span> <span class="string">&#x27;17799990005&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>不会走索引，因为大部分的数据满足条件</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> phone <span class="operator">&gt;=</span> <span class="string">&#x27;17799990015&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>会走索引，仅少量数据满足条件</p></blockquote><h4 id="SQL提示"><a href="#SQL提示" class="headerlink" title="SQL提示"></a>SQL提示</h4><p>profession存在两个索引联合索引<code>idx_user_pro_age_sta</code>、单列索引<code>idx_user_pro</code></p><p>执行下面语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p><strong>用到了联合索引</strong>，经过MySQL，选择了联合索引</p></blockquote><p>SQL提示，是优化数据库的一个重要手段，简单来说，就是在SQL语句中加入一些人为的提示来达到优化操作的目的。</p><p><code>use index</code>：使用的索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user use index(idx_user_pro) <span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span>;</span><br></pre></td></tr></table></figure><p><code>ignore index</code>：忽略使用的索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user ignore index(idx_user_pro) <span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span>;</span><br></pre></td></tr></table></figure><p><code>force index</code>：强制使用的索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user force index(idx_user_pro) <span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span>;</span><br></pre></td></tr></table></figure><h4 id="覆盖索引-amp-回表查询"><a href="#覆盖索引-amp-回表查询" class="headerlink" title="覆盖索引&amp;回表查询"></a>覆盖索引&amp;回表查询</h4><p>尽量使用覆盖索引(查询使用了索引，并且需要返回的列，在该索引中已经全部能够找到)，<br><strong>减少使用<code>select *</code></strong></p><p>以下存在联合索引<code>idx_user_pro_age_sta</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id, profession <span class="keyword">from</span> tb_user </span><br><span class="line"><span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">and</span> age <span class="operator">=</span> <span class="number">31</span> <span class="keyword">and</span> status<span class="operator">=</span><span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"><span class="comment">/*using where; using index*/</span></span><br><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> id, profession, age, status <span class="keyword">from</span> tb_user </span><br><span class="line"><span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">and</span> age <span class="operator">=</span><span class="number">31</span> <span class="keyword">and</span> status <span class="operator">=</span> <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"><span class="comment">/*using where; using index*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> id, profession, age, status, name <span class="keyword">from</span> tb_user </span><br><span class="line"><span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">and</span> age <span class="operator">=</span><span class="number">31</span> <span class="keyword">and</span> status <span class="operator">=</span><span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"><span class="comment">/*using index condition 多加一个name字段*/</span></span><br><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user </span><br><span class="line"><span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">and</span> age <span class="operator">=</span><span class="number">31</span> <span class="keyword">and</span> status <span class="operator">=</span> <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"><span class="comment">/*using index condition*/</span></span><br></pre></td></tr></table></figure><p>Extra中：</p><ul><li>using index condition ：查找使用了索引，但是需要<strong>回表查询数据</strong></li><li>using where; using index ：查找使用了索引，但是<strong>需要的数据都在索引列中能找到</strong>，所以不需要回表查询数据</li></ul><p>一张表，有四个字段(id, username, password, status)，由于数据量大，需要对以下SQL语句进行优化，该如何进<br>行才是最优方案：<br><code>select id,username,password from tb_user where username = &#39;itcast&quot;;</code></p><blockquote><p>通过username和password建立一个联合索引，不需要回表查询</p></blockquote><h4 id="前缀索引"><a href="#前缀索引" class="headerlink" title="前缀索引"></a>前缀索引</h4><p>当字段类型为字符串(varchar, text等)时，有时候需要索引很长的字符串，这会让索引变得很大，查询时，浪费大量的磁盘IO，影响查询效率。此时可以只<strong>将字符串的一部分前缀，建立索引</strong>，这样<strong>可以大大节约索引空间</strong>，从而提高索引效率。</p><p>语法：</p><p><code>create index idx_XXX on table_name(column(n))</code></p><p>前缀长度：</p><p>可以根据索引的选择性来决定，而选择性是指不重复的索引值(基数)和数据表的记录总数的比值，索引选择性越高则查询效率越高，<strong>唯一索引的选择性是1</strong>，这是最好的索引选择性，性能也是最好的。<br><code>select count(distinct email)/count(*) from tb_user;</code><br><code>select count(distinct substring(email,1,5))/count(*) from tb_user;</code></p><ul><li>distinct：去重</li><li>count(*)：总行数</li><li>substring()：截取字符串函数</li></ul><h4 id="单列-amp-联合索引"><a href="#单列-amp-联合索引" class="headerlink" title="单列&amp;联合索引"></a>单列&amp;联合索引</h4><p>单列索引：即一个索引只包含单个列</p><p>联合索引：即一个索引包含多个列</p><p>存在单列索引<code>idx_user_phone</code>、<code>idx_user_name</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id, phone, name <span class="keyword">from</span> tb_user </span><br><span class="line"><span class="keyword">where</span> phone <span class="operator">=</span> <span class="string">&#x27;123456789&#x27;</span> <span class="keyword">and</span> name <span class="operator">=</span> <span class="string">&#x27;元哥&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>只走了<code>idx_user_phone</code>索引</p></blockquote><p>创建联合索引<code>idx_user_phone_name</code></p><p>执行上面的语句后，发现依然只走了<code>idx_user_phone</code>索引，有单列索引干扰</p><p>我们可以指定所使用的索引：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id, phone, name <span class="keyword">from</span> tb_user </span><br><span class="line">use index(idx_user_phone_name)</span><br><span class="line"><span class="keyword">where</span> phone <span class="operator">=</span> <span class="string">&#x27;123456789&#x27;</span> <span class="keyword">and</span> name <span class="operator">=</span> <span class="string">&#x27;元哥&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>走了联合索引idx_user_phone_name</p></blockquote><p>在业务中，如果存在多个查询条件，考虑针对查询字段建立索引时，<strong>建议建立联合索引</strong>，而非单列索引</p><h3 id="2-7-设计原则"><a href="#2-7-设计原则" class="headerlink" title="2.7 设计原则"></a>2.7 设计原则</h3><ol><li>针对于数据量较大，且查询比较频繁的表建立索引。</li><li>针对于常作为查询条件(where)、排序(order by)、分组(groupby) 操作的字段建立索引。</li><li>尽量选择区分度高的列作为索引，尽量建立唯一索引，区分度越高，使用索引的效率越高。</li><li>如果是字符串类型的字段，字段的长度较长，可以针对于字段的特点，建立前缀索引。</li><li>尽量使用联合索引，减少单列索引，查询时，联合素引很多时候可以覆盖索引，节省存储空问，避免回表，提高查询效率。</li><li>要控制索引的数量，索引不是多多益善，索引越多，维护索引结构的代价也就越大，会影响增删改的效率。</li><li>如果索引列不能存储NULL值，请在创建表时使用<code>NOT NULL</code>约束它。当优化器知道每列是否包含NULL值时，它可以更好地确定哪个索引最有效地用于查询。</li></ol><h4 id=""><a href="#" class="headerlink" title=""></a></h4></div><div class="story post-story"><h2 id="3-SQL优化"><a href="#3-SQL优化" class="headerlink" title="3.SQL优化"></a>3.SQL优化</h2><h3 id="3-1-插入数据"><a href="#3-1-插入数据" class="headerlink" title="3.1 插入数据"></a>3.1 插入数据</h3><h4 id="insert优化"><a href="#insert优化" class="headerlink" title="insert优化"></a>insert优化</h4><ul><li><p>批量插入</p><p>手动提交事务</p><p>主键顺序插入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> transaction;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;Cat&#x27;</span>),(<span class="number">3</span>,<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;Tom&#x27;</span>),(<span class="number">5</span>,<span class="string">&#x27;Cat&#x27;</span>),(<span class="number">6</span>,<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> th_test <span class="keyword">values</span>(<span class="number">7</span>,<span class="string">&#x27;Tom&#x27;</span>),(<span class="number">8</span>,<span class="string">&#x27;Cat&#x27;</span>),(<span class="number">9</span>,<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure></li><li><p>大批量插入数据</p><p>如果一次性需要插入大批量数据，使用insert语句插入性能较低，此时可以使用MySQL数据库提供的load指令进行插入。</p><p>操作如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#客户端连接服务端时，加上参数 --local-infile</span><br><span class="line">mysal --local-infile -u root -p</span><br><span class="line">#设置全局参数local_infile为1，开启从本地加载文件导入数据的开关</span><br><span class="line">set global local_infile = 1,</span><br><span class="line">#执行load指令将准备好的数据，加载到表结构中</span><br><span class="line">load data local infile &#x27;/root/sql1.log&#x27; into table `tb_user` fields terminated by &#x27;,&#x27; lines terminated by &#x27;/n&#x27;;</span><br></pre></td></tr></table></figure></li></ul><h3 id="3-2-主键优化"><a href="#3-2-主键优化" class="headerlink" title="3.2 主键优化"></a>3.2 主键优化</h3><h4 id="数据组织方式"><a href="#数据组织方式" class="headerlink" title="数据组织方式"></a>数据组织方式</h4><p>在InnoDB存储引擎中，表数据都是根据主键顺常组织存放的，这种存储方式的表称为家引组织表(index organized table IOT)。</p><p><img src="https://s2.loli.net/2022/12/06/OyXSt8omNKhjUGc.png" class="lazyload" data-srcset="https://s2.loli.net/2022/12/06/OyXSt8omNKhjUGc.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221206173530147.png"></p><h4 id="页分裂"><a href="#页分裂" class="headerlink" title="页分裂"></a>页分裂</h4><p>页可以为空，也可以填充一半，也可以填充100%。每个页包含了2~N行数据(如果一行数据多大，会行溢出)，根据主键排列。</p><ul><li><strong>主键顺序插入</strong>：</li></ul><p>依次插入</p><ul><li><strong>主键乱序插入</strong>：</li></ul><p><img src="https://s2.loli.net/2022/12/06/cSvy3dfM4CwoATR.png" class="lazyload" data-srcset="https://s2.loli.net/2022/12/06/cSvy3dfM4CwoATR.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221206180131502.png"></p><p><img src="https://s2.loli.net/2022/12/06/oVmNipcHlgDJvr5.png" class="lazyload" data-srcset="https://s2.loli.net/2022/12/06/oVmNipcHlgDJvr5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221206182524083.png"></p><h4 id="页合并"><a href="#页合并" class="headerlink" title="页合并"></a>页合并</h4><p>当删除一行记录时，实际上记录并没有被物理删除，只是记录被标记(flaged)为删除井且它的空间变得允许被其他记录声明使用。</p><p>当页中删除的记录达到 MERGE_THRESHOLD(合并页的阈值，默认为页的50%，可以自己设置)，InnoDB会开始寻找最靠近的页(前或后)看看是否可以将两个页合并以优化空间使用。</p><p><img src="https://s2.loli.net/2022/12/06/QdVOT4ujy87o5rW.png" class="lazyload" data-srcset="https://s2.loli.net/2022/12/06/QdVOT4ujy87o5rW.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221206183525291.png"></p><p><img src="https://s2.loli.net/2022/12/06/xJhRo7UGaKTtB43.png" class="lazyload" data-srcset="https://s2.loli.net/2022/12/06/xJhRo7UGaKTtB43.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221206183701315.png"></p><h4 id="主键设计原则"><a href="#主键设计原则" class="headerlink" title="主键设计原则"></a>主键设计原则</h4><ul><li>满足业务需求的情况下，尽量降低主键的长度。</li><li>插入数据时，尽量选择顺序插入，<strong>选择使用AUTO_INCREMENT自增主键</strong>。</li><li>尽量不要使用UUID做主键或者是其他自然主键，如身份证号。</li><li>业务操作时，避免对主键的修改。</li></ul><h3 id="3-3-order-by优化"><a href="#3-3-order-by优化" class="headerlink" title="3.3 order by优化"></a>3.3 order by优化</h3><ul><li>Using filesort：通过表的索引或全表扫描，读取满足条件的数据行，然后在排序缓冲区sort buffer中完成排序操作，所有不是通过索引直接返回排序结果的排序都叫 FileSort 排序。</li><li>Using index ：通过有序索引顺序扫描直接返回有序数据，这种情况即为using index，不需要额外排序，操作效率高。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#没有创建索引时，根据age,phone进行排序</span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> tb _user <span class="keyword">order</span> <span class="keyword">by</span> age, phone;</span><br><span class="line">#创建索引</span><br><span class="line"><span class="keyword">create</span> index idx_user_age_phone <span class="keyword">on</span> tb_user(age,phone);</span><br><span class="line"></span><br><span class="line">#创建索引后，根据age,phone进行升序排序</span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> th _user <span class="keyword">order</span> <span class="keyword">by</span> age, phone;</span><br><span class="line">#创建索引后，根据age,phone进行降序排序</span><br><span class="line">explain <span class="keyword">select</span> id, age,phone <span class="keyword">from</span> th_user <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">desc</span>, phone <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><ul><li>只有字段全都是升序排列或者全都是降序排列时，idx_user_age_phone索引生效，为Using index</li></ul><p>如果一个升序一个降序或者一个降序一个升序，就需要重新创建一个新索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#没有创建索引时，根据age升序,phone降序进行排序</span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> tb _user <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>, phone <span class="keyword">desc</span>;</span><br><span class="line">#创建索引</span><br><span class="line"><span class="keyword">create</span> index idx_user_age_phone_ad <span class="keyword">on</span> tb_user(age <span class="keyword">asc</span>,phone <span class="keyword">desc</span>);</span><br><span class="line"></span><br><span class="line">#创建索引后，根据age升序,phone降序进行排序，为<span class="keyword">Using</span> index</span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> tb _user <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>, phone <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><p><strong>总结</strong></p><ul><li>根据排序字段建立合适的索引，多字段排序时，也遵循最左前缀法则。</li><li>尽量使用覆盖索引。</li><li>多字段排序，一个升序一个降序，此时需要注意联合索引在创建时的规则(ASC&#x2F;DESC)。</li><li>如果不可避免的出现<strong>filesort</strong>，大数据量排序时，可以适当增大排序缓冲区大小 sort_ buffer_size(默认256k）。</li></ul><h3 id="3-4-group-by优化"><a href="#3-4-group-by优化" class="headerlink" title="3.4 group by优化"></a>3.4 group by优化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#执行分组操作，根据profession字段分组</span><br><span class="line">explain <span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> th_user <span class="keyword">group</span> <span class="keyword">by</span> profession;</span><br><span class="line"></span><br><span class="line">#创建索引</span><br><span class="line"><span class="keyword">Create</span> index id_user_pro_age_sta <span class="keyword">on</span> tb_user(profession,age,status);</span><br><span class="line"></span><br><span class="line">#以下均会走索引</span><br><span class="line">#执行分组操作，根据profession字段分组</span><br><span class="line">explain <span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_user <span class="keyword">group</span> <span class="keyword">by</span> profession;</span><br><span class="line">#执行分组操作，根据profession字段分组</span><br><span class="line">explain <span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_user <span class="keyword">group</span> <span class="keyword">by</span> profession,age;</span><br><span class="line">#执行分组操作，根据profession字段分组</span><br><span class="line">explain <span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_user <span class="keyword">where</span> profession <span class="operator">=</span> <span class="string">&#x27;软件工程&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> age;</span><br></pre></td></tr></table></figure><p><strong>总结</strong></p><ul><li>在分组操作时，可以通过索引来提高效率</li><li>分组操作时，<strong>索引的使用也是满足最左前缀法则的</strong></li></ul><h3 id="3-5-limit优化"><a href="#3-5-limit优化" class="headerlink" title="3.5 limit优化"></a>3.5 limit优化</h3><p>一个常见又非常头疼的问题就是 limit 2000000,10，此时需要MySQL排序前2000010 记录，仅仅返回2000000-2000010的记录，其他记录丢弃，查询排序的代价非常大。</p><p>优化思路：一般分页查询时，通过创建 <strong>覆盖索引</strong> 能够比较好地提高性能，可以<strong>通过覆盖索引加子查询形式</strong>进行优化。</p><p>优化前：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_sku <span class="keyword">order</span> <span class="keyword">by</span> id limit <span class="number">2000000</span>,<span class="number">10</span> </span><br></pre></td></tr></table></figure><p>优化后：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> t.<span class="operator">*</span> <span class="keyword">from</span> tb_sku t, (<span class="keyword">select</span> id <span class="keyword">from</span> tb_sku <span class="keyword">order</span> <span class="keyword">by</span> id limit <span class="number">2000000</span>,<span class="number">10</span>) a <span class="keyword">where</span> t.id <span class="operator">=</span> a.id</span><br></pre></td></tr></table></figure><h3 id="3-6-count优化"><a href="#3-6-count优化" class="headerlink" title="3.6 count优化"></a>3.6 count优化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_user;</span><br></pre></td></tr></table></figure><ul><li>MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行 count(*)的时候会直接返回这个数，效率很高</li><li>InnoDB 引擎就麻烦了，它执行 count(*)的时候，需要把数据一行一行地从引擎里面读出来，然后累积数</li></ul><p>优化思路：自己计数。</p><h4 id="count的几种用法"><a href="#count的几种用法" class="headerlink" title="count的几种用法"></a>count的几种用法</h4><p>count(是一个聚合函数，对于返回的结果集，一行行地判断，如果count 函数的参数不是 NULL，累计值就加1，否则不加，最后返回累计值。</p><p>用法：count(*)、count(主键)、count(字段)、count(1)</p><ul><li><p>count(主键)</p><p>InnoDB 引擎会遍历整张表，把每一行的 主键id 值都取出来，返回给服务层。服务层拿到主键后，直接按行进行累加(主键不可能为nul)。</p></li><li><p>count(字段)</p><ul><li>没有not null 约束：InnoDB 引1擎会遍历整张表把每一行的字段值都取出来，返回给服务层，服务层判断是否为null，不为null，计数累加。</li><li>有not null 约束：InnoDB 引擎会遍历整张表把每一行的字段值都取出来，返回给服务层，直接按行进行累加。</li></ul></li><li><p>count(1)</p><p>InnoDB 引擎遍历整张表，但不取值。服务层对于返回的每一行，放一个数字”1”进去，直接按行进行累加。</p></li><li><p>count(*)</p><p>InnoDB引擎并不会把全部字段取出来，而是专门做了优化，不取值，服务层直接按行进行累加。</p></li></ul><p>按照效率排序的话，<code>count(字段) &lt; count(主键id) &lt; count(1) ≈ count(*)</code>，所以尽量使用 *<em>count(</em>)**。</p><h3 id="3-7-update优化"><a href="#3-7-update优化" class="headerlink" title="3.7 update优化"></a>3.7 update优化</h3><p>InnoDB的行锁是针对索引加的锁，不是针对记录加的锁</p><p>如果该索引失效或者没有索引，则会从行锁升级为表锁。</p></div><div class="story post-story"><h2 id="4-视图"><a href="#4-视图" class="headerlink" title="4.视图"></a>4.视图</h2><p>视图(view)是一种虛拟存在的表。视图中的数据并不在数据库中实际存在，行和列数据来自定义视图的查询中使用的表，并且是在使用视图时动态生成的。</p><p>通俗的讲，视图只保存了查询的SQL逻辑，不保存查询结果。所以我们在创建视图的时候，主要的工作就落在创建这条SQL查询语句上。</p><h3 id="4-1-基础语法"><a href="#4-1-基础语法" class="headerlink" title="4.1 基础语法"></a>4.1 基础语法</h3><p>创建视图：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> [<span class="keyword">or</span> replace] <span class="keyword">view</span> 视图名[(列名列表)] <span class="keyword">as</span> <span class="keyword">select</span>语句</span><br></pre></td></tr></table></figure><p>查询视图：</p><ul><li><p>查看创建视图语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">view</span> 视图名称;</span><br></pre></td></tr></table></figure></li><li><p>查看视图数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 视图名称…;</span><br></pre></td></tr></table></figure></li></ul><p>修改视图：</p><ul><li><p>方式一：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> [<span class="keyword">or</span> replace] <span class="keyword">view</span> 视图名[(列名列表)] <span class="keyword">as</span> <span class="keyword">select</span>语句</span><br></pre></td></tr></table></figure></li><li><p>方式二：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">view</span> 视图名[(列名列表)] <span class="keyword">as</span> <span class="keyword">select</span>语句</span><br></pre></td></tr></table></figure></li></ul><p>删除视图：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">view</span> [if <span class="keyword">exists</span>] 视图名称 [,视图名称]</span><br></pre></td></tr></table></figure><h3 id="4-2-检查选项"><a href="#4-2-检查选项" class="headerlink" title="4.2 检查选项"></a>4.2 检查选项</h3><p>当使用WITH CHECK OPTION子句创建视图时，MySQL会通过视图检查正在更改的每个行，例如插入，更新，删除，以使其符合视图的定义。MySQL允许基于另一个视图创建视图，它还会检查依赖视图中的规则以保持一致性。为了确定检查的范围，MySQL提供了两个选项：CASCADED和LOCAL,默认值为CASCADED。</p><p>CASCADED示例：</p><p>第一种情况：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> stu_v_1 <span class="keyword">as</span> <span class="keyword">select</span> id,name <span class="keyword">from</span> v1 <span class="keyword">where</span> id <span class="operator">&lt;=</span><span class="number">20</span> <span class="keyword">with</span> <span class="keyword">cascaded</span> <span class="keyword">check</span> option</span><br></pre></td></tr></table></figure><p>执行插入语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stu_v_1 <span class="keyword">values</span>(<span class="number">30</span>,<span class="string">&#x27;Tom&#x27;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>会依据条件<code>where id &lt;=10</code>进行检查，如果不符合条件则报错</p></blockquote><p>第二种情况：</p><p>修改视图stu_v_1：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> stu_v_1 <span class="keyword">as</span> <span class="keyword">select</span> id,name <span class="keyword">from</span> v1 <span class="keyword">where</span> id <span class="operator">&lt;=</span><span class="number">20</span></span><br></pre></td></tr></table></figure><p>依据stu_v_1视图建立视图stu_v_2：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> stu_v_2 <span class="keyword">as</span> <span class="keyword">select</span> id,name <span class="keyword">from</span> stu_v_1 <span class="keyword">where</span> id <span class="operator">&gt;=</span><span class="number">10</span> <span class="keyword">with</span> <span class="keyword">cascaded</span> <span class="keyword">check</span> option</span><br></pre></td></tr></table></figure><p>执行插入语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stu_v_2 <span class="keyword">values</span>(<span class="number">30</span>,<span class="string">&#x27;Tom&#x27;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>此插入语句符合视图stu_v_2的条件，但是无论stu_v_1是否有检查选项，都会进行对stu_v_1条件的检查，所以不符合报错</p></blockquote><p>LOCAL示例：</p><p>第一种情况与CASCADED相同</p><p>第二种情况：</p><p>修改视图stu_v_1：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> stu_v_1 <span class="keyword">as</span> <span class="keyword">select</span> id,name <span class="keyword">from</span> v1 <span class="keyword">where</span> id <span class="operator">&lt;=</span><span class="number">20</span></span><br></pre></td></tr></table></figure><p>依据stu_v_1视图建立视图stu_v_2：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> stu_v_2 <span class="keyword">as</span> <span class="keyword">select</span> id,name <span class="keyword">from</span> stu_v_1 <span class="keyword">where</span> id <span class="operator">&gt;=</span><span class="number">10</span> <span class="keyword">with</span> <span class="keyword">local</span> <span class="keyword">check</span> option</span><br></pre></td></tr></table></figure><p>执行插入语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stu_v_2 <span class="keyword">values</span>(<span class="number">30</span>,<span class="string">&#x27;Tom&#x27;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>此插入语句符合视图stu_v_2的条件，会对stu_v_1进行检查是否有检查选项。如果有，则对stu_v_1进行条件检查；如果没有，则不会对stu_v_1进行检查，所以不会报错</p></blockquote><h3 id="4-3-更新及作用"><a href="#4-3-更新及作用" class="headerlink" title="4.3 更新及作用"></a>4.3 更新及作用</h3><p>视图的更新：</p><p>要使视图可更新，视图中的行与基础表中的行之间必须存在一对一的关系。如果视图包含以下任何一项，则该视图不可更新：</p><ol><li>聚合函数或窗口函数(SUM()、MIN()、MAX()、COUNT()等)</li><li>DISTINCT</li><li>GROUP BY</li><li>HAVING</li><li>UNION或者UNION ALL</li></ol><p>视图的作用：</p><blockquote><ul><li><p>简单：</p><p>视图不仅可以简化用户对数据的理解，也可以简化他们的操作。那些被经常使用的查询可以被定义为视图，从而使得用户不必为以后的操作每次指定全部的条件。</p></li><li><p>安全：</p><p>数据库可以授权，但不能授权到数据库特定行和特定的列上。通过视图用户只能查询和修改他们所能见到的数据</p></li><li><p>数据独立：</p><p>视图可帮助用户屏蔽真实表结构变化带来的影响。</p></li></ul></blockquote></div><div class="story post-story"><h2 id="5-存储过程"><a href="#5-存储过程" class="headerlink" title="5.存储过程"></a>5.存储过程</h2><p>存储过程是事先经过编译并存储在数据库中的一段SQL语句的集合，调用存储过程可以简化应用开发人员的很多工作，减少数据在数据库和应用服务器之间的传输，对于提高数据处理的效率是有好处的。</p><p>存储过程思想上很简单，就是数据库SQL语言层面的代码封装与重用。</p><p>特点：</p><ul><li>封装，复用</li><li>可以接收参数，也可以返回数据</li><li>减少网络交互，效率提升</li></ul><h3 id="5-1-基础语法"><a href="#5-1-基础语法" class="headerlink" title="5.1 基础语法"></a>5.1 基础语法</h3><p>创建：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> 存储过程名称([参数列表])</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SQL</span>语句;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><blockquote><p>注意：在命令行中，执行创建存储过程的SQL时，需要通过关键字<code>delimiter</code>指定SQL语句的结束符。</p></blockquote><p>调用：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> 存储过程名称([参数])</span><br></pre></td></tr></table></figure><p>查看：</p><ul><li><p>查询指定数据库的存储过程及状态信息：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> INFORMATION_SCHEMA.ROUTINES <span class="keyword">where</span> ROUTINE_SCHEMA<span class="operator">=</span><span class="string">&#x27;XXX&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p>查询某个存储过程的定义：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">procedure</span> 存储过程名称;</span><br></pre></td></tr></table></figure></li></ul><p>删除：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> [if <span class="keyword">exists</span>] 存储过程名称;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="6-触发器"><a href="#6-触发器" class="headerlink" title="6.触发器"></a>6.触发器</h2><h3 id="6-1-介绍"><a href="#6-1-介绍" class="headerlink" title="6.1 介绍"></a>6.1 介绍</h3><p>触发器是与表有关的数据库对象，指在<code>insert</code>&#x2F;<code>update</code>&#x2F;<code>delete</code>之前或之后，触发并执行触发器中定义的SQL语句集合。触发器的这种特性可以协助应用在数据库端确保数据的完整性，日志记录，数据校验等操作。</p><p>使用别名OLD和NEW来引用触发器中发生变化的记录内容，这与其他的数据库是相似的。现在触发器还只支持行级触发，不支持语句级触发。</p><table><thead><tr><th>触发器类型</th><th>NEW和OLD</th></tr></thead><tbody><tr><td>INSERT型触发器</td><td>NEW表示将要或者已经新增的数据</td></tr><tr><td>UPDATE型触发器</td><td>OLD表示修改之前的数据，NEW表示将要或已经修改后的数据</td></tr><tr><td>DELETE型触发器</td><td>OLD表示将要或者已经别除的数据</td></tr></tbody></table><h3 id="6-2-基础语法"><a href="#6-2-基础语法" class="headerlink" title="6.2 基础语法"></a>6.2 基础语法</h3><p>创建：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger_name</span><br><span class="line">BEFORE<span class="operator">/</span>AFTER <span class="keyword">INSERT</span><span class="operator">/</span><span class="keyword">UPDATE</span><span class="operator">/</span><span class="keyword">DELETE</span></span><br><span class="line"><span class="keyword">ON</span> tbl_name <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span><span class="comment">--行级触发器</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">trigger_stmt</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure><p>查看：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> TRIGGERS;</span><br></pre></td></tr></table></figure><p>删除：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> [schema_name.]trigger_name;<span class="comment">--如果没有指定schema_name,默认为当前数据库。</span></span><br></pre></td></tr></table></figure><h3 id="6-3-案例"><a href="#6-3-案例" class="headerlink" title="6.3 案例"></a>6.3 案例</h3><p>通过触发器将记录tb_user表的数据变更日志插入到日志表user_logs中，包含增加，修改，删除：</p><p>user_logs表结构：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_logs(</span><br><span class="line">id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span> auto increment,</span><br><span class="line">operation <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作类型insert/update/delete&#x27;</span>,</span><br><span class="line">operate_time datetime <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作时间&#x27;</span>，</span><br><span class="line">operate_id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作的ID&#x27;</span>,</span><br><span class="line">operate_params <span class="type">varchar</span>(<span class="number">500</span>)comment <span class="string">&#x27;操作参数&#x27;</span>,</span><br><span class="line"><span class="keyword">primary</span> key(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">)engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure><h4 id="insert类型"><a href="#insert类型" class="headerlink" title="insert类型"></a>insert类型</h4><p>创建tb_user_insert_trigger触发器：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> tb_user_insert_trigger</span><br><span class="line">after <span class="keyword">insert</span> <span class="keyword">on</span> tb_user <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_logs(id,operation,operate_time,operate_id,operate_params) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="keyword">null</span>,<span class="string">&#x27;insert&#x27;</span>,now(),new.id,concat(<span class="string">&#x27;插入的数据内容为：id=&#x27;</span>,new.id, <span class="string">&#x27;,name=&#x27;</span>,new.name, <span class="string">&#x27;,phone=&#x27;</span>,new.phone, <span class="string">&#x27;,email=&#x27;</span>,new.email, <span class="string">&#x27;,profession=&#x27;</span>,new.profession));</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><ul><li>new为插入的数据</li><li>concat() 函数用于将多个字符串连接起来，形成一个单一的字符串</li></ul><h4 id="update类型"><a href="#update类型" class="headerlink" title="update类型"></a>update类型</h4><p>创建tb_user_update_trigger触发器：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> tb_user_insert_trigger</span><br><span class="line">after <span class="keyword">update</span> <span class="keyword">on</span> tb_user <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_logs(id,operation,operate_time,operate_id,operate_params) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="keyword">null</span>,<span class="string">&#x27;update&#x27;</span>,now(),new.id,concat(<span class="string">&#x27;更新之后的数据内容为：id=&#x27;</span>,old.id, <span class="string">&#x27;,name=&#x27;</span>,old.name, <span class="string">&#x27;,phone=&#x27;</span>,old.phone, <span class="string">&#x27;,email=&#x27;</span>,old.email, <span class="string">&#x27;,profession=&#x27;</span>,old.profession, <span class="string">&#x27;|更新之后的数据内容为：id=&#x27;</span>,new.id, <span class="string">&#x27;,name=&#x27;</span>,new.name, <span class="string">&#x27;,phone=&#x27;</span>,new.phone, <span class="string">&#x27;,email=&#x27;</span>,new.email, <span class="string">&#x27;,profession=&#x27;</span>,new.profession));</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><ul><li>old为更新之前的数据</li></ul><h4 id="delete类型"><a href="#delete类型" class="headerlink" title="delete类型"></a>delete类型</h4><p>创建tb_user_delete_trigger触发器：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> tb_user_delete_trigger</span><br><span class="line">after <span class="keyword">delete</span> <span class="keyword">on</span> tb_user <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_logs(id,operation,operate_time,operate_id,operate_params) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="keyword">null</span>,<span class="string">&#x27;update&#x27;</span>,now(),new.id,concat(<span class="string">&#x27;删除的数据内容为：id=&#x27;</span>,old.id, <span class="string">&#x27;,name=&#x27;</span>,old.name, <span class="string">&#x27;,phone=&#x27;</span>,old.phone, <span class="string">&#x27;,email=&#x27;</span>,old.email, <span class="string">&#x27;,profession=&#x27;</span>,old.profession));</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="7-锁"><a href="#7-锁" class="headerlink" title="7.锁"></a>7.锁</h2><h3 id="7-1-介绍"><a href="#7-1-介绍" class="headerlink" title="7.1 介绍"></a>7.1 介绍</h3><p>锁是计算机协调多个进程或线程并发访问某一资源的机制。在数据库中，除传统的计算资源(CPU、RAM、I&#x2F;O)的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。</p><h3 id="7-2-全局锁"><a href="#7-2-全局锁" class="headerlink" title="7.2 全局锁"></a>7.2 全局锁</h3><p>全局锁就是对整个数据库实例加锁，加锁后整个实例就处于只读状态，后续的DML(对数据的增删改查)的写语句，DDL(对数据库索引的增删改查)语句，已经更新操作的事务提交语句都将被阻塞。</p><p>其典型的使用场景是做全库的逻辑备份，对所有的表进行锁定，从而获取一致性视图，保证数据的完整性</p><p>添加全局锁：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush tables <span class="keyword">with</span> read lock;</span><br></pre></td></tr></table></figure><p>在<strong>非MySQL命令行中</strong>输入地址、账号、密码，将数据库存放到指定的文件中：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h 192.168.200.001 -uroot -p1234 user &gt; D:/user.sql</span><br></pre></td></tr></table></figure><p>解除全局锁：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlock tables;</span><br></pre></td></tr></table></figure><p>特点：</p><p>数据库中加全局锁，是一个比较重的操作，存在以下问题：</p><ul><li>如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆。</li><li>如果在从库上备份，那么在备份期间从库不能执行主库同步过来的二进制日志(binlog),会导致主从延迟。</li></ul><p>在InnoDB引擎中，我们可以在备份时加上参数<code>--single-transaction</code>参数来完成不加锁的一致性数据备份。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump --single-transaction -uroot -p123456 db &gt; db.sql</span><br></pre></td></tr></table></figure><h3 id="7-3-表级锁"><a href="#7-3-表级锁" class="headerlink" title="7.3 表级锁"></a>7.3 表级锁</h3><p>表级锁，每次操作锁住整张表。锁定粒度大，发生锁冲突的概率最高，并发度最低。应用在MyISAM、InnoDB、BDB等存储引擎中。</p><p>对于表级锁，主要分为以下三类：</p><ul><li>表锁</li><li>元数据锁(meta data lock,MDL)</li><li>意向锁</li></ul><h4 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h4><p>对于表锁，分为两类：</p><ul><li>表共享读锁(read lock)：当前客户端只可以读，不可以写，其他客户端也一样</li><li>表独占写锁(write lock)：当前客户端既可以读，又可以写，其他客户端都不可以</li></ul><p>语法：</p><ul><li><p>加锁：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lock tables 表名 read<span class="operator">/</span>write;</span><br></pre></td></tr></table></figure></li><li><p>释放锁：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlock tables;<span class="operator">/</span>与客户端断开连接</span><br></pre></td></tr></table></figure></li></ul><h4 id="元数据锁"><a href="#元数据锁" class="headerlink" title="元数据锁"></a>元数据锁</h4><p>MDL加锁过程是系统自动控制，无需显式使用，在访问一张表的时候会自动加上。MDL锁主要作用是维护表元数据的数据一致性，在表上有活动事务的时候，不可以对元数据进行写入操作。为了避免DML与DDL冲突，保证读写的正确性。</p><p>在MySQL5.5中引入了MDL,当对一张表进行增删改查的时候，加MDL读锁（共享）；当对表结构进行变更操作的时候，加MDL写锁(排他)。</p><table><thead><tr><th>对应SQL</th><th>锁类型</th><th>说明</th></tr></thead><tbody><tr><td>lock tables xxx read&#x2F;write</td><td>SHARED_READ_ONLY&#x2F;SHARED_NO_READ_WRITE</td><td></td></tr><tr><td>select,select … lock in share mode</td><td>SHARED_READ</td><td>与SHARED_READ、SHARED_WRITE兼容，与EXCLUSIVE互斥</td></tr><tr><td>insert,update、delete、select,for update</td><td>SHARED_WRITE</td><td>与SHARED_READ、SHARED_WRITE兼容，与EXCLUSIVE互斥</td></tr><tr><td>alter table…</td><td>EXCLUSIVE</td><td>与其他的MDL都互斥</td></tr></tbody></table><ul><li>大致就是修改表结构时，无法增删改查；增删查改时，无法修改表结构</li></ul><h4 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h4><p>为了避免DML在执行时，加的行锁与表锁的冲突，在InnoDB中引入了意向锁，使<strong>得表锁不用检查每行数据是否加锁</strong>，使用意向锁来减少表锁的检查。</p><p>在加入<strong>行锁</strong>后，会自动添加<strong>意向锁</strong>，<strong>如果存在意向锁那么添加表锁就会阻塞等待</strong>，使得不需要检查是否存在行锁；解除行锁后，自动解除意向锁，就可以上表锁了</p><p>意向锁分为：</p><ol><li><p>意向共享锁(IS)：由语句select..lock in share mode添加。</p><ul><li>与表锁共享锁(read)兼容，与表锁排它锁(write)互斥。</li></ul></li><li><p>意向排他锁(lX)：由insert、update、delete、select..for update添加。</p><ul><li>与表锁共享锁(read)及排它锁(write)都互斥。意向锁之间不会互斥。</li></ul></li></ol><h3 id="7-4-行级锁"><a href="#7-4-行级锁" class="headerlink" title="7.4 行级锁"></a>7.4 行级锁</h3><p>行级锁，每次操作锁住对应的行数据。锁定粒度最小，发生锁冲突的概率最低，并发度最高。应用在InnoDB存储引擎中。</p><p>InnoDB的数据是基于索引组织的，行锁是通过对索引上的索引项加锁来实现的，而不是对记录加的锁。对于行级锁，主要分为以下三类：</p><ol><li>行锁(Record Lock)：锁定单个行记录的锁，防止其他事务对此行进行update和delete。在RC、RR隔离级别下都支持。</li><li>间隙锁(Gap Lock)：锁定索引记录间隙（不含该记录），确保索引记录间隙不变，防止其他事务在这个间隙进行insert,产生幻读。在RR隔离级别下都支持。<ul><li>幻读：事务A修改了表中所有信息，此时事务B插入一条数据，在事务A提交时发现有一条未修改的数据</li></ul></li><li>临键锁(Next-Key Lock)：行锁和间隙锁组合，同时锁住数据，并锁住数据前面的间隙Gap。在RR隔离级别下支持。</li></ol><h4 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h4><p>InnoDB实现了以下两种类型的行锁：</p><ol><li>共享锁(S)：允许一个事务去读一行，阻止其他事务获得相同数据集的排它锁。</li><li>排他锁(X)：允许获取排他锁的事务更新数据，阻止其他事务获得相同数据集的共享锁和排他锁。</li></ol><p>共享锁与共享锁之间兼容，排他锁与共享锁以及自己都不兼容</p><table><thead><tr><th>SQL</th><th>行锁类型</th><th>说明</th></tr></thead><tbody><tr><td>insert</td><td>排他锁</td><td>自动加锁</td></tr><tr><td>update</td><td>排他锁</td><td>自动加锁</td></tr><tr><td>delete</td><td>排他锁</td><td>自动加锁</td></tr><tr><td>select</td><td>无</td><td></td></tr><tr><td>select … lock in share mode</td><td>共享锁</td><td>手动加锁</td></tr><tr><td>select … for update</td><td>排他锁</td><td>手动加锁</td></tr></tbody></table><h4 id="间隙锁-amp-临界锁"><a href="#间隙锁-amp-临界锁" class="headerlink" title="间隙锁&amp;临界锁"></a>间隙锁&amp;临界锁</h4><p>默认情况下，InnoDB在REPEATABLE READ事务隔离级别运行，InnoDB使用next-key锁(临界锁)进行搜索和索引扫描，以防止幻读。</p><ol><li><p>索引上的等值查询（唯一索引），给不存在的记录加锁时，优化为间隙锁。</p><ul><li><p>表中的数据的id依次为1、3、5</p><p>此时一个客户端要查询一个不存在的记录要查询id为4，那么就会加上间隙锁，锁住3和5之间</p><p>防止此时另一个客户端插入一个id为4的记录，导致发生幻读</p></li></ul></li><li><p>索引上的等值查询(普通索引)，向右遍历时最后一个值不满足查询需求时，next-key lock退化为间隙锁。</p></li><li><p>索引上的范围查询(唯一索引)，会访问到不满足条件的第一个值为止。</p></li></ol><p>注意：间隙锁唯一目的是防止其他事务插入间隙。间隙锁可以共存，一个事务采用的间隙锁不会阻止另一个事务在同一间隙上采用间隙锁。</p></div><div class="story post-story"><h2 id="8-InnoDB引擎"><a href="#8-InnoDB引擎" class="headerlink" title="8.InnoDB引擎"></a>8.InnoDB引擎</h2><h3 id="8-1-逻辑存储结构"><a href="#8-1-逻辑存储结构" class="headerlink" title="8.1 逻辑存储结构"></a>8.1 逻辑存储结构</h3><p><img src="https://s2.loli.net/2022/12/06/OyXSt8omNKhjUGc.png" class="lazyload" data-srcset="https://s2.loli.net/2022/12/06/OyXSt8omNKhjUGc.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221206173530147.png"></p><ul><li><p>Tablespace：表空间(ibd文件)，一个ysql实例可以对应多个表空间，用于存储记录、索引等数据。</p></li><li><p>Segment：段，分为数据段(Leaf node segment)、索引段(Non-leaf node segment)、回滚段(Rollback segment),InnoDB是索引组织表，数据段就是B+树的叶子节点，索引段即为B+树的非叶子节点。段用来管理多个Extent(区)。</p></li><li><p>Extent：区，表空间的单元结构，每个区的大小为1M。默认情况下，InnoDB存储引擎页大小为16K,即一个区中一共有64个连续的页。</p></li><li><p>Page：页，是InnoDB存储引擎磁盘管理的最小单元，每个页的大小默认为16KB。为了保证页的连续性，InnoDB存储引擎每次从磁盘申请4-5个区。</p></li><li><p>Row：行，InnoDB存储引擎数据是按行进行存放的。</p></li></ul><h3 id="8-2-架构"><a href="#8-2-架构" class="headerlink" title="8.2 架构"></a>8.2 架构</h3><p>MySQL5.5版本开始，默认使用InnoDB存储引擎，它擅长事务处理，具有崩溃恢复特性，在日常开发中使用非常广泛。</p><p>下面是InnoDB架构图，左侧为内存结构，右侧为磁盘结构：</p><img src="https://s2.loli.net/2023/01/17/tK8HjiSqAhx2QC1.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/17/tK8HjiSqAhx2QC1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230117140744367.png" style="zoom:67%;" /><h4 id="内存结构"><a href="#内存结构" class="headerlink" title="内存结构"></a>内存结构</h4><ul><li><p>Buffer Pool：缓冲池是主内存中的一个区域，里面可以缓存磁盘上经常操作的真实数据，在执行增改查操作先操作缓冲池中的数据(若缓冲池没有数据，则从磁盘加载并缓存)，然后再以一定频率刷新到磁盘，从而减少磁盘的I&#x2F;O操作，快处理速度。</p><p>缓冲池以Page页为单位，底层采用链表结构管理Page。根据状态，将Page分为三种类型：</p><ul><li><p>free page：未发使用。</p></li><li><p>clean page：被使用page，数据没有被修改过.</p></li><li><p>dirty page：脏页，被使用page， 数据被修改过，也中数据与磁盘的数据产生了不一致。</p></li></ul></li><li><p>Change Buffer：更改缓冲区针对于非唯一 二级索引页)，在执行DML语句时，如果这些数据Page没有在Buffer Pool中，不会直接操作磁盘，而会将数据变更存在更改缓冲区Change Buffer中，在未来数据被读取时，再将数据合并恢复到Buffer Pool中，再将合并后的数据刷新到磁盘中。</p><p>Change Buffer的意义是什么？</p><ul><li>与聚集索引不同，二级索引通常是非唯一的，并且以相对随机的顺序插入二级索引。同样，删除和更新可能会影响索引树中不相邻的二级索引页，如果每一次都操作磁盘，会造成大量的磁盘I&#x2F;O。有了Change Buffer之后，我们可以在缓冲池中进行合并处理，从而减少磁盘I&#x2F;O。</li></ul></li><li><p>Adaptive Hash Index：自适应hash索引，用于优化对Buffer Pool数据的查询(只能用于等值匹配)。InnoDB存储引攀会监控对表上各索引页的查询，如果观察到hash索引可以提升速度，则建立hash索引，称之为自适应hash索引。</p><p>自适应哈希素引，无需人工干预，是系统根据情况自动完成。</p><p>参数：adaptive_hash_index</p></li><li><p>Log Buffer：日志缓冲区，用来保存要写入到磁盘中的log日志数据(redo log、undo log)，默认大小为16MB，日志缓冲区的日志会定期别新到磁盘中。如果需要更新、插入或删除许多行的事务，增加日志缓冲区的大小可以节省磁盘I&#x2F;O。</p><p>参数：</p><ul><li><p>innodb_log_buffer_size:缓冲区大小</p></li><li><p>innodb_flush_log_at_trx_commit:日志别新到磁盘时机</p></li></ul></li></ul><h4 id="磁盘结构"><a href="#磁盘结构" class="headerlink" title="磁盘结构"></a>磁盘结构</h4><ul><li><p>System Tablespace：系统表空间是更改缓冲区的存储区域。如果表是在系统表空间而不是每个表文件或通用表空间中创建的，它也可能包含表和索引数据。(在MySQL5.x版本中还包含InnoDB数据字典、undolog等)</p><p>参数：innodb_data_file_path</p></li><li><p>File-Per-Table Tablespaces：每个表的文件表空间包含单个InnoDB表的数据和索引，并存储在文件系统上的单个数据文件中。</p><p>参数：innodb_file_per_table</p></li><li><p>General Tablespaces：通用表空间，需要通过<code>CREATE TABLESPACE</code>语法创建通用表空间，在创建表时，可以指定该表空间。</p><p>创建表空间：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>SPACE xxx <span class="keyword">ADD</span><span class="comment">--指定表空间名称</span></span><br><span class="line">DATAFILE <span class="string">&#x27;file_name&#x27;</span><span class="comment">--指定表空间关联表空间文件</span></span><br><span class="line">ENGINE <span class="operator">=</span> engine_name;<span class="comment">--指定存储引擎</span></span><br></pre></td></tr></table></figure><p>创建表时指定表空间：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">user</span>(</span><br><span class="line">...</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> engine_name TABLESPACE ts_Rame;<span class="comment">--指定表空间</span></span><br></pre></td></tr></table></figure></li><li><p>Undo Tablespaces：辙销表空间，MySQL实例在初始化时会自动创建两个默认的undo表空间(初始大小16M)，用于存储undo log日志。</p></li><li><p>Temporary Tablespaces：InnoDB使用会话临时表空间和全局临时表空间。存储用户创建的临时表等数据。</p></li><li><p>Doublewrite Buffer Files：双写缓冲区，innoDB引擎将数据页从Buffer Pool刷新到磁盘前，先将数据页写入双写缓冲区文件中，便于系统异常时恢复数据。</p></li><li><p>Redo Log：重做日志，是用来实现事务的持久性。</p><p>该日志文件由两部分组成：重做日志缓冲(redo log buffer)以及重做日志文件(redo log)，前者是在内存中，后者在磁盘中。当事务提交之后会把所有修改信息都会存到该日志中，用于在刷新脏页到磁盘时，发生错误时，进行数据恢复使用。</p></li></ul><h4 id="后台线程"><a href="#后台线程" class="headerlink" title="后台线程"></a>后台线程</h4><ol><li><p>Master Thread</p><p>核心后台线程，负责调度其他线程，还负责将缓冲池中的数据异步刷新到磁盘中，保持数据的一致性，<br>还包括脏页的刷新、合并插入缓存、undo页的回收。</p></li><li><p>IO Thread</p><p>在InnoDB存储引擎中大量使用了AIO来处理I&#x2F;O请求，这样可以极大地提高数据库的性能，而IO Thread主要负责这些I&#x2F;O请求的回调。</p><table><thead><tr><th>线程类型</th><th>默认个数</th><th>职责</th></tr></thead><tbody><tr><td>Read thread</td><td>4</td><td>负责读操作</td></tr><tr><td>Write thread</td><td>4</td><td>负责写操作</td></tr><tr><td>Log thread</td><td>1</td><td>负责将日志缓冲区刷新到磁盘</td></tr><tr><td>Insert buffer thread</td><td>1</td><td>负责将写缓冲区内容刷新到磁盘</td></tr></tbody></table></li><li><p>Purge Thread</p><p>主要用于回收事务已经提交了的undo log,在事务提交之后，undo log可能不用了，就用它来回收。</p></li><li><p>Page Cleaner Thread</p><p>协助Master Thread刷新脏页到磁盘的线程，它可以减轻Master Thread的工作压力，减少阻塞。</p></li></ol><h3 id="8-3-事务原理"><a href="#8-3-事务原理" class="headerlink" title="8.3 事务原理"></a>8.3 事务原理</h3><p>事务：</p><p>事务是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撒销操作请求，即这些操作要么同时成功，要么同时失败。</p><p>特性：</p><ul><li>原子性(Atomicity)：事务是不可分割的最小操作单元，要么全部成功，要么全部失败。</li><li>一致性(Consistency)：事务完成时，必须使所有的数据都保持一致状态。</li><li>隔离性(lsolation)：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。</li><li>特久性(Durability)：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的。</li></ul><h4 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h4><p>重做日志，记录的是事务提交时数据页的物理修改，是用来实现事务的<strong>持久性</strong>，</p><p>该日志文件由两部分组成：重做日志缓冲(redo log buffer)以及重做日志文件(redo log file)，前者是在内存中，后者在磁盘中。</p><p>当事务提交之后会<strong>优先把所有修改信息先都存到该日志文件中</strong>(如果存入日志文件失败则事务提交也就失败了)，用于在刷新脏页到磁盘，发生错误时，进行数据恢复使用。</p><p>并且日志文件会将多条事务排列好顺序刷新到磁盘，避免随机I&#x2F;O，浪费性能</p><h4 id="undo-log"><a href="#undo-log" class="headerlink" title="undo log"></a>undo log</h4><p>回滚日志，用于记录数据被修改前的信微，作用包含两个：提供回滚和MVCC(多版本并发控制)</p><p>undo log和redo log记录物理日志不一样，它是逻辑日志。可以认为当delete一条记录时，undo log中会记条对应的insert记录，反之亦然，当update一条记录时，它记录一条对应相反的update记录。当执行rollback时，就可以从undo log中的逻辑记录读家到相应的内容井进行回滚。</p><p>Undo log销盟：undo log在事务执行时产生，事务提交时，并不会立即除undo log,因为这些日志可能还用于MVCC</p><p>Undo log存储：undo log采用段的方式进行管理和记录，存放在前面介绍的rollback segment回滚段中，内部包含1024个undo log segment</p><h3 id="8-4-MVCC"><a href="#8-4-MVCC" class="headerlink" title="8.4 MVCC"></a>8.4 MVCC</h3><h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><ul><li><p>当前读：</p><p>读取的是记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。对于我们日常的操作，如：<code>select...lock in share mode(共享锁)</code>，<code>select..for update、update、insert、delete(排他锁)</code>都是一种当前读。</p></li><li><p>快照读：</p><p>简单的select(不加锁)就是快照读，快照读，读取的是记录数据的可见版本，有可能是历史数据，不加锁，是非阻塞读。</p><p>隔离级别：</p><ul><li><p>Read Committed(不可重复读)：每次select，都生成一个快照读。</p></li><li><p>Repeatable Read(可重复读)：开启事务后第一个select语句才是快照读的地方。</p></li><li><p>Serializable(串行化)：快照读会退化为当前读。</p></li></ul></li><li><p>MVCC：</p><p>全称Multi-Version Concurrency Control，多版本并发控制。指维护一个数据的多个版本，使得读写操作没有冲突，快照读为MySQL实现MVCC提供了一个非阻塞读功能。MVCC的具体实现，还需要依赖于数据库记录中的<strong>三个隐式字段</strong>、<strong>undo log日志</strong>、<strong>readView</strong>。</p></li></ul><h4 id="隐藏字段"><a href="#隐藏字段" class="headerlink" title="隐藏字段"></a>隐藏字段</h4><p>记录中会有2个或3个隐藏字段：</p><table><thead><tr><th>隐藏字段</th><th>含义</th></tr></thead><tbody><tr><td>DB_TRX_ID</td><td>最近修改事务ID，记录插入这条记录或最后一次修改该记录的事务ID。</td></tr><tr><td>DB_ROLL_PTR</td><td>回滚指针，指向这条记录的上一个版本，用于配合undo log，指向上一个版本。</td></tr><tr><td>DB_ROW_ID</td><td>隐藏主键，如果表结构没有指定主键，将会生成该隐藏字段。</td></tr></tbody></table><h4 id="undo-log版本链"><a href="#undo-log版本链" class="headerlink" title="undo log版本链"></a>undo log版本链</h4><p>回滚日志，在insert、update、deletel的时候产生的便于数据回滚的日志。</p><p>当insert的时候，产生的undo log日志只在回滚时需要，在事务提交后，可被立即删除。</p><p>而update、delete的时候，产生的undo log日志不仅在回滚时需要，在快照读时也需要，不会立即被删除。</p><p><img src="https://s2.loli.net/2023/01/17/4EcuRgXlPhoZ6bV.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/17/4EcuRgXlPhoZ6bV.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230117215145551.png">不同事务或相同事务对同一条记录进行修改，会导致该记录的undo log生成一条记录版本链表，链表的头部是最新的旧记录，链表尾部是最早的旧记录。</p><h4 id="readview"><a href="#readview" class="headerlink" title="readview"></a>readview</h4><p>ReadView(读视图)是快照读SQL执行时MVCC提取数据的依据，记录并维护系统当前活跃的事务(未提交的)id。</p><p>ReadView中包含了四个核心字段：</p><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>m_ids</td><td>当前活跃的事务ID集合</td></tr><tr><td>min_trx_id</td><td>最小活跃事务ID</td></tr><tr><td>max_trx id</td><td>预分配事务ID,当前最大事务ID+1(因为事务ID是自增的)</td></tr><tr><td>creator_trx_id</td><td>ReadView创建者的事务ID</td></tr></tbody></table><p><strong>版本链数据访问规则</strong>：</p><p>trx_id为记录中的DB_TRX_ID</p><ul><li><p><code>trx_id == creator_trx_id</code> ? <strong>可以</strong>访问该版本</p><p>成立，说明数据是当前这个事务更改的。</p></li><li><p><code>trx_id &lt; min trx_id</code> ? <strong>可以</strong>访问该版本</p><p>成立，说明数据已经提交了。</p></li><li><p><code>trx_id &gt; max_trx_id</code> ? <strong>不可以</strong>访问该版本</p><p>成立，说明该事务是在ReadView生成后才开启。</p></li><li><p><code>min_trx_id &lt;= trx_id &lt;= max_trx_id</code> ? 如果trx_id<strong>不在m_ids</strong>中是<strong>可以访问</strong>该版本的</p><p>成立，说明数据已经提交</p></li></ul><p>不同的隔离级别，生成ReadView的时机不同：</p><ul><li>READ COMMITTED：在事务中每一次执行快黑读时生成Readview。</li><li>REPEATABLE READ：仅在事务中第一次执行快照读时生成Readview，后续复用该Readview。</li></ul><p><strong>RC隔离级别</strong>下，在事务中每一次执行快照读时生成ReadView。</p><img src="https://s2.loli.net/2023/01/17/kNiI9A3HLgshzE4.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/17/kNiI9A3HLgshzE4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230117221941419.png" style="zoom:67%;" /><p>执行<strong>事务5</strong>时的<strong>第一条查询语句</strong>生成的ReadView：</p><ul><li>m_ids(活跃事务集合)：{3、4、5}</li><li>min_trx_id(最小事务id)：3</li><li>max_trx id(预分配事务id)：6</li><li>creator_trx_id(创建ReadView的事务id)：5</li></ul><p>在执行<strong>事务5</strong>时的<strong>第二条查询语句</strong>生成的ReadView：</p><ul><li><p>m_ids(活跃事务集合)：{4、5}</p><p>此时，事务3已经提交事务</p></li><li><p>min_trx_id(最小事务id)：4</p></li><li><p>max_trx id(预分配事务id)：6</p></li><li><p>creator_trx_id(创建ReadView的事务id)：5</p></li></ul><p>这样就可以通过一条记录中的<strong>DB_TRX_ID</strong>与<strong>版本链数据访问规则</strong>进行判断，从<strong>undo log</strong>找出可以访问的版本</p><p><strong>RR隔离级别</strong>下，仅在事务中第一次执行快照读时生成ReadView，后续复用该ReadView。</p><p>同样为这个图：</p><img src="https://s2.loli.net/2023/01/17/kNiI9A3HLgshzE4.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/17/kNiI9A3HLgshzE4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230117221941419.png" style="zoom:67%;" /><p>执行<strong>事务5</strong>时的<strong>第一条查询语句</strong>生成的ReadView：</p><ul><li>m_ids(活跃事务集合)：{3、4、5}</li><li>min_trx_id(最小事务id)：3</li><li>max_trx id(预分配事务id)：6</li><li>creator_trx_id(创建ReadView的事务id)：5</li></ul><p>在<strong>事务5</strong>执行<strong>第二条查询语句</strong>时，会复用之前的Readview</p><p>所以在同一次事务中，只会生成一次ReadView</p></div>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)870. 优势洗牌</title>
      <link href="/2022/10/08/%E6%AF%8F%E6%97%A5LeetCode/2022-10/870%20%E4%BC%98%E5%8A%BF%E6%B4%97%E7%89%8C/"/>
      <url>/2022/10/08/%E6%AF%8F%E6%97%A5LeetCode/2022-10/870%20%E4%BC%98%E5%8A%BF%E6%B4%97%E7%89%8C/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定两个大小相等的数组 nums1 和 nums2，nums1 相对于 nums2 的优势可以用满足 nums1[i] &gt; nums2[i] 的索引 i 的数目来描述。</p><p>返回 nums1 的任意排列，使其相对于 nums2 的优势最大化。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums1 &#x3D; [2,7,11,15], nums2 &#x3D; [1,10,4,11]<br>输出：[2,11,7,15]</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>类似于田忌赛马</p><p>将两个数组降序排序，num1中最大的数都比不过num2，那就摆烂，用num1中最小的数</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">advantageCount</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums1, vector&lt;<span class="type">int</span>&gt;&amp; nums2)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">sort</span>(nums1.<span class="built_in">begin</span>(), nums1.<span class="built_in">end</span>(), <span class="built_in">greater</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">        vector&lt;pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt;&gt; <span class="built_in">sign</span>(nums2.<span class="built_in">size</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; nums2.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            sign[i] = &#123;nums2[i], i&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">sort</span>(sign.<span class="built_in">begin</span>(), sign.<span class="built_in">end</span>(), </span><br><span class="line">             [](<span class="keyword">auto</span>&amp; a, <span class="keyword">auto</span>&amp; b)&#123;</span><br><span class="line">                 <span class="keyword">return</span> a.first &gt; b.first;</span><br><span class="line">             &#125;</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">ans</span><span class="params">(nums2.size())</span></span>;</span><br><span class="line">        <span class="type">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right = nums2.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(pos &lt; nums2.<span class="built_in">size</span>())&#123;</span><br><span class="line">            <span class="keyword">auto</span> [num, index] = sign[pos++];</span><br><span class="line">            <span class="keyword">if</span>(nums1[left] &gt; num)&#123;</span><br><span class="line">                ans[index] = nums1[left++];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                ans[index] = nums1[right--];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(nlogn)，其中 n 是 nums1 的长度。</li><li>空间复杂度：O(n)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1800. 最大升序子数组和</title>
      <link href="/2022/10/07/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1800%20%E6%9C%80%E5%A4%A7%E5%8D%87%E5%BA%8F%E5%AD%90%E6%95%B0%E7%BB%84%E5%92%8C/"/>
      <url>/2022/10/07/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1800%20%E6%9C%80%E5%A4%A7%E5%8D%87%E5%BA%8F%E5%AD%90%E6%95%B0%E7%BB%84%E5%92%8C/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个正整数组成的数组 nums ，返回 nums 中一个 升序 子数组的最大可能元素和。</p><p>子数组是数组中的一个连续数字序列。</p><p>已知子数组 [numsl, numsl+1, …, numsr-1, numsr] ，若对所有 i（l &lt;&#x3D; i &lt; r），numsi &lt; numsi+1 都成立，则称这一子数组为 升序 子数组。注意，大小为 1 的子数组也视作 升序 子数组。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [12,17,15,13,10,11,12]<br>输出：33<br>解释：[10,11,12] 是元素和最大的升序子数组，最大元素和为 33 。 </p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxAscendingSum</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> temp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; nums.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            temp += nums[i];</span><br><span class="line">            <span class="keyword">if</span>(i &lt; nums.<span class="built_in">size</span>() || nums[i] &gt;= nums[i + <span class="number">1</span>])&#123;</span><br><span class="line">                ans = <span class="built_in">max</span>(ans, temp);</span><br><span class="line">                temp = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)</li><li>空间复杂度：O(1)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)811. 子域名访问计数</title>
      <link href="/2022/10/05/%E6%AF%8F%E6%97%A5LeetCode/2022-10/811%20%E5%AD%90%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE%E8%AE%A1%E6%95%B0/"/>
      <url>/2022/10/05/%E6%AF%8F%E6%97%A5LeetCode/2022-10/811%20%E5%AD%90%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE%E8%AE%A1%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>网站域名 “discuss.leetcode.com” 由多个子域名组成。顶级域名为 “com” ，二级域名为 “leetcode.com” ，最低一级为 “discuss.leetcode.com” 。当访问域名 “discuss.leetcode.com” 时，同时也会隐式访问其父域名 “leetcode.com” 以及 “com” 。</p><p>计数配对域名 是遵循 “rep d1.d2.d3” 或 “rep d1.d2” 格式的一个域名表示，其中 rep 表示访问域名的次数，d1.d2.d3 为域名本身。</p><p>例如，”9001 discuss.leetcode.com” 就是一个 计数配对域名 ，表示 discuss.leetcode.com 被访问了 9001 次。<br>给你一个 计数配对域名 组成的数组 cpdomains ，解析得到输入中每个子域名对应的 计数配对域名 ，并以数组形式返回。可以按 任意顺序 返回答案。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：cpdomains &#x3D; [“900 google.mail.com”, “50 yahoo.com”, “1 intel.mail.com”, “5 wiki.org”]<br>输出：[“901 mail.com”,”50 yahoo.com”,”900 google.mail.com”,”5 wiki.org”,”5 org”,”1 intel.mail.com”,”951 com”]<br>解释：按照前文描述，会访问 “google.mail.com” 900 次，”yahoo.com” 50 次，”intel.mail.com” 1 次，”wiki.org” 5 次。<br>而对于父域名，会访问 “mail.com” 900 + 1 &#x3D; 901 次，”com” 900 + 50 + 1 &#x3D; 951 次，和 “org” 5 次。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">subdomainVisits</span><span class="params">(vector&lt;string&gt;&amp; cpdomains)</span> </span>&#123;</span><br><span class="line">        vector&lt;string&gt; ans;</span><br><span class="line">        unordered_map&lt;string, <span class="type">int</span>&gt; map;</span><br><span class="line">        <span class="type">int</span> n = cpdomains.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; cpdomains[i].<span class="built_in">size</span>(); j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(cpdomains[i][j] == <span class="string">&#x27; &#x27;</span>)&#123;</span><br><span class="line">                    <span class="type">int</span> num = <span class="built_in">stoi</span>(cpdomains[i].<span class="built_in">substr</span>(<span class="number">0</span>, j));</span><br><span class="line">                    string str = cpdomains[i].<span class="built_in">substr</span>(j + <span class="number">1</span>);</span><br><span class="line">                    map[str] += num;</span><br><span class="line"></span><br><span class="line">                    <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">while</span>(pos &lt; str.<span class="built_in">size</span>())&#123;</span><br><span class="line">                        <span class="keyword">if</span>(str[pos] == <span class="string">&#x27;.&#x27;</span>)&#123;</span><br><span class="line">                            string temp = str.<span class="built_in">substr</span>(pos + <span class="number">1</span>);</span><br><span class="line">                            map[temp] += num;</span><br><span class="line">                        &#125;</span><br><span class="line">                        pos++;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; [str, num] : map)&#123;</span><br><span class="line">            string temp = <span class="built_in">to_string</span>(num);</span><br><span class="line">            temp += <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">            temp += str;</span><br><span class="line">            ans.<span class="built_in">emplace_back</span>(temp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(L)，其中 L 是数组 cpdomains 中的所有字符串长度之和。遍历数组中所有的计数配对域名计算每个子域名的计数需要 O(L) 的时间，遍历哈希表也需要 O(L) 的时间。</p></li><li><p>空间复杂度：O(L)，其中 L 是数组 cpdomains 中的所有字符串长度之和。哈希表需要 O(L) 的空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)921. 使括号有效的最少添加</title>
      <link href="/2022/10/04/%E6%AF%8F%E6%97%A5LeetCode/2022-10/921%20%E4%BD%BF%E6%8B%AC%E5%8F%B7%E6%9C%89%E6%95%88%E7%9A%84%E6%9C%80%E5%B0%91%E6%B7%BB%E5%8A%A0/"/>
      <url>/2022/10/04/%E6%AF%8F%E6%97%A5LeetCode/2022-10/921%20%E4%BD%BF%E6%8B%AC%E5%8F%B7%E6%9C%89%E6%95%88%E7%9A%84%E6%9C%80%E5%B0%91%E6%B7%BB%E5%8A%A0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>只有满足下面几点之一，括号字符串才是有效的：</p><p>它是一个空字符串，或者<br>它可以被写成 AB （A 与 B 连接）, 其中 A 和 B 都是有效字符串，或者<br>它可以被写作 (A)，其中 A 是有效字符串。<br>给定一个括号字符串 s ，移动N次，你就可以在字符串的任何位置插入一个括号。</p><p>例如，如果 s &#x3D; “()))” ，你可以插入一个开始括号为 “(()))” 或结束括号为 “())))” 。<br>返回 为使结果字符串 s 有效而必须添加的最少括号数。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “())”<br>输出：1</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minAddToMakeValid</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; i : s)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">                count++;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span>(count == <span class="number">0</span>)</span><br><span class="line">                    ans++;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    count--;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans + count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)，其中 n 是字符串的长度。遍历字符串一次。</li><li>空间复杂度：O(1)。只需要维护常量的额外空间。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)777. 在LR字符串中交换相邻字符</title>
      <link href="/2022/10/02/%E6%AF%8F%E6%97%A5LeetCode/2022-10/777%20%E5%9C%A8LR%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E4%BA%A4%E6%8D%A2%E7%9B%B8%E9%82%BB%E5%AD%97%E7%AC%A6/"/>
      <url>/2022/10/02/%E6%AF%8F%E6%97%A5LeetCode/2022-10/777%20%E5%9C%A8LR%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E4%BA%A4%E6%8D%A2%E7%9B%B8%E9%82%BB%E5%AD%97%E7%AC%A6/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>在一个由 ‘L’ , ‘R’ 和 ‘X’ 三个字符组成的字符串（例如”RXXLRXRXL”）中进行移动操作。一次移动操作指用一个”LX”替换一个”XL”，或者用一个”XR”替换一个”RX”。现给定起始字符串start和结束字符串end，请编写代码，当且仅当存在一系列移动操作使得start可以转换成end时， 返回True。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入: start &#x3D; “RXXLRXRXL”, end &#x3D; “XRLXXRRLX”<br>输出: True<br>解释:<br>我们可以通过以下几步将start转换成end:<br>RXXLRXRXL -&gt;<br>XRXLRXRXL -&gt;<br>XRLXRXRXL -&gt;<br>XRLXXRRXL -&gt;<br>XRLXXRRLX</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p><code>&#39;R&#39;</code>只能向右移动，并且只能移向<code>&#39;X&#39;</code>，<code>&#39;L&#39;</code>只能向左移动，并且只能移向<code>&#39;X&#39;</code>。</p><ul><li><p>如果将<code>start</code>、<code>end</code>中的‘X’全部去掉得到的newStart 和 newEnd相等才有可能转换成功。</p></li><li><p>如果start中<code>&#39;R&#39;</code>的左边<code>&#39;X&#39;</code>的个数超过在<code>end</code>中对应位置的<code>&#39;R&#39;</code>的左边<code>&#39;X&#39;</code>的个数，则不能转换成功</p><p>因为<code>start</code>中的<code>&#39;R&#39;</code>只能向右移动，右边的<code>&#39;X&#39;</code>只能增加不能减少</p></li><li><p>如果<code>end</code>中<code>&#39;L&#39;</code>的左边<code>&#39;X&#39;</code>的个数超过在<code>start</code>中对应位置的<code>&#39;L&#39;</code>的左边<code>&#39;X&#39;</code>的个数，则不能转换成功</p><p>因为<code>start</code>中的<code>&#39;L&#39;</code>只能向左移动，左边的<code>&#39;X&#39;</code>只能减少不能增加</p></li></ul></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><p>双指针</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">canTransform</span><span class="params">(string start, string end)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = start.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; n &amp;&amp; start[i] == <span class="string">&#x27;X&#x27;</span>) </span><br><span class="line">                i++;</span><br><span class="line">            <span class="keyword">while</span> (j &lt; n &amp;&amp; end[j] == <span class="string">&#x27;X&#x27;</span>) </span><br><span class="line">                j++;</span><br><span class="line">            <span class="keyword">if</span> (i == n &amp;&amp; j == n) </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (i == n || j == n || start[i] != end[j]) </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (start[i] == <span class="string">&#x27;L&#x27;</span> &amp;&amp; i &lt; j) </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (start[i] == <span class="string">&#x27;R&#x27;</span> &amp;&amp; i &gt; j) </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            i++;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，其中 n 是字符串 start 和 end 的长度。需要遍历两个字符串各一次。</p></li><li><p>空间复杂度：O(1)。只需要使用常量的额外空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1694. 重新格式化电话号码</title>
      <link href="/2022/10/01/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1694%20%E9%87%8D%E6%96%B0%E6%A0%BC%E5%BC%8F%E5%8C%96%E7%94%B5%E8%AF%9D%E5%8F%B7%E7%A0%81/"/>
      <url>/2022/10/01/%E6%AF%8F%E6%97%A5LeetCode/2022-10/1694%20%E9%87%8D%E6%96%B0%E6%A0%BC%E5%BC%8F%E5%8C%96%E7%94%B5%E8%AF%9D%E5%8F%B7%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个字符串形式的电话号码 number 。number 由数字、空格 <code>&#39; &#39;</code>、和破折号 <code>&#39;-&#39;</code> 组成。</p><p>请你按下述方式重新格式化电话号码。</p><p>首先，删除 所有的空格和破折号。<br>其次，将数组从左到右 每 3 个一组 分块，直到 剩下 4 个或更少数字。剩下的数字将按下述规定再分块：</p><ul><li>2 个数字：单个含 2 个数字的块。</li><li>3 个数字：单个含 3 个数字的块。</li><li>4 个数字：两个分别含 2 个数字的块。</li></ul><p>最后用破折号将这些块连接起来。注意，重新格式化过程中 不应该 生成仅含 1 个数字的块，并且 最多 生成两个含 2 个数字的块。</p><p>返回格式化后的电话号码。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：number &#x3D; “1-23-45 6”<br>输出：”123-456”<br>解释：数字是 “123456”<br>步骤 1：共有超过 4 个数字，所以先取 3 个数字分为一组。第 1 个块是 “123” 。<br>步骤 2：剩下 3 个数字，将它们放入单个含 3 个数字的块。第 2 个块是 “456” 。<br>连接这些块后得到 “123-456” 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">reformatNumber</span><span class="params">(string number)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        string num = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; number.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(number[i] == <span class="string">&#x27; &#x27;</span> || number[i] == <span class="string">&#x27;-&#x27;</span>)&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            num.<span class="built_in">push_back</span>(number[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string ans = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">int</span> size = num.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(size%<span class="number">3</span> == <span class="number">1</span> &amp;&amp; size -i+<span class="number">1</span> &lt;= <span class="number">4</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(count == <span class="number">2</span>)&#123;</span><br><span class="line">                    ans.<span class="built_in">push_back</span>(<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">                    count = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(count == <span class="number">3</span>)&#123;</span><br><span class="line">                ans.<span class="built_in">push_back</span>(<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">                count = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ans.<span class="built_in">push_back</span>(num[i]);</span><br><span class="line">            count++;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)</p></li><li><p>空间复杂度：O(n)</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)面试题 01.08. 零矩阵</title>
      <link href="/2022/09/30/%E6%AF%8F%E6%97%A5LeetCode/2022-9/%E9%9D%A2%E8%AF%95%E9%A2%98%2001.08%20%E9%9B%B6%E7%9F%A9%E9%98%B5/"/>
      <url>/2022/09/30/%E6%AF%8F%E6%97%A5LeetCode/2022-9/%E9%9D%A2%E8%AF%95%E9%A2%98%2001.08%20%E9%9B%B6%E7%9F%A9%E9%98%B5/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>编写一种算法，若M × N矩阵中某个元素为0，则将其所在的行与列清零。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：<br>[<br>[1,1,1],<br>[1,0,1],<br>[1,1,1]<br>]<br>输出：<br>[<br>[1,0,1],<br>[0,0,0],<br>[1,0,1]<br>]</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">     <span class="function"><span class="type">void</span> <span class="title">setZeroes</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; matrix)</span> </span>&#123;</span><br><span class="line">         <span class="type">int</span> m = matrix.<span class="built_in">size</span>();</span><br><span class="line">         <span class="type">int</span> n = matrix[<span class="number">0</span>].<span class="built_in">size</span>();</span><br><span class="line"> <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">x</span><span class="params">(m)</span></span>;</span><br><span class="line">         <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">y</span><span class="params">(n)</span></span>;</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++)&#123;</span><br><span class="line">             <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++)&#123;</span><br><span class="line">                 <span class="keyword">if</span>(matrix[i][j] == <span class="number">0</span>)&#123;</span><br><span class="line">                     x[i] = <span class="number">1</span>;</span><br><span class="line">                     y[j] = <span class="number">1</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++)&#123;</span><br><span class="line">             <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++)&#123;</span><br><span class="line">                 <span class="keyword">if</span>(x[i] == <span class="number">1</span> || y[j] == <span class="number">1</span>)&#123;</span><br><span class="line">                     matrix[i][j] = <span class="number">0</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(mn)，其中 m 是矩阵的行数，n 是矩阵的列数。我们至多只需要遍历该矩阵两次。</p></li><li><p>空间复杂度：O(m+n)，其中 m 是矩阵的行数，n 是矩阵的列数。我们需要分别记录每一行或每一列是否有零出现。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)面试题 01.09. 字符串轮转</title>
      <link href="/2022/09/29/%E6%AF%8F%E6%97%A5LeetCode/2022-9/%E9%9D%A2%E8%AF%95%E9%A2%98%2001.09%20%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AE%E8%BD%AC/"/>
      <url>/2022/09/29/%E6%AF%8F%E6%97%A5LeetCode/2022-9/%E9%9D%A2%E8%AF%95%E9%A2%98%2001.09%20%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AE%E8%BD%AC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>字符串轮转。给定两个字符串<code>s1</code>和<code>s2</code>，请编写代码检查<code>s2</code>是否为<code>s1</code>旋转而成（比如，<code>waterbottle</code>是<code>erbottlewat</code>旋转后的字符串）。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s1 &#x3D; “waterbottle”, s2 &#x3D; “erbottlewat”<br>输出：True</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><p>模拟</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isFlipedString</span><span class="params">(string s1, string s2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(s1.<span class="built_in">size</span>() != s2.<span class="built_in">size</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(s1.<span class="built_in">size</span>() == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s1.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="type">bool</span> flag = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; s1.<span class="built_in">size</span>(); j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(s2[(i + j) % s1.<span class="built_in">size</span>()] != s1[j])&#123;</span><br><span class="line">                    flag = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(flag) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h3><ul><li><p>时间复杂度：O(n^2)，其中 n 是字符串 s1的长度。我们需要双重循环来判断。</p></li><li><p>空间复杂度：O(1)。仅使用常数空间。</p></li></ul></div><div class="story post-story"><h2 id="代码-cpp-：-1"><a href="#代码-cpp-：-1" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><p>KMP</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isFlipedString</span><span class="params">(string s1, string s2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(s1.<span class="built_in">size</span>() != s2.<span class="built_in">size</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(s1.<span class="built_in">size</span>() == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        s1 += s1;</span><br><span class="line">        <span class="keyword">return</span> s1.<span class="built_in">find</span>(s2) != string::npos; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="复杂度分析：-1"><a href="#复杂度分析：-1" class="headerlink" title="复杂度分析："></a>复杂度分析：</h3><ul><li><p>时间复杂度：O(n)，其中 n 是字符串 s1的长度。KMP 算法搜索子字符串的时间复杂度为 O(n)，其他搜索子字符串的方法会略有差异。</p></li><li><p>空间复杂度：O(n)，其中 n 是字符串 s1的长度。KMP 算法搜索子字符串的空间复杂度为 O(n)，其他搜索子字符串的方法会略有差异。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)面试题 01.02. 判定是否互为字符重排</title>
      <link href="/2022/09/27/%E6%AF%8F%E6%97%A5LeetCode/2022-9/%E9%9D%A2%E8%AF%95%E9%A2%98%2001.02%20%E5%88%A4%E5%AE%9A%E6%98%AF%E5%90%A6%E4%BA%92%E4%B8%BA%E5%AD%97%E7%AC%A6%E9%87%8D%E6%8E%92/"/>
      <url>/2022/09/27/%E6%AF%8F%E6%97%A5LeetCode/2022-9/%E9%9D%A2%E8%AF%95%E9%A2%98%2001.02%20%E5%88%A4%E5%AE%9A%E6%98%AF%E5%90%A6%E4%BA%92%E4%B8%BA%E5%AD%97%E7%AC%A6%E9%87%8D%E6%8E%92/</url>
      
        <content type="html"><![CDATA[<p>题目：</p><p>给定两个字符串 <code>s1</code> 和 <code>s2</code>，请编写一个程序，确定其中一个字符串的字符重新排列后，能否变成另一个字符串。</p><p>示例：</p><blockquote><p>输入: s1 &#x3D; “abc”, s2 &#x3D; “bca”<br>输出: true </p></blockquote><p>代码(cpp)：</p><p>方式一：排序</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">CheckPermutation1</span><span class="params">(string s1, string s2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(s1.<span class="built_in">size</span>() != s2.<span class="built_in">size</span>())&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">sort</span>(s1.<span class="built_in">begin</span>(), s1.<span class="built_in">end</span>());</span><br><span class="line">        <span class="built_in">sort</span>(s2.<span class="built_in">begin</span>(), s2.<span class="built_in">end</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s1.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(s1[i] != s2[i])&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>方式二：哈希</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">   <span class="function"><span class="type">bool</span> <span class="title">CheckPermutation</span><span class="params">(string s1, string s2)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(s1.<span class="built_in">size</span>() != s2.<span class="built_in">size</span>())&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">map</span><span class="params">(<span class="number">26</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; s : s1)&#123;</span><br><span class="line">           map[s - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; s : s2)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map[s - <span class="string">&#x27;a&#x27;</span>] != <span class="number">0</span>)&#123;</span><br><span class="line">                map[s - <span class="string">&#x27;a&#x27;</span>]--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)面试题 17.19. 消失的两个数字</title>
      <link href="/2022/09/26/%E6%AF%8F%E6%97%A5LeetCode/2022-9/%E9%9D%A2%E8%AF%95%E9%A2%98%2017.19%20%E6%B6%88%E5%A4%B1%E7%9A%84%E4%B8%A4%E4%B8%AA%E6%95%B0%E5%AD%97/"/>
      <url>/2022/09/26/%E6%AF%8F%E6%97%A5LeetCode/2022-9/%E9%9D%A2%E8%AF%95%E9%A2%98%2017.19%20%E6%B6%88%E5%A4%B1%E7%9A%84%E4%B8%A4%E4%B8%AA%E6%95%B0%E5%AD%97/</url>
      
        <content type="html"><![CDATA[<p>题目：</p><p>给定一个数组，包含从 1 到 N 所有的整数，但其中缺了两个数字。你能在 O(N) 时间内只用 O(1) 的空间找到它们吗？</p><p>以任意顺序返回这两个数字均可。</p><p>示例：</p><blockquote><p>输入: [2,3]<br>输出: [1,4]</p></blockquote><p>代码(cpp)：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">missingTwo</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//总长度</span></span><br><span class="line">        <span class="type">int</span> all = nums.<span class="built_in">size</span>() + <span class="number">2</span>;</span><br><span class="line">        <span class="comment">//获取总长度的元素总和</span></span><br><span class="line">        <span class="type">int</span> all_sum = all*(<span class="number">1</span> + all) / <span class="number">2</span>;</span><br><span class="line">        <span class="comment">//计算剩余的总和</span></span><br><span class="line">        <span class="type">int</span> remain_sum = all_sum;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; num : nums)&#123;</span><br><span class="line">            remain_sum -= num;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取结果中间的元素，说明有一个答案必定有一个小于mid的</span></span><br><span class="line">        <span class="type">int</span> mid = remain_sum / <span class="number">2</span>;</span><br><span class="line">        <span class="comment">//计算出总和</span></span><br><span class="line">        <span class="type">int</span> mid_sum = mid*(<span class="number">1</span> + mid) / <span class="number">2</span>;</span><br><span class="line">        <span class="comment">//获取那个小于mid的答案</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; num : nums)&#123;</span><br><span class="line">            <span class="keyword">if</span>(num &lt;= mid)&#123;</span><br><span class="line">                mid_sum -= num;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//用剩余的减去mid_sumjiu&#x27;de</span></span><br><span class="line">        <span class="keyword">return</span> &#123;mid_sum, remain_sum - mid_sum&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1652. 拆炸弹</title>
      <link href="/2022/09/24/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1652%20%E6%8B%86%E7%82%B8%E5%BC%B9/"/>
      <url>/2022/09/24/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1652%20%E6%8B%86%E7%82%B8%E5%BC%B9/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>你有一个炸弹需要拆除，时间紧迫！你的情报员会给你一个长度为 n 的 循环 数组 code 以及一个密钥 k 。</p><p>为了获得正确的密码，你需要替换掉每一个数字。所有数字会 同时 被替换。</p><ul><li>如果 k &gt; 0 ，将第 i 个数字用 接下来 k 个数字之和替换。</li><li>如果 k &lt; 0 ，将第 i 个数字用 之前 k 个数字之和替换。</li><li>如果 k &#x3D;&#x3D; 0 ，将第 i 个数字用 0 替换。</li></ul><p>由于 code 是循环的， code[n-1] 下一个元素是 code[0] ，且 code[0] 前一个元素是 code[n-1] 。</p><p>给你 循环 数组 code 和整数密钥 k ，请你返回解密后的结果来拆除炸弹！</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：code &#x3D; [5,7,1,4], k &#x3D; 3<br>输出：[12,10,16,13]<br>解释：每个数字都被接下来 3 个数字之和替换。解密后的密码为 [7+1+4, 1+4+5, 4+5+7, 5+7+1]。注意到数组是循环连接的。</p></blockquote><blockquote><p>输入：code &#x3D; [2,4,9,3], k &#x3D; -2<br>输出：[12,5,6,13]<br>解释：解密后的密码为 [3+9, 2+3, 4+2, 9+4] 。注意到数组是循环连接的。如果 k 是负数，那么和为 之前 的数字。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>分为3中情况，模拟出3种情况即可</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">decrypt</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; code, <span class="type">int</span> k)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; ans;</span><br><span class="line">        <span class="type">int</span> n = code.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">if</span>(k == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (k &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; code.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">                <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; k; j++)&#123;</span><br><span class="line">                    sum += code[(i + j + <span class="number">1</span>) % n];</span><br><span class="line">                &#125;</span><br><span class="line">                ans.<span class="built_in">emplace_back</span>(sum);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; code.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">                <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="built_in">abs</span>(k); j++)&#123;</span><br><span class="line">                    sum += code[(i - j - <span class="number">1</span> + n) % n];</span><br><span class="line">                &#125;</span><br><span class="line">                ans.<span class="built_in">emplace_back</span>(sum);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)707. 设计链表</title>
      <link href="/2022/09/23/%E6%AF%8F%E6%97%A5LeetCode/2022-9/707%20%E8%AE%BE%E8%AE%A1%E9%93%BE%E8%A1%A8/"/>
      <url>/2022/09/23/%E6%AF%8F%E6%97%A5LeetCode/2022-9/707%20%E8%AE%BE%E8%AE%A1%E9%93%BE%E8%A1%A8/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p><strong>设计链表的实现</strong>。您可以选择使用单链表或双链表。单链表中的节点应该具有两个属性：val 和 next。val 是当前节点的值，next 是指向下一个节点的指针&#x2F;引用。如果要使用双向链表，则还需要一个属性 prev 以指示链表中的上一个节点。假设链表中的所有节点都是 0-index 的。</p><p>在链表类中实现这些功能：</p><ul><li><code>get(index)</code>：获取链表中第 index 个节点的值。如果索引无效，则返回-1。</li><li><code>addAtHead(val)</code>：在链表的第一个元素之前添加一个值为 val 的节点。插入后，新节点将成为链表的第一个节点。</li><li><code>addAtTail(val)</code>：将值为 val 的节点追加到链表的最后一个元素。</li><li><code>addAtIndex(index,val)</code>：在链表中的第 index 个节点之前添加值为 val  的节点。如果 index 等于链表的长度，则该节点将附加到链表的末尾。如果 index 大于链表长度，则不会插入节点。如果index小于0，则在头部插入节点。</li><li><code>deleteAtIndex(index)</code>：如果索引 index 有效，则删除链表中的第 index 个节点。</li></ul></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>MyLinkedList linkedList &#x3D; new MyLinkedList();<br>linkedList.addAtHead(1);<br>linkedList.addAtTail(3);<br>linkedList.addAtIndex(1,2);      &#x2F;&#x2F;链表变为1-&gt; 2-&gt; 3<br>linkedList.get(1);                        &#x2F;&#x2F;返回2<br>linkedList.deleteAtIndex(1);     &#x2F;&#x2F;现在链表是1-&gt; 3<br>linkedList.get(1);            &#x2F;&#x2F;返回3</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyLinkedList</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MyLinkedList</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;head = <span class="keyword">new</span> <span class="built_in">ListNode</span>(<span class="number">-1</span>, <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">get</span><span class="params">(<span class="type">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || <span class="keyword">this</span>-&gt;size &lt;= index) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> temp = <span class="keyword">this</span>-&gt;head;</span><br><span class="line">        <span class="keyword">while</span>(index &gt;=<span class="number">0</span>) &#123;</span><br><span class="line">            temp = temp-&gt;next;</span><br><span class="line">            index--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> temp-&gt;val;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addAtHead</span><span class="params">(<span class="type">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">addAtIndex</span>(<span class="number">0</span>, val);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addAtTail</span><span class="params">(<span class="type">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">addAtIndex</span>(<span class="keyword">this</span>-&gt;size, val);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addAtIndex</span><span class="params">(<span class="type">int</span> index, <span class="type">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || <span class="keyword">this</span>-&gt;size &lt; index) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> temp = <span class="keyword">this</span>-&gt;head;</span><br><span class="line">        <span class="keyword">while</span>(index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            temp = temp-&gt;next;</span><br><span class="line">            index--;</span><br><span class="line">        &#125;</span><br><span class="line">        ListNode* newNode = <span class="keyword">new</span> <span class="built_in">ListNode</span>(val, temp-&gt;next);</span><br><span class="line">        temp-&gt;next = newNode;</span><br><span class="line">        <span class="keyword">this</span>-&gt;size++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">deleteAtIndex</span><span class="params">(<span class="type">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || <span class="keyword">this</span>-&gt;size &lt;= index) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">auto</span> temp = <span class="keyword">this</span>-&gt;head;</span><br><span class="line">        <span class="keyword">while</span>(index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            temp = temp-&gt;next;</span><br><span class="line">            index--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">auto</span> e = temp-&gt;next;</span><br><span class="line">        temp-&gt;next = e-&gt;next;</span><br><span class="line">        <span class="keyword">delete</span> e;</span><br><span class="line">        <span class="keyword">this</span>-&gt;size--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ListNode</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="type">int</span> val;</span><br><span class="line">        ListNode* next;</span><br><span class="line">        <span class="built_in">ListNode</span>(<span class="type">int</span> val, ListNode* next) &#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;val = val;</span><br><span class="line">            <span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    ListNode* head;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：初始化消耗 O(1)，get 消耗 O(index)，addAtHead 消耗 O(1)，addAtTail 消耗 O(n)，其中 n 为链表当前长度，即 addAtHead，addAtTail 和 addAtIndex 已调用次数之和，addAtIndex 消耗 O(index)。</p></li><li><p>空间复杂度：所有函数的单次调用空间复杂度均为 O(1)，总体空间复杂度为 O(n)，其中 n 为 addAtHead，addAtTail 和 addAtIndex 调用次数之和。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git的学习笔记</title>
      <link href="/2022/09/21/Java/Git/"/>
      <url>/2022/09/21/Java/Git/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h2><h3 id="1-1-开发常用场景"><a href="#1-1-开发常用场景" class="headerlink" title="1.1 开发常用场景"></a>1.1 开发常用场景</h3><ul><li><p>备份</p></li><li><p>代码还原</p></li><li><p>协同开发</p></li><li><p>追溯问题代码的编写人员和编写时间</p></li></ul><h3 id="1-2-SVN"><a href="#1-2-SVN" class="headerlink" title="1.2 SVN"></a>1.2 SVN</h3><p>SVN(subversion)，是一个开放源代码的版本控制系统，通过采用分支管理系统的高效管理，简而言之就是用于多个人共同开发同一个项目，实现共享资源，实现最终集中式的管理。</p><p>工作流程：</p><p>SVN是集中式版本控制系统，版本库是集中放在中央服务器的<br>工作流程如下:</p><ol><li>从中央服务器远程仓库下载代码</li><li>修改后将代码提交到中央服务器远程仓库</li></ol><p>优缺点:</p><ul><li>优点：简单,易操作</li><li>缺点：所有代码必须放在中央服务器  <ol><li>服务器一旦宕机无法提交代码,即容错性较差</li><li>离线无法提交代码,无法及时记录我们的提交行为</li></ol></li></ul><h3 id="1-3-Git"><a href="#1-3-Git" class="headerlink" title="1.3 Git"></a>1.3 Git</h3><p>工作流程：</p><p>Git是分布式版本控制系统(Distributed Version Control System，简称 DVCS)，分为两种类型的仓库：</p><ul><li><p>本地仓库</p></li><li><p>远程仓库</p></li></ul><p>工作流程如下：</p><ol><li>从远程仓库中克隆或拉取代码到本地仓库(clone&#x2F;pull)</li><li>从本地进行代码修改</li><li>在提交前先将代码提交到暂存区</li><li>提交到本地仓库。本地仓库中保存修改的各个历史版本</li><li>修改完成后，需要和团队成员共享代码时，将代码push到远程仓库</li></ol><p>Git和SVN的区别：</p><ol><li>SVN 是集中式版本控制工具，Git是分布式版本控制工具</li><li>SVN不支持离线提交，Git支持离线提交代码</li></ol><h3 id="1-4-Git-工作流程"><a href="#1-4-Git-工作流程" class="headerlink" title="1.4 Git 工作流程"></a>1.4 Git 工作流程</h3><img src="https://s2.loli.net/2023/02/03/qR3W8iYTb2zXNrC.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/03/qR3W8iYTb2zXNrC.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-03_11-43-02_waifu2x_photo_noise1_scale.png" style="zoom: 50%;" /><p>命令如下：</p><ol><li>clone(克隆)：从玩程仓庄中克隆代码到本地仓库</li><li>checkout(检出)：从本地仓库中检出一个仓库分支然后进行修订</li><li>add(添加)：在提交的先格代码堤交到智存区</li><li>commit(提交)：提交到本地仓库，本地仓南中保存修放的各个历史版本</li><li>fetch(抓取)：从污程车，抓取到本地仓库，不进行任何的合井动作，一般操作比较少。</li><li>pull(拉取)：从运程库拉到本地库，白动进行合井(merge)，然后放到到工作区，相当于fetch+merge</li><li>push(推送)：修改完成后，需要和团队成员共享代码，将代码推送到远程仓库</li></ol></div><div class="story post-story"><h2 id="2-Git的使用及常用命令"><a href="#2-Git的使用及常用命令" class="headerlink" title="2.Git的使用及常用命令"></a>2.Git的使用及常用命令</h2><p>再windows桌面或者文件夹中右键，会出现：</p><ul><li><code>Git GUI</code>：Git提供的图像化界面工具</li><li><code>Git Bash</code>：Git提供的命令行工具</li></ul><h3 id="2-1-基本配置"><a href="#2-1-基本配置" class="headerlink" title="2.1 基本配置"></a>2.1 基本配置</h3><h4 id="配置用户信息"><a href="#配置用户信息" class="headerlink" title="配置用户信息"></a>配置用户信息</h4><ol><li><p>打开<code>Git Bash</code></p></li><li><p>设置用户信息</p><ul><li><p><code>git config --global user.name&quot;XXX&quot;</code></p></li><li><p><code>git config --global user.email&quot;666@qq.com&quot;</code></p></li></ul></li><li><p>查看用户信息</p><ul><li><p><code>git config --global user.name</code></p></li><li><p><code>git config --global user.email</code></p></li></ul></li></ol><h4 id="为常用指令配置别名"><a href="#为常用指令配置别名" class="headerlink" title="为常用指令配置别名"></a>为常用指令配置别名</h4><p>有些常用的指令参数非常多，每次都要出入好多参数，我们可以起别名：</p><ol><li><p>打开<code>Users</code>目录，创建<code>.bashrc</code>文件</p><p>再<code>Users</code>目录中右键，打开<code>Git Bash</code>，输入下面来创建<code>.bashrc</code>文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> ~/.bashrc</span><br></pre></td></tr></table></figure></li><li><p>再<code>.bashrc</code>文件输入以下内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用于输出git提交日志</span></span><br><span class="line"><span class="built_in">alias</span> git-log=<span class="string">&#x27;git log --pretty=oneline --all --graph --abbrev-commit&#x27;</span></span><br><span class="line"><span class="comment">#用于输出当前目录所有文件及其文件信息</span></span><br><span class="line"><span class="built_in">alias</span> ll=<span class="string">&#x27;ls -al&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>接着执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash</span><br></pre></td></tr></table></figure></li></ol><h4 id="解决Git-Bash乱码问题"><a href="#解决Git-Bash乱码问题" class="headerlink" title="解决Git Bash乱码问题"></a>解决Git Bash乱码问题</h4><ol><li><p>打开Git Bash执行下面命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global core.quotepath <span class="literal">false</span></span><br></pre></td></tr></table></figure></li><li><p><code>$&#123;git_home&#125;/etc/bash.bashrc</code>文件最后加入下面内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export LANG=&quot;zh_CN.UTF-8&quot;</span><br><span class="line">export LC_ALL=&quot;zh_CN.UTF-8&quot;</span><br></pre></td></tr></table></figure></li></ol><h3 id="2-2-获取本地仓库"><a href="#2-2-获取本地仓库" class="headerlink" title="2.2 获取本地仓库"></a>2.2 获取本地仓库</h3><p>要使用Git对代码进行版本控制，首先需要获得本地仓库</p><ol><li><p>在电脑的任意位置创建一个空目录(例如test)作为我们的本地Git仓库</p></li><li><p>进入这个目录中，点击右键打开Git bash窗口</p></li><li><p>执行命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure></li><li><p>如果创建成功后可在文件夹下看到隐藏的<code>.git</code>目录。</p></li></ol><h3 id="2-3-基础操作命令"><a href="#2-3-基础操作命令" class="headerlink" title="2.3 基础操作命令"></a>2.3 基础操作命令</h3><p>Git工作目录对于文件的修改(增加、删除、更新)会存在几个状态，这些<strong>修改</strong>状态会随着执行Git命令而发生变化</p><img src="https://s2.loli.net/2022/09/22/2R67LeqzPWbku5o.png" class="lazyload" data-srcset="https://s2.loli.net/2022/09/22/2R67LeqzPWbku5o.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220922142123000.png" style="zoom:67%;" /><p>使用命令来控制这些状态之间的转换：</p><ul><li><code>git add</code>：工作区–&gt;暂存区</li><li><code>git commit</code>：暂存区–&gt;本地仓库</li></ul><h4 id="查看修改的状态"><a href="#查看修改的状态" class="headerlink" title="查看修改的状态"></a>查看修改的状态</h4><p>查看修改的状态(暂存区、工作区)：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure><h4 id="添加工作区到暂存区"><a href="#添加工作区到暂存区" class="headerlink" title="添加工作区到暂存区"></a>添加工作区到暂存区</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add 文件名</span><br></pre></td></tr></table></figure><p>或者使用通配符，如：将所有文件添加到暂存区</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br></pre></td></tr></table></figure><h4 id="提交暂存区到本地仓库"><a href="#提交暂存区到本地仓库" class="headerlink" title="提交暂存区到本地仓库"></a>提交暂存区到本地仓库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -m <span class="string">&#x27;注释内容&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> [option]</span><br></pre></td></tr></table></figure><p>option多个参数：</p><ul><li><code>--all</code>：显示所有分支</li><li><code>--pretty=oneline</code>：将提交的信息显示为一行</li><li><code>--abbrev-commit</code>：使得输出的commitId更简短</li><li><code>--graph</code>：以图的形式显示</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --pretty=oneline --all --graph --abbrev-commit</span><br></pre></td></tr></table></figure><p>或者在之前的常用指令设置的别名：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git-log</span><br></pre></td></tr></table></figure><h4 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard commitID</span><br></pre></td></tr></table></figure><ul><li><code>commitID</code>可以使用<code>git-log</code>或<code>git log</code>查看</li></ul><p>查看已经删除的记录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reflog</span><br></pre></td></tr></table></figure><h4 id="添加文件至忽略列表"><a href="#添加文件至忽略列表" class="headerlink" title="添加文件至忽略列表"></a>添加文件至忽略列表</h4><p>在工作目录创建一个名为<code>.gitignore</code>的文件(文件名固定)</p><p>可以列出要忽略的文件名，如：</p><p>忽略后缀为a的文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.a</span><br></pre></td></tr></table></figure><h3 id="2-4-分支"><a href="#2-4-分支" class="headerlink" title="2.4 分支"></a>2.4 分支</h3><p>几乎所有的版本控制系统都以某种形式支持分支。使用分支意味着你可以把你的工作从开发主线上分离来进行重大的BUG修改，开发新功能，以免影响开发主线</p><h4 id="查看本地分支"><a href="#查看本地分支" class="headerlink" title="查看本地分支"></a>查看本地分支</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch</span><br></pre></td></tr></table></figure><h4 id="创建本地分支"><a href="#创建本地分支" class="headerlink" title="创建本地分支"></a>创建本地分支</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch 分支名</span><br></pre></td></tr></table></figure><h4 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout 分支名</span><br></pre></td></tr></table></figure><p>还可以切换到另一个不存在的分支(创建并切换)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b 分支名</span><br></pre></td></tr></table></figure><h4 id="合并分支"><a href="#合并分支" class="headerlink" title="合并分支"></a>合并分支</h4><p>一个分支上的提交可以合并到另一个分支</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge 分支名称</span><br></pre></td></tr></table></figure><h4 id="删除分支"><a href="#删除分支" class="headerlink" title="删除分支"></a>删除分支</h4><p>不能删除当前分支，只能删除其他分支</p><p>删除分支时，需要删除其他分支：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -d b1</span><br></pre></td></tr></table></figure><p>不做任何检查，强制删除：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -D b1</span><br></pre></td></tr></table></figure><h4 id="解决冲突"><a href="#解决冲突" class="headerlink" title="解决冲突"></a>解决冲突</h4><p>当两个分支上对文件的修改可能会存在冲突，如同时修改同一个文件的同一行，这时需要手动解决冲突，解决步骤如下：</p><ol><li>处理文件中冲突的地方</li><li>将解决完的冲突的文件加入暂存区(add)</li><li>提交到仓库(commit)</li></ol><h4 id="开发中分支使用原则"><a href="#开发中分支使用原则" class="headerlink" title="开发中分支使用原则"></a>开发中分支使用原则</h4><p>在开发中，一般有如下分支使用原则与流程：</p><ul><li>master(生产分支)<ul><li>线上分支、主分支、中小规模项目作为线上运行的应用对应的分支</li></ul></li><li>develop(开发分支)<ul><li>是从master创建的分支，一般作为开发部门的主要开发分支，如果没有其他并行开发不同期上线要求，都可以在此版本进行开发，阶段开发完成后，需要合并到master分支，准备上线</li></ul></li><li>feature&#x2F;XXX分支<ul><li>从develop创建的分支，一般是同期并行开发，但不同期上线时创建的分支，分支上的研发任务完成后合并到develop分支。</li></ul></li><li>hotfix&#x2F;XXX分支<ul><li>从master派生的分支，一般作为线上bug修复使用，修复完成后需要合并到master、test、 develop分支。</li></ul></li><li>还有其他一些分支如，test分支(用于代码测试)、pre分支(预上线分支)等</li></ul></div><div class="story post-story"><h2 id="3-Git远程仓库"><a href="#3-Git远程仓库" class="headerlink" title="3.Git远程仓库"></a>3.Git远程仓库</h2><h3 id="3-1-常用的托管仓库"><a href="#3-1-常用的托管仓库" class="headerlink" title="3.1 常用的托管仓库"></a>3.1 常用的托管仓库</h3><p>那么我们如何搭建Git远程仓库呢？</p><p>我们可以借助互联网上提供的一些代码托管服务水实现，其中比较常用的有GitHub、码云等。</p><ul><li><a href="https://github.com/">gitHub</a>是一个面向开源及私有软件项目的托管平台，因为只支持Git作为唯一的版本库格式进行托管，故名gitHub</li><li><a href="https://gitee.com/">码云</a>(gitee)是国内的一个代码托管平台，由手服务器在国内，所以相比于GitHub，码云速度会更快</li></ul><h3 id="3-2-操作远程仓库"><a href="#3-2-操作远程仓库" class="headerlink" title="3.2 操作远程仓库"></a>3.2 操作远程仓库</h3><h4 id="远程仓库的添加"><a href="#远程仓库的添加" class="headerlink" title="远程仓库的添加"></a>远程仓库的添加</h4><p>命令：<code>git remote add &lt;远端名称&gt; &lt;仓库路径&gt;</code></p><ul><li>远端名称：默认为origin(可以自己取)，取决于远端服务器设置</li><li>仓库名称：从远程仓库服务器获取的URL</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin 仓库地址</span><br></pre></td></tr></table></figure><h4 id="查看远程仓库"><a href="#查看远程仓库" class="headerlink" title="查看远程仓库"></a>查看远程仓库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote</span><br></pre></td></tr></table></figure><h4 id="推送到远程仓库"><a href="#推送到远程仓库" class="headerlink" title="推送到远程仓库"></a>推送到远程仓库</h4><p>命令：<code>git push [-f] [--set-upstream] [远端名称] [本地分支名]:[远端分支名]</code></p><ul><li><p><code>-f</code>：强制覆盖</p></li><li><p>注意：如果本地分支名和远端分支名相同，则只需写本地分支名即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin master</span><br></pre></td></tr></table></figure></li><li><p><code>--set-upstream</code>：推送到远端的同时并建立起与远端分支的关联</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push --set-upstream origin master</span><br></pre></td></tr></table></figure><p>如果当前分支已经和远端分支关联，则可以省略分支名和远端名</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push</span><br></pre></td></tr></table></figure></li></ul><h4 id="本地分支与远端分支"><a href="#本地分支与远端分支" class="headerlink" title="本地分支与远端分支"></a>本地分支与远端分支</h4><p>查看关联关系：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -vv</span><br></pre></td></tr></table></figure><h4 id="从远程仓库克隆"><a href="#从远程仓库克隆" class="headerlink" title="从远程仓库克隆"></a>从远程仓库克隆</h4><p>将远程仓库克隆到本地：</p><p>命令：<code>git clone &lt;仓库路径&gt; &lt;本地目录&gt;</code></p><ul><li>注意：本地目录可以省略，会在当前文件夹自动生成一个目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> 仓库路径</span><br></pre></td></tr></table></figure><h4 id="从远程仓库抓取和拉取"><a href="#从远程仓库抓取和拉取" class="headerlink" title="从远程仓库抓取和拉取"></a>从远程仓库抓取和拉取</h4><p>抓取：将仓库里的更新都抓取到本地，不会进行合并</p><ul><li><p>抓取命令：<code>git fetch [remote name] [branch name]</code></p></li><li><p>如果不指定远端名称和分支名，则会抓取所有分支</p></li></ul><p>拉取：将远端仓库的修改拉到本地并自动进行合并，等同于<code>fetch+merge</code></p><ul><li><p>拉取命令：<code>git pull [remote name] [branch name]</code></p></li><li><p>如果不指定远端名称和分支名，则会抓取所有分支并更新当前分支</p></li></ul><h4 id="解决合并冲突"><a href="#解决合并冲突" class="headerlink" title="解决合并冲突"></a>解决合并冲突</h4><p>在一段时间，A、B用户修改了同一个文件，且修改了同一行位置的代码，此时会发生合并冲突。</p><p>A用户在本地修改代码后优先推送到远程仓库，此时B用户在本地修订代码，提交到本地仓库后，也需要推送到远程仓库，此时B用户晚于A用户，故需要先拉取远程仓库的提交，经过合井后才能推送到远端分支,如下图所示。</p><p>在B用户拉取代码时，因为A、B用户同一段时同修改了同一个文件的相同位置代码，故会发生合并冲突。</p><p>远程分支也是分支，所以合井时冲突的解决方式也和解決本地分支冲突相同相同</p></div>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)698. 划分为k个相等的子集</title>
      <link href="/2022/09/20/%E6%AF%8F%E6%97%A5LeetCode/2022-9/698%20%E5%88%92%E5%88%86%E4%B8%BAk%E4%B8%AA%E7%9B%B8%E7%AD%89%E7%9A%84%E5%AD%90%E9%9B%86/"/>
      <url>/2022/09/20/%E6%AF%8F%E6%97%A5LeetCode/2022-9/698%20%E5%88%92%E5%88%86%E4%B8%BAk%E4%B8%AA%E7%9B%B8%E7%AD%89%E7%9A%84%E5%AD%90%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个整数数组 <code>nums</code> 和一个正整数 <code>k</code>，找出是否有可能把这个数组分成 <code>k</code> 个非空子集，其总和都相等。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入： nums &#x3D; [4, 3, 2, 3, 5, 2, 1], k &#x3D; 4<br>输出： True<br>说明： 有可能将其分成 4 个子集（5），（1,4），（2,3），（2,3）等于总和。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>计算出nums的元素总和。</p><p>除以k，不能除尽，则说明不存在解</p><p>总和除以k，可以求出平均值，得出每个桶(arr数组)需要装的元素大小</p><p>利用回溯进行装球(nums中的元素)，得出解</p></div><div class="story post-story"><h2 id="代码-cpp-；"><a href="#代码-cpp-；" class="headerlink" title="代码(cpp)；"></a>代码(cpp)；</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">dfs</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> target, vector&lt;<span class="type">int</span>&gt; arr, <span class="type">int</span> k, <span class="type">int</span> index)</span></span>&#123;</span><br><span class="line">        <span class="comment">//如果index到了nums的末尾的后一位</span></span><br><span class="line">        <span class="keyword">if</span>(index == nums.<span class="built_in">size</span>())&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; a : arr)&#123;</span><br><span class="line">                <span class="comment">//如果有一个桶里的数不等于平均数，则返回false</span></span><br><span class="line">                <span class="keyword">if</span>(a != target) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//遍历完成，返回true</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//遍历每个桶</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; k; i++)&#123;</span><br><span class="line">            <span class="comment">//如果第i桶加上nums中的index位置的元素，大于平均数</span></span><br><span class="line">            <span class="keyword">if</span>(arr[i] + nums[index] &gt; target)</span><br><span class="line">                <span class="comment">//进入到下一个桶(i+1)</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">//第i桶加上index位置元素</span></span><br><span class="line">            arr[i] += nums[index];</span><br><span class="line"><span class="comment">//调用递归，插入index+1位置的元素</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">dfs</span>(nums, target, arr, k, index + <span class="number">1</span>))</span><br><span class="line">                <span class="comment">//如果递归完成后每个桶里的数都等于平均数，则返回为真</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="comment">//运行到这里说明，这个index位置的元素，放到i桶里不合适</span></span><br><span class="line">            <span class="comment">//将i桶中的这个位置的元素剔除，放到i+1桶里试试</span></span><br><span class="line">            arr[i] -= nums[index];</span><br><span class="line">            </span><br><span class="line"><span class="comment">//剔除这个位置的元素后，如果这个桶为0，则说明放到别的桶里也一样</span></span><br><span class="line">            <span class="comment">//每个桶要放的大小都一样</span></span><br><span class="line">            <span class="keyword">if</span>(arr[i] == <span class="number">0</span>) <span class="keyword">break</span>; <span class="comment">//剪枝</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//遍历完全后，还没有找到解，则返回false</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">canPartitionKSubsets</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果nums的元素个数小于k，则返回flase</span></span><br><span class="line">        <span class="keyword">if</span>(nums.<span class="built_in">size</span>() &lt; k) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">//获取nums的元素总和</span></span><br><span class="line">        <span class="type">int</span> sum = <span class="built_in">accumulate</span>(nums.<span class="built_in">begin</span>(),nums.<span class="built_in">end</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//如果不能被k除尽，则返回false</span></span><br><span class="line">        <span class="keyword">if</span>(sum%k != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">//降序排列</span></span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>(), <span class="built_in">greater</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line"><span class="comment">//获取sum的平均数</span></span><br><span class="line">        <span class="type">int</span> target = sum / k;</span><br><span class="line"><span class="comment">//用来记录每个桶的大小</span></span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">arr</span><span class="params">(k)</span></span>;</span><br><span class="line"><span class="comment">//调用回溯,得出解</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dfs</span>(nums, target, arr, k, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1636. 按照频率将数组升序排序</title>
      <link href="/2022/09/19/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1636%20%E6%8C%89%E7%85%A7%E9%A2%91%E7%8E%87%E5%B0%86%E6%95%B0%E7%BB%84%E5%8D%87%E5%BA%8F%E6%8E%92%E5%BA%8F/"/>
      <url>/2022/09/19/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1636%20%E6%8C%89%E7%85%A7%E9%A2%91%E7%8E%87%E5%B0%86%E6%95%B0%E7%BB%84%E5%8D%87%E5%BA%8F%E6%8E%92%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数数组 <code>nums</code> ，请你将数组按照每个值的频率 <strong>升序</strong> 排序。如果有多个值的频率相同，请你按照数值本身将它们 <strong>降序</strong> 排序。 </p><p>请你返回排序后的数组。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [1,1,2,2,2,3]<br>输出：[3,1,1,2,2,2]<br>解释：’3’ 频率为 1，’1’ 频率为 2，’2’ 频率为 3 。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>获取nums数组中的每个元素的频率，通过频率比较：</p><ul><li>如果频率相等的情况，按照元素的大小进行降序排列</li><li>如果频率不相等的情况，按照元素的排列大小进行升序排列</li></ul></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">frequencySort</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; map;</span><br><span class="line">        <span class="comment">//获取nums中各个元素的频率</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; num : nums)&#123;</span><br><span class="line">            map[num]++;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//给nums自定义排序</span></span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>(), [&amp;](<span class="type">int</span> a, <span class="type">int</span> b)&#123;</span><br><span class="line">            <span class="comment">//频率不相等的情况，按照升序排列</span></span><br><span class="line">            <span class="keyword">if</span>(map[a] != map[b])&#123;</span><br><span class="line">                <span class="keyword">return</span> map[a] &lt; map[b];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//排列相等的情况，按照降序排序</span></span><br><span class="line">            <span class="keyword">return</span> a &gt; b;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nums;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(nlogn)，其中 n 是数组 nums 的长度。排序消耗 O(nlogn) 时间。</p></li><li><p>空间复杂度：O(n)，存储数组元素频率的哈希表消耗 O(n) 空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1640. 能否连接形成数组</title>
      <link href="/2022/09/19/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1640%20%E8%83%BD%E5%90%A6%E8%BF%9E%E6%8E%A5%E5%BD%A2%E6%88%90%E6%95%B0%E7%BB%84/"/>
      <url>/2022/09/19/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1640%20%E8%83%BD%E5%90%A6%E8%BF%9E%E6%8E%A5%E5%BD%A2%E6%88%90%E6%95%B0%E7%BB%84/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数数组 arr ，数组中的每个整数 互不相同 。另有一个由整数数组构成的数组 pieces，其中的整数也 互不相同 。请你以 任意顺序 连接 pieces 中的数组以形成 arr 。但是，不允许 对每个数组 pieces[i] 中的整数重新排序。</p><p>如果可以连接 pieces 中的数组形成 arr ，返回 true ；否则，返回 false 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：arr &#x3D; [91,4,64,78], pieces &#x3D; [[78],[4,64],[91]]<br>输出：true<br>解释：依次连接 [91]、[4,64] 和 [78]</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>使用哈希表存储pieces中每个数组的首元素及其该数组的位置</p><p>再与arr数组比较：</p><ul><li>如果未找到(arr与pieces中的元素都相同)，则说明该元素不是pieces的数组中的首元素，返回false</li><li>如果找到，再依次比较后面的元素，如果有不同的元素，返回false</li></ul><p>直到遍历完全，没有上述问题，返回true</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">canFormArray</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; arr, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; pieces)</span> </span>&#123;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; map;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; pieces.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            map.<span class="built_in">emplace</span>(pieces[i][<span class="number">0</span>], i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(i &lt; arr.<span class="built_in">size</span>())&#123;</span><br><span class="line">            <span class="keyword">auto</span> temp = map.<span class="built_in">find</span>(arr[i]);</span><br><span class="line">            <span class="keyword">if</span>(temp != map.<span class="built_in">end</span>())&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; pieces[temp-&gt;second].<span class="built_in">size</span>(); j++)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(arr[i++] != pieces[temp-&gt;second][j])&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，其中 n 是数组 arr 的长度。</p></li><li><p>空间复杂度：O(n)。保存哈希表需要 O(n) 的空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2022/09/17/Java/%E6%89%8B%E5%86%99Spring/"/>
      <url>/2022/09/17/Java/%E6%89%8B%E5%86%99Spring/</url>
      
        <content type="html"><![CDATA[<hr><hr><h3 id="手写Spring启动和扫描"><a href="#手写Spring启动和扫描" class="headerlink" title="手写Spring启动和扫描"></a>手写Spring启动和扫描</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ComponentScan &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Component &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Scope &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanDefinition</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Class cls;</span><br><span class="line">    <span class="keyword">private</span> String scope;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BeanDefinition</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BeanDefinition</span><span class="params">(Class cls, String scope)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cls = cls;</span><br><span class="line">        <span class="built_in">this</span>.scope = scope;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class <span class="title function_">getCls</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cls;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCls</span><span class="params">(Class cls)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cls = cls;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getScope</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> scope;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setScope</span><span class="params">(String scope)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.scope = scope;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplicationContext</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Class ApplicationConfig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Object&gt; beanDefinitionMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyApplicationContext</span><span class="params">(Class ApplicationConfig)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ApplicationConfig = ApplicationConfig;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解析配置类</span></span><br><span class="line">        scan(ApplicationConfig);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//扫描路径中的bean</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scan</span><span class="params">(Class ApplicationConfig)</span> &#123;</span><br><span class="line">        <span class="comment">//判断是否存在ComponentScan注解</span></span><br><span class="line">        <span class="keyword">if</span> (!ApplicationConfig.isAnnotationPresent(ComponentScan.class))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;not found interface ComponentScan&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取ComponentScan注解</span></span><br><span class="line">        <span class="type">ComponentScan</span> <span class="variable">componentScan</span> <span class="operator">=</span> (ComponentScan) ApplicationConfig.getDeclaredAnnotation(ComponentScan.class);</span><br><span class="line">        <span class="comment">//获取扫描的路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> componentScan.value();</span><br><span class="line">        path = path.replace(<span class="string">&quot;.&quot;</span>,<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//扫描路径</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> MyApplicationContext.class.getClassLoader(); <span class="comment">//app</span></span><br><span class="line">        <span class="type">URL</span> <span class="variable">resource</span> <span class="operator">=</span> classLoader.getResource(path);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(resource.getFile()); <span class="comment">//获取目录</span></span><br><span class="line">        <span class="keyword">if</span> (file.isDirectory())&#123; <span class="comment">//目录是否为空</span></span><br><span class="line">            File[] files = file.listFiles(); <span class="comment">//获取目录中的类路径</span></span><br><span class="line">            <span class="keyword">for</span> (File f : files) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> f.getAbsolutePath(); <span class="comment">//获取类路径字符串</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (fileName.endsWith(<span class="string">&quot;.class&quot;</span>))&#123; <span class="comment">//判断是否是类文件</span></span><br><span class="line">                    <span class="comment">//分割获取指定的路径</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> fileName.substring(fileName.indexOf(<span class="string">&quot;com&quot;</span>),fileName.indexOf(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">                    className = className.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Class&lt;?&gt; cls = classLoader.loadClass(className); <span class="comment">//获取到类</span></span><br><span class="line">                        <span class="comment">//判断是否类中是否有Component注解</span></span><br><span class="line">                        <span class="keyword">if</span> (cls.isAnnotationPresent(Component.class))&#123;</span><br><span class="line">                            <span class="comment">//获取Component中的bean名</span></span><br><span class="line">                            <span class="type">Component</span> <span class="variable">component</span> <span class="operator">=</span> cls.getDeclaredAnnotation(Component.class);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> component.value();</span><br><span class="line"></span><br><span class="line">                            <span class="type">BeanDefinition</span> <span class="variable">definition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>();</span><br><span class="line">                            definition.setCls(cls);</span><br><span class="line"><span class="comment">//判断是否类中是否有Scope注解</span></span><br><span class="line">                            <span class="keyword">if</span> (cls.isAnnotationPresent(Scope.class))&#123;</span><br><span class="line">                                <span class="type">Scope</span> <span class="variable">scope</span> <span class="operator">=</span> cls.getDeclaredAnnotation(Scope.class);</span><br><span class="line">                                definition.setScope(scope.value());</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                definition.setScope(<span class="string">&quot;singleton&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            beanDefinitionMap.put(beanName, definition);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//TODO</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getBean</span><span class="params">(String beanName)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="手写getBean"><a href="#手写getBean" class="headerlink" title="手写getBean()"></a>手写getBean()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplicationContext</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Class ApplicationConfig;</span><br><span class="line">    <span class="comment">//单例对象池</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Object&gt; beanDefinitionMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyApplicationContext</span><span class="params">(Class ApplicationConfig)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ApplicationConfig = ApplicationConfig;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解析配置类</span></span><br><span class="line">        scan(ApplicationConfig);</span><br><span class="line">        <span class="comment">//创建出单例bean，多例bean无需创建随用随创</span></span><br><span class="line">        <span class="keyword">for</span> (String beanName : beanDefinitionMap.keySet()) &#123;</span><br><span class="line">            <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> (BeanDefinition) beanDefinitionMap.get(beanName);</span><br><span class="line">            <span class="keyword">if</span> (beanDefinition.getScope().equals(<span class="string">&quot;singleton&quot;</span>)) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> createBean(beanDefinition);</span><br><span class="line">                singletonObjects.put(beanName, bean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//通过beanDefinition中的cls创建bean</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">createBean</span><span class="params">(BeanDefinition beanDefinition)</span>&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> beanDefinition.getCls();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> cls.getDeclaredConstructor().newInstance();</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//扫描路径中的bean</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scan</span><span class="params">(Class ApplicationConfig)</span> &#123;</span><br><span class="line">        <span class="comment">//判断是否存在ComponentScan注解</span></span><br><span class="line">        <span class="keyword">if</span> (!ApplicationConfig.isAnnotationPresent(ComponentScan.class))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;not found interface ComponentScan&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取ComponentScan注解</span></span><br><span class="line">        <span class="type">ComponentScan</span> <span class="variable">componentScan</span> <span class="operator">=</span> (ComponentScan) ApplicationConfig.getDeclaredAnnotation(ComponentScan.class);</span><br><span class="line">        <span class="comment">//获取扫描的路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> componentScan.value();</span><br><span class="line">        path = path.replace(<span class="string">&quot;.&quot;</span>,<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//扫描路径</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> MyApplicationContext.class.getClassLoader(); <span class="comment">//app</span></span><br><span class="line">        <span class="type">URL</span> <span class="variable">resource</span> <span class="operator">=</span> classLoader.getResource(path);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(resource.getFile()); <span class="comment">//获取目录</span></span><br><span class="line">        <span class="keyword">if</span> (file.isDirectory())&#123; <span class="comment">//目录是否为空</span></span><br><span class="line">            File[] files = file.listFiles(); <span class="comment">//获取目录中的类路径</span></span><br><span class="line">            <span class="keyword">for</span> (File f : files) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> f.getAbsolutePath(); <span class="comment">//获取类路径字符串</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (fileName.endsWith(<span class="string">&quot;.class&quot;</span>))&#123; <span class="comment">//判断是否是类文件</span></span><br><span class="line">                    <span class="comment">//分割获取指定的路径</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> fileName.substring(fileName.indexOf(<span class="string">&quot;com&quot;</span>),fileName.indexOf(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">                    className = className.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Class&lt;?&gt; cls = classLoader.loadClass(className); <span class="comment">//获取到类</span></span><br><span class="line">                        <span class="comment">//判断是否类中是否有Component注解</span></span><br><span class="line">                        <span class="keyword">if</span> (cls.isAnnotationPresent(Component.class))&#123; </span><br><span class="line">                            <span class="comment">//获取Component中的bean名</span></span><br><span class="line">                            <span class="type">Component</span> <span class="variable">component</span> <span class="operator">=</span> cls.getDeclaredAnnotation(Component.class);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> component.value();</span><br><span class="line"></span><br><span class="line">                            <span class="type">BeanDefinition</span> <span class="variable">definition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>();</span><br><span class="line">                            definition.setCls(cls);</span><br><span class="line"><span class="comment">//判断是否类中是否有Scope注解</span></span><br><span class="line">                            <span class="keyword">if</span> (cls.isAnnotationPresent(Scope.class))&#123;</span><br><span class="line">                                <span class="type">Scope</span> <span class="variable">scope</span> <span class="operator">=</span> cls.getDeclaredAnnotation(Scope.class);</span><br><span class="line">                                definition.setScope(scope.value());</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                definition.setScope(<span class="string">&quot;singleton&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            beanDefinitionMap.put(beanName, definition);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//getBean方法</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getBean</span><span class="params">(String beanName)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanDefinitionMap.containsKey(beanName))&#123;</span><br><span class="line">            <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> (BeanDefinition) beanDefinitionMap.get(beanName);</span><br><span class="line">            <span class="keyword">if</span> (beanDefinition.getScope().equals(<span class="string">&quot;singleton&quot;</span>))&#123;</span><br><span class="line">                <span class="comment">//如果是单例bean，直接在单例池中取</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> singletonObjects.get(beanName);</span><br><span class="line">                <span class="keyword">return</span> bean;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//多例bean就创建新的bean对象</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> createBean(beanDefinition);</span><br><span class="line">                <span class="keyword">return</span> bean;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;not found bean&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><p>配置类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(&quot;com.mine.service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyApplicationContext</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyApplicationContext</span>(AppConfig.class);</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) app.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService1</span> <span class="operator">=</span> (UserService) app.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService2</span> <span class="operator">=</span> (UserService) app.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;userService = &quot;</span> + userService);</span><br><span class="line">        System.out.println(<span class="string">&quot;userService1 = &quot;</span> + userService1);</span><br><span class="line">        System.out.println(<span class="string">&quot;userService2 = &quot;</span> + userService2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将UserService设置为单例(默认就为单例)：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;userService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">userService2 = com.mine.service.UserService@2<span class="type">e817b38</span></span><br><span class="line"><span class="variable">userService1</span> <span class="operator">=</span> com.mine.service.UserService@2<span class="type">e817b38</span></span><br><span class="line"><span class="variable">userService3</span> <span class="operator">=</span> com.mine.service.UserService@2e817b38</span><br></pre></td></tr></table></figure></blockquote><p>将UserService设为多例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;userService&quot;)</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">userService2 = com.mine.service.UserService@433<span class="type">c675d</span></span><br><span class="line"><span class="variable">userService1</span> <span class="operator">=</span> com.mine.service.UserService@3<span class="type">f91beef</span></span><br><span class="line"><span class="variable">userService3</span> <span class="operator">=</span> com.mine.service.UserService@1a6c5a9e</span><br></pre></td></tr></table></figure><h3 id="手写依赖注入"><a href="#手写依赖注入" class="headerlink" title="手写依赖注入"></a>手写依赖注入</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.FIELD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Autowired &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;orderService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;userService&quot;)</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;orderService = &quot;</span> + orderService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在createBean方法中添加：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">createBean</span><span class="params">(BeanDefinition beanDefinition)</span>&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> beanDefinition.getCls();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> cls.getDeclaredConstructor().newInstance();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//获取每个字段</span></span><br><span class="line">            <span class="keyword">for</span> (Field field : cls.getDeclaredFields()) &#123;</span><br><span class="line">                <span class="comment">//判断该字段是否有Autowired注解</span></span><br><span class="line">                <span class="keyword">if</span> (field.isAnnotationPresent(Autowired.class)) &#123;</span><br><span class="line">                    field.setAccessible(<span class="literal">true</span>); <span class="comment">//设置可以访问private变量的变量值</span></span><br><span class="line">                    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> getBean(field.getName());</span><br><span class="line">                    <span class="comment">//将该字段注入</span></span><br><span class="line">                    field.set(instance, bean);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="测试：-1"><a href="#测试：-1" class="headerlink" title="测试："></a>测试：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyApplicationContext</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyApplicationContext</span>(AppConfig.class);</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) app.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;userService = &quot;</span> + userService);</span><br><span class="line">        userService.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">userService = com.mine.service.UserService@179d3b25</span><br><span class="line">orderService = com.mine.service.OrderService@254989ff</span><br></pre></td></tr></table></figure></blockquote><h3 id="Aware回调"><a href="#Aware回调" class="headerlink" title="Aware回调"></a>Aware回调</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanNameAware</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setBeanName</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现BeanNameAware的接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;userService&quot;)</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> <span class="keyword">implements</span> <span class="title class_">BeanNameAware</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String beanName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        beanName = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;orderService = &quot;</span> + orderService);</span><br><span class="line">        System.out.println(<span class="string">&quot;beanName = &quot;</span> + beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要在createBean添加内容，并添加一个参数(记得把调用的createBean方法也进行修改)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span>&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> beanDefinition.getCls();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> cls.getDeclaredConstructor().newInstance();</span><br><span class="line">            <span class="comment">//获取每个字段</span></span><br><span class="line">            <span class="keyword">for</span> (Field field : cls.getDeclaredFields()) &#123;</span><br><span class="line">                <span class="comment">//判断该字段是否有Autowired注解</span></span><br><span class="line">                <span class="keyword">if</span> (field.isAnnotationPresent(Autowired.class)) &#123;</span><br><span class="line">                    field.setAccessible(<span class="literal">true</span>); <span class="comment">//设置可以访问private变量的变量值</span></span><br><span class="line">                    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> getBean(field.getName());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//将该字段注入</span></span><br><span class="line">                    field.set(instance, bean);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//Aware回调</span></span><br><span class="line">            <span class="keyword">if</span> (instance <span class="keyword">instanceof</span> BeanNameAware) &#123; <span class="comment">//判断instance是否实现了BeanNameAware的方法</span></span><br><span class="line">                ((BeanNameAware) instance).setBeanName(beanName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="测试：-2"><a href="#测试：-2" class="headerlink" title="测试："></a>测试：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyApplicationContext</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyApplicationContext</span>(AppConfig.class);</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) app.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;userService = &quot;</span> + userService);</span><br><span class="line">        userService.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果·：</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">userService = com.mine.service.UserService@254989<span class="type">ff</span></span><br><span class="line"><span class="variable">orderService</span> <span class="operator">=</span> com.mine.service.OrderService@5<span class="type">d099f62</span></span><br><span class="line"><span class="variable">beanName</span> <span class="operator">=</span> userService</span><br></pre></td></tr></table></figure></blockquote><h3 id="初始化机制"><a href="#初始化机制" class="headerlink" title="初始化机制"></a>初始化机制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;userService&quot;)</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;orderService = &quot;</span> + orderService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;初始化&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span>&#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> beanDefinition.getCls();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> cls.getDeclaredConstructor().newInstance();</span><br><span class="line">        <span class="comment">//获取每个字段</span></span><br><span class="line">        <span class="keyword">for</span> (Field field : cls.getDeclaredFields()) &#123;</span><br><span class="line">            <span class="comment">//判断该字段是否有Autowired注解</span></span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(Autowired.class)) &#123;</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>); <span class="comment">//设置可以访问private变量的变量值</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> getBean(field.getName());</span><br><span class="line"></span><br><span class="line">                <span class="comment">//将该字段注入</span></span><br><span class="line">                field.set(instance, bean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Aware回调</span></span><br><span class="line">        <span class="keyword">if</span> (instance <span class="keyword">instanceof</span> BeanNameAware) &#123; <span class="comment">//instance是否实现了BeanNameAware的方法</span></span><br><span class="line">            ((BeanNameAware) instance).setBeanName(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//初始化</span></span><br><span class="line">        <span class="keyword">if</span> (instance <span class="keyword">instanceof</span> InitializingBean) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ((InitializingBean) instance).afterPropertiesSet();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试：-3"><a href="#测试：-3" class="headerlink" title="测试："></a>测试：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyApplicationContext</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyApplicationContext</span>(AppConfig.class);</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) app.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;userService = &quot;</span> + userService);</span><br><span class="line">        userService.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">初始化</span><br><span class="line">userService = com.mine.service.UserService@254989ff</span><br><span class="line">orderService = com.mine.service.OrderService@5d099f62</span><br></pre></td></tr></table></figure></blockquote><h3 id="手写BeanPostProcessor机制"><a href="#手写BeanPostProcessor机制" class="headerlink" title="手写BeanPostProcessor机制"></a>手写BeanPostProcessor机制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span>;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;初始化前&quot;</span>+beanName);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;初始化后&quot;</span>+beanName);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>scan方法中的部分代码，添加判断BeanPostProcessor接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">                        Class&lt;?&gt; cls = classLoader.loadClass(className); <span class="comment">//获取到类</span></span><br><span class="line">                        <span class="keyword">if</span> (cls.isAnnotationPresent(Component.class))&#123; <span class="comment">//判断是否类中是否有Component注解</span></span><br><span class="line">                            <span class="comment">//判断是否实现了BeanPostProcessor接口</span></span><br><span class="line">                            <span class="keyword">if</span>(BeanPostProcessor.class.isAssignableFrom(cls)) &#123;</span><br><span class="line">                                <span class="type">BeanPostProcessor</span> <span class="variable">beanPostProcessor</span> <span class="operator">=</span> (BeanPostProcessor) cls.getDeclaredConstructor().newInstance();</span><br><span class="line">                                beanPostProcessorList.add(beanPostProcessor);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="type">Component</span> <span class="variable">component</span> <span class="operator">=</span> cls.getDeclaredAnnotation(Component.class);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> component.value();</span><br><span class="line"></span><br><span class="line">                            <span class="type">BeanDefinition</span> <span class="variable">definition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>();</span><br><span class="line">                            definition.setCls(cls);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (cls.isAnnotationPresent(Scope.class))&#123;</span><br><span class="line">                                <span class="type">Scope</span> <span class="variable">scope</span> <span class="operator">=</span> cls.getDeclaredAnnotation(Scope.class);</span><br><span class="line">                                definition.setScope(scope.value());</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                definition.setScope(<span class="string">&quot;singleton&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            beanDefinitionMap.put(beanName, definition);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span>&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> beanDefinition.getCls();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> cls.getDeclaredConstructor().newInstance();</span><br><span class="line">            <span class="comment">//获取每个字段</span></span><br><span class="line">            <span class="keyword">for</span> (Field field : cls.getDeclaredFields()) &#123;</span><br><span class="line">                <span class="comment">//判断该字段是否有Autowired注解</span></span><br><span class="line">                <span class="keyword">if</span> (field.isAnnotationPresent(Autowired.class)) &#123;</span><br><span class="line">                    field.setAccessible(<span class="literal">true</span>); <span class="comment">//设置可以访问private变量的变量值</span></span><br><span class="line">                    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> getBean(field.getName());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//将该字段注入</span></span><br><span class="line">                    field.set(instance, bean);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//Aware回调</span></span><br><span class="line">            <span class="keyword">if</span> (instance <span class="keyword">instanceof</span> BeanNameAware) &#123; <span class="comment">//o是否实现了BeanNameAware的方法</span></span><br><span class="line">                ((BeanNameAware) instance).setBeanName(beanName);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//调用初始化前定义的方法</span></span><br><span class="line">            <span class="keyword">for</span> (BeanPostProcessor beanPostProcessor : beanPostProcessorList) &#123;</span><br><span class="line">                instance = beanPostProcessor.postProcessBeforeInitialization(instance, beanName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//初始化</span></span><br><span class="line">            <span class="keyword">if</span> (instance <span class="keyword">instanceof</span> InitializingBean) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ((InitializingBean) instance).afterPropertiesSet();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//调用初始化后定义的方法</span></span><br><span class="line">            <span class="keyword">for</span> (BeanPostProcessor beanPostProcessor : beanPostProcessorList) &#123;</span><br><span class="line">                instance = beanPostProcessor.postProcessAfterInitialization(instance, beanName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyApplicationContext</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyApplicationContext</span>(AppConfig.class);</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) app.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">初始化前</span><br><span class="line">初始化后</span><br><span class="line">初始化前orderService</span><br><span class="line">初始化后orderService</span><br><span class="line">初始化前userService</span><br><span class="line">初始化后userService</span><br></pre></td></tr></table></figure></blockquote><p>手写Bean生命周期</p><p>手写Aop机制</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2022/09/17/Java/Java%E5%9F%BA%E7%A1%80/"/>
      <url>/2022/09/17/Java/Java%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<hr><hr><div class="story post-story"><h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><p>java中注解分为两种：<strong>元注解</strong>与<strong>自定义注解</strong></p><ul><li>元注解：描述注解的注解</li><li>自定义注解：开发者自己定义的注解，如Spring框架中<code>@Value</code>、<code>@Autowired</code>等</li></ul><p>JDK提供了4个标准的注解：</p><table><thead><tr><th>元注解</th><th>作用</th></tr></thead><tbody><tr><td>@Target</td><td>指定注解使用的作用范围(类、方法、字段等)</td></tr><tr><td>@Retention</td><td>指定注解的生命周期(源码、class文件、运行等)</td></tr><tr><td>@Documented</td><td>表示该注解会被javadoc文档记录</td></tr><tr><td>@Inherited</td><td>表示该注解的子类可以继承父类的注解，只能作用于类上的注解</td></tr></tbody></table><p>除了以上4个注解其余都是自定义注解</p><p>元注解参数说明：</p><ul><li>@Target参数<ul><li><strong>ElementType.METHOD：用于描述方法</strong></li><li><strong>ElementType.TYPE：用于描述类、接口(包括注解类型)或enum声明</strong></li><li>ElementType.CONSTRUCTOR：用于描述构造器</li><li>ElementType.FIELD：成员变量、对象、属性(包括enum实例)</li><li>ElementType.LOCAL_VARIABLE：用于描述局部变量</li><li>ElementType.PACKAGE：用于描述包</li><li>ElementType.PARAMETER：用于描述参数</li><li>ElementType.ANNOTATION_TYPE:用于描述参数</li></ul></li><li>@Retention参数<ul><li><strong>RetentionPolicy.RUNTIME：始终不会丢弃</strong>，运行期也保留该注解，因此可以使用反射机制读取该注解的信息</li><li>RetentionPolicy.SOURCE：在编译阶段丢弃，这些注解在编译结束后就不再有任何意义，所以它们不会写入字节码。如：<code>@Override</code>就属于这类注解</li><li>RetentionPolicy.CLASS：在类加载的时候丢弃，在字节码文件的处理中有用，注解默认使用这种方式</li></ul></li></ul><p>自定义注解实现：</p><blockquote><p>需求：需要记录方法的入口参数以及方法的返回参数，以及方法执行的时间</p></blockquote><p>自定义一个<code>@MyLog</code>注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyLog &#123;</span><br><span class="line">    <span class="comment">//描述方法</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h3><p>ThreadLocal叫做<strong>线程变量</strong>，意思是ThreadLocal中填充的<strong>变量属于当前线程</strong>，该变量对<strong>其他线程而言是隔离</strong>的，也就是说<strong>该变量是当前线程独有的变量</strong>。</p><p>ThreadLocal为变量在每个线程中都创建了一个副本，那么<strong>每个线程只可以访问自己内部的副本变量</strong>。</p><p>ThreadLocal 适用于<strong>每个线程需要自己独立的实例且该实例需要在多个方法中被使用</strong>，即变量在线程间隔离而在方法或类间共享的场景</p><h3 id="2-基本使用"><a href="#2-基本使用" class="headerlink" title="2.基本使用"></a>2.基本使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//设置当前线程的本地变量</span></span><br><span class="line">        threadLocal.set(<span class="string">&quot;ayb&quot;</span>);</span><br><span class="line">        <span class="comment">//获取当前线程的本地变量</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> threadLocal.get();</span><br><span class="line">        <span class="comment">//删除当前线程的本地变量</span></span><br><span class="line">        threadLocal.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-原理分析"><a href="#3-原理分析" class="headerlink" title="3.原理分析"></a>3.原理分析</h3><p>从<code>ThreadLocal</code>的<code>set()</code>方法看：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="comment">//获取当前线程对象</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">//获取ThreadLocalMap对象</span></span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="comment">//判断ThreadLocalMap对象是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//存在ThreadLocalMap对象，设置设置key,value，中this为ThreadLocal对象</span></span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//不存在ThreadLocalMap对象，则创建ThreadLocalMap，并且设置key,value</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ThreadLocalMap map = getMap(t)</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ThreadLocal类的getMap()方法</span></span><br><span class="line">ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">    <span class="comment">//返回ThreadLocalMap对象</span></span><br><span class="line">    <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先看<code>map.set(this, value)</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ThreadLocalMap类的set()方法</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> &#123;</span><br><span class="line">    <span class="comment">//获取ThreadLocalMap中，私有成员Entry数组table</span></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//判断是否存在此key</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i];</span><br><span class="line">         e != <span class="literal">null</span>;</span><br><span class="line">         e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.refersTo(key)) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e.refersTo(<span class="literal">null</span>)) &#123;</span><br><span class="line">            replaceStaleEntry(key, value, i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//将key，value放入Entry数组中，key为ThreadLocal</span></span><br><span class="line">    tab[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line">    <span class="type">int</span> <span class="variable">sz</span> <span class="operator">=</span> ++size;</span><br><span class="line">    <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">        rehash();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再看<code>createMap(t, value)</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ThreadLocal的create()方法</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">    <span class="comment">//实例化ThreadLocalMap对象，保存在Thread对象的threadLocals变量中</span></span><br><span class="line">    <span class="comment">//其中this为ThreadLocal对象</span></span><br><span class="line">    t.threadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ThreadLocalMap(this, firstValue)的构造函数</span></span><br><span class="line">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">    <span class="comment">//初始化table数组</span></span><br><span class="line">    table = <span class="keyword">new</span> <span class="title class_">Entry</span>[INITIAL_CAPACITY];</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//将key， value放入table数组中</span></span><br><span class="line">    table[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(firstKey, firstValue);</span><br><span class="line">    size = <span class="number">1</span>;</span><br><span class="line">    setThreshold(INITIAL_CAPACITY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Thread</code>、<code>ThreadLocal</code>、<code>ThreadLocalMap</code>的关系：</p><img src="https://s2.loli.net/2023/02/01/QeSpgP4F5V37n1N.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/01/QeSpgP4F5V37n1N.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-01_13-55-47.png" style="zoom:67%;" /><blockquote><p>执行<code>ThreadLocal.set(T value)</code>方法，通过调用<code>ThreadLocal.getMap(Thread t)</code>方法</p><ul><li>得到当前线程的<code>ThreadLocalMap</code>对象</li><li><strong>如果存在</strong>，以此<code>ThreadLocal</code>对象为<strong>key</strong>以及<strong>value</strong>，插入到<code>ThreadLocalMap</code>的Entry数组中</li><li><strong>如果不存在</strong>，则创建<code>ThreadLocalMap</code>对象，以此<code>ThreadLocal</code>对象为<strong>key</strong>以及<strong>value</strong>，插入到<code>ThreadLocalMap</code>的Entry数组中</li></ul></blockquote></div>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1624. 两个相同字符之间的最长子字符串</title>
      <link href="/2022/09/17/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1624%20%E4%B8%A4%E4%B8%AA%E7%9B%B8%E5%90%8C%E5%AD%97%E7%AC%A6%E4%B9%8B%E9%97%B4%E7%9A%84%E6%9C%80%E9%95%BF%E5%AD%90%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
      <url>/2022/09/17/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1624%20%E4%B8%A4%E4%B8%AA%E7%9B%B8%E5%90%8C%E5%AD%97%E7%AC%A6%E4%B9%8B%E9%97%B4%E7%9A%84%E6%9C%80%E9%95%BF%E5%AD%90%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个字符串 s，请你返回 两个相同字符之间的最长子字符串的长度 ，计算长度时不含这两个字符。如果不存在这样的子字符串，返回 -1 。</p><p>子字符串 是字符串中的一个连续字符序列。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “abca”<br>输出：2<br>解释：最优的子字符串是 “bc” 。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>使用哈希表存放某个字母第一次出现的位置，之后与后面再次出现的字母得到字串长度，最后得到最长的字串长度</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    unordered_map&lt;<span class="type">char</span>, <span class="type">int</span>&gt; map;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxLengthBetweenEqualCharacters</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">auto</span> it = map.<span class="built_in">find</span>(s[i]);</span><br><span class="line">            <span class="keyword">if</span>(it == map.<span class="built_in">end</span>())&#123;</span><br><span class="line">                map.<span class="built_in">emplace</span>(s[i], i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">int</span> temp = i - <span class="number">1</span> - it-&gt;second;</span><br><span class="line">                ans = <span class="built_in">max</span>(temp, ans);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，其中 n 表示字符串的长度。我们只需遍历一遍字符串即可。</p></li><li><p>空间复杂度：O(∣Σ∣)，其中 Σ 是字符集，在本题中字符集为所有小写字母，∣Σ∣&#x3D;26。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)670. 最大交换</title>
      <link href="/2022/09/13/%E6%AF%8F%E6%97%A5LeetCode/2022-9/670%20%E6%9C%80%E5%A4%A7%E4%BA%A4%E6%8D%A2/"/>
      <url>/2022/09/13/%E6%AF%8F%E6%97%A5LeetCode/2022-9/670%20%E6%9C%80%E5%A4%A7%E4%BA%A4%E6%8D%A2/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个非负整数，你<strong>至多</strong>可以交换一次数字中的任意两位。返回你能得到的最大值。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入: 2736<br>输出: 7236<br>解释: 交换数字2和数字7。</p></blockquote></div><div class="story post-story"><h2 id="思路：遍历"><a href="#思路：遍历" class="headerlink" title="思路：遍历"></a>思路：遍历</h2><p>先用第一个数字与后面的数字比较，找出最大的并且大于第一个数字，未找到，则用第二个数字与后面的数字比较</p><p>依次遍历，直到找到有比所比较的数字大的数字后交换位置，返回交换后的数字</p><p>如果遍历完全后，未找到，则说明，此数字已经为最大数，直接返回</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maximumSwap</span><span class="params">(<span class="type">int</span> num)</span> </span>&#123;</span><br><span class="line">        string str = <span class="built_in">to_string</span>(num);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; str.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="type">int</span> temp = i;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = str.<span class="built_in">size</span>() - <span class="number">1</span>; j &gt;=  i + <span class="number">1</span>; j--)&#123;</span><br><span class="line">                <span class="keyword">if</span>(str[temp] &lt; str[j])&#123;</span><br><span class="line">                    temp = j;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(temp != i)&#123;</span><br><span class="line">                <span class="built_in">swap</span>(str[i], str[temp]);</span><br><span class="line">                <span class="type">int</span> ans = <span class="built_in">stoi</span>(str);</span><br><span class="line">                <span class="keyword">return</span> ans;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n^2)</p></li><li><p>空间复杂度：O(n)</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1608. 特殊数组的特征值</title>
      <link href="/2022/09/12/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1608%20%E7%89%B9%E6%AE%8A%E6%95%B0%E7%BB%84%E7%9A%84%E7%89%B9%E5%BE%81%E5%80%BC/"/>
      <url>/2022/09/12/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1608%20%E7%89%B9%E6%AE%8A%E6%95%B0%E7%BB%84%E7%9A%84%E7%89%B9%E5%BE%81%E5%80%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个非负整数数组 nums 。如果存在一个数 x ，使得 nums 中恰好有 x 个元素 大于或者等于 x ，那么就称 nums 是一个 特殊数组 ，而 x 是该数组的 特征值 。</p><p>注意： x 不必 是 nums 的中的元素。</p><p>如果数组 nums 是一个 特殊数组 ，请返回它的特征值 x 。否则，返回 -1 。可以证明的是，如果 nums 是特殊数组，那么其特征值 x 是 唯一的 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [3,5]<br>输出：2<br>解释：有 2 个元素（3 和 5）大于或等于 2 。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-：暴力枚举"><a href="#代码-cpp-：暴力枚举" class="headerlink" title="代码(cpp)：暴力枚举"></a>代码(cpp)：暴力枚举</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">specialArray</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> size = nums.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt;= size; i++)&#123;</span><br><span class="line">            <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; size; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(nums[j] &gt;= i)&#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(count == i)&#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="思路：降序排序-一次遍历"><a href="#思路：降序排序-一次遍历" class="headerlink" title="思路：降序排序+一次遍历"></a>思路：降序排序+一次遍历</h2><p>先将nums数组降序排序，</p><p>先以<code>x = 0</code>为例：这就说明nums数组中第一个元素以及之后的都要小于x</p><p><code>x = 1</code>时：nums数组第一个元素要大于等于x，之后的要小于x</p><p><code>x = 2</code>时：nums数组第二个元素要大于等于x(因为是降序所以第一个元素肯定大于x)，之后的要小于x</p><p>结论：<code>nums[x-1] &gt;= x</code>并且<code>num[x] &lt; x</code></p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> <span class="title function_">specialArray</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> nums.size();</span><br><span class="line"><span class="comment">//降序排列</span></span><br><span class="line">        sort(nums.begin(), nums.end(), greater&lt;<span class="type">int</span>&gt;());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt;= size; x++)&#123;</span><br><span class="line">        <span class="comment">//如果存在nums[x-1] &lt; x的情况，跳出此次遍历，进入下一个</span></span><br><span class="line">            <span class="keyword">if</span>(x-<span class="number">1</span> &gt;=<span class="number">0</span> &amp;&amp; nums[x-<span class="number">1</span>] &lt; x)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//如果num[x] &lt; x，返回x</span></span><br><span class="line">            <span class="keyword">if</span>(x == size || nums[x] &lt; i)&#123;</span><br><span class="line">                <span class="keyword">return</span> x;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(nlogn)，其中 n 是数组 nums 的长度。</p></li><li><p>空间复杂度：O(logn)，即为排序需要的栈空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1619. 删除某些元素后的数组均值</title>
      <link href="/2022/09/12/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1619%20%E5%88%A0%E9%99%A4%E6%9F%90%E4%BA%9B%E5%85%83%E7%B4%A0%E5%90%8E%E7%9A%84%E6%95%B0%E7%BB%84%E5%9D%87%E5%80%BC/"/>
      <url>/2022/09/12/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1619%20%E5%88%A0%E9%99%A4%E6%9F%90%E4%BA%9B%E5%85%83%E7%B4%A0%E5%90%8E%E7%9A%84%E6%95%B0%E7%BB%84%E5%9D%87%E5%80%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数数组 <code>arr</code> ，请你删除最小 <code>5%</code> 的数字和最大 <code>5%</code> 的数字后，剩余数字的平均值。</p><p>与 <strong>标准答案</strong> 误差在 <code>10^(-5)</code> 的结果都被视为正确结果。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：arr &#x3D; [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3]<br>输出：2.00000<br>解释：删除数组中最大和最小的元素后，所有元素都等于 2，所以平均值为 2 。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>将size设为数组的元素个数</p><p>将数组排序后，将左边<code>size*0.05</code>个元素删除，并且将右边<code>size*0.05</code>个元素删除</p><p>再计算出总和除以<code>size*0.9</code>个元素(删除左右两边各<code>size*0.05</code>个元素，还剩<code>size*0.9</code>个元素)</p><p>返回平均数</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">trimMean</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; arr)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">sort</span>(arr.<span class="built_in">begin</span>(), arr.<span class="built_in">end</span>());</span><br><span class="line">        <span class="type">int</span> size = arr.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> temp = <span class="built_in">int</span>(size * <span class="number">0.05</span>);</span><br><span class="line">        <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = temp; i &lt; size - temp; i++)&#123;</span><br><span class="line">            sum += arr[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">double</span> ans = sum / (size*<span class="number">0.9</span>);</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(nlogn)，其中 n 是数组 arr 的长度。</p></li><li><p>空间复杂度：O(logn)。排序需要 O(logn) 的栈空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)669. 修剪二叉搜索树</title>
      <link href="/2022/09/10/%E6%AF%8F%E6%97%A5LeetCode/2022-9/669%20%E4%BF%AE%E5%89%AA%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91/"/>
      <url>/2022/09/10/%E6%AF%8F%E6%97%A5LeetCode/2022-9/669%20%E4%BF%AE%E5%89%AA%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你二叉搜索树的根节点 root ，同时给定最小边界low 和最大边界 high。通过修剪二叉搜索树，使得所有节点的值在[low, high]中。修剪树 不应该 改变保留在树中的元素的相对结构 (即，如果没有被移除，原有的父代子代关系都应当保留)。 可以证明，存在 唯一的答案 。</p><p>所以结果应当返回修剪好的二叉搜索树的新的根节点。注意，根节点可能会根据给定的边界发生改变。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2020/09/09/trim2.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2020/09/09/trim2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:50%;" /><blockquote><p>输入：root &#x3D; [3,0,4,null,2,null,null,1], low &#x3D; 1, high &#x3D; 3<br>输出：[3,2,null,1]</p></blockquote></div><div class="story post-story"><h2 id="思路：DFS"><a href="#思路：DFS" class="headerlink" title="思路：DFS"></a>思路：DFS</h2><p>通过深度优先搜索，找出不符合<code>[low, high]</code>区间的结点，并剔除</p><p>二叉平衡树的性质：父节点大于左子树，小于右子树</p><p>如果有节点存在，<code>val</code>值小于<code>low</code>值，则说明该节点的左子树，也均小于<code>low</code>值</p><p>同理，如果有节点存在，<code>val</code>值大于<code>high</code>值，则说明该节点的右子树，也均大于<code>high</code>值</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution1</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">trimBST</span><span class="params">(TreeNode* root, <span class="type">int</span> low, <span class="type">int</span> high)</span> </span>&#123;</span><br><span class="line"><span class="comment">//找到符合区间的结点</span></span><br><span class="line">        <span class="keyword">while</span>(root != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(root-&gt;val &lt; low)</span><br><span class="line">                root = root-&gt;right; </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(root-&gt;val &gt; high)</span><br><span class="line">                root = root-&gt;left;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//遍历左右子树</span></span><br><span class="line">        <span class="keyword">if</span>(root != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">            root-&gt;left = <span class="built_in">trimBST</span>(root-&gt;left, low, high);</span><br><span class="line">            root-&gt;right = <span class="built_in">trimBST</span>(root-&gt;right, low, high);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="官方代码-cpp-："><a href="#官方代码-cpp-：" class="headerlink" title="官方代码(cpp)："></a>官方代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">trimBST</span><span class="params">(TreeNode* root, <span class="type">int</span> low, <span class="type">int</span> high)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">//小于low的情况</span></span><br><span class="line">        <span class="keyword">if</span> (root-&gt;val &lt; low)</span><br><span class="line">            <span class="comment">//返回该节点的右子树</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">trimBST</span>(root-&gt;right, low, high);</span><br><span class="line">        <span class="comment">//大于high的情况</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (root-&gt;val &gt; high)</span><br><span class="line">            <span class="comment">//返回该节点的左子树</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">trimBST</span>(root-&gt;left, low, high);</span><br><span class="line">        <span class="comment">//遍历左右子树</span></span><br><span class="line">root-&gt;left = <span class="built_in">trimBST</span>(root-&gt;left, low, high);</span><br><span class="line">root-&gt;right = <span class="built_in">trimBST</span>(root-&gt;right, low, high);</span><br><span class="line">        </span><br><span class="line"><span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)，其中 n 为二叉树的结点数目。</li><li>空间复杂度：O(n)。递归栈最坏情况下需要 O(n) 的空间。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2022/09/09/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/Docker%E5%AE%89%E8%A3%85Nacos/"/>
      <url>/2022/09/09/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/Docker%E5%AE%89%E8%A3%85Nacos/</url>
      
        <content type="html"><![CDATA[<hr><hr><div class="story post-story"><h2 id="1-安装Nacos"><a href="#1-安装Nacos" class="headerlink" title="1.安装Nacos"></a>1.安装Nacos</h2><h3 id="1-1-搜索Nacos镜像"><a href="#1-1-搜索Nacos镜像" class="headerlink" title="1.1 搜索Nacos镜像"></a>1.1 搜索Nacos镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search nacos</span><br></pre></td></tr></table></figure><h3 id="1-2-拉取Nacos镜像"><a href="#1-2-拉取Nacos镜像" class="headerlink" title="1.2 拉取Nacos镜像"></a>1.2 拉取Nacos镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nacos/nacos-server</span><br></pre></td></tr></table></figure><h3 id="1-3-启动Nacos容器"><a href="#1-3-启动Nacos容器" class="headerlink" title="1.3 启动Nacos容器"></a>1.3 启动Nacos容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -id \</span><br><span class="line">--name c_nacos \</span><br><span class="line">-p 8848:8848 \</span><br><span class="line">--privileged=true \</span><br><span class="line">-e MODE=standalone \</span><br><span class="line">-e PREFER_HOST_MODE=hostname \</span><br><span class="line">nacos/nacos-server:latest</span><br></pre></td></tr></table></figure><p>参数：</p><ul><li><code>--privileged=true</code>：使容器内的root拥有真正的root权限</li></ul><h3 id="1-4-测试"><a href="#1-4-测试" class="headerlink" title="1.4 测试"></a>1.4 测试</h3><p>访问：<code>http://主机地址:8848/nacos/index.html</code></p></div><div class="story post-story"><h2 id="2-搭建Nacos集群"><a href="#2-搭建Nacos集群" class="headerlink" title="2.搭建Nacos集群"></a>2.搭建Nacos集群</h2><p>2.1 拉取mysql镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql</span><br></pre></td></tr></table></figure><p>2.2 拉取</p></div>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1598. 文件夹操作日志搜集器</title>
      <link href="/2022/09/09/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1598%20%E6%96%87%E4%BB%B6%E5%A4%B9%E6%93%8D%E4%BD%9C%E6%97%A5%E5%BF%97%E6%90%9C%E9%9B%86%E5%99%A8/"/>
      <url>/2022/09/09/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1598%20%E6%96%87%E4%BB%B6%E5%A4%B9%E6%93%8D%E4%BD%9C%E6%97%A5%E5%BF%97%E6%90%9C%E9%9B%86%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>每当用户执行变更文件夹操作时，LeetCode 文件系统都会保存一条日志记录。</p><p>下面给出对变更操作的说明：</p><ul><li><code>&quot;../&quot;</code> ：移动到当前文件夹的父文件夹。如果已经在主文件夹下，则 <strong>继续停留在当前文件夹</strong> 。</li><li><code>&quot;./&quot;</code> ：继续停留在当前文件夹。</li><li><code>&quot;x/&quot;</code> ：移动到名为 x 的子文件夹中。题目数据 保证总是存在文件夹 x 。<br>给你一个字符串列表 logs ，其中 logs[i] 是用户在 i^th 步执行的操作。</li></ul><p>文件系统启动时位于主文件夹，然后执行 logs 中的操作。</p><p>执行完所有变更文件夹操作后，请你找出 <strong>返回主文件夹所需的最小步数</strong> 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/09/26/sample_11_1957.png" class="lazyload" data-srcset="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/09/26/sample_11_1957.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:67%;" /><blockquote><p>输入：logs &#x3D; [“d1&#x2F;“,”d2&#x2F;“,”..&#x2F;“,”d21&#x2F;“,”.&#x2F;“]<br>输出：2<br>解释：执行 “..&#x2F;“ 操作变更文件夹 2 次，即可回到主文件夹</p></blockquote></div><div class="story post-story"><h2 id="思路：栈模拟"><a href="#思路：栈模拟" class="headerlink" title="思路：栈模拟"></a>思路：栈模拟</h2><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minOperations</span><span class="params">(vector&lt;string&gt;&amp; logs)</span> </span>&#123;</span><br><span class="line">        stack&lt;string&gt; s;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; log : logs)&#123;</span><br><span class="line">            <span class="keyword">if</span>(log == <span class="string">&quot;../&quot;</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(!s.<span class="built_in">empty</span>())&#123;</span><br><span class="line">                    s.<span class="built_in">pop</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(log == <span class="string">&quot;./&quot;</span>)&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                s.<span class="built_in">emplace</span>(log);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)，其中 n 字符串数组的长度。只需遍历一遍字符串数组即可。</li><li>空间复杂度：O(1)。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1592. 重新排列单词间的空格</title>
      <link href="/2022/09/07/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1592%20%E9%87%8D%E6%96%B0%E6%8E%92%E5%88%97%E5%8D%95%E8%AF%8D%E9%97%B4%E7%9A%84%E7%A9%BA%E6%A0%BC/"/>
      <url>/2022/09/07/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1592%20%E9%87%8D%E6%96%B0%E6%8E%92%E5%88%97%E5%8D%95%E8%AF%8D%E9%97%B4%E7%9A%84%E7%A9%BA%E6%A0%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个字符串 <code>text</code> ，该字符串由若干被空格包围的单词组成。每个单词由一个或者多个小写英文字母组成，并且两个单词之间至少存在一个空格。题目测试用例保证 <code>text</code> <strong>至少包含一个单词</strong> 。</p><p>请你重新排列空格，使每对相邻单词之间的空格数目都 相等 ，并尽可能 最大化 该数目。如果不能重新平均分配所有空格，请 <strong>将多余的空格放置在字符串末尾</strong> ，这也意味着返回的字符串应当与原 <code>text</code> 字符串的长度相等。</p><p>返回 <strong>重新排列空格后的字符串</strong> 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：text &#x3D; “  this   is  a sentence “<br>输出：”this   is   a   sentence”<br>解释：总共有 9 个空格和 4 个单词。可以将 9 个空格平均分配到相邻单词之间，相邻单词间空格数为：9 &#x2F; (4-1) &#x3D; 3 个。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><p>感觉像屎山，不确定我在看看~</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">reorderSpaces</span><span class="params">(string text)</span> </span>&#123;</span><br><span class="line">        vector&lt;string&gt; str;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>; <span class="comment">//空格数初始化为0</span></span><br><span class="line">        string temp = <span class="string">&quot;&quot;</span>; <span class="comment">//初始化单词为空</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; text.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(text[i] == <span class="string">&#x27; &#x27;</span>) &#123; <span class="comment">//如果是空格</span></span><br><span class="line">                <span class="comment">//temp不为空，插入str，并将temp置空，获取下一个单词</span></span><br><span class="line">                <span class="keyword">if</span>(temp != <span class="string">&quot;&quot;</span>)&#123; </span><br><span class="line">                    str.<span class="built_in">emplace_back</span>(temp);</span><br><span class="line">                    temp = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                count++; <span class="comment">//空格数加1</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123; <span class="comment">//如果不为空格</span></span><br><span class="line">                temp += text[i]; <span class="comment">//添加字符</span></span><br><span class="line">                <span class="comment">//如果处在text字符串的末尾，直接将temp插入str中</span></span><br><span class="line">                <span class="keyword">if</span>(i == text.<span class="built_in">size</span>() - <span class="number">1</span>)&#123;</span><br><span class="line">                    str.<span class="built_in">emplace_back</span>(temp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> num = <span class="number">0</span>; <span class="comment">//初始化两个单词之间的空格数为0</span></span><br><span class="line">        <span class="keyword">if</span>(str.<span class="built_in">size</span>() &gt; <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//获取两个单词之间的空格数</span></span><br><span class="line">            num = count / (str.<span class="built_in">size</span>()<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//拼接字符串</span></span><br><span class="line">        string ans = str[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; str.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="comment">//拼接</span></span><br><span class="line">            ans += <span class="built_in">string</span>(num, <span class="string">&#x27; &#x27;</span>) + str[i];</span><br><span class="line">            count -= num; <span class="comment">//剩余的空格数</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将剩余的空格加到ans的末尾</span></span><br><span class="line">        ans += <span class="built_in">string</span>(count, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)652. 寻找重复的子树</title>
      <link href="/2022/09/05/%E6%AF%8F%E6%97%A5LeetCode/2022-9/652%20%E5%AF%BB%E6%89%BE%E9%87%8D%E5%A4%8D%E7%9A%84%E5%AD%90%E6%A0%91/"/>
      <url>/2022/09/05/%E6%AF%8F%E6%97%A5LeetCode/2022-9/652%20%E5%AF%BB%E6%89%BE%E9%87%8D%E5%A4%8D%E7%9A%84%E5%AD%90%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一棵二叉树 root，返回所有重复的子树。</p><p>对于同一类的重复子树，你只需要返回其中任意一棵的根结点即可。</p><p>如果两棵树具有相同的结构和相同的结点值，则它们是重复的。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2020/08/16/e33.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2020/08/16/e33.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:50%;" /><blockquote><p>输入：root &#x3D; [2,2,2,3,null,3,null]<br>输出：[[2,3],[3]]</p></blockquote></div><div class="story post-story"><h2 id="思路：递归"><a href="#思路：递归" class="headerlink" title="思路：递归"></a>思路：递归</h2><p>通过递归获取每一段的子树的字符串</p><p>如果哈希表中不存在此字符串，则插入，存在此字符串，说明此字符串存在重复的子树</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    unordered_set&lt;TreeNode*&gt; set;</span><br><span class="line">    unordered_map&lt;string, TreeNode*&gt; map;</span><br><span class="line"></span><br><span class="line">    <span class="function">string <span class="title">dfs</span><span class="params">(TreeNode* node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="comment">//获取node结点的子树字符串</span></span><br><span class="line">        string str = <span class="built_in">to_string</span>(node-&gt;val) + <span class="string">&quot;(&quot;</span> + <span class="built_in">dfs</span>(node-&gt;left) + <span class="string">&quot;)(&quot;</span> + <span class="built_in">dfs</span>(node-&gt;right) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">        <span class="comment">//在哈希表中查询</span></span><br><span class="line">        <span class="keyword">auto</span> temp = map.<span class="built_in">find</span>(str);</span><br><span class="line">        <span class="keyword">if</span>(temp != map.<span class="built_in">end</span>()) <span class="comment">//存在，则插入到set中</span></span><br><span class="line">            set.<span class="built_in">emplace</span>(temp-&gt;second);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            map[str] = node; <span class="comment">//不存在，插入到哈希表中</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">vector&lt;TreeNode*&gt; <span class="title">findDuplicateSubtrees</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">dfs</span>(root);</span><br><span class="line">        <span class="comment">//将set中的元素拷贝到vector中</span></span><br><span class="line">        <span class="keyword">return</span> &#123;set.<span class="built_in">begin</span>(), set.<span class="built_in">end</span>()&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n^2)，其中 n 是树中节点的数目。在最坏情况下，树呈现链状的结构，而每一个节点都会在其左右子树序列的基础上再增加最多 99 个字符（两组括号以及节点本身的值），那么所有子树的序列长度之和为 $\sum_{i&#x3D;1}^n$ 9n &#x3D; O(n^2)。构造出这些序列就需要 O(n^2) 的时间。</p></li><li><p>空间复杂度：O(n^2)，即为哈希表需要使用的空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1582. 二进制矩阵中的特殊位置</title>
      <link href="/2022/09/04/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1582%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%9F%A9%E9%98%B5%E4%B8%AD%E7%9A%84%E7%89%B9%E6%AE%8A%E4%BD%8D%E7%BD%AE/"/>
      <url>/2022/09/04/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1582%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%9F%A9%E9%98%B5%E4%B8%AD%E7%9A%84%E7%89%B9%E6%AE%8A%E4%BD%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个大小为 rows x cols 的矩阵 mat，其中 mat[i][j] 是 0 或 1，请返回 矩阵 mat 中特殊位置的数目 。</p><p>特殊位置 定义：如果 mat[i][j] &#x3D;&#x3D; 1 并且第 i 行和第 j 列中的所有其他元素均为 0（行和列的下标均 从 0 开始 ），则位置 (i, j) 被称为特殊位置。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：mat &#x3D; [[1,0,0],<br>                           [0,0,1],<br>                           [1,0,0]]<br>输出：1<br>解释：(1,2) 是一个特殊位置，因为 mat[1][2] &#x3D;&#x3D; 1 且所处的行和列上所有其他元素都是 0</p></blockquote></div><div class="story post-story"><h2 id="思路：模拟"><a href="#思路：模拟" class="headerlink" title="思路：模拟"></a>思路：模拟</h2><p>获取<code>mat</code>数组中的每行<code>i</code>及每列<code>j</code>的1元素的总个数<code>row</code>、<code>column</code></p><p>如果某<code>i</code>行只有一个1元素，某<code>j</code>列也只有一个1元素，并且该行列在<code>mat</code>数组中存在为1</p><p>说明<code>mat[i][j]</code>所处的行和列上所有其他元素都是 0</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">numSpecial</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; mat)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = mat.<span class="built_in">size</span>(); <span class="comment">//获取行数</span></span><br><span class="line">        <span class="type">int</span> m = mat[<span class="number">0</span>].<span class="built_in">size</span>();  <span class="comment">//获取列数</span></span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">row</span><span class="params">(n)</span></span>;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">column</span><span class="params">(m)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; m; j++)&#123;</span><br><span class="line">                row[i] += mat[i][j]; <span class="comment">//获取每行的1元素的总个数</span></span><br><span class="line">                column[j] += mat[i][j]; <span class="comment">//获取每列的1元素的总个数</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; m; j++)&#123;</span><br><span class="line">            <span class="comment">//如果i行只有一个1，j列只有一个1，并且mat数组i行j列为1</span></span><br><span class="line">                <span class="keyword">if</span>(mat[i][j] == <span class="number">1</span> &amp;&amp; row[i] == <span class="number">1</span> &amp;&amp; column[j] == <span class="number">1</span>)&#123;</span><br><span class="line">                    ans++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(m×n)，其中 m 为矩阵 mat 的行数，n 为矩阵 mat 的列数。</li><li>空间复杂度：O(m+n)，主要为预处理每一行和列的空间开销。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++11的学习笔记</title>
      <link href="/2022/09/03/C++/C++11%E7%89%B9%E6%80%A7/"/>
      <url>/2022/09/03/C++/C++11%E7%89%B9%E6%80%A7/</url>
      
        <content type="html"><![CDATA[<h1 id="C-11-简介"><a href="#C-11-简介" class="headerlink" title="C++11 简介"></a>C++11 简介</h1><p>C++11是对目前C++语言的扩展与修正，C++11不仅包含核心语言的新机能，而且拓展了C++的标准库(STL)，并入了大部分的C++Trehnical Report 1(TR1)程序库。</p><p>C++11包括的新特性，包括：lambda表达式、类型推导关键字auto、decltype以及模板的大量改进</p><div class="story post-story"><h2 id="1-类型推导"><a href="#1-类型推导" class="headerlink" title="1.类型推导"></a>1.类型推导</h2><h3 id="1-1-auto"><a href="#1-1-auto" class="headerlink" title="1.1 auto"></a>1.1 auto</h3><p>在C中，auto修饰局部变量，局部变量也叫auto变量，自动变量</p><p>而在C++11中，auto根据用户初始化数据类型自动推导</p><p>举例前，需要引入<code>typeinfo</code>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;typeinfo&gt;</span></span></span><br></pre></td></tr></table></figure><p>其中下面的函数可返回a的<strong>数据类型的字符串形式</strong>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">typeid</span>(a).<span class="built_in">name</span>();</span><br></pre></td></tr></table></figure><p>1. </p>   <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">auto</span> b = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">//b的数据类型自动推导为int</span></span><br><span class="line">cout &lt;&lt; <span class="built_in">typeid</span>(b).<span class="built_in">name</span>() &lt;&lt; endl;</span><br><span class="line"><span class="keyword">auto</span> c = <span class="number">2.5</span>;</span><br><span class="line">    <span class="comment">//c的数据类型自动推导为double</span></span><br><span class="line">cout &lt;&lt; <span class="built_in">typeid</span>(c).<span class="built_in">name</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>   运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="type">double</span></span><br></pre></td></tr></table></figure></blockquote><p>2. </p>   <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">fun</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1.5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">auto</span> a = <span class="built_in">fun</span>();   </span><br><span class="line">    <span class="comment">//c的数据类型根据返回值自动推导为double</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">typeid</span>(a).<span class="built_in">name</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>   运行结果：</p><blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span></span><br></pre></td></tr></table></figure></blockquote><p>3. </p>   <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Test t = &#123; <span class="number">1</span> &#125;;     <span class="comment">//初始化Test结构体 a = 1</span></span><br><span class="line"><span class="keyword">auto</span> a = t;</span><br><span class="line">    <span class="comment">// d的数据类型自动推导为Test</span></span><br><span class="line">cout &lt;&lt; <span class="built_in">typeid</span>(a).<span class="built_in">name</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>   运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">struct</span> <span class="title class_">Test</span></span><br></pre></td></tr></table></figure></blockquote><ol start="4"><li><p>两种遍历方式：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun1</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> it = v.<span class="built_in">begin</span>(); it != v.<span class="built_in">end</span>(); it++)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; *it &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun2</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; v)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; i : v)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; i &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>注意</strong>：</p><p>使用auto时，数据必须要<span style="color:red">初始化</span>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">auto</span> a; <span class="comment">//报错</span></span><br><span class="line">a = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>vs不支持函数形参是auto变量(部分编译器会支持)：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun3</span><span class="params">(<span class="keyword">auto</span> a)</span> <span class="comment">//报错</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不能作为自定义类型的成员变量：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Test</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> a;</span><br><span class="line"><span class="keyword">auto</span> b;     <span class="comment">//报错</span></span><br><span class="line"><span class="keyword">auto</span> c = <span class="number">0</span>; <span class="comment">//报错</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>auto不能作为初始化数组，但是可以赋值：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//auto a[3] = &#123; 1, 2, 3 &#125;; //报错</span></span><br><span class="line"><span class="type">int</span> b[<span class="number">3</span>] = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br><span class="line"><span class="keyword">auto</span> c = b;</span><br><span class="line">cout &lt;&lt; <span class="built_in">typeid</span>(c).<span class="built_in">name</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> * __ptr64</span><br></pre></td></tr></table></figure></blockquote><p>模板实例化不能是auto类型：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//vector&lt;auto&gt; v1;         //报错</span></span><br><span class="line"> <span class="comment">//vector&lt;auto&gt; v2 = &#123; 1 &#125;; //报错</span></span><br><span class="line">vector&lt;<span class="type">int</span>&gt; v3 = &#123; <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">auto</span> v4 = v3;              <span class="comment">//正常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="1-2-decltype"><a href="#1-2-decltype" class="headerlink" title="1.2 decltype"></a>1.2 decltype</h3><p><code>decltype()</code>与<code>auto</code>相反，可以获取a的数据类型，并用做b的数据类型</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">decltype</span>(a) b;</span><br></pre></td></tr></table></figure><p>1. </p>   <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line">    <span class="comment">//decltype(i)等价于int</span></span><br><span class="line"><span class="keyword">decltype</span>(i) j = <span class="number">0</span>;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">typeid</span>(j).<span class="built_in">name</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>   运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br></pre></td></tr></table></figure></blockquote><p>2. </p>   <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">float</span> a;</span><br><span class="line"><span class="type">double</span> b;</span><br><span class="line"><span class="keyword">decltype</span>(a + b) c;</span><br><span class="line">cout &lt;&lt; <span class="built_in">typeid</span>(c).<span class="built_in">name</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>   运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="type">double</span></span><br></pre></td></tr></table></figure></blockquote><p>3. </p>   <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; v;</span><br><span class="line"><span class="keyword">decltype</span>(v.<span class="built_in">begin</span>()) it;</span><br><span class="line"><span class="comment">//打印迭代器数据类型</span></span><br><span class="line">cout &lt;&lt; <span class="built_in">typeid</span>(it).<span class="built_in">name</span>() &lt;&lt; endl;</span><br><span class="line"><span class="keyword">for</span> (it = v.<span class="built_in">begin</span>(); it != v.<span class="built_in">end</span>(); it++)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">//数组为空，无打印</span></span><br><span class="line">cout &lt;&lt; *it &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>   运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">class</span> <span class="title class_">std</span>::_Vector_iterator&lt;<span class="keyword">class</span> <span class="title class_">std</span>::_Vector_val&lt;<span class="keyword">struct</span> <span class="title class_">std</span>::_Simple_types&lt;<span class="type">int</span>&gt; &gt; &gt;</span><br></pre></td></tr></table></figure></blockquote><ol start="4"><li><p>匿名数据类型：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//匿名类型的枚举变量</span></span><br><span class="line"><span class="keyword">enum</span> &#123;OK, Error&#125; flag;</span><br><span class="line"><span class="keyword">decltype</span>(flag) flag2;</span><br><span class="line">cout &lt;&lt; <span class="built_in">typeid</span>(flag2).<span class="built_in">name</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">enum `void __cdecl main(void)&#x27;::`2&#x27;::&lt;unnamed-type-flag&gt;</span><br></pre></td></tr></table></figure></blockquote></li></ol><h3 id="1-3-跟踪返回类型"><a href="#1-3-跟踪返回类型" class="headerlink" title="1.3 跟踪返回类型"></a>1.3 跟踪返回类型</h3><ol><li><p>正常写函数以及返回值</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">double</span> <span class="title">fun</span><span class="params">(<span class="type">int</span> a, <span class="type">double</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>引入<code>auto</code>作为返回值，并指定返回值为<code>double</code>与上面的函数效果等价</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">fun1</span><span class="params">(<span class="type">int</span> a, <span class="type">double</span> b)</span> -&gt; <span class="type">double</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>自定义返回值</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">fun2</span><span class="params">(<span class="type">int</span> a, <span class="type">double</span> b)</span> -&gt; <span class="title">decltype</span><span class="params">(a + b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>引入模板</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T1, <span class="keyword">class</span> T2&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">fun3</span><span class="params">(T1 a, T2 b)</span> -&gt; <span class="title">decltype</span><span class="params">(a + b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></div><div class="story post-story"><h2 id="2-易用性改进"><a href="#2-易用性改进" class="headerlink" title="2.易用性改进"></a>2.易用性改进</h2><h3 id="2-1-类内成员初始化"><a href="#2-1-类内成员初始化" class="headerlink" title="2.1 类内成员初始化"></a>2.1 类内成员初始化</h3><ol><li><p>类中的数据成员在申明时可以直接赋予一个默认值</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">A</span>(<span class="type">int</span> a, <span class="type">int</span> b) : <span class="built_in">a</span>(a),<span class="built_in">b</span>(b)  <span class="comment">//参数列表初始化 </span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> a = <span class="number">10</span>;                  <span class="comment">//`=`等号初始化默认值</span></span><br><span class="line">    <span class="type">int</span> b&#123; <span class="number">20</span> &#125;;                 <span class="comment">//`&#123;&#125;`大括号初始化默认值</span></span><br><span class="line">    </span><br><span class="line">    string str1 = <span class="string">&quot;str1&quot;</span>;        <span class="comment">//`=`等号初始化默认值</span></span><br><span class="line"><span class="comment">//string str2(&quot;str2&quot;);       //报错</span></span><br><span class="line">string str3&#123; <span class="string">&quot;str3&quot;</span> &#125;;       <span class="comment">//`&#123;&#125;`大括号初始化默认值</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">A a&#123;<span class="number">1</span>&#125;;                      <span class="comment">//通过大括号初始化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="2-2-列表初始化"><a href="#2-2-列表初始化" class="headerlink" title="2.2 列表初始化"></a>2.2 列表初始化</h3><ol><li><p>列表初始化(<code>&#123;&#125;</code>初始化方式)</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> age;</span><br><span class="line"><span class="type">double</span> money;</span><br><span class="line"><span class="type">char</span> name[<span class="number">20</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Test t = &#123; <span class="number">18</span>, <span class="number">64.8</span>, <span class="string">&quot;Tom&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> b = &#123; <span class="number">1</span> &#125;;</span><br><span class="line"><span class="type">int</span> c&#123; <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> arr1[] = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br><span class="line"><span class="type">int</span> arr2[]&#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>使用列表初始化的方式可以<strong>防止类型收窄</strong>(隐式转换导致数据丢失)</p><p><code>=</code>赋值的情况：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">128</span>;</span><br><span class="line"><span class="type">char</span> b = a;</span><br><span class="line">cout &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">cout &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">128</span></span><br><span class="line">   <span class="comment">//为空，数据丢失。c语言中ascii码最多能表示0~127，共128个字符</span></span><br></pre></td></tr></table></figure></blockquote><p><code>&#123;&#125;</code>赋值的情况：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">128</span>;</span><br><span class="line"><span class="type">char</span> b&#123; a &#125;;</span><br><span class="line">cout &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">cout &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>vs运行报错：<strong>从“int”转换到“char”需要收缩转换</strong></p></li></ol><h3 id="2-3-for循环"><a href="#2-3-for循环" class="headerlink" title="2.3 for循环"></a>2.3 for循环</h3><ol><li><p>for循环遍历数组</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a[] = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line"><span class="type">int</span> size = <span class="built_in">sizeof</span>(a) / <span class="built_in">sizeof</span>(*a); <span class="comment">//获取元素个数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; a[i] &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>基于范围的for循环</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a[] = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; temp : a)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; temp &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure></blockquote></li><li><p>容器范围的for遍历</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; v = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; temp : v)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; temp &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：</p><p>容器的范围的for遍历，需要容器含有<code>begin()</code>和<code>end()</code>才可以使用</p><p>例如：<code>queue</code>、<code>stack</code>等容器无法使用范围的for遍历</p></li></ol><h3 id="2-4-静态断言"><a href="#2-4-静态断言" class="headerlink" title="2.4 静态断言"></a>2.4 静态断言</h3><p>C++提供了调试工具<code>assert</code>，这是个宏，用于在运行阶段对断言进行检查，如果条件为<code>true</code>，执行程序，否则调用<code>abort()</code></p><p>使用<code>assert()</code>需要导入：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br></pre></td></tr></table></figure><p><code>assert()</code>断言：</p><ul><li>运行时检查条件</li><li>条件应为常量、变量均可</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line"><span class="comment">//运行时检查条件，如果为真，继续执行；否则中断程序，报错</span></span><br><span class="line"><span class="built_in">assert</span>(flag == <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;hello assert&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行报错：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Assertion failed: flag == true, file E:\08_静态断言.cpp, line 9</span><br></pre></td></tr></table></figure></blockquote><p><code>static_assert()</code>静态断言：</p><ul><li>编译时检查条件</li><li>条件应为常量，编译阶段不会有变量</li></ul><p>下面为，检查是否<strong>不为</strong>64位系统：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">static_assert</span>(<span class="built_in">sizeof</span>(<span class="type">void</span>*) == <span class="number">8</span>, <span class="string">&quot;不支持64位系统&quot;</span>);</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;hello static_assert&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-5-noexcept修饰符"><a href="#2-5-noexcept修饰符" class="headerlink" title="2.5 noexcept修饰符"></a>2.5 noexcept修饰符</h3><p>抛出异常：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="number">1</span>; <span class="comment">//抛出异常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不让函数抛出异常：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//fun2函数不能抛出任何异常，老式写法，在C++11中被废弃</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun2</span><span class="params">()</span> <span class="title">throw</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：此写法，在C++11中被废弃</p><p>新写法使用<code>noexcept</code>修饰符 来替代<code>throw()</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//fun3函数不能抛出任何异常</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun3</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-6-nullptr"><a href="#2-6-nullptr" class="headerlink" title="2.6 nullptr"></a>2.6 nullptr</h3><p><code>nullptr</code>是为了解决C++中<code>NULL</code>的二义性问题从而引进的一种新的类型，<code>NULL</code>实际上代表的是0</p><p>重载fun函数：</p><p>​当调用<code>fun(NULL)</code>时，我们希望它打印的是：<code>fun2</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;fun1&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">int</span>* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;fun2&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fun</span>(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun1</span><br></pre></td></tr></table></figure></blockquote><p>但是，打印的是：<code>fun1</code>；</p><p>如果要解决这个二义性，所以就需要使用<code>nullptr</code>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;fun1&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">int</span>* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;fun2&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fun</span>(<span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;fun2</span><br></pre></td></tr></table></figure></blockquote><p>比较<code>NULL</code>和<code>nullptr</code>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span>* p1 = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span>* p2 = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (p1 == p2)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;p1 = p2&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;p1 = p2</span><br></pre></td></tr></table></figure></blockquote><p>证明：<code>NULL</code>和<code>nullptr</code>相等</p><p><code>nullptr</code>不能赋值给普通类型：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="literal">NULL</span>;             <span class="comment">//正常</span></span><br><span class="line"><span class="comment">//int b = nullptr;        //报错</span></span><br><span class="line"><span class="comment">//double c = nullptr;     //报错</span></span><br><span class="line">    <span class="type">int</span>* p = <span class="literal">nullptr</span>;         <span class="comment">//正常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-7-强类型枚举"><a href="#2-7-强类型枚举" class="headerlink" title="2.7 强类型枚举"></a>2.7 强类型枚举</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Status1</span> &#123; Ok, Error &#125;;</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Status2</span> &#123; Ok, Error &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行报错：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">“main::Ok”: 重定义；以前的定义是“枚举数”</span><br><span class="line">“main::Error”: 重定义；以前的定义是“枚举数”</span><br></pre></td></tr></table></figure></blockquote><p>强类型枚举：<code>enum</code>后面加上<code>class</code>或<code>struct</code>修饰，即可：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Status1</span> &#123; Ok, Error &#125;;</span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Status2</span> &#123; Ok, Error &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行成功！</p><p>调用时，需要指定枚举类型的作用域：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Status1</span> &#123; Ok, Error &#125;;</span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Status2</span> &#123; Ok, Error &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Status1 flag = OK;            //报错，必须要指定枚举的作用域</span></span><br><span class="line">Status1 flag = Status1::Ok;     <span class="comment">//正常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>强枚举类型，并且可以指定成员变量的类型：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Status1</span> &#123; Ok, Error &#125;;</span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Status2</span> : <span class="type">char</span> &#123; Ok, Error &#125;;</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="built_in">sizeof</span>(Status1::Ok) &lt;&lt; endl; <span class="comment">//4字节</span></span><br><span class="line">cout &lt;&lt; <span class="built_in">sizeof</span>(Status2::Ok) &lt;&lt; endl; <span class="comment">//1字节</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">4</span></span><br><span class="line">&gt;<span class="number">1</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="2-8-常量表达式"><a href="#2-8-常量表达式" class="headerlink" title="2.8 常量表达式"></a>2.8 常量表达式</h3><p>常量表达式要在程序编译时执行，普通变量要在程序运行时执行</p><p><code>constexpr</code>：可以将<strong>变量</strong>或<strong>函数</strong>在<strong>编译阶段</strong>初始化</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">//运行时初始化，非常量</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getNum1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//const修饰的常量属于右值</span></span><br><span class="line"><span class="comment">//const修饰的形参不是常量</span></span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">int</span> <span class="title">getNum2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//常量表达式，发生在编译阶段</span></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="type">int</span> <span class="title">getNum3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 枚举类型成员初始化，必须是整型常量</span></span><br><span class="line"><span class="comment">//enum &#123;e1 = getNum1(), e2 &#125;;    //报错</span></span><br><span class="line"><span class="comment">//enum &#123; e1 = getNum2(), e2 &#125;;   //const，报错</span></span><br><span class="line"><span class="keyword">enum</span> &#123; e1 = <span class="built_in">getNum3</span>(), e2 &#125;;     <span class="comment">//正常</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> temp = <span class="built_in">getNum3</span>();  <span class="comment">//正常，发生在编译阶段</span></span><br><span class="line"><span class="keyword">enum</span> &#123; e3 = temp, e4 &#125;;          <span class="comment">//正常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>constexpr</code>的限制：</p><ul><li>函数中允许包含typedef、using指令、静态断言</li><li>函数必须有返回值</li><li>在使用前必须已有定义</li><li>return返回语句表达式不能使用非常量表达式的函数、全局函数，且必须是一个常量表达式</li></ul><p><strong>总结</strong>：运行阶段产生的变量或函数，不要瞎掺和到常量表达式中</p><h3 id="2-9-自定义字面量"><a href="#2-9-自定义字面量" class="headerlink" title="2.9 自定义字面量"></a>2.9 自定义字面量</h3><p>根据C++11标准，只有以下参数才是合法的：</p><blockquote><p>char const *</p><p>unsigned long long</p><p>long double</p><p>char const *, size_t</p><p>wchar const *, size_t</p><p>char16_t const *, size_t</p><p>char32_t const *, size_t</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义字面量，起名要求 operator&quot;&quot;XXX</span></span><br><span class="line"><span class="comment">//只需要传递第一个参数，第二个参数自动推导出第一个参数的长度并赋值</span></span><br><span class="line"><span class="type">size_t</span> <span class="keyword">operator</span><span class="string">&quot;&quot;</span>_len(<span class="type">char</span> <span class="type">const</span>* str, <span class="type">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> <span class="type">const</span>* <span class="keyword">operator</span><span class="string">&quot;&quot;</span>_str(<span class="type">char</span> <span class="type">const</span>* str, <span class="type">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> <span class="type">const</span>* <span class="keyword">operator</span><span class="string">&quot;&quot;</span>_test(<span class="type">char</span> <span class="type">const</span>* str)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;abc&quot;</span>_len &lt;&lt; endl;      <span class="comment">//正常</span></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;abc&quot;</span>_str &lt;&lt; endl;      <span class="comment">//正常</span></span><br><span class="line"><span class="comment">//cout &lt;&lt; &quot;abc&quot;_test &lt;&lt; endl;   //报错</span></span><br><span class="line">cout &lt;&lt; <span class="number">123</span>_test &lt;&lt; endl;       <span class="comment">//正常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">3</span></span><br><span class="line">&gt;abc</span><br><span class="line">&gt;<span class="number">123</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="2-10-原生字符串字面值"><a href="#2-10-原生字符串字面值" class="headerlink" title="2.10 原生字符串字面值"></a>2.10 原生字符串字面值</h3><p>原生字符串字面值：使用户书写的字符串”所见即所得”</p><p>C++11中使用原生字符串字面值只需要在<code>R&quot;()&quot;</code>括号中写入字符串，即可</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">R&quot;(Hello ,\n \r</span></span><br><span class="line"><span class="string">world</span></span><br><span class="line"><span class="string">  !!!)&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;-------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="comment">//也可以赋值给string数据类型</span></span><br><span class="line">string str = <span class="string">R&quot;(Hello ,\n \r)&quot;</span>;</span><br><span class="line">cout &lt;&lt; str &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;Hello ,\n \r</span><br><span class="line">&gt;world</span><br><span class="line"> !!!</span><br><span class="line">&gt;-------------------</span><br><span class="line">&gt;Hello ,\n \r</span><br></pre></td></tr></table></figure></blockquote></div><div class="story post-story"><h2 id="3-类的改进"><a href="#3-类的改进" class="headerlink" title="3.类的改进"></a>3.类的改进</h2><p>…..</p></div><div class="story post-story"><h2 id="4-模板的改进"><a href="#4-模板的改进" class="headerlink" title="4.模板的改进"></a>4.模板的改进</h2><h3 id="4-1-右尖括号-gt"><a href="#4-1-右尖括号-gt" class="headerlink" title="4.1 右尖括号&gt;"></a>4.1 右尖括号<code>&gt;</code></h3><p>在C++98&#x2F;03中，模板实例化时，连续的右尖括号<code>&gt;&gt;</code>会被编译成右移动操作符</p><p>需要在两个右尖括号之间添加空格<code>&gt; &gt;</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//vector&lt;vector&lt;int&gt;&gt; v1;   //报错</span></span><br><span class="line">vector&lt;vector&lt;<span class="type">int</span>&gt; &gt; v2;    <span class="comment">//正常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在C++11中解决了此问题：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; v <span class="comment">//正常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-类型的别名"><a href="#4-2-类型的别名" class="headerlink" title="4.2 类型的别名"></a>4.2 类型的别名</h3><p>需要导入一个库来判断数据类型是否相同</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;type_traits&gt;</span></span></span><br></pre></td></tr></table></figure><p><code>is_same</code>判断两个数据类型是否相同，返回值为bool类型：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">is_same&lt;T1, T2&gt;::value</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;type_traits&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过typedef给一个类型起别名，不能新建类型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> int32;</span><br><span class="line"><span class="comment">//C++11起别名方式</span></span><br><span class="line"><span class="keyword">using</span> my_int = <span class="type">int</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; is_same&lt;int32, my_int&gt;::value &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-函数模板的默认模板参数"><a href="#4-3-函数模板的默认模板参数" class="headerlink" title="4.3 函数模板的默认模板参数"></a>4.3 函数模板的默认模板参数</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//类模板支持默认模板参数</span></span><br><span class="line"><span class="comment">//注意：如果有多个类模板参数，默认模板参数要写在**最右边**</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span> = <span class="type">int</span>&gt;</span><br><span class="line"><span class="keyword">class</span> A</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">A</span>(T a) : <span class="built_in">a</span>(a) &#123;&#125;</span><br><span class="line">T a;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//C++11支持函数模板的默认模板参数</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T </span>= <span class="type">int</span>&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(T t)</span></span></span><br><span class="line"><span class="function"></span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">A&lt;&gt; <span class="built_in">a</span>(<span class="number">10</span>);             <span class="comment">//默认为int</span></span><br><span class="line">cout &lt;&lt; a.a &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"><span class="function">A&lt;string&gt; <span class="title">b</span><span class="params">(<span class="string">&quot;abc&quot;</span>)</span></span>;    <span class="comment">//指定为string</span></span><br><span class="line">cout &lt;&lt; b.a &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"><span class="built_in">fun</span>(<span class="number">10</span>);               <span class="comment">//传入int</span></span><br><span class="line"><span class="built_in">fun</span>&lt;string&gt;(<span class="string">&quot;abc&quot;</span>);    <span class="comment">//传入string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-可变参数模板函数"><a href="#4-4-可变参数模板函数" class="headerlink" title="4.4 可变参数模板函数"></a>4.4 可变参数模板函数</h3><p>可变模板函数的声明：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//下面为可变参数模板函数</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ... T&gt;     <span class="comment">//T为模板参数包</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(T ... args)</span>        <span class="comment">//args为函数参数包</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//获取可变参数个数</span></span><br><span class="line">cout &lt;&lt; <span class="keyword">sizeof</span> ... (args) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fun</span>&lt;<span class="type">int</span>&gt;(<span class="number">10</span>);</span><br><span class="line"><span class="built_in">fun</span>&lt;<span class="type">int</span>, string&gt;(<span class="number">10</span>, <span class="string">&quot;abc&quot;</span>);</span><br><span class="line"><span class="built_in">fun</span>&lt;<span class="type">int</span>, string, <span class="type">char</span>&gt;(<span class="number">10</span>, <span class="string">&quot;abc&quot;</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">    <span class="built_in">fun</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);  <span class="comment">//不指定数据类型也可以</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">1</span></span><br><span class="line">&gt;<span class="number">2</span></span><br><span class="line">&gt;<span class="number">3</span></span><br><span class="line">&gt;<span class="number">4</span></span><br></pre></td></tr></table></figure></blockquote><p><strong>参数包的展开</strong></p><ul><li><p>递归的方式展开：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//递归终止函数，当参数列表遍历完后，调用此重载函数结束递归</span></span><br><span class="line"><span class="comment">//本质就是重载函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;参数已为空&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T1, <span class="keyword">class</span> ... T2&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(T1 first, T2 ... last)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; first &lt;&lt; endl;</span><br><span class="line"><span class="built_in">fun</span>(last ...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fun</span>(<span class="number">1</span>, <span class="number">2.5</span>, <span class="number">3</span>, <span class="string">&quot;abc&quot;</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">1</span></span><br><span class="line">&gt;<span class="number">2.5</span></span><br><span class="line">&gt;<span class="number">3</span></span><br><span class="line">&gt;abc</span><br><span class="line">&gt;a</span><br><span class="line">&gt;参数已为空</span><br></pre></td></tr></table></figure></blockquote></li><li><p>非递归的方式展开：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">(T t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; t &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ... T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(T ... args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//逗号运算符</span></span><br><span class="line"><span class="comment">//初始化列表</span></span><br><span class="line"><span class="type">int</span> a[] = &#123; (<span class="built_in">print</span>(args), <span class="number">0</span>) ... &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fun</span>(<span class="number">1</span>, <span class="number">2.5</span>, <span class="string">&quot;abc&quot;</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">1</span></span><br><span class="line">&gt;<span class="number">2.5</span></span><br><span class="line">&gt;abc</span><br><span class="line">&gt;a</span><br></pre></td></tr></table></figure></blockquote></li></ul><h3 id="4-5-可变参数模板类"><a href="#4-5-可变参数模板类" class="headerlink" title="4.5 可变参数模板类"></a>4.5 可变参数模板类</h3><p>继承的方式展开参数模板类</p><ul><li><p>类模板继承方式展开参数包：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可变参数模板的声明，必须要声明</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> ... T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Car</span>; <span class="comment">//主模板的声明中不允许使用模板参数列表&lt; &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//递归继承模板类</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">Head</span>, <span class="keyword">class</span> ... Tail&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Car</span>&lt;Head, Tail ...&gt; : <span class="keyword">public</span> Car&lt;Tail ...&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Car</span>()</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; <span class="built_in">typeid</span>(Head).<span class="built_in">name</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//递归终止类</span></span><br><span class="line"><span class="keyword">template</span>&lt;&gt; </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Car</span>&lt;&gt;&#123; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//初始化Car</span></span><br><span class="line">Car&lt;<span class="type">int</span>, <span class="type">double</span>, string, <span class="type">char</span>&gt; c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="type">char</span></span><br><span class="line">&gt;<span class="keyword">class</span> <span class="title class_">std</span>::basic_string&lt;<span class="type">char</span>,<span class="keyword">struct</span> <span class="title class_">std</span>::char_traits&lt;<span class="type">char</span>&gt;,<span class="keyword">class</span> <span class="title class_">std</span>::allocator&lt;<span class="type">char</span>&gt; &gt;</span><br><span class="line">&gt;<span class="type">double</span></span><br><span class="line">&gt;<span class="type">int</span></span><br></pre></td></tr></table></figure></blockquote></li><li><p>类模板递归和特化方式展开参数包</p><p>下面的是获得相加的数据类型的字节总数：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可变参数模板的声明</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ... T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Add</span>;</span><br><span class="line"><span class="comment">//可变参数模板的定义</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">first</span>, <span class="keyword">class</span> ... last&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Add</span>&lt;first, last ...&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> val = Add&lt;first&gt;::val + Add&lt;last ...&gt;::val;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//边界条件，递归终止条件</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">first</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Add</span>&lt;first&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> val = <span class="built_in">sizeof</span>(first);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; Add&lt;<span class="type">int</span>&gt;::val &lt;&lt; endl;              <span class="comment">//int类型字节为4</span></span><br><span class="line">cout &lt;&lt; Add&lt;<span class="type">double</span>&gt;::val &lt;&lt; endl;           <span class="comment">//double类型字节为8</span></span><br><span class="line">cout &lt;&lt; Add&lt;<span class="type">int</span>, <span class="type">int</span>, <span class="type">double</span>&gt;::val &lt;&lt; endl; <span class="comment">//int+int+double字节数为16 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">4</span></span><br><span class="line">&gt;<span class="number">8</span></span><br><span class="line">&gt;<span class="number">16</span></span><br></pre></td></tr></table></figure></blockquote><p>也可以指定数据类型：</p><p>指定数据类型为<code>int</code>，并获得他们的之间相乘的总和：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可变参数模板的声明</span></span><br><span class="line"><span class="comment">//并指定为int类型</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="type">int</span> ... T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mul</span>;</span><br><span class="line"><span class="comment">//可变参数模板的定义</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="type">int</span> first, <span class="type">int</span> ... last&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mul</span>&lt;first, last ...&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> val = first * Mul&lt;last ...&gt;::val;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//边界条件，递归终止条件</span></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mul</span>&lt;&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> val = <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; Mul&lt;<span class="number">2</span>&gt;::val &lt;&lt; endl;        <span class="comment">//2*1</span></span><br><span class="line">cout &lt;&lt; Mul&lt;<span class="number">2</span>, <span class="number">2</span>&gt;::val &lt;&lt; endl;     <span class="comment">//2*2</span></span><br><span class="line">cout &lt;&lt; Mul&lt;<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>&gt;::val &lt;&lt; endl;  <span class="comment">//3*3*3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">2</span></span><br><span class="line">&gt;<span class="number">4</span></span><br><span class="line">&gt;<span class="number">27</span></span><br></pre></td></tr></table></figure></blockquote></li></ul></div><div class="story post-story"><h2 id="5-左值、右值"><a href="#5-左值、右值" class="headerlink" title="5.左值、右值"></a>5.左值、右值</h2><h3 id="5-1-左值、右值引用"><a href="#5-1-左值、右值引用" class="headerlink" title="5.1 左值、右值引用"></a>5.1 左值、右值引用</h3><p>左值引用：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//引用&amp;：给一个内存起别名，定义时必须初始化</span></span><br><span class="line"><span class="type">int</span> a;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> temp = <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> t1 = <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> t2 = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span>&amp; b = a;               <span class="comment">//正常</span></span><br><span class="line"><span class="comment">//int&amp; c = 1;             //报错，非常量引用的初始值必须为左值</span></span><br><span class="line"><span class="comment">//int&amp; d = t1 + t2;       //报错，非常量引用的初始值必须为左值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//const int&amp; 万能引用</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span>&amp; e = a;         <span class="comment">//正常</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span>&amp; f = <span class="number">1</span>;         <span class="comment">//正常</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span>&amp; t = temp;      <span class="comment">//正常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>右值引用：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//右值引用</span></span><br><span class="line"><span class="type">int</span>&amp;&amp; a = <span class="number">10</span>;           <span class="comment">//正常</span></span><br><span class="line"><span class="type">int</span>&amp;&amp; b = <span class="built_in">fun</span>();        <span class="comment">//正常</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> t1 = <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> t2 = <span class="number">1</span>;</span><br><span class="line"><span class="comment">//int&amp;&amp; c = t1;         //报错，无法将右值引用绑定到左值</span></span><br><span class="line"><span class="type">int</span>&amp;&amp; d = t1 + t2;      <span class="comment">//正常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>左值、右值判断：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过重载函数的特点，来进行判断</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">(<span class="type">int</span>&amp; left)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;左值&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">(<span class="type">int</span>&amp;&amp; right)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;右值&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> b = <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span>&amp;&amp; c = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">test</span>(a);        <span class="comment">//左值</span></span><br><span class="line"><span class="built_in">test</span>(<span class="number">1</span>);        <span class="comment">//右值</span></span><br><span class="line"><span class="built_in">test</span>(a + b);    <span class="comment">//右值</span></span><br><span class="line"><span class="built_in">test</span>(c);        <span class="comment">//左值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;左值</span><br><span class="line">&gt;右值</span><br><span class="line">&gt;右值</span><br><span class="line">&gt;左值</span><br></pre></td></tr></table></figure></blockquote><h3 id="5-2-返回值优化"><a href="#5-2-返回值优化" class="headerlink" title="5.2 返回值优化"></a>5.2 返回值优化</h3><p>……</p></div><div class="story post-story"><h2 id="6-移动语义"><a href="#6-移动语义" class="headerlink" title="6.移动语义"></a>6.移动语义</h2><p>……</p><h3 id="6-3-std-move"><a href="#6-3-std-move" class="headerlink" title="6.3 std::move"></a>6.3 std::move</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="comment">//int&amp;&amp; b = a;     //报错，左值不能绑定到右值引用</span></span><br><span class="line"><span class="type">int</span>&amp;&amp; c = <span class="built_in">move</span>(a); <span class="comment">//正常，move将左值转化为右值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-4-std-forward"><a href="#6-4-std-forward" class="headerlink" title="6.4 std::forward"></a>6.4 std::forward</h3><p>当我们需要将一组参数原封不动的传递给里一个函数时：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">const</span> T&amp; t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;fun(const T&amp; t) &quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(T&amp; t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;fun(T&amp; t) &quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">forwardVal</span><span class="params">(<span class="type">const</span> T&amp; t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fun</span>(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">forwardVal</span><span class="params">(T&amp; t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fun</span>(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> b = <span class="number">1</span>;</span><br><span class="line">forwardVal(a);</span><br><span class="line">forwardVal(b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="built_in">fun</span>(T&amp; t)</span><br><span class="line">&gt;<span class="built_in">fun</span>(<span class="type">const</span> T&amp; t)</span><br></pre></td></tr></table></figure></blockquote><p>使用<code>std::forward</code>函数，实现完美转发：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">const</span> T&amp; t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;fun(const T&amp; t) &quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(T&amp; t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;fun(T&amp; t) &quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">const</span> T&amp;&amp; t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;fun(const T&amp;&amp; t) &quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//只需定义一个函数，无需重载函数</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">forwardVal</span><span class="params">(T&amp;&amp; t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//forward保存参数的左值、右值属性</span></span><br><span class="line"><span class="built_in">fun</span>(forward&lt;T&gt;(t));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> b = <span class="number">2</span>;</span><br><span class="line">forwardVal(a);</span><br><span class="line">forwardVal(b);</span><br><span class="line">forwardVal(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="built_in">fun</span>(T&amp; t)</span><br><span class="line">&gt;<span class="built_in">fun</span>(<span class="type">const</span> T&amp; t)</span><br><span class="line">&gt;<span class="built_in">fun</span>(<span class="type">const</span> T&amp;&amp; t)</span><br></pre></td></tr></table></figure></blockquote></div><div class="story post-story"><h2 id="7-智能指针"><a href="#7-智能指针" class="headerlink" title="7.智能指针"></a>7.智能指针</h2><h3 id="7-1-unique-ptr"><a href="#7-1-unique-ptr" class="headerlink" title="7.1 unique_ptr"></a>7.1 unique_ptr</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;memory&gt;</span>           <span class="comment">//智能指针头文件</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//智能指针无需释放，自动释放</span></span><br><span class="line"><span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">ptr</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line">cout &lt;&lt; *ptr &lt;&lt; endl;  <span class="comment">//重载了operator*()</span></span><br><span class="line">cout &lt;&lt; ptr &lt;&lt; endl;   </span><br><span class="line"></span><br><span class="line"><span class="comment">//可以人为指定释放堆区空间</span></span><br><span class="line"><span class="comment">//ptr = nullptr;       //正常</span></span><br><span class="line"><span class="comment">//ptr = NULL;          //正常</span></span><br><span class="line">ptr.<span class="built_in">reset</span>();           <span class="comment">//正常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;memory&gt;</span>               <span class="comment">//智能指针头文件</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">ptr1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line"><span class="comment">//报错，禁用拷贝构造</span></span><br><span class="line"><span class="comment">//unique_ptr&lt;int&gt; ptr2 = ptr;  </span></span><br><span class="line">    <span class="comment">//int* p = ptr             //报错</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//将ptr1使用权(指向的内存)交给ptr3，ptr1不能再操作堆区内存了</span></span><br><span class="line">unique_ptr&lt;<span class="type">int</span>&gt; ptr3 = <span class="built_in">move</span>(ptr1); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//cout &lt;&lt; *ptr1 &lt;&lt; endl;   //报错  </span></span><br><span class="line">    cout &lt;&lt; *ptr3 &lt;&lt; endl;     <span class="comment">//正常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;memory&gt;</span> <span class="comment">//智能指针头文件</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">ptr</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//无参，作用为显式释放堆区内存</span></span><br><span class="line"><span class="comment">//ptr.reset();  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//有参，先释放堆区内存，再重新绑定一个新堆区内存</span></span><br><span class="line">ptr.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">20</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;memory&gt;</span> <span class="comment">//智能指针头文件</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">ptr</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//释放ptr对堆区内存的控制权但是不释放堆区的内存，并将控制权交给指针p</span></span><br><span class="line"><span class="type">int</span>* p = ptr.<span class="built_in">release</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//cout &lt;&lt; *ptr &lt;&lt; endl;   //报错</span></span><br><span class="line">cout &lt;&lt; *p &lt;&lt; endl;       <span class="comment">//正常</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//需要人为将p指针的堆区释放</span></span><br><span class="line"><span class="keyword">delete</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-2-shared-ptr"><a href="#7-2-shared-ptr" class="headerlink" title="7.2 shared_ptr"></a>7.2 shared_ptr</h3><p><code>shared_ptr</code>允许多个智能指针共享并拥有同一个堆区分配对象的内存。通过引用计数实现，会记录有多少个<code>shared_ptr</code>共同指向同一个对象，如果最后一个共享指针被销毁，也就是对某个引用对象的计数变为0时，自动释放此内存。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//shared_ptr也会自动释放堆区空间</span></span><br><span class="line"><span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">ptr1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//拷贝构造，此时有2个对象和堆区内存绑定</span></span><br><span class="line">shared_ptr&lt;<span class="type">int</span>&gt; ptr2 = ptr1;       <span class="comment">//正常</span></span><br><span class="line"><span class="comment">//打印ptr1与ptr2的地址</span></span><br><span class="line">cout &lt;&lt; ptr1 &lt;&lt; endl;</span><br><span class="line">cout &lt;&lt; ptr2 &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"><span class="comment">//计数器，获取与堆区绑定的对象的个数</span></span><br><span class="line">cout &lt;&lt; ptr1.<span class="built_in">use_count</span>() &lt;&lt; endl;  <span class="comment">//2</span></span><br><span class="line"><span class="comment">//释放ptr1对象，计数器减1，不会释放堆区内存</span></span><br><span class="line">    ptr1.<span class="built_in">reset</span>();</span><br><span class="line">cout &lt;&lt; ptr2.<span class="built_in">use_count</span>() &lt;&lt; endl;  <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//当计数器为0时，才会释放堆区空间</span></span><br><span class="line">ptr2.<span class="built_in">reset</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">0000026</span>C3E3E6CA0</span><br><span class="line">&gt;<span class="number">0000026</span>C3E3E6CA0</span><br><span class="line">&gt;<span class="number">2</span></span><br><span class="line">&gt;<span class="number">1</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="7-3-weak-ptr"><a href="#7-3-weak-ptr" class="headerlink" title="7.3 weak_ptr"></a>7.3 weak_ptr</h3><p><code>weak_ptr</code>是为配合 <code>shared_ptr</code> 而引入的一种智能指针来协助 <code>shared_ptr</code> 工作，它可以从一个<code>shared_ptr</code> 或另一个 <code>weak_ptr</code> 对象构造，它的构造和析构不会引起引用计数的增加或减少。没有重载 <code>*</code> 和<code>-&gt;</code>但可以使用 <code>lock</code> 获得一个可用的 <code>shared_ptr</code> 对象。</p><p><code>weak_ptr</code> 的使用更为复杂一点，它可以指向 <code>shared_ptr</code> 指针指向的对象内存，却并不拥有该内存，而使用 <code>weak_ptr</code> 成员<code>lock</code>，则可返回其指向内存的一个 <code>share_ptr</code> 对象，且在所指对象内存己经无效时，返回指针空值 nullptr。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">ptr1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line">shared_ptr&lt;<span class="type">int</span>&gt; ptr2 = ptr1;             <span class="comment">//2个对象绑定堆区空间</span></span><br><span class="line"><span class="comment">//weak_ptr不和堆区空间绑定，可以通过lock函数获取shared_ptr的对象</span></span><br><span class="line">weak_ptr&lt;<span class="type">int</span>&gt; ptr3 = ptr1;</span><br><span class="line">cout &lt;&lt; ptr1.<span class="built_in">use_count</span>() &lt;&lt; endl;        <span class="comment">//打印计数器</span></span><br><span class="line">cout &lt;&lt; ptr3.<span class="built_in">use_count</span>() &lt;&lt; endl;        <span class="comment">//打印计数器</span></span><br><span class="line">    </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;----------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//通过lock函数获取shared_ptr的对象</span></span><br><span class="line">shared_ptr&lt;<span class="type">int</span>&gt; ptr4 = ptr3.<span class="built_in">lock</span>();      <span class="comment">//3个对象绑定堆区空间</span></span><br><span class="line">cout &lt;&lt; ptr1.<span class="built_in">use_count</span>() &lt;&lt; endl;        <span class="comment">//打印计数器</span></span><br><span class="line">cout &lt;&lt; ptr3.<span class="built_in">use_count</span>() &lt;&lt; endl;        <span class="comment">//打印计数器</span></span><br><span class="line"></span><br><span class="line">cout &lt;&lt; *ptr1 &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; *ptr2 &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; *ptr4 &lt;&lt; endl;  <span class="comment">//正常</span></span><br><span class="line"><span class="comment">//cout &lt;&lt; *ptr3 &lt;&lt; endll;                               //报错，没有重载*和-&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//释放所有shared_ptr对象</span></span><br><span class="line">    ptr1.<span class="built_in">reset</span>();</span><br><span class="line">ptr2.<span class="built_in">reset</span>();</span><br><span class="line">ptr4.<span class="built_in">reset</span>();</span><br><span class="line"></span><br><span class="line">shared_ptr&lt;<span class="type">int</span>&gt; temp = ptr3.<span class="built_in">lock</span>();</span><br><span class="line"><span class="keyword">if</span> (temp == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;temp为空，已经释放了堆区空间！&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">2</span></span><br><span class="line">&gt;<span class="number">2</span></span><br><span class="line">&gt;----------------</span><br><span class="line">&gt;<span class="number">3</span></span><br><span class="line">&gt;<span class="number">3</span></span><br><span class="line">&gt;<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span></span><br><span class="line">&gt;temp为空，已经释放了堆区空间！</span><br></pre></td></tr></table></figure></blockquote></div><div class="story post-story"><h2 id="8-闭包的实现"><a href="#8-闭包的实现" class="headerlink" title="8.闭包的实现"></a>8.闭包的实现</h2><h3 id="8-1-闭包是什么"><a href="#8-1-闭包是什么" class="headerlink" title="8.1 闭包是什么"></a>8.1 闭包是什么</h3><p>闭包有很多种定义，一种说法是，闭包是带有上下文的函数。说白了，就是有状态的函数，更直接一些，不就是个类吗？换了个名字化 。</p><p>一个函数，带上了一个状态，就变成了闭包了。那什么叫“带上状态，呢？意思是这个闭包有属于自己的变量，这些个变量的值是创建闭包的时候设置的，并在调用闭包的时候，可以访问这些变量。</p><p>函数是代码，状态是一组变量，将代码和一组变量捆绑(bind)，就形成了闭包。</p><p>闭包的状态㧢绑，必须发生在运行时。</p><h3 id="8-2-仿函数：重载operator"><a href="#8-2-仿函数：重载operator" class="headerlink" title="8.2 仿函数：重载operator()"></a>8.2 仿函数：重载operator()</h3><p>C++11之前就已经支持</p><p>比较大小：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//仿函数：重载operator()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Compare</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//如果val1小于val2,则返回真，否则返回假</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">int</span> val1, <span class="type">int</span> val2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> val1 &lt; val2;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="built_in">Compare</span>()(<span class="number">11</span>, <span class="number">12</span>) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">1</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="8-3-std-function"><a href="#8-3-std-function" class="headerlink" title="8.3 std::function"></a>8.3 std::function</h3><p>在C++中，可调用实体主要包括：函数、函数指针、函数引用、可以隐式转换为函数指定的对系，或者实现了 opetator()的对象。</p><p>C++11中，新增加了一个 std::function 类模板，它是对 C++中现有的可调用实体的一种类型安全的包装。通过指定它的模板参数，它可以用统一的方式处理函数、函数对象、函数指针，并允许保存和延迟执行它们。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span>  <span class="comment">//std::function</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//普通函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//__func__：返回函数名</span></span><br><span class="line">cout &lt;&lt; __func__ &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//类中静态函数</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">testFun</span><span class="params">(<span class="type">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; __func__ &lt;&lt; endl;</span><br><span class="line"><span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//类中仿函数</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyFun</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; __func__ &lt;&lt; endl;</span><br><span class="line"><span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//绑定普通函数</span></span><br><span class="line">function&lt;<span class="type">void</span>()&gt; f1 = fun;</span><br><span class="line"><span class="built_in">f1</span>();</span><br><span class="line"><span class="comment">//绑定类中的静态函数</span></span><br><span class="line">function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; f2 = Test::testFun;</span><br><span class="line">cout &lt;&lt; <span class="built_in">f2</span>(<span class="number">100</span>) &lt;&lt; endl;</span><br><span class="line"><span class="comment">//绑定类中的仿函数，绑定对象</span></span><br><span class="line">function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; f3 = <span class="built_in">MyFun</span>();</span><br><span class="line">cout &lt;&lt; <span class="built_in">f3</span>(<span class="number">30</span>) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;fun</span><br><span class="line">&gt;testFun</span><br><span class="line">&gt;<span class="number">100</span></span><br><span class="line">&gt;<span class="built_in">operator</span> ()</span><br><span class="line">&gt;<span class="number">30</span></span><br></pre></td></tr></table></figure></blockquote><p>std:function对象最大的用处就是在实现函数回调，使用者需要注忘，它不能被用来检查相等或者不相等，但是可以与 NULL 或者nullptr 进行比较。</p><h3 id="8-4-std-bind"><a href="#8-4-std-bind" class="headerlink" title="8.4 std::bind"></a>8.4 std::bind</h3><p>std:bind 是这样一种机制，它可以预先把指定可调用实体的某些参数鄉定到己有的变量，产生一个新的可调用实体，这种机制在 回调函数 的使用过程中也频为有用。</p><p>C++98中，有两个两数bindlst 和bind2nd，它们分别可以用来绑定 functor 的第一个和第二个参数，它们都是只可以绑定一个参数，各种限制，使得 bind1st 和 bind2nd 的可用性大大降低。</p><p>在C++11中，提供了std:bind， 它鄉定的参数的个数不受限制，绑定的具体哪些参数也不受限制，由用户指定，这个bind 才是真正意义上的绑定。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span>   <span class="comment">//std::bind</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; x &lt;&lt; <span class="string">&quot;   &quot;</span> &lt;&lt; y &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">bind</span>(fun, <span class="number">1</span>, <span class="number">2</span>)();             <span class="comment">//输出1  2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//std::placeholders::_1 表示函数调用，第1个参数替换</span></span><br><span class="line"><span class="comment">//std::placeholders::_2 表示函数调用，第2个参数替换</span></span><br><span class="line"><span class="comment">//std::placeholders::_3 表示函数调用，第3个参数替换</span></span><br><span class="line"><span class="built_in">bind</span>(fun, placeholders::_1, placeholders::_2)(<span class="number">5</span>, <span class="number">10</span>);  <span class="comment">//输出5  10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//简化写法</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::placeholders;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将第1个参数与_1替换</span></span><br><span class="line"><span class="built_in">bind</span>(fun, <span class="number">5</span>, _1)(<span class="number">2</span>, <span class="number">4</span>, <span class="number">10</span>);    <span class="comment">//输出5  2</span></span><br><span class="line"><span class="comment">//将第2个参数与_2替换</span></span><br><span class="line"><span class="built_in">bind</span>(fun, <span class="number">5</span>, _2)(<span class="number">2</span>, <span class="number">4</span>, <span class="number">10</span>);    <span class="comment">//输出5  4</span></span><br><span class="line"><span class="comment">//第1个参数与第一个参数互换</span></span><br><span class="line"><span class="built_in">bind</span>(fun, _2, _1)(<span class="number">2</span>, <span class="number">4</span>, <span class="number">10</span>);   <span class="comment">//输出4  2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//bind(fun, _2, 10)(20);       //报错，不存咋第2个参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">1</span>   <span class="number">2</span></span><br><span class="line">&gt;<span class="number">5</span>   <span class="number">10</span></span><br><span class="line">&gt;<span class="number">5</span>   <span class="number">2</span></span><br><span class="line">&gt;<span class="number">5</span>   <span class="number">4</span></span><br><span class="line">&gt;<span class="number">4</span>   <span class="number">2</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="8-5-function结合bind"><a href="#8-5-function结合bind" class="headerlink" title="8.5 function结合bind"></a>8.5 function结合bind</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::placeholders;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">int</span> a;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; x &lt;&lt; <span class="string">&quot;  &quot;</span> &lt;&lt; y &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Test test;    <span class="comment">//创建对象</span></span><br><span class="line"><span class="comment">//绑定成员函数</span></span><br><span class="line">function&lt;<span class="type">void</span>(<span class="type">int</span>, <span class="type">int</span>)&gt; f1 = <span class="built_in">bind</span>(&amp;Test::fun, &amp;test, _1, _2);</span><br><span class="line"><span class="built_in">f1</span>(<span class="number">1</span>, <span class="number">2</span>);     <span class="comment">//test.fun(1, 2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//绑定成员变量</span></span><br><span class="line">function&lt;<span class="type">int</span>&amp; ()&gt; f2 = <span class="built_in">bind</span>(&amp;Test::a, &amp;test);</span><br><span class="line"><span class="built_in">f2</span>() = <span class="number">12</span>;    <span class="comment">//test.a = 12;</span></span><br><span class="line">cout &lt;&lt; test.a &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">1</span>  <span class="number">2</span></span><br><span class="line">&gt;<span class="number">12</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="8-6-lambda表达式"><a href="#8-6-lambda表达式" class="headerlink" title="8.6 lambda表达式"></a>8.6 lambda表达式</h3><p>lambda表达式的基本格式：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[]()</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基础语法：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//[]中只能捕获全局变量与同一作用域的变量</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">auto</span> f1 = []() &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> b = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;f2-------------&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="comment">//a、b以值传递方式</span></span><br><span class="line"><span class="keyword">auto</span> f2 = [a, b]()</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; a &lt;&lt; <span class="string">&quot;  &quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">f2</span>();</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;f3-------------&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="comment">//添加x、y参数</span></span><br><span class="line"><span class="keyword">auto</span> f3 = [a, b](<span class="type">int</span> x, <span class="type">int</span> y)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; a &lt;&lt; <span class="string">&quot;  &quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;x=&quot;</span> &lt;&lt; x &lt;&lt; <span class="string">&quot;,y=&quot;</span> &lt;&lt; y &lt;&lt; endl;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">f3</span>(<span class="number">3</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;f4-------------&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="comment">//=：以值传递的方式捕获外面的变量</span></span><br><span class="line"><span class="keyword">auto</span> f4 = [=]()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">f3</span>(<span class="number">4</span>, <span class="number">8</span>);</span><br><span class="line">cout &lt;&lt; a &lt;&lt; <span class="string">&quot;  &quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">f4</span>();</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;f5-------------&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="comment">//&amp;：以引用的方式捕获外面的变量</span></span><br><span class="line"><span class="keyword">auto</span> f5 = [&amp;]()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">f3</span>(<span class="number">5</span>, <span class="number">10</span>);</span><br><span class="line">cout &lt;&lt; a &lt;&lt; <span class="string">&quot;  &quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">f5</span>();</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;f6-------------&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="comment">//a为值传递，其余为引用</span></span><br><span class="line"><span class="keyword">auto</span> f6 = [&amp;, a]()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">f3</span>(<span class="number">6</span>, <span class="number">12</span>);</span><br><span class="line">cout &lt;&lt; a &lt;&lt; <span class="string">&quot;  &quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">f6</span>();</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;f7-------------&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="comment">//a为引用，其余为值传递</span></span><br><span class="line"><span class="keyword">auto</span> f7 = [=, &amp;a]()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">f3</span>(<span class="number">7</span>, <span class="number">14</span>);</span><br><span class="line">cout &lt;&lt; a &lt;&lt; <span class="string">&quot;  &quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">f7</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认情况下，lambda表达式以const修饰函数体</span></span><br><span class="line"><span class="comment">//添加mutable，就可以修改了</span></span><br><span class="line"><span class="keyword">auto</span> f8 = [=]() <span class="keyword">mutable</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//不加mutable会报错，无法修改</span></span><br><span class="line">a++;   <span class="comment">//正常</span></span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">1</span>  <span class="number">2</span></span><br><span class="line">&gt;f3-------------</span><br><span class="line">&gt;<span class="number">1</span>  <span class="number">2</span></span><br><span class="line">&gt;x=<span class="number">3</span>,y=<span class="number">6</span></span><br><span class="line">&gt;f4-------------</span><br><span class="line">&gt;<span class="number">1</span>  <span class="number">2</span></span><br><span class="line">&gt;x=<span class="number">4</span>,y=<span class="number">8</span></span><br><span class="line">&gt;<span class="number">1</span>  <span class="number">2</span></span><br><span class="line">&gt;f5-------------</span><br><span class="line">&gt;<span class="number">1</span>  <span class="number">2</span></span><br><span class="line">&gt;x=<span class="number">5</span>,y=<span class="number">10</span></span><br><span class="line">&gt;<span class="number">1</span>  <span class="number">2</span></span><br><span class="line">&gt;f6-------------</span><br><span class="line">&gt;<span class="number">1</span>  <span class="number">2</span></span><br><span class="line">&gt;x=<span class="number">6</span>,y=<span class="number">12</span></span><br><span class="line">&gt;<span class="number">1</span>  <span class="number">2</span></span><br><span class="line">&gt;f7-------------</span><br><span class="line">&gt;<span class="number">1</span>  <span class="number">2</span></span><br><span class="line">&gt;x=<span class="number">7</span>,y=<span class="number">14</span></span><br><span class="line">&gt;<span class="number">1</span>  <span class="number">2</span></span><br></pre></td></tr></table></figure></blockquote><p>类和全局变量：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> globality = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">int</span> i = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">testFun</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">5</span>;</span><br><span class="line">cout &lt;&lt; __func__ &lt;&lt; endl;</span><br><span class="line"><span class="keyword">auto</span> f1 = [=]()</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; i &lt;&lt; endl;              <span class="comment">//正常</span></span><br><span class="line">cout &lt;&lt; globality &lt;&lt; endl;   <span class="comment">//正常</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">auto</span> f2 = [&amp;]()</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; i &lt;&lt; endl;             <span class="comment">//正常</span></span><br><span class="line">cout &lt;&lt; globality &lt;&lt; endl;   <span class="comment">//正常</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//只能捕获类成员变量和全局变量，不能捕获局部变量</span></span><br><span class="line"><span class="keyword">auto</span> f3 = [<span class="keyword">this</span>]()</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; i &lt;&lt; endl;             <span class="comment">//正常</span></span><br><span class="line">cout &lt;&lt; globality &lt;&lt; endl;   <span class="comment">//正常</span></span><br><span class="line"><span class="comment">//cout &lt;&lt; a &lt;&lt; endl;          //报错</span></span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//[]中只能捕获全局变量与同一作用域的变量</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">auto</span> f1 = [=]()</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; globality &lt;&lt; endl;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">f1</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-7-值传递与引用捕获参数的区别"><a href="#8-7-值传递与引用捕获参数的区别" class="headerlink" title="8.7 值传递与引用捕获参数的区别"></a>8.7 值传递与引用捕获参数的区别</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">auto</span> f1 = [=]() <span class="keyword">mutable</span></span><br><span class="line">&#123;</span><br><span class="line">a++;</span><br><span class="line">cout &lt;&lt; a &lt;&lt; endl;    <span class="comment">//a = 2;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">f1</span>();</span><br><span class="line">cout &lt;&lt; a &lt;&lt; endl;        <span class="comment">//a = 1;</span></span><br><span class="line">    </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;-----------&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> b = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">auto</span> f2 = [&amp;]() <span class="keyword">mutable</span></span><br><span class="line">&#123;</span><br><span class="line">b++;</span><br><span class="line">cout &lt;&lt; b &lt;&lt; endl;    <span class="comment">//b = 2;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">f2</span>();</span><br><span class="line">cout &lt;&lt; b &lt;&lt; endl;        <span class="comment">//b = 2;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">2</span></span><br><span class="line">&gt;<span class="number">1</span></span><br><span class="line">&gt;-----------</span><br><span class="line">&gt;<span class="number">2</span></span><br><span class="line">&gt;<span class="number">2</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="8-8-lambda表达式与仿函数"><a href="#8-8-lambda表达式与仿函数" class="headerlink" title="8.8 lambda表达式与仿函数"></a>8.8 lambda表达式与仿函数</h3><p>事实上，仿函数是编译器实现lambda 的一种方式，通过编译器都是把lambda表达式转化为一个仿函数对象。</p><p>因此，在C++11中，lambda 可以视为仿函数的一种等价形式。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyFun</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> a;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">MyFun</span>(<span class="type">int</span> a)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;a = a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;a + val;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//仿函数</span></span><br><span class="line">cout &lt;&lt; <span class="built_in">MyFun</span>(a)(<span class="number">20</span>) &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"><span class="comment">//lambda表达式</span></span><br><span class="line"><span class="keyword">auto</span> f = [=](<span class="type">int</span> val)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> a + val;</span><br><span class="line">&#125;;</span><br><span class="line">cout &lt;&lt; <span class="built_in">f</span>(<span class="number">20</span>) &lt;&lt; endl;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-9-lambda表达式类型"><a href="#8-9-lambda表达式类型" class="headerlink" title="8.9 lambda表达式类型"></a>8.9 lambda表达式类型</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::placeholders;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; f1 = [](<span class="type">int</span> x) &#123;<span class="keyword">return</span> x + <span class="number">1</span>; &#125;;</span><br><span class="line">cout &lt;&lt; <span class="built_in">f1</span>(<span class="number">1</span>) &lt;&lt; endl;    <span class="comment">//2</span></span><br><span class="line"></span><br><span class="line">function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; f2 = <span class="built_in">bind</span>([](<span class="type">int</span> x) &#123;<span class="keyword">return</span> x + <span class="number">1</span>; &#125;, _1);</span><br><span class="line">cout &lt;&lt; <span class="built_in">f2</span>(<span class="number">2</span>) &lt;&lt; endl;    <span class="comment">//3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> f3 = [](<span class="type">int</span> x, <span class="type">int</span> y) -&gt;<span class="type">int</span> &#123;<span class="keyword">return</span> x + y; &#125;;</span><br><span class="line"><span class="keyword">auto</span> f4 = [=](<span class="type">int</span> x, <span class="type">int</span> y) -&gt;<span class="type">int</span> &#123;<span class="keyword">return</span> x + y; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个FUN_PTR函数指针，参数列表为两个int，返回值为int</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*FUN_PTR)</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span></span>;</span><br><span class="line">FUN_PTR p1 = f3;          <span class="comment">//正常，lambda表达式可以转化为函数指针</span></span><br><span class="line"><span class="comment">//FUN_PTR p2 = f4;        //报错，lambda表达式转化为函数指针不允许捕获变量</span></span><br><span class="line"></span><br><span class="line">cout&lt;&lt; <span class="built_in">p1</span>(<span class="number">1</span>, <span class="number">2</span>) &lt;&lt; endl;  <span class="comment">//3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="8-10-lambda的优势"><a href="#8-10-lambda的优势" class="headerlink" title="8.10 lambda的优势"></a>8.10 lambda的优势</h3><p>传统筛选出大于5的数：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">vector&lt;<span class="type">int</span>&gt; arr;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; largeNums; <span class="comment">//筛选出大于5的数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">(<span class="type">const</span> vector&lt;<span class="type">int</span>&gt;&amp; v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; i : v)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; i &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">arr.<span class="built_in">emplace_back</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> temp = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传统操作</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; a : arr)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (a &gt; temp)</span><br><span class="line">&#123;</span><br><span class="line">largeNums.<span class="built_in">emplace_back</span>(a);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(largeNums);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回调函数：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;algorithm&gt;</span>  <span class="comment">//std::for_each</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">vector&lt;<span class="type">int</span>&gt; arr;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; largeNums; <span class="comment">//筛选出大于5的数</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> temp = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">int</span>&amp; n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (n &gt; temp)</span><br><span class="line">&#123;</span><br><span class="line">largeNums.<span class="built_in">emplace_back</span>(n);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">(<span class="type">int</span>&amp; n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; n &lt;&lt; <span class="string">&quot;  &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">arr.<span class="built_in">emplace_back</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//筛选</span></span><br><span class="line">for_each(arr.<span class="built_in">begin</span>(), arr.<span class="built_in">end</span>(), fun);</span><br><span class="line"><span class="comment">//遍历</span></span><br><span class="line">for_each(largeNums.<span class="built_in">begin</span>(), largeNums.<span class="built_in">end</span>(), print);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>lambda表达式：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;algorithm&gt;</span>  <span class="comment">//std::for_each</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">vector&lt;<span class="type">int</span>&gt; arr;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; largeNums; <span class="comment">//筛选出大于5的数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">arr.<span class="built_in">emplace_back</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> temp = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//筛选</span></span><br><span class="line">for_each(arr.<span class="built_in">begin</span>(), arr.<span class="built_in">end</span>(),</span><br><span class="line">[&amp;temp](<span class="type">int</span>&amp; n) &#123;</span><br><span class="line"><span class="keyword">if</span> (n &gt; temp) largeNums.<span class="built_in">emplace_back</span>(n);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//遍历</span></span><br><span class="line">for_each(largeNums.<span class="built_in">begin</span>(), largeNums.<span class="built_in">end</span>(),</span><br><span class="line">[](<span class="type">int</span>&amp; n) &#123;</span><br><span class="line">cout &lt;&lt; n &lt;&lt; <span class="string">&quot;  &quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)646. 最长数对链</title>
      <link href="/2022/09/03/%E6%AF%8F%E6%97%A5LeetCode/2022-9/646%20%E6%9C%80%E9%95%BF%E6%95%B0%E5%AF%B9%E9%93%BE/"/>
      <url>/2022/09/03/%E6%AF%8F%E6%97%A5LeetCode/2022-9/646%20%E6%9C%80%E9%95%BF%E6%95%B0%E5%AF%B9%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<p>题目：</p><p>给出 n 个数对。 在每一个数对中，第一个数字总是比第二个数字小。</p><p>现在，我们定义一种跟随关系，当且仅当 b &lt; c 时，数对(c, d) 才可以跟在 (a, b) 后面。我们用这种形式来构造一个数对链。</p><p>给定一个数对集合，找出能够形成的最长数对链的长度。你不需要用到所有的数对，你可以以任何顺序选择其中的一些数对来构造。</p><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：[[1,2], [2,3], [3,4]]<br>输出：2<br>解释：最长的数对链是 [1,2] -&gt; [3,4]</p></blockquote></div><div class="story post-story"><h2 id="思路：动态规划"><a href="#思路：动态规划" class="headerlink" title="思路：动态规划"></a>思路：动态规划</h2><p>遍历数组<code>pairs</code> 用<code> i</code>表示</p><p>如果存在<code>pairs[j][1] &lt; pairs[i][0]</code></p><p>重新遍历之前已经遍历过的元素(<code>i</code>位置之前的元素)<code>pairs</code>用<code>j</code>表示并且<code>j &lt; i</code>，找到最大的<code>dp[j] + 1</code>，记录到<code>dp[i]</code>中</p><p>返回<code>dp</code>数组的最后一个元素就为最长数对链</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">findLongestChain</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; pairs)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">dp</span><span class="params">(pairs.size(), <span class="number">1</span>)</span></span>;</span><br><span class="line">        <span class="built_in">sort</span>(pairs.<span class="built_in">begin</span>(), pairs.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; pairs.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; i; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span> (pairs[j][<span class="number">1</span>] &lt; pairs[i][<span class="number">0</span>]) &#123;</span><br><span class="line">                    dp[i] = <span class="built_in">max</span>(dp[i], dp[j] + <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp.<span class="built_in">back</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n^2)，其中 n 为 pairs 的长度。排序的时间复杂度为 O(nlogn)，两层 for 循环的时间复杂度为 O(n^2)。</p></li><li><p>空间复杂度：O(n)，数组 dp 的空间复杂度为 O(n)。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)687. 最长同值路径</title>
      <link href="/2022/09/02/%E6%AF%8F%E6%97%A5LeetCode/2022-9/687%20%E6%9C%80%E9%95%BF%E5%90%8C%E5%80%BC%E8%B7%AF%E5%BE%84/"/>
      <url>/2022/09/02/%E6%AF%8F%E6%97%A5LeetCode/2022-9/687%20%E6%9C%80%E9%95%BF%E5%90%8C%E5%80%BC%E8%B7%AF%E5%BE%84/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个二叉树的 root ，返回 最长的路径的长度 ，这个路径中的 每个节点具有相同值 。 这条路径可以经过也可以不经过根节点。</p><p>两个节点之间的路径长度 由它们之间的边数表示。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2020/10/13/ex1.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2020/10/13/ex1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:67%;" /><blockquote><p>输入：root &#x3D; [5,4,5,1,1,5]<br>输出：2</p></blockquote></div><div class="story post-story"><h2 id="思路：深度优先搜索-DFS"><a href="#思路：深度优先搜索-DFS" class="headerlink" title="思路：深度优先搜索(DFS)"></a>思路：深度优先搜索(DFS)</h2><p>递归到树的最底部后，得到左右子树的路径长度</p><p>其中<code>ans</code>记录了左右子树由它们的父节点相连，所得到的左右子树相加的路径长度</p><p>返回值为左右子树中最长路径的长度</p><p>举例：</p><blockquote><p>​     1</p><p>  &#x2F;  \</p><p> <span style="color:red">1</span>     1</p><p>&#x2F; \</p><p>1    1</p></blockquote><ol><li><p>此时，红色标记的就是父节点</p><blockquote><p>  <span style="color:red">1</span></p><p> &#x2F; \</p><p>1    1</p></blockquote></li><li><p>ans的值就为：2(左右子树的路径长度的相加之和)，也就是局部的最优解</p></li><li><p>但是返回值应为左右子树的中的最长路径的长度</p><ul><li><p>因为如果返回左右子树相加之和的路径长度就会导致：</p><blockquote><p>​     1</p><p>  &#x2F;  </p><p> <span style="color:red">1</span>     </p><p>&#x2F; \</p><p>1    1</p></blockquote><p>出现”三岔口”。</p></li><li><p>返回左右子树的中的最长路径的长度</p><blockquote><p>​     1</p><p>  &#x2F;  </p><p> <span style="color:red">1</span>     </p><p>  \</p><p>​     1</p></blockquote><p>不会出现”三岔口”。</p></li></ul></li><li><p>一直向上返回值，直至到达root根节点，最后得到<code>ans</code>的最大值(全局最优解)</p><blockquote><p>​    1</p><p>  &#x2F;  \</p><p> <span style="color:red">1</span>     1</p><p>  \</p><p>​     1</p></blockquote></li></ol></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> ans = <span class="number">0</span>; <span class="comment">//记录最长的路径</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">dfs</span><span class="params">(TreeNode* root)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">//进入最底层的节点，从下往上计算</span></span><br><span class="line">        <span class="type">int</span> L = <span class="built_in">dfs</span>(root-&gt;left); <span class="comment">//获取左子树中最长的一段路径</span></span><br><span class="line">        <span class="type">int</span> R = <span class="built_in">dfs</span>(root-&gt;right); <span class="comment">//获取右子树中最长的一段路径</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> temp_L = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> temp_R = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//如果左子树的值与父节点的值相同，则加一，否则置为0</span></span><br><span class="line">        <span class="keyword">if</span>(root-&gt;left != <span class="literal">nullptr</span> &amp;&amp; root-&gt;left-&gt;val == root-&gt;val)</span><br><span class="line">            temp_L = L + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(root-&gt;right != <span class="literal">nullptr</span> &amp;&amp; root-&gt;right-&gt;val == root-&gt;val)</span><br><span class="line">            temp_R = R + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//将左右子树相加变为一条路径，与之前的最长路径比较</span></span><br><span class="line">        ans = <span class="built_in">max</span>(ans, temp_L + temp_R); </span><br><span class="line"><span class="comment">//返回左子树或右子树中的最长的一段路径</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(temp_L, temp_R);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">longestUnivaluePath</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">dfs</span>(root);</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)，其中 n 为树的结点数目。</li><li>空间复杂度：O(n)。递归栈最坏情况下需要 O(n) 的空间。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1475. 商品折扣后的最终价格</title>
      <link href="/2022/09/01/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1475%20%E5%95%86%E5%93%81%E6%8A%98%E6%89%A3%E5%90%8E%E7%9A%84%E6%9C%80%E7%BB%88%E4%BB%B7%E6%A0%BC/"/>
      <url>/2022/09/01/%E6%AF%8F%E6%97%A5LeetCode/2022-9/1475%20%E5%95%86%E5%93%81%E6%8A%98%E6%89%A3%E5%90%8E%E7%9A%84%E6%9C%80%E7%BB%88%E4%BB%B7%E6%A0%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个数组 prices ，其中 <code>prices[i]</code> 是商店里第 <code>i</code> 件商品的价格。</p><p>商店里正在进行促销活动，如果你要买第 i 件商品，那么你可以得到与 <code>prices[j]</code> 相等的折扣，其中 j 是满足 <code>j &gt; i</code> 且 <code>prices[j] &lt;= prices[i]</code> 的 最小下标 ，如果没有满足条件的 <code>j</code> ，你将没有任何折扣。</p><p>请你返回一个数组，数组中第 <code>i</code> 个元素是折扣后你购买商品 <code>i</code> 最终需要支付的价格。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：prices &#x3D; [8,4,6,2,3]<br>输出：[4,2,4,2,3]<br>解释：<br>商品 0 的价格为 price[0]&#x3D;8 ，你将得到 prices[1]&#x3D;4 的折扣，所以最终价格为 8 - 4 &#x3D; 4 。<br>商品 1 的价格为 price[1]&#x3D;4 ，你将得到 prices[3]&#x3D;2 的折扣，所以最终价格为 4 - 2 &#x3D; 2 。<br>商品 2 的价格为 price[2]&#x3D;6 ，你将得到 prices[3]&#x3D;2 的折扣，所以最终价格为 6 - 2 &#x3D; 4 。<br>商品 3 和 4 都没有折扣。</p></blockquote></div><div class="story post-story"><h2 id="思路：遍历"><a href="#思路：遍历" class="headerlink" title="思路：遍历"></a>思路：遍历</h2><p>遍历找到满足 <code>j &gt; i</code> 且 <code>prices[j] &lt;= prices[i]</code> 的 最小下标</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">finalPrices</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; prices)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = prices.<span class="built_in">size</span>();</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">ans</span><span class="params">(n)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">            ans[i] = prices[i];</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = i + <span class="number">1</span>; j &lt; n; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(prices[j] &lt;= prices[i])&#123;</span><br><span class="line">                    ans[i] -= prices[j];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n^2)，其中 n 为数组的长度。对于每个商品，我们需要遍历一遍数组查找符合题目要求的折扣。</p></li><li><p>空间复杂度：O(1)。返回值不计入空间复杂度。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)946. 验证栈序列</title>
      <link href="/2022/08/31/%E6%AF%8F%E6%97%A5LeetCode/2022-8/946%20%E9%AA%8C%E8%AF%81%E6%A0%88%E5%BA%8F%E5%88%97/"/>
      <url>/2022/08/31/%E6%AF%8F%E6%97%A5LeetCode/2022-8/946%20%E9%AA%8C%E8%AF%81%E6%A0%88%E5%BA%8F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定 pushed 和 popped 两个序列，每个序列中的 值都不重复，只有当它们可能是在最初空栈上进行的推入 push 和弹出 pop 操作序列的结果时，返回 true；否则，返回 false 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：pushed &#x3D; [1,2,3,4,5], popped &#x3D; [4,5,3,2,1]<br>输出：true<br>解释：我们可以按以下顺序执行：<br>push(1), push(2), push(3), push(4), pop() -&gt; 4,<br>push(5), pop() -&gt; 5, pop() -&gt; 3, pop() -&gt; 2, pop() -&gt; 1</p></blockquote></div><div class="story post-story"><h2 id="思路：模拟"><a href="#思路：模拟" class="headerlink" title="思路：模拟"></a>思路：模拟</h2><p>依次将<code>pushed</code>数组中的元素入栈，如果栈<code>s</code>的栈顶等于<code>popped</code>的第一个元素，将栈顶元素出栈，并判断<code>popped</code>数组的下一个元素</p><p>最后只需要判断栈<code>s</code>是否为空即可</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">validateStackSequences</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; pushed, vector&lt;<span class="type">int</span>&gt;&amp; popped)</span> </span>&#123;</span><br><span class="line">        stack&lt;<span class="type">int</span>&gt; s;</span><br><span class="line">        <span class="type">int</span> pos = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pushed.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            s.<span class="built_in">emplace</span>(pushed[i]);</span><br><span class="line">            <span class="keyword">while</span> (!s.<span class="built_in">empty</span>() &amp;&amp; s.<span class="built_in">top</span>() == popped[pos]) &#123;</span><br><span class="line">                s.<span class="built_in">pop</span>();</span><br><span class="line">                pos++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s.<span class="built_in">empty</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，其中 nn 是数组 pushed 和 popped 的长度。需要遍历数组 pushed 和 popped 各一次，判断两个数组是否为有效的栈操作序列。</p></li><li><p>空间复杂度：O(n)，其中 n 是数组 pushed 和 popped 的长度。空间复杂度主要取决于栈空间，栈内元素个数不超过 n。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)998. 最大二叉树 II</title>
      <link href="/2022/08/30/%E6%AF%8F%E6%97%A5LeetCode/2022-8/998%20%E6%9C%80%E5%A4%A7%E4%BA%8C%E5%8F%89%E6%A0%91%20II/"/>
      <url>/2022/08/30/%E6%AF%8F%E6%97%A5LeetCode/2022-8/998%20%E6%9C%80%E5%A4%A7%E4%BA%8C%E5%8F%89%E6%A0%91%20II/</url>
      
        <content type="html"><![CDATA[<p>题目：</p><p>最大树 定义：一棵树，并满足：<strong>其中每个节点的值都大于其子树中的任何其他值</strong>。</p><p>给你最大树的根节点 root 和一个整数 val 。</p><p>就像 之前的问题 那样，给定的树是利用 Construct(a) 例程从列表 a（root &#x3D; Construct(a)）递归地构建的：</p><p>如果 a 为空，返回 null 。<br>否则，令 a[i] 作为 a 的最大元素。创建一个值为 a[i] 的根节点 root 。<br>root 的左子树将被构建为 Construct([a[0], a[1], …, a[i - 1]]) 。<br>root 的右子树将被构建为 Construct([a[i + 1], a[i + 2], …, a[a.length - 1]]) 。<br>返回 root 。<br>请注意，题目没有直接给出 a ，只是给出一个根节点 root &#x3D; Construct(a) 。</p><p>假设 b 是 a 的副本，并在末尾附加值 val。题目数据保证 b 中的值互不相同。</p><p>返回 Construct(b) 。</p><p>示例：</p><p><img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2019/02/23/maximum-binary-tree-1-2.png" class="lazyload" data-srcset="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2019/02/23/maximum-binary-tree-1-2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><blockquote><p>输入：root &#x3D; [4,1,3,null,null,2], val &#x3D; 5<br>输出：[5,4,null,1,3,null,null,2]<br>解释：a &#x3D; [1,4,2,3], b &#x3D; [1,4,2,3,5]</p></blockquote><p>没看懂题目…</p><p>看题解大概是：val足够大，整个树都是左子树。val足够小，变成一个右叶子。</p><p>代码(cpp)：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">insertIntoMaxTree</span><span class="params">(TreeNode* root, <span class="type">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">TreeNode</span>(val);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(root-&gt;val &lt; val)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">TreeNode</span>(val, root, <span class="literal">nullptr</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        root-&gt;right = <span class="built_in">insertIntoMaxTree</span>(root-&gt;right, val);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1470. 重新排列数组</title>
      <link href="/2022/08/29/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1470%20%E9%87%8D%E6%96%B0%E6%8E%92%E5%88%97%E6%95%B0%E7%BB%84/"/>
      <url>/2022/08/29/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1470%20%E9%87%8D%E6%96%B0%E6%8E%92%E5%88%97%E6%95%B0%E7%BB%84/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个数组 <code>nums</code> ，数组中有 2n 个元素，按 <code>[x1,x2,...,xn,y1,y2,...,yn]</code> 的格式排列。</p><p>请你将数组按 <code>[x1,y1,x2,y2,...,xn,yn]</code> 格式重新排列，返回重排后的数组。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [2,5,1,3,4,7], n &#x3D; 3<br>输出：[2,3,5,4,1,7]<br>解释：由于 x1&#x3D;2, x2&#x3D;5, x3&#x3D;1, y1&#x3D;3, y2&#x3D;4, y3&#x3D;7 ，所以答案为 [2,3,5,4,1,7]</p></blockquote></div><div class="story post-story"><h2 id="思路：双指针"><a href="#思路：双指针" class="headerlink" title="思路：双指针"></a>思路：双指针</h2><p>在数组<code>nums</code>的起始位置和中间位置依次遍历添加到<code>ans</code>新数组中</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">shuffle</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">ans</span><span class="params">(<span class="number">2</span>*n)</span></span>;</span><br><span class="line">        <span class="type">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right = n;</span><br><span class="line">        <span class="keyword">while</span>(left &lt; n)&#123;</span><br><span class="line">            ans.<span class="built_in">emplace_back</span>(nums[left]);</span><br><span class="line">            ans.<span class="built_in">emplace_back</span>(nums[right]);</span><br><span class="line">            left++;</span><br><span class="line">            right++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，其中 n 是给定的参数。需要遍历长度为 2n 的数组 nums 一次将数组重新排列，每个元素重新排列的时间是 O(1)O(1)。</p></li><li><p>空间复杂度：O(1)。注意返回值不计入空间复杂度。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)662. 二叉树最大宽度</title>
      <link href="/2022/08/27/%E6%AF%8F%E6%97%A5LeetCode/2022-8/662%20%E4%BA%8C%E5%8F%89%E6%A0%91%E6%9C%80%E5%A4%A7%E5%AE%BD%E5%BA%A6/"/>
      <url>/2022/08/27/%E6%AF%8F%E6%97%A5LeetCode/2022-8/662%20%E4%BA%8C%E5%8F%89%E6%A0%91%E6%9C%80%E5%A4%A7%E5%AE%BD%E5%BA%A6/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一棵二叉树的根节点 <code>root</code> ，返回树的 <strong>最大宽度</strong> 。</p><p>树的 最大宽度 是所有层中最大的 宽度 。</p><p>每一层的 宽度 被定义为该层最左和最右的非空节点（即，两个端点）之间的长度。将这个二叉树视作与满二叉树结构相同，两端点间会出现一些延伸到这一层的 <code>null</code> 节点，这些 <code>null</code> 节点也计入长度。</p><p>题目数据保证答案将会在  32 位 带符号整数范围内。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2021/05/03/width1-tree.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2021/05/03/width1-tree.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:67%;" /><blockquote><p>输入：root &#x3D; [1,3,2,5,3,null,9]<br>输出：4<br>解释：最大宽度出现在树的第 3 层，宽度为 4 (5,3,null,9) 。</p></blockquote></div><div class="story post-story"><h2 id="思路：广度优先搜索-BFS"><a href="#思路：广度优先搜索-BFS" class="headerlink" title="思路：广度优先搜索(BFS)"></a>思路：广度优先搜索(BFS)</h2><p>就是一个二叉树的层序遍历</p><p>只是遍历的时候增加了一个 标记每个<strong>结点</strong>的<strong>序号</strong> 的过程</p><p>如果某节点<code>node</code>的序号为<code>n</code>，那么它的左节点为<code>2n</code>，右节点为<code>2n+1</code></p><p>每层的<strong>尾序号与首序号之间的差</strong>就是该层的宽度</p><p>返回最大宽度</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">widthOfBinaryTree</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 初始化数组储存结点以及对应的序号</span></span><br><span class="line">        vector&lt;pair&lt;TreeNode*, <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>&gt;&gt; array;</span><br><span class="line">        array.<span class="built_in">emplace_back</span>(root, <span class="number">1L</span>);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ans = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>(!array.<span class="built_in">empty</span>())&#123; <span class="comment">//层序遍历</span></span><br><span class="line">            vector&lt;pair&lt;TreeNode*, <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>&gt;&gt; temp;</span><br><span class="line">            <span class="comment">// 获取每个结点以及对应的序号</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; [node, index] : array)&#123; <span class="comment">//遍历该层的每个结点</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span>(node-&gt;left) temp.<span class="built_in">emplace_back</span>(node-&gt;left, index*<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">if</span>(node-&gt;right) temp.<span class="built_in">emplace_back</span>(node-&gt;right, index*<span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ans = <span class="built_in">max</span>(ans, array.<span class="built_in">back</span>().second - array[<span class="number">0</span>].second + <span class="number">1</span>);</span><br><span class="line">            array = <span class="built_in">move</span>(temp); <span class="comment">//将temp(就是下一层的结点)引用给array</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，其中 n 是二叉树的节点个数。需要遍历所有节点。</p></li><li><p>空间复杂度：O(n)。广度优先搜索的空间复杂度最多为 O(n)。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1464. 数组中两元素的最大乘积</title>
      <link href="/2022/08/26/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1464%20%E6%95%B0%E7%BB%84%E4%B8%AD%E4%B8%A4%E5%85%83%E7%B4%A0%E7%9A%84%E6%9C%80%E5%A4%A7%E4%B9%98%E7%A7%AF/"/>
      <url>/2022/08/26/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1464%20%E6%95%B0%E7%BB%84%E4%B8%AD%E4%B8%A4%E5%85%83%E7%B4%A0%E7%9A%84%E6%9C%80%E5%A4%A7%E4%B9%98%E7%A7%AF/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数数组 <code>nums</code>，请你选择数组的两个不同下标 <code>i</code> 和 <code>j</code>，使 <code>(nums[i]-1)*(nums[j]-1)</code> 取得最大值。</p><p>请你计算并返回该式的最大值。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [3,4,5,2]<br>输出：12<br>解释：如果选择下标 i&#x3D;1 和 j&#x3D;2（下标从 0 开始），则可以获得最大值，(nums[1]-1)<em>(nums[2]-1) &#x3D; (4-1)</em>(5-1) &#x3D; 3*4 &#x3D; 12 。 </p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxProduct</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">return</span> (nums[nums.<span class="built_in">size</span>()<span class="number">-2</span>] - <span class="number">1</span>)*(nums[nums.<span class="built_in">size</span>()<span class="number">-1</span>] - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(nlogn)，其中 n 为数组 nums 的长度，主要为数组排序的时间复杂度。</li><li>空间复杂度：O(1)，仅使用常量空间。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)658. 找到 K 个最接近的元素</title>
      <link href="/2022/08/25/%E6%AF%8F%E6%97%A5LeetCode/2022-8/658%20%E6%89%BE%E5%88%B0%20K%20%E4%B8%AA%E6%9C%80%E6%8E%A5%E8%BF%91%E7%9A%84%E5%85%83%E7%B4%A0/"/>
      <url>/2022/08/25/%E6%AF%8F%E6%97%A5LeetCode/2022-8/658%20%E6%89%BE%E5%88%B0%20K%20%E4%B8%AA%E6%9C%80%E6%8E%A5%E8%BF%91%E7%9A%84%E5%85%83%E7%B4%A0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个 排序好 的数组 arr ，两个整数 k 和 x ，从数组中找到最靠近 x（两数之差最小）的 k 个数。返回的结果必须要是按升序排好的。</p><p>整数 a 比整数 b 更接近 x 需要满足：</p><p><code>|a - x| &lt; |b - x|</code> 或者<code>|a - x| == |b - x|</code> 且 <code>a &lt; b</code></p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：arr &#x3D; [1,2,3,4,5], k &#x3D; 4, x &#x3D; 3<br>输出：[1,2,3,4]</p></blockquote></div><div class="story post-story"><h2 id="思路：二分查找-双指针"><a href="#思路：二分查找-双指针" class="headerlink" title="思路：二分查找+双指针"></a>思路：二分查找+双指针</h2><p>利用 <strong>二分查找</strong> 找到第一个不小于x的元素</p><p>利用 <strong>双指针</strong> 循环找到最接近x值的元素区间</p><p>返回此区间的元素即可</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">findClosestElements</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; arr, <span class="type">int</span> k, <span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> right = <span class="built_in">lower_bound</span>(arr.<span class="built_in">begin</span>(), arr.<span class="built_in">end</span>(), x);</span><br><span class="line">        <span class="keyword">auto</span> left = right - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (left &lt; arr.<span class="built_in">begin</span>()) &#123;</span><br><span class="line">                right++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (right &gt;= arr.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                left--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (x - *left &lt;= *right - x) &#123;</span><br><span class="line">                left--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                right++;</span><br><span class="line">            &#125;</span><br><span class="line">            k--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(left + <span class="number">1</span>, right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(logn+k)，其中 n 是数组 arr 的长度。二分查找需要 O(logn)，双指针查找需要 O(k)。</p></li><li><p>空间复杂度：O(1)。返回值不计入空间复杂度。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1460. 通过翻转子数组使两个数组相等</title>
      <link href="/2022/08/24/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1460%20%E9%80%9A%E8%BF%87%E7%BF%BB%E8%BD%AC%E5%AD%90%E6%95%B0%E7%BB%84%E4%BD%BF%E4%B8%A4%E4%B8%AA%E6%95%B0%E7%BB%84%E7%9B%B8%E7%AD%89/"/>
      <url>/2022/08/24/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1460%20%E9%80%9A%E8%BF%87%E7%BF%BB%E8%BD%AC%E5%AD%90%E6%95%B0%E7%BB%84%E4%BD%BF%E4%B8%A4%E4%B8%AA%E6%95%B0%E7%BB%84%E7%9B%B8%E7%AD%89/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你两个长度相同的整数数组 <code>target</code> 和 <code>arr</code> 。每一步中，你可以选择 <code>arr</code> 的任意 非空子数组 并将它翻转。你可以执行此过程任意次。</p><p>如果你能让 <code>arr</code> 变得与 <code>target</code> 相同，返回 <code>True</code>；否则，返回 <code>False</code> 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：target &#x3D; [1,2,3,4], arr &#x3D; [2,4,1,3]<br>输出：true<br>解释：你可以按照如下步骤使 arr 变成 target：<br>1- 翻转子数组 [2,4,1] ，arr 变成 [1,4,2,3]<br>2- 翻转子数组 [4,2] ，arr 变成 [1,2,4,3]<br>3- 翻转子数组 [4,3] ，arr 变成 [1,2,3,4]<br>上述方法并不是唯一的，还存在多种将 arr 变成 target 的方法。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>这道题很简单！</p><p>不需要关注<strong>过程</strong>，只需要看到<strong>结果</strong>即可</p><p>将<code>target</code>与<code>arr</code>排序后比较是否相同即可</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">canBeEqual</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; target, vector&lt;<span class="type">int</span>&gt;&amp; arr)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">sort</span>(target.<span class="built_in">begin</span>(), target.<span class="built_in">end</span>());</span><br><span class="line">        <span class="built_in">sort</span>(arr.<span class="built_in">begin</span>(), arr.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> target == arr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n×logn)，其中 n 是输入数组的长度。排序消耗 O(n×logn) 复杂度，判断是否相同消耗 O(n) 复杂度。</p></li><li><p>空间复杂度：O(logn)，快速排序递归深度平均为 O(logn)。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)655. 输出二叉树</title>
      <link href="/2022/08/22/%E6%AF%8F%E6%97%A5LeetCode/2022-8/655%20%E8%BE%93%E5%87%BA%E4%BA%8C%E5%8F%89%E6%A0%91/"/>
      <url>/2022/08/22/%E6%AF%8F%E6%97%A5LeetCode/2022-8/655%20%E8%BE%93%E5%87%BA%E4%BA%8C%E5%8F%89%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一棵二叉树的根节点 root ，请你构造一个下标从 0 开始、大小为 <code>m x n</code> 的字符串矩阵 <code>res</code> ，用以表示树的 格式化布局 。构造此格式化布局矩阵需要遵循以下规则：</p><p>树的 高度 为 <code>height</code> ，矩阵的行数 m 应该等于 <code>height + 1</code> 。<br>矩阵的列数 <code>n</code> 应该等于 <code>2^(height+1 - 1)</code> 。<br>根节点 需要放置在 顶行 的 正中间 ，对应位置为 <code>res[0][(n-1)/2]</code> 。<br>对于放置在矩阵中的每个节点，设对应位置为 <code>res[r][c]</code> ，将其左子节点放置在 <code>res[r+1][c-2height-r-1]</code> ，右子节点放置在 <code>res[r+1][c+2height-r-1]</code>。<br>继续这一过程，直到树中的所有节点都妥善放置。<br>任意空单元格都应该包含空字符串 <code>&quot;&quot;</code> 。<br>返回构造得到的矩阵 <code>res</code> 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2021/05/03/print2-tree.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2021/05/03/print2-tree.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 67%;" /><blockquote><p>输入：root &#x3D; [1,2,3,null,4]<br>输出：<br>[[“”,””,””,”1”,””,””,””],<br>[“”,”2”,””,””,””,”3”,””],<br>[“”,””,”4”,””,””,””,””]]</p></blockquote></div><div class="story post-story"><h2 id="思路：DFS-深度优先搜索"><a href="#思路：DFS-深度优先搜索" class="headerlink" title="思路：DFS(深度优先搜索)"></a>思路：DFS(深度优先搜索)</h2><ol><li>利用DFS获取深度</li><li>利用DFS遍历二叉树获取对应的val值</li></ol></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getHeight</span><span class="params">(TreeNode* root)</span></span>&#123;</span><br><span class="line">        <span class="type">int</span> height = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(root-&gt;left)&#123;</span><br><span class="line">            height = <span class="built_in">max</span>(height, <span class="built_in">getHeight</span>(root-&gt;left) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(root-&gt;right)&#123;</span><br><span class="line">            height = <span class="built_in">max</span>(height, <span class="built_in">getHeight</span>(root-&gt;right) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> r, <span class="type">int</span> c, TreeNode* root, vector&lt;vector&lt;string&gt;&gt;&amp; res, <span class="type">int</span>&amp; height)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        res[r][c] = <span class="built_in">to_string</span>(root-&gt;val);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">dfs</span>(r+<span class="number">1</span>, c-<span class="built_in">pow</span>(<span class="number">2</span>, height-r<span class="number">-1</span>), root-&gt;left, res, height);</span><br><span class="line">        <span class="built_in">dfs</span>(r+<span class="number">1</span>, c+<span class="built_in">pow</span>(<span class="number">2</span>, height-r<span class="number">-1</span>), root-&gt;right, res, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vector&lt;vector&lt;string&gt;&gt; <span class="built_in">printTree</span>(TreeNode* root) &#123;</span><br><span class="line">        <span class="type">int</span> height = <span class="built_in">getHeight</span>(root); <span class="comment">//获取深度</span></span><br><span class="line">        <span class="type">int</span> m = height + <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> n = <span class="built_in">pow</span>(<span class="number">2</span>, m) - <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//初始化res</span></span><br><span class="line">        vector&lt;vector&lt;string&gt;&gt; <span class="built_in">res</span>(m, <span class="built_in">vector</span>&lt;string&gt;(n));</span><br><span class="line"><span class="comment">//dfs遍历二叉树</span></span><br><span class="line">        <span class="built_in">dfs</span>(<span class="number">0</span>, (n<span class="number">-1</span>)/<span class="number">2</span>, root, res, height);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(height×2^height)，其中height 是二叉树的高度。需要填充 (height + 1)×(2^(height+1) − 1) 的数组。</p></li><li><p>空间复杂度：O(height)，其中 height 是二叉树的高度。空间复杂度主要是递归调用的栈空间，取决于二叉树的高度。注意返回值不计入空间复杂度。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2022/08/22/%E5%B0%8F%E6%8A%80%E5%B7%A7/C++%E4%B8%AD1%E3%80%8A%E3%80%8A%20n%E7%9A%84%E6%84%8F%E6%80%9D/"/>
      <url>/2022/08/22/%E5%B0%8F%E6%8A%80%E5%B7%A7/C++%E4%B8%AD1%E3%80%8A%E3%80%8A%20n%E7%9A%84%E6%84%8F%E6%80%9D/</url>
      
        <content type="html"><![CDATA[<hr><hr><div class="story post-story"><h2 id="1-lt-lt-n是什么意思？"><a href="#1-lt-lt-n是什么意思？" class="headerlink" title="1 &lt;&lt; n是什么意思？"></a><code>1 &lt;&lt; n</code>是什么意思？</h2><p>1的二进制是<code>0000 0001</code><br><code>&lt;&lt;</code>：将二进制编码向左移动n位并将空位补0</p><p>例如：</p><p><code>1 &lt;&lt; 2</code></p><p>就是将<code>0000 0001</code>左移2位为变成<code>0000 0100</code></p><p>转换成十进制最终变成4</p><p>同理：</p><p><code>1 &gt;&gt; n</code>：将二进制编码向右移动n位</p></div>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1455. 检查单词是否为句中其他单词的前缀</title>
      <link href="/2022/08/21/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1455%20%E6%A3%80%E6%9F%A5%E5%8D%95%E8%AF%8D%E6%98%AF%E5%90%A6%E4%B8%BA%E5%8F%A5%E4%B8%AD%E5%85%B6%E4%BB%96%E5%8D%95%E8%AF%8D%E7%9A%84%E5%89%8D%E7%BC%80/"/>
      <url>/2022/08/21/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1455%20%E6%A3%80%E6%9F%A5%E5%8D%95%E8%AF%8D%E6%98%AF%E5%90%A6%E4%B8%BA%E5%8F%A5%E4%B8%AD%E5%85%B6%E4%BB%96%E5%8D%95%E8%AF%8D%E7%9A%84%E5%89%8D%E7%BC%80/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个字符串 sentence 作为句子并指定检索词为 searchWord ，其中句子由若干用 单个空格 分隔的单词组成。请你检查检索词 searchWord 是否为句子 sentence 中任意单词的前缀。</p><p>如果 searchWord 是某一个单词的前缀，则返回句子 sentence 中该单词所对应的下标（下标从 1 开始）。如果 searchWord 是多个单词的前缀，则返回匹配的第一个单词的下标（最小下标）。如果 searchWord 不是任何单词的前缀，则返回 -1 。</p><p>字符串 s 的 前缀 是 s 的任何前导连续子字符串。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：sentence &#x3D; “i love eating burger”, searchWord &#x3D; “burg”<br>输出：4<br>解释：”burg” 是 “burger” 的前缀，而 “burger” 是句子中第 4 个单词。</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">isPrefixOfWord</span><span class="params">(string sentence, string searchWord)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">1</span>; <span class="comment">//初始化第一个单词的wei</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; sentence.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="type">int</span> temp = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (sentence[i] == searchWord[temp]) &#123; <span class="comment">// 与searchWord进行比较</span></span><br><span class="line">                <span class="keyword">if</span> (temp == searchWord.<span class="built_in">size</span>() - <span class="number">1</span>) &#123; <span class="comment">//比较完，返回单词位置</span></span><br><span class="line">                    <span class="keyword">return</span> ans;</span><br><span class="line">                &#125;</span><br><span class="line">                temp++;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; sentence.<span class="built_in">size</span>() &amp;&amp; sentence[i] != <span class="string">&#x27; &#x27;</span>)&#123;<span class="comment">//遍历到下一个单词</span></span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            ans++; <span class="comment">// 进入下一个单词的位置</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">//不存在，返回-1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)654. 最大二叉树</title>
      <link href="/2022/08/20/%E6%AF%8F%E6%97%A5LeetCode/2022-8/654%20%E6%9C%80%E5%A4%A7%E4%BA%8C%E5%8F%89%E6%A0%91/"/>
      <url>/2022/08/20/%E6%AF%8F%E6%97%A5LeetCode/2022-8/654%20%E6%9C%80%E5%A4%A7%E4%BA%8C%E5%8F%89%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个不重复的整数数组 nums 。 最大二叉树 可以用下面的算法从 nums 递归地构建:</p><p>创建一个根节点，其值为 nums 中的最大值。<br>递归地在最大值 左边 的 子数组前缀上 构建左子树。<br>递归地在最大值 右边 的 子数组后缀上 构建右子树。<br>返回 nums 构建的 最大二叉树 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2020/12/24/tree1.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2020/12/24/tree1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 50%;" /><blockquote><p>输入：nums &#x3D; [3,2,1,6,0,5]<br>输出：[6,3,5,null,2,0,null,null,1]<br>解释：递归调用如下所示：</p><p>[3,2,1,6,0,5] 中的最大值是 6 ，左边部分是 [3,2,1] ，右边部分是 [0,5] 。</p><ul><li>[3,2,1] 中的最大值是 3 ，左边部分是 [] ，右边部分是 [2,1] 。<ul><li>空数组，无子节点。</li><li>[2,1] 中的最大值是 2 ，左边部分是 [] ，右边部分是 [1] 。<ul><li>空数组，无子节点。</li><li>只有一个元素，所以子节点是一个值为 1 的节点。</li></ul></li></ul></li><li>[0,5] 中的最大值是 5 ，左边部分是 [0] ，右边部分是 [] 。<ul><li>只有一个元素，所以子节点是一个值为 0 的节点。</li><li>空数组，无子节点。</li></ul></li></ul></blockquote></div><div class="story post-story"><h2 id="思路：递归"><a href="#思路：递归" class="headerlink" title="思路：递归"></a>思路：递归</h2><p>每次递归遍历中找到<code>left</code>和<code>right</code>区间的最大值作为该节点的<code>val</code>值，以及该最大值的位置<code>max_pos</code></p><p>划分该节点的左子树的区间为<code>left</code>和<code>max_pos</code></p><p>划分该节点的右子树的区间为<code>max_pos+1</code>和<code>right</code></p><p>如果左右区间<code>left &gt;= right</code>说明已经遍历完全，退出递归</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">def</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> left, <span class="type">int</span> right)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(left &gt;= right) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> temp = <span class="number">-1</span>;</span><br><span class="line">        <span class="type">int</span> max_pos = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = left; i &lt; right; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[i] &gt; temp)&#123;</span><br><span class="line">                temp = nums[i];</span><br><span class="line">                max_pos = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TreeNode* node = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(temp);</span><br><span class="line">        node-&gt;left = <span class="built_in">def</span>(nums, left, max_pos);</span><br><span class="line">        node-&gt;right = <span class="built_in">def</span>(nums, max_pos + <span class="number">1</span>, right);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">TreeNode* <span class="title">constructMaximumBinaryTree</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">def</span>(nums, <span class="number">0</span>, nums.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n^2)，其中 n 是数组 nums 的长度。在最坏的情况下，数组严格递增或递减，需要递归 n 层，第 (0 ≤ i &lt; n) 层需要遍历 n-i 个元素以找出最大值，总时间复杂度为 O(n^2)。</p></li><li><p>空间复杂度：O(n)，即为最坏情况下需要使用的栈空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker中安装es以及kibana</title>
      <link href="/2022/08/19/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/Docker%E4%B8%AD%E5%AE%89%E8%A3%85es%E4%BB%A5%E5%8F%8Akibana/"/>
      <url>/2022/08/19/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/Docker%E4%B8%AD%E5%AE%89%E8%A3%85es%E4%BB%A5%E5%8F%8Akibana/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="1-es"><a href="#1-es" class="headerlink" title="1.es"></a>1.es</h2><h3 id="1-1-安装es镜像"><a href="#1-1-安装es镜像" class="headerlink" title="1.1 安装es镜像"></a>1.1 安装es镜像</h3><p>我的容器中jdk版本为8</p><p>这里我选择的是es的7.17.5版本镜像镜像安装，因为<strong>es8以上的版本不支持jdk8</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull elasticsearch:7.17.5</span><br></pre></td></tr></table></figure><h3 id="1-2-启动es容器"><a href="#1-2-启动es容器" class="headerlink" title="1.2 启动es容器"></a>1.2 启动es容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -id \</span><br><span class="line">--name c_es \</span><br><span class="line">-p 9200:9200 \</span><br><span class="line">-e &quot;discovery.type=single-node&quot; \</span><br><span class="line">elasticsearch:7.17.5</span><br></pre></td></tr></table></figure><h3 id="1-3-测试"><a href="#1-3-测试" class="headerlink" title="1.3 测试"></a>1.3 测试</h3><p>在浏览器中访问：<code>http://主机地址ip:9200</code></p><p>如果出现：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;3c9efa3c75db&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;cluster_name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;docker-cluster&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;cluster_uuid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1hr4ILNNQfufDSJYgcuIHQ&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;7.17.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build_flavor&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;docker&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build_hash&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;8d61b4f7ddf931f219e3745f295ed2bbc50c8e84&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build_date&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2022-06-23T21:57:28.736740635Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build_snapshot&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lucene_version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;8.11.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;minimum_wire_compatibility_version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;6.8.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;minimum_index_compatibility_version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;6.0.0-beta1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tagline&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>则说明安装成功！</p><h3 id="1-4-跨域访问问题"><a href="#1-4-跨域访问问题" class="headerlink" title="1.4 跨域访问问题"></a>1.4 跨域访问问题</h3><p>进入容器：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it c_es /bin/bash</span><br></pre></td></tr></table></figure><p>修改<code>elasticsearch.yml</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/elasticsearch/config/</span><br><span class="line">vi elasticsearch.yml</span><br></pre></td></tr></table></figure><p>文件末尾添加以下内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure><p>重启容器：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart c_es</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="2-kibana"><a href="#2-kibana" class="headerlink" title="2.kibana"></a>2.kibana</h2><h3 id="2-1-安装kibana镜像"><a href="#2-1-安装kibana镜像" class="headerlink" title="2.1 安装kibana镜像"></a>2.1 安装kibana镜像</h3><p>前提：已经成功部署es</p><p><strong>注意</strong>：kibana版本要与es的版本一致</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull kibana:7.17.5</span><br></pre></td></tr></table></figure><h3 id="2-2-获取es容器内部ip"><a href="#2-2-获取es容器内部ip" class="headerlink" title="2.2 获取es容器内部ip"></a>2.2 获取es容器内部ip</h3><p>查看c_es容器信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect c_es</span><br></pre></td></tr></table></figure><p>找到<code>IPAddress: &quot;ip&quot;</code>，此ip就是<strong>es容器内部ip</strong></p><h3 id="2-3-启动kibana容器"><a href="#2-3-启动kibana容器" class="headerlink" title="2.3 启动kibana容器"></a>2.3 启动kibana容器</h3><p>将<code>ELASTICSEARCH_HOSTS</code>修改为<strong>自己es容器内部ip</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -id \</span><br><span class="line">--name c_kibana \</span><br><span class="line">-e ELASTICSEARCH_HOSTS=http://es容器内部ip:9200 \</span><br><span class="line">-p 5601:5601 \</span><br><span class="line">kibana:7.17.5</span><br></pre></td></tr></table></figure><h3 id="2-4-修改中文"><a href="#2-4-修改中文" class="headerlink" title="2.4 修改中文"></a>2.4 修改中文</h3><p>进入容器：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -u 0 -it c_kibana /bin/bash</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd config</span><br><span class="line">vi kibana.yml</span><br></pre></td></tr></table></figure><p>在末尾加上一下内容： </p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">i18n.locale:</span> <span class="string">&quot;zh-CN&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-5-测试"><a href="#2-5-测试" class="headerlink" title="2.5 测试"></a>2.5 测试</h3><p>在浏览器中访问：<code>http://主机地址ip:5601</code></p><p>就可以看到kibana的界面了！</p></div>]]></content>
      
      
      <categories>
          
          <category> 软件安装 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 容器 </tag>
            
            <tag> es </tag>
            
            <tag> kibana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1450. 在既定时间做作业的学生人数</title>
      <link href="/2022/08/19/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1450%20%E5%9C%A8%E6%97%A2%E5%AE%9A%E6%97%B6%E9%97%B4%E5%81%9A%E4%BD%9C%E4%B8%9A%E7%9A%84%E5%AD%A6%E7%94%9F%E4%BA%BA%E6%95%B0/"/>
      <url>/2022/08/19/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1450%20%E5%9C%A8%E6%97%A2%E5%AE%9A%E6%97%B6%E9%97%B4%E5%81%9A%E4%BD%9C%E4%B8%9A%E7%9A%84%E5%AD%A6%E7%94%9F%E4%BA%BA%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你两个整数数组 <code>startTime</code>（开始时间）和 <code>endTime</code>（结束时间），并指定一个整数 <code>queryTime</code> 作为查询时间。</p><p>已知，第 <code>i</code> 名学生在 <code>startTime[i]</code> 时开始写作业并于 <code>endTime[i]</code> 时完成作业。</p><p>请返回在查询时间 <code>queryTime</code> 时正在做作业的学生人数。形式上，返回能够使 <code>queryTime</code> 处于区间 <code>[startTime[i], endTime[i]]</code>（含）的学生人数。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：startTime &#x3D; [1,2,3], endTime &#x3D; [3,2,7], queryTime &#x3D; 4<br>输出：1<br>解释：一共有 3 名学生。<br>第一名学生在时间 1 开始写作业，并于时间 3 完成作业，在时间 4 没有处于做作业的状态。<br>第二名学生在时间 2 开始写作业，并于时间 2 完成作业，在时间 4 没有处于做作业的状态。<br>第三名学生在时间 3 开始写作业，预计于时间 7 完成作业，这是是唯一一名在时间 4 时正在做作业的学生。</p></blockquote></div><div class="story post-story"><h2 id="思路：枚举"><a href="#思路：枚举" class="headerlink" title="思路：枚举"></a>思路：枚举</h2><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">busyStudent</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; startTime, vector&lt;<span class="type">int</span>&gt;&amp; endTime, <span class="type">int</span> queryTime)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; startTime.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(startTime[i] &lt;= queryTime &amp;&amp; queryTime &lt;= endTime[i]) &#123;</span><br><span class="line">                sum++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)，其中 n 为 数组的长度。只需遍历一遍数组即可。</li><li>空间复杂度：O(1)。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1302. 层数最深叶子节点的和</title>
      <link href="/2022/08/17/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1302%20%E5%B1%82%E6%95%B0%E6%9C%80%E6%B7%B1%E5%8F%B6%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E5%92%8C/"/>
      <url>/2022/08/17/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1302%20%E5%B1%82%E6%95%B0%E6%9C%80%E6%B7%B1%E5%8F%B6%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E5%92%8C/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一棵二叉树的根节点 <code>root</code> ，请你返回 <strong>层数最深的叶子节点的和</strong> 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2019/12/28/1483_ex1.png" class="lazyload" data-srcset="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2019/12/28/1483_ex1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 67%;" /><blockquote><p>输入：root &#x3D; [1,2,3,4,5,null,6,7,null,null,null,null,8]<br>输出：15</p></blockquote></div><div class="story post-story"><h2 id="思路一：深度优先搜索-DFS"><a href="#思路一：深度优先搜索-DFS" class="headerlink" title="思路一：深度优先搜索(DFS)"></a>思路一：深度优先搜索(DFS)</h2><h3 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> max_level = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(TreeNode* root, <span class="type">int</span> level)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!root) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(max_level &lt; level)&#123; <span class="comment">//max_sum如果不是最大深度，重新开始</span></span><br><span class="line">            sum = root-&gt;val;</span><br><span class="line">            max_level = level;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(max_level == level) &#123; <span class="comment">//为最大深度，le</span></span><br><span class="line">            sum += root-&gt;val;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">dfs</span>(root-&gt;left, level + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">dfs</span>(root-&gt;right, level + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">deepestLeavesSum</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">dfs</span>(root, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h3><ul><li><p>时间复杂度：O(n)，其中 n 是二叉树的节点数。深度优先搜索需要遍历每个节点一次。</p></li><li><p>空间复杂度：O(n)，其中 n 是二叉树的节点数。空间复杂度主要取决于递归调用栈的深度，为二叉树的深度，最坏情况下二叉树的深度是 O(n)。</p></li></ul></div><div class="story post-story"><h2 id="思路二：广度优先搜索-BFS"><a href="#思路二：广度优先搜索-BFS" class="headerlink" title="思路二：广度优先搜索(BFS)"></a>思路二：广度优先搜索(BFS)</h2><h3 id="代码-cpp-：-1"><a href="#代码-cpp-：-1" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">deepestLeavesSum</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        queue&lt;TreeNode*&gt; q;</span><br><span class="line">        q.<span class="built_in">emplace</span>(root);</span><br><span class="line">        <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>())&#123; <span class="comment">//层遍历</span></span><br><span class="line">            sum = <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> size = q.<span class="built_in">size</span>(); <span class="comment">//获取该层的元素个数</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++)&#123; <span class="comment">//该层的元素遍历</span></span><br><span class="line">                TreeNode* node = q.<span class="built_in">front</span>();</span><br><span class="line">                q.<span class="built_in">pop</span>();</span><br><span class="line">                <span class="keyword">if</span>(node-&gt;left)  q.<span class="built_in">emplace</span>(node-&gt;left);</span><br><span class="line">                <span class="keyword">if</span>(node-&gt;right)  q.<span class="built_in">emplace</span>(node-&gt;right);</span><br><span class="line">                sum += node-&gt;val;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="复杂度分析：-1"><a href="#复杂度分析：-1" class="headerlink" title="复杂度分析："></a>复杂度分析：</h3><ul><li><p>时间复杂度：O(n)，其中 n 是二叉树的节点数。广度优先搜索需要遍历每个节点一次。</p></li><li><p>空间复杂度：O(n)，其中 n 是二叉树的节点数。空间复杂度主要取决于队列空间，队列中的节点个数不超过 n 个。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1656. 设计有序流</title>
      <link href="/2022/08/16/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1656%20%E8%AE%BE%E8%AE%A1%E6%9C%89%E5%BA%8F%E6%B5%81/"/>
      <url>/2022/08/16/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1656%20%E8%AE%BE%E8%AE%A1%E6%9C%89%E5%BA%8F%E6%B5%81/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>有 <code>n</code> 个 <code>(id, value)</code> 对，其中 <code>id</code> 是 <code>1</code> 到 <code>n</code> 之间的一个整数，<code>value</code> 是一个字符串。不存在 <code>id</code> 相同的两个 <code>(id, value)</code> 对。</p><p>设计一个流，以 任意 顺序获取 <code>n</code> 个 <code>(id, value)</code> 对，并在多次调用时 <strong>按 <code>id</code> 递增的顺序</strong> 返回一些值。</p><p>实现 <code>OrderedStream</code> 类：</p><ul><li><code>OrderedStream(int n)</code> 构造一个能接收 <code>n</code> 个值的流，并将当前指针 <code>ptr</code> 设为 <code>1</code> 。</li><li><code>String[] insert(int id, String value)</code> 向流中存储新的 <code>(id, value)</code> 对。存储后：<ul><li>如果流存储有 <code>id = ptr</code> 的 <code>(id, value)</code> 对，则找出从 <code>id = ptr</code> 开始的 最长 <strong><code>id</code> 连续递增序列</strong> ，并 <strong>按顺序</strong> 返回与这些 <code>id</code> 关联的值的列表。然后，将 <code>ptr</code> 更新为最后那个  <code>id + 1</code> 。</li><li>否则，返回一个空列表。</li></ul></li></ul></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><p><img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/11/15/q1.gif" class="lazyload" data-srcset="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/11/15/q1.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><blockquote><p>输入<br>[“OrderedStream”, “insert”, “insert”, “insert”, “insert”, “insert”]<br>[[5], [3, “ccccc”], [1, “aaaaa”], [2, “bbbbb”], [5, “eeeee”], [4, “ddddd”]]<br>输出<br>[null, [], [“aaaaa”], [“bbbbb”, “ccccc”], [], [“ddddd”, “eeeee”]]</p><p>解释<br>OrderedStream os&#x3D; new OrderedStream(5);<br>os.insert(3, “ccccc”); &#x2F;&#x2F; 插入 (3, “ccccc”)，返回 []<br>os.insert(1, “aaaaa”); &#x2F;&#x2F; 插入 (1, “aaaaa”)，返回 [“aaaaa”]<br>os.insert(2, “bbbbb”); &#x2F;&#x2F; 插入 (2, “bbbbb”)，返回 [“bbbbb”, “ccccc”]<br>os.insert(5, “eeeee”); &#x2F;&#x2F; 插入 (5, “eeeee”)，返回 []<br>os.insert(4, “ddddd”); &#x2F;&#x2F; 插入 (4, “ddddd”)，返回 [“ddddd”, “eeeee”]</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OrderedStream</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> ptr;</span><br><span class="line">    vector&lt;string&gt; array;</span><br><span class="line">    <span class="built_in">OrderedStream</span>(<span class="type">int</span> n) &#123;</span><br><span class="line">        ptr = <span class="number">1</span>;</span><br><span class="line">        array = <span class="built_in">vector</span>&lt;string&gt;(n + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">insert</span><span class="params">(<span class="type">int</span> idKey, string value)</span> </span>&#123;</span><br><span class="line">        vector&lt;string&gt; ans;</span><br><span class="line">        array[idKey] = value;</span><br><span class="line">        <span class="keyword">while</span>(ptr &lt; array.<span class="built_in">size</span>() &amp;&amp; array[ptr] != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">            ans.<span class="built_in">emplace_back</span>(array[ptr]);</span><br><span class="line">            ptr++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：OrderedStream(int n) 的时间复杂度为 O(n)；String[] insert(int id, String value) 的时间复杂度为均摊 O(1)，这是因为我们会恰好调用该函数 n 次，那么每一个字符串最多会被包含在返回数组中一次。</p></li><li><p>空间复杂度：O(n)，即为存储 n 个字符串需要的空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)641. 设计循环双端队列</title>
      <link href="/2022/08/15/%E6%AF%8F%E6%97%A5LeetCode/2022-8/641%20%E8%AE%BE%E8%AE%A1%E5%BE%AA%E7%8E%AF%E5%8F%8C%E7%AB%AF%E9%98%9F%E5%88%97/"/>
      <url>/2022/08/15/%E6%AF%8F%E6%97%A5LeetCode/2022-8/641%20%E8%AE%BE%E8%AE%A1%E5%BE%AA%E7%8E%AF%E5%8F%8C%E7%AB%AF%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>设计实现双端队列。</p><p>实现 MyCircularDeque 类:</p><ul><li><p><code>MyCircularDeque(int k)</code> ：构造函数,双端队列最大为 k 。</p></li><li><p><code>boolean insertFront()</code>：将一个元素添加到双端队列头部。 如果操作成功返回 true ，否则返回 false。</p></li><li><p><code>boolean insertLast()</code> ：将一个元素添加到双端队列尾部。如果操作成功返回 true ，否则返回 false 。</p></li><li><p><code>boolean deleteFront()</code> ：从双端队列头部删除一个元素。 如果操作成功返回 true ，否则返回 false 。</p></li><li><p><code>boolean deleteLast()</code> ：从双端队列尾部删除一个元素。如果操作成功返回 true ，否则返回 false 。</p></li><li><p><code>int getFront()</code>：从双端队列头部获得一个元素。如果双端队列为空，返回 -1 。</p></li><li><p><code>int getRear()</code> ：获得双端队列的最后一个元素。 如果双端队列为空，返回 -1 。</p></li><li><p><code>boolean isEmpty()</code> ：若双端队列为空，则返回 true ，否则返回 false  。</p></li><li><p><code>boolean isFull()</code> ：若双端队列满了，则返回 true ，否则返回 false 。</p></li></ul></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入<br>[“MyCircularDeque”, “insertLast”, “insertLast”, “insertFront”, “insertFront”, “getRear”, “isFull”, “deleteLast”, “insertFront”, “getFront”]<br>[[3], [1], [2], [3], [4], [], [], [], [4], []]<br>输出<br>[null, true, true, true, false, 2, true, true, true, 4]</p><p>解释<br>MyCircularDeque circularDeque &#x3D; new MycircularDeque(3); &#x2F;&#x2F; 设置容量大小为3<br>circularDeque.insertLast(1);       &#x2F;&#x2F; 返回 true<br>circularDeque.insertLast(2);       &#x2F;&#x2F; 返回 true<br>circularDeque.insertFront(3);     &#x2F;&#x2F; 返回 true<br>circularDeque.insertFront(4);     &#x2F;&#x2F; 已经满了，返回 false<br>circularDeque.getRear();        &#x2F;&#x2F; 返回 2<br>circularDeque.isFull();             &#x2F;&#x2F; 返回 true<br>circularDeque.deleteLast();        &#x2F;&#x2F; 返回 true<br>circularDeque.insertFront(4);     &#x2F;&#x2F; 返回 true<br>circularDeque.getFront();       &#x2F;&#x2F; 返回 4</p></blockquote></div><div class="story post-story"><h2 id="思路：数组"><a href="#思路：数组" class="headerlink" title="思路：数组"></a>思路：数组</h2><p>可参考<a href="/2022/08/02/%E6%AF%8F%E6%97%A5LeetCode/2022-8/622%20%E8%AE%BE%E8%AE%A1%E5%BE%AA%E7%8E%AF%E9%98%9F%E5%88%97">力扣 622 设计循环队列</a></p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyCircularDeque</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; deque;</span><br><span class="line">    <span class="type">int</span> front;</span><br><span class="line">    <span class="type">int</span> rear;</span><br><span class="line">    <span class="type">int</span> capacity;</span><br><span class="line">    <span class="built_in">MyCircularDeque</span>(<span class="type">int</span> k) &#123;</span><br><span class="line">        capacity = k;</span><br><span class="line">        deque = <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(k + <span class="number">1</span>);</span><br><span class="line">        front = <span class="number">0</span>;</span><br><span class="line">        rear = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">insertFront</span><span class="params">(<span class="type">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isFull</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        front = (front - <span class="number">1</span> + capacity + <span class="number">1</span>) % (capacity + <span class="number">1</span>);</span><br><span class="line">        deque[front] = value;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">insertLast</span><span class="params">(<span class="type">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isFull</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        deque[rear] = value;</span><br><span class="line">        rear = (rear + <span class="number">1</span>) % (capacity + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">deleteFront</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isEmpty</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        front = (front + <span class="number">1</span>) % (capacity + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">deleteLast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isEmpty</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        rear = (rear - <span class="number">1</span> + capacity + <span class="number">1</span>) % (capacity + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getFront</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isEmpty</span>()) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> deque[front];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getRear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isEmpty</span>()) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> deque[(rear - <span class="number">1</span> + capacity + <span class="number">1</span>) % (capacity + <span class="number">1</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> front == rear;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (rear + <span class="number">1</span>) % (capacity + <span class="number">1</span>) == front;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：初始化和每项操作的时间复杂度均为 O(1)。</li><li>空间复杂度：O(k)，其中 k 为给定的队列元素数目。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1422. 分割字符串的最大得分</title>
      <link href="/2022/08/14/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1422%20%E5%88%86%E5%89%B2%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%9C%80%E5%A4%A7%E5%BE%97%E5%88%86/"/>
      <url>/2022/08/14/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1422%20%E5%88%86%E5%89%B2%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%9C%80%E5%A4%A7%E5%BE%97%E5%88%86/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个由若干 0 和 1 组成的字符串 s ，请你计算并返回将该字符串分割成两个 非空 子字符串（即 左 子字符串和 右 子字符串）所能获得的最大得分。</p><p>「分割字符串的得分」为 左 子字符串中 0 的数量加上 右 子字符串中 1 的数量。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “011101”<br>输出：5<br>解释：<br>将字符串 s 划分为两个非空子字符串的可行方案有：<br>左子字符串 &#x3D; “0” 且 右子字符串 &#x3D; “11101”，得分 &#x3D; 1 + 4 &#x3D; 5<br>左子字符串 &#x3D; “01” 且 右子字符串 &#x3D; “1101”，得分 &#x3D; 1 + 3 &#x3D; 4<br>左子字符串 &#x3D; “011” 且 右子字符串 &#x3D; “101”，得分 &#x3D; 1 + 2 &#x3D; 3<br>左子字符串 &#x3D; “0111” 且 右子字符串 &#x3D; “01”，得分 &#x3D; 1 + 1 &#x3D; 2<br>左子字符串 &#x3D; “01110” 且 右子字符串 &#x3D; “1”，得分 &#x3D; 2 + 1 &#x3D; 3</p></blockquote></div><div class="story post-story"><h2 id="思路：枚举"><a href="#思路：枚举" class="headerlink" title="思路：枚举"></a>思路：枚举</h2><p>获得每一种可能的分数，比较出最高得分</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxScore</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> score = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>() - <span class="number">1</span>; i++)&#123;</span><br><span class="line">            <span class="type">int</span> temp_score = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt;= i; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(s[j] == <span class="string">&#x27;0&#x27;</span>)&#123;</span><br><span class="line">                    temp_score++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> k = i + <span class="number">1</span>; k &lt; s.<span class="built_in">size</span>(); k++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(s[k] == <span class="string">&#x27;1&#x27;</span>)&#123;</span><br><span class="line">                    temp_score++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            score = <span class="built_in">max</span>(score, temp_score);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> score;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n^2)，其中 n 是字符串 s 的长度。需要遍历 n−1 个分割点，对于每个分割点需要 O(n) 的时间遍历整个字符串计算分割字符串的得分，因此时间复杂度是 O(n^2)</p></li><li><p>空间复杂度：O(1)</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1282. 用户分组</title>
      <link href="/2022/08/12/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1282%20%E7%94%A8%E6%88%B7%E5%88%86%E7%BB%84/"/>
      <url>/2022/08/12/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1282%20%E7%94%A8%E6%88%B7%E5%88%86%E7%BB%84/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>有 n 个人被分成数量未知的组。每个人都被标记为一个从 0 到 n - 1 的唯一ID 。</p><p>给定一个整数数组 groupSizes ，其中 groupSizes[i] 是第 i 个人所在的组的大小。例如，如果 groupSizes[1] &#x3D; 3 ，则第 1 个人必须位于大小为 3 的组中。</p><p>返回一个组列表，使每个人 i 都在一个大小为 groupSizes[i] 的组中。</p><p>每个人应该 恰好只 出现在 一个组 中，并且每个人必须在一个组中。如果有多个答案，返回其中 任何 一个。可以 保证 给定输入 至少有一个 有效的解。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：groupSizes &#x3D; [3,3,3,3,3,1,3]<br>输出：[[5],[0,1,2],[3,4,6]]<br>解释：<br>第一组是 [5]，大小为 1，groupSizes[5] &#x3D; 1。<br>第二组是 [0,1,2]，大小为 3，groupSizes[0] &#x3D; groupSizes[1] &#x3D; groupSizes[2] &#x3D; 3。<br>第三组是 [3,4,6]，大小为 3，groupSizes[3] &#x3D; groupSizes[4] &#x3D; groupSizes[6] &#x3D; 3。<br>其他可能的解决方案有 [[2,1,6],[5],[0,4,3]] 和 [[5],[0,6,2],[4,3,1]]。</p></blockquote></div><div class="story post-story"><h2 id="思路：哈希表"><a href="#思路：哈希表" class="headerlink" title="思路：哈希表"></a>思路：哈希表</h2><p>使用哈希表获取用户人数相同的元素的所在位置</p><p>遍历哈希表，依次截取用户人数为大小的片段</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">groupThePeople</span>(vector&lt;<span class="type">int</span>&gt;&amp; groupSizes) &#123;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, vector&lt;<span class="type">int</span>&gt;&gt; groups;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; groupSizes.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            groups[groupSizes[i]].<span class="built_in">emplace_back</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; ans;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; group : groups)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> it = group.second.<span class="built_in">begin</span>(); it != group.second.<span class="built_in">end</span>();)&#123;</span><br><span class="line">                ans.<span class="built_in">emplace_back</span>(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(it, it + group.first)); <span class="comment">//截取数组片段</span></span><br><span class="line">                it += group.first;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，其中 n 是数组 groupSize 的长度。需要遍历数组一次得到每个组的大小对应的所有人的编号，然后需要遍历所有元素完成分组。</p></li><li><p>空间复杂度：O(n)，其中 n 是数组 groupSize 的长度。空间复杂度主要取决于哈希表，哈希表需要 O(n) 的空间记录每个组的大小对应的所有人的编号。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1417. 重新格式化字符串</title>
      <link href="/2022/08/11/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1417%20%E9%87%8D%E6%96%B0%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
      <url>/2022/08/11/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1417%20%E9%87%8D%E6%96%B0%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个混合了数字和字母的字符串 s，其中的字母均为小写英文字母。</p><p>请你将该字符串重新格式化，使得任意两个相邻字符的类型都不同。也就是说，字母后面应该跟着数字，而数字后面应该跟着字母。</p><p>请你返回 重新格式化后 的字符串；如果无法按要求重新格式化，则返回一个 空字符串 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><p>输入：s &#x3D; “a0b1c2”<br>输出：”0a1b2c”<br>解释：”0a1b2c” 中任意两个相邻字符的类型都不同。 “a0b1c2”, “0a1b2c”, “0c2a1b” 也是满足题目要求的答案。</p></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>分别获取数字<code>num</code>和字母<code>letter</code></p><p>求得数字长度与字母长度之间的差：</p><ul><li><p>差的绝对值大于1，则无解；</p></li><li><p>差等于0，依次添加数字、字母；</p></li><li><p>差等于1，先添加数字再添加字母；</p></li><li><p>差等于-1，先添加字母再添加数字；</p></li></ul></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">reformat</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        string num = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        string letter = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> i : s)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i &gt;= <span class="number">48</span> &amp;&amp; i &lt;= <span class="number">57</span>)&#123;</span><br><span class="line">                num += i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                letter += i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> temp = num.<span class="built_in">size</span>() - letter.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">if</span>(temp &gt; <span class="number">1</span> || temp &lt; <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        string ans;</span><br><span class="line">        <span class="keyword">if</span>(temp == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; num.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">                ans += num[i];</span><br><span class="line">                ans += letter[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(temp == <span class="number">1</span>)&#123;</span><br><span class="line">            ans += num[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; letter.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">                ans += letter[i]; </span><br><span class="line">                ans += num[i + <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            ans += letter[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; num.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">                ans += num[i]; </span><br><span class="line">                ans += letter[i + <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2022/08/11/C++/%E5%81%9A%E9%A2%98%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0/"/>
      <url>/2022/08/11/C++/%E5%81%9A%E9%A2%98%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th align="center">函数</th><th align="center"></th><th></th></tr></thead><tbody><tr><td align="center">bool isdigit(char c)</td><td align="center">判断字符是否为数字</td><td></td></tr><tr><td align="center">int abs(int num)</td><td align="center">获取num的绝对值</td><td></td></tr><tr><td align="center">string to_string (int val)</td><td align="center">数字转字符串</td><td></td></tr><tr><td align="center">iterator lower_bound(<br>iterator first, iterator last, T&amp; val)</td><td align="center">指定区域内查找不小于目标值的第一个元素</td><td>二分查找</td></tr><tr><td align="center">T move(T t)</td><td align="center">将左值强制转化为右值引用</td><td>效率更高,<br>增强型等号</td></tr><tr><td align="center">int atoi(const char *nptr)</td><td align="center">将char*类型的字符串转为int整型</td><td></td></tr><tr><td align="center">int stoi(string str)</td><td align="center">将string类型的字符串转为int整型</td><td></td></tr><tr><td align="center">accumulate(起始迭代器, 结束迭代器, 初始值, 自定义操作函数)</td><td align="center">累加</td><td></td></tr><tr><td align="center">int islower(int c)</td><td align="center">检查所传的字符是否是小写字母</td><td></td></tr><tr><td align="center">string substr(int start, int length);</td><td align="center">从start位置开始，截取length个字符</td><td></td></tr></tbody></table>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1413. 逐步求和得到正数的最小值</title>
      <link href="/2022/08/09/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1413%20%E9%80%90%E6%AD%A5%E6%B1%82%E5%92%8C%E5%BE%97%E5%88%B0%E6%AD%A3%E6%95%B0%E7%9A%84%E6%9C%80%E5%B0%8F%E5%80%BC/"/>
      <url>/2022/08/09/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1413%20%E9%80%90%E6%AD%A5%E6%B1%82%E5%92%8C%E5%BE%97%E5%88%B0%E6%AD%A3%E6%95%B0%E7%9A%84%E6%9C%80%E5%B0%8F%E5%80%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数数组 <code>nums</code> 。你可以选定任意的 正数 <code>startValue</code> 作为初始值。</p><p>你需要从左到右遍历 <code>nums</code> 数组，并将 <code>startValue</code> 依次累加上 <code>nums</code> 数组中的值。</p><p>请你在确保累加和始终大于等于 1 的前提下，选出一个最小的 正数 作为 <code>startValue</code> 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [-3,2,-3,4,2]<br>输出：5<br>解释：如果你选择 startValue &#x3D; 4，在第三次累加时，和小于 1 。<br>         累加求和<br>         startValue &#x3D; 4 | startValue &#x3D; 5 | nums<br>           (4 -3 ) &#x3D; 1  | (5 -3 ) &#x3D; 2    |  -3<br>           (1 +2 ) &#x3D; 3  | (2 +2 ) &#x3D; 4    |   2<br>           (3 -3 ) &#x3D; 0  | (4 -3 ) &#x3D; 1    |  -3<br>           (0 +4 ) &#x3D; 4  | (1 +4 ) &#x3D; 5    |   4<br>           (4 +2 ) &#x3D; 6  | (5 +2 ) &#x3D; 7    |   2</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>遍历数组，如果累加中小于1时，增加<code>startValue</code>的值直到累加为1</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minStartValue</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> startValue = <span class="number">1</span>; <span class="comment">//初始化为1，因为startValue为最小的正数</span></span><br><span class="line">        <span class="type">int</span> sum = <span class="number">1</span>; <span class="comment">//初始化为1，因为一开始初始化为0要加上startValue就变成了1</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; num : nums)&#123;</span><br><span class="line">            sum += num; <span class="comment">//累加</span></span><br><span class="line">            <span class="keyword">if</span>(sum &lt; <span class="number">1</span>)&#123; <span class="comment">//小于1的情况</span></span><br><span class="line">                startValue += <span class="number">1</span> - sum; <span class="comment">//加上相差的数</span></span><br><span class="line">                sum = <span class="number">1</span>; <span class="comment">//总和就变成了1</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> startValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)636. 函数的独占时间</title>
      <link href="/2022/08/07/%E6%AF%8F%E6%97%A5LeetCode/2022-8/636%20%E5%87%BD%E6%95%B0%E7%9A%84%E7%8B%AC%E5%8D%A0%E6%97%B6%E9%97%B4/"/>
      <url>/2022/08/07/%E6%AF%8F%E6%97%A5LeetCode/2022-8/636%20%E5%87%BD%E6%95%B0%E7%9A%84%E7%8B%AC%E5%8D%A0%E6%97%B6%E9%97%B4/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>有一个 单线程 CPU 正在运行一个含有 <code>n</code> 道函数的程序。每道函数都有一个位于  <code>0</code> 和 <code>n-1</code> 之间的唯一标识符。</p><p>函数调用 存储在一个 调用栈 上 ：当一个函数调用开始时，它的标识符将会推入栈中。而当一个函数调用结束时，它的标识符将会从栈中弹出。标识符位于栈顶的函数是 <strong>当前正在执行的函数</strong> 。每当一个函数开始或者结束时，将会记录一条日志，包括函数标识符、是开始还是结束、以及相应的时间戳。</p><p>给你一个由日志组成的列表 <code>logs</code> ，其中 <code>logs[i]</code> 表示第 <code>i</code> 条日志消息，该消息是一个按<code>&quot;&#123;function_id&#125;:&#123;&quot;start&quot; | &quot;end&quot;&#125;:&#123;timestamp&#125;&quot;</code> 进行格式化的字符串。例如，<code>&quot;0:start:3&quot;</code> 意味着标识符为 0 的函数调用在时间戳 3 的 起始开始执行 ；而 <code>&quot;1:end:2&quot;</code> 意味着标识符为 <code>1</code> 的函数调用在时间戳 <code>2</code> 的 <strong>末尾结束执行</strong>。注意，函数可以 <strong>调用多次，可能存在递归调用</strong> 。</p><p>函数的 独占时间 定义是在这个函数在程序所有函数调用中执行时间的总和，调用其他函数花费的时间不算该函数的独占时间。例如，如果一个函数被调用两次，一次调用执行 <code>2</code> 单位时间，另一次调用执行 <code>1</code> 单位时间，那么该函数的 独占时间 为 <code>2 + 1 = 3</code> 。</p><p>以数组形式返回每个函数的 <strong>独占时间</strong> ，其中第 <code>i</code> 个下标对应的值表示标识符 <code>i</code> 的函数的独占时间。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2019/04/05/diag1b.png" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2019/04/05/diag1b.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 33%;" /><blockquote><p>输入：<code>n = 2, logs = [&quot;0:start:0&quot;,&quot;1:start:2&quot;,&quot;1:end:5&quot;,&quot;0:end:6&quot;]</code><br>输出：[3,4]<br>解释：<br>函数 0 在时间戳 0 的起始开始执行，执行 2 个单位时间，于时间戳 1 的末尾结束执行。<br>函数 1 在时间戳 2 的起始开始执行，执行 4 个单位时间，于时间戳 5 的末尾结束执行。<br>函数 0 在时间戳 6 的开始恢复执行，执行 1 个单位时间。<br>所以函数 0 总共执行 2 + 1 &#x3D; 3 个单位时间，函数 1 总共执行 4 个单位时间。 </p></blockquote></div><div class="story post-story"><h2 id="思路：栈"><a href="#思路：栈" class="headerlink" title="思路：栈"></a>思路：栈</h2><p>遍历logs数组</p><p>遍历到<code>status</code>为<code>start</code>时：</p><ol><li><p>将栈顶函数的运行<strong>部分时长</strong>更新，因为要运行新的函数，先暂时停止运行栈顶函数</p></li><li><p>将栈顶函数的时刻更新为现在的时刻，再入栈</p></li></ol><p><code>status</code>为<code>end</code>时：</p><ol><li>获取栈顶函数，更新运行<strong>总时长</strong>，将此函数弹出，因为已经运行完毕了</li><li>此时栈顶函数就是之前的那个函数了，要继续运行此函数，</li><li>将此函数从时刻更新为现在的时刻，因为是现在的时刻开始继续运行的</li></ol></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">exclusiveTime</span><span class="params">(<span class="type">int</span> n, vector&lt;string&gt;&amp; logs)</span> </span>&#123;</span><br><span class="line">        stack&lt;pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt;&gt; s;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">ans</span><span class="params">(n)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; log : logs)&#123;</span><br><span class="line">            <span class="type">int</span> id;</span><br><span class="line">            <span class="type">char</span> status[<span class="number">10</span>];</span><br><span class="line">            <span class="type">int</span> cur_time;</span><br><span class="line">            <span class="built_in">sscanf</span>(log.<span class="built_in">c_str</span>(), <span class="string">&quot;%d:%[^:]:%d&quot;</span>, &amp;id, status, &amp;cur_time);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(status[<span class="number">0</span>] == <span class="string">&#x27;s&#x27;</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(!s.<span class="built_in">empty</span>())&#123;</span><br><span class="line">                    ans[s.<span class="built_in">top</span>().first] += cur_time - s.<span class="built_in">top</span>().second;</span><br><span class="line">                    s.<span class="built_in">top</span>().second = cur_time;</span><br><span class="line">                &#125;</span><br><span class="line">                s.<span class="built_in">emplace</span>(id, cur_time);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">auto</span> temp = s.<span class="built_in">top</span>();</span><br><span class="line">                s.<span class="built_in">pop</span>();</span><br><span class="line">                ans[temp.first] += cur_time + <span class="number">1</span> - temp.second;</span><br><span class="line">                <span class="keyword">if</span>(!s.<span class="built_in">empty</span>())&#123;</span><br><span class="line">                    s.<span class="built_in">top</span>().second = cur_time + <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;          </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)，其中 n 为全部日志 logs 的数量，n 条日志信息对应总共 n 次入栈和出栈操作。</li><li>空间复杂度：O(n)，其中 n 为全部日志 logs 的数量，n 条日志信息对应 n&#x2F;2 次入栈操作，最坏的情况下全部 n&#x2F;2 条日志入栈后才会依次弹栈。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker容器的学习笔记</title>
      <link href="/2022/08/06/Java/Docker%E5%AE%B9%E5%99%A8/"/>
      <url>/2022/08/06/Java/Docker%E5%AE%B9%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="1-初识Docker"><a href="#1-初识Docker" class="headerlink" title="1.初识Docker"></a>1.初识Docker</h2><p>我们写好的代码会接触到好几个环境：开发环境、测试环境和生产环境</p><p><img src="https://s2.loli.net/2022/08/08/yRKLvzcD9kjVJig.png" class="lazyload" data-srcset="https://s2.loli.net/2022/08/08/yRKLvzcD9kjVJig.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="AADB6B41E3BB00CBEC2A7517863F8989"></p><p>可能导致在<strong>不同的环境下</strong>代码运行产生问题(“水土”不服)</p><p>所以就需要将<strong>代码以及运行环境</strong>装到一个<strong>容器</strong></p><p>测试只需要在容器中进行测试即可，使用的是容器中的运行环境，解决了<strong>软件跨环境迁移</strong>的问题</p><h3 id="1-1-Docker概念"><a href="#1-1-Docker概念" class="headerlink" title="1.1 Docker概念"></a>1.1 Docker概念</h3><ul><li><p>Docker是一个开源的应用容器引擎</p></li><li><p>诞生于2013年初，基于Go语言实现</p></li><li><p>Docker可以让开发者打包他们的应用以及依赖包到一个轻量级、可移值的容器中，然后发布到任何流行的Linux机器上</p></li><li><p>容器是完全使用沙箱机制，相互隔离(一台Linux机器可以启动多个容器，容器之间互不影响)</p></li><li><p>容器性能开销极低</p></li></ul><p><strong>小结：docker是一种容器技术，解决软件跨环境迁移的问题</strong></p><h3 id="1-2-Docker架构"><a href="#1-2-Docker架构" class="headerlink" title="1.2 Docker架构"></a>1.2 Docker架构</h3><img src="https://s2.loli.net/2022/08/08/eyKaI6RDYMcEnWG.png" class="lazyload" data-srcset="https://s2.loli.net/2022/08/08/eyKaI6RDYMcEnWG.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220808111802683" style="zoom: 67%;" /><ul><li>镜像(Image)：Docker镜像(image)，就相当于是一个root文件系统。比如官方镜像ubuntu:16.04包含了一个完整的一套Ubuntu 16.04最小系统的root文件系统。</li><li>容器(Container)：镜像(image)和容器(Container)的关系就像是面向对象程序设计中的类和对象一样，镜像是静态的定义，容器是镜像运行时的实体类。容器可以被创建、启动、停止、删除、暂停等操作。</li><li>仓库(Repository)：仓库看成一个代码控制中心，用来保存镜像。</li></ul><h3 id="1-3-Docker与虚拟机"><a href="#1-3-Docker与虚拟机" class="headerlink" title="1.3 Docker与虚拟机"></a>1.3 Docker与虚拟机</h3><p>容器就是将软件打包成标准化单元，以用于开发、交付和部署。</p><ul><li>容器镜像是轻量的、可执行的独立软件包，包含软件运行新需的所有内容：代码、运行时环境、系结工具、<br>系统库和设置。</li><li>容器化软件在任何环境中都能够始终如一地运行。</li><li>容器赋于了软件独立性，使其免受外在环境差异的影响，从而有助于减少团队间在相同基础设施上运行不同<br>软件时的冲突。</li></ul><p><strong>docker容器虚拟化与传统虚拟机比较</strong></p><p>相同：</p><ul><li>容器和虚拟机具有相似的资源隔离和分配优势</li></ul><p>不同：</p><ul><li>容器虛拟化的是操作系統，虛拟机虚拟化的是硬件。</li><li>传统虚拟机可以运行不同的操作系统，容器只能运行同一类型操作系统</li></ul><table><thead><tr><th align="center">特性</th><th align="center">容器</th><th align="center">虚拟机</th></tr></thead><tbody><tr><td align="center">启动</td><td align="center">秒级</td><td align="center">分钟级</td></tr><tr><td align="center">硬盘使用</td><td align="center">一般为MB</td><td align="center">一般为GB</td></tr><tr><td align="center">性能</td><td align="center">接近原生</td><td align="center">较弱</td></tr><tr><td align="center">系统支持量</td><td align="center">单机支持上千个容器</td><td align="center">一般为几十个</td></tr></tbody></table></div><div class="story post-story"><h2 id="2-Docker命令"><a href="#2-Docker命令" class="headerlink" title="2.Docker命令"></a>2.Docker命令</h2><h3 id="2-1-服务相关命令"><a href="#2-1-服务相关命令" class="headerlink" title="2.1 服务相关命令"></a>2.1 服务相关命令</h3><ul><li><p>启动docker服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure></li><li><p>停止docker服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker</span><br></pre></td></tr></table></figure></li><li><p>重启docker服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure></li><li><p>查看docker服务状态：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status docker</span><br></pre></td></tr></table></figure></li><li><p>设置开机启动docker服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-2-镜像相关命令"><a href="#2-2-镜像相关命令" class="headerlink" title="2.2 镜像相关命令"></a>2.2 镜像相关命令</h3><ul><li><p><strong>查看镜像</strong>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure><p>查看镜像所有的image id：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images -q</span><br></pre></td></tr></table></figure></li><li><p><strong>搜索镜像</strong>：</p><p>搜索redis镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search redis</span><br></pre></td></tr></table></figure></li><li><p><strong>拉取(下载)镜像</strong>：</p><p>默认下载最新版本的redis镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search redis</span><br></pre></td></tr></table></figure><p>也可以指定版本号：</p><p>下载7.0版本的redis镜像 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search redis:7.0</span><br></pre></td></tr></table></figure><p>查看版本：打开<a href="hub.docker.com">docker官网</a>，搜索redis，找到并打开官方镜像查看描述信息</p></li><li><p><strong>删除镜像</strong>：</p><p>通过image id删除镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi &lt;IMAGE ID&gt;</span><br></pre></td></tr></table></figure><p>也可以通过名称指定版本：删除7.0版本的redis镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi redis:7.0</span><br></pre></td></tr></table></figure><p>删除所有镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi &#x27;docker images -q&#x27;</span><br></pre></td></tr></table></figure><p> 删除无用镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi $(docker images -f &quot;dangling=true&quot; -q)</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-3-容器相关命令"><a href="#2-3-容器相关命令" class="headerlink" title="2.3 容器相关命令"></a>2.3 容器相关命令</h3><ul><li><p><strong>查看容器</strong>：</p><p>查看正在运行的容器：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure><p>查看所有容器：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure></li><li><p><strong>创建容器</strong>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run [参数]</span><br></pre></td></tr></table></figure><p>例子：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name=c1 centos:latest /bin/bash</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -id --name=c2 centos:latest</span><br></pre></td></tr></table></figure><p><code>-i</code>：保持容器运行</p><p><code>-t</code>：为容器重新分配一个伪终端(可与-i合并为-it)</p><p><code>-it</code>创建的容器称为交互式容器</p><p><code>-d</code>：守护(后台)模式运行容器</p><p><code>-id</code>：创建的容器称为守护式容器，需要使用<code>docker exec</code>进入容器</p><p><code>--name=c1</code>：给容器起名为c1</p><p>退出容器：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure></li><li><p><strong>进入容器</strong>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec [参数]</span><br></pre></td></tr></table></figure><p>进入c2容器：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it c2 /bin/bash</span><br></pre></td></tr></table></figure><p>以root权限进入容器：</p><p>参数 0 表示root</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -u 0 -it 容器名 /bin/bash</span><br></pre></td></tr></table></figure></li><li><p><strong>启动容器</strong>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start 容器名称</span><br></pre></td></tr></table></figure></li><li><p><strong>停止容器</strong>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop 容器名称</span><br></pre></td></tr></table></figure></li><li><p><strong>删除容器</strong>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm 容器名称</span><br></pre></td></tr></table></figure></li><li><p><strong>查看容器信息</strong>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect 容器名称</span><br></pre></td></tr></table></figure></li></ul></div><div class="story post-story"><h2 id="3-Docker容器数据卷"><a href="#3-Docker容器数据卷" class="headerlink" title="3.Docker容器数据卷"></a>3.Docker容器数据卷</h2><h3 id="3-1-数据卷概念"><a href="#3-1-数据卷概念" class="headerlink" title="3.1 数据卷概念"></a>3.1 数据卷概念</h3><ul><li><p>数据卷是宿主机中的一个目录或文件</p></li><li><p>当容器目录和数据卷目录被绑定后，双方的修改会立即同步</p></li><li><p>一个数据卷可以被多个容器同时挂载</p></li><li><p>一个容器可以被挂载多个数据卷</p></li><li><p>数据卷的作用：</p><ul><li><p>容器的持久化</p></li><li><p>外部机器和容器间接通信</p></li><li><p>容器之间数据交换</p></li></ul></li></ul><h3 id="3-2-配置数据卷"><a href="#3-2-配置数据卷" class="headerlink" title="3.2 配置数据卷"></a>3.2 配置数据卷</h3><p>创建启动容器时，使用<code>-v</code>设置数据卷</p><p><code>docker run -v 宿主机目录(或文件):容器内目录(或文件)</code></p><p>注意事项：</p><ol><li>目录必须是绝对路径</li><li>如果目录不存在，会自动创建</li><li>可以挂载多个数据卷</li></ol><p>例子：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name=c1 -v /root/data:/root/data_container centos:latest /bin/bash</span><br></pre></td></tr></table></figure><p>挂载多个数据卷：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name=c2 \</span><br><span class="line">-v /root/data1:/root/data_container1 \</span><br><span class="line">-v /root/data2:/root/data_container2 \</span><br><span class="line">centos:latest /bin/bash</span><br></pre></td></tr></table></figure><h3 id="3-3-配置数据卷容器"><a href="#3-3-配置数据卷容器" class="headerlink" title="3.3 配置数据卷容器"></a>3.3 配置数据卷容器</h3><p>多容器进行数据交换：</p><ol><li>多个容器挂载同一个数据卷</li><li>数据卷容器</li></ol><p>创建启动c3数据卷容器，使用<code>-v 参数</code>设置数据卷：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name=c3 -v /volume centos:latest /bin/bash</span><br></pre></td></tr></table></figure><p>创建启动c1、c2容器，使用<code>--volume-from 参数</code>设置数据卷：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name=c1 --volume-from c3 centos:latest /bin/bash</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name=c2 --volume-from c3 centos:latest /bin/bash</span><br></pre></td></tr></table></figure><h3 id="3-4-数据卷小结"><a href="#3-4-数据卷小结" class="headerlink" title="3.4 数据卷小结"></a>3.4 数据卷小结</h3><blockquote><ol><li><p>数据卷的概念</p><p>宿主机的一个目录或文件</p></li><li><p>数据卷的作用</p><p>容器数据持久化</p><p>客户端和容器数据交换</p><p>容器之间数据交换</p></li><li><p>数据卷容器</p><p>创建一个容器，挂载一个目录，让其他容器继承该容器</p><p>通过简单方式实现数据卷配置</p></li></ol></blockquote></div><div class="story post-story"><h2 id="4-Docker应用部署"><a href="#4-Docker应用部署" class="headerlink" title="4.Docker应用部署"></a>4.Docker应用部署</h2><p>基本步骤：</p><blockquote><p>搜索镜像</p><p>拉取镜像</p><p>创建容器</p><p>操作容器</p></blockquote><ul><li><p>容器内的网络服务和外部机器不能直接通信</p></li><li><p>外部机器和宿主机可以直接通信</p></li><li><p>宿主机和容器可以直接通信</p></li><li><p>当容器中的网络服务需要被外部机器访问时，可以将容器中提供服务的端口映射到宿主机的端口上。外部机<br>器访问宿主机的该端口，从而问接访问容器的服务。</p></li><li><p>这种操作称为：<strong>端口映射</strong></p></li></ul><h3 id="4-1-MySQL部署"><a href="#4-1-MySQL部署" class="headerlink" title="4.1 MySQL部署"></a>4.1 MySQL部署</h3><p>需求：</p><p>在Docker容器中部署MySQL，并通过外部mysql客户端操作MySQL server</p><ol><li><p>搜索镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search mysql</span><br></pre></td></tr></table></figure></li><li><p>拉取镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql</span><br></pre></td></tr></table></figure></li><li><p>创建容器，设置端口映射、目录映射</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在/root目录下创建mysql目录用于存储mysql数据信息</span></span><br><span class="line">mkdir ~/mysql</span><br><span class="line">cd ~/mysql</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -id \</span><br><span class="line">-p 3307:3306 \</span><br><span class="line">--name=c_mysql \</span><br><span class="line">-v $PWD/conf:/etc/mysql/conf.d \</span><br><span class="line">-v $PWD/data:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">mysql:latest</span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li><p><code>$PWD</code>：相当于主机目录的 &#x2F;root&#x2F;mysql</p></li><li><p><code>-p 3307:3306</code>：将容器的3306端口映射到宿主机的3306端口   <strong>端口映射</strong></p></li><li><p><code>-V $PWD/conf:/etc/mysql/conf.d</code>：将主机当前目录下的 conf&#x2F;my.cnf 挂载到容器的<br>&#x2F;etc&#x2F;mysql&#x2F;my.cnf   <strong>配置目录</strong></p></li><li><p><code>-V $PWD/logs:/logs</code>：将主机当前目录下的logs目录挂载到容器的 &#x2F;logs   <strong>日志目录</strong></p></li><li><p><code>-V $PWD/data:/var/lib/mysql</code>：将主机当前目录下的data目录挂载到容器的 &#x2F;var&#x2F;lib&#x2F;mysql   <strong>数据目录</strong></p></li><li><p><code>-e MYSOL_ROOT_PASSWORD=123456</code>：初始化root 用户的密码为123456</p></li></ul></li><li><p>操作MySQL容器</p><p>容器内连接MySQL：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it c_mysql /bin/bash</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456</span><br></pre></td></tr></table></figure><p>图形化客户端连接MySQL：</p><blockquote><p>主机：宿主机的ip</p><p>端口：为上面映射为的3307</p><p>用户名：root</p><p>密码：为上面的123456</p></blockquote></li></ol><h3 id="4-2-Tomcat部署"><a href="#4-2-Tomcat部署" class="headerlink" title="4.2 Tomcat部署"></a>4.2 Tomcat部署</h3><p>需求：</p><p>在Docker容器中部署Tomcat，并通过外部机器访问Tomcat部署的项目</p><ol><li><p>搜索Tomcat镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search tomcat</span><br></pre></td></tr></table></figure></li><li><p>拉取Tomcat镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull tomcat</span><br></pre></td></tr></table></figure></li><li><p>创建容器，设置端口映射、目录映射</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在/root目录下创建tomcat目录用于存储tomcat数据信息</span></span><br><span class="line">mkdir ~/tomcat</span><br><span class="line">cd ~/tomcat</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -id \</span><br><span class="line">--name=c_tomcat \</span><br><span class="line">-p 8080:8080 \</span><br><span class="line">-v $PWD:/usr/local/tomcat/webapps \</span><br><span class="line">tomcat:latest</span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li><code>-p 8080:8080</code>：将容器的8080端口映射到主机的8080端口</li><li><code>-v $PWD:/user/local/tomcat/webapps</code>：将主机中当前目录挂载到容器中的 &#x2F;user&#x2F;local&#x2F;tomcat&#x2F;webapps</li></ul></li><li><p>测试Tomcat</p><p>在tomcat目录下，创建test包，在test包中创建一个测试文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir test</span><br><span class="line">cd test</span><br><span class="line">vim index.html</span><br></pre></td></tr></table></figure><p>在index.html文件中写入：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span> Hello Tomcat <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure><p>保存退出：</p><p><code>Esc</code>+<code>:wq</code></p><p>使用浏览器访问Tomcat：<code>主机地址:8080/test/index.html</code></p></li></ol><h3 id="4-3-Redis部署"><a href="#4-3-Redis部署" class="headerlink" title="4.3 Redis部署"></a>4.3 Redis部署</h3><p>需求：</p><p>在Docker容器中部署Redis，并通过外部机器连接Redis</p><ol><li><p>搜索Redis镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search redis</span><br></pre></td></tr></table></figure></li><li><p>拉取Tomcat镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull redis</span><br></pre></td></tr></table></figure></li><li><p>创建容器，设置端口映射</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -id \</span><br><span class="line">-p 6379:6379 \</span><br><span class="line">--name=c_redis \</span><br><span class="line">redis:latest</span><br></pre></td></tr></table></figure></li><li><p>图形化客户端连接redis</p><blockquote><p>主机地址：宿主机的ip</p><p>端口：为6379</p></blockquote></li></ol><h3 id="4-4-Nginx部署"><a href="#4-4-Nginx部署" class="headerlink" title="4.4 Nginx部署"></a>4.4 Nginx部署</h3><p>需求：</p><p>在Docker容器中部署Nginx，并通过外部机器访问Nginx</p><ol><li><p>搜索Nginx镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search nginx</span><br></pre></td></tr></table></figure></li><li><p>拉取Nginx镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure></li><li><p>部署Nginx</p><p>在&#x2F;root目录下创建nginx目录用于存储nginx数据信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/nginx</span><br><span class="line">cd ~/nginx</span><br></pre></td></tr></table></figure><p>在~&#x2F;nginx&#x2F;conf&#x2F;下创建nginx.conf文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir conf</span><br><span class="line">cd conf</span><br><span class="line">vim nginx.conf</span><br></pre></td></tr></table></figure><p>在nginx.conf中写入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回到nginx目录：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd ..</span><br></pre></td></tr></table></figure><p>创建容器，设置端口映射、目录映射：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -id \</span><br><span class="line">--name=c_nginx \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-v $PWD/conf/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">-v $PWD/logs:/var/log/nginx \</span><br><span class="line">-v $PWD/html:/usr/share/nginx/html \</span><br><span class="line">nginx:latest</span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li><code>-p 80:80</code>：将容器的80端口映射到宿主机的 80 端口</li><li><code>-v $PWD/conf/nginx.conf:/etc/nginx/nginx.conf</code>：将主机当前目录下的&#x2F;conf&#x2F;nginx.conf 挂载到容器的：&#x2F;etc&#x2F;nginx&#x2F;nginx.conf   <strong>配置目录</strong></li><li><code>-v $PWD/logs:/var/log/nginx</code>：将主机当前目录下的 logs 目录挂载到容器的&#x2F;var&#x2F;log&#x2F;nginx   <strong>日志目录</strong></li></ul></li><li><p>使用浏览器访问nginx</p><p>创建nginx&#x2F;html&#x2F;test&#x2F;index.html文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd html</span><br><span class="line">mkdir test</span><br><span class="line">cd test</span><br><span class="line">vim index.html</span><br></pre></td></tr></table></figure><p>写入下面内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span> Hello Nginx <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure><p>浏览器访问：<code>主机地址/test/index.html</code></p></li></ol></div><div class="story post-story"><h2 id="5-DockerFile"><a href="#5-DockerFile" class="headerlink" title="5.DockerFile"></a>5.DockerFile</h2><h3 id="5-1-Docker镜像原理"><a href="#5-1-Docker镜像原理" class="headerlink" title="5.1 Docker镜像原理"></a>5.1 Docker镜像原理</h3><blockquote><p>操作系统组成部分：</p><ul><li>进程调度子系统</li><li>进程通信子系統</li><li>内存管理子系统</li><li>设备管理子系统</li><li><span style="color:red">文件管理子系统</span></li><li>网络通信子系统</li><li>作业控制子系统</li></ul><p>Linux文件系统由bootfs和rootfs两部分组成：</p><ul><li>bootfs：包含bootloader(引导加载程序)和kernel(内核）</li><li>rootfs：root文件系统，包含的就是典型Linux 系统中的&#x2F;dev、&#x2F;proc、&#x2F;bin、&#x2F;etc等标准目录和文件</li><li>不同的linux发行版，bootfs基本一样，而rootis不同。如ubuntu、centos等</li></ul></blockquote><p>Docker镜像原理：</p><ul><li><p>Docker镜像是由特殊的文件系统叠加而成</p></li><li><p>最底端是bootfs， 并使用宿主机的bootfs</p></li><li><p>第二层是root文件系统rootfs称为base image(基础镜像)</p></li><li><p>然后再往上可以叠加其他的镜像文件</p></li><li><p>统一文件系统 (Union File System）技术能够将不同的层整合成一个文件系统，为这些层提供了一个统一的视角，迹样就隐藏了多层的存在，在用户的角度看来，只存在一个文件系统。</p></li><li><p>一个镜像可以放在另一个镜像的上面。位于下面的镜像称为父镜像，最底部的镜像成为基础镜像。</p></li><li><p>当一个镜像启动容器时，Docker会在最底层加载一个读写文件系统作为容器</p></li><li><p>这样分层的好处就是<span style="color:red">复用</span></p></li></ul><img src="https://s2.loli.net/2022/08/12/yJsdAp5eOKuFraG.png" class="lazyload" data-srcset="https://s2.loli.net/2022/08/12/yJsdAp5eOKuFraG.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220812225117535" style="zoom: 50%;" /><p>总结：</p><ol><li><p>Docker镜像的本质是什么?</p><p>一个分层文件系统</p></li><li><p>centos镜像只有200MB，而一个centos的操作系统的iso文件要几个G？</p><p>centos的镜像文件包含bootfs和rootfs，而docker的centos镜像复用了操作系统(就是宿主机)的bootfs，只有rootfs和其他镜像层</p></li><li><p>Docker中一个tomcat镜像为什么有500MB，而—个tomcat安装包只有70多MB?</p><p>由于docker中镜像是分层的，tomcat虽然只有70多MB，但他需要依赖于父镜像和基础镜像，所有整个对外暴露的tomcat镜像加起来大小500多MB</p></li></ol><h3 id="5-2-容器转镜像"><a href="#5-2-容器转镜像" class="headerlink" title="5.2 容器转镜像"></a>5.2 容器转镜像</h3><p>容器转镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit [容器id] [新的镜像名称]:[自定义版本号]</span><br></pre></td></tr></table></figure><p>镜像转压缩文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save -o [自定义压缩文件名称.tar] [镜像名称]:[自定义版本号]</span><br></pre></td></tr></table></figure><p>压缩文件转镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i [压缩文件]</span><br></pre></td></tr></table></figure><h3 id="5-3-DockerFile概念"><a href="#5-3-DockerFile概念" class="headerlink" title="5.3 DockerFile概念"></a>5.3 DockerFile概念</h3><ul><li>DockerFile是一个文本系统</li><li>包含了一条条的指令</li><li>每条指令构建一层，基于基础镜像，最终构建出一个新的镜像</li><li>可以为开发团队提高一个完全一致的开发环境</li><li>在部署时，可以实现应用的无缝移植</li></ul><p>例如：</p><p><a href="https://github.com/CentOS/sig-cloud-instance-images/blob/b2d195220e1c5b181427c3172829c23ab9cd27eb/docker/Dockerfile">centos7的dockerfile</a></p><p><a href="https://github.com/nginxinc/docker-nginx/blob/f3d86e99ba2db5d9918ede7b094fcad7b9128cd8/mainline/debian/Dockerfile">nginx的dockerfile</a></p><h3 id="5-4-DockerFile的关键字"><a href="#5-4-DockerFile的关键字" class="headerlink" title="5.4 DockerFile的关键字"></a>5.4 DockerFile的关键字</h3><table><thead><tr><th align="center">关键字</th><th align="center">作用</th></tr></thead><tbody><tr><td align="center">FROM</td><td align="center">指定父镜像</td></tr><tr><td align="center">MAINTAINER</td><td align="center">作者信息</td></tr><tr><td align="center">LABEL</td><td align="center">标签</td></tr><tr><td align="center">RUN</td><td align="center">执行命令</td></tr><tr><td align="center">CMD</td><td align="center">容器启动命令</td></tr><tr><td align="center">ENTRYPOINT</td><td align="center">入口</td></tr><tr><td align="center">COPY</td><td align="center">复制文件</td></tr><tr><td align="center">ADD</td><td align="center">添加文件</td></tr><tr><td align="center">ENV</td><td align="center">环境变量</td></tr><tr><td align="center">ARG</td><td align="center">构建参数</td></tr><tr><td align="center">VOLUME</td><td align="center">定义外部可以挂载的数据卷</td></tr><tr><td align="center">EXPOSE</td><td align="center">暴露端口</td></tr><tr><td align="center">WORKDIR</td><td align="center">工作目录</td></tr><tr><td align="center">USER</td><td align="center">指定执行用户</td></tr><tr><td align="center">HEALTHCHECK</td><td align="center">健康检查</td></tr><tr><td align="center">ONBUILD</td><td align="center">触发器</td></tr><tr><td align="center">STOPSIGNAL</td><td align="center">发送信息量到宿主机</td></tr><tr><td align="center">SHELL</td><td align="center">执行执行脚本shell</td></tr></tbody></table><h3 id="5-5-部署SpringBoot项目"><a href="#5-5-部署SpringBoot项目" class="headerlink" title="5.5 部署SpringBoot项目"></a>5.5 部署SpringBoot项目</h3><p>需求：</p><p>定义dockerfile，发布springboot项目</p><p>实现步骤：</p><ol><li><p>定义父镜像</p></li><li><p>定义作者信息</p></li><li><p>将jar包添加到容器</p></li><li><p>定义容器启动执行的命令</p></li><li><p>通过dockerfile构建镜像</p></li><li><p>创建目录：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/docker-files</span><br><span class="line">cd ~/docker-files</span><br></pre></td></tr></table></figure></li><li><p>将打包好的SpringBoot项目上传到~&#x2F;docker-files目录下</p><p>注意：SpringBoot项目也要为java8版本</p></li><li><p>在docker-files目录编写springboot_dockerfile：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim springboot_dockerfile</span><br></pre></td></tr></table></figure><p>写入下面的内容：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> Ai</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> springboot-demo-0.0.1-SNAPSHOT.jar app.jar</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> java -jar app.jar</span></span><br></pre></td></tr></table></figure></li><li><p>保存退出，将jar包转换为镜像：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -f ./springboot_dockerfile -t app .</span><br></pre></td></tr></table></figure></li><li><p>测试</p><p>创建容器：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -id --name=c_app -p 8080:8080 app:latest</span><br></pre></td></tr></table></figure><p>浏览器访问：<code>主机地址:8080/hello</code></p></li></ol><h3 id="5-6-自定义Centos"><a href="#5-6-自定义Centos" class="headerlink" title="5.6 自定义Centos"></a>5.6 自定义Centos</h3><p>需求：</p><p>自定义centos:7镜像，要求：</p><blockquote><ol><li>默认登录路径为&#x2F;usr</li><li>可以使用vim</li></ol></blockquote><p>实现步骤：</p><ol><li><p>定义父镜像</p></li><li><p>定义作者信息</p></li><li><p>执行安装vim命令</p></li><li><p>定义默认的工作目录</p></li><li><p>定义容器启动执行的命令</p></li><li><p>转到~&#x2F;docker-files目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd ~/docker-files</span><br></pre></td></tr></table></figure></li><li><p>编写centos7_dockerfile</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim centos7_dockerfile</span><br></pre></td></tr></table></figure><p>写入下面内容：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> Ai</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y vim</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> /bin/bash</span></span><br></pre></td></tr></table></figure><p>保存退出</p></li><li><p>创建自定义centos7镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -f ./centos7_dockerfile -t my_centos:1 .</span><br></pre></td></tr></table></figure></li></ol></div><div class="story post-story"><h2 id="6-Docker服务编排"><a href="#6-Docker服务编排" class="headerlink" title="6.Docker服务编排"></a>6.Docker服务编排</h2><h3 id="6-1-Docker-Compose概述"><a href="#6-1-Docker-Compose概述" class="headerlink" title="6.1 Docker Compose概述"></a>6.1 Docker Compose概述</h3><p>微服务架构的应用系统中一般包含若干个微服务，每个微服务一般都会部署多个实例，如果每个微服务都要手动启停，维护的工作量会很大。</p><ul><li>要从Dockerfile build image 或者去dockerhub拉取image</li><li>要创建多个container</li><li>要管理这些container(启动停止删除)</li></ul><p>服务编排：按照一定的业务规则批量管理容器</p><p>Docker Compose是一个编排多容器分布式部署的工具，提供命令集管理容器化应用的完整开发周期，包括服务构建、启动和停止。使用步骤：</p><blockquote><ol><li>利用 Dockerfile 定义运行环境镜像</li><li>使用 docker-compose.yml定义组成应用的各服务</li><li>运行 docker-compose up 启动应用</li></ol></blockquote><h3 id="6-2-Docker-Compose安装"><a href="#6-2-Docker-Compose安装" class="headerlink" title="6.2 Docker Compose安装"></a>6.2 Docker Compose安装</h3><p>在安装docker-compose之前要安装docker，以二进制包的方式安装在Linux中：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://get.daocloud.io/docker/compose/releases/download/v2.9.0/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><p>设置可执行权限：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><p>查看版本信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -v</span><br></pre></td></tr></table></figure><p>docker-compose的卸载，删除二进制文件即可：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><h3 id="6-3-编排Nginx-SpringBoot项目"><a href="#6-3-编排Nginx-SpringBoot项目" class="headerlink" title="6.3 编排Nginx+SpringBoot项目"></a>6.3 编排Nginx+SpringBoot项目</h3><ol><li><p>创建目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/docker-compose</span><br><span class="line">cd ~/docker-compose</span><br><span class="line">vim docker-compose.yml </span><br></pre></td></tr></table></figure></li><li><p>编写docker-compose.yml文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>创建.&#x2F;nginx&#x2F;conf.d目录下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ./nginx/conf.d</span><br><span class="line">cd ./nginx/conf.d</span><br><span class="line">vim my.conf</span><br></pre></td></tr></table></figure></li><li><p>编写my.conf文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">access_log off;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_pass http://app:8080;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在~&#x2F;docker-compose目录下使用docker-compose启动容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure></li><li><p>测试</p><p>使用浏览器访问：<code>主机地址:80/hello</code></p></li></ol></div><div class="story post-story"><h2 id="7-Docker私有仓库"><a href="#7-Docker私有仓库" class="headerlink" title="7.Docker私有仓库"></a>7.Docker私有仓库</h2><p><strong>Docker私有仓库</strong>：</p><p>Docker官方的<a href="https://hub.docker.com/">Docker hub</a>是一个用于管理公共镜像的仓库，我们可以从上面拉取镜像到本地，也可以把我们自己的镜像推送上去。但是，有时候我们的服务器无法访问互联网，或者你不希望将自己的镜像放到公网当中，那么我们就需要搭建自己的私有仓库来存储和管理自己的镜像。</p><h3 id="7-1-搭建私有仓库"><a href="#7-1-搭建私有仓库" class="headerlink" title="7.1 搭建私有仓库"></a>7.1 搭建私有仓库</h3><ol><li><p>拉取私有仓库镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry</span><br></pre></td></tr></table></figure></li><li><p>启动私有仓库容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -id --name=registry -p 5000:5000 registry</span><br></pre></td></tr></table></figure></li><li><p>打开浏览器，输入地址<code>https://私有仓库服务器ip:5000/v2/_catalog</code></p><p>如果看到<code>&#123;&quot;repositories&quot;:[]&#125;</code>表示私有仓库搭建成功</p></li><li><p>修改deamon.json</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure><p>在deamon.json中添加一个key，让docker信任私有仓库地址，<strong>添加</strong>下面内容：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;私有仓库服务器ip:5000&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>重启docker服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure></li><li><p>启动registry容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start registry</span><br></pre></td></tr></table></figure></li></ol><h3 id="7-2-上传镜像到私有仓库"><a href="#7-2-上传镜像到私有仓库" class="headerlink" title="7.2 上传镜像到私有仓库"></a>7.2 上传镜像到私有仓库</h3><p>上传<code>centos:7</code>为例：</p><ol><li><p>标记镜像为私有仓库的镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag centos:7 私有仓库地址ip:5000/centos:7</span><br></pre></td></tr></table></figure></li><li><p>上传标记的镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push 私有仓库地址ip:5000/centos:7</span><br></pre></td></tr></table></figure></li></ol><p>注意：要启动registry容器，才可以上传到私有仓库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start registry </span><br></pre></td></tr></table></figure><h3 id="7-3-从私有仓库拉取镜像"><a href="#7-3-从私有仓库拉取镜像" class="headerlink" title="7.3 从私有仓库拉取镜像"></a>7.3 从私有仓库拉取镜像</h3><p>拉取<code>centos:7</code>为例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dokcer pull 私有仓库地址ip:5000/centos:7</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 容器 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据结构的学习笔记</title>
      <link href="/2022/08/06/%E8%AE%A1%E7%AE%97%E6%9C%BA4%E4%BB%B6%E5%A5%97/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
      <url>/2022/08/06/%E8%AE%A1%E7%AE%97%E6%9C%BA4%E4%BB%B6%E5%A5%97/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="0-排序"><a href="#0-排序" class="headerlink" title="0.排序"></a>0.排序</h2><h3 id="0-1-冒泡排序"><a href="#0-1-冒泡排序" class="headerlink" title="0.1 冒泡排序"></a>0.1 冒泡排序</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bubble</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span> = less&lt;&gt;&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="built_in">sort</span>(vector&lt;T&gt;&amp; v)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = v.<span class="built_in">size</span>() - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; i; j++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">compare</span>()(v[j], v[j + <span class="number">1</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">swap</span>(v[j], v[j + <span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>时间复杂度：O(n^2)</li></ul><h3 id="0-2-选择排序"><a href="#0-2-选择排序" class="headerlink" title="0.2 选择排序"></a>0.2 选择排序</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Selection</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span> = less&lt;&gt;&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="built_in">sort</span>(vector&lt;T&gt;&amp; v)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; v.<span class="built_in">size</span>(); i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> temp = i;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = i + <span class="number">1</span>; j &lt; v.<span class="built_in">size</span>(); j++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">compare</span>()(v[temp], v[j]))</span><br><span class="line">temp = j;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">swap</span>(v[i], v[temp]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>时间复杂度：O(n^2)</li></ul><h3 id="0-3-插入排序"><a href="#0-3-插入排序" class="headerlink" title="0.3 插入排序"></a>0.3 插入排序</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Insertion</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span> = less&lt;&gt;&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="built_in">sort</span>(vector&lt;T&gt;&amp; v)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; v.<span class="built_in">size</span>(); i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = i; j &gt; <span class="number">0</span>; j--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">compare</span>()(v[j - <span class="number">1</span>], v[j]))</span><br><span class="line"><span class="built_in">swap</span>(v[j - <span class="number">1</span>], v[j]);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>时间复杂度：O(n^2)</li></ul><h3 id="0-4-希尔排序"><a href="#0-4-希尔排序" class="headerlink" title="0.4 希尔排序"></a>0.4 希尔排序</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Shell</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span> = less&lt;&gt;&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="built_in">sort</span>(vector&lt;T&gt;&amp; v)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> h = v.<span class="built_in">size</span>() / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">while</span> (h &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = h; i &lt; v.<span class="built_in">size</span>(); i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = i; j &gt;= h; j -= h)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">compare</span>()(v[j - h], v[j]))</span><br><span class="line"><span class="built_in">swap</span>(v[j - h], v[j]);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">h = h &gt;&gt; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>时间复杂度为O(logn)~O(n^2)</li></ul><h3 id="0-5-归并排序"><a href="#0-5-归并排序" class="headerlink" title="0.5 归并排序"></a>0.5 归并排序</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Merge</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">sort</span><span class="params">(vector&lt;T&gt;&amp; v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">sort</span>(v, <span class="number">0</span>, v.<span class="built_in">size</span>() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">sort</span><span class="params">(vector&lt;T&gt;&amp; v, <span class="type">int</span> left, <span class="type">int</span> right)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (left &gt;= right) </span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> mid = (left + right) / <span class="number">2</span>;</span><br><span class="line"><span class="built_in">sort</span>(v, left, mid);</span><br><span class="line"><span class="built_in">sort</span>(v, mid + <span class="number">1</span>, right);</span><br><span class="line"></span><br><span class="line"><span class="built_in">merge</span>(v, left, mid, right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span> = less&lt;&gt;&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="built_in">merge</span>(vector&lt;T&gt;&amp; v, <span class="type">int</span> left, <span class="type">int</span> mid, <span class="type">int</span> right)</span><br><span class="line">&#123;</span><br><span class="line">vector&lt;T&gt; temp;</span><br><span class="line"><span class="type">int</span> L = left;</span><br><span class="line"><span class="type">int</span> R = mid + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (L &lt;= mid &amp;&amp; R &lt;= right)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">compare</span>()(v[L], v[R]))</span><br><span class="line">temp.<span class="built_in">emplace_back</span>(v[L++]);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">temp.<span class="built_in">emplace_back</span>(v[R++]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (L &lt;= mid)</span><br><span class="line">temp.<span class="built_in">emplace_back</span>(v[L++]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (R &lt;= right)</span><br><span class="line">temp.<span class="built_in">emplace_back</span>(v[R++]);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (pos &lt; temp.<span class="built_in">size</span>())</span><br><span class="line">v[left++] = temp[pos++];</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="0-6-快速排序"><a href="#0-6-快速排序" class="headerlink" title="0.6 快速排序"></a>0.6 快速排序</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Insertion</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">sort</span><span class="params">(vector&lt;T&gt;&amp; v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">sort</span>(v, <span class="number">0</span>, v.<span class="built_in">size</span>() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span> = less&lt;&gt;&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="built_in">sort</span>(vector&lt;T&gt;&amp; v, <span class="type">int</span> left, <span class="type">int</span> right)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (left &gt;= right)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">T key = v[left];</span><br><span class="line"><span class="type">int</span> L = left;</span><br><span class="line"><span class="type">int</span> R = right;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (L &lt; R)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//必须要先走R指针在走L指针</span></span><br><span class="line"><span class="comment">//找到比key值小的元素的位置</span></span><br><span class="line"><span class="keyword">while</span> (!<span class="built_in">compare</span>()(v[R], key) &amp;&amp; L &lt; R)</span><br><span class="line">R--;</span><br><span class="line"><span class="comment">//找到比key值大的元素的位置</span></span><br><span class="line"><span class="keyword">while</span> (!<span class="built_in">compare</span>()(key, v[L]) &amp;&amp; L &lt; R)</span><br><span class="line">L++;</span><br><span class="line"><span class="keyword">if</span> (L &lt; R)</span><br><span class="line"><span class="built_in">swap</span>(v[L], v[R]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">v[left] = v[L];</span><br><span class="line">v[L] = key;</span><br><span class="line"></span><br><span class="line"><span class="built_in">sort</span>(v, left, L - <span class="number">1</span>);</span><br><span class="line"><span class="built_in">sort</span>(v, L + <span class="number">1</span>, right);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>由于使用了类模板，导致测试时，导入头文件，例如：<code>#include&quot;ArrayList.h&quot;</code>，会报错。</p><p>所以改用导入源文件，例如：<code>#include&quot;ArrayList.cpp&quot;</code>，这样就能成功运行了！</p></div><div class="story post-story"><h2 id="1-线性表"><a href="#1-线性表" class="headerlink" title="1.线性表"></a>1.线性表</h2><h3 id="1-1-顺序表-动态数组"><a href="#1-1-顺序表-动态数组" class="headerlink" title="1.1 顺序表(动态数组)"></a>1.1 顺序表(动态数组)</h3><p>Cpp实现，顺序表的基本实现</p><p>头文件<code>ArrayList.h</code>：</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line">template &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">private:</span><br><span class="line">T* arrayList;                  <span class="comment">// 存储元素的数组</span></span><br><span class="line"><span class="type">int</span> size;                      <span class="comment">// 数组的大小 </span></span><br><span class="line">    <span class="type">int</span> capacity;                  <span class="comment">// 数组的容量</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">resize</span><span class="params">(<span class="type">int</span> newCapacity)</span>;  <span class="comment">// 重新设置容量</span></span><br><span class="line">public:</span><br><span class="line">ArrayList(<span class="type">int</span> capacity);    <span class="comment">// 构造函数，初始化容量</span></span><br><span class="line">~ArrayList();                  <span class="comment">// 析构函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">clear</span><span class="params">()</span>;    <span class="comment">// 清空数组</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">isEmpty</span><span class="params">()</span>;    <span class="comment">// 数组是否为空</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">length</span><span class="params">()</span>;    <span class="comment">// 获取数组的长度</span></span><br><span class="line">T <span class="title function_">get</span><span class="params">(<span class="type">int</span> pos)</span>;                <span class="comment">// 获取该位置的元素</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">insert</span><span class="params">(T val)</span>;            <span class="comment">// 在数组末尾插入元素</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">insert</span><span class="params">(<span class="type">int</span> pos, T val)</span>;   <span class="comment">// 指定数组中的位置插入元素</span></span><br><span class="line">T <span class="title function_">remove</span><span class="params">(<span class="type">int</span> pos)</span>;             <span class="comment">// 删除该位置的元素并返回该元素</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">indexOf</span><span class="params">(T val)</span>;            <span class="comment">// 根据元素值查找最小索引的位置，没有返回-1</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件<code>ArrayList.cpp</code>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;ArrayList.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">ArrayList&lt;T&gt;::<span class="built_in">ArrayList</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;capacity = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = <span class="keyword">new</span> T[<span class="keyword">this</span>-&gt;capacity];</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">ArrayList&lt;T&gt;::<span class="built_in">ArrayList</span>(<span class="type">int</span> capacity)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;capacity = capacity;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = <span class="keyword">new</span> T[<span class="keyword">this</span>-&gt;capacity];</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">ArrayList&lt;T&gt;::~<span class="built_in">ArrayList</span>() &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;arrayList != <span class="literal">nullptr</span>)&#123;</span><br><span class="line"><span class="keyword">delete</span>[] <span class="keyword">this</span>-&gt;arrayList;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> ArrayList&lt;T&gt;::<span class="built_in">clear</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">bool</span> ArrayList&lt;T&gt;::<span class="built_in">isEmpty</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;arrayList == <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">int</span> ArrayList&lt;T&gt;::<span class="built_in">length</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T ArrayList&lt;T&gt;::<span class="built_in">get</span>(<span class="type">int</span> pos)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (pos &lt;<span class="number">0</span> || pos &gt;= <span class="keyword">this</span>-&gt;size) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line">    </span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;arrayList[pos];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> ArrayList&lt;T&gt;::<span class="built_in">insert</span>(T val)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;size == <span class="keyword">this</span>-&gt;capacity)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">resize</span>(<span class="keyword">this</span>-&gt;capacity * <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList[<span class="keyword">this</span>-&gt;size] = val;</span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> ArrayList&lt;T&gt;::<span class="built_in">insert</span>(<span class="type">int</span> pos, T val)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;size == <span class="keyword">this</span>-&gt;capacity)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">resize</span>(<span class="keyword">this</span>-&gt;capacity * <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="keyword">this</span>-&gt;size - <span class="number">1</span>; i &gt;= pos ; i--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList[i + <span class="number">1</span>] = <span class="keyword">this</span>-&gt;arrayList[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList[pos] = val;</span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T ArrayList&lt;T&gt;::<span class="built_in">remove</span>(<span class="type">int</span> pos)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (pos &lt;<span class="number">0</span> || pos &gt;= <span class="keyword">this</span>-&gt;size) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line">    </span><br><span class="line">T val = <span class="keyword">this</span>-&gt;arrayList[pos];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = pos; i &lt; <span class="keyword">this</span>-&gt;size; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList[i] = <span class="keyword">this</span>-&gt;arrayList[i + <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>-&gt;size--;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;size &lt; <span class="keyword">this</span>-&gt;capacity / <span class="number">4</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">resize</span>(<span class="keyword">this</span>-&gt;capacity / <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">int</span> ArrayList&lt;T&gt;::<span class="built_in">indexOf</span>(T val)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>-&gt;size; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;arrayList[i] == val)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> ArrayList&lt;T&gt;::<span class="built_in">resize</span>(<span class="type">int</span> newCapacity)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;capacity = newCapacity;</span><br><span class="line">T* temp = <span class="keyword">new</span> T[<span class="keyword">this</span>-&gt;capacity];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>-&gt;size; i++)</span><br><span class="line">&#123;</span><br><span class="line">temp[i] = <span class="keyword">this</span>-&gt;arrayList[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">delete</span>[] <span class="keyword">this</span>-&gt;arrayList;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>部分测试<code>main.cpp</code>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;ArrayList.cpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="function">ArrayList <span class="title">a</span><span class="params">(<span class="number">3</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">a.<span class="built_in">insert</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; a.<span class="built_in">isEmpty</span>() &lt;&lt; endl;</span><br><span class="line">cout &lt;&lt; a.<span class="built_in">remove</span>(<span class="number">1</span>) &lt;&lt; endl;</span><br><span class="line">cout &lt;&lt; a.<span class="built_in">indexOf</span>(<span class="number">1</span>) &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; a.<span class="built_in">length</span>(); i++)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; a.<span class="built_in">get</span>(i) &lt;&lt; <span class="string">&quot;  &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-单向链表"><a href="#1-2-单向链表" class="headerlink" title="1.2 单向链表"></a>1.2 单向链表</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span>  <span class="title class_">LinkedList</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">T data;</span><br><span class="line">Node* next;</span><br><span class="line"><span class="built_in">Node</span>() &#123;&#125;</span><br><span class="line">        <span class="built_in">Node</span>(Node* next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Node</span>(T data, Node* next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;data = data;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">Node* head;</span><br><span class="line"><span class="type">int</span> size;</span><br><span class="line">    <span class="function">Node* <span class="title">reverse</span><span class="params">(Node* curr)</span></span>; <span class="comment">// 当前节点实现反转</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">LinkedList</span>();</span><br><span class="line">~<span class="built_in">LinkedList</span>();</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">length</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">T <span class="title">get</span><span class="params">(<span class="type">int</span> pos)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(T data)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(<span class="type">int</span> pos, T data)</span></span>;</span><br><span class="line"><span class="function">T <span class="title">remove</span><span class="params">(<span class="type">int</span> pos)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">indexOf</span><span class="params">(T data)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reverse</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">getMid</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;LinkedList.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> LinkedList&lt;T&gt;::Node* LinkedList&lt;T&gt;::<span class="built_in">reverse</span>(Node* curr)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (curr-&gt;next == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;head-&gt;next = curr;</span><br><span class="line"><span class="keyword">return</span> curr;</span><br><span class="line">&#125;</span><br><span class="line">Node* p = <span class="built_in">reverse</span>(curr-&gt;next);</span><br><span class="line">p-&gt;next = curr;</span><br><span class="line">curr-&gt;next = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">return</span> curr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">LinkedList&lt;T&gt;::<span class="built_in">LinkedList</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="keyword">new</span> <span class="built_in">Node</span>(<span class="literal">nullptr</span>);</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">LinkedList&lt;T&gt;::~<span class="built_in">LinkedList</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;head == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">clear</span>();</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> LinkedList&lt;T&gt;::<span class="built_in">clear</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;head == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">Node* newNode = p-&gt;next;</span><br><span class="line"><span class="keyword">delete</span> p;</span><br><span class="line">p = newNode;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>-&gt;head-&gt;next = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">bool</span> LinkedList&lt;T&gt;::<span class="built_in">isEmpty</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">int</span> LinkedList&lt;T&gt;::<span class="built_in">length</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T LinkedList&lt;T&gt;::<span class="built_in">get</span>(<span class="type">int</span> pos)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (pos &lt; <span class="number">0</span> || pos &gt;= <span class="keyword">this</span>-&gt;size) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line"></span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pos; i++)</span><br><span class="line">&#123;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> p-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> LinkedList&lt;T&gt;::<span class="built_in">insert</span>(T data)</span><br><span class="line">&#123;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">while</span> (p-&gt;next != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Node* newNode = <span class="keyword">new</span> <span class="built_in">Node</span>(data, <span class="literal">nullptr</span>);</span><br><span class="line">p-&gt;next = newNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> LinkedList&lt;T&gt;::<span class="built_in">insert</span>(<span class="type">int</span> pos, T data)</span><br><span class="line">&#123;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pos; i++)</span><br><span class="line">&#123;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Node* newNode = <span class="keyword">new</span> <span class="built_in">Node</span>(data, p-&gt;next);</span><br><span class="line">p-&gt;next = newNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T LinkedList&lt;T&gt;::<span class="built_in">remove</span>(<span class="type">int</span> pos)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (pos &lt; <span class="number">0</span> || pos &gt;= <span class="keyword">this</span>-&gt;size) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line"></span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pos; i++)</span><br><span class="line">&#123;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line">Node* e = p-&gt;next;</span><br><span class="line">p-&gt;next = e-&gt;next;</span><br><span class="line"></span><br><span class="line">T res = e-&gt;data;</span><br><span class="line"><span class="keyword">delete</span> e;</span><br><span class="line">e = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;size--;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">int</span> LinkedList&lt;T&gt;::<span class="built_in">indexOf</span>(T data)</span><br><span class="line">&#123;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (p-&gt;data == data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> pos;</span><br><span class="line">&#125;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">pos++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> LinkedList&lt;T&gt;::<span class="built_in">reverse</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;size &lt; <span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">reverse</span>(<span class="keyword">this</span>-&gt;head-&gt;next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T LinkedList&lt;T&gt;::<span class="built_in">getMid</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;head-&gt;next == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line"></span><br><span class="line">Node* fast = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line">Node* slow = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (fast != <span class="literal">nullptr</span> &amp;&amp; fast-&gt;next != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">fast = fast-&gt;next-&gt;next;</span><br><span class="line">slow = slow-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> slow-&gt;data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;LinkedList.cpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">LinkedList&lt;<span class="type">int</span>&gt; list;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">list.<span class="built_in">insert</span>(i);</span><br><span class="line">&#125;</span><br><span class="line">list.<span class="built_in">insert</span>(<span class="number">2</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; list.<span class="built_in">isEmpty</span>() &lt;&lt; endl;</span><br><span class="line">cout &lt;&lt; list.<span class="built_in">remove</span>(<span class="number">5</span>) &lt;&lt; endl;</span><br><span class="line">cout &lt;&lt; list.<span class="built_in">indexOf</span>(<span class="number">5</span>) &lt;&lt; endl;</span><br><span class="line"><span class="comment">//list.clear();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; list.<span class="built_in">length</span>(); i++)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; list.<span class="built_in">get</span>(i) &lt;&lt; <span class="string">&quot;  &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-3-双向链表"><a href="#1-3-双向链表" class="headerlink" title="1.3 双向链表"></a>1.3 双向链表</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DoubleLinkedList</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">T data;</span><br><span class="line">Node* pre;</span><br><span class="line">Node* next;</span><br><span class="line"><span class="built_in">Node</span>() &#123;&#125;</span><br><span class="line">        <span class="built_in">Node</span>(Node* pre, Node* next)</span><br><span class="line">&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;pre = pre;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Node</span>(Node* pre, T data, Node* next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;pre = pre;</span><br><span class="line"><span class="keyword">this</span>-&gt;data = data;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">Node* head;</span><br><span class="line">Node* last;</span><br><span class="line"><span class="type">int</span> size;</span><br><span class="line"><span class="function">Node* <span class="title">getNode</span><span class="params">(<span class="type">int</span> pos)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">DoubleLinkedList</span>();</span><br><span class="line">~<span class="built_in">DoubleLinkedList</span>();</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">length</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">T <span class="title">get</span><span class="params">(<span class="type">int</span> pos)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(T data)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(<span class="type">int</span> pos, T data)</span></span>;</span><br><span class="line"><span class="function">T <span class="title">remove</span><span class="params">(<span class="type">int</span> pos)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">indexOf</span><span class="params">(T data)</span></span>;</span><br><span class="line"><span class="function">T <span class="title">getFirst</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">T <span class="title">getLast</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;DoubleLinkedList.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> DoubleLinkedList&lt;T&gt;::Node* DoubleLinkedList&lt;T&gt;::<span class="built_in">getNode</span>(<span class="type">int</span> pos)</span><br><span class="line">&#123;</span><br><span class="line">Node* p;</span><br><span class="line"><span class="comment">//从前往后遍历</span></span><br><span class="line"><span class="keyword">if</span> (pos &lt; <span class="built_in">int</span>(<span class="keyword">this</span>-&gt;size / <span class="number">2</span>))</span><br><span class="line">&#123;</span><br><span class="line">p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pos; i++)</span><br><span class="line">&#123;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//从后往前遍历</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">p = <span class="keyword">this</span>-&gt;last;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pos; i++)</span><br><span class="line">&#123;</span><br><span class="line">p = p-&gt;pre;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">DoubleLinkedList&lt;T&gt;::<span class="built_in">DoubleLinkedList</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="keyword">new</span> <span class="built_in">Node</span>(<span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="keyword">this</span>-&gt;last = <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">DoubleLinkedList&lt;T&gt;::~<span class="built_in">DoubleLinkedList</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;head == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;last = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> DoubleLinkedList&lt;T&gt;::<span class="built_in">clear</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;head == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">Node* newNode = p-&gt;next;</span><br><span class="line"><span class="keyword">delete</span> p;</span><br><span class="line">p = newNode;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>-&gt;head-&gt;next = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;last = <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">bool</span> DoubleLinkedList&lt;T&gt;::<span class="built_in">isEmpty</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">int</span> DoubleLinkedList&lt;T&gt;::<span class="built_in">length</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T DoubleLinkedList&lt;T&gt;::<span class="built_in">get</span>(<span class="type">int</span> pos)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (pos &lt; <span class="number">0</span> || pos &gt;= <span class="keyword">this</span>-&gt;size) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line"></span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;<span class="built_in">getNode</span>(pos);</span><br><span class="line"><span class="keyword">return</span> p-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> DoubleLinkedList&lt;T&gt;::<span class="built_in">insert</span>(T data)</span><br><span class="line">&#123;</span><br><span class="line">Node* newNode = <span class="keyword">new</span> <span class="built_in">Node</span>(<span class="keyword">this</span>-&gt;last, data, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="keyword">this</span>-&gt;last-&gt;next = newNode;</span><br><span class="line"><span class="keyword">this</span>-&gt;last = newNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> DoubleLinkedList&lt;T&gt;::<span class="built_in">insert</span>(<span class="type">int</span> pos, T data)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;<span class="built_in">getNode</span>(pos);</span><br><span class="line"></span><br><span class="line">Node* newNode = <span class="keyword">new</span> <span class="built_in">Node</span>(p, data, p-&gt;next);</span><br><span class="line">p-&gt;next-&gt;pre = newNode;</span><br><span class="line">p-&gt;next = newNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T DoubleLinkedList&lt;T&gt;::<span class="built_in">remove</span>(<span class="type">int</span> pos)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (pos &lt; <span class="number">0</span> || pos &gt;= <span class="keyword">this</span>-&gt;size) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line"></span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;<span class="built_in">getNode</span>(pos);</span><br><span class="line">T res = p-&gt;data;</span><br><span class="line"></span><br><span class="line">p-&gt;pre-&gt;next = p-&gt;next;</span><br><span class="line">p-&gt;next-&gt;pre = p-&gt;pre;</span><br><span class="line"><span class="keyword">delete</span> p;</span><br><span class="line">p = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;size--;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">int</span> DoubleLinkedList&lt;T&gt;::<span class="built_in">indexOf</span>(T data)</span><br><span class="line">&#123;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (p-&gt;data == data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> pos;</span><br><span class="line">&#125;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T DoubleLinkedList&lt;T&gt;::<span class="built_in">getFirst</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;<span class="built_in">isEmpty</span>()) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;head-&gt;next-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T DoubleLinkedList&lt;T&gt;::<span class="built_in">getLast</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;<span class="built_in">isEmpty</span>()) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;last-&gt;data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-4-栈-链栈"><a href="#1-4-栈-链栈" class="headerlink" title="1.4 栈(链栈)"></a>1.4 栈(链栈)</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Stack</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">T data;</span><br><span class="line">Node* next;</span><br><span class="line"><span class="built_in">Node</span>() &#123;&#125;</span><br><span class="line">        <span class="built_in">Node</span>(Node* next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Node</span>(T data, Node* next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;data = data;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">Node* head;</span><br><span class="line"><span class="type">int</span> size;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Stack</span>();</span><br><span class="line">~<span class="built_in">Stack</span>();</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">T <span class="title">pop</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(T data)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Stack.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">Stack&lt;T&gt;::<span class="built_in">Stack</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="keyword">new</span> <span class="built_in">Node</span>(<span class="literal">nullptr</span>);</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">Stack&lt;T&gt;::~<span class="built_in">Stack</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;head == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">Node* newNode = p-&gt;next;</span><br><span class="line"><span class="keyword">delete</span> p;</span><br><span class="line">p = newNode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">bool</span> Stack&lt;T&gt;::<span class="built_in">isEmpty</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">int</span> Stack&lt;T&gt;::<span class="built_in">getSize</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T Stack&lt;T&gt;::<span class="built_in">pop</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;size == <span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line"></span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line">T data = p-&gt;data;</span><br><span class="line"><span class="keyword">this</span>-&gt;head-&gt;next = p-&gt;next;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;size--;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> Stack&lt;T&gt;::<span class="built_in">push</span>(T data)</span><br><span class="line">&#123;</span><br><span class="line">Node* p = <span class="keyword">new</span> <span class="built_in">Node</span>(data, <span class="keyword">this</span>-&gt;head-&gt;next);</span><br><span class="line"><span class="keyword">this</span>-&gt;head-&gt;next = p;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-5-队列-链队"><a href="#1-5-队列-链队" class="headerlink" title="1.5 队列(链队)"></a>1.5 队列(链队)</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">T data;</span><br><span class="line">Node* next;</span><br><span class="line"><span class="built_in">Node</span>() &#123;&#125;</span><br><span class="line">        <span class="built_in">Node</span>(Node* next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Node</span>(T data, Node* next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;data = data;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">Node* head;</span><br><span class="line">Node* last;</span><br><span class="line"><span class="type">int</span> size;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Queue</span>();</span><br><span class="line">~<span class="built_in">Queue</span>();</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">T <span class="title">dequeue</span><span class="params">()</span></span>; <span class="comment">//出队</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">enqueue</span><span class="params">(T data)</span></span>; <span class="comment">//入队</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Queue.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">Queue&lt;T&gt;::<span class="built_in">Queue</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="keyword">new</span> <span class="built_in">Node</span>(<span class="literal">nullptr</span>);</span><br><span class="line"><span class="keyword">this</span>-&gt;last = <span class="keyword">this</span>-&gt;head;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">Queue&lt;T&gt;::~<span class="built_in">Queue</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;head == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">Node* newNode = p-&gt;next;</span><br><span class="line"><span class="keyword">delete</span> p;</span><br><span class="line">p = newNode;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;last = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">bool</span> Queue&lt;T&gt;::<span class="built_in">isEmpty</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T Queue&lt;T&gt;::<span class="built_in">dequeue</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;size == <span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line"></span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line">T data = p-&gt;data;</span><br><span class="line"><span class="keyword">this</span>-&gt;head-&gt;next = p-&gt;next;</span><br><span class="line"><span class="keyword">delete</span> p;</span><br><span class="line"><span class="keyword">this</span>-&gt;size--;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;<span class="built_in">isEmpty</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;last = <span class="keyword">this</span>-&gt;head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> Queue&lt;T&gt;::<span class="built_in">enqueue</span>(T data)</span><br><span class="line">&#123;</span><br><span class="line">Node* newNode = <span class="keyword">new</span> <span class="built_in">Node</span>(data, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="keyword">this</span>-&gt;last-&gt;next = newNode;</span><br><span class="line"><span class="keyword">this</span>-&gt;last = newNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="2-符号表"><a href="#2-符号表" class="headerlink" title="2.符号表"></a>2.符号表</h2><h3 id="2-1-符号表-map"><a href="#2-1-符号表-map" class="headerlink" title="2.1 符号表(map)"></a>2.1 符号表(map)</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Map</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">K key;</span><br><span class="line">V value;</span><br><span class="line">Node* next;</span><br><span class="line"><span class="built_in">Node</span>() &#123;&#125;</span><br><span class="line">        <span class="built_in">Node</span>(Node* next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Node</span>(K key, V value, Node* next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;key = key;</span><br><span class="line"><span class="keyword">this</span>-&gt;value = value;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">Node* head;</span><br><span class="line"><span class="type">int</span> size;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Map</span>();</span><br><span class="line">~<span class="built_in">Map</span>();</span><br><span class="line"><span class="function">V <span class="title">get</span><span class="params">(K key)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">put</span><span class="params">(K key, V value)</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">remove</span><span class="params">(K key)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;Map.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line">Map&lt;K, V&gt;::<span class="built_in">Map</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="keyword">new</span> <span class="built_in">Node</span>(<span class="literal">nullptr</span>);</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line">Map&lt;K, V&gt;::~<span class="built_in">Map</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;head == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">Node* newNode = p-&gt;next;</span><br><span class="line"><span class="keyword">delete</span> p;</span><br><span class="line">p = newNode;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line">V Map&lt;K, V&gt;::<span class="built_in">get</span>(K key)</span><br><span class="line">&#123;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (p-&gt;key == key)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> p-&gt;value;</span><br><span class="line">&#125;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">V</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="type">void</span> Map&lt;K, V&gt;::<span class="built_in">put</span>(K key, V value)</span><br><span class="line">&#123;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">while</span> (p-&gt;next != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line"><span class="keyword">if</span> (p-&gt;key == key)</span><br><span class="line">&#123;</span><br><span class="line">p-&gt;value = value;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">Node* newNode = <span class="keyword">new</span> <span class="built_in">Node</span>(key, value, <span class="literal">nullptr</span>);</span><br><span class="line">p-&gt;next = newNode;</span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="type">bool</span> Map&lt;K, V&gt;::<span class="built_in">remove</span>(K key)</span><br><span class="line">&#123;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">while</span> (p-&gt;next != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (p-&gt;next-&gt;key == key)</span><br><span class="line">&#123;</span><br><span class="line">Node* e = p-&gt;next;</span><br><span class="line">p-&gt;next = e-&gt;next;</span><br><span class="line"><span class="keyword">delete</span> e;</span><br><span class="line"><span class="keyword">this</span>-&gt;size--;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="type">int</span> Map&lt;K, V&gt;::<span class="built_in">getSize</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-有序符号表"><a href="#2-2-有序符号表" class="headerlink" title="2.2 有序符号表"></a>2.2 有序符号表</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span> = less&lt;K&gt;&gt;</span><br><span class="line"><span class="keyword">class</span> OrderMap</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">class</span> Node</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">K key;</span><br><span class="line">V value;</span><br><span class="line">Node* next;</span><br><span class="line"><span class="built_in">Node</span>() &#123;&#125;</span><br><span class="line"><span class="built_in">Node</span>(Node* next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Node</span>(K key, V value, Node* next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;key = key;</span><br><span class="line"><span class="keyword">this</span>-&gt;value = value;</span><br><span class="line"><span class="keyword">this</span>-&gt;next = next;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">Node* head;</span><br><span class="line"><span class="type">int</span> size;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">OrderMap</span>();</span><br><span class="line">~<span class="built_in">OrderMap</span>();</span><br><span class="line"><span class="function">V <span class="title">get</span><span class="params">(K key)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">put</span><span class="params">(K key, V value)</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">remove</span><span class="params">(K key)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;OrderMap.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">OrderMap&lt;K, V, compare&gt;::<span class="built_in">OrderMap</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="keyword">new</span> <span class="built_in">Node</span>(<span class="literal">nullptr</span>);</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">OrderMap&lt;K, V, compare&gt;::~<span class="built_in">OrderMap</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;head == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">Node* newNode = p-&gt;next;</span><br><span class="line"><span class="keyword">delete</span> p;</span><br><span class="line">p = newNode;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">this</span>-&gt;head = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">V OrderMap&lt;K, V, compare&gt;::<span class="built_in">get</span>(K key)</span><br><span class="line">&#123;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (p-&gt;key == key)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> p-&gt;value;</span><br><span class="line">&#125;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">V</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> OrderMap&lt;K, V, compare&gt;::<span class="built_in">put</span>(K key, V value)</span><br><span class="line">&#123;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head-&gt;next;</span><br><span class="line">Node* pre = <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">nullptr</span> &amp;&amp; <span class="built_in">compare</span>()(p-&gt;key, key))</span><br><span class="line">&#123;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">pre = pre-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (p == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">Node* newNode = <span class="keyword">new</span> <span class="built_in">Node</span>(key, value, <span class="literal">nullptr</span>);</span><br><span class="line">pre-&gt;next = newNode;</span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (p-&gt;key == key)</span><br><span class="line">&#123;</span><br><span class="line">p-&gt;value = value;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">Node* newNode = <span class="keyword">new</span> <span class="built_in">Node</span>(key, value, p);</span><br><span class="line">pre-&gt;next = newNode;</span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">bool</span> OrderMap&lt;K, V, compare&gt;::<span class="built_in">remove</span>(K key)</span><br><span class="line">&#123;</span><br><span class="line">Node* p = <span class="keyword">this</span>-&gt;head;</span><br><span class="line"><span class="keyword">while</span> (p-&gt;next != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (p-&gt;next-&gt;key == key)</span><br><span class="line">&#123;</span><br><span class="line">Node* e = p-&gt;next;</span><br><span class="line">p-&gt;next = e-&gt;next;</span><br><span class="line"><span class="keyword">delete</span> e;</span><br><span class="line"><span class="keyword">this</span>-&gt;size--;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">int</span> OrderMap&lt;K, V, compare&gt;::<span class="built_in">getSize</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="3-树"><a href="#3-树" class="headerlink" title="3.树"></a>3.树</h2><h3 id="3-1-二叉查找树"><a href="#3-1-二叉查找树" class="headerlink" title="3.1 二叉查找树"></a>3.1 二叉查找树</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BinaryTree</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">K key;</span><br><span class="line">V value;</span><br><span class="line">Node* left;</span><br><span class="line">Node* right;</span><br><span class="line"><span class="built_in">Node</span>() &#123;&#125;</span><br><span class="line"><span class="built_in">Node</span>(K key, V value, Node* left, Node* right)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;key = key;</span><br><span class="line"><span class="keyword">this</span>-&gt;value = value;</span><br><span class="line"><span class="keyword">this</span>-&gt;left = left;</span><br><span class="line"><span class="keyword">this</span>-&gt;right = right;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">Node* root;</span><br><span class="line"><span class="type">int</span> size;</span><br><span class="line"><span class="function">Node* <span class="title">put</span><span class="params">(Node* node, K key, V value)</span></span>;</span><br><span class="line"><span class="function">V <span class="title">get</span><span class="params">(Node* node, K key)</span></span>;</span><br><span class="line"><span class="function">Node* <span class="title">remove</span><span class="params">(Node* node, K key)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">destroy</span><span class="params">(Node* node)</span></span>;</span><br><span class="line"><span class="function">Node* <span class="title">min</span><span class="params">(Node* node)</span></span>;</span><br><span class="line"><span class="function">Node* <span class="title">max</span><span class="params">(Node* node)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">depth</span><span class="params">(Node* node)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ergodic</span><span class="params">(Node* node, vector&lt;K&gt;&amp; keys, <span class="type">int</span> select)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">layerErgodic</span><span class="params">(Node* node, vector&lt;K&gt;&amp; keys)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">BinaryTree</span>();</span><br><span class="line">~<span class="built_in">BinaryTree</span>();</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">put</span><span class="params">(K key, V value)</span></span>;</span><br><span class="line"><span class="function">V <span class="title">get</span><span class="params">(K key)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(K key)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">K <span class="title">getMin</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">K <span class="title">getMax</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getDepth</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">vector&lt;K&gt; <span class="title">ergodic</span><span class="params">(<span class="type">int</span> select)</span></span>; <span class="comment">//0 层序 先序1 中序2 后序3</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;BinaryTree.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> BinaryTree&lt;K, V&gt;::Node* BinaryTree&lt;K, V&gt;::<span class="built_in">put</span>(Node* node, K key, V value)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (node == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Node</span>(key, value, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (node-&gt;key &gt; key) node-&gt;left = <span class="keyword">this</span>-&gt;<span class="built_in">put</span>(node-&gt;left, key, value);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (node-&gt;key &lt; key) node-&gt;right = <span class="keyword">this</span>-&gt;<span class="built_in">put</span>(node-&gt;right, key, value);</span><br><span class="line"><span class="keyword">else</span> node-&gt;value = value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line">V BinaryTree&lt;K, V&gt;::<span class="built_in">get</span>(Node* node, K key)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (node == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="built_in">V</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (node-&gt;key &gt; key) <span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">get</span>(node-&gt;left, key);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (node-&gt;key &lt; key) <span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">get</span>(node-&gt;right, key);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">return</span> node-&gt;value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">V</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> BinaryTree&lt;K, V&gt;::Node* BinaryTree&lt;K, V&gt;::<span class="built_in">remove</span>(Node* node, K key)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//未找到key值</span></span><br><span class="line"><span class="keyword">if</span> (node == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (node-&gt;key &gt; key) node-&gt;left = <span class="keyword">this</span>-&gt;<span class="built_in">remove</span>(node-&gt;left, key);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (node-&gt;key &lt; key) node-&gt;right = <span class="keyword">this</span>-&gt;<span class="built_in">remove</span>(node-&gt;right, key);</span><br><span class="line"><span class="comment">// node-&gt;key == key情况</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//左子树为空的情况</span></span><br><span class="line"><span class="keyword">if</span> (node-&gt;left == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">Node* temp = node-&gt;right;</span><br><span class="line"><span class="keyword">delete</span> node;</span><br><span class="line">node = temp;</span><br><span class="line"><span class="keyword">this</span>-&gt;size--;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//右子树为空的情况</span></span><br><span class="line"><span class="keyword">if</span> (node-&gt;right == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">Node* temp = node-&gt;left;</span><br><span class="line"><span class="keyword">delete</span> node;</span><br><span class="line">node = temp;</span><br><span class="line"><span class="keyword">this</span>-&gt;size--;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//左右字树都不为空的情况</span></span><br><span class="line">Node* nodeLeft = node-&gt;left; <span class="comment">//要删除的节点的左子树</span></span><br><span class="line">Node* nodeRight = node-&gt;right; <span class="comment">//要删除的节点的左子树</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//循环，找到右子树的左节点的底节点e以及e的父节点p</span></span><br><span class="line">Node* p = node; <span class="comment">//初始化父节点为node</span></span><br><span class="line">Node* e = node-&gt;right; <span class="comment">//初始化底节点e为node的右节点</span></span><br><span class="line"><span class="keyword">while</span> (e-&gt;left != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">p = e;</span><br><span class="line">e = e-&gt;left;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果node的右节点就是底节点e了</span></span><br><span class="line"><span class="keyword">if</span> (p == node)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">delete</span> node; <span class="comment">//将node节点销毁</span></span><br><span class="line">node = e; <span class="comment">//换成e节点</span></span><br><span class="line">node-&gt;left = nodeLeft; <span class="comment">//e节点(就是现在的node)的左子树为nodeLeft</span></span><br><span class="line"><span class="keyword">this</span>-&gt;size--; <span class="comment">//size-1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取底层节点e，将e的父节点p左子树置空</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">p-&gt;left = <span class="literal">nullptr</span>; <span class="comment">//将父节点置空</span></span><br><span class="line"><span class="keyword">delete</span> node; <span class="comment">//将node节点销毁</span></span><br><span class="line">node = e; <span class="comment">//换成e节点</span></span><br><span class="line">node-&gt;left = nodeLeft; <span class="comment">//e节点(就是现在的node)的左子树为nodeLeft</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//e节点遍历右子树到底层节点temp</span></span><br><span class="line">Node* temp = node;</span><br><span class="line"><span class="keyword">while</span> (temp-&gt;right != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">temp = temp-&gt;right;</span><br><span class="line">&#125;</span><br><span class="line">temp-&gt;right = nodeRight; <span class="comment">//temp的右子树为nodeRight</span></span><br><span class="line"><span class="keyword">this</span>-&gt;size--; <span class="comment">//size-1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="type">void</span> BinaryTree&lt;K, V&gt;::<span class="built_in">destroy</span>(Node* node)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (node == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">destroy</span>(node-&gt;left);</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">destroy</span>(node-&gt;right);</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> BinaryTree&lt;K, V&gt;::Node* BinaryTree&lt;K, V&gt;::<span class="built_in">min</span>(Node* node)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (node-&gt;left == <span class="literal">nullptr</span>) <span class="keyword">return</span> node;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">min</span>(node-&gt;left);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> BinaryTree&lt;K, V&gt;::Node* BinaryTree&lt;K, V&gt;::<span class="built_in">max</span>(Node* node)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (node-&gt;right == <span class="literal">nullptr</span>) <span class="keyword">return</span> node;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">max</span>(node-&gt;right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="type">int</span> BinaryTree&lt;K, V&gt;::<span class="built_in">depth</span>(Node* node)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (node == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> left = <span class="keyword">this</span>-&gt;<span class="built_in">depth</span>(node-&gt;left) + <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> right = <span class="keyword">this</span>-&gt;<span class="built_in">depth</span>(node-&gt;right) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (left &gt; right) <span class="keyword">return</span> left;</span><br><span class="line"><span class="keyword">return</span> right;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="type">void</span> BinaryTree&lt;K, V&gt;::<span class="built_in">ergodic</span>(Node* node, vector&lt;K&gt;&amp; keys, <span class="type">int</span> select)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (node == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (select == <span class="number">1</span>) keys.<span class="built_in">emplace_back</span>(node-&gt;key); <span class="comment">//先序的选择</span></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">ergodic</span>(node-&gt;left, keys, select);</span><br><span class="line"><span class="keyword">if</span> (select == <span class="number">2</span>) keys.<span class="built_in">emplace_back</span>(node-&gt;key); <span class="comment">//中序的选择</span></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">ergodic</span>(node-&gt;right, keys, select);</span><br><span class="line"><span class="keyword">if</span> (select == <span class="number">3</span>) keys.<span class="built_in">emplace_back</span>(node-&gt;key); <span class="comment">//后序的选择</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="type">void</span> BinaryTree&lt;K, V&gt;::<span class="built_in">layerErgodic</span>(Node* node, vector&lt;K&gt;&amp; keys)</span><br><span class="line">&#123;</span><br><span class="line">queue&lt;Node*&gt; q;</span><br><span class="line">q.<span class="built_in">emplace</span>(node);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (!q.<span class="built_in">empty</span>())</span><br><span class="line">&#123;</span><br><span class="line">Node* temp = q.<span class="built_in">front</span>();</span><br><span class="line">keys.<span class="built_in">emplace_back</span>(temp-&gt;key);</span><br><span class="line">q.<span class="built_in">pop</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (temp-&gt;left != <span class="literal">nullptr</span>) q.<span class="built_in">emplace</span>(temp-&gt;left);</span><br><span class="line"><span class="keyword">if</span> (temp-&gt;right != <span class="literal">nullptr</span>) q.<span class="built_in">emplace</span>(temp-&gt;right);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line">BinaryTree&lt;K, V&gt;::<span class="built_in">BinaryTree</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;root = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line">BinaryTree&lt;K, V&gt;::~<span class="built_in">BinaryTree</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">destroy</span>(<span class="keyword">this</span>-&gt;root);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="type">void</span> BinaryTree&lt;K, V&gt;::<span class="built_in">put</span>(K key, V value)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;root = <span class="keyword">this</span>-&gt;<span class="built_in">put</span>(<span class="keyword">this</span>-&gt;root, key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line">V BinaryTree&lt;K, V&gt;::<span class="built_in">get</span>(K key)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">get</span>(<span class="keyword">this</span>-&gt;root, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="type">void</span> BinaryTree&lt;K, V&gt;::<span class="built_in">remove</span>(K key)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;root = <span class="keyword">this</span>-&gt;<span class="built_in">remove</span>(<span class="keyword">this</span>-&gt;root, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="type">int</span> BinaryTree&lt;K, V&gt;::<span class="built_in">getSize</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line">K BinaryTree&lt;K, V&gt;::<span class="built_in">getMin</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">min</span>(<span class="keyword">this</span>-&gt;root)-&gt;key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line">K BinaryTree&lt;K, V&gt;::<span class="built_in">getMax</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">max</span>(<span class="keyword">this</span>-&gt;root)-&gt;key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line"><span class="type">int</span> BinaryTree&lt;K, V&gt;::<span class="built_in">getDepth</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">depth</span>(<span class="keyword">this</span>-&gt;root);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>&gt;</span><br><span class="line">vector&lt;K&gt; BinaryTree&lt;K, V&gt;::<span class="built_in">ergodic</span>(<span class="type">int</span> select)</span><br><span class="line">&#123;</span><br><span class="line">vector&lt;K&gt; keys;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (select == <span class="number">0</span>) <span class="keyword">this</span>-&gt;<span class="built_in">layerErgodic</span>(<span class="keyword">this</span>-&gt;root, keys); <span class="comment">//0 层序</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">ergodic</span>(<span class="keyword">this</span>-&gt;root, keys, select);</span><br><span class="line"><span class="keyword">return</span> keys;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-红黑树"><a href="#3-2-红黑树" class="headerlink" title="3.2 红黑树"></a>3.2 红黑树</h3><p>红黑树含有黑红链接满足下列条件：</p><ol><li>红链接均为左链接</li><li>没有任何一个结点同时和两条红链接相连</li><li>该树是完美黑色平衡，即任意空链接到根节点的路径上的黑链接数量相同</li></ol><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认为less&lt;&gt;为左小右大，可修改为greater&lt;&gt;左大右小</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span> = less&lt;K&gt;&gt;</span><br><span class="line"><span class="keyword">class</span> RedBlackTree</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">class</span> Node</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">K key;</span><br><span class="line">V value;</span><br><span class="line">Node* left;</span><br><span class="line">Node* right;</span><br><span class="line"><span class="type">bool</span> color;</span><br><span class="line"><span class="built_in">Node</span>() &#123;&#125;</span><br><span class="line"><span class="built_in">Node</span>(K key, V value, Node* left, Node* right, <span class="type">bool</span> color)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;key = key;</span><br><span class="line"><span class="keyword">this</span>-&gt;value = value;</span><br><span class="line"><span class="keyword">this</span>-&gt;left = left;</span><br><span class="line"><span class="keyword">this</span>-&gt;right = right;</span><br><span class="line"><span class="keyword">this</span>-&gt;color = color;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">Node* root;</span><br><span class="line"><span class="type">int</span> size;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">bool</span> RED = <span class="literal">true</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">bool</span> BLACK = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isRed</span><span class="params">(Node* node)</span></span>;</span><br><span class="line"><span class="function">Node* <span class="title">rotateLeft</span><span class="params">(Node* node)</span></span>;</span><br><span class="line"><span class="function">Node* <span class="title">rotateRight</span><span class="params">(Node* node)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">flipColors</span><span class="params">(Node* node)</span></span>;                    <span class="comment">//颜色反转</span></span><br><span class="line"><span class="function">Node* <span class="title">put</span><span class="params">(Node* node, K key, V value)</span></span>;</span><br><span class="line"><span class="function">V <span class="title">get</span><span class="params">(Node* node, K key)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">destroy</span><span class="params">(Node* node)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">RedBlackTree</span>();</span><br><span class="line">~<span class="built_in">RedBlackTree</span>();</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">put</span><span class="params">(K key, V value)</span></span>;</span><br><span class="line"><span class="function">V <span class="title">get</span><span class="params">(K key)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;RedBlackTree.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">bool</span> RedBlackTree&lt;K, V, compare&gt;::<span class="built_in">isRed</span>(Node* node)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (node == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">return</span> node-&gt;color == <span class="keyword">this</span>-&gt;RED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> RedBlackTree&lt;K, V, compare&gt;::Node* RedBlackTree&lt;K, V, compare&gt;::<span class="built_in">rotateLeft</span>(Node* node)</span><br><span class="line">&#123;</span><br><span class="line">Node* r = node-&gt;right;     <span class="comment">//获取node的右节点r</span></span><br><span class="line">node-&gt;right = r-&gt;left;       <span class="comment">//将node的右节点指向之前的右节点r的左节点</span></span><br><span class="line">r-&gt;left = node;                <span class="comment">//将右节点r的左节点指向node</span></span><br><span class="line">r-&gt;color = node-&gt;color;</span><br><span class="line">node-&gt;color = <span class="keyword">this</span>-&gt;RED;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> RedBlackTree&lt;K, V, compare&gt;::Node* RedBlackTree&lt;K, V, compare&gt;::<span class="built_in">rotateRight</span>(Node* node)</span><br><span class="line">&#123;</span><br><span class="line">Node* l = node-&gt;left;</span><br><span class="line">node-&gt;left = l-&gt;right;</span><br><span class="line">l-&gt;right = node;</span><br><span class="line">l-&gt;color = node-&gt;color;</span><br><span class="line">node-&gt;color = <span class="keyword">this</span>-&gt;RED;</span><br><span class="line"><span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> RedBlackTree&lt;K, V, compare&gt;::<span class="built_in">flipColors</span>(Node* node)</span><br><span class="line">&#123;</span><br><span class="line">node-&gt;color = <span class="keyword">this</span>-&gt;RED;</span><br><span class="line">node-&gt;left-&gt;color = <span class="keyword">this</span>-&gt;BLACK;</span><br><span class="line">node-&gt;right-&gt;color = <span class="keyword">this</span>-&gt;BLACK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> RedBlackTree&lt;K, V, compare&gt;::Node* RedBlackTree&lt;K, V, compare&gt;::<span class="built_in">put</span>(Node* node, K key, V value)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (node == <span class="literal">nullptr</span>) &#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line">Node* newNode = <span class="keyword">new</span> <span class="built_in">Node</span>(key, value, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, RED);</span><br><span class="line"><span class="keyword">return</span> newNode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">compare</span>()(key, node-&gt;key)) node-&gt;left = <span class="keyword">this</span>-&gt;<span class="built_in">put</span>(node-&gt;left, key, value);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">compare</span>()(node-&gt;key, key)) node-&gt;right = <span class="keyword">this</span>-&gt;<span class="built_in">put</span>(node-&gt;right, key, value);</span><br><span class="line"><span class="keyword">else</span> node-&gt;value = value;</span><br><span class="line"><span class="comment">//左旋</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">isRed</span>(node-&gt;right) &amp;&amp; !<span class="built_in">isRed</span>(node-&gt;left)) node = <span class="keyword">this</span>-&gt;<span class="built_in">rotateLeft</span>(node);</span><br><span class="line"><span class="comment">//右旋</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">isRed</span>(node-&gt;left) &amp;&amp; <span class="built_in">isRed</span>(node-&gt;left-&gt;left)) node = <span class="keyword">this</span>-&gt;<span class="built_in">rotateRight</span>(node);</span><br><span class="line"><span class="comment">//颜色反转</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">isRed</span>(node-&gt;left) &amp;&amp; <span class="built_in">isRed</span>(node-&gt;right)) <span class="keyword">this</span>-&gt;<span class="built_in">flipColors</span>(node);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">V RedBlackTree&lt;K, V, compare&gt;::<span class="built_in">get</span>(Node* node, K key)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (node == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="built_in">V</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">compare</span>()(key, node-&gt;key)) <span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">get</span>(node-&gt;left, key);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">compare</span>()(node-&gt;key, key)) <span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">get</span>(node-&gt;right, key);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">return</span> node-&gt;value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">V</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> RedBlackTree&lt;K, V, compare&gt;::<span class="built_in">destroy</span>(Node* node)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (node == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">destroy</span>(node-&gt;left);</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">destroy</span>(node-&gt;right);</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">RedBlackTree&lt;K, V, compare&gt;::<span class="built_in">RedBlackTree</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;root = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">RedBlackTree&lt;K, V, compare&gt;::~<span class="built_in">RedBlackTree</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">destroy</span>(<span class="keyword">this</span>-&gt;root);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> RedBlackTree&lt;K, V, compare&gt;::<span class="built_in">put</span>(K key, V value)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;root = <span class="keyword">this</span>-&gt;<span class="built_in">put</span>(<span class="keyword">this</span>-&gt;root, key, value);</span><br><span class="line"><span class="keyword">this</span>-&gt;root-&gt;color = <span class="keyword">this</span>-&gt;BLACK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">V RedBlackTree&lt;K, V, compare&gt;::<span class="built_in">get</span>(K key)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">get</span>(<span class="keyword">this</span>-&gt;root, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">K</span>, <span class="keyword">class</span> <span class="title class_">V</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"> <span class="type">int</span> RedBlackTree&lt;K, V, compare&gt;::<span class="built_in">getSize</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-并查集"><a href="#3-3-并查集" class="headerlink" title="3.3 并查集"></a>3.3 并查集</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UF_Tree_Weighted</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span>* array;</span><br><span class="line"><span class="type">int</span>* size;</span><br><span class="line"><span class="type">int</span> count;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">UF_Tree_Weighted</span>(<span class="type">int</span> capacity);</span><br><span class="line">~<span class="built_in">UF_Tree_Weighted</span>();</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCount</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">connected</span><span class="params">(<span class="type">int</span> p, <span class="type">int</span> q)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">find</span><span class="params">(<span class="type">int</span> p)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">merge</span><span class="params">(<span class="type">int</span> p, <span class="type">int</span> q)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;UF_Tree_Weighted.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">UF_Tree_Weighted::<span class="built_in">UF_Tree_Weighted</span>(<span class="type">int</span> capacity)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;array = <span class="keyword">new</span> <span class="type">int</span>[capacity];</span><br><span class="line">    <span class="keyword">this</span>-&gt;size = <span class="keyword">new</span> <span class="type">int</span>[capacity];</span><br><span class="line">    <span class="keyword">this</span>-&gt;count = capacity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>-&gt;count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;array[i] = i;</span><br><span class="line">        <span class="keyword">this</span>-&gt;size[i] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">UF_Tree_Weighted::~<span class="built_in">UF_Tree_Weighted</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;array != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">delete</span>[] array;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UF_Tree_Weighted::getCount</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UF_Tree_Weighted::connected</span><span class="params">(<span class="type">int</span> p, <span class="type">int</span> q)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">find</span>(p) == <span class="built_in">find</span>(q);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UF_Tree_Weighted::find</span><span class="params">(<span class="type">int</span> p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;array[p] == p) <span class="keyword">return</span> p;</span><br><span class="line">        p = <span class="keyword">this</span>-&gt;array[p];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UF_Tree_Weighted::merge</span><span class="params">(<span class="type">int</span> p, <span class="type">int</span> q)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> pRoot = <span class="keyword">this</span>-&gt;<span class="built_in">find</span>(p);</span><br><span class="line">    <span class="type">int</span> qRoot = <span class="keyword">this</span>-&gt;<span class="built_in">find</span>(q);</span><br><span class="line">    <span class="keyword">if</span> (pRoot == qRoot) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//判断哪个结点长，哪个就当根节点</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;size[pRoot] &lt; <span class="keyword">this</span>-&gt;size[qRoot]) &#123;</span><br><span class="line">        <span class="comment">//让p的根节点指向q的根节点</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;array[pRoot] = qRoot;</span><br><span class="line">        <span class="keyword">this</span>-&gt;size[qRoot] += <span class="keyword">this</span>-&gt;size[pRoot];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;array[qRoot] = pRoot;</span><br><span class="line">        <span class="keyword">this</span>-&gt;size[pRoot] += <span class="keyword">this</span>-&gt;size[qRoot];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>-&gt;count--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="4-堆"><a href="#4-堆" class="headerlink" title="4.堆"></a>4.堆</h2><h3 id="4-1-堆-完全二叉树"><a href="#4-1-堆-完全二叉树" class="headerlink" title="4.1 堆(完全二叉树)"></a>4.1 堆(完全二叉树)</h3><p>堆是用数组完成数据元素的存储(0位置被废止了)</p><p>如果一个节点的位置为<code>k</code>，那么它的父节点的位置为<code>k/2</code>，而它的子节点的位置为<code>2k</code>和<code>2k+1</code></p><p>并且每个节点都要大于它的子节点之和，但是这两个子节点的顺序位置没有要求</p><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认less&lt;&gt;为小堆顶，使用可修改为greater&lt;&gt;为大堆顶</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span> = less&lt;T&gt;&gt;</span><br><span class="line"><span class="keyword">class</span> Heap</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">T* arrayList;</span><br><span class="line"><span class="type">int</span> size;</span><br><span class="line"><span class="type">int</span> capacity;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">less</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span></span>;    <span class="comment">//判断i位置的元素是否小于j位置的元素</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">exch</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span></span>;   <span class="comment">//交换i位置与j位置的元素</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">swim</span><span class="params">(<span class="type">int</span> pos)</span></span>;     <span class="comment">//使用上浮算法，使pos位置的元素能处于正确位置</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sink</span><span class="params">(<span class="type">int</span> pos)</span></span>;      <span class="comment">//使用下浮算法，使pos位置的元素能处于正确位置</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">resize</span><span class="params">(<span class="type">int</span> newCapacity)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Heap</span>();</span><br><span class="line"><span class="built_in">Heap</span>(<span class="type">int</span> capacity);</span><br><span class="line">~<span class="built_in">Heap</span>();</span><br><span class="line"><span class="function">T <span class="title">delMax</span><span class="params">()</span></span>;               <span class="comment">//删除堆中最大的元素，并返回该元素</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(T val)</span></span>;       <span class="comment">//插入一个元素</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Heap.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">bool</span> Heap&lt;T, compare&gt;::<span class="built_in">less</span>(<span class="type">int</span> i, <span class="type">int</span> j)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">compare</span>()(<span class="keyword">this</span>-&gt;arrayList[i], <span class="keyword">this</span>-&gt;arrayList[j]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> Heap&lt;T, compare&gt;::<span class="built_in">exch</span>(<span class="type">int</span> i, <span class="type">int</span> j)</span><br><span class="line">&#123;</span><br><span class="line">T temp = <span class="keyword">this</span>-&gt;arrayList[i];</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList[i] = <span class="keyword">this</span>-&gt;arrayList[j];</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList[j] = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> Heap&lt;T, compare&gt;::<span class="built_in">swim</span>(<span class="type">int</span> pos)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">while</span> (pos &gt; <span class="number">1</span> &amp;&amp; <span class="keyword">this</span>-&gt;<span class="built_in">less</span>(pos, <span class="built_in">int</span>(pos / <span class="number">2</span>)))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">exch</span>(<span class="built_in">int</span>(pos / <span class="number">2</span>), pos);</span><br><span class="line">pos = <span class="built_in">int</span>(pos / <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> Heap&lt;T, compare&gt;::<span class="built_in">sink</span>(<span class="type">int</span> pos)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">2</span> * pos &lt;= <span class="keyword">this</span>-&gt;size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> min;</span><br><span class="line"><span class="comment">// 如果存在右节点，判断两个子节点哪个最小</span></span><br><span class="line"><span class="keyword">if</span> (<span class="number">2</span> * pos + <span class="number">1</span> &lt;= <span class="keyword">this</span>-&gt;size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;<span class="built_in">less</span>(<span class="number">2</span> * pos + <span class="number">1</span>, <span class="number">2</span> * pos)) min = <span class="number">2</span> * pos + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">else</span> min = <span class="number">2</span> * pos;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 只有左节点</span></span><br><span class="line"><span class="keyword">else</span> min = <span class="number">2</span> * pos;</span><br><span class="line"><span class="comment">// 父节点pos小于最小的子节点，不需要继续下浮了</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;<span class="built_in">less</span>(pos, min)) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">exch</span>(pos, min); <span class="comment">//交换</span></span><br><span class="line">pos = min;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> Heap&lt;T, compare&gt;::<span class="built_in">resize</span>(<span class="type">int</span> newCapacity)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;capacity = newCapacity;</span><br><span class="line">T* temp = <span class="keyword">new</span> T[<span class="keyword">this</span>-&gt;capacity + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= <span class="keyword">this</span>-&gt;size; i++)</span><br><span class="line">&#123;</span><br><span class="line">temp[i] = <span class="keyword">this</span>-&gt;arrayList[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">delete</span>[] <span class="keyword">this</span>-&gt;arrayList;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">Heap&lt;T, compare&gt;::<span class="built_in">Heap</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;capacity = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = <span class="keyword">new</span> T[<span class="keyword">this</span>-&gt;capacity + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">Heap&lt;T, compare&gt;::<span class="built_in">Heap</span>(<span class="type">int</span> capacity)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;capacity = capacity;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = <span class="keyword">new</span> T[<span class="keyword">this</span>-&gt;capacity + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">Heap&lt;T, compare&gt;::~<span class="built_in">Heap</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;arrayList != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">delete</span>[] <span class="keyword">this</span>-&gt;arrayList;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">T Heap&lt;T, compare&gt;::<span class="built_in">delMax</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;size == <span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line"></span><br><span class="line">T val = <span class="keyword">this</span>-&gt;arrayList[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">exch</span>(<span class="number">1</span>, <span class="keyword">this</span>-&gt;size);</span><br><span class="line"><span class="keyword">this</span>-&gt;size--;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">sink</span>(<span class="number">1</span>); <span class="comment">//下沉算法</span></span><br><span class="line"><span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> Heap&lt;T, compare&gt;::<span class="built_in">insert</span>(T val)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;size == <span class="keyword">this</span>-&gt;capacity) </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">resize</span>(<span class="keyword">this</span>-&gt;capacity * <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//不用0位置</span></span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList[<span class="keyword">this</span>-&gt;size + <span class="number">1</span>] = val;</span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">swim</span>(<span class="keyword">this</span>-&gt;size); <span class="comment">//上浮算法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="5-优先队列"><a href="#5-优先队列" class="headerlink" title="5.优先队列"></a>5.优先队列</h2><h3 id="5-1-优先队列-堆实现"><a href="#5-1-优先队列-堆实现" class="headerlink" title="5.1 优先队列(堆实现)"></a>5.1 优先队列(堆实现)</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认为greater&lt;&gt;最大优先队列，可修改为less&lt;&gt;为最小优先队列</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span> = greater&lt;T&gt;&gt;</span><br><span class="line"><span class="keyword">class</span> PriorityQueue</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">T* arrayList;</span><br><span class="line"><span class="type">int</span> size;</span><br><span class="line"><span class="type">int</span> capacity;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">less</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span></span>;    <span class="comment">//判断i位置的元素是否小于j位置的元素</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">exch</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span></span>;   <span class="comment">//交换i位置与j位置的元素</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">swim</span><span class="params">(<span class="type">int</span> pos)</span></span>;     <span class="comment">//使用上浮算法，使pos位置的元素能处于正确位置</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sink</span><span class="params">(<span class="type">int</span> pos)</span></span>;      <span class="comment">//使用下浮算法，使pos位置的元素能处于正确位置</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">resize</span><span class="params">(<span class="type">int</span> newCapacity)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">PriorityQueue</span>();</span><br><span class="line"><span class="built_in">PriorityQueue</span>(<span class="type">int</span> capacity);</span><br><span class="line">~<span class="built_in">PriorityQueue</span>();</span><br><span class="line"><span class="function">T <span class="title">delMax</span><span class="params">()</span></span>;               <span class="comment">//删除堆中最大的元素，并返回该元素</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(T val)</span></span>;       <span class="comment">//插入一个元素</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;PriorityQueue.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">bool</span> PriorityQueue&lt;T, compare&gt;::<span class="built_in">less</span>(<span class="type">int</span> i, <span class="type">int</span> j)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">compare</span>()(<span class="keyword">this</span>-&gt;arrayList[i], <span class="keyword">this</span>-&gt;arrayList[j]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> PriorityQueue&lt;T, compare&gt;::<span class="built_in">exch</span>(<span class="type">int</span> i, <span class="type">int</span> j)</span><br><span class="line">&#123;</span><br><span class="line">T temp = <span class="keyword">this</span>-&gt;arrayList[i];</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList[i] = <span class="keyword">this</span>-&gt;arrayList[j];</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList[j] = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> PriorityQueue&lt;T, compare&gt;::<span class="built_in">swim</span>(<span class="type">int</span> pos)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">while</span> (pos &gt; <span class="number">1</span> &amp;&amp; <span class="keyword">this</span>-&gt;<span class="built_in">less</span>(pos, <span class="built_in">int</span>(pos / <span class="number">2</span>)))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">exch</span>(<span class="built_in">int</span>(pos / <span class="number">2</span>), pos);</span><br><span class="line">pos = <span class="built_in">int</span>(pos / <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> PriorityQueue&lt;T, compare&gt;::<span class="built_in">sink</span>(<span class="type">int</span> pos)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">2</span> * pos &lt;= <span class="keyword">this</span>-&gt;size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> max;</span><br><span class="line"><span class="comment">// 如果存在右节点，判断两个子节点哪个最大</span></span><br><span class="line"><span class="keyword">if</span> (<span class="number">2</span> * pos + <span class="number">1</span> &lt;= <span class="keyword">this</span>-&gt;size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;<span class="built_in">less</span>(<span class="number">2</span> * pos + <span class="number">1</span>, <span class="number">2</span> * pos)) max = <span class="number">2</span> * pos + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">else</span> max = <span class="number">2</span> * pos;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 只有左节点</span></span><br><span class="line"><span class="keyword">else</span> max = <span class="number">2</span> * pos;</span><br><span class="line"><span class="comment">// 父节点pos大于最大的子节点，不需要继续下浮了</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;<span class="built_in">less</span>(pos, max)) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">exch</span>(pos, max); <span class="comment">//交换</span></span><br><span class="line">pos = max;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> PriorityQueue&lt;T, compare&gt;::<span class="built_in">resize</span>(<span class="type">int</span> newCapacity)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;capacity = newCapacity;</span><br><span class="line">T* temp = <span class="keyword">new</span> T[<span class="keyword">this</span>-&gt;capacity + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= <span class="keyword">this</span>-&gt;size; i++)</span><br><span class="line">&#123;</span><br><span class="line">temp[i] = <span class="keyword">this</span>-&gt;arrayList[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">delete</span>[] <span class="keyword">this</span>-&gt;arrayList;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">PriorityQueue&lt;T, compare&gt;::<span class="built_in">PriorityQueue</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;capacity = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = <span class="keyword">new</span> T[<span class="keyword">this</span>-&gt;capacity + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">PriorityQueue&lt;T, compare&gt;::<span class="built_in">PriorityQueue</span>(<span class="type">int</span> capacity)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;capacity = capacity;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = <span class="keyword">new</span> T[<span class="keyword">this</span>-&gt;capacity + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">this</span>-&gt;size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">PriorityQueue&lt;T, compare&gt;::~<span class="built_in">PriorityQueue</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;arrayList != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">delete</span>[] <span class="keyword">this</span>-&gt;arrayList;</span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line">T PriorityQueue&lt;T, compare&gt;::<span class="built_in">delMax</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;size == <span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line"></span><br><span class="line">T val = <span class="keyword">this</span>-&gt;arrayList[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">exch</span>(<span class="number">1</span>, <span class="keyword">this</span>-&gt;size);</span><br><span class="line"><span class="keyword">this</span>-&gt;size--;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">sink</span>(<span class="number">1</span>); <span class="comment">//下沉算法</span></span><br><span class="line"><span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">void</span> PriorityQueue&lt;T, compare&gt;::<span class="built_in">insert</span>(T val)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;size == <span class="keyword">this</span>-&gt;capacity)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">resize</span>(<span class="keyword">this</span>-&gt;capacity * <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//不用0位置</span></span><br><span class="line"><span class="keyword">this</span>-&gt;arrayList[<span class="keyword">this</span>-&gt;size + <span class="number">1</span>] = val;</span><br><span class="line"><span class="keyword">this</span>-&gt;size++;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">swim</span>(<span class="keyword">this</span>-&gt;size); <span class="comment">//上浮算法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">int</span> PriorityQueue&lt;T, compare&gt;::<span class="built_in">getSize</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">compare</span>&gt;</span><br><span class="line"><span class="type">bool</span> PriorityQueue&lt;T, compare&gt;::<span class="built_in">isEmpty</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;size == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-索引优先队列"><a href="#5-2-索引优先队列" class="headerlink" title="5.2 索引优先队列"></a>5.2 索引优先队列</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="6-图"><a href="#6-图" class="headerlink" title="6.图"></a>6.图</h2><h3 id="6-1-无向图-邻接表"><a href="#6-1-无向图-邻接表" class="headerlink" title="6.1 无向图(邻接表)"></a>6.1 无向图(邻接表)</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Graph</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> V;</span><br><span class="line"><span class="type">int</span> E;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt;* adj;</span><br><span class="line"><span class="type">int</span> start;</span><br><span class="line"><span class="type">int</span>* edgeTo;</span><br><span class="line"><span class="type">bool</span>* visited;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> v, <span class="type">bool</span>* marked, vector&lt;<span class="type">int</span>&gt;&amp; visit)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bfs</span><span class="params">(<span class="type">int</span> v, <span class="type">bool</span>* marked, vector&lt;<span class="type">int</span>&gt;&amp; visit)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfsSeek</span><span class="params">(<span class="type">int</span> s, <span class="type">bool</span>* visited)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Graph</span>(<span class="type">int</span> v);</span><br><span class="line">~<span class="built_in">Graph</span>();</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getV</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getE</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addEdge</span><span class="params">(<span class="type">int</span> v, <span class="type">int</span> w)</span></span>;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">get</span><span class="params">(<span class="type">int</span> v)</span></span>;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">dfs</span><span class="params">(<span class="type">int</span> v)</span></span>;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">bfs</span><span class="params">(<span class="type">int</span> v)</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isPath</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span></span>;</span><br><span class="line"><span class="function">stack&lt;<span class="type">int</span>&gt; <span class="title">getPath</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Graph.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Graph::dfs</span><span class="params">(<span class="type">int</span> v, <span class="type">bool</span>* marked, vector&lt;<span class="type">int</span>&gt;&amp; visit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">marked[v] = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; w : <span class="keyword">this</span>-&gt;adj[v])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (marked[w])</span><br><span class="line">&#123;</span><br><span class="line">visit.<span class="built_in">emplace_back</span>(w);</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">dfs</span>(w, marked, visit);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Graph::bfs</span><span class="params">(<span class="type">int</span> v, <span class="type">bool</span>* marked, vector&lt;<span class="type">int</span>&gt;&amp; visit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">marked[v] = <span class="literal">false</span>;</span><br><span class="line">q.<span class="built_in">emplace</span>(v);</span><br><span class="line"><span class="keyword">while</span> (!q.<span class="built_in">empty</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> temp = q.<span class="built_in">front</span>();</span><br><span class="line">q.<span class="built_in">pop</span>();</span><br><span class="line">visit.<span class="built_in">emplace_back</span>(temp);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; w : <span class="keyword">this</span>-&gt;adj[v])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (marked[w])</span><br><span class="line">&#123;</span><br><span class="line">marked[w] = <span class="literal">false</span>;</span><br><span class="line">q.<span class="built_in">emplace</span>(w);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Graph::dfsSeek</span><span class="params">(<span class="type">int</span> s, <span class="type">bool</span>* visited)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">visited[s] = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; w : <span class="keyword">this</span>-&gt;adj[s])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (visited[w])</span><br><span class="line">&#123;</span><br><span class="line">edgeTo[w] = s;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">dfsSeek</span>(w, visited);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Graph::<span class="built_in">Graph</span>(<span class="type">int</span> v)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;V = v;</span><br><span class="line"><span class="keyword">this</span>-&gt;E = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;start = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;edgeTo = <span class="keyword">new</span> <span class="type">int</span>[v];</span><br><span class="line"><span class="keyword">this</span>-&gt;visited = <span class="keyword">new</span> <span class="type">bool</span>[v];</span><br><span class="line"><span class="keyword">this</span>-&gt;adj = <span class="keyword">new</span> vector&lt;<span class="type">int</span>&gt;[v];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Graph::~<span class="built_in">Graph</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;adj != <span class="literal">nullptr</span>)</span><br><span class="line"><span class="keyword">delete</span>[] <span class="keyword">this</span>-&gt;adj;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;edgeTo != <span class="literal">nullptr</span>)</span><br><span class="line"><span class="keyword">delete</span>[] <span class="keyword">this</span>-&gt;edgeTo;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;visited != <span class="literal">nullptr</span>)</span><br><span class="line"><span class="keyword">delete</span>[] <span class="keyword">this</span>-&gt;visited;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Graph::getV</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;V;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Graph::getE</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;E;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Graph::addEdge</span><span class="params">(<span class="type">int</span> v, <span class="type">int</span> w)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;adj[v].<span class="built_in">emplace_back</span>(w);</span><br><span class="line"><span class="keyword">this</span>-&gt;adj[w].<span class="built_in">emplace_back</span>(v);</span><br><span class="line"><span class="keyword">this</span>-&gt;E++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">Graph::get</span><span class="params">(<span class="type">int</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;adj[v];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">Graph::dfs</span><span class="params">(<span class="type">int</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; visit;</span><br><span class="line"><span class="type">bool</span>* marked = <span class="keyword">new</span> <span class="type">bool</span>[<span class="keyword">this</span>-&gt;<span class="built_in">getV</span>()];</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">dfs</span>(v, marked, visit);</span><br><span class="line"><span class="keyword">delete</span>[] marked;</span><br><span class="line"><span class="keyword">return</span> visit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">Graph::bfs</span><span class="params">(<span class="type">int</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; visit;</span><br><span class="line"><span class="type">bool</span>* marked = <span class="keyword">new</span> <span class="type">bool</span>[<span class="keyword">this</span>-&gt;<span class="built_in">getV</span>()];</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">bfs</span>(v, marked, visit);</span><br><span class="line"><span class="keyword">delete</span>[] marked;</span><br><span class="line"><span class="keyword">return</span> visit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Graph::isPath</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;start != start)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">delete</span>[] visited;</span><br><span class="line"><span class="keyword">this</span>-&gt;visited = <span class="keyword">new</span> <span class="type">bool</span>[<span class="keyword">this</span>-&gt;<span class="built_in">getV</span>()];</span><br><span class="line"><span class="keyword">this</span>-&gt;start = start;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">dfsSeek</span>(<span class="keyword">this</span>-&gt;start, visited);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> !visited[end];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">stack&lt;<span class="type">int</span>&gt; <span class="title">Graph::getPath</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">isPath</span>(start, end))</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">stack</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">stack&lt;<span class="type">int</span>&gt; s;</span><br><span class="line">s.<span class="built_in">emplace</span>(end);</span><br><span class="line"><span class="type">int</span> temp = end;</span><br><span class="line"><span class="keyword">while</span> (temp != start)</span><br><span class="line">&#123;</span><br><span class="line">temp = <span class="keyword">this</span>-&gt;edgeTo[temp];</span><br><span class="line">s.<span class="built_in">emplace</span>(temp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-2-有向图"><a href="#6-2-有向图" class="headerlink" title="6.2 有向图"></a>6.2 有向图</h3><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Digraph</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> V;</span><br><span class="line"><span class="type">int</span> E;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt;* adj;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfsIsCycle</span><span class="params">(<span class="type">int</span> v, <span class="type">bool</span>* marked, <span class="type">bool</span>* toStack, <span class="type">bool</span>&amp; isCycle)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfsSort</span><span class="params">(<span class="type">int</span> v, <span class="type">bool</span>* marked, stack&lt;<span class="type">int</span>&gt;&amp; s)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reversePost</span><span class="params">(stack&lt;<span class="type">int</span>&gt;&amp; s)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Digraph</span>(<span class="type">int</span> v);</span><br><span class="line">~<span class="built_in">Digraph</span>();</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getV</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getE</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addEdge</span><span class="params">(<span class="type">int</span> v, <span class="type">int</span> w)</span></span>;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">get</span><span class="params">(<span class="type">int</span> v)</span></span>;</span><br><span class="line"><span class="function">Digraph <span class="title">reverse</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isCycle</span><span class="params">()</span></span>;       <span class="comment">//是否有环</span></span><br><span class="line"><span class="function">stack&lt;<span class="type">int</span>&gt; <span class="title">order</span><span class="params">()</span></span>; <span class="comment">//拓扑排序</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>源文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Digraph.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Digraph::dfsIsCycle</span><span class="params">(<span class="type">int</span> v, <span class="type">bool</span>* marked, <span class="type">bool</span>* toStack, <span class="type">bool</span>&amp; isCycle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">marked[v] = <span class="literal">false</span>; <span class="comment">//将此点标记为已经遍历过了</span></span><br><span class="line">toStack[v] = <span class="literal">false</span>; <span class="comment">//第一次标记此点</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; w : <span class="keyword">this</span>-&gt;adj[v])</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//如果没遍历过此点，则遍历</span></span><br><span class="line"><span class="keyword">if</span> (marked[w])</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">dfsIsCycle</span>(w, marked, toStack, isCycle);</span><br><span class="line"><span class="comment">//如果遍历过了此点，又出现了，说明此点存在环</span></span><br><span class="line"><span class="keyword">if</span> (!toStack[w]) </span><br><span class="line">&#123;</span><br><span class="line">isCycle = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">return</span>; <span class="comment">//直接退出，无需继续遍历了</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//遍历完成，说明此点不存在环，将此点取消标记</span></span><br><span class="line"><span class="comment">//只有不存在环，才会运行到这里，并且结束递归时toStack又恢复到原来状态了</span></span><br><span class="line">toStack[v] = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Digraph::dfsSort</span><span class="params">(<span class="type">int</span> v, <span class="type">bool</span>* marked, stack&lt;<span class="type">int</span>&gt;&amp; s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">marked[v] = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; w : <span class="keyword">this</span>-&gt;adj[v])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (marked[w])</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">dfsSort</span>(w, marked, s);</span><br><span class="line">&#125;</span><br><span class="line">s.<span class="built_in">emplace</span>(v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Digraph::reversePost</span><span class="params">(stack&lt;<span class="type">int</span>&gt;&amp; s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">bool</span>* marked = <span class="keyword">new</span> <span class="type">bool</span>[<span class="keyword">this</span>-&gt;<span class="built_in">getV</span>()];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> v = <span class="number">0</span>; v &lt; <span class="keyword">this</span>-&gt;<span class="built_in">getV</span>(); v++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (marked[v])</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">dfsSort</span>(v, marked, s);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">delete</span>[] marked;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Digraph::<span class="built_in">Digraph</span>(<span class="type">int</span> v)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;V = v;</span><br><span class="line"><span class="keyword">this</span>-&gt;E = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">this</span>-&gt;adj = <span class="keyword">new</span> vector&lt;<span class="type">int</span>&gt;[v];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Digraph::~<span class="built_in">Digraph</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;adj != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">delete</span>[] <span class="keyword">this</span>-&gt;adj;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Digraph::getV</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;V;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Digraph::getE</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;E;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Digraph::addEdge</span><span class="params">(<span class="type">int</span> v, <span class="type">int</span> w)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;adj[v].<span class="built_in">emplace_back</span>(w);</span><br><span class="line"><span class="keyword">this</span>-&gt;E++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">Digraph::get</span><span class="params">(<span class="type">int</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;adj[v];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Digraph <span class="title">Digraph::reverse</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="function">Digraph <span class="title">newDigraph</span><span class="params">(<span class="keyword">this</span>-&gt;getV())</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> v = <span class="number">0</span>; v &lt; <span class="keyword">this</span>-&gt;<span class="built_in">getV</span>(); v++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; w : <span class="keyword">this</span>-&gt;adj[v])</span><br><span class="line">&#123;</span><br><span class="line">newDigraph.<span class="built_in">addEdge</span>(w, v);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> newDigraph;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Digraph::isCycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">bool</span> isCycle = <span class="literal">false</span>;</span><br><span class="line"><span class="type">bool</span>* marked = <span class="keyword">new</span> <span class="type">bool</span>[<span class="keyword">this</span>-&gt;<span class="built_in">getV</span>()];</span><br><span class="line"><span class="type">bool</span>* toStack = <span class="keyword">new</span> <span class="type">bool</span>[<span class="keyword">this</span>-&gt;<span class="built_in">getV</span>()];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> v = <span class="number">0</span>; v &lt; <span class="keyword">this</span>-&gt;<span class="built_in">getV</span>(); v++) </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (marked[v]) </span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">dfsIsCycle</span>(v, marked, toStack, isCycle);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">delete</span>[] marked, toStack;</span><br><span class="line"><span class="keyword">return</span> isCycle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">stack&lt;<span class="type">int</span>&gt; <span class="title">Digraph::order</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>-&gt;<span class="built_in">isCycle</span>())</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">stack</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">stack&lt;<span class="type">int</span>&gt; s;</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">reversePost</span>(s);</span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-3-加权无向图"><a href="#6-3-加权无向图" class="headerlink" title="6.3 加权无向图"></a>6.3 加权无向图</h3></div><div class="story post-story"><h2 id="7-字符串匹配"><a href="#7-字符串匹配" class="headerlink" title="7.字符串匹配"></a>7.字符串匹配</h2><h3 id="7-1-KMP"><a href="#7-1-KMP" class="headerlink" title="7.1 KMP"></a>7.1 KMP</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KMP</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">KMP</span>();</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">match</span><span class="params">(string mainStr, string subStr)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="function"><span class="type">int</span>* <span class="title">getNext</span><span class="params">(string subStr)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;KMP.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">KMP::<span class="built_in">KMP</span>()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">KMP::match</span><span class="params">(string mainStr, string subStr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span>* next = <span class="built_in">getNext</span>(subStr);</span><br><span class="line">    <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> k = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (pos &lt; mainStr.<span class="built_in">size</span>() &amp;&amp; k &lt; <span class="built_in">int</span>(subStr.<span class="built_in">size</span>()))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="number">-1</span> || mainStr[pos] == subStr[k])</span><br><span class="line">        &#123;</span><br><span class="line">            pos++;</span><br><span class="line">            k++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            k = next[k];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>[] next;</span><br><span class="line">    <span class="keyword">if</span> (k == subStr.<span class="built_in">size</span>())</span><br><span class="line">        <span class="keyword">return</span> pos - k;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span>* <span class="title">KMP::getNext</span><span class="params">(string subStr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> n = subStr.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">int</span>* next;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">3</span>)</span><br><span class="line">        next = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        next = <span class="keyword">new</span> <span class="type">int</span>[n];</span><br><span class="line">    </span><br><span class="line">    next[<span class="number">0</span>] = <span class="number">-1</span>;</span><br><span class="line">    next[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> pos = <span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> k = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (pos &lt; n)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (subStr[pos - <span class="number">1</span>] == subStr[k])</span><br><span class="line">            next[pos++] = ++k;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (k &gt; <span class="number">0</span>)</span><br><span class="line">            k = next[k];</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            next[pos++] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 计算机4件套 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> c++ </tag>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>操作系统的学习笔记</title>
      <link href="/2022/08/06/%E8%AE%A1%E7%AE%97%E6%9C%BA4%E4%BB%B6%E5%A5%97/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
      <url>/2022/08/06/%E8%AE%A1%E7%AE%97%E6%9C%BA4%E4%BB%B6%E5%A5%97/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="一、操作系统概述"><a href="#一、操作系统概述" class="headerlink" title="一、操作系统概述"></a>一、操作系统概述</h1><h3 id="1-1-特征"><a href="#1-1-特征" class="headerlink" title="1.1 特征"></a>1.1 特征</h3><p>操作系统的特征：</p><ul><li><p><span style="color:red">并发</span>：指两个多个事件在同一时间间隔内发生</p><p>这些事件<span style="color:red">宏观上是同时发生</span>的，但<span style="color:red">微观上是交替发生</span>的</p><p><span style="color:red">并行</span>：指两个或多个事件在同一时刻同时发生</p><p><strong>操作系统的并发性</strong>指计算机系统中同时存在着多个运行着的程序。</p><p>单核CPU同一时刻只能执行一个程序，因此操作系统会负责协调<span style="color:red">多个程序交替执行</span>，但在宏观上看多个程序在<span style="color:red">同时执行</span></p><p>操作系统是伴随着”多道程序技术”而出现的，因此，操作系统和程序并发是一起诞生的</p><p>如今一般都是多核CPU，比如一个4核的CPU，同一时刻可以有<span style="color:red">4个程序并行执行</span>，但是<span style="color:red">操作系统的并发性依然必不可少</span>，因为不可能只运行4个程序</p></li><li><p><span style="color:red">共享</span>：即资源共享，是指系统中的资源可供内存中多个并发程序执行的进程共同使用</p><p>资源共享的方式：</p><ul><li><p>互斥共享方式：系统中的某些资源，虽然可以提供给多个进程使用，但是<span style="color:red">一段时间内只允许一个进程访问该资源</span></p><p>示例：使用QQ和微信视频，<strong>同一时间内摄像头只能分配给其中一个进程</strong></p></li><li><p>同时共享方式：系统中的某些资源，允许一个时间段由<span style="color:red">多个进程”同时”对它们进行访问</span></p><p>其中所谓”同时”，是在宏观上，而微观上，这些进程可能是<strong>交替地对该资源进行访问</strong></p><p>示例：使用QQ发送文件A，同时使用微信发送文件B。<strong>从宏观上，两边都在同时读取并发送文件，从微观上，两个进程在交替着访问硬盘</strong></p></li></ul></li><li><p><span style="color:red">虚拟</span>：是指把一个<span style="color:red">物理上的实体</span>变为若干<span style="color:red">逻辑上的对应物</span>。<span style="color:red">物理实体</span>实际存在的，而<span style="color:red">逻辑上对应物</span>是用户感受到的</p><p>一个程序需要放入内存并分配给CPU才能执行</p><p>一个电脑内存4GB，GTA5运行需要4GB，QQ运行需要256MB，但是还是可以此电脑上运行。</p><p>这是因为使用了<strong>虚拟存储器技术</strong>，虚拟技术中的<span style="color:red">“空分复用技术”</span></p><p>在单核CPU的计算机中，打开多个的软件，依旧能运行，实际上只有一个单核CPU，但是用户认为有多个CPU在为自己服务。</p><p>这是运用了<strong>虚拟处理器技术</strong>中的<span style="color:red">“时分复用技术”</span>，微观上处理机在各个微小的时间段内<strong>交替着为各个进程服务</strong></p><p>虚拟技术：</p><ul><li><p>空分复用技术</p></li><li><p>时分复用技术</p><p>如果失去并发性一段时间只能运行一个程序，则失去了虚拟性的意义(没有并发就谈不上虚拟性)</p></li></ul></li><li><p><span style="color:red">异步</span>：在多道程序环境下，允许多个程序并发执行，但由于资源有限，进程的执行不是一贯到底的。而是走走停停的，已不可预知的速度向前推进，这就是进程的异步。</p><p>只有系统拥有并发性，才有可能导致异步性</p></li></ul><p>并发与共享的关系：</p><ul><li>如果失去并发性，则共享性失去存在意义(不需要两个进程交替着访问硬盘了)</li><li>如果失去共享性，则无法并发(QQ与微信无法同时读取硬盘资源)</li><li>并发性与共线性<strong>互为存在条件</strong></li></ul><p><strong>没有并发和共享，就没有虚拟和异步，因此并发和共享是操作系统的两个最基本的特征</strong></p><h3 id="1-2-发展与分类"><a href="#1-2-发展与分类" class="headerlink" title="1.2 发展与分类"></a>1.2 发展与分类</h3><p>发展：</p><ol><li><p>手工操作阶段</p><p>主要缺点：用户独占全机，人机速度矛盾导致资源利用率极低</p></li><li><p>批处理阶段</p><ol><li><p>单道批处理系统</p><p>引入<strong>脱机输入&#x2F;输出技术</strong>(用磁带完成)，并<strong>监督程序</strong>(操作系统的雏形)负责控制作业的输入、输出</p><p>主要优点：缓解了一定程度的人机速度矛盾，资源利用率有所提升。</p><p>主要缺点：内存中<strong>仅能有一道程序运行</strong>，只有该程序运行结束后才会进入下一道程序。CPU有大量的时间是在空闲<strong>等待IO完成</strong>，资源利用率依然很低</p><img src="https://s2.loli.net/2023/02/09/yS48JnK9pv5r72O.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/yS48JnK9pv5r72O.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220917092729299.png" style="zoom:50%;" /></li><li><p>多道批处理系统</p><p>主要优点：多道程序<strong>并发</strong>执行，<strong>共享</strong>计算加资源。<strong>资源利用率</strong>大幅提升，CPU和其他资源保持”忙碌”状态，系统吞吐量增大</p><p>主要缺点：用户响应时间长，没有<strong>人机交互功能</strong>(用户提交作业后只能等待计算机处理完成，中间不能控制自己的作业执行)</p><img src="https://s2.loli.net/2023/02/09/u2QHvJzP7tIjBbr.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/u2QHvJzP7tIjBbr.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220917092823353.png" style="zoom:50%;" /></li></ol></li><li><p>分时操作系统：计算机以<strong>时间片</strong>为单位<span style="color:red">轮流为各个用户&#x2F;作业服务</span>，各个用户可通过终端与计算机进行交互</p><p>主要优点：用户请求可以被即时响应，<span style="color:red">解决了人机交互问题</span>，允许多个用户同时使用一台计算机，并且用户对计算机的操作相互独立，感受不到别人的存在</p><p>主要缺点：<span style="color:red">不能优先处理一些紧急任务</span>，操作系统对各个用户&#x2F;作业完全公平，不区分任务的紧急性</p></li><li><p>实时操作系统</p><p>主要优点：能够<span style="color:red">优先响应一些紧急任务</span> ，某些紧急任务不需要时间片排队</p><p>在实时操作系统的控制下，计算机接收到信号后及时处理，并且在严格的时间内限时完成任务，实时操作系统的主要特点是：<span style="color:red">及时性和可靠性</span></p><ul><li>硬实时系统：必须在绝对严格的规定时间内完成处理</li><li>软实时系统：能接受偶尔违反时间规定</li></ul></li></ol><p>其他几种操作系统：</p><ul><li>网络操作系统：能够把网络中各个计算机有机的结合起来，实现数据传送等功能，实现网络中的各种资源的共享和各个计算机之间的通信</li><li>分布式操作系统：主要特点是分布式与并行性，任何工作都可以分布在这些计算机上，由它们并行、协同完成这个任务</li><li>个人计算机操作系统：如Windows、MacOS等</li></ul><h3 id="1-3-运行机制与体系结构"><a href="#1-3-运行机制与体系结构" class="headerlink" title="1.3 运行机制与体系结构"></a>1.3 运行机制与体系结构</h3><p><strong>运行机制</strong>：</p><ul><li><p>指令：处理器能够识别、执行的最基本命令</p><ul><li>特权指令：如内存清零指令(不允许用户程序使用)</li><li>非特权指令：如普通的运算指令</li></ul></li><li><p>判断是否可以执行特权指令可以通过<span style="color:red">两种处理器状态</span>：</p><ul><li>用户态(目态)：此时CPU只能执行非特权指令</li><li>核心态(管态)：特权和非特权都可以执行</li></ul><p>用程序状态寄存器(PSW)来标识当前处理器处于什么状态。如0为用户态，1为核心态</p></li><li><p>两种程序：</p><ul><li>内核程序：操作系统的内核程序是系统发管理者，运行在核心态</li><li>应用程序：为了保证系统的安全运行，普通应用程序只能运行在用户态</li></ul></li></ul><p><strong>操作系统内核</strong>又细分为：非内核功能和内核</p><ul><li>内核：计算机上配置的底层软件，是操作系统最基本、最核心的部分<ul><li>对系统资源进行管理功能(有的操作系统<strong>不会</strong>把这部分功能当作内核功能)：<ul><li>进程管理、存储器管理、设备管理等功能</li></ul></li><li>时钟管理：实现计时功能</li><li>中断处理：负责实现中断机制</li><li>原语(设备驱动、CPU切换等)<ul><li>一种特殊的程序。</li><li>是最接近硬件的部分，</li><li>这种程序的运行具有原子性(要么不执行，要么一直执行到结束)</li></ul></li></ul></li></ul><p><strong>操作系统的体系结构</strong>：大内核和微内核</p><ul><li><p>大内核：将操作系统的主要功能模块都作为系统内核，运行在核心态</p><p>优点：高性能</p><p>缺点：内核代码庞大、结构混乱、难以维护</p></li><li><p>微内核：只把最基本的功能保留在内核</p><p>优点：内核功能少、结构清晰、方便维护</p><p>缺点：需要频繁地在核心态和用户态之间切换、性能低</p></li></ul><h3 id="1-4-中断与异常"><a href="#1-4-中断与异常" class="headerlink" title="1.4 中断与异常"></a>1.4 中断与异常</h3><p>中断：</p><ul><li>当中断发生时，CPU立即进入核心态</li><li>当中断发生后，当前运行的进程暂停运行，并由操作系统内核对中断进行处理</li><li>对于不同的中断信号，会进行不同的处理</li></ul><p>发生了中断，就意味着需要操作系统介入，开展管理工作。由于操作系统的管理工作(比如进程切换、分配IO设备等)需要使用特权指令，因此CPU要从用户态转换为核心态。</p><p><span style="color:red">中断可以使CPU从用户态切换为核心态</span>，使用操作系统获得计算机的控制权。有了中断，才能实现多道程序并发执行</p><p>用户态与核心态的转换：</p><ul><li><p>用户态-&gt;核心态：通过<strong>中断实现</strong>的，并且只能是中断</p></li><li><p>核心态-&gt;用户态：通过<strong>执行一个特权指令</strong>，将程序状态标志设置为用户态</p></li></ul><p>中断的分类：</p><ul><li><p>内中断</p></li><li><p>外中断</p></li></ul><p>……</p><h1 id="二、进程与线程"><a href="#二、进程与线程" class="headerlink" title="二、进程与线程"></a>二、进程与线程</h1><p>OS中进程作为资源分配与独立运行的基本单位出现。OS的四大特征(并发、共享、虚拟、异步)都是基于进程而形成的。所以在OS中，进程是一个及其重要的概念</p><p>到了80年代中期，又出现了比进程更小的基本单位——线程。用来提高程序并发执行程度，以进一步改善系统的服务质量。现代OS无一例外的引入了线程，线程也是一个重要的概念</p><h3 id="2-1-进程的描述"><a href="#2-1-进程的描述" class="headerlink" title="2.1 进程的描述"></a>2.1 进程的描述</h3><h4 id="进程控制块PCB"><a href="#进程控制块PCB" class="headerlink" title="进程控制块PCB"></a>进程控制块PCB</h4><ul><li><p>为了方便控制和管理参与并发执行的每个程序的独立运行，在操作系统中为之配置一种专门的数据结构，称为进程控制块：PCB(Process Control Block)。</p></li><li><p>系统利用PCB来描述进程的基本信息与活动过程，进而控制和管理程。</p></li><li><p><span style="color:red">PCB、程序段、数据段</span>三部分构成了<span style="color:red">进程实体(进程映像)</span>，也叫<span style="color:red">进程</span></p></li></ul><h4 id="PCB在进程切换的作用"><a href="#PCB在进程切换的作用" class="headerlink" title="PCB在进程切换的作用"></a>PCB在进程切换的作用</h4><p>操作系统就是根据PCB来感知进程的存在的。</p><p>PCB在进程切换过程中起着非常重要的作用，操作系统可以通过对PCB的修改来达到对进程的控制。</p><img src="https://s2.loli.net/2023/02/09/ljsJmIT8xR4GD63.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/ljsJmIT8xR4GD63.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220919102403455.png" style="zoom: 67%;" /><p>以下是PCB结构体的部分描述属性：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line"><span class="type">long</span> state;              <span class="comment">// 进程运行状态：-1不可运行，0可运行，&gt;0已停止</span></span><br><span class="line"><span class="type">long</span> priority;           <span class="comment">// 进程运行优先级</span></span><br><span class="line"><span class="type">long</span> counter;   <span class="comment">// 已运行时间计数器</span></span><br><span class="line"><span class="type">long</span> exit_code;  <span class="comment">// 进程停止执行后退出码，其父进程需要读取</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> start_code;   <span class="comment">// 代码段起始地址</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> end_code;  <span class="comment">// 代码段长度，单位字节</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> next_code;    <span class="comment">// 下一条要执行代码的地址</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> start_data;   <span class="comment">// 数据段起始地址</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> end_data;     <span class="comment">// 代码段长度+数据段长度，单位字节</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> next_data;    <span class="comment">// 下一条要读取数据的地址</span></span><br><span class="line"><span class="type">long</span> pid; <span class="comment">// 进程标识</span></span><br><span class="line"><span class="type">long</span> father; <span class="comment">// 父进程标识</span></span><br><span class="line">...</span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure><h4 id="进程定义"><a href="#进程定义" class="headerlink" title="进程定义"></a>进程定义</h4><blockquote><p>从不同的角度，进程可以有不同的定义，比较传统典型的定义有：</p><ol><li>进程是程序的一次<strong>执行的过程</strong></li><li>进程是一个程序以及数据在处理顺序执行时所<strong>发生的活动</strong></li><li>进程是具有独立功能的程序在数据集合上的<strong>运行的过程</strong>，它是系统进行资源分配和调度的一个独立单位</li></ol><p>这3个定义都强调了**”动态性”**</p><p>引入进程实体的概念后，可以把<strong>进程定义</strong>为：</p><ul><li>进程是<span style="color:red">进程实体的运行程序</span>，是系统进行<span style="color:red">资源分配和调度</span>的一个独立单位</li></ul><p>注意：严格来说，<strong>进程实体</strong>和<strong>进程</strong>并不一样，进程实体是<span style="color:red">静态的</span>，进程则是<span style="color:red">动态的</span>。不过，除非题目刻意考察二者区别，否则是可以认为<strong>进程就是进程实体</strong></p></blockquote><p>引入进程后使得作业的并发执行得以实现，</p><p>同时也带来了一些问题：</p><ul><li>增加了空间开销<ul><li>需要为进程创建PCB</li></ul></li><li>增加了时间开销<ul><li>管理、协调、跟踪进程的执行需要时间 </li><li>创建、更新、回收PCB需要时间 </li><li>进程切换、保护、恢复CPU现场需要时间</li></ul></li><li>增加了控制难度<ul><li>协调多个进程对资源的竞争与共享增加了控制难度 </li><li>对可能由进程引发的异常进行处理增加了控制难度</li></ul></li></ul><h3 id="2-2-进程状态"><a href="#2-2-进程状态" class="headerlink" title="2.2 进程状态"></a>2.2 进程状态</h3><h4 id="五种状态"><a href="#五种状态" class="headerlink" title="五种状态"></a>五种状态</h4><p>根据进程所拥有资源的不同，可以将进程所处的状态划分为五种状态：</p><ul><li>就绪状态：进程已经获取到了除处理器之外执行所需的所有资源的状态。 </li><li>执行状态：进程已经获取到了包括处理器在内的执行所需的所有资源的状态。 </li><li>阻塞状态：进程在执行过程中因等待某事件的发生而无法继续执行的状态。 </li><li>创建状态：进程缺少完整PCB与运行所需资源的状态。</li><li>终止状态：进程释放所拥有资源的过程的状态。</li></ul><p>其中，就绪状态、执行状态、阻塞状态，称为进程的基本状态</p><h4 id="状态转换"><a href="#状态转换" class="headerlink" title="状态转换"></a>状态转换</h4><pre class="mermaid">flowchart LRA(创建状态)B(就绪状态)C(执行状态)D(阻塞状态)E(终止状态)A--资源分配-->B--获得CPU-->C--请求I/O-->DD--I/O完成-->BC--释放CPU-->BC--释放PCB-->E</pre><p>状态转换的特点： </p><ul><li><strong>创建</strong>好的进程直接到达的是<strong>就绪态</strong> </li><li><strong>就绪态</strong>进程无法直接转换为<strong>阻塞态</strong> </li><li><strong>阻塞态</strong>只能是进程执行过程中由于等待某事件的发生而引发的 </li><li>进程只能是在<strong>执行</strong>时<strong>终止</strong></li></ul><h4 id="挂起与激活"><a href="#挂起与激活" class="headerlink" title="挂起与激活"></a>挂起与激活</h4><h4 id="PCB的组织方式"><a href="#PCB的组织方式" class="headerlink" title="PCB的组织方式"></a>PCB的组织方式</h4><p>不同应用可以产生很多异类进程，一个应用可以产生很多同类进程。无论是何类进程，其会按照它们的 状态将它们组织到一起。</p><p>常见的组织方式有两种： </p><ul><li>链表方式：<strong>同一状态的进程的PCB组成一个链表</strong>，所以多种状态的进程PCB组成多个链表。此时就会产生诸如就绪链表、阻塞链表等不同链表。 </li><li>索引表方式：<strong>所有PCB都放入同一链表</strong>，再为<strong>每种状态创建出不同的PCB索引链表</strong>，其中存放的就是该状态的所有PCB的索引</li></ul><p>粗俗的理解就是，无论就绪队列，还是阻塞队列中的元素就是PCB</p><p><img src="https://s2.loli.net/2023/02/09/KeLwCMNEnAv7J6O.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/KeLwCMNEnAv7J6O.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220919183526346.png"></p><h3 id="2-3-进程控制"><a href="#2-3-进程控制" class="headerlink" title="2.3 进程控制"></a>2.3 进程控制</h3><p>进程控制是进程管理中最基本的功能。如，进程的创建与终止、进程状态转换等。进程控制一般是由 OS内核中的原语实现的。</p><p>进程控制就是实现进程状态的转换。</p><h4 id="进程的创建"><a href="#进程的创建" class="headerlink" title="进程的创建"></a>进程的创建</h4><p>无论是OS内核创建进程，还是用户进程创建子进程，都是调用了进程创建原语完成的。</p><p><strong>进程创建过程</strong></p><p><strong>进程创建原语</strong>的创建过程如下：</p><ul><li>生成进程标识符PID<ul><li>这是一个数字标识符，用于区分系统中的所有进程，在系统中具有唯一 性。</li></ul></li><li>申请空白PCB。</li><li>为进程分配其运行所需的一切资源(除CPU外)<ul><li>这些资源要么从OS直接获得，要么从父进程获 得。</li></ul></li><li>初始化PCB。<ul><li>这些初始化信息包括自己的PID及父进程的PID，当前处理器的状态数据，进程的状态数据。</li></ul></li><li>将进程写入就绪队列 (创建态-&gt;就绪态)</li></ul><p><strong>进程创建事件</strong></p><p>一个进程可以由系统内核创建，也可以由另一个进程创建。发生进程创建的典型事件有三类： </p><ul><li>用户登录：在分时系统中，用户登录后，系统内核会为该用户创建一个进程。 </li><li>作业调度：在多道批处理系统中，当作业调度程序调度到某作业后，会将其装入内存，并由系统 内核为该作业创建一个进程。 </li><li>提供服务：当某进程在运行过程中提出某种请求后，系统内核或主进程将会创建一个相应的子进程来处理该请求，以使主进程与子进程可以并发执行。<ul><li>例如，用户进程提交了一个文件打印请求后，系统内核会创建一个打印进程来处理该请求。</li></ul></li><li>应用请求：由用户主动请求创建一个子进程</li></ul><h4 id="进程的终止"><a href="#进程的终止" class="headerlink" title="进程的终止"></a>进程的终止</h4><p><strong>进程终止过程</strong> </p><p>系统中发生进程终止事件，OS就会调用进程终止原语去终止进程。</p><p><strong>进程终止原语</strong>的终止过程如下： </p><ul><li><p>根据被终止进程的PID，找出其PCB。 </p></li><li><p>从PCB中读取其状态，若该进程处于执行态，则立即终止其执行，并置调度标志为真，用于标志该进程可被重新调度。 </p></li><li><p>从PCB中读取其子进程PID，若该进程还有子进程，则要将其所有子进程全部终止。 </p></li><li><p>从PCB中读取其所拥有的全部资源，并全部释放，归还给其父进程或系统。 </p><p>这个资源释放的过程主要包含两步： </p><ul><li>将其PCB赋值为null </li><li>在其父进程或系统的资源数量上增加相应释放的数量。</li></ul></li><li><p>将该进程的PCB从PCB队列或链表中移出。 </p></li><li><p>释放该PCB空间。</p></li></ul><p>进程终止事件 </p><p>引起进程终止的事件典型的有三类： </p><ul><li><p>正常结束：进程的任务正常执行完毕后的进程终止。当进程的任务执行完毕后，进程会发出一条终止指令，此时会产生一个中断，以通知OS进程马上终止。 </p></li><li><p>异常结束：进程在运行过程中发生了某种异常事件，导致进程无法继续运行。 </p><p>常见的异常事件有： </p><ul><li>访问越界 </li><li>非法指令 </li><li>权限异常</li><li>运行超时 </li><li>等待超时 </li><li>运算异常 </li><li>IO异常</li></ul></li><li><p>外界干预：进程被外界干预终止。</p><p>外界干预主要指三方面：</p><ul><li>用户直接终止</li><li>OS终止</li><li>父进程终止</li></ul></li></ul><h4 id="进程的堵塞与唤醒"><a href="#进程的堵塞与唤醒" class="headerlink" title="进程的堵塞与唤醒"></a>进程的堵塞与唤醒</h4><p><strong>进程阻塞</strong></p><p>阻塞是进程自身的一种主动行为。当系统中发生进程阻塞事件后，进程自己会调用进程阻塞原语将自 己阻塞。</p><p><strong>进程阻塞原语</strong>的阻塞过程如下： </p><ol><li>立即暂停CPU的执行，保留当前CPU的现场。</li><li>将PCB中的状态由执行态修改为阻塞态。</li><li>将PCB写入到相应阻塞原因的阻塞队列。</li><li>启动调度程序进行重新调度，即将CPU分配给另一就绪进程。 </li><li>按照新进程的PCB设置CPU新的环境。</li></ol><p>引发进程阻塞的事件 </p><p>进程发生阻塞是由于**正在执行的进程突然发生执行条件缺失事件(需要等待系统分配资源和等待相互合作的进程的完成工作)**，进而暂停执行等待条件的满足</p><p><strong>进程唤醒</strong></p><p>进程唤醒过程 当被阻塞进程所期待的事件发生时，由“相关进程(促使执行条件满足的进程)”调用唤醒原语，将阻塞进程唤醒(唤醒是进程的被动行为)。</p><p><strong>进程唤醒原语</strong>的唤醒过程如下： </p><ol><li>将该进程的PCB从阻塞队列移出。</li><li>修改PCB中的状态由阻塞变为就绪。</li><li>将PCB插入到就绪队列</li></ol><p>阻塞进程被唤醒则是由于发生了某些事件，从而具备了执行条件，到达了执行时机。</p><h3 id="2-4-进程通信"><a href="#2-4-进程通信" class="headerlink" title="2.4 进程通信"></a>2.4 进程通信</h3><h4 id="共享存储"><a href="#共享存储" class="headerlink" title="共享存储"></a>共享存储</h4><p>为了保证安全，一个进程不能直接访问另一个进程的地址空间</p><ol><li><p>在通信的进程之间存在一块可直接访问的共享空间，通过对这片共享空间进行写&#x2F;读操作实现进程之间的信息交换。</p></li><li><p>两个进程对共享空间的访问必须是互斥的(互斥访问通过操作系统提供的工具实现)。</p><p>互斥访问就是在同一时间只能有一个进程对同一资源进行访问</p><p>操作系统只负责提供共享空间和同步互斥工具(如P、V操作)。</p></li><li><p>共享方式分为两种：</p></li></ol><ul><li><p>低级方式的共享是基于数据结构的共享</p><p><strong>基于数据结构的共享：</strong>比如共享空间里只能发放一个长度为10的数组，这种共享方式速度慢，限制多，是一种低级通信方式。</p></li><li><p>高级方式的共享则是基于存储区的共享</p><p><strong>基于存储区的共享：</strong>在内存中画出一块共享存储区，数据的形式、存放的位置都由进程决定，而不是操作系统。相比之下，这种共享方式速度更快，是一种高级通信方式。</p></li></ul><h4 id="管道通信"><a href="#管道通信" class="headerlink" title="管道通信"></a>管道通信</h4><ol><li><p>“管道”是指用于连接读写进程的一个共享文件，又名pipe文件，其实就是在内存中开辟的一个大小固定的缓冲区。</p></li><li><p>管道通信只能采用半双工通信，某一个时段内只能实现<strong>单向的传输</strong>，如果要实现双向同时通信，则需要<strong>设置两个管道</strong>。</p></li><li><p>各个进程要互斥的访问管道。write</p></li><li><p>数据以字符流的形式写入管道，当管道写满时，写进程的write()系统调用将被阻塞，等待读进程将数据取走。当读进程将数据全部取走后，管道变空，此时读进程的read()系统调用将被阻塞。</p><p><strong>注意：</strong>如果没有写满，是不允许读的，如果没有读空，是不允许写的。</p></li><li><p>数据一旦被读出，就会从管道中被抛弃，这就意味着读进程最多只能有一个，否则可能会有读错数据的情况。</p></li></ol><h4 id="消息传递"><a href="#消息传递" class="headerlink" title="消息传递"></a>消息传递</h4><p>进程间的数据交换以<strong>格式化的消息</strong>(Message)为单位。</p><p>进程通过操作系统提供的”发送消息&#x2F;接收消息”两个<strong>原语进行数据交换</strong></p><p>格式化的消息分为：消息头和消息体</p><ul><li>消息头：包括发送的进程ID、接受进程ID、消息类型、消息长度等格式化信息</li></ul><p>直接通信方式：A进程发送消息(原语)直接挂到接收进程B的<strong>消息缓冲队列</strong>上</p><p>间接通信方式：发送消息(原语)要先发送到**中间实体(信箱)**中，因此也称”信箱通信方式”。如：计网中的电子邮箱系统</p><h3 id="2-5-线程的描述"><a href="#2-5-线程的描述" class="headerlink" title="2.5 线程的描述"></a>2.5 线程的描述</h3><h4 id="为什么要引入线程"><a href="#为什么要引入线程" class="headerlink" title="为什么要引入线程"></a>为什么要引入线程</h4><ol><li><p>进程是资源分配的基本单位，也是调度的基本单位</p><p>引入线程之后，线程是CPU调度的基本单位</p></li><li><p>由于切换进程时，需要保存&#x2F;恢复进程运行环境，还需要切换内存地址空间(更新快表、更新缓冲)</p><p>引入线程后，同一个进程内各个线程间并发，不需要切换进程运行环境和内存地址空间，省时省力。</p><p><strong>注意：</strong>从属于不同进程的线程间的切换，也会导致进程的切换，开销也大</p></li><li><p>引入进程的目的是：</p><ul><li>为了更好的让多道程序并发执行，提高资源利用率和系统吞吐量</li><li>为了减少程序在并发执行时所付出的时空开销，提高操作系统的并发性能。</li></ul></li></ol><p>进程可能需要”同时”做很多事情，而传统的进程只能</p><h4 id="线程的特点"><a href="#线程的特点" class="headerlink" title="线程的特点"></a>线程的特点</h4><ol><li><p><strong>各个进程的内存地址空间相互独立</strong>，只能通过请求操作系统内核的帮助来完成进程之间的通信。</p><p>但<strong>同一个进程下的各个线程之间共享内存地址空间</strong>，可以直接通过读&#x2F;写内存空间进行通信。</p></li><li><p>从属于同一个进程各个线程共享进程的所有资源。</p></li><li><p><strong>进程之间的通信</strong>必须请求操作系统服务(CPU要求换到核心态)，<strong>开销大</strong>。</p><p><strong>同进程下的线程间通信</strong>不需要操作系统干预，<strong>开销更小</strong>。</p></li><li><p>引入线程前，进程既是资源分配的基本单位，也是调度的基本单位。</p><p>但是引入线程后，<strong>进程是资源分配的基本单位</strong>，而<strong>线程是调度的基本单位</strong>。同样线程也有运行态，就绪态和阻塞态。</p><p>而线程几乎不拥有资源，只拥有极少量的资源(线程控制块TCB、寄存器信息、堆栈等)</p></li><li><p>在多核CPU环境下，各个线程也可以分配到不同的CPU上并行的执行。</p></li></ol><h3 id="2-6-线程的实现方式"><a href="#2-6-线程的实现方式" class="headerlink" title="2.6 线程的实现方式"></a>2.6 线程的实现方式</h3><p>线程分为：用户级线程和内核级线程</p><h4 id="用户级线程"><a href="#用户级线程" class="headerlink" title="用户级线程"></a>用户级线程</h4><ol><li><p>用户级线程由应用程序通过<strong>线程库</strong>实现，所有的<strong>线程管理工作都由应用程序负责</strong>(包括线程切换)</p></li><li><p>用户级线程中，线程切换可以在用户态下即可完成，无需操作系统干预。</p></li><li><p>在用户看来，是有多个线程，但是在操作系统的内核来看，并不意识到线程的存在。</p><p>“用户级线程”就是从用户视角所能看到的线程。</p></li><li><p>优点：用户级线程的切换在用户空间即可完成，<strong>不需要切换到核心态</strong>，线程管理的系统开销小，效率高。</p></li><li><p>缺点：当一个用户级线程被阻塞后，<strong>整个线程都会被阻塞，并发度不高</strong>。多个线程必须在多核处理机上并行运行。</p></li><li><p>在用户级线程中，<strong>CPU调度的基本单位依旧是进程</strong>，并非线程</p></li></ol><p>​</p><h4 id="内核级线程"><a href="#内核级线程" class="headerlink" title="内核级线程"></a>内核级线程</h4><ol><li><p>内核级线程：又称”内核支撑的线程”，是由操作系统支撑的线程。</p><p>大多数的现代操作系统都实现了内核级线程，如Windows、Linux。</p></li><li><p>内核级线程的管理工作是<strong>由操作系统内核完成</strong>。</p></li><li><p>线程调度和切换等工作都是由内核负责，因此内核级线程的切换必然需要在核心态下才能完成。</p></li><li><p>操作系统会为**每个内核级线程建立相应的TCB(进程控制块)**，通过TCB对线程进行管理”。</p></li><li><p>“内核级线程”就是从操作系统内核视角看到的线程。</p></li><li><p>优点：当一个线程被阻塞后，别的线程还可以继续执行，<strong>并发能力强</strong>。<strong>多线程可在多核处理机上并行执行</strong>。</p></li><li><p>缺点：<strong>一个用户进程会占用多个内核程序</strong>，<strong>线程切换</strong>由操作系统内核完成，<strong>需要从用户态变为核心态</strong>，因此线程管理的成本高，<strong>开销大</strong>。</p></li></ol><h3 id="2-7-多线程模型"><a href="#2-7-多线程模型" class="headerlink" title="2.7 多线程模型"></a>2.7 多线程模型</h3><h4 id="一对一模型"><a href="#一对一模型" class="headerlink" title="一对一模型"></a>一对一模型</h4><p>一对一模型：</p><ul><li>一个用户及线程映射到一个肉核级线程。每个用户进程有与用户级线程同数量的内核级线程。</li><li>优点：当一个线程被阻塞后，别的线程还可以继续执行，并发能力强。多线程可在多核处理机上并行执行。</li><li>缺点：一个用户进程会占用多个内核级线程，线程切换由操作系统内核完成，需要切换到核心态，因此线程管理的成本高，开销大。</li></ul><img src="https://s2.loli.net/2023/02/09/2Mc3U8VPFs5GtOb.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/2Mc3U8VPFs5GtOb.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220920140036089.png" style="zoom:50%;" /><h4 id="多对一模型"><a href="#多对一模型" class="headerlink" title="多对一模型"></a>多对一模型</h4><p>多对一模型：</p><ul><li>多个用户及线程映射到一个内核级线程。每个用户进程只对应一个内核级<br>线程。</li><li>优点：用户级线程的切换在用户空间即可完成，不需要切换到核心态，线程管理的系统<br>开销小，效率高</li><li>缺点：当一个用户级线程被阻塞后，整个进程都会被阻塞，并发度不高。多个线程不可在多核处理机上并行运行</li></ul><img src="https://s2.loli.net/2023/02/09/wLanIfW2PANyGeO.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/wLanIfW2PANyGeO.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220920140146980.png" style="zoom: 50%;" /><h4 id="多对多模型"><a href="#多对多模型" class="headerlink" title="多对多模型"></a>多对多模型</h4><p>多对多模型：</p><ul><li>n用户及线程映射到m个内核级线程(n&gt;&#x3D;m)。每个用户进程对应m个内核级线程。</li><li>克服了多对一模型并发度不高的缺点，又克服了一对一模型中一个用户进程占用太多内核级线程，开销太大的缺点。</li></ul><img src="https://s2.loli.net/2023/02/09/7g9jb2dYlTZQqmA.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/7g9jb2dYlTZQqmA.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220920140239032.png" style="zoom:50%;" /><h3 id="2-8-处理机调度"><a href="#2-8-处理机调度" class="headerlink" title="2.8  处理机调度"></a>2.8  处理机调度</h3><ol><li><p>当有一堆任务要处理，但由于资源有限，这些事情没法同时处理。这就需要确定某种规则(时间短优先、先来先服务等)来决定这些任务的顺序，这就是“调度”研究的问题。</p></li><li><p>在多道程序系统中，进程的数量往往是多于处理机的个数的，这样不可能同时并行的处理各个进程。</p><p>处理机调度：就是从就绪队列中按照一定的算法选择一个进程并将处理机分配给它运行，以实现进程的并发执行。</p></li></ol><h4 id="高级调度"><a href="#高级调度" class="headerlink" title="高级调度"></a>高级调度</h4><p>高级调度是，也称为作业调度，根据不同的作业调度算法，将磁盘中后备队列中的不同的若干作业调入 内存的过程。作业一旦被调入内存，就会将其创建为进程，并为之分配必要的资源，进入就绪队列。</p><ul><li>高级调度，主要存在于多道批处理系统，实时系统与分时系统中没有该调度方式</li></ul><h4 id="中级调度"><a href="#中级调度" class="headerlink" title="中级调度"></a>中级调度</h4><p>中级调度，也称为内存调度，也是OS中最基本的一种调度，是为提高内存利用率与系统吞吐量而引入 的一类调度。其功能是，将内存中暂时不能运行的进程，调到外存等待。当具备运行条件且内存有空闲 时，再根据不同的调度算法将其重新调入到内存。</p><ul><li>中级调度，无论是多道批处理系统，还是分时系统、实时系统，都存在该调度方式</li></ul><h4 id="低级调度"><a href="#低级调度" class="headerlink" title="低级调度"></a>低级调度</h4><p>低级调度是，也称为进程调度，是OS中最基本的一种调度，是一个根据不同的进程调度算法，选择不 同的进程为其分配处理机的过程。</p><ul><li>低级调度，无论是多道批处理系统，还是分时系统、实时系统，都存在该调度方式</li></ul><h3 id="2-9-进程调度"><a href="#2-9-进程调度" class="headerlink" title="2.9 进程调度"></a>2.9 进程调度</h3><h4 id="进程调度的时机"><a href="#进程调度的时机" class="headerlink" title="进程调度的时机"></a>进程调度的时机</h4><p>进程调度(低级调度)，就是按照某种算法从就绪队列中选择一个进程为其分配处理机。</p><p><strong>需要进行进程调度</strong>与切换的情况：</p><ul><li>当前运行的进程<strong>主动放弃</strong>处理机<ul><li>进程正常终止</li><li>运行过程中发生异常而终止</li><li>进程主动请求阻塞，如等待I&#x2F;O</li></ul></li><li>当前运行的进程<strong>被动放弃</strong>处理机<ul><li>分给进程的时间片用完</li><li>有更紧急的事需要处理，如I&#x2F;O中断</li><li>有更高优先级的进程进入就绪队列</li></ul></li></ul><p>不能进行进程调度与切一换的情况：</p><ul><li>在<strong>处理中断的过程</strong>中。中断处理过程复杂，与硬件密切相关，很难做到在中断处理过程中进行进程切换。</li><li>进程在<strong>操作系统内核程序临界区</strong>中。</li><li>在<strong>原子操作过程</strong>中(原语)。原子操作不可中断，要一气呵成。如之前讲过的修改PCB中进程状态标志，并把PCB放到相应队列</li></ul><h4 id="进程调度的方式"><a href="#进程调度的方式" class="headerlink" title="进程调度的方式"></a>进程调度的方式</h4><ul><li><p><strong>非剥夺调度方式</strong>，又称非抢占方式：</p><p>即，只允许进程主动放弃处理机。在运行过程中即便有更紧迫的任务到达，当前进程依然会继续使用处理机，直到该进程终止或主动要求进入阻塞态。<br>特点：实现简单，系统开的小但是无法及时处理紧急任务，适合于早期的批处理系统</p></li><li><p><strong>剥夺调度方式</strong>，又称抢占方式：</p><p>当一个进程正在处理机上执行时，如果有一个更重要或更紧迫的进程需要使用处理机，则立即暂停正在执行的进程，将处理机分配给更重要紧迫的那个进程。<br>特点：可以优先处理更紧急的进程，也可实现让各进程按时间片轮流执行的功能(通过时钟中断)。适合于分时操作系统、实时操作系统</p></li></ul><h4 id="进程的切换与过程"><a href="#进程的切换与过程" class="headerlink" title="进程的切换与过程"></a>进程的切换与过程</h4><p>“<strong>狭义的进程调度”与“进程切换”的区别：</strong></p><ul><li><p><strong>狭义的进程调度</strong>：指的是从就绪队列中选中一个要运行的进程(这个进程可以是刚刚被暂停执行的进程，也可能是另一个进程，后一种情况就需要进程切换)</p></li><li><p><strong>进程切换</strong>：是指一个进程让出处理机，由另一个进程占用处理机的过程。</p></li><li><p><strong>广义的进程调度</strong>：包含了选择一个进程和进程切换两个步骤。</p></li></ul><p><strong>进程切换过程完成后：</strong></p><ul><li><p>对原来运行进程各种数据的保存</p></li><li><p>对新的进程各种数据的恢复</p><p>如：程序计数器、程序状态字、各种数据寄存器等处理机现场信息，这些信息一班保存在进程控制块PCB中</p></li></ul><p>注意：<strong>进程切换是有代价的</strong>，不能说进程切换越频繁系统并发性就越好，因为如果<strong>过于频繁的进行进程调度、切换</strong>，必然会使得<strong>整个系统的效率降低</strong>，使得系统大部分时间都花在了进程的切换上，而真正<strong>用于执行进程的时间减少</strong>。</p><h3 id="2-10-调度算法"><a href="#2-10-调度算法" class="headerlink" title="2.10 调度算法"></a>2.10 调度算法</h3><h4 id="调度算法的评价指标"><a href="#调度算法的评价指标" class="headerlink" title="调度算法的评价指标"></a>调度算法的评价指标</h4><p>调度算法的评价指标主要有：CPU利用率，系统吞吐量、周转时间、等待时间和响应时间</p><ul><li><p><strong>CPU利用率</strong>：指的是CPU”忙碌”的时间占总时间的比例</p><ul><li><code>利用率 = CPU忙碌的时间 / 总时间</code></li></ul></li><li><p><strong>系统吞吐量</strong>：单位时间内完成作业的数量</p><ul><li><code>系统吞吐量 = 总共完成了多少道作业 / 总共花了多少时间</code></li></ul></li><li><p><strong>周转时间</strong>：是指从作业被提交给系统开始，到作业完成为止的这段时间间隔</p><ul><li><p><code>周转时间 = 作业完成时间 - 作业提交时间</code></p><p>对于用户，更关心自己的单个作业的周转时间</p></li><li><p><code>平均周转时间 = 各个作业周转时间之和 / 作业数</code></p><p>对于操作系统，更关心系统的整体表现，因此更关心所有作业的周转时间的平均值</p></li><li><p><code>带权周转时间 = 作业周转时间 / 作业实际运行时间</code></p><p>​   <code>= (作业完成时间 - 作业提交时间) / 作业实际运行时间</code></p><p>带权周转时间与周转时间都是越小越好(带权周转时间必然 &gt;&#x3D; 1)</p></li><li><p><code>平均带权周转时间 = 各个带权周转时间之和 / 作业数</code></p></li></ul></li><li><p>等待时间：指进程&#x2F;作业<strong>处于等待处理机状态时间之和</strong>，等待时间越短，用户越满意</p><ul><li>对于<strong>进程</strong>来说，等待时间就是指<strong>进程建立后等待被服务的时间之和</strong>，在等待I&#x2F;O完成的期间其实进程也是被服务的，所以不计入等待时间。</li><li>而对于<strong>作业</strong>来说，<strong>不仅要考虑建立进程后的等待时间，还要加上作业在外存后备队列中的等待时间</strong>。</li><li>一个作业总共需要被CPU服务多久，被I&#x2F;O设备服务多久一般是确定不变的，因此调度算法其实只能影响作业或者进程的等待时间。当然，与前面指标类似，也有”平均等待时间”来评价整体性能。</li></ul></li><li><p>响应时间：指从用户请求到首次产生响应所用的时间</p></li></ul><h4 id="调度算法一"><a href="#调度算法一" class="headerlink" title="调度算法一"></a>调度算法一</h4><p>**先来先服务(FCFS)**：</p><p>例题：各进程到达就绪队列的时间、需要的运行时间如下表所示。使用<strong>先来先服务调度算法</strong>，计算各进程的等待时间、平均等待时间、周转时间、平均周转时间、带权周转时间、平均带权周转时间。</p><table><thead><tr><th>进程</th><th>到达时间</th><th>运行时间</th><th>开始运行时间</th></tr></thead><tbody><tr><td>p1</td><td>0</td><td>7</td><td>0</td></tr><tr><td>p2</td><td>2</td><td>4</td><td>7 &#x3D; 7</td></tr><tr><td>p3</td><td>4</td><td>1</td><td>7 + 4 &#x3D; 11</td></tr><tr><td>p4</td><td>5</td><td>4</td><td>7 + 4 + 1 &#x3D; 12</td></tr></tbody></table><p>先来先服务调度算法：按照到达的先后顺序调度,,事实上就是等待时间越久的越优先得到服务。</p><p>调度顺序：p1-&gt;p2-&gt;p3-&gt;p4</p><img src="https://s2.loli.net/2022/10/25/25YZy6GBnEqRkl4.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/25/25YZy6GBnEqRkl4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2022-10-25_11-01-04.png" style="zoom:67%;" /><p>周转时间&#x3D;完成时间-到达时间</p><p>带权周转时间&#x3D;周转时间&#x2F;运行时间</p><p>等待时间&#x3D;周转时间-运行时间</p><p>平均周转时间&#x3D;(7+9+8+11)&#x2F;4&#x3D;8.75</p><p>平均带权周转时间&#x3D;(1+2.25+8+2.75)&#x2F;4&#x3D; 3.5</p><p>平均等待时间&#x3D;(0+5+7+7)&#x2F;4 &#x3D; 4.75</p><p>FCFS算法：</p><blockquote><p>算法思想：主要从“公平”的角度考虑(类似于我们生活中排队买东西的例子)</p><p>算法规则：按照作业&#x2F;进程到达的先后顺序进行服务</p><p>用于作业&#x2F;进程调度：用于作业调度时，考虑的是哪个作业先到达后备队列；用于进程调度时，考虑的是哪个进程先到达就绪队列</p><p>是否可抢占：非抢占式的算法</p><p>优缺点：</p><ul><li><p>优点:公平、算法实现简单</p></li><li><p>缺点:排在长作业(进程)后面的短作业需要等待很长时间，带权周转时间很大，对短作业来说用户体验不好。即，FCFS算法对长作业有利，对短作业不利(Eg :排队买奶茶…)</p></li></ul><p>是否会导致饥饿(某进程&#x2F;作业长期得不到服务)：不会</p></blockquote><p>**短作业优先(SJF)**：</p><p>一个作业可以由多个进程组成,且一个作业至少由一个进程组成</p><p><strong>1.非抢占式的短作业优先算法</strong></p><p>例题：各进程到达就绪队列的时间、需要的运行时间如下表所示。使用非抢占式的短作业优先调度算法，计算各进程的等待时间、平均等待时间、周转时间、平均周转时间、带权周转时间、平均带权周转时间。</p><table><thead><tr><th>进程</th><th>到达时间</th><th>运行时间</th><th>开始运行时间</th></tr></thead><tbody><tr><td>p1</td><td>0</td><td>7</td><td>0</td></tr><tr><td>p2</td><td>2</td><td>4</td><td>7 + 1 &#x3D; 8</td></tr><tr><td>p3</td><td>4</td><td>1</td><td>7 &#x3D; 7</td></tr><tr><td>p4</td><td>5</td><td>4</td><td>7 + 4 + 1 &#x3D; 12</td></tr></tbody></table><p>短作业&#x2F;进程优先调度算法:每次调度时选择当前已到达且运行时间最短的作业&#x2F;进程。</p><p>因此，调度顺序为：p1-&gt;p3-&gt;p2-&gt;p4</p><img src="https://s2.loli.net/2022/10/25/gcrIE1fyKpzXD4Z.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/25/gcrIE1fyKpzXD4Z.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2022-10-25_16-14-32.png" style="zoom:67%;" /><p>周转时间&#x3D;完成时间-到达时间</p><p>带权周转时间&#x3D;周转时间&#x2F;运行时间</p><p>等待时间&#x3D;周转时间-运行时间</p><p>平均周转时间&#x3D; (7+4+10+11)&#x2F;4 &#x3D; 8</p><p>平均带权周转时间&#x3D; (1+4+2.5+2.75)&#x2F;4&#x3D; 2.56</p><p>平均等待时间&#x3D;(0+3+6+7)&#x2F;4&#x3D; 4</p><p>对比FCFS算法的结果，显然SPF算法的平均等待&#x2F;周转&#x2F;带权周转时间都要更低</p><p><strong>2.抢占式的短作业优先算法(又称最短剩余时间优先算法 SRTN)</strong></p><p>例题：各进程到达就绪队列的时间、需要的运行时间如下表所示。使用抢占式的短作业优先调度算法,计算各进程的等待时间、平均等待时间、周转时间、平均周转时间、带权周转时间、平均带权周转时[间。</p><table><thead><tr><th>进程</th><th>到达时间</th><th>运行时间</th><th>开始运行时间</th></tr></thead><tbody><tr><td>p1</td><td>0</td><td>7</td><td><code>0~2，11~16</code></td></tr><tr><td>p2</td><td>2</td><td>4</td><td><code>2~4，5~7</code></td></tr><tr><td>p3</td><td>4</td><td>1</td><td><code>4~5</code></td></tr><tr><td>p4</td><td>5</td><td>4</td><td><code>7~11</code></td></tr></tbody></table><img src="https://s2.loli.net/2022/10/25/qFZMEV1vx4TWeun.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/25/qFZMEV1vx4TWeun.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2022-10-25_16-38-13.png" style="zoom:67%;" /><p>最短剩余时间优先算法:每当有进程加入就绪队列改变时就需要调度，如果<strong>新到达的进程剩余时间</strong>比<strong>当前运行的进程剩余时间</strong>更<strong>短</strong>，则由新进程抢占处理机，当前运行进程重新回到就绪队列。另外，当一个进程完成时也需要调度</p><p>周转时间&#x3D;完成时间-到达时间</p><p>带权周转时间&#x3D;周转时间&#x2F;运行时间</p><p>等待时间&#x3D;周转时间-运行时间</p><p>平均周转时间&#x3D;(16+5+1+6)&#x2F;4 &#x3D; 7</p><p>平均带权周转时间&#x3D;(2.28+1.25+1+1.5)&#x2F;4&#x3D; 1.50</p><p>平均等待时间&#x3D;(9+1+0+2)&#x2F;4&#x3D; 3</p><p>对比非抢占式的短作业优先算法，显然抢占式的这几个指标又要更低</p><p>短作业优先算法：</p><blockquote><p>算法思想： 追求平均等待时间，平均周转时间，平均带权周转时间最短</p><p>算法规则：<strong>服务时间最短</strong>的优先得到服务</p><p>作业调度：SJF短作业优先</p><p>进程调度：SPF短进程优先</p><p>是否抢占式：</p><ul><li>SJF和SPF是非抢占式的算法。</li><li>但是也有抢占式的版本——最短剩余时间优先算法SRTM</li></ul><p>优缺点：</p><ul><li><p>优点：“最短的”平均等待时间、平均周转时间(前提是所有进程同时可运行或者说所有进程几乎都同时到达)因为最短剩余时间优先算法得到的平均等待时间、平均周转时间还要更少</p></li><li><p>缺点：<strong>不利于长作业，对短作业有利</strong>，由此可能产生饥饿现象</p></li></ul><p>是否导致饥饿：会，当短作业&#x2F;进程不断到来会导致长作业&#x2F;进程长时间得不到服务</p></blockquote><p>**高响应比优先(HRRN)**：</p><p>例题：各进程到达就绪队列的时间、需要的运行时间如下表所示。使用高响应比优先调度算法，计算各进程的等待时间、平均等待时间、周转时间、平均周转时间、带权周转时间、平均带权周转时间。</p><table><thead><tr><th>进程</th><th>到达时间</th><th>运行时间</th></tr></thead><tbody><tr><td>p1</td><td>0</td><td>7</td></tr><tr><td>p2</td><td>2</td><td>4</td></tr><tr><td>p3</td><td>4</td><td>1</td></tr><tr><td>p4</td><td>5</td><td>4</td></tr></tbody></table><p>高响应比优先算法:非抢占式的调度算法，只有当前运行的进程主动放弃CPU时(正常&#x2F;异常完成，或主动阻塞)，才需要进行调度，调度时计算所有就绪进程的响应比，选响应比最高的进程上处理机。</p><ul><li><code>响应比=(等待时间+要求服务时间)/要求服务时间</code></li></ul><blockquote><p>0时刻：只有p1到达就绪队列，p1上处理机</p><p>7时刻(P1主动放弃CPU)：就绪队列中的响应比：<code>p2：(5+4)/4=2.25</code>、<code>p3：(3+1)/1=4</code>、<code>p4：(2+4)/4=1.5</code></p><p>8时刻(P3完成)：响应比：<code>P2：(6+4)/4=2.5</code>、<code>P4：(3+4)/4=1.75</code></p><p>12时刻(P2完成)：就绪队列中只剩下P4</p></blockquote><p>高响应比优先调度算法：</p><blockquote><p>算法思想：要综合考虑作业&#x2F;进程的等待时间和要求服务的时间</p><p>算法规则：</p><ul><li><p>在每次调度时先计算各个作业&#x2F;进程的响应比，选择响应比最高的作业&#x2F;进程为其服务要求服务时间</p></li><li><p>响应比&#x3D;  -等待时间+要求服务时间</p></li></ul><p>用于作业&#x2F;进程调度：即可用于作业调度，也可用于进程调度</p><p>是否可抢占：非抢占式的算法。因此只有当前运行的作业&#x2F;进程主动放弃处理机时，才需要调度，才需要计算响应比</p><p>优缺点：综合考虑了等待时间和运行时间(要求服务时间)等待时间相同时，要求服务时间短的优先( SJF的优点)要求服务时间相同时，等待时间长的优先(FCFS的优点)对于长作业来说，随着等待时间越来越久，其响应比也越来越大，从而避免了长作业饥饿的问题</p><p>是否会导致饥饿：不会</p></blockquote><h4 id="调度算法二"><a href="#调度算法二" class="headerlink" title="调度算法二"></a>调度算法二</h4><p>时间片轮转法：</p><p>例题：各进程到达就绪队列的时间、需要的运行时间如下表所示。使用<strong>时间片轮转调度</strong>算法，分析时间片大小分别是2、5时的进程运行情况</p><table><thead><tr><th>进程</th><th>到达时间</th><th>运行时间</th></tr></thead><tbody><tr><td>p1</td><td>0</td><td>5</td></tr><tr><td>p2</td><td>2</td><td>4</td></tr><tr><td>p3</td><td>4</td><td>1</td></tr><tr><td>p4</td><td>5</td><td>6</td></tr></tbody></table><p>时间片轮转调度算法：轮流让就绪队列中的进程依次执行一个时间片(每次选择的都是排在就绪队列队头的进程)</p><p>时间片大小为5</p><blockquote><p>0时刻(p1(5))：只有p1到达，p1上处理机</p><p>2时刻(p2(4))：p2到达，但P1时间片尚未结束，因此暂不调度</p><p>4时刻(p2(4)-&gt;p3(1))：p3到达，但p1时间片尚未结束，因此暂不调度</p><p>5时刻(p2(4)-&gt;p3(1)-&gt;p4(6))：p4到达，同时，p1运行结束。发生调度，p2上处理机</p><p>9时刻(p3(1)-&gt;P4(6)：p2运行结束，虽然时间片没用完，但是会主动放弃处理机。发生调度</p><p>10时刻(p4(6))：p3运行结束，虽然时间片没用完，但是会主动放弃处理机。发生调度。</p><p>15时刻()：p4时间片用完，但就绪队列为空，因此会让p4继续执行一个时间片。</p><p>16时刻()：p4运行完，主动放弃处理机。所有进程运行完。</p></blockquote><blockquote><p>算法思想：公平地、轮流地为各个进程服务，让每个进程在一定时间可隔内都可以得到响应</p><p>算法规则：按照各进程到达就绪队列的顺序，轮流让各个进程执行一个时间片（如100ms）。若进程未在一个时间片内执行完则剥夺处理机，将进程重新放到就绪队列队尾重新排队</p><p>用于作业&#x2F;进程调度：用于进程调度（只看作亚放入内存建立了相应的进程后，不能被分配处理机时间片）</p><p>是否可抢占：若进程来能在时间片内运行完，将被强行刺夺处理机使用权，因此时间片轮转调度算法属于抢占式的算法。由时钟装置发出时钟中断来通知CPU时间片已到</p><p>优缺点：</p><ul><li>优点：公平：响应快，适用于分时操作系统</li><li>缺点：由于高频率的进程切换，因此有一定开销：不区分任务的紧急程度。</li></ul><p>是否会导致机饿：不会</p><p>补充：时间片太大或太小分别有什么影</p></blockquote><p>优先级调度算法：</p><p><strong>1.非抢占式的优先级调度算法</strong></p><p><strong>2.抢占式的优先级调度算法</strong></p><p>多级反馈队列调度算法</p><p>……</p><h3 id="2-11-进程同步"><a href="#2-11-进程同步" class="headerlink" title="2.11 进程同步"></a>2.11 进程同步</h3><h4 id="进程同步"><a href="#进程同步" class="headerlink" title="进程同步"></a>进程同步</h4><p>进程具有异步性的特征。异步性是指，并发执行的进程以各自独立的、不可预知的速度向前推进。而进程同步就是用来解决这种异步问题。</p><p>同步也称直接制约关系，它是指为完成某种任务而建立的两个或多个进程，这些进程因为需要在某些位置上<strong>协调</strong>它们<strong>工作次序</strong>而产生的制约关系。进程间的<strong>直接制约关系</strong>是源于他们之间的相互合作。</p><h4 id="进程互斥"><a href="#进程互斥" class="headerlink" title="进程互斥"></a>进程互斥</h4><p>我们把一个时间段内只允许一个进程使用的资源称为临界资源。许多物理设备（比如摄像头、打印机）都属于临界资源。此外还有许多变量、数据、内存缓冲区都属于临界资源。</p><p>对临界资源的访问，必须互斥的进行。互斥，也称间接制约关系。进程互斥指的是当一个进程访问某个临界资源时，另一个想要访问的该临界资源的进程必须等待。当前访问临界资源的进程访问结束，释放该资源之后，另一个进程才能访问该临界资源。</p><p>对临界资源的互斥访问，可以在逻辑上分为如下四个部分：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line">entry section;<span class="comment">//进入区</span></span><br><span class="line">critical section;<span class="comment">//临界区</span></span><br><span class="line"><span class="built_in">exit</span> section;<span class="comment">//退出区</span></span><br><span class="line">remainder section;<span class="comment">//剩余区</span></span><br><span class="line">&#125;<span class="keyword">while</span>(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure><ul><li>进入区：负责检查是否可以进入临界区，若可以进入，则应设置<strong>正在访问临界资源的标志</strong>(可以理解为”上锁”)，以阻止其他进行同时进入临界区</li><li>临界区：访问临界资源的那段代码</li><li>退出区：负责解除正在访问临界资源的标志(可理解为”解锁”)</li><li>剩余区：做其他处理</li></ul><p>注意：</p><blockquote><p>临界区是进程中访问临界资源的代码段</p><p>进入区和退出区是负责实现互后的代码段</p><p>临界区也可称为”临界段”</p></blockquote><p>为了实现对临界资源的互斥访问，同时保证系统整体性能， 需要遵循以下原则：</p><ol><li><strong>空闲让进</strong>。临界区空闲时，可以元许一个请求进入临界区的进程立即进入临界区；</li><li><strong>忙则等待</strong>。当己有进程进入临界区时，其他试图进入临界区的进程必须等待；</li><li><strong>有限等待</strong>。对请求访问的进程，应保证能在有限时间内进入临界区(保证不会饥饿)；</li><li><strong>让权等待</strong>。当进程不能进入临界区时，应立即释放处理机，防止进程忙等待。</li></ol><h3 id="2-12-进程互斥的软件实现"><a href="#2-12-进程互斥的软件实现" class="headerlink" title="2.12 进程互斥的软件实现"></a>2.12 进程互斥的软件实现</h3><h4 id="单标志法"><a href="#单标志法" class="headerlink" title="单标志法"></a>单标志法</h4><p>算法思想：两个进程在访问完临界区后会把使用临界区的权限转交给另一个进程。也就是说每个进程<br>进入临界区的权限只能被另一个进程赋予</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> turn = <span class="number">0</span>;<span class="comment">//turn 表示当前允许进入临界区的进程号</span></span><br></pre></td></tr></table></figure><p>p0进程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (turn != <span class="number">0</span>);<span class="comment">//进入区</span></span><br><span class="line">critical section;<span class="comment">//临界区</span></span><br><span class="line">turn = <span class="number">1</span>;<span class="comment">//退出区</span></span><br><span class="line">remainder section;<span class="comment">//剩余区</span></span><br></pre></td></tr></table></figure><p>p1进程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (turn != <span class="number">1</span>);      <span class="comment">//进入区，如果不为1，则一直卡在while循环中，等待</span></span><br><span class="line">critical section;<span class="comment">//临界区</span></span><br><span class="line">turn = <span class="number">0</span>;               <span class="comment">//退出区</span></span><br><span class="line">remainder section;<span class="comment">//剩余区</span></span><br></pre></td></tr></table></figure><p>turn 表示当前允许进入临界区的进程号，而只有当前允许进入临界区的进程在访问了临界区之后，才会修改 turn 的值。也就是说，对于临界区的访问，一定是按p0-&gt;p1-&gt;p0-&gt;p1-&gt;…这样轮流访问。</p><p>这种必须 “轮流访问”带来的问题是，如果此时允许进入临界区的进程是p0，而p0一直不访问临界区，那么虽然此时临界区空闲，但是并不允许p1访问。</p><p><strong>单标志法存在的主要问题：违背”空闲让进”的原则</strong></p><h4 id="双标志先检查法"><a href="#双标志先检查法" class="headerlink" title="双标志先检查法"></a>双标志先检查法</h4><p>算法思想：设置一个布尔型数组 flag[]，数组中各个元素用来标记各进程想进入临界区的意愿，<br>比如”flag[0]&#x3D;ture”意味着0号进程p0现在想要进入临界区。每个进程在进入临界区之前先检套当前有没有别的进程想进入临界区，如果没有，则把自身对应的标志 flag[i] 设为true，之后开始访问临界区。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> flag[<span class="number">2</span>];<span class="comment">//表示进入临界区意愿的数组</span></span><br><span class="line">flag [<span class="number">0</span>] = <span class="literal">false</span>;</span><br><span class="line">flag [<span class="number">1</span>] = <span class="literal">false</span>;<span class="comment">//刚开始设置为两个进程都不想进入临界区</span></span><br></pre></td></tr></table></figure><p>p0进程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (flag[<span class="number">1</span>]);</span><br><span class="line">flag [<span class="number">0l</span> = <span class="literal">true</span>;</span><br><span class="line">critical section; </span><br><span class="line">flag [<span class="number">0</span>] = <span class="literal">false</span>;</span><br><span class="line">remainder section;</span><br></pre></td></tr></table></figure><p>p1 进程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (flag[<span class="number">0</span>]);<span class="comment">//如果此时p0想进入临界区，p1就一直循环等待</span></span><br><span class="line">flag [<span class="number">1</span>] = <span class="literal">true</span>;<span class="comment">//标记为p1进程想要进入临界区</span></span><br><span class="line">critical section;  <span class="comment">//访问临界区</span></span><br><span class="line">flag [<span class="number">1</span>] = <span class="literal">false</span>; <span class="comment">//访问完临界区，修改标记为p1不想使用临界区</span></span><br><span class="line">remainder section;</span><br></pre></td></tr></table></figure><p>但是有可能会导致p0和p1同时访问临界区</p><p><strong>因此，双标志先检查法的主要问题是：违反”忙则等待”原则</strong></p><p>原因在于，进入区的”检查”和”上锁” 两个处理不是一气呵成的。”检查” 后，”上锁”前可能发生进程切换。</p><h4 id="双标志后检查法"><a href="#双标志后检查法" class="headerlink" title="双标志后检查法"></a>双标志后检查法</h4><p>算法思想：双标志先检查法的改版。前一个算法的问题是先 “检查”后“上锁”，但是这两个操作又无法一气呵成，因此导致了两个进程同时进入临界区的问题。因此，人们又想到先 “上锁〞 后“检查”的方法，来避免上述问题。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> flag[<span class="number">2</span>];<span class="comment">//表示进入临界区意愿的数组</span></span><br><span class="line">flag[<span class="number">0</span>] = <span class="literal">false</span>;</span><br><span class="line">flag[<span class="number">1</span>] = <span class="literal">false</span>;<span class="comment">//刚开始设置为两个进程都不想进入临界区</span></span><br></pre></td></tr></table></figure><p>p0进程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flag[<span class="number">0</span>] = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">while</span> (flag[<span class="number">1</span>]);</span><br><span class="line">critical section; </span><br><span class="line">flag[<span class="number">0</span>] = <span class="literal">false</span>;</span><br><span class="line">remainder section;</span><br></pre></td></tr></table></figure><p>p1进程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flag[<span class="number">1</span>] = <span class="literal">true</span>;<span class="comment">//标记为 P1 进程想要进入临界区</span></span><br><span class="line"><span class="keyword">while</span> (flag[<span class="number">0</span>]);<span class="comment">//如果 PQ 也想进入临界区，则 P1 循环等待</span></span><br><span class="line">critical section;<span class="comment">//访问临界区</span></span><br><span class="line">flag[<span class="number">1</span>] = <span class="literal">false</span>;<span class="comment">//访问完临界区，修改标记为 P1 不想使用临界区</span></span><br><span class="line">remainder section;</span><br></pre></td></tr></table></figure><p>有可能会导致p0和p2将都无法进入临界区</p><p>因此，双标志后检查法虽然解决了 “忙则等待” 的问题，但是又<strong>违背了“空闲让进”和“有限等待”原则</strong>，会因各进程都长期无法访问临界资源而产生 “饥饿”现象。</p><p>两个进程都争着想进入临界区，但是谁也不让谁，最后谁都无法进入临界区。</p><h4 id="Peterson算法"><a href="#Peterson算法" class="headerlink" title="Peterson算法"></a>Peterson算法</h4><p>算法思想：双标志后检查法中，两个进程都手着想进入临界区，但是谁也不让谁，最后谁都无法进入临界区。Gary L. Peterson 想到了一种方法，如果双方都争着想进入临界区，那可以让进程尝试 “孔融让梨”，主动让对方先使用临界区。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> flag[<span class="number">2</span>];<span class="comment">//表示进入临界区意愿的数组，初始值都是false</span></span><br><span class="line"><span class="type">int</span> turn =<span class="number">0</span>;<span class="comment">//turn 表示优先让哪个进程进入临界区</span></span><br></pre></td></tr></table></figure><p>p0进程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">flag[<span class="number">0</span>] = <span class="literal">true</span>;<span class="comment">//三部分合为进入区：</span></span><br><span class="line">turn = <span class="number">1</span>:<span class="comment">//主动争取</span></span><br><span class="line"><span class="keyword">while</span> (flag[<span class="number">1</span>] &amp;&amp; turn==<span class="number">1</span>);<span class="comment">//主动谦让</span></span><br><span class="line"><span class="comment">//检查对方是否也想使用，且最后一次是不是自己说了&quot;客气话&quot;</span></span><br><span class="line">critical section;</span><br><span class="line">flag [<span class="number">0</span>] = <span class="literal">false</span>;</span><br><span class="line">remainder section;</span><br></pre></td></tr></table></figure><p>p1进程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flag [<span class="number">1</span>] = <span class="literal">true</span>;<span class="comment">//表示自己想进入临界区</span></span><br><span class="line">turn = <span class="number">0</span>;<span class="comment">//可以优先让对方进入临界区</span></span><br><span class="line"><span class="keyword">while</span> (flag[<span class="number">0</span>] &amp;&amp; turn==<span class="number">0</span>);<span class="comment">//对方想进，且最后一次是自己&quot;让梨&quot;，那自己就循环等待</span></span><br><span class="line">critical section;</span><br><span class="line">flag[<span class="number">1</span>] = <span class="literal">false</span>;<span class="comment">//访问完临界区，表示自己已经不想访问临界区了</span></span><br><span class="line">remainder section;</span><br></pre></td></tr></table></figure><p>Peterson算法用软件方法解决了进程互斥问题，遵循了<strong>空闲让进、忙则等待、有限等待</strong>三个原则，但是依然<strong>未遵循让权等待</strong>的原则。</p><h3 id="2-13-进程互斥的硬件实现"><a href="#2-13-进程互斥的硬件实现" class="headerlink" title="2.13 进程互斥的硬件实现"></a>2.13 进程互斥的硬件实现</h3><h4 id="中断屏蔽方法"><a href="#中断屏蔽方法" class="headerlink" title="中断屏蔽方法"></a>中断屏蔽方法</h4><p>利用”开&#x2F;关中断指令”实现(与原语的实现思想相同，即在某进程开始访问临界区到结束访问为止都不允许被中断，也就不能发生进程切换，因此也不可能发生两个同时访问临界区的情况)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">关中断; //关中断后即不允许当前进程被中断，也必然不会发生进程切换</span><br><span class="line">临界区;</span><br><span class="line">开中断; //直到当前进程访问完临界区，再执行开中断指令，才有可能有别的进程上处理机并访问临界区</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>优点：简单、高效</p><p>缺点：不适用于多处理机；只适用于操作系统内核进程，不适用于用户进程(因为开&#x2F;关中断指令只能运行在内核态，这组指令如果能让用户随意使用会很危险)</p><h4 id="TestAndSet指令"><a href="#TestAndSet指令" class="headerlink" title="TestAndSet指令"></a>TestAndSet指令</h4><p>简称TS指令，或TSL指令</p><p>TSL指令是用硬件实现的，执行的过程不允许被中断，只能一气呵成。</p><p>以下是用C语言描述：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//布尔型共享变量 lock 表示当前临界区是否被加锁</span></span><br><span class="line"><span class="comment">//true 表示已加锁，false 表示未加锁</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">TestAndset</span> <span class="params">(<span class="type">bool</span> *lock)</span>&#123;</span><br><span class="line"><span class="type">bool</span> old;</span><br><span class="line">old=*lock; <span class="comment">//old用来存放Lock 原来的值</span></span><br><span class="line">*lock = <span class="literal">true</span>; <span class="comment">//无论之前是否已加锁，都将1ock设为true</span></span><br><span class="line"><span class="keyword">return</span> old;<span class="comment">//返回lock原来的值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//以下是使用 TSL 指令实现互斥的算法逻辑</span></span><br><span class="line"><span class="keyword">while</span> (TestAndset(&amp;lock));<span class="comment">//&quot;上锁&quot;并&quot;检查&quot;</span></span><br><span class="line">临界区代码段...</span><br><span class="line">lock = <span class="literal">false</span>;<span class="comment">//解锁</span></span><br><span class="line">剩余区代码段...</span><br></pre></td></tr></table></figure><p>若刚开始 lock 是false，则TSL返回的old 值为false， while 循环条件不满足，直接跳过循环，进入界区。</p><p>若刚开始 lock 是true，则执行TLS后old 返回的值为true， while 循环条件满足，会一直循环，直到当前访问临界区的进程在退出区进行 “解锁”。</p><p>相比软件实现方法，TSL指令把”上锁”和”检查”操作用硬件的方式变成了一气呵成的原子操作。</p><p>优点：实现简单，无需像软件实现方法那样严格检查是否会有逻辑漏洞；适用于多处理机环境</p><p>缺点：不满足”让权等待”原则，暂时无法进入临界区的进程会占用CPU并循环执行TSL指令，从而导致”忙等”</p><h4 id="Swap指令"><a href="#Swap指令" class="headerlink" title="Swap指令"></a>Swap指令</h4><p>有的地方也叫 Exchange 指令，或简称XCHG 指令。</p><p>Swap 指令是用硬件实现的，执行的过程不允许被中断，只能一气呵成。</p><p>以下是用C语言描述：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Swap 指令的作用是交换两个变量的值</span></span><br><span class="line">Swap (<span class="type">bool</span> *a， <span class="type">bool</span> *b)&#123;</span><br><span class="line"><span class="type">bool</span> temp;</span><br><span class="line">temp = *a;</span><br><span class="line">*a = *b;</span><br><span class="line">*b = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//以下是用 Swap指令实现互斥的算法逻辑</span></span><br><span class="line"><span class="comment">//lock 表示当前临界区是否被加锁</span></span><br><span class="line"><span class="type">bool</span> old = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">while</span> (old == <span class="literal">true</span>)</span><br><span class="line">Swap(&amp;lock, Sold);</span><br><span class="line">临界区代码段...</span><br><span class="line">lock = <span class="literal">false</span>;</span><br><span class="line">剩余区代码段...</span><br></pre></td></tr></table></figure><p>逻辑上来看 Swap 和TSL 并无太大区别，都是先记录下此时临界区是否已经被上锁(记录在old变量上)，再将上锁标记 lock 设置为true，最后检查old，如果old 为false 则说明之前没有别的进程对临界区上锁，则可跳出循环，进入临界区。</p><p>优点：实现简单，无需像软件实现方法那样严格检查是否会有逻辑漏洞；适用于多处理机环境</p><p>缺点：不满足”让权等待” 原则，暂时无法进入临界区的进程会占用CPU并循环执行TSL指令，从而导致”忙等”。</p><h3 id="2-14-信号量机制"><a href="#2-14-信号量机制" class="headerlink" title="2.14 信号量机制"></a>2.14 信号量机制</h3><p>用户进程可以通过使用操作系统提供的一对原语来对信号量进行操作，从而很方便的实现了进程互斥、进程同步。</p><p>信号量其实就是一个变量(<span style="color:red">可以是一个整数，也可以是更复杂的记录型变量</span>)，可以用<span style="color:red">一个信号量表示系统中某种资源的数量</span>，比如：系统中只有一台打印机，就丽以设置一个初值为1的信号量。</p><p><span style="color:red">原语是一种特殊的程序段，其执行只能一气呵成，不可被中断。</span>原语是由<span style="color:red">关中断&#x2F;开中断指令实现</span>的。软件解决方案的主要问题是由 “进入区的各种操作无法一气呵成”，因此如果能把进入区、退出区的操作都用 “原语〞实现，使这些操作能 “一气呵成”就能避免问题。</p><p>一对原语：wait(S) 原语和signal(S)原语，可以把原语理解为我们自1己写的函数，函数名分别为 wait和signal，括号里的信号量S其实就是函数调用时传入的一个参数。</p><p>wait、signal 原语常简称为P、V操作。因此，做题的时候常把wait(S)、signal(S)两个操作分别写为 <span style="color:red">P(S)、V(S)</span></p><h4 id="整型信号量"><a href="#整型信号量" class="headerlink" title="整型信号量"></a>整型信号量</h4><p>用一个整数型的变量作为信号量，用来表示系统中某种资源的数量。</p><p>Eg：某计算机系统中有一台打印机…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> S = <span class="number">1</span>; <span class="comment">//初始化整型信号量s，表示兰前系统中可用的打印机资源数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">wait</span><span class="params">(<span class="type">int</span> S)</span> &#123;<span class="comment">//wait原语，相当于&quot;进入区&quot;，检查、上锁一并合成，避免并发和异步问题</span></span><br><span class="line"><span class="keyword">while</span> (S &lt;= <span class="number">0</span>);<span class="comment">//如果资源数不够，就一直循环等待，会发生&quot;让权等待&quot;，发生&quot;忙等&quot;</span></span><br><span class="line">S=S<span class="number">-1</span>;<span class="comment">//如果资源数够，则占用一个资源</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal</span><span class="params">(<span class="type">int</span> S)</span> &#123; <span class="comment">//signal原语，相当于&quot;退出区&quot;</span></span><br><span class="line">S=S+<span class="number">1</span>;<span class="comment">//使用完资源后，在退出区释放资源</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进程p0~pn：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">wait(S);<span class="comment">//进入区，申请资源</span></span><br><span class="line">使用打印机资源...   <span class="comment">//临界区，访问资源</span></span><br><span class="line">signal(S);<span class="comment">//退出区，释放资源</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="记录型信号量"><a href="#记录型信号量" class="headerlink" title="记录型信号量"></a>记录型信号量</h4><p>整型信号量的缺陷是存在“忙等”问题，因此人们又提出了 “记录型信号量”，即用记录型数据结构表示的信号量。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*记录型信号量的定义*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="type">int</span> value;<span class="comment">//剩余资源数</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">process</span> *<span class="title">L</span>;</span><span class="comment">//等待队列</span></span><br><span class="line">&#125; semaphore;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*某进程需要使用资源时，通过wait原语申请*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">wait</span> <span class="params">(semaphore S)</span> &#123;</span><br><span class="line">S.value--;</span><br><span class="line"><span class="keyword">if</span>(S.value &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">/*如果剩余资源不够，使用block原语使进程从运行态进入阻塞态，并把信号量S的等待队列L中*/</span></span><br><span class="line">block(S.L);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*进程使零完资源后，通过signal原语释放*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal</span><span class="params">(semaphore S)</span> &#123;</span><br><span class="line">S.value++;</span><br><span class="line"><span class="keyword">if</span>(S.value &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/*释放资源后，若还有别的进程在等待这种资源，则使用wakeup原语唤醒等待队列L中的一个进程，使进程从阻塞态进入就绪态*/</span></span><br><span class="line">wakeup(S.L);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Eg：某计算机系统中有2台打印机…，则可在初始化信号量S时将 S.value 的值设为2，队列 S.L 设置为空</p><p>一共有p0、p1、p2、p3进程：</p><ol><li>p0调用<code>wait(S);</code>-&gt;S.value-1变为<code>1</code>，使用打印机</li><li>p1调用<code>wait(S);</code>-&gt;S.value-1变为<code>0</code>，使用打印机</li><li>p2调用<code>wait(S);</code>-&gt;S.value-1变为<code>-1</code>。打印机不够，p2进入等待队列，此时有1个进程等待</li><li>p3调用<code>wait(S);</code>-&gt;S.value-1变为<code>-2</code>。打印机不够，p3也进入等待队列，此时有2个进程等待</li><li>p0结束使用打印机，调用<code>signal(S);</code>-&gt;S.value+1变为<code>-1</code>。<code>S.value&lt;=0</code>说明有进程在等待该资源，唤醒等待队列中的1个进程p2，p2使用打印机</li><li>p1结束使用打印机，调用<code>signal(S);</code>-&gt;S.value+1变为<code>0</code>。<code>S.value&lt;=0</code>说明有进程在等待该资源，唤醒等待队列中的1个进程p3，p3使用打印机</li><li>p2结束使用打印机，调用<code>signal(S);</code>-&gt;S.value+1变为<code>1</code>。<code>S.value&gt;0</code>说明不存在进程等待该资源</li><li>p3结束使用打印机，调用<code>signal(S);</code>-&gt;S.value+1变为<code>2</code>。<code>S.value&gt;0</code>说明不存在进程等待该资源</li></ol><h4 id="实现进程互斥"><a href="#实现进程互斥" class="headerlink" title="实现进程互斥"></a>实现进程互斥</h4><ol><li>分析并发进程的关键活动，划定临界区（如：对临界资源打印机的访问就应放在临界区）</li><li><span style="color:red">设置互斥信号量mutex，初值为 1</span></li><li>在临界区之前执行 P(mutex)</li><li>在临界区之后执行 V(mutex)</li></ol><p>注意：</p><ul><li><p>对不同的临界资源需要设置不同的互斥信号量。</p></li><li><p>P、V操作必须成对出现。缺少<code>P(mutex)</code>就不能保证临界资源的互斥访问。缺少<code>V(mutex)</code>会导致资源永不被释放，等待进程永不被唤醒。</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*信号量机制实现互反*/</span></span><br><span class="line">semaphore mutex=<span class="number">1</span>;<span class="comment">//初始化信号量，可以把信号量的声明简写成这种形式</span></span><br><span class="line"></span><br><span class="line">p1()&#123;</span><br><span class="line">...</span><br><span class="line">P(mutex);<span class="comment">//使用临界资源前需要加锁</span></span><br><span class="line">临界区代码段...</span><br><span class="line">V(mutex);<span class="comment">//使用临界资源后需要解锁</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p2()&#123;</span><br><span class="line">...</span><br><span class="line">P(mutex);</span><br><span class="line">临界区代码段...</span><br><span class="line">V(mutex);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现进程同步"><a href="#实现进程同步" class="headerlink" title="实现进程同步"></a>实现进程同步</h4><p>进程同步：要让各并发进程按要求有序地推进。</p><p>比如，p1、p2并发执行，由于存在异步性，因此二者交替推进的次序是不确定的。</p><p>若p2的”代码4”要基于p1的”代码1”和”代码2”的运行结果才能执行，那么我们就必须保证”代码4”一定是在”代码2”之后才会执行。</p><p>这就是进程同步问题，让本来异步并发的进程互相配合，有序推进。</p><p>用信号量实现进程同步：</p><ol><li>分析什么地方需要实现“同步关系”，即必须保证“一前一后”执行的两个操作(或两句代码)</li><li><span style="color:red">设置同步信号量S，初始为0</span></li><li>在”前操作”之后执行V(S)</li><li>在”后操作”之前执行P(S)</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*信号量机制实现同步*/</span></span><br><span class="line">semaphore S=<span class="number">0</span>;<span class="comment">//初始化同步信号量，初始值为0</span></span><br><span class="line"></span><br><span class="line">p1()&#123;</span><br><span class="line">代码<span class="number">1</span>;</span><br><span class="line">代码<span class="number">2</span>;</span><br><span class="line">V(S);</span><br><span class="line">代码<span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p2()&#123;</span><br><span class="line">P(S);</span><br><span class="line">代码<span class="number">4</span>;</span><br><span class="line">代码<span class="number">5</span>;</span><br><span class="line">代码<span class="number">6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>解释：</p><ul><li><p>若先执行到V(S) 操作，则S++ 后 S&#x3D;1。之后当执行到P(S)操作时，由于 S&#x3D;1，表示有可用资源，会执行 S–，S的值变回0，p2进程不会执行 block 原语，而是继续往下执行代码4。</p></li><li><p>若先执行到 P(S) 操作，由于 S&#x3D;0，S– 后S &#x3D; -1，表示此时没有可用资源，因此P操作中会执行 block 原语，主动请求阻塞。之后当执行完”代码2”，继而执行 v(S)操作，S++，使S变回0，由于此时有进程在该信号量对应的阻塞队列中，因此会在V操作中执行 wakeup 原语，唤醒 p2 进程。这样 p2就可以继续执行 “代码4”了</p></li></ul><h4 id="实现前驱关系"><a href="#实现前驱关系" class="headerlink" title="实现前驱关系"></a>实现前驱关系</h4><p>进程p1中有代码s1，p2中有代码s2…..p6中有代码s6</p><p>这些代码要求如下前驱图所示的顺序来执行：</p><pre class="mermaid">flowchart TB    s1-->s2-->s4-->s6    s1-->s3-->s6    s2-->s5-->s6</pre><p>前驱关系问题，本质上就是一个复杂的同步问题</p><p><strong>这就需要对每一对前驱关系各设置一个同步变量</strong>：</p><img src="https://s2.loli.net/2022/10/28/zJVIo56iywTX9OZ.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/28/zJVIo56iywTX9OZ.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2022-10-28_15-36-27.png" style="zoom:67%;" /><img src="https://s2.loli.net/2022/10/28/S6e3vI8dHjbGyni.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/28/S6e3vI8dHjbGyni.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="2AAC250AB7E4BC29326BB4CE820920AA.png" style="zoom:50%;" /><h3 id="2-15-进程同步、互斥问题"><a href="#2-15-进程同步、互斥问题" class="headerlink" title="2.15 进程同步、互斥问题"></a>2.15 进程同步、互斥问题</h3><h4 id="生产者-消费者问题"><a href="#生产者-消费者问题" class="headerlink" title="生产者-消费者问题"></a>生产者-消费者问题</h4><p>生产者消费者问题是一个互斥、同步的综合问题</p><p>问题描述：</p><p>系统中有一组生产者进程和一组消费者进程，生产者进程每次生产一个产品放入缓冲区，消费者进程每次从缓冲区中取出一个产品并使用。(注：这里的”产品”理解为某种数据）</p><ul><li>生产者、消费者共享一个<span style="color:red">初始为空、大小为n的缓冲区</span>。</li><li>生产<span style="color:red">只有缓冲区没满</span>时，生产者才能把产品放入缓冲区，否则必须等待</li><li>只有<span style="color:red">缓冲区不空</span>时，消费者才能从中取出产品，否则必须等待。</li><li>缓冲区是临界资源，<span style="color:red">各进程必领互斥地访问</span>。</li></ul><p>PV操作题目分析步骤：</p><ol><li><p>关系分析。找出题目中描述的各 个进程，分析它们之间的同步、互斥关系</p></li><li><p>整理思路。根据各进程的操作流程确定P、V操作的大致顺序。</p></li><li><p>设置信号量。设置需要的信号量，并根据题目条件确定信号量初值。</p><p>(互斥信号量初值一般为1，同步信号量的初始值要看对应资源的初始值是多少)</p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">semaphore mutex = <span class="number">1</span>;<span class="comment">//互斥信号量，实现对缓冲区的互斥访问</span></span><br><span class="line">semaphore empty = n;<span class="comment">//同步信号量，表示空闲缓冲区的数量</span></span><br><span class="line">semaphore full = <span class="number">0</span>;<span class="comment">//同步信号量，表示产品的数量，也即非空缓冲区的数量</span></span><br><span class="line"></span><br><span class="line">producer()&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        生产一个产品;</span><br><span class="line">        P(empty);<span class="comment">//消耗一个空闲缓冲区</span></span><br><span class="line">        P(mutex);</span><br><span class="line">        把产品放入缓冲区;</span><br><span class="line">        V(mutex);</span><br><span class="line">        V(full);<span class="comment">//增加一个产品</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">consumer()&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        P(full);<span class="comment">//消耗一个产品</span></span><br><span class="line">        P(mutex);</span><br><span class="line">        从缓冲区取出一个产品;</span><br><span class="line">        V(mutex);</span><br><span class="line">        V(empty);<span class="comment">//增加一个空闲缓冲区</span></span><br><span class="line">        使用产品;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="多生产者-多消费者问题"><a href="#多生产者-多消费者问题" class="headerlink" title="多生产者-多消费者问题"></a>多生产者-多消费者问题</h4><p>问题描述：</p><p>桌子上有一只盘子，每次只能向其中放入一个水果。爸爸专向盘子中放苹果，妈妈专向盘子中放橘子，儿子专等着吃盘子中的橘子，女儿专等着吃盘子中的苹果。只有盘子空时，爸爸或妈妈才可向盘子中放一个水果。仅当盘子中有自己需要的水果时，儿子或女儿可以从盘子中取出水果。</p><p>互斥关系：</p><ul><li>对缓冲区(盘子)的访问要互斥地进行(只能有一人访问盘子)</li></ul><p>同步关系(一前一后)：</p><ul><li>父亲将苹果放入盘子后，女儿才能取苹果</li><li>母亲将橘子放入盘子后，儿子才能取橘子</li><li>只有盘子为空时，父亲或母亲才能放入水果</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">semaphore mutex = <span class="number">1</span>;<span class="comment">//实现互斥访问盘子(缓冲区)</span></span><br><span class="line">semaphore apple = <span class="number">0</span>;<span class="comment">//盘子中有几个苹果</span></span><br><span class="line">semaphore orange = <span class="number">0</span>;<span class="comment">//盘子中有几个橘子</span></span><br><span class="line">semaphore plate = <span class="number">1</span>;<span class="comment">//盘子中还可以放多少个水果</span></span><br><span class="line"></span><br><span class="line">dad()&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    准备一个苹果;</span><br><span class="line">        P(plate);</span><br><span class="line">        P(mutex);</span><br><span class="line">        苹果放入盘子;</span><br><span class="line">        V(mutex);</span><br><span class="line">        V(apple);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mom()&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    准备一个橘子;</span><br><span class="line">        P(plate);</span><br><span class="line">        P(mutex);</span><br><span class="line">        橘子放入盘子;</span><br><span class="line">        V(mutex);</span><br><span class="line">        V(orange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">son()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">P(apple);</span><br><span class="line">        P(mutex);</span><br><span class="line">        拿走苹果;</span><br><span class="line">        V(mutex);</span><br><span class="line">        V(plate);</span><br><span class="line">        吃掉苹果;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">daughter()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        P(orange);</span><br><span class="line">        P(mutex);</span><br><span class="line">        拿走橘子;</span><br><span class="line">        V(mutex);</span><br><span class="line">        V(plate);</span><br><span class="line">        吃掉橘子;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="吸烟者问题"><a href="#吸烟者问题" class="headerlink" title="吸烟者问题"></a>吸烟者问题</h4><p>问题描述：</p><p>假设一个系统有三个抽烟者进程和一个供应者进程。每个抽烟者不停地卷烟并抽掉它，但是要卷起并抽掉一支烟，抽烟者需要有三种材料：烟草、纸和胶水。三个抽烟者中，第一个拥有烟草、第二个拥有纸、第三个拥有胶水。供应者进程无限地提供三种材料，供应者每次将两种材料放桌子上，拥有剩下那种材料的抽烟者卷一根烟并抽掉它，并给供应者进程一个信号告诉完成了，供应者就会放另外两种材料再桌上，这个过程一直重复(让三个抽烟者轮流地抽烟)</p><ul><li><p>桌上有组合一 -&gt; 第一个抽烟者取走东西</p></li><li><p>桌上有组合二 -&gt; 第二个抽烟者取走东西</p></li><li><p>桌上有组合三 -&gt; 第三个抽烟者取走东西</p></li><li><p>发出完成信号 -&gt; 供应者将下一个组合放到桌上</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">semaphore offer1 = <span class="number">0</span>;<span class="comment">//桌上组合一的数量</span></span><br><span class="line">semaphore offer2 = <span class="number">0</span>;<span class="comment">//桌上组合二的数量</span></span><br><span class="line">semaphore offer3 = <span class="number">0</span>;<span class="comment">//桌上组合三的数量</span></span><br><span class="line">semaphore finish = <span class="number">0</span>;<span class="comment">//抽烟是否完成</span></span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;<span class="comment">//用于实现&quot;抽烟者轮流抽烟&quot;</span></span><br><span class="line"></span><br><span class="line">provider()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</span><br><span class="line">将组合<span class="number">1</span>放在桌上;</span><br><span class="line">V(offer1);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(i == <span class="number">1</span>)&#123;</span><br><span class="line">将组合<span class="number">2</span>放在桌上;</span><br><span class="line">V(offer2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">将组合<span class="number">3</span>放在桌上;</span><br><span class="line">V(offer3);</span><br><span class="line">&#125;</span><br><span class="line">i = (i+<span class="number">1</span>)%<span class="number">3</span>;</span><br><span class="line">P(finish);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">smoker1()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">P(offer1);</span><br><span class="line">拿走组合<span class="number">1</span>，卷烟，抽掉</span><br><span class="line">V(finish);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">smoker2()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">P(offer2);</span><br><span class="line">拿走组合<span class="number">2</span>，卷烟，抽掉</span><br><span class="line">V(finish);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">smoker3()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">P(offer3);</span><br><span class="line">拿走组合<span class="number">3</span>，卷烟，抽掉</span><br><span class="line">V(finish);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>吸烟者问题可以为我们解决”可以生产多个产品的单生产者”问题提供一个思路。</p><p>值得吸取的精华是：”轮流让各个吸烟者吸烟”必然需要”轮流的在桌上放上组合一、二、三”，注意体会我们是如何用一个整型变量 i 实现这个”轮流”过程的。</p><h4 id="读者-写者问题"><a href="#读者-写者问题" class="headerlink" title="读者-写者问题"></a>读者-写者问题</h4><p>问题描述：</p><p>有读者和写者两组并发进程，共享一个文件，当两个或两个以上的读进程同时访问共享数据时不会产生副作用，但若某个写进程和其他进程（读进程或写进程）同时访问共享数据时则可能导致数据不一致的错误。因此要求：</p><ol><li>允许多个读者可以同时对文件执行读操作</li><li>只允许一个写者往文件中写信息</li><li>任一写者在完成写操作之前不允许其他读者或写者工作</li><li>写者执行写操作前，应让己有的读者和写者全部退出</li></ol><p>两类进程：写进程、读进程：</p><ul><li>互斥关系：写进程——写进程、写进程——读进程。读进程与读进程不存在互斥问题。</li><li>写者进程和任何进程都互斥，设置一个互斥信号量 rw，在写者访问共享文件前后分别执行P、V操作。</li><li>读者进程和写者进程也要互斥，因此读者访问共享文件前后也要对rw 执行P、V操作。</li><li>如果所有读者进程在访问共享文件之前都执行 P(rw) 操作，那么会导致各个读进程之问也无法同时访问文件。</li><li>P(rw)和 V(rw)其实就是对共享文件的“加锁”和“解锁〞。既然各个读进程需要同时访问，而读进程与写进程又必须互斥访问，那么我们可以让第一个访问文件的读进程 “加锁〞，让最后一个访问完文件的读进程 “解锁”。可以设置一个整数变量 count 来记录当前有几个读进程在访问交件。</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">semaphore mutex = <span class="number">1</span>;<span class="comment">//用于实现对文件的互斥访问。表示当前是否有进程在访问共享文件</span></span><br><span class="line">semaphore rw = <span class="number">1</span>;<span class="comment">//记录当前有几个读进程在访问文件</span></span><br><span class="line">semaphore w = <span class="number">1</span>;<span class="comment">//用于实现&quot;写优先&quot;</span></span><br><span class="line"><span class="type">int</span> count = <span class="number">0</span>;<span class="comment">//用于保证对count变量的互斥访问</span></span><br><span class="line"></span><br><span class="line">writer()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        P(w);<span class="comment">//防止写者饿死</span></span><br><span class="line">P(rw);<span class="comment">//写之前&quot;加锁&quot;</span></span><br><span class="line">写文件;</span><br><span class="line">V(rw);<span class="comment">//写之后&quot;解锁&quot;</span></span><br><span class="line">V(w);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reader()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        P(w);<span class="comment">//不要无限让读者访问，因为只要有读者，写者就只能等待，防止写者饿死</span></span><br><span class="line">P(mutex);<span class="comment">//各读者进程互斥访问count，防止一起进入导致另一个读者阻塞</span></span><br><span class="line"><span class="keyword">if</span>(count == <span class="number">0</span>)</span><br><span class="line">P(rw);<span class="comment">//第一个读者进程负责&quot;加锁&quot;</span></span><br><span class="line">count++;<span class="comment">//访问文件的读进程数+1</span></span><br><span class="line">V(mutex);<span class="comment">//解锁</span></span><br><span class="line">V(w);</span><br><span class="line">        </span><br><span class="line">        读文件;</span><br><span class="line">P(mutex);<span class="comment">//各读者进程互斥访问count</span></span><br><span class="line">count--;<span class="comment">//访问文件的读进程数-1</span></span><br><span class="line"><span class="keyword">if</span>(count == <span class="number">0</span>)</span><br><span class="line">V(rw);<span class="comment">//最后一个读进程负责&quot;解锁&quot;</span></span><br><span class="line">V(mutex);<span class="comment">//解锁</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这种算法中，连续进入的多个读者可以同时读文件；写者和其他进程不能同时访问文件；写者不会饥饿，但也并不是真正的”写优先”，而是相对公平的先来先服务原则。有的书上把这种算法称为”读写公平法”</p><h4 id="哲学家进餐问题"><a href="#哲学家进餐问题" class="headerlink" title="哲学家进餐问题"></a>哲学家进餐问题</h4><p>问题描述：</p><p>一张圆桌上坐着5名哲学家，每两个哲学家之间的桌上摆一根筷子，桌子的中间是一碗米饭。哲学家们倾注毕生的精力用于思考和进餐，哲学家在思考时，并不影响他人。只有当哲学家饥饿时，才试图拿起左、右两根筷子（一根一根地拿起）。如果筷子已在他人手上，则需等待。饥饿的哲学家只有同时拿起两根筷子才可以开始进餐，当进餐完毕后，放下筷子继续思考。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">semaphore chopstick[<span class="number">5</span>] = &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;;</span><br><span class="line">Pi()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">P(chopstick[i]);<span class="comment">//拿左筷子</span></span><br><span class="line">P(chopstick[(i+<span class="number">1</span>)%<span class="number">5</span>]);<span class="comment">//拿右筷子</span></span><br><span class="line">吃饭;</span><br><span class="line">V(chopstick[i]);<span class="comment">//放下左筷子</span></span><br><span class="line">V(chopstick[(i+<span class="number">1</span>)%<span class="number">5</span>]);<span class="comment">//放下右筷子</span></span><br><span class="line">思考;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//会发生死锁！！</span></span><br></pre></td></tr></table></figure><p>如果5个哲学家并发地拿起了自己左手边的筷子，会导致每个哲学家都只有一个筷子，引发死锁</p><p>如何防止死锁的发生呢？</p><ol><li><p>可以对哲学家进程施加一些限制条件，比如最多允许四个哲学家同时进餐。这样可以保证至少有一个哲学家是可以拿到左右两只筷子的</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">semaphore chopstick[<span class="number">5</span>] = &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;;</span><br><span class="line">semaphore mutex = <span class="number">4</span>;<span class="comment">//最多只允许4个人同时拿筷子</span></span><br><span class="line">Pi()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">P(mutex);</span><br><span class="line">P(chopstick[i]);<span class="comment">//拿左筷子</span></span><br><span class="line">P(chopstick[(i+<span class="number">1</span>)%<span class="number">5</span>]);<span class="comment">//拿右筷子</span></span><br><span class="line">吃饭;</span><br><span class="line">V(chopstick[i]);<span class="comment">//放下左筷子</span></span><br><span class="line">V(chopstick[(i+<span class="number">1</span>)%<span class="number">5</span>]);<span class="comment">//放下右筷子</span></span><br><span class="line">V(mutex);</span><br><span class="line">思考;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>要求奇数号哲学家先拿左边的筷子，然后再拿有边的筷子，而偶数号哲学家刚好相反。用这种方法可以保证如果相邻的两个奇偶号哲学家都想吃饭，那么只会有其中一个可以拿起第一只筷子，另一个会直接阻塞。这就避免了占有一支后再等待另一只的情況。</p></li><li><p>保证有一个哲学家吃饭</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">semaphore chopstick[<span class="number">5</span>] = &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;;</span><br><span class="line">semaphore mutex = <span class="number">1</span>;<span class="comment">//互斥地拿筷子</span></span><br><span class="line">Pi()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">P(mutex);</span><br><span class="line">P(chopstick[i]);<span class="comment">//拿左筷子</span></span><br><span class="line">P(chopstick[(i+<span class="number">1</span>)%<span class="number">5</span>]);<span class="comment">//拿右筷子</span></span><br><span class="line">V(mutex);</span><br><span class="line">吃饭;</span><br><span class="line">V(chopstick[i]);<span class="comment">//放下左筷子</span></span><br><span class="line">V(chopstick[(i+<span class="number">1</span>)%<span class="number">5</span>]);<span class="comment">//放下右筷子</span></span><br><span class="line">思考;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="2-16-管程"><a href="#2-16-管程" class="headerlink" title="2.16 管程"></a>2.16 管程</h3><p>信号量机制存在的问题：编程程序困难、易出错</p><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>管程是一种特殊的软件模块，有这些部分组成：</p><ol><li>局部于管程的共享数据结构说明；</li><li>对该数据结构进行操作的一组过程(函数)；</li><li>对局部于管程的共享数据设置初始值的语句；</li><li>管程有一个名字。</li></ol><p>管程的基本特征：</p><ol><li>局部于管程的数据只能被局部于管程的过程所访问：</li><li>一个进程只有通过调用管程内的过程才能进入管程访问共享数据；</li><li>每次<strong>仅允许一个进程</strong>在管程内执行某个内部过程。</li></ol><h4 id="解决生产者消费者问题"><a href="#解决生产者消费者问题" class="headerlink" title="解决生产者消费者问题"></a>解决生产者消费者问题</h4><p>可以用某种特殊的语法定义一个管程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">monitor ProducerConsumer</span><br><span class="line">condition full, empty;<span class="comment">//条件变量用来实现同步(排队)</span></span><br><span class="line"><span class="type">int</span> count = <span class="number">0</span>; <span class="comment">//缓冲区中的产品数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">insert</span><span class="params">(Item item)</span>&#123;        <span class="comment">//把产品item放入缓冲区</span></span><br><span class="line"><span class="keyword">if</span>(count == N)</span><br><span class="line">wait(full);</span><br><span class="line">count++;</span><br><span class="line">insert_item(item);</span><br><span class="line"><span class="keyword">if</span>(count == <span class="number">1</span>)</span><br><span class="line">signal(empty);</span><br><span class="line">Item <span class="title function_">remove</span><span class="params">()</span>&#123; <span class="comment">//从缓冲区中取出一个产品</span></span><br><span class="line"><span class="keyword">if</span>(count == <span class="number">0</span>)</span><br><span class="line">wait(empty);</span><br><span class="line">count--;</span><br><span class="line"><span class="keyword">if</span>(count == N<span class="number">-1</span>)</span><br><span class="line">signal(full);</span><br><span class="line"><span class="keyword">return</span> remove_item();</span><br><span class="line">end monitor;</span><br></pre></td></tr></table></figure><p>实现生产者-消费者：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生产者进程</span></span><br><span class="line">producer()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">item = 生产一个产品;</span><br><span class="line">ProducerConsumer.insert(item);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//消费者进程</span></span><br><span class="line">producer()&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">ProducerConsumer.remove(item);</span><br><span class="line">        消费产品item;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="java中类似管制的机制"><a href="#java中类似管制的机制" class="headerlink" title="java中类似管制的机制"></a>java中类似管制的机制</h4><p>java中，如果用关键宇<code>synchronized</code>来描述一个函数，那么这个函数同一时间段内只能被一个线程调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">monitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Item buffer[] = <span class="keyword">new</span> <span class="title class_">Item</span>[N];</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Item item)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-17-死锁"><a href="#2-17-死锁" class="headerlink" title="2.17 死锁"></a>2.17 死锁</h3><h4 id="死锁的概念"><a href="#死锁的概念" class="headerlink" title="死锁的概念"></a>死锁的概念</h4><p>在并发环境下，各进程因竞争资源而造成的一种互相等待对方手里的资源，导致各进程都阻塞，都无法向前推进的现象，就是”死锁”。发生死锁后若无外力干涉，这些进程都将无法向前推进。</p><p>死锁：各进程互相等待对方手里的资源，导致各进程都阻塞，无法向前推进的现象。</p><p>饥饿：由于长期得不到想要的资源，某进程无法向前推进的现象。比如：在短进程优先(SPF)算法中，若有源源不断的短进程到来，则长进程将一直得不到处理机，从而发生长进程”饥饿”。</p><p>死循环：某进程执行过程中一直跳不出某个循环的现象。有时是因为程序逻辑 bug 导致的，有时是程序员故意设计的。</p><p>死锁、饥饿、死循环</p><blockquote><p>共同点：都是进程无法顺利向前推进的现象</p><p>区别：</p><ul><li><p>死锁</p><p>死锁一定是”循环等待对方手里的资源”导致的，因此如果有死锁现象，那至<strong>少有两个或两个以上</strong>的进程同时发生死锁。另外，发生死锁的进程一定处于阻塞态。</p></li><li><p>饥饿</p><p>可能只有一个进程发生饥饿。发生饥饿的进程既可能是阻塞态(如长期得不到推进的现象需要的I&#x2F;O设备)，也可能是就绪态(长期得不到处理机）</p></li><li><p>死循环</p><p>可能只有一个进程发生死循环。死循环的进程可以上处理机运行(可以是运行态)，只不过无法像期待的那样顺利推进。死锁和饥饿问题是由于操作系统分配资源的策略不合理导致的，而死循环是由代码逻辑的错误导致的。死锁和饥饿是管理者(操作系统)的问题，死循环是被管理者的问题。</p></li></ul></blockquote><h4 id="死锁产生的条件"><a href="#死锁产生的条件" class="headerlink" title="死锁产生的条件"></a>死锁产生的条件</h4><p>产生死锁必须同时满足一下四个条件，只要其中任一条件不成立，死锁就不会发生。</p><ul><li>互斥条件：只有对必须互斥使用的资源的争抢才会导致死锁(如哲学家的筷子、打印机设备)像内存、扬声器这样可以同时让多个进程使用的资源是不会导致死锁的(因为进程不用阻塞等这种资源)。</li><li>不剥夺条件：进程所获得的资源在未使用完之前，不能由其他进程强行夺走，只能主动释放。</li><li>请求和保持条件：进程已经保特了至少一个资源，但又提出了新的资源请求，而该资源又被其他进程占有，此时请求进程被阻塞，但又对自己己有的资源保持不放。</li><li>循环等待条件：存在一种进程资源的循环等待链，链中的每一个进程己获得的资源同时被下一个进程所请求。</li></ul><p>注意：发生死锁时一定有循环等待，但是发生循环等待时未必死锁(循环等待是死锁的必要不充分条件)</p><p>如果同类资源数大于1，则即使有循环等待，也未必发生死锁。但如果系统中每类资源都只有一个，那循环等待就是死锁的充分必要条件了。</p><p>总之，对不可剥夺资源的不合理分配，可能导致死锁</p><h3 id="2-18-死锁的处理策略"><a href="#2-18-死锁的处理策略" class="headerlink" title="2.18 死锁的处理策略"></a>2.18 死锁的处理策略</h3><ol><li>预防死锁(静态策略)：破坏死锁产生的四个必要条件中的一个或几个</li><li>避免死锁(动态策略)：用某种方法防止系统进入不安全状态，从而避免死锁(银行家算法)</li><li>死锁的检测和解除：允许死锁的发生，不过操作系统会负责检测出死锁的发生，然后采取某种措施解除死锁</li></ol><h4 id="静态策略-预防死锁"><a href="#静态策略-预防死锁" class="headerlink" title="静态策略(预防死锁)"></a>静态策略(预防死锁)</h4><p><strong>破坏互斥条件</strong></p><p>互斥条件：只有对必须互斥使用的资源的争抢才会导致死锁。</p><p>如果把只能互斥使用的资源改造为允许共享使用，则系统不会进入死锁状态。比如：SPOOLing技术。</p><p>操作系统可以采用 SPOOLing 技术把独占设备在逻辑上改造成共享设备。比如，用SPOOLing技术将打印机改造为共享设备，使用了SPOOLing技术后，在各进程看来，自己对打印机资源的使用请求立即就被接收处理了，不需要再阻塞等待。</p><p>该策略的缺点：并不是所有的资源都可以改造成可共享使用的资源。并且为了系统安全，很多地方还必须保护这种互斥性。因此，很多时候都无法破坏互斥条件。</p><p><strong>破环不剥夺条件</strong></p><p>不剥夺条件：进程所获得的资源在未使用完之前，不能由其他进程强行夺走，只能主动释放。</p><p>破坏不剥夺条件：</p><ul><li>方案一：当某个进程请求新的资源得不到满足时，它必须立即释放保持的所有资源，待以后需要时再重新申请。也就是说，即使某些资源尚末使用完，也需要主动释放，从而破坏了不可剥夺条件。</li><li>方案二：当某个进程需要的资源被其他进程所占有的时候，可以由操作系统协助，将想要的资源强行剥夺。这种方式一般需要考虑各进程的优先级(比如：剥夺调度方式，就是将处理机资源强行剥夺给优先级更高的进程使用)</li></ul><p>该策略的缺点：</p><ol><li>实现起来比较复杂。</li><li>释放己获得的资源可能造成前一阶段工作的失效。因此这种方法一般只适用于易保存和恢复状态的资源，如CPU。</li><li>反复地申请和释放资源会增加系统开销，降低系统吞吐量。</li><li>若采用方案一，意味着只要暂时得不到某个资源，之前获得的那些资源就都需要放弃，以后再重新申请。如果一直发生这样的情况，就会导致进程饥饿。</li></ol><p><strong>破坏请求和保持条件</strong></p><p>请求和保持条件：进程己经保持了至少一个资源，但又提出了新的资源请求，而该资源又被其他进程占有，此时请求进程被阻塞，但又对自己己有的资源保持不放。</p><p>可以采用静态分配方法，即进程在运行前一次申请完它所需要的全部资源，在它的资源未满足前，不让它投入运行。一旦投入运行后，这些资源就一直归它所有，该进程就不会再请求别的任何资源了。</p><p>该策略实现起来简单，但也有明显的缺点：</p><p>有些资源可能只需要用很短的时间，因此如果进程的整个运行期问都一直保持着所有资源，就会造成正重的资源浪费，资源利用率极低。另外，<strong>该策略也有可能导致某些进程饥饿</strong>。</p><p><strong>破环循环等待条件</strong></p><p>循环等待条件：存在一种进程资源的循环等待链，链中的每一个进程已获得的资源同时被下一个进程所请求。</p><p>可采用顺序资源分配法。首先给系统中的资源编号，规定每个进程必须按编号递增的顺序请求资源，同类资源(即编号相同的资源)一次申请完。</p><p>原理分析：一个进程只有己占有小编号的资源时，才有资格申请更大编号的资源。按此规则，己持有大编号资源的进程不可能逆向地回来申请小编号的资源，从而就不会产生循环等待的现象。</p><p>在任何一个时刻，总有一个进程拥有的资源编号是最大的，那这个进程申请之后的资源必然畅通无阻。因此，不可能出现所有进程都阻塞的死锁现象。</p><p>该策略的缺点：</p><ol><li>不方便增加新的设备，因为可能需要重新分配所有的编号；</li><li>进程实际使用资源的顺序可能和编号递增顺序不一致，会导致资源浪费；</li><li>必须按规定次序申请资源，用户编程麻烦。</li></ol><h4 id="动态策略-避免死锁"><a href="#动态策略-避免死锁" class="headerlink" title="动态策略(避免死锁)"></a>动态策略(避免死锁)</h4><p><strong>安全序列</strong></p><p>所谓安全序列，就是<strong>指如果系统按照这种序列分配资源，则每个进程都能顺利完成</strong>。只要能找出一个安全序列，系统就是安全状态。当然，安全序列可能有多个</p><p>如果分配了资源之后，系统中找不出任何一个安全序列，系统就进入了不安全状态。这就意味着之后可能所有进程都无法顺利的执行下去。当然，如果有进程提前归还了一些资源，那系统也有可能重新回到安全状态，不过我们在分配资源之前总是要考虑到最坏的情况。</p><p>如果<strong>系统处于安全状态，就一定不会发生死锁</strong>。如果系统进入不安全状态，就可能发生死锁(处于不安全状态未必就是发生了死锁，但发生死锁时一定是在不安全状态)</p><p>因此可以<strong>在资源分配之前预先判断这次分配是否会导致系统进入不安全状态</strong>，以此决定是否答应资源分配请求。这也是”银行家算法”的核心思想。</p><p><strong>银行家算法</strong></p><p>银行家算法是荷兰学者 Dijkstra 为银行系统设计的，以确保银行在发放现金贷款时，不会发生不能满足所有客户需要的情况。后来该算法被用在操作系统中，<strong>用于避免死锁</strong>。</p><p>核心思想：在进程提出资源申请时，先预判此次分配是否会导致系统进入不安全状态。如果会进入不安全状态，就暂时不答应这次请求，让该进程先阻塞等待。</p><p>在计算机系统中会有多种多样的资源，应该怎么把算法拓展为多种资源的情况呢？</p><ul><li>可以把单维的数字拓展为多维的向量。</li></ul><p>比如：系统中有5个进程 p0<del>p4, 3种资源 r0</del>r2，初始数量为(10, 5, 7)</p><p>某一时刻的情况可表示如下：</p><table><thead><tr><th>进程</th><th>最大需求</th><th>已分配</th><th>最多还需要</th></tr></thead><tbody><tr><td>p0</td><td>(7, 5, 3)</td><td>(0, 1, 0)</td><td>(7, 4, 3)</td></tr><tr><td>p1</td><td>(3, 2, 2)</td><td>(2, 0, 0)</td><td>(1, 2, 2)</td></tr><tr><td>p2</td><td>(9, 0, 2)</td><td>(3, 0, 2)</td><td>(6, 0, 0)</td></tr><tr><td>p3</td><td>(2, 2, 2)</td><td>(2, 1, 1)</td><td>(0, 1, 1)</td></tr><tr><td>p4</td><td>(4, 3, 3)</td><td>(0, 0, 2)</td><td>(4, 3, 1)</td></tr></tbody></table><ol><li><p>依次检查剩余可用资源为(3, 3, 2)能否被满足某个剩余进程的需求</p><p>可满足p1需求，将p1加入安全序列</p><p>说明：说明如果优先把资源分配给p1了，那p1一定是可以顺利执行结束的。等p1结束了就会归还资源。于是，资源数就可以增加到(2,0,0)+(3,3,2)&#x3D;(5,3,2)</p></li><li><p>依次检查剩余可用资源为(5, 3, 2)能否被满足某个剩余进程的需求</p><p>可满足p3需求，将p3加入安全序列</p></li><li><p>依次检查剩余可用资源为(7, 4, 3)能否被满足某个剩余进程的需求</p><p>可满足p0需求，将p0加入安全序列</p></li><li><p>以此类推。如果依次检查剩余可用资源都不能被满足剩余进程的需求，<strong>那么此时系统处于不安全状态，有可能发生死锁</strong></p></li></ol><p>最后得出安全序列：<code>&#123;p1, p3, p0, p2, p4&#125;</code></p><p>假设系统中有n个进程，m种资源</p><p>每个进程在运行前先声明对各种资源的最大需求数，则可用一个<code>n*m</code>的矩阵(可用二维数组实现)表示所有进程对各种资源的最大需求数。<span style="color:red">最大需求Max矩阵</span>， <code>Max[i][j]=K</code> 表示进程pi最多需要K个rj资源。</p><p>系统可以用一个<code>n*m</code> 的<span style="color:red">分配矩阵Allocation</span>表示对所有进程的资源分配情況。</p><p>Max-Allocation&#x3D;<span style="color:red">Need矩阵</span>，表示各进程最多还需要多少各类资源。</p><p>另外，还要用一个长度为m的一维<span style="color:red">数组 Available</span> 表示当前系统中还有多少可用资源。</p><p>某进程pi向系统申请资源，可用一个长度为m的<span style="color:red">一维数组 Request<del>i</del></span> 表示本次申请的各种资源量。</p><p>可用银行家算法预判本次分配是否会导致系统进入不安全状态：</p><ol><li><p>如果 Request<del>i</del>[j] &lt;&#x3D; Need[i, j] 便转向步骤2。否则认为出错，因为它所需要的资源数己超过它所宣布的最大值。</p></li><li><p>如果 Request<del>i</del>[j] &lt;&#x3D; Available[j] 便转向步骤3；否则表示尚无足够资源，pi必须等待。</p></li><li><p>系统试探着把资源分配给进程pi，并修改相应的数据(并非真的分配，修改数值只是为了做预判)</p><ul><li>修改可用资源：Available &#x3D; Available[i, j] + Request<del>i</del>[j]</li><li>修改已分配资源：Allocation[i, j] &#x3D; Allocation[i, j] + Request<del>i</del>[j]</li><li>修改最多还需要的资源：Need[i, j] &#x3D; Need[i, j] - Request<del>i</del>[j]</li></ul></li><li><p>操作系统执行安全性算法，检查此次资源分配后，系统是否处于安全状态。若安全，才正式分配；否则，恢复相应数据，让进程阻塞等待。</p></li></ol><h4 id="检测和解除"><a href="#检测和解除" class="headerlink" title="检测和解除"></a>检测和解除</h4><p><strong>死锁的检测</strong></p><p>死锁定理：如果某时刻系统的资源分配图是不可完全简化的，那么此时系统死锁</p><p>如果按上述过程分析，最终能消除所有边，就称这个图是可完全简化的。此时一定没有发生死锁(相当于能我<br>到一个安全序列)</p><p><strong>死锁的解除</strong></p><p>一旦检测出死锁的发生，就应该立即解除死锁。</p><img src="https://s2.loli.net/2022/11/01/Xcpa5EmitFlfP8x.png" class="lazyload" data-srcset="https://s2.loli.net/2022/11/01/Xcpa5EmitFlfP8x.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="0E9AB9562DAC988D63F2405D4B055932.png" style="zoom:67%;" /><p>补充：并不是系统中所有的进程都是死锁状态，用死锁检测算法化简资源分配图后，还连着边的那些进程就是死锁进程</p><p>解除死锁的主要方法有：</p><ol><li><strong>资源剥夺法</strong>。挂起〈暂时放到外在上，基些死锁进程，并抢占它的资源，将这些资源分配给其他的死锁进程。但是应防止被挂起的进程长时间得不到资源而饥饿。</li><li><strong>撤销进程法</strong>（或称终止进程法）。强制撤销部分、甚至全部死锁进程，并剥夺这些进程的资源。这种方式的优点是实现简单，但所付出的代价可能会很大。因为有些进程可能已经运行了很长时间，己经接近结束了，一旦被终止可谓功亏一篑，以后还得从头再来。</li><li><strong>进程回退法</strong>。让一个或多个死锁进程回退到足以避免死锁的地步。这就要求系统要记录进程的历史信息，设置还原点。</li></ol><h1 id="三、内存"><a href="#三、内存" class="headerlink" title="三、内存"></a>三、内存</h1><h3 id="3-1-内存的概念"><a href="#3-1-内存的概念" class="headerlink" title="3.1 内存的概念"></a>3.1 内存的概念</h3><p>内存是用于存放数据的硬件。程序执行前需要先放到内存中才能被CPU处理。</p><h4 id="装入的三种方式"><a href="#装入的三种方式" class="headerlink" title="装入的三种方式"></a>装入的三种方式</h4><p><strong>绝对装入</strong>：在编译时，如果知道程序将放到内存中的哪个位置，编译程序将产生绝对地址的目标代码。装入程序按照装入模块中的地址，将程序和数据装入内存。</p><p>注意：绝对装入只适用于单道程序环境</p><p><strong>静态重定位</strong>：又称可重定位装入。编译、链接后的装入模块的地址都是从0开始的，指令中使用的地址、数据存放的地址都是相对于起始地址而言的逻辑地址。可根据内存的当前情况，将装入模块装入到内存的适当位置。装入时对地址进行”重定位”，将逻辑地址变换为物理地址(地址变换是在装入时一次完成的)。</p><p>静态重定位的特点：在一个作业装入内存时，必须分配其要求的全部内存空间，如果没有足够的内存，就不能装入该作业。</p><p><strong>动态重定位</strong>：又称动态运行时装入。编译、链接后的装入模块的地址都是从0开始的。装入程序把装入模块装入内存后，并不会立即把逻辑地址转换为物理地址，而是把地址转换推迟到程序真正要执行时才进行。因此装入内存后所有的地址依然是逻辑地址。这种方式需要一个重定位寄存器的支持。</p><p>采用动态重定位时允许程序在内存中发生移动。</p><h4 id="链接的三种方式"><a href="#链接的三种方式" class="headerlink" title="链接的三种方式"></a>链接的三种方式</h4><ul><li>静态链接：在程序运行之前，先将各目标模块及它们所需的库函数连接成一个完整的可执行文件(装入模块)，之后不再拆开。</li><li>装入时动态链接：将各目标模块装入内存时，边装入边链接的链接方式。</li><li>运行时动态链接：在程序执行中需要该目标模块时，才对它进行链接。其优点是便于修改和更新，便于实现对<br>目标模块的共享。</li></ul><h3 id="3-2-内存管理"><a href="#3-2-内存管理" class="headerlink" title="3.2 内存管理"></a>3.2 内存管理</h3><ol><li>操作系统负责内存空间的分配与回收</li><li>操作系统需要提供某种技术从逻辑上对内存空间进行扩充</li><li>操作系统需要提供地址转换功能，负责程序的逻辑地址与物理地址的转换</li><li>操作系统需要提供内存保护功能。保证各进程在各自存储空间内运行，互不干扰</li></ol><h4 id="内存保护"><a href="#内存保护" class="headerlink" title="内存保护"></a>内存保护</h4><p>防止某进程更改操作系统所在的内存或者别的进程的内存</p><p>内存保护的两种方法：</p><ol><li>在CPU中设置一对上、下限寄存器，存放进程的上、下限地址。进程的指令要访问某个地址时，CPU检查是否越界</li><li>采用重定位寄存器(又称基址寄存器)和界地址寄存器(又称限长寄存器)进行越界检查。重定位寄存器中存放的是进程的起始物理地址。界地址寄存器中存放的是进程的最大逻辑地址</li></ol><h4 id="内存扩充"><a href="#内存扩充" class="headerlink" title="内存扩充"></a>内存扩充</h4><p><strong>覆盖技术</strong></p><blockquote><p>覆盖技术的思想：将程序分为多个段(多个模块)。</p><p>常用的段常驻内存，不常用的段在需要时调入内存。</p><p>内存中分为一个”固定区”和若干个”覆盖区”。</p><p>需要常驻内存的段放在”固定区”中，调入后就不再调出(除非运行结束)</p><p>不常用的段放在”覆盖区”，需要用到时调入内存，用不到时调出内存</p></blockquote><p>按照自身逻辑结构，让那些<strong>不可能同时被访问的程序段</strong>共享同一个覆盖区</p><img src="https://s2.loli.net/2022/11/01/6ZA9b2RLdspCIrQ.png" class="lazyload" data-srcset="https://s2.loli.net/2022/11/01/6ZA9b2RLdspCIrQ.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221101130044842.png" style="zoom: 50%;" /><p>必须由程序员声明覆盖结构，操作系统完成自动覆盖。缺点：对用户不透明，增加了用户编程负担。</p><p>覆盖技术只用于早期的操作系统中，现在已<strong>成为历史</strong>。</p><p><strong>交换技术</strong></p><p>交换(对换)技术的设计思想：内存空间紧张时，系统将内存中某些进程暂时换出外存，把外存中某些已具备运行条件的进程换入内存(进程在内存与磁盘间动态调度)</p><p>暂时换出外存等待的进程状态为挂起状态(挂起态，suspend)</p><p>挂起态又可以进一步细分为就绪挂起、阻塞挂起两种状态</p><ul><li><p>具有对换功能的操作系统中，通常把磁盘空间分为<strong>文件区</strong>和<strong>对换区</strong>两部分。文件区主要用于存放文件，主要追求存储空间的利用率，因此对<strong>文件区</strong>空间的管理采用<strong>离散分配方式</strong>；对换区空间只占磁盘空间的小部分，被换出的进程数据就存放在对换区。由我对换的速度直按影响到系统的整体速度，因此对换区空问的管理主要追求换入换出度，因此通常<strong>对换区</strong>采用<strong>连续分配方式</strong>。总之，对换区的I&#x2F;O速度比文件区的更快</p></li><li><p>交换通常在许多进程运行且内存吃紧时进行，而系统负荷降低就暂停。</p><p>例如：在发现许多进程运行时经常发生缺页，就说明内存紧张，此时可以换出一些进程；如果缺页率明显下降，就可以暂停换出。</p></li><li><p>可优先换出阻塞进程；可换出优先级低的进程；为了防止优先级低的进程在被调入内存后很快又被换出，有的系统还会考虑进程在内存的驻留时间…</p></li></ul><p>注意：PCB会常驻内存，不会被换出内存</p><h3 id="3-3-连续分配管理方式"><a href="#3-3-连续分配管理方式" class="headerlink" title="3.3 连续分配管理方式"></a>3.3 连续分配管理方式</h3><h4 id="单一连续分配"><a href="#单一连续分配" class="headerlink" title="单一连续分配"></a>单一连续分配</h4><p>在单一连续分配方式中，内存被分为系统区和用户区。</p><p>系统区通常位于内存的低地址部分，用于存放操作系统相关数据；用户区用于存放用户进程相关数据。</p><p>内存中只能有一道用户程序，用户程序独占整个用户区空间。</p><ul><li><p>优点：实现简单；无外部碎片：可以采用覆盖技术扩充</p></li><li><p>内存：不一定需要采取内存保（eg：早期的 PC操作系統 MS-DOS)。</p></li><li><p>缺点：只能用于单用户、单任务的操作系统中；有内部碎片：存储器利用率极低。</p><p>分配给某进程的内存区域中，如果有些部分没有用就是”内部碎片“</p></li></ul><h4 id="固定分区分配"><a href="#固定分区分配" class="headerlink" title="固定分区分配"></a>固定分区分配</h4><p>20世纪60年代出现了支持多道程序的系统，为了能在内存中装入多道程序，且这些程序之问又不会相互干扰，于是将整个用户空间划分为若干个固定大小的分区，在每个分区中只装入一道作业，这样就形成了最早的、最简单的一种可运行多道程序的内存管理方式。</p><ul><li><p>分区大小相等：缺乏灵活性，但是很适合用于用一台计算机控制多个相同对象的场合(比如：钢铁厂有n个相同的炼钢炉，就可把内存分为n个大小相等的区域存放n个炼钢炉控制程序)</p></li><li><p>分区大小不等：增加了灵活性，“可以满足不同大小的进程需求。根据常在系统中运行的作业大小情况进行划分(比如：划分多个小分区、适量中等分区、少量大分区)</p></li></ul><p>操作系统需要建立一个数据结构一一分区说明表，来实现各个分区的分配与回收。每个表项对应一个分区，通常按分区大小排列。每个表项包括对应分区的**大小、起始地址、状态(是否己分配)**。</p><p>当某用户程序要装入内存时，由操作系统内核程序根据用户程序大小检索该表，从中找到一个能满足大小的、未分配的分区，将之分配给该程序，然后修改状态为”已分配”。</p><ul><li><p>优点：实现简单，无外部碎片。</p></li><li><p>缺点：</p><ul><li><p>当用户程序太大时，可能所有的分区都不能满足需求，此时不得不采用覆盖技术来解决，但这又会降低性能；</p></li><li><p>会产生内部碎片，内存利用率低。</p></li></ul></li></ul><h4 id="动态分区分配"><a href="#动态分区分配" class="headerlink" title="动态分区分配"></a>动态分区分配</h4><p>动态分区分配又称为可变分区分配。这种分配方式不会预先划分内存分区，而是在进程装入内存时，根据进程的大小动态地建立分区，并使分区的大小正好适合进程的需要。因此系统分区的大小和数目是可变的。</p><ul><li>空闲分区表：每个空闲分区对应一个表项。表项中包含分区号、分区大小、分区起始地址等信息</li><li>空闲分区链：每个分区的起始部分和末尾部分分别设置前向指针和后向指针。起始部分处还可记录分区大小等信息</li></ul><p>动态分区分配没有内部碎片，但是有外部碎片。</p><ul><li>内部碎片，分配给某进程的内存区域中，如果有些部分没有用上。</li><li>外部碎片，是指内存中的某些空闲分区由于太小而难以利用。</li></ul><p>如果内存中空闲空间的总和本来可以满足某进程的要求，但由于进程需要的是一整块连续的内存空间，因此这些”碎片”，不能满足进程的需求。可以通过紧凑(拼凑，Compaction)技术来解决外部碎片。</p><h3 id="3-4-动态分区分配算法"><a href="#3-4-动态分区分配算法" class="headerlink" title="3.4 动态分区分配算法"></a>3.4 动态分区分配算法</h3><h4 id="首次适应算法-First-Fit"><a href="#首次适应算法-First-Fit" class="headerlink" title="首次适应算法(First Fit)"></a>首次适应算法(First Fit)</h4><p>算法思想：每次都从低地址开始查找，找到第一个能满足大小的空闲分区。</p><p>如何实现：空闲分区<strong>以地址递增的次序</strong>排列。每次分配内存时顺序查找空闲分区链(或空闲分区表)，找到大小能满足要求的第一个空闲分区。</p><p>四种算法中，<strong>首次适应算法</strong>的效果的反而更好</p><h4 id="最佳适应算法-Beat-Fit"><a href="#最佳适应算法-Beat-Fit" class="headerlink" title="最佳适应算法(Beat Fit)"></a>最佳适应算法(Beat Fit)</h4><p>算法思想：由于动态分区分配是一种连续分配方式，为各进程分配的空间必须是连续的一整片区域。因此<strong>为了保证当”大进程”到来时能有连续的大片空间</strong>，可以尽可能多地留下大片的空闲区，即，<strong>优先使用更小的空闲区</strong>。</p><p>如何实现：空闲分区<strong>按容量递增次序</strong>链接。每次分配内存时顺序查找空闲分区链(或空闲分区表)，找到大小能满足要求的第一个空闲分区。</p><p>缺点：每次都选最小的分区进行分配，<strong>会留下越来越多的、很小的、难以利用的内存块</strong>。因此这种方法会产生很多的外部碎片。</p><h4 id="最坏适应算法-Worst-Fit"><a href="#最坏适应算法-Worst-Fit" class="headerlink" title="最坏适应算法(Worst Fit)"></a>最坏适应算法(Worst Fit)</h4><p>又称<strong>最大适应算法 (Largest Fit)</strong></p><p>算法思想：为了解决最佳适应算法的问题一一即留下太多难以利用的小碎片，可以在每次分配时<strong>优先使用最大的连续空闲区</strong>，这样分配后剩余的空闲区就不会太小，更方便使用。</p><p>如何实现：空闲分区<strong>按容量递减次序</strong>链接。每次分配内存时顺序查找空闲分区链(或空闲分区表)，找到大小能满足要求的第一个空闲分区。</p><p>缺点：每次都选最大的分区进行分配，虽然可以让分配后留下的空闲区更大，更可用，但是这种方式会导致较大的连续空闲区被迅速用完。如果之后有”大进程”到达，就没有内存分区可用了。</p><h4 id="邻近适应算法-Next-Fit"><a href="#邻近适应算法-Next-Fit" class="headerlink" title="邻近适应算法(Next Fit)"></a>邻近适应算法(Next Fit)</h4><p>算法思想：首次适应算法每次都从链头开始查找的。这可能会导致低地址部分出现很多小的空闲分区，而每次分配查找时，都要经过这些分区，因此也增加了查找的开销。如果每次都从上次查找结束的位置开始检索，就能解决上述问题。</p><p>如何实现：空闲分区<strong>以地址递增的顺序排列</strong>(可排成一个<strong>循环链表</strong>)。每次分配内存时<strong>从上次查找结束的位置开始查找</strong>空闲分区链(或空闲分区表)，找到大小能满足要求的第一个空闲分区。</p><p>首次适应算法每次都要从头查我，每次都需要检索低地址的小分区。但是这种规则也决定了当低地址部分有更小的分区可以满足需求时，会更有可能用到低地址部分的小分区，也会更有可能把高地址部分的大分区保留下来(最佳适应算法的优点)</p><p>邻近适应算法的规则可能会导致无论低地址、高地址部分的空闲分区都有相同的概率被使用，也就导致了高地址部分的大分区更可能被使用，划分为小分区，最后导致无大分区可用(最大适应算法的缺点)</p><h3 id="3-5-基本分页存储管理"><a href="#3-5-基本分页存储管理" class="headerlink" title="3.5 基本分页存储管理"></a>3.5 基本分页存储管理</h3><p>考虑支持多道程序的两种连续分配方式：</p><ul><li>固定分区分配：缺乏灵活性，会产生大量的内部碎片，内存的利用率很低。</li><li>动态分区分配：会产生很多外部碎片，虽然可以用”紧湊”技术来处理，但是”紧凑”的时间代价很高</li></ul><p>如果允许将一个进程分散地装入到许主不相邻的分区中，便可充分地利用内存，而无需再进行”紧凑”</p><p>基于这一思想，产生了”非连续分配方式”，或者称为”离散分配方式”</p><h4 id="思想"><a href="#思想" class="headerlink" title="思想"></a>思想</h4><p><strong>基本分页存储管理思想</strong>：把内存分为一个个相等的小分区，再按照分区大小把进程拆分成一个个小部分</p><p>物理地址：</p><p>将<strong>内存空间</strong>分为一个个大小相等的分区(比如：每个分区4KB)，每个分区就是一个”页框”(或称”页帧”、”内存<br>块”、”物理块”)。每个页框有一个编号，即”页框号”(或者”内存块号”、”页帧号”、”物理块号”)<strong>页框号从0开始。</strong></p><p>逻辑地址：</p><p>将用户进程的地址空间也分为与页框大小相等的一个个区域，称为”页”或”页面”。每个页面也有一个编号，即”页号”，页号也是从0开始。</p><p>各个页面不必连续存放，也不必按先后顺序来，可以放到不相邻的各个页框中。</p><h4 id="实现地址的转换"><a href="#实现地址的转换" class="headerlink" title="实现地址的转换"></a>实现地址的转换</h4><ol><li>要算出逻辑地址对应的页号</li><li>要知道该页号对应页面在内存中的起始地址</li><li>要算出逻辑地址在页面内的”偏移”</li><li>物理地址&#x3D;页面始址 + 页内偏移量</li></ol><p><code>页号 = 逻辑地址/页面长度(取除法的整数部分)</code></p><p><code>页内偏移量 = 逻辑地址%页面长度</code></p><p>如果有K位表示”页内偏移量”，则说明该系统中一个页面的大小是2^K^个内存单元</p><p>如果有M 位表示”页号”，则说明在该系统中，一个进程最多允许有2^M^ 个页面</p><h4 id="页表"><a href="#页表" class="headerlink" title="页表"></a>页表</h4><p>为了能知道进程的每个页面在内存中存放的位置，操作系统要为每个进程建立一张页表。</p><p>页表：</p><table><thead><tr><th>页号(逻辑地址)</th><th>块页(物理地址)</th></tr></thead><tbody><tr><td>0</td><td>3</td></tr><tr><td>1</td><td>6</td></tr><tr><td>2</td><td>4</td></tr><tr><td>…</td><td>…</td></tr><tr><td>n</td><td>8</td></tr></tbody></table><ol><li>一个进程对应一张页表</li><li>进程的每一页对应一个页表项</li><li>每个页表项由”页号”和”块号”组成</li><li>页表记录<strong>进程页面</strong>和<strong>实际存放的内存块</strong>之间的对应关系</li></ol><p>假设某系统物理内存大小为 4GB，页面大小为 4KB，则每个页表项至少应该为多少字节？</p><blockquote><p>4GB&#x3D; 232B， 4KB &#x3D; 212B</p><p>因此4GB 的内存总共会被分为 2^32^&#x2F;2^12^ &#x3D; 2^20^个内存块，因此内存块号的范围应该是0~2^20^-1</p><p>因此至少要 20 个二进制位才能表示这么多的内存块号，因此至少要3个字节才够</p></blockquote><p>各页表项会按顺序连续地存放在内存中</p><p>如果该页表在内存中存放的起始地址为x，则M号页对应的页表项一定是存放在内存地址为<code>x+3*M</code></p><p>如果一个页面为 4KB，则每个页框可以存放 4096&#x2F;3&#x3D;1365个页表项，但是这个页框会剩余 <code>4096%3=1B</code>页内碎片<br>因此，1365 号页表项存放的地址为<code>x +3*1365 +1</code></p><ul><li>如果每个页表项占4个字节，则每个页框刚好可存放 1024个页表项1024号页表项虽然是存放在下一个页框中的，但是它的址址依然可以用<code>x+44*1024</code>得出</li></ul><p>结论：理论上，页表项长度为3B 即可表示内存块号的范围，但是，为了方便页表的查询，常常会让一个页表项占更多的字节，使得每个页面恰好可以装得下整数个页表项。</p><h4 id="基地址变换机构"><a href="#基地址变换机构" class="headerlink" title="基地址变换机构"></a>基地址变换机构</h4><p>例：若页面大小<code>L</code>为1K字节，页号2对应的内存块号b&#x3D;8，将逻辑地址 <code>A</code>&#x3D;2500 转换为物理地址E。<br>等价描述：某系统按字节寻址，逻辑地址结构中，页内偏移量占10位，页号2对应的内存块号b&#x3D;8，将逻辑地址 A&#x3D;2500 转换为物理地址E。</p><blockquote><p>页内偏移量占10位：说明一个页面的大小为 2^10^B&#x3D; 1KB</p><ol><li><p>计算页号、页内偏移量</p><ul><li><p>页号：P&#x3D;A&#x2F;L&#x3D;2500&#x2F;1024&#x3D;2</p></li><li><p>页内偏移量：W&#x3D;A%L&#x3D;2500%1024 &#x3D; 452</p></li></ul></li><li><p>根据题中条件可知，<strong>页号2没有越界</strong>，其存放的内存块号b&#x3D;8</p></li><li><p>物理地址<code>E=b*L+W = 8*1024 + 452 = 8644</code></p></li></ol></blockquote><p>在分页存储管理(页式管理)的系统中，只要确定了<strong>每个页面的大小</strong>，逻辑地址结构就确定了。因此，页式管理中地址是一维的。即，<strong>只要给出一个逻辑地址</strong>，系统就可以自动地算出页号、页内偏移量两个部分，并不需要显式地告诉系统这个逻辑地址中，页内偏移量占多少位。</p><h4 id="快表地址变换机构"><a href="#快表地址变换机构" class="headerlink" title="快表地址变换机构"></a>快表地址变换机构</h4><p>局部性原理：</p><ul><li><p>时间局部性：如果执行了程序中的某条指令，那么不久后这条指令很有可能再次执行；如果某个数据被访问过，不久之后该数据很可能再次被访问。(因为程序中存在大量的循环)</p></li><li><p>空间局部性：一旦程序访问了某个存储单元，在不久之后，其附近的存储单元也很有可能被访问。(因为很多数据在内存中都是连续存放的)</p></li></ul><p>在基本地址变换机构中，每次要访问一个逻辑地址，都需要查询内存中的页表。由于局部性原理，<strong>可能连续很多次查到的都是同一个页表项</strong>。既然如此，能否利用这个特性减少访问页表的次数呢？</p><p>快表，又称联想寄存器(TLB)，是一种访问速度比内存快很多的<strong>高速缓冲存储器</strong>，用于存放当前访问的若干页表项，以加速地址变换的过程。与此对应，<strong>内存中的页表常称为慢表</strong>。</p><ol><li>CPU<strong>给出逻辑地址</strong>，由某个硬件<strong>算得页号、页内偏移量</strong>，将<strong>页号与快表</strong>中的所有页号进行<strong>比较</strong>。</li><li>如果<strong>找到匹配</strong>的页号，说明要访问的页表项在快表中有副本，则直接从中<strong>取出该页对应的内存块号</strong>，再将内存块号与页内偏移量<strong>拼接形成物理地址</strong>，最后，访问该物理地址对应的内存单元。因此，若快表命中，则<strong>访问某个逻辑地址仅需一次访存</strong>即可。</li><li>如果<strong>没有找到匹配</strong>的页号，则需要<strong>访问内存中的页表</strong>，找到对应页表项，<strong>得到页面存放的内存块号</strong>，再将内存块号与页内偏移量<strong>拼接形成物理地址</strong>，最后，访问该物理地址对应的内存单元。因此，若快表未命中，则<strong>访问某个逻辑地址需要两次访存</strong>(注意：在找到页表项后，应同时将其存入快表，以便后面可能的再次访问。<strong>但若快表已满，则必须按照一定的算法对旧的页表项进行替换</strong>)</li></ol><p>由于查询快表的速度比查询页表的速度快很多，因此只要快表命中，就可以节省很多时间。因为局部性原理，一般来说<strong>快表的命中率可以达到 90%以上</strong>。</p><h4 id="两级页表"><a href="#两级页表" class="headerlink" title="两级页表"></a>两级页表</h4><p>单极页表的问题：</p><ul><li>页表必须连续存放，因此当页表很大时，需要占用很多个连续的页框。</li><li>没有必要让整个页表常驻内存，因为进程在一段时间内可能只需要访问某几个特定的页面。</li></ul><p>可将长长的页表进行分组，使每个内存块刚好可以放入一个分组(比如上个例子中，页面大小4KB，每个页表项4B，每个页面可存放1K 个页表项，因此每 1K 个连续的页表项为一组，每组刚好占一个内存块，再讲各组离散地放到各个内存块中)</p><p><img src="https://s2.loli.net/2022/11/07/ApkcweubKaTVOZU.png" class="lazyload" data-srcset="https://s2.loli.net/2022/11/07/ApkcweubKaTVOZU.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221107131103128.png"></p><p>可以在需要访间页面时才把页面调入内存(虚拟存储技术)。可以在页表项中增加一个标志位，用于表示该页面是否已经调入内存</p><p>若想访问的页面不在内存中，则产生缺页中断(内中断)，然后将目标页面从外存调入内存</p><p>若采用多级页表机制，则各级页表的大小不能超过一个页面</p><p>例：某系统按字节编址，采用40位逻辑地址，页面大小为 4KB，页表项大小为 4B，假设采用纯页式存储，则要采用（）级页表，页内偏移量为（）位？</p><ul><li>页面大小&#x3D;4KB&#x3D;2^12^B，按字节编址，因此页内偏移量为12位</li><li>页号&#x3D;40-12&#x3D;28位</li><li>页面大小&#x3D;2^12^B，页表项大小&#x3D;4B，则每个页面可存放2^12^ &#x2F; 4&#x3D;2^10^个页表项</li></ul><p>因此各级页表最多包含2^10^个页表项，需要10位二进制位才能映射到2^10^个页表项，因此每一级的页<br>表对应页号应为10位。总共28位的页号至少要分为三级</p><p>逻辑地址：<code>一级页表(8位) + 二级页表(10位) + 三级页表(10位) + 页内偏移量(12位)</code></p><p>两级页表的访存次数分析(假设没有快表机构)</p><ul><li>第一次访存：访问内存中的页目录表</li><li>第二次访存：访问内存中的二级页表</li><li>第三次访存：访问目标内存单元</li></ul><h3 id="3-6-基本分段存储管理"><a href="#3-6-基本分段存储管理" class="headerlink" title="3.6 基本分段存储管理"></a>3.6 基本分段存储管理</h3><h4 id="分段"><a href="#分段" class="headerlink" title="分段"></a>分段</h4><p>进程的地址空问：按照程序自身的逻辑关系划分为若干个段，每个段都有一个段名(在低级语言中，程序员使用段名来编程)，每段从0开始编址</p><p>内存分配规则：以段为单位进行分配，每个段在内存中占据连续空间，但各段之间可以不相邻。</p><p><img src="https://s2.loli.net/2022/11/07/qVnFN43KSa5TABx.png" class="lazyload" data-srcset="https://s2.loli.net/2022/11/07/qVnFN43KSa5TABx.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221107133248612.png"></p><h4 id="分页、分段对比"><a href="#分页、分段对比" class="headerlink" title="分页、分段对比"></a>分页、分段对比</h4><p>页是信息的物理单位。分页的主要目的是为了实现离散分配，提高内存利用率。分页仅仅是系统管理上的需要，完全是系统行为，对用户是不可见的。</p><p>段是信息的逻辑单位。分段的主要目的是更好地满足用户需求。一个段通常包含着一组属于一个逻辑模块的信息。</p><p>分段对用户是可见的，用户编程时需要显式地给出段名。</p><p>页的大小固定且由系统决定。段的长度却不固定，决定于用户编写的程序。</p><p>分页的用户进程地址空间是一维的，程序员只需给出一个记忆符即可表示一个地址。</p><p>分段的用户进程地址空间是二维的，程序员在标识一个地址时，既要给出段名，也要给出段内地址。</p><p>分段比分页更容易实现信息的共享和保护。不能被修改的代码称为纯代码或可重入代码(不属于临界资源)，这样的代码是可以共享的。可修改的代码是不能共享的</p><p>访问一个逻辑地址需要几次访存？</p><ul><li>分页(单级页表)：<ul><li>第一次访存一一查内存中的页表</li><li>第二次访存一一访问目标内存单元。</li><li>总共两次访存</li></ul></li><li>分段：<ul><li>第一次访存一一查内存中的段表</li><li>第二次访存一一访问目标内存单元。</li><li>总共两次访存与分页系统类似，分段系统中也可以引入快表机构，将近期访问过的段表项放到快表中，这样可以少一次访问，加快地址变换速度。</li></ul></li></ul><h3 id="3-7-段页管理方式"><a href="#3-7-段页管理方式" class="headerlink" title="3.7 段页管理方式"></a>3.7 段页管理方式</h3><h4 id="分页、分段的优缺点"><a href="#分页、分段的优缺点" class="headerlink" title="分页、分段的优缺点"></a>分页、分段的优缺点</h4><table><thead><tr><th></th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>分页管理</td><td>内存空间利用率高，<br>不会产生外部碎片，只念有少量的页内碎片</td><td>不方便按照逻辑模块实现信息的共享和保护</td></tr><tr><td>分段管理</td><td>很方便按照逻辑模块实现信息的共享和保护</td><td>如果段长过大，<br>为其分配很大的连续空间会很不方便。<br>另外，段式管理会产生外部碎片</td></tr></tbody></table><h4 id="段页式管理的逻辑地址"><a href="#段页式管理的逻辑地址" class="headerlink" title="段页式管理的逻辑地址"></a>段页式管理的逻辑地址</h4><p><strong>分段系统的逻辑地址结构</strong>由<code>段号</code>和<code>段内地址(段內偏移量)</code>组成。</p><p><strong>段页式系统的逻辑地址结构</strong>由<code>段号</code>、<code>页号</code>、<code>页内地址(页内偏移量)</code>组成。</p><ul><li><p>“分段”对用户是可见的，程序员编程时需要显式地给出<code>段号</code>、<code>段内地址</code>。</p><p>而将各段”分页”对用户是不可见的。</p><p>系统会根据段内地址<strong>自动划分</strong>页号和页内偏移量。因此段页式管理的地址结构是二维的。</p></li><li><p>段号的位数决定了每个进程最多可以分几个段</p></li><li><p>页号位数决定了每个段最大有多少页</p></li><li><p>页内偏移量决定了页面大小、内存块大小是多少</p></li></ul><p>在上述例子中，若系统是按字节寻址的，则</p><ul><li>段号占16位，因此在该系统中，每个进程最多有2^16^&#x3D;64K 个段</li><li>页号占4位，因此每个段最多有2^4^&#x3D;16页</li><li>页内偏移量占12位，因此每个页面每个内存块大小为 2^12^&#x3D;4KB</li></ul><h4 id="段表、页表"><a href="#段表、页表" class="headerlink" title="段表、页表"></a>段表、页表</h4><p>每个段对应一个段表项，每个段表项由段号、页表长度、页表存放块号(页表起始地址)组成。每个段表项长度相等，段号是隐含的。</p><p>每个页面对应一个页表项，每个页表项由页号、页面存放的内存块号组成。每个页表项长度相等，页号是隐含的。</p><h4 id="地址变换"><a href="#地址变换" class="headerlink" title="地址变换"></a>地址变换</h4><ol><li>由<strong>逻辑地址</strong>得到<code>段号</code>、<code>页号</code>、<code>页内偏移量</code></li><li><code>段号</code>与<code>段表寄存器中的段长度</code>比较，<strong>检查是否越界</strong></li><li>由**<code>段表始址、段号</code>**找到对应<code>段表项</code>(<strong>第一次访存，查段表</strong>)</li><li>根据<code>段表</code>中记录的<code>页表长度</code>，<strong>检查页号是否越界</strong></li><li>由**<code>段表</code>中的<code>页表地址</code>、<code>页号</code>**得到查询页表，找到相应<code>页表项</code>(<strong>第二次访存，查页表</strong>)</li><li>由<code>页面</code>存放的<code>内存块号</code>、<code>页内偏移量</code>得到最终的<strong>物理地址</strong></li><li>访问目标单元(第三次访存)</li></ol><p>如果采用<strong>快表机构</strong>，若快表命中，则只需一次访存</p><h3 id="3-8-虚拟内存"><a href="#3-8-虚拟内存" class="headerlink" title="3.8 虚拟内存"></a>3.8 虚拟内存</h3><h4 id="传统存储管理方式"><a href="#传统存储管理方式" class="headerlink" title="传统存储管理方式"></a>传统存储管理方式</h4><ul><li><p>一次性：作业必须一次性全部装入内存后才能开始运行。</p><p>这会造成两个问题：</p><ol><li>作业很大时，不能全部装入内存，导致大作业无法运行</li><li>当大量作业要求运行时，由于内存无法容纳所有作业，因此只有少量作业能运行，导致多道程序并发度下降。</li></ol></li><li><p>驻留性：一旦作业被装入内存，就会一直驻留在内存中，直至作业运行结束。</p><p>事实上，在一个时间段内，只需要访问作业的一小部分数据即可正常运行，这就导致了内存中会驻留大量的、惩时用不到的数据，浪费了宝贵的内存资源。</p></li></ul><p>很多暂时用不到的数据也会长期占用内存，导致内存利用率不高</p><h4 id="虚拟内存的定义"><a href="#虚拟内存的定义" class="headerlink" title="虚拟内存的定义"></a>虚拟内存的定义</h4><p>局部性原理：</p><ul><li><p>时间局部性：如果执行了程序中的某条指令，那么不久后这条指令很有可能再次执行；</p><p>如果某个数据被访问过，不久之后该数据很可能再次被访问。（因为程序中存在大量的循环）</p></li><li><p>空间局部性：一旦程序访问了某个存储单元，在不久之后，其附近的存储单元也很有可能被访问。</p><p>（因为很多数据在内存中都是连续存放的，并且程序的指令也是顺序地在内存中存放的）</p></li></ul><p>高速缓冲技术的思想：将近期会频繁访间到的数据放到更高速的存储器中，暂时用不到的数据放在更低速存储器中。</p><p>基于局部性原理，在程序装入时，可以将程序中很快会用到的部分装入内存，暂时用不到的部分留在外存，就可以让程序开始执行。</p><ul><li><p>在程序执行过程中，当所访问的信息不在内存时，由操作系统负责将所需信息从外存调入内存，然后继续执行程序。</p></li><li><p>若内存空间不够，由操作系统负责将内存中暂时用不到的信息换出到外存。</p></li></ul><p>在操作系统的管理下，在用户看来似乎有一个比实际内存大得多的内存，这就是虚拟内存</p><h4 id="虚拟内存的容量"><a href="#虚拟内存的容量" class="headerlink" title="虚拟内存的容量"></a>虚拟内存的容量</h4><ul><li>虚拟内存的最大容量是由计算机的地址结构(CPU寻址范围)确定的</li><li>虚拟内存的实际容量&#x3D;min(内存和外存容量之和，CPU寻址范围)</li></ul><p>如：某计算机地址结构为32位，按字节编址，内存大小为512MB，外存大小为2GB。</p><ul><li>则虚拟内存的最大容量为 2^32^B&#x3D;4GB</li><li>虚拟内存的实际容量&#x3D;min(512MB+2GB, 2^32^)&#x3D;2GB+512MB</li></ul><h4 id="虚拟内存的特征"><a href="#虚拟内存的特征" class="headerlink" title="虚拟内存的特征"></a>虚拟内存的特征</h4><p>虚拟内存有一下三个主要特征：</p><ul><li>多次性：无需在作业运行时一次性全部装入内存，而是允许被分成多次调入内存。</li><li>对换性：在作业运行时无需一直常驻内存，而是允许在作业运行过程中，将作业换入、换出。</li><li>虚拟性：从逻辑上扩充了内存的容量，使用户看到的内存容量，远大于实际的容量。</li></ul><h4 id="实现虚拟内存技术"><a href="#实现虚拟内存技术" class="headerlink" title="实现虚拟内存技术"></a>实现虚拟内存技术</h4><p>虛拟内存技术，允许一个作业分多次调入内存。如果采用连续分配方式，会不方便实现。因此，虛拟内存的实现需要建立在离散分配的内存管理方式基础上。</p><p>虚拟内存的实现：</p><ul><li>请求分页存储管理</li><li>请求分段存储管理</li><li>请求段页式存储管理</li></ul><p>主要区别：</p><p>在程序执行过程中，</p><ul><li><p>当<strong>所访问的信息不在内存</strong>时，由操作系统负责将所需信息从外存调入内存，然后继续执行程序。</p><p>操作系统要提供请求调页（或请求调段）功能</p></li><li><p>若<strong>内存空间不够</strong>时，由操作系统负责将内存中暂时用不到的信息换出到外存。</p><p>操作系统要提供页面置换（或段置换）的功能</p></li></ul><h3 id="3-9-请求分页管理方式"><a href="#3-9-请求分页管理方式" class="headerlink" title="3.9 请求分页管理方式*"></a>3.9 请求分页管理方式*</h3><h4 id="页表机制"><a href="#页表机制" class="headerlink" title="页表机制"></a>页表机制</h4><h4 id="缺页中断机构"><a href="#缺页中断机构" class="headerlink" title="缺页中断机构"></a>缺页中断机构</h4><h4 id="地址变换机构"><a href="#地址变换机构" class="headerlink" title="地址变换机构"></a>地址变换机构</h4><h3 id="3-10-页面置换算法"><a href="#3-10-页面置换算法" class="headerlink" title="3.10 页面置换算法"></a>3.10 页面置换算法</h3><p>请求分页存储管理与基本分页存储管理的主要区别：</p><ul><li>在程序执行过程中，当所访问的信息不在内存时，由操作系统负责将所需信息从外存调入内存，然<br>后继续执行程序。</li><li>若内存空间不够，由操作系统负责将内存中暂时用不到的信息换出到外存。</li></ul><p>用页面置换算法决定应该换出哪个页面</p><h4 id="最佳置换算法-OPT"><a href="#最佳置换算法-OPT" class="headerlink" title="最佳置换算法(OPT)"></a>最佳置换算法(OPT)</h4><p>最佳置换算法(OPT, Optimal)：每次选择淘汰的页面将是以后永不使用，或者在最长时间内不再被访问的页面，这样可以保证最低的缺页率。<br>例：假设系统为某进程分配了三个内存块，并考虑到有一下页面号引用串(会依次访问这些页面)：<br>7, 0, 1, 2, 0, 3, 0, 4, 2, 3, 0, 3, 2, 1, 2, 0, 1, 7, 0, 1</p><table><thead><tr><th>访问页面</th><th>7</th><th>0</th><th>1</th><th><span style="color:red">2</span></th><th><span style="color:blue">0</span></th><th>3</th><th>0</th><th>4</th><th>2</th><th>3</th><th>0</th><th>3</th><th>2</th><th><span style="color:blue">1</span></th><th>2</th><th>0</th><th>1</th><th><span style="color:blue">7</span></th><th>0</th><th>1</th></tr></thead><tbody><tr><td>内存块1</td><td>7</td><td>7</td><td>7</td><td>2</td><td></td><td>2</td><td></td><td>2</td><td></td><td></td><td>2</td><td></td><td></td><td>2</td><td></td><td></td><td></td><td>7</td><td></td><td></td></tr><tr><td>内存块2</td><td></td><td>0</td><td>0</td><td>0</td><td></td><td>0</td><td></td><td>4</td><td></td><td></td><td>0</td><td></td><td></td><td>0</td><td></td><td></td><td></td><td>0</td><td></td><td></td></tr><tr><td>内存块3</td><td></td><td></td><td>1</td><td>1</td><td></td><td>3</td><td></td><td>3</td><td></td><td></td><td>3</td><td></td><td></td><td>1</td><td></td><td></td><td></td><td>1</td><td></td><td></td></tr><tr><td>是否缺页</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td></td><td>✓</td><td></td><td>✓</td><td></td><td></td><td>✓</td><td></td><td></td><td>✓</td><td></td><td></td><td></td><td>✓</td><td></td><td></td></tr></tbody></table><p>以在访问2号页面为例：</p><p>内存块1为7，内存块2为0，内存块3为1，都已经占用</p><p>选择从0、1、7中淘汰页。按最佳置换的规则，往后寻找，最后一个出现的页号就是要淘汰的页面</p><p>最后出现的为7，就变为：</p><p>内存块1为2，内存块2为0，内存块3为1</p><p>整个过程缺页中断发生了9次(打对勾的)，页面置换发生了6次(前三次有空闲内存块没有发生置换)。</p><p>注意：缺页时末必发生页面置换。若还有可用的空闲内存块，就不用进行页面置换。</p><p>最佳罝换算法可以保证最低的缺页率，但实际上，只有在进程执行的过程中才能知道接下来会访问到的是哪个页面。操作系统无法提前预判页面访问序列。因此，<strong>最佳置换算法是无法实现的</strong>。</p><h4 id="先进先出置换算法-FIFO"><a href="#先进先出置换算法-FIFO" class="headerlink" title="先进先出置换算法(FIFO)"></a>先进先出置换算法(FIFO)</h4><p>先进先出置换算法 (FIFO)：每次选择淘汰的页面是最早进入内存的页面</p><p>实现方法：把调入内存的页面根据调入的先后顺序排成一个队列，需要换出页面时选择队头页面即可队列的最大长度取决于系统为进程分配了多少个内存块。</p><p>例：假设系统为某进程分配了三个内存块，并考虑到有以下页面号引用串：<br>3, 2, 1, 0, 3, 2, 4, 3, 2, 1, 0, 4</p><h4 id="最近最久未使用置换算法-LRU"><a href="#最近最久未使用置换算法-LRU" class="headerlink" title="最近最久未使用置换算法(LRU)"></a>最近最久未使用置换算法(LRU)</h4><p>最近最久未使用置换算法(LRU，least recently used)：每次淘汰的页面是最近最久未使用的页面</p><p>实现方法：赋子每个页面对应的页表项中，用访问字段记录该页面白上次被访问以来所经历的时间t。</p><p>当需要淘汰一个页面时，选择现有页面中t值最大的，即最近最久未使用的页面。</p><p>例：假设系统为某进程分配了四个内存块，并考虑到有以下页面号引用串：<br>1, 8, 1, 7, 8, 2, 7, 2, 1, 8, 3, 8, 2, 1, 3, 1, 7, 1, 3, 7</p><table><thead><tr><th>访问页面</th><th>1</th><th>8</th><th>1</th><th>7</th><th>8</th><th>2</th><th><span style="color:blue">7</span></th><th>2</th><th>1</th><th>8</th><th><span style="color:red">3</span></th><th><span style="color:blue">8</span></th><th>2</th><th>1</th><th>3</th><th>1</th><th>7</th><th>1</th><th>3</th><th>7</th></tr></thead><tbody><tr><td>内存块1</td><td>1</td><td>1</td><td></td><td>1</td><td></td><td>1</td><td></td><td></td><td></td><td></td><td>1</td><td></td><td></td><td></td><td></td><td></td><td>1</td><td></td><td></td><td></td></tr><tr><td>内存块2</td><td></td><td>8</td><td></td><td>8</td><td></td><td>8</td><td></td><td></td><td></td><td></td><td>8</td><td></td><td></td><td></td><td></td><td></td><td>7</td><td></td><td></td><td></td></tr><tr><td>内存块3</td><td></td><td></td><td></td><td>7</td><td></td><td>7</td><td></td><td></td><td></td><td></td><td>3</td><td></td><td></td><td></td><td></td><td></td><td>3</td><td></td><td></td><td></td></tr><tr><td>内存块4</td><td></td><td></td><td></td><td></td><td></td><td>2</td><td></td><td></td><td></td><td></td><td>2</td><td></td><td></td><td></td><td></td><td></td><td>2</td><td></td><td></td><td></td></tr><tr><td>是否缺页</td><td>✓</td><td>✓</td><td></td><td>✓</td><td></td><td>✓</td><td></td><td></td><td></td><td></td><td>✓</td><td></td><td></td><td></td><td></td><td></td><td>✓</td><td></td><td></td><td></td></tr></tbody></table><p>在手动做题时，若需要淘汰页面，可以逆向检查(&lt;—)此时在内存中的几个页面号。</p><p><strong>在逆向扫描过程中最后一个出现的页号就是要淘汰的页面</strong>。</p><h4 id="时钟置换算法-CLOCK"><a href="#时钟置换算法-CLOCK" class="headerlink" title="时钟置换算法(CLOCK)"></a>时钟置换算法(CLOCK)</h4><h4 id="改进型的时钟置换算法"><a href="#改进型的时钟置换算法" class="headerlink" title="改进型的时钟置换算法"></a>改进型的时钟置换算法</h4><h3 id="3-11-页面分配策略"><a href="#3-11-页面分配策略" class="headerlink" title="3.11 页面分配策略"></a>3.11 页面分配策略</h3><p>驻留集：指请求分页存储管理中给进程分配的物理块的集合。<br>在采用了虚拟存储技术的系统中，驻留集大小一般小于进程的总大小。<br>若驻留集太小，会导致缺页频繁，系统要花大量的时间来处理缺页，实际用于进程推进的时间很少<br>驻留集太大，又会导致多道程序并发度下降，资源利用率降低。所以应该选择一个合适的驻留集大小。</p><p>固定分配：操作系统为每个进程分配一组固定数目的物理块，在进程运行期间不再改变。即，驻留集大小不变</p><p>可变分配：先为每个进程分配一定数目的物理块，在进程运行期间，可根据情况做适当的增加或减少。即，驻留集大小可变</p><p>局部置换：发生缺页时只能选进程自己的物理块进行置换。</p><p>全局置换：可以将操作系统保留的空闲物理块分配给缺页进程，也可以将别的进程持有的物理块置换到外存，再分配给缺页进程。</p><p>固定分配局部置换：系统为每个进程分配一定数量的物理块，在整个运行期间都不改变。若进程在运行中发生缺页，则只能从该进程在内存中的页面中选出一页换出，然后再调入需要的页面。这种策略的缺点是：很难在刚开始就确定应为每个进程分配多少个物理块才算合理。(采用这种策略的系统可以根据进程大小、优先级、或是根据程序 员给出的参数来确定为一个进程分配的内存块数)</p><p>可变分配全局置换：刚开始会为每个进程分配一定数量的物理块。操作系统会保持一个空闲物理块队当某进程发生缺页时，从空闲物理块中取出一块分配给该进程；若已无空闲物理块，则可选择一个未锁定的页面换出外存，再将该物理块分配给缺页的进程。采用这种策略时，只要某进程发生缺页，都将获得新的物理块，仅当空闲物理块用完时，系统才选择一个未锁定的页面调出。被选择调出的页可能是系统中任何一个进程中的页，因此这个被选中的进程拥有的物理块会减少，缺页率会增加。</p><h1 id="四、文件"><a href="#四、文件" class="headerlink" title="四、文件"></a>四、文件</h1><h3 id="4-1-初识文件管理"><a href="#4-1-初识文件管理" class="headerlink" title="4.1 初识文件管理"></a>4.1 初识文件管理</h3><h4 id="文件属性"><a href="#文件属性" class="headerlink" title="文件属性"></a>文件属性</h4><blockquote><p>文件名：由创建文件的用户决定文件名，主要是为了方便用户找到文件，同一目录下不允许有重名文件。</p><p>标识符：一个系统内的各文件标识符唯一，对用户来说亳无可读性，因此标识符只是操作系统用于区分各个文件的一种内部名称。</p><p>类型：指明文件的类型</p><p>位置：文件存放的路径(让用户使用)、在外存中的地址(操作系统使用，对用户不可见)<br>大小：指明文件大小</p><p>创建时间、上次修改时间、文件所有者信息</p><p>保护信息：对文件进行保护的访问控制信息</p></blockquote><h4 id="操作系统提供的功能"><a href="#操作系统提供的功能" class="headerlink" title="操作系统提供的功能"></a>操作系统提供的功能</h4><ul><li>创建文件</li><li>删除文件</li><li>读文件</li><li>写文件</li><li>打开文件</li><li>关闭文件</li></ul><h3 id="4-2-文件的逻辑结构"><a href="#4-2-文件的逻辑结构" class="headerlink" title="4.2 文件的逻辑结构"></a>4.2 文件的逻辑结构</h3><p>按文件是否有结构分类，可以分为无结构文件、有结构文件两种。</p><ul><li><p><strong>无结构文件</strong>：文件内部的数据就是一系列二进制流或字符流组成。又称“流式文件”。</p><p>如：Windows 操作系统中的.txt 文件。</p></li><li><p><strong>有结构文件</strong>：由一组相似的记录组成，又称“记录式文件”。每条记录又若干个数据项组成。</p><p>如：数据库表文件。一般来说，每条记录有一个数据项可作为关键字。根据各条记录的长度(占用的<br>存储空间)是否相等，又可分为定长记录和可变长记录两种。</p><p>有结构文件在逻辑上可分为三类：顺序文件、索引文件、索引顺序文件</p></li></ul><h4 id="顺序文件"><a href="#顺序文件" class="headerlink" title="顺序文件"></a>顺序文件</h4><p>顺序文件：文件中的记录一个接一个地顺序排列（逻辑上），记录可以是定长的或可变长的。各个记录在物理上可以<strong>顺序存储</strong>或<strong>链式存储</strong>。</p><ul><li>顺序存储一一逻辑上相邻的记录物理上也相邻(类似于顺序表)</li><li>链式存储一一逻辑上相邻的记录物理上不一定相邻(类似于链表)</li></ul><p>顺序文件的结构：</p><ul><li>串结构：记录之间的顺序与关键字无关(通常按照记录存入的时间决定记录的顺序)</li><li>顺序结构：记录之间的顺序按关键字顺序排列</li></ul><p>定长记录的顺序文件，若物理上采用顺序存储，则可实现随机存取；<br>若能再保证记录的顺序结构，则可实现快速检索(即根据关键字快速找到对应记录〉</p><p>一般来说，考试题目中所说的”顺序文件”指的是物理上顺序存储的顺序文件。之后的讲解中提到的顺序文件也默认如此。可见，顺序文件的缺点是增加&#x2F;删除一个记录比较困难（如果是串结构则相对简单）</p><h4 id="索引文件"><a href="#索引文件" class="headerlink" title="索引文件"></a>索引文件</h4><p>建立一张索引表以加快文件检素速度。每条记录对应一个索引项。<br>逻辑文件</p><p>索引表本身是定长记录的顺序文件。因此可以快速找到第i个记录对应的素引项。<br>可将关键字作为索引号内容，若按关键字顺序排列，则还可以支持按照关键字折半查找。<br>每当要增加&#x2F;删除一个记录时，需要对索引表进行修改。由于索引文件有很快的检索速度，因此主要用于对信息处理的及时性要求比较高的场合。</p><p>另外，可以用不同的数据项建立多个索引表。如：<br>学生信息表中，可用关键字 “学号”建立一张素引表。也可用“姓名”建立一张索引表。这样就可以根据”姓名”快速地检索文件了。</p><h3 id="文件目录"><a href="#文件目录" class="headerlink" title="文件目录"></a>文件目录</h3><h4 id="两级目录"><a href="#两级目录" class="headerlink" title="两级目录"></a>两级目录</h4><h4 id="多级目录"><a href="#多级目录" class="headerlink" title="多级目录"></a>多级目录</h4><h3 id="文件的物理结构"><a href="#文件的物理结构" class="headerlink" title="文件的物理结构"></a>文件的物理结构</h3><h3 id="4-3-文件存储空间管理"><a href="#4-3-文件存储空间管理" class="headerlink" title="4.3 文件存储空间管理"></a>4.3 文件存储空间管理</h3><h4 id="位示图法"><a href="#位示图法" class="headerlink" title="位示图法"></a>位示图法</h4><p>![F&#96;XC_DT2WYTE_CB~_40TU_M.png](<a href="https://s2.loli.net/2023/02/09/yREqvoUxCZ4MzFw.png">https://s2.loli.net/2023/02/09/yREqvoUxCZ4MzFw.png</a>)</p><p>位示图：每个二进制位对应一个盘块。在本例中，“0”代表盘块空闲，“1”代表盘块已分配。位示图一般用连续的“字”来表示，如本例中一个字的字长是16位，字中的每一位对应一个盘块。因此可以用（字号，位号)对应一个盘块号。当然有的题目中也描述为（行号，列号）</p><p>盘块号与字号、位号相互转换的公式</p><blockquote><p>盘号&#x3D;字长*字号+位号</p><p>字号&#x3D;盘号&#x2F;字长</p><p>位号&#x3D;盘号%位号</p></blockquote><h4 id="成组链接法"><a href="#成组链接法" class="headerlink" title="成组链接法"></a>成组链接法</h4><p>空闲表法、空闲链表法不适用于大型文件系统，因为空闲表或空闲链表可能过大。<strong>UNIX系统中采用了成组链接法对磁盘空闲块进行管理</strong>。</p><p>文件卷的目录区中专门用一个磁盘块作为”超级块”，当系统启动时需要将超级块读入内存。并且要保证内存与外存中的”超级块”数据一致。</p><h3 id="磁盘调度算法"><a href="#磁盘调度算法" class="headerlink" title="磁盘调度算法"></a>磁盘调度算法</h3><h4 id="先来先服务"><a href="#先来先服务" class="headerlink" title="先来先服务"></a>先来先服务</h4><p>根据进程请求访问磁盘的先后顺序进行调度。</p><p>假设磁头的初始位置是100号磁道，有多个进程先后陆续地请求访问55、58、39、18、90、160、150、38、184号磁道</p><p>按照FCFS的规则，按照请求到达的顺序，磁头需要依次移动到55、58、39、18、90、160、150、38、184号磁道</p><p><img src="https://s2.loli.net/2023/02/09/3XP9rzi6jCKWeJA.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/3XP9rzi6jCKWeJA.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221213175737199.png"></p><p>磁头总共移动了45+3+19+21+72+70+10+112+146&#x3D;498个磁道</p><p>响应一个请求平均需要移动498&#x2F;9&#x3D;55.3个磁道(平均寻找长度)</p><blockquote><p>优点：公平；如果请求访问的磁道比较集中的话，算法性能还算过的去</p><p>缺点：如果有大量进程竞争使用磁盘，请求访问的磁道很分散，则FCS在性能上很差，寻道时间长。</p></blockquote><h4 id="最短寻找时间优先SSTF"><a href="#最短寻找时间优先SSTF" class="headerlink" title="最短寻找时间优先SSTF"></a>最短寻找时间优先SSTF</h4><p>SSTF算法会优先处理的磁道是与当前磁头最近的磁道。可以保证每次的寻道时间最短，但是并不能保证总的寻道时间最短。(其实就是<strong>贪心算法</strong>的思想，只是选择眼前最优，但是总体未必最优)</p><p>假设磁头的初始位置是100号磁道，有多个进程先后陆续地请求访问55、58、39、18、90、160、150、38、184号磁道</p><p><img src="https://s2.loli.net/2023/02/09/oUbJ5MFyrnw2Wps.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/oUbJ5MFyrnw2Wps.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221213180224030.png"></p><p>磁头总共移动了（100-18)+(184-18)&#x3D;248个磁道</p><p>响应一个请求平均需要移动248&#x2F;9&#x3D;27.5个磁道（平均寻找长度）</p><blockquote><p>优点：性能较好，平均寻道时间短</p><p>缺点：可能产生”饥饿”现象</p><p>Eg:本例中，如果在处理18号磁道的访问请求时又来了一个38号磁道的访问请求，处理38号磁道的访问请求时又来了一个18号磁道的访问请求。如果有源源不断的18号、38号磁道的访问请求到来的话，150、160、184号磁道的访问请求就永远得不到满足，从而产生“饥饿”现象。</p></blockquote><h4 id="扫描算法SCAN"><a href="#扫描算法SCAN" class="headerlink" title="扫描算法SCAN"></a>扫描算法SCAN</h4><p>SSTF算法会产生饥饿的原因在于：磁头有可能在一个小区域内来回来去地移动。为了防止这个问题，可以规定，只有磁头移动到最外侧磁道的时候才能往内移动，移动到最内侧磁道的时候才能往外移动。<strong>这就是扫描算法(SCAN)的思想</strong>。由于磁头移动的方式很像电梯，因此也叫<strong>电梯算法</strong>。</p><p>假设某磁盘的磁道为0~200号，磁头的初始位置是100号磁道，且此时磁头正在往磁道号增大的方向移动，有多个进程先后陆续地请求访问55、58、39、18、90、160、150、38、184号磁道</p><p><img src="https://s2.loli.net/2023/02/09/lBCkH6a5mnyUZju.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/lBCkH6a5mnyUZju.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221214110408242.png"></p><p>磁头总共移动了(200-100)+(184-18)&#x3D;250个磁道</p><p>响应一个请求平均需要移动250&#x2F;9&#x3D;27.5个磁道（平均寻找长度）</p><h4 id="循环扫描算法CSCAN"><a href="#循环扫描算法CSCAN" class="headerlink" title="循环扫描算法CSCAN"></a>循环扫描算法CSCAN</h4><p>SCAN算法对于各个位置磁道的响应频率不平均，而<strong>C-SCAN算法就是为了解决这个问题</strong>。规定只有磁头朝某个特定方向移动时才处理磁道访问请求，而返回时直接快速移动至起始端而不处理任何请求。</p><p>假设某磁盘的磁道为0~200号，磁头的初始位置是100号磁道，且此时磁头正在往磁道号增大的方向移动，有多个进程先后陆续地请求访问55、58、39、18、90、160、150、38、184号磁道</p><p><img src="https://s2.loli.net/2023/02/09/AM28fNdEgxChi6b.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/AM28fNdEgxChi6b.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221214110627796.png"></p><p>磁头总共移动了(184-100)+(184-18)+(90-18)&#x3D;322个磁道</p><p>响应一个请求平均需要移动322&#x2F;9&#x3D;5.8个磁道（平均寻找长度）</p><h1 id="五、I-O设备"><a href="#五、I-O设备" class="headerlink" title="五、I-O设备"></a>五、I-O设备</h1><h3 id="缓冲区管理"><a href="#缓冲区管理" class="headerlink" title="缓冲区管理"></a>缓冲区管理</h3><h4 id="单缓冲"><a href="#单缓冲" class="headerlink" title="单缓冲"></a>单缓冲</h4><p>假设某用户进程请求某种块设备读入若干块的数据。若采用单缓冲的策略，操作系统会在主存中为<br>其分配一个缓冲区(若题目中没有特别说明，一个缓冲区的大小就是一个块)。</p><p>注意：当缓冲区数据非空时，不能往缓冲区冲入数据，只能从缓冲区把数据传出：当缓冲区为空时<br>可以往缓冲区冲入数据，但必须把缓冲区充满以后，才能从缓冲区把数据传出。</p><img src="https://s2.loli.net/2023/02/09/iRYjUcw6VXDaLIe.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/iRYjUcw6VXDaLIe.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221213171245536.png" style="zoom:50%;" /><img src="https://s2.loli.net/2023/02/09/sL8v9egWxPZlGUu.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/sL8v9egWxPZlGUu.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221213171901922.png" style="zoom: 67%;" /><img src="https://s2.loli.net/2023/02/09/vsQzY56w1jkyq3d.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/vsQzY56w1jkyq3d.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221213172116018.png" style="zoom:67%;" /><p><strong>结论：采用单缓冲策略，处理一块数据平均耗时：<code>Max(C,T)+M</code></strong></p><h4 id="双缓冲"><a href="#双缓冲" class="headerlink" title="双缓冲"></a>双缓冲</h4><p>假设某用户进程请求某种块设备读入若干块的数据。若采用双缓冲的策略，操作系统会在主存中为其分配两个缓冲区(若题目中没有特别说明，一个缓冲区的大小就是一个块)</p><p>双缓冲题目中，假设初始状态为：工作区空，其中一个缓冲区满，另一个缓冲区空</p><img src="https://s2.loli.net/2023/02/09/yEsVajr6Uqglh1K.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/yEsVajr6Uqglh1K.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221213172635434.png" style="zoom:67%;" /><img src="https://s2.loli.net/2023/02/09/IYpb6wSRW9etJ75.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/IYpb6wSRW9etJ75.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221213172850833.png" style="zoom:67%;" /><img src="https://s2.loli.net/2023/02/09/e2vp9y1o7irOSlJ.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/09/e2vp9y1o7irOSlJ.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221213173728832.png" style="zoom:67%;" /><p><strong>结论：采用双缓冲策略，处理一个数据块的平均耗时为：<code>Max(T,C+M)</code></strong></p>]]></content>
      
      
      <categories>
          
          <category> 计算机4件套 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2022/08/06/%E5%B0%8F%E6%8A%80%E5%B7%A7/@Autowired%E4%B8%8E@Resource/"/>
      <url>/2022/08/06/%E5%B0%8F%E6%8A%80%E5%B7%A7/@Autowired%E4%B8%8E@Resource/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="Autowired和-Resource区别"><a href="#Autowired和-Resource区别" class="headerlink" title="@Autowired和@Resource区别"></a>@Autowired和@Resource区别</h2><h3 id="1-提供方不同："><a href="#1-提供方不同：" class="headerlink" title="1.提供方不同："></a>1.提供方不同：</h3><ul><li><p>@Autowired是由Spring提供，属于第三方</p></li><li><p>@Resource是由J2EE提供，属于Java的</p></li></ul><h3 id="2-装配时默认类型不同："><a href="#2-装配时默认类型不同：" class="headerlink" title="2.装配时默认类型不同："></a>2.装配时默认类型不同：</h3><ul><li><p><strong>@Autowired默认按type装配</strong></p><p>默认情况下必须要求依赖对象存在，如果要允许<code>null</code>值，可以设置它的<code>required</code>属性为<code>false</code>。</p><p>如果想使用名称装配可以结合<code>@Qualifier注解</code>进行使用。</p></li><li><p><strong>@Resource默认按name装配</strong></p><p>名称可以通过<code>name</code>属性进行指定，如果没有指定<code>name</code>属性，当注解写在字段上时，默认取字段名进行名称查找。</p><p>如果注解写在setter方法上默认取属性名进行装配。</p><p>当找不到与名称匹配的<code>bean</code>时才按照类型进行装配。</p><p>但是需要注意的是，如果<code>name</code>属性一旦指定，就只会按照名称进行装配。</p></li></ul><h3 id="3-使用注意："><a href="#3-使用注意：" class="headerlink" title="3.使用注意："></a>3.使用注意：</h3><ul><li><p><strong>@Autowired</strong></p><p><strong>@Qualifier(“userService”)</strong> </p><p>是直接按照名字进行搜索，也就是说，对于UserServiceImpl 上面@Service注解必须写名字，不写就会报错，而且名字必须是@Autowired @Qualifier(“userService”) 保持一致。如果@Service上面写了名字，而@Autowired @Qualifier() ，一样会报错。</p></li><li><p><strong>@Resource</strong></p><p>根据这个注解的匹配效果可以看出，它进行了两次匹配，也就是说，如果你在UserService这个类上面这样写注解@Service。首先是找相同名字的，如果没有找到，再找相同类型的，而这里的@Service没有写名字，这个时候就进行了两次搜索，显然，速度就下降了许多。</p><p>@Resource根据名字搜索是这样写@Resource(“userService”)，如果你写了这个名字叫userService，那么UserServiceImpl的@Service注解也必须也是这个名字，不然还是会报错。</p></li></ul></div>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Spring框架的学习笔记</title>
      <link href="/2022/08/06/Java/Spring%E6%A1%86%E6%9E%B6/"/>
      <url>/2022/08/06/Java/Spring%E6%A1%86%E6%9E%B6/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="1-初识Spring"><a href="#1-初识Spring" class="headerlink" title="1.初识Spring"></a>1.初识Spring</h2><ul><li>官网：<a href="https://spring.io/">spring官网</a></li><li>Spring已经发展成了一种开发的生态圈，Spring提供了若干个项目，每个项目用于完成特定的功能<ul><li><strong>Spring Framework</strong></li><li>Spring Boot</li><li>Spring Cloud</li><li>….</li></ul></li><li>目前已经发展到<strong>Spring 5.0</strong>，需要<strong>JDK8</strong>以上支持</li></ul></div><div class="story post-story"><h2 id="2-Spring-Framework架构"><a href="#2-Spring-Framework架构" class="headerlink" title="2.Spring Framework架构"></a>2.Spring Framework架构</h2><ul><li><p>Spring Framework是Spring生态圈中最基础的项目，是其他项目的根基</p><img src="https://s2.loli.net/2022/06/22/P2TnXF8qp9gDHxS.png" class="lazyload" data-srcset="https://s2.loli.net/2022/06/22/P2TnXF8qp9gDHxS.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="QQ图片20220622160146" style="zoom: 67%;"/><blockquote><ul><li>Data Access：数据访问</li><li>Data Integeration：数据集成</li><li>Web：web开发 </li><li>AOP：面向切面编程</li><li>Aspects：AOP思想实现</li><li>Core Container：核心容器</li><li>Test：单元测试与集成测试</li></ul></blockquote></li></ul></div><div class="story post-story"><h2 id="3-核心概念"><a href="#3-核心概念" class="headerlink" title="3.核心概念"></a>3.核心概念</h2><h3 id="3-1-项目结构"><a href="#3-1-项目结构" class="headerlink" title="3.1 项目结构"></a>3.1 项目结构</h3><blockquote><p>java包</p><blockquote><p>com包</p><blockquote><p>spring包</p><blockquote><p>dao包</p><p><code>BookDao.java</code></p><blockquote><p>impl包</p><blockquote><p><code>BookDaoImpl.java</code></p></blockquote></blockquote></blockquote><blockquote><p>service包</p><p><code>BookSerive.java</code></p><blockquote><p>impl包</p><blockquote><p><code>BookServiceImpl.java</code></p></blockquote></blockquote><p><code>App.java</code>主函数</p></blockquote></blockquote></blockquote><p>resources包</p><blockquote><p><code>applicationContext.xml</code></p><p><code>jdbc.properties</code></p></blockquote></blockquote><h3 id="3-2-初识IOC和DI"><a href="#3-2-初识IOC和DI" class="headerlink" title="3.2 初识IOC和DI"></a>3.2 初识IOC和DI</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;book dao save...&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BookDaoImpl</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">bookDao.save();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这是一种很常见的写法。<br>但是这样的写法<strong>耦合度</strong>太高，<strong>耦合度</strong>可以简单的理解为：<strong>两个类之间的关联程度</strong>，耦合度高就代表两个类之间关联程度很高，<strong>动其中一个类，就不得不动另外一个类</strong>。</p></blockquote><p>所以就需要<code>解耦</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line"><span class="keyword">private</span> BookDao bookDao;<span class="comment">//service:我免费啦！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">bookDao.save();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><strong><code>IOC</code>(Inversion of Control) 控制反转</strong></p><ul><li><blockquote><p>使用对象时，由以前主动<code>new</code>一个对象转换为由<strong>外部</strong>提供对象，创建对象的控制权交给了<strong>外部</strong>，此思想为<strong>控制反转</strong>。</p></blockquote></li></ul></li><li><p><strong>Spring技术对<code>IOC</code>进行实现</strong></p><blockquote><ul><li><strong>Spring</strong>提供一个<code>容器</code>，称为<code>IOC容器</code>，用来当作<code>IOC</code>思想中的**”外部”**</li><li><strong>IOC容器</strong>负责对象的<code>创建</code>、<code>初始化</code>等工作</li><li>在<strong>IOC容器</strong>中被创建或被管理的对象称之为<code>Bean</code></li></ul></blockquote></li><li><p><strong><code>DI</code>(Dependency Injection) 依赖注入</strong></p><ul><li><blockquote><p>在容器中建立的<code>bean</code>与<code>bean</code>之间的依赖关系的整个过程，称之为<code>依赖注入</code>。          </p><p>例：<code>service层</code>需要依赖<code>dao层</code>运行，但无需自己<code>new</code>一个<code>dao层</code>，它会自动生成<code>dao层</code>。</p></blockquote></li></ul></li><li><p>目标：<strong>充分解耦</strong></p><blockquote><ul><li>使用<strong>IOC容器</strong>管理<code>bean</code>(IOC思想)</li><li>在<strong>ICO容器</strong>内将依赖关系的<code>bean</code>进行关系绑定(DI思想)</li><li>在使用对象时不仅可以从<code>IOC容器</code>中获取，并且也可以获取到<code>bean</code>已经绑定的所有依赖关系</li></ul></blockquote></li></ul></div><div class="story post-story"><h2 id="4-IOC入门"><a href="#4-IOC入门" class="headerlink" title="4.IOC入门"></a>4.IOC入门</h2><ol><li><p>pom.xml导入spring的坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><code>resources</code>目录创建Spring配置文件<code>applicationContext.xml</code></p><p>配置<code>bean</code></p><blockquote><ul><li><code>bean</code>标签：配置bean</li><li><code>id</code>属性：给bean起名字</li><li><code>class</code>属性：给bean定义类型</li></ul></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.service.impl.BookServiceImpl&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>创建名为启动类App</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> com.spring.dao.BookDao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">      <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">        </span><br><span class="line">        <span class="type">BookService</span> <span class="variable">bookService</span> <span class="operator">=</span> (BookService) ac.getBean(<span class="string">&quot;bookService&quot;</span>);</span><br><span class="line">        bookService.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></div><div class="story post-story"><h2 id="5-DI入门"><a href="#5-DI入门" class="headerlink" title="5.DI入门"></a>5.DI入门</h2><blockquote><ul><li>基于IOC管理bean</li><li>不能保留Service层中用new创建的对象</li><li>通过spring配置文件进行配置Service与Dao的关系</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    <span class="comment">//删除业务层中用new创建对象的方式</span></span><br><span class="line">    <span class="comment">//private BookDao bookDao = new BookDaoImpl();</span></span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"><span class="comment">//提供相应的set的方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBookDao</span><span class="params">(BookDao bookDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bookDao = bookDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在spring配置文件<code>applicationContext.xml</code>中，配置property</p><blockquote><ul><li><code>property</code>标签：配置当前bean的属性</li><li><code>name</code>属性：配置哪个具体的属性</li><li><code>ref</code>属性：参照spring配置文件中的哪个bean的id</li></ul></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.service.impl.BookServiceImpl&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置service与dao的关系 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;bookDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>配置完成后，BookDao无需使用new来手动创建对象，而是通过spring来自动创建</p></blockquote></div><div class="story post-story"><h2 id="6-bean基础配置"><a href="#6-bean基础配置" class="headerlink" title="6.bean基础配置"></a>6.bean基础配置</h2><h3 id="6-1-bean别名配置"><a href="#6-1-bean别名配置" class="headerlink" title="6.1 bean别名配置"></a>6.1 bean别名配置</h3><blockquote><p>name属性：可以起多个别名用<code>;</code>分号<code> </code>空格<code>,</code>逗号分隔</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dao Dao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Service service&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.service.impl.BookServiceImpl&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>别名可以用于getBean()方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="comment">//BookService bookService=(BookService)ac.getBean(&quot;bookService&quot;);</span></span><br><span class="line">        <span class="comment">//通过别名获取BookService</span></span><br><span class="line">        BookService bookService=(BookService)ac.getBean(<span class="string">&quot;Service&quot;</span>);</span><br><span class="line">        bookService.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>别名也可以用于<code>ref</code>属性，<strong>不建议用别名，建议使用id</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.service.impl.BookServiceImpl&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;Dao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="6-2-bean的作用范围"><a href="#6-2-bean的作用范围" class="headerlink" title="6.2 bean的作用范围"></a>6.2 bean的作用范围</h3><p>创建的<code>bean</code>是否为多个对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao1</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao2</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(bookDao1);</span><br><span class="line">        System.out.println(bookDao2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">com.spring.dao.impl.BookDaoImpl@7219ec67</span><br><span class="line">com.spring.dao.impl.BookDaoImpl@7219ec67</span><br></pre></td></tr></table></figure></blockquote><p>结论：两个对象地址相同，spring默认创建的<code>bean</code>是单例的</p><p>需要在配置文件的<code>bean</code>标签里添加一个<code>scope</code>属性</p><blockquote><ul><li>scope属性有<code>singleton</code>单例模式和<code>prototype</code>非单例模式</li><li>scope属性默认为<code>singleton</code>单例模式</li></ul></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prtotype&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">再次运行后，运行结果：</span><br><span class="line">com.spring.dao.impl.BookDaoImpl@7219ec67</span><br><span class="line">com.spring.dao.impl.BookDaoImpl@<span class="number">45018215</span></span><br></pre></td></tr></table></figure></blockquote><p>结论：两个对象地址不同，为非单例模式</p><ul><li><p>bean作用范围说明</p><ul><li><blockquote><p><strong>单例bean的优势</strong></p><p>减少了新生成实例的消耗，可以快速获取到bean，更大程度的复用</p></blockquote></li><li><blockquote><p><strong>适合</strong>交给容器进行管理的bean</p><p>表现层对象，业务层对象，数据层对象，工具对象</p></blockquote></li><li><blockquote><p><strong>不适合</strong>交给容器进行管理的bean</p><p>封装实体的域对象(存在变量的)</p></blockquote></li></ul></li></ul></div><div class="story post-story"><h2 id="7-bean实例化"><a href="#7-bean实例化" class="headerlink" title="7.bean实例化"></a>7.bean实例化</h2><p>   bean的本质就是对象，创建bean都需要使用<strong>构造方法</strong>完成</p><h3 id="7-1-构造方法实例化bean"><a href="#7-1-构造方法实例化bean" class="headerlink" title="7.1 构造方法实例化bean"></a>7.1 构造方法实例化bean</h3><p>(常用)</p><p>在<code>BookDaoImpl</code>类中创建构造方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BookDaoImpl</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookDaoImpl构造函数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*private BookDaoImpl()&#123;</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;BookDaoImpl构造函数&quot;);</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookDao~~~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AppForInstanceBook</code>类进行测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppForInstanceBook</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">BookDaoImpl构造函数</span><br><span class="line">BookDao~~~~~</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>并且<code>BookDaoImpl</code>中的构造方法无论是否私有都可以被调用，这就是<strong>反射</strong>。</p></blockquote><p><strong>无参构造方法不存在，将会抛出异常</strong></p><p>在<code>BookDaoImpl</code>类中构造方法改为有参构造：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BookDaoImpl</span><span class="params">(<span class="type">int</span> i)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;BookDaoImpl构造函数&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>运行后会<strong>报错</strong>，同时说明<strong>Spring</strong>创建<code>bean</code>的时候，调用的是<strong>无参构造</strong>。</p></blockquote><h3 id="7-2-静态工厂实例化bean"><a href="#7-2-静态工厂实例化bean" class="headerlink" title="7.2 静态工厂实例化bean"></a>7.2 静态工厂实例化bean</h3><p>(<strong>早期</strong>实例化bean <strong>了解</strong>)</p><p>创建一个factory软件包，并在里面创建一个<code>BookDaoFactory</code>类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> BookDao <span class="title function_">getBookDao</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;factory is running&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BookDaoImpl</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AppForInstanceBook</code>类运行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppForInstanceBook</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> BookDaoFactory.getBookDao();</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//运行成功</span></span><br></pre></td></tr></table></figure><p>通过配置文件使用静态工厂实例化bean：</p><p>Spring配置文件中：</p><p><code>factory-method</code>属性：选择工厂里的bean实例方法</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.factory.BookDaoFactory&quot;</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">factory-method</span>=<span class="string">&quot;getBookDao&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p><code>AppForInstanceBook</code>类运行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppForInstanceBook</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">factory is running</span><br><span class="line">BookDaoImpl构造函数</span><br><span class="line">BookDao~~~~~</span><br></pre></td></tr></table></figure></blockquote><h3 id="7-3-实例工厂实例化bean"><a href="#7-3-实例工厂实例化bean" class="headerlink" title="7.3 实例工厂实例化bean"></a>7.3 实例工厂实例化bean</h3><p>(非静态工厂 <strong>了解</strong>)</p><p><code>BookDaoFactory</code>类中，将方法改为非静态方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> BookDao <span class="title function_">getBookDao</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;factory is running~~~~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BookDaoImpl</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AppForInstanceBook</code>类运行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppForInstanceBook</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">BookDaoFactory</span> <span class="variable">bookDaoFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BookDaoFactory</span>();</span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> bookDaoFactory.getBookDao();</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">factory is running~~~~~</span><br><span class="line">BookDaoImpl构造函数</span><br><span class="line">BookDao~~~~~</span><br></pre></td></tr></table></figure></blockquote><p>通过配置文件使用静态工厂实例化bean：</p><p>Spring配置文件中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 先要造出工厂的bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDaoFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.factory.BookDaoFactory&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;bookDaoFactory&quot;</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">factory-method</span>=<span class="string">&quot;getBookDao&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><code>AppForInstanceBook</code>类运行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppForInstanceBook</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">factory is running~~~~~</span><br><span class="line">BookDaoImpl构造函数</span><br><span class="line">BookDao~~~~~</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>配置文件中bean<code>bookDaoFactory</code>只是为了配合使用，实际没有意义。</p></blockquote><p>Spring对这种实例化bean方法进行了改良：</p><ul><li><p><strong>4.通过FactoryBean实例化bean</strong>(实用)</p><p>创建<code>BookDaoFactoryBean</code>类实现接口<code>FactoryBean&lt;T&gt;</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;BookDao&gt; &#123;</span><br><span class="line">    <span class="comment">//代替原始实例工厂中创建对象的方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BookDao <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BookDaoImpl</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> BookDao.class;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Spring配置文件中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.factory.BookDaoFactoryBean&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p><code>AppForInstanceBook</code>类运行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppForInstanceBook</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">BookDaoImpl构造函数</span><br><span class="line">BookDao~~~~~</span><br></pre></td></tr></table></figure></blockquote><p>并且<code>BookDaoFactoryBean</code>类中可以重写<code>isSinglenton</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;table&gt;</span><br><span class="line"></span><br><span class="line">    &lt;th align=<span class="string">&quot;center&quot;</span>&gt;         </span><br><span class="line">    &lt;td rowspan=<span class="string">&quot;2&quot;</span>&gt;Key&lt;/td&gt;         </span><br><span class="line">    &lt;td colspan=<span class="string">&quot;2&quot;</span>&gt;Value&lt;/td&gt;</span><br><span class="line">&lt;/th&gt;</span><br><span class="line">&lt;tr align=<span class="string">&quot;center&quot;</span>&gt;                 </span><br><span class="line">    &lt;td&gt;field&lt;/td&gt;</span><br><span class="line">    &lt;td&gt;value&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">    &lt;tr align=<span class="string">&quot;center&quot;</span>&gt;         </span><br><span class="line">    &lt;td rowspan=<span class="string">&quot;2&quot;</span>&gt;REQUIRES_NEW&lt;/td&gt;         </span><br><span class="line">    &lt;td&gt;开启T&lt;/td&gt;</span><br><span class="line">    &lt;td&gt;新建T2&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;tr align=<span class="string">&quot;center&quot;</span>&gt;                 </span><br><span class="line">    &lt;td&gt;无&lt;/td&gt;</span><br><span class="line">    &lt;td&gt;新建T2&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">    &lt;tr align=<span class="string">&quot;center&quot;</span>&gt;         </span><br><span class="line">    &lt;td rowspan=<span class="string">&quot;2&quot;</span>&gt;SUPPORTS&lt;/td&gt;         </span><br><span class="line">    &lt;td&gt;开启T&lt;/td&gt;</span><br><span class="line">    &lt;td&gt;加入T&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;tr align=<span class="string">&quot;center&quot;</span>&gt;                 </span><br><span class="line">    &lt;td&gt;无&lt;/td&gt;</span><br><span class="line">    &lt;td&gt;无&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;/table&gt;</span><br></pre></td></tr></table></figure></li></ul></div><div class="story post-story"><h2 id="8-bean的生命周期"><a href="#8-bean的生命周期" class="headerlink" title="8.bean的生命周期"></a>8.bean的生命周期</h2><blockquote><p>bean生命周期：bean从创建到销毁的整体过程</p><p>bean生命周期控制：在bean创建后到销毁前做一些事</p></blockquote><p>在<code>BookDaoImpl</code>类中，创建<code>init</code>和<code>destroy</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookDao~~~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;destroy~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在Spring配置文件中：</p><p><code>init-method</code>和<code>destroy-method</code>属性</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroy&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>调用主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">init~~~</span><br><span class="line">BookDao~~~~~</span><br></pre></td></tr></table></figure></blockquote><p>控制台并没有输出<code>destroy~~~</code>；</p><p>因为销毁函数还没有来得及调用，程序就被杀死了；</p><p>所以需要进行手动关闭；</p><p>我们调用主函数中的<code>ac</code>中的<code>close()</code>方法，但是<code>ApplicationContext</code>接口中并没有提供<code>close()</code>方法，所以我们要改用<code>ClassPathXmlApplicationContext</code>类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">        ac.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">init~~~</span><br><span class="line">BookDao~~~~~</span><br><span class="line">destroy~~~</span><br><span class="line">    成功！！！！</span><br></pre></td></tr></table></figure></blockquote><p>容器还提供另外一种方式关闭容器：<strong>设置关闭钩子</strong></p><p>调用<code>ac</code>的<code>registerShutdownHook()</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line"></span><br><span class="line">        ac.registerShutdownHook();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">init~~~</span><br><span class="line">BookDao~~~~~</span><br><span class="line">destroy~~~</span><br></pre></td></tr></table></figure></blockquote><p><code>close()</code>和<code>registerShutdownHook()</code>的区别</p><p>将<code>registerShutdownHook()</code>放到上面：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        ac.registerShutdownHook();</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">运行成功：</span><br><span class="line">init~~~</span><br><span class="line">BookDao~~~~~</span><br><span class="line">destroy~~~</span><br></pre></td></tr></table></figure></blockquote><p>将<code>close()</code>放到上面：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        ac.close();</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">init~~~</span><br><span class="line">destroy~~~</span><br><span class="line">报错：BeanFactory not initialized or already closed - call <span class="string">&#x27;refresh&#x27;</span> before accessing beans via the ApplicationContext</span><br><span class="line">    BeanFactory没有被初始化或者已经被关闭了</span><br><span class="line">    运行失败！！</span><br></pre></td></tr></table></figure></blockquote><p>或者通过接口的方式实现：</p><p><code>BookServiceImpl</code>类实现接口<code>InitializingBean</code>和<code>DisposableBean</code>的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span>, InitializingBean, DisposableBean &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBookDao</span><span class="params">(BookDao bookDao)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookDao set~~~&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.bookDao = bookDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;service destroy~~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;service init~~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroy&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.service.impl.BookServiceImpl&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;bookDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>主函数运行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">        ac.registerShutdownHook();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">init~~~</span><br><span class="line">BookDao set~~~</span><br><span class="line">service init~~~~</span><br><span class="line">BookDao~~~~~</span><br><span class="line">service destroy~~~~</span><br><span class="line">destroy~~~</span><br></pre></td></tr></table></figure></blockquote><p><code>BookServiceImpl</code>类中<code>destroy()</code>方法和<code>afterPropertiesSet()</code>方法被调用</p><p>并且<code>setBookDao()</code>方法之后才调用的<code>afterPropertiesSet()</code>方法</p></div><div class="story post-story"><h2 id="9-依赖注入方式"><a href="#9-依赖注入方式" class="headerlink" title="9.依赖注入方式"></a>9.依赖注入方式</h2><p>向一个类传递数据的方式有：set方法、构造方法</p><h3 id="9-1-setter注入"><a href="#9-1-setter注入" class="headerlink" title="9.1 setter注入"></a>9.1 setter注入</h3><ul><li><p><strong>引用类型</strong></p><p>在bean中定义引用类型属性并提供可访问的<code>set</code>方法</p><p><code>BookServiceImpl</code>类中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"><span class="comment">//提供相应的set的方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBookDao</span><span class="params">(BookDao bookDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bookDao = bookDao;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在配置文件中使用<code>property</code>标签<code>ref</code>属性注入引用类型对象</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.service.impl.BookServiceImpl&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;bookDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>简单类型</strong></p><p>在bean中定义引用类型属性并提供可访问的<code>set</code>方法</p><p><code>BookDaoImpl</code>类中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookDao~~~~~&quot;</span>+<span class="string">&quot;姓名：&quot;</span>+name+<span class="string">&quot;年龄：&quot;</span>+age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件中，在<code>property</code>标签<code>value</code>属性注入简单类型数据</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;DaHuang&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>运行主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">        ac.registerShutdownHook();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">BookDao~~~~~姓名：DaHuang年龄：<span class="number">18</span></span><br></pre></td></tr></table></figure></blockquote></li></ul><h3 id="9-2-构造器注入"><a href="#9-2-构造器注入" class="headerlink" title="9.2 构造器注入"></a>9.2 构造器注入</h3><ul><li><p><strong>引用类型</strong></p><p>在bean中定义引用类型属性并提供可访问的<strong>构造</strong>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BookServiceImpl</span><span class="params">(BookDao bookDao)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookServiceImpl构造器运行~~~&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.bookDao = bookDao;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件中，使用<code>constructor-arg</code>标签中的<code>ref</code>属性注入引用类型对象</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;DaHuang&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.service.impl.BookServiceImpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;bookDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>运行主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">BookServiceImpl构造器运行~~~</span><br></pre></td></tr></table></figure></blockquote></li><li><p><strong>简单类型</strong></p><p><code>BookDaoImpl</code>类中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BookDaoImpl</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;DaHei&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果要更改<code>BookDaoImpl</code>类中的形参名字，还要更改配置文件中的<code>name</code>属性的名字；</p><p>存在形参与<code>name</code>属性名不耦合的问题。</p><p><code>constructor-arg</code>标签还有<code>type</code>和<code>index</code>属性</p><ul><li>type：形参的数据类型(存在多个同数据类型的形参，无法使用)</li><li>index：形参的位置顺序</li></ul><p>在配置文件中，使用<code>index</code>属性设置按形参位置顺序注入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;bookDao&quot;</span> class=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>&gt;</span><br><span class="line">        &lt;constructor-arg index=<span class="string">&quot;0&quot;</span> value=<span class="string">&quot;DaHei&quot;</span>/&gt;</span><br><span class="line">        &lt;constructor-arg index=<span class="string">&quot;1&quot;</span> value=<span class="string">&quot;20&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure><p>运行主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">BookDao~~~~~姓名：DaHei年龄：<span class="number">20</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="9-3-依赖注入方式的选择"><a href="#9-3-依赖注入方式的选择" class="headerlink" title="9.3 依赖注入方式的选择"></a>9.3 依赖注入方式的选择</h3><ol><li><blockquote><p><strong>强制依赖使用<code>构造器注入</code>，使用<code>setter注入</code>有概率不注入导致<code>null</code>对象出现。</strong></p><p>bean必须要的东西，要用构造器注入。因为构造器必须被执行，必须注入，否则报错</p><p>而<code>setter</code>方法可以执行也可以不执行，如果没有进行<code>setter</code>注入，会导致<code>null</code>对象</p></blockquote></li><li><blockquote><p><strong>可选依赖使用<code>setter注入</code>进行，灵活性强。</strong></p><p><code>setter注入</code>可以执行也可以不执行</p></blockquote></li><li><blockquote><p><strong>Spring框架倡导使用构造器。</strong></p><p>第三方框架大多采用构造器注入的形式初始化数据，更加严谨</p></blockquote></li><li><blockquote><p><strong>setter注入和构造器注入可以同时使用。</strong></p><p>使用构造器完成强制依赖注入，使用setter注入完成可选依赖注入</p></blockquote></li><li><blockquote><p><strong>自己开发的模块推荐使用setter注入</strong></p></blockquote></li></ol></div><div class="story post-story"><h2 id="10-依赖自动装配"><a href="#10-依赖自动装配" class="headerlink" title="10.依赖自动装配"></a>10.依赖自动装配</h2><p>IOC容器根据bean都依赖的资源在容器中自动查找并注入到bean中的过程称为<strong>自动装配</strong></p><p>自动装配的方式：</p><blockquote><ul><li><strong>按类型(常用)</strong></li><li>按名称</li><li>按构造方法(不推荐)</li><li>不启用自动装配</li></ul></blockquote><h3 id="10-1-按类型"><a href="#10-1-按类型" class="headerlink" title="10.1 按类型"></a>10.1 按类型</h3><p>需要提供相应的<code>setter</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBookDao</span><span class="params">(BookDao bookDao)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookDao set~~~&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.bookDao = bookDao;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件中，要提前写好<code>bookDao</code>的<code>bean</code>否则无法装配，</p><p><code>autowire</code>属性设置为<code>byTpye</code> 通过类型自动装配</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.service.impl.BookServiceImpl&quot;</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">autowire</span>=<span class="string">&quot;byType&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BookService</span> <span class="variable">bookService</span> <span class="operator">=</span> (BookService) ac.getBean(<span class="string">&quot;bookService&quot;</span>);</span><br><span class="line">        bookService.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">BookDao set~~~</span><br></pre></td></tr></table></figure></blockquote><p>如果出现一下这种情况：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.service.impl.BookServiceImpl&quot;</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">autowire</span>=<span class="string">&quot;byType&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>出现了两个<code>BookDao</code>的bean，导致Spring无法区分了，这时就需要<strong>按名称装配</strong></p></blockquote><h3 id="10-2-按名称"><a href="#10-2-按名称" class="headerlink" title="10.2 按名称"></a>10.2 按名称</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBookDao</span><span class="params">(BookDao bookDao)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookDao set~~~&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.bookDao = bookDao;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件中，<code>autowire</code>属性设置为<code>byName</code> 通过名称自动装配</p><p>是通过<code>BookServiceImpl</code>类的变量名<code>bookDao</code>与配置文件的bean中<code>id</code>相同名称的进行绑定</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.service.impl.BookServiceImpl&quot;</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">autowire</span>=<span class="string">&quot;ByName&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><h3 id="10-3-总结"><a href="#10-3-总结" class="headerlink" title="10.3 总结"></a>10.3 总结</h3><blockquote><ul><li><p>自动装配用于引用类型依赖注入，不能对简单类型进行操作</p></li><li><p>使用按类型装配<code>byType</code>，必须保障容器中相同类型的bean<strong>唯一</strong>，推荐使用</p></li><li><p>使用按名称装配<code>byName</code>，必须保障容器中具有指定名称的bean，变量名要与配置耦合，</p><p>不推荐使用</p></li><li><p>自动装配优先级低于<code>setter注入</code>和<code>构造器注入</code>，同时出现时自动装配配置失效</p></li></ul></blockquote></div><div class="story post-story"><h2 id="11-集合注入"><a href="#11-集合注入" class="headerlink" title="11.集合注入"></a>11.集合注入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] array;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; list;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; set;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; map;</span><br><span class="line">    <span class="keyword">private</span> Properties properties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setArray</span><span class="params">(<span class="type">int</span>[] array)</span> &#123;<span class="built_in">this</span>.array = array;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setList</span><span class="params">(List&lt;String&gt; list)</span> &#123;<span class="built_in">this</span>.list = list;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSet</span><span class="params">(Set&lt;String&gt; set)</span> &#123;<span class="built_in">this</span>.set = set;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMap</span><span class="params">(Map&lt;String, String&gt; map)</span> &#123;<span class="built_in">this</span>.map = map;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;<span class="built_in">this</span>.properties = properties;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookDaoImpl&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\narray=&quot;</span> + Arrays.toString(array) +</span><br><span class="line">                <span class="string">&quot;, \nlist=&quot;</span> + list +</span><br><span class="line">                <span class="string">&quot;, \nset=&quot;</span> + set +</span><br><span class="line">                <span class="string">&quot;, \nmap=&quot;</span> + map +</span><br><span class="line">                <span class="string">&quot;, \nproperties=&quot;</span> + properties +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;array&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>100<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>200<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>300<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;list&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>唱<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>跳<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>Rap<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;set&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>唱<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>跳<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>Rap<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>Rap<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;map&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;county&quot;</span> <span class="attr">value</span>=<span class="string">&quot;china&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;province&quot;</span> <span class="attr">value</span>=<span class="string">&quot;tianjin&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;city&quot;</span> <span class="attr">value</span>=<span class="string">&quot;baodi&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;properties&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;county&quot;</span>&gt;</span>china<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;province&quot;</span>&gt;</span>tianjin<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;city&quot;</span>&gt;</span>baodi<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>运行主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">BookDaoImpl&#123;</span><br><span class="line">array=[<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>], </span><br><span class="line">list=[唱, 跳, Rap], </span><br><span class="line">set=[唱, 跳, Rap], </span><br><span class="line">map=&#123;county=china, province=tianjin, city=baodi&#125;, </span><br><span class="line">properties=&#123;province=tianjin, city=baodi, county=china&#125;&#125;</span><br></pre></td></tr></table></figure></blockquote></div><div class="story post-story"><h2 id="12-数据源对象管理"><a href="#12-数据源对象管理" class="headerlink" title="12.数据源对象管理"></a>12.数据源对象管理</h2><p>在<code>pom.xml</code>导入<code>druid</code>坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置文件中，管理<code>DruidDataSouurce</code>对象</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/demo&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>运行主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> (DataSource) ac.getBean(<span class="string">&quot;dataSource&quot;</span>);</span><br><span class="line">        System.out.println(dataSource);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">&#123;</span><br><span class="line">CreateTime:&quot;2022-06-24 22:27:03&quot;,</span><br><span class="line">ActiveCount:0,</span><br><span class="line">PoolingCount:0,</span><br><span class="line">CreateCount:0,</span><br><span class="line">DestroyCount:0,</span><br><span class="line">CloseCount:0,</span><br><span class="line">ConnectCount:0,</span><br><span class="line">Connections:[</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote></div><div class="story post-story"><h2 id="13-加载properties配置信息"><a href="#13-加载properties配置信息" class="headerlink" title="13.加载properties配置信息"></a>13.加载properties配置信息</h2><p>在<code>rescource</code>资源包中创建<code>jdbc.properties</code>文件：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jdbc.driver</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">jdbc.url</span>=<span class="string">jdbc:mysql://localhost:3306/demo</span></span><br><span class="line"><span class="attr">jdbc.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">jdbc.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="attr">username</span>=<span class="string">dahuang</span></span><br><span class="line"><span class="attr">age</span>=<span class="string">18</span></span><br></pre></td></tr></table></figure><p>配置文件中:</p><blockquote><ul><li>在<code>beans</code>标签中开启<code>context</code>命名空间</li><li>使用<code>context</code>空间加载<code>properties</code>文件</li></ul></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">   </span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 1.开启context命名空间 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 2.使用context空间加载properties文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;jdbc.properties&quot;</span> </span></span><br><span class="line"><span class="tag">                                  <span class="attr">system-properties-mode</span>=<span class="string">&quot;NEVER&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用占位符$&#123;&#125;读取properties中的属性 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.dao.impl.BookDaoImpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;age&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>加载properties文件格式：</strong></p><ul><li>不加载系统属性：</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&lt;context</span>:<span class="string">property-placeholder location=&quot;jdbc.properties&quot; </span></span><br><span class="line">                              <span class="attr">system-properties-mode</span>=<span class="string">&quot;NEVER&quot;/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>加载多个properties文件：</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&lt;context</span>:<span class="string">property-placeholder location=&quot;jdbc.properties, jdbc2.properties&quot;/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>加载所有properties文件：</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&lt;context</span>:<span class="string">property-placeholder location=&quot;*.properties&quot;/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>加载properties文件<span style="color:red">标准格式</span>：</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&lt;context</span>:<span class="string">property-placeholder location=&quot;classpath:*.properties&quot;/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>从类路径或jar包中搜索加载properties文件：</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&lt;context</span>:<span class="string">property-placeholder location=&quot;classpath*:*.properties&quot;/&gt;</span></span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="14-容器"><a href="#14-容器" class="headerlink" title="14.容器"></a>14.容器</h2><h3 id="14-1-创建容器的几种方式"><a href="#14-1-创建容器的几种方式" class="headerlink" title="14.1 创建容器的几种方式"></a>14.1 创建容器的几种方式</h3><ul><li>类路径下的加载配置文件</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li>文件系统下加载的配置文件</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;E:\Java_Web\Spring\spring_01_IOC\src\main\resources\applicationContext.xml&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li>加载多个配置文件：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext1.xml&quot;</span>,<span class="string">&quot;applicationContext2.xml&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="14-2-获取bean的几种方式"><a href="#14-2-获取bean的几种方式" class="headerlink" title="14.2 获取bean的几种方式"></a>14.2 获取bean的几种方式</h3><ul><li>使用bean名称获取</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li>使用bean名称获取并指定类型</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> ac.getBean(<span class="string">&quot;bookDao&quot;</span>,BookDao.class);</span><br></pre></td></tr></table></figure><ul><li>使用bean类型获取</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> ac.getBean(BookDao.class);<span class="comment">//对应的容器中只能有一个该类型，唯一</span></span><br></pre></td></tr></table></figure><h3 id="14-3-容器类层次结构"><a href="#14-3-容器类层次结构" class="headerlink" title="14.3 容器类层次结构"></a>14.3 容器类层次结构</h3><p>使用<code>ctrl+H</code>打开容器类的层次结构图：</p><img src="https://s2.loli.net/2022/06/26/zCFTWykYuqBf23S.png" class="lazyload" data-srcset="https://s2.loli.net/2022/06/26/zCFTWykYuqBf23S.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220626113036937.png" style="zoom: 67%;" /><blockquote><p>BeanFactory：是IOC容器的顶层接口，初始化BeanFactory对象时，加载的bean延迟加载</p><p>ApplicationContext：是Spring容器的核心接口，初始化时bean立即加载</p><p>​  提供基础的bean操作相关的方法，通过其他接口扩展其功能</p><p>ConfigurableApplicationContext：提供关闭容器功能</p><p>ClassPathXmlApplicationContext：常用实现类</p></blockquote><h3 id="14-4-BeanFactory初始化"><a href="#14-4-BeanFactory初始化" class="headerlink" title="14.4 BeanFactory初始化"></a>14.4 BeanFactory初始化</h3><p>类路径加载配置文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Rescoure</span> <span class="variable">rescoure</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathRescoure</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="type">BeanFactory</span> <span class="variable">bf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XmlBeanFactory</span>(rescoure);</span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> bf.getBean(<span class="string">&quot;bookDao&quot;</span>,BookDao.class);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BeanFactory创建完毕后，所有bean均为延迟加载</p></div><div class="story post-story"><h2 id="15-注解开发"><a href="#15-注解开发" class="headerlink" title="15.注解开发*"></a>15.注解开发*</h2><h3 id="15-1-用注释定义bean"><a href="#15-1-用注释定义bean" class="headerlink" title="15.1 用注释定义bean"></a>15.1 用注释定义bean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@component(&quot;bookDao&quot;)</span> <span class="comment">//等价于&lt;bean id=&quot;bookDao&quot; class=&quot;com.spring.dao.impl.BookDaoImpl&quot;/&gt;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookDao~~~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> <span class="comment">//没有写bean名，要通过类型获取bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookService~~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是，Spring怎么感知到注释呢？</p><p>配置文件中，需要添加扫描组件：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 扫描@component组件 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- base-package为扫描的位置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.spring&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取ICO容器</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//获取bean</span></span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> (BookDao) ac.getBean(<span class="string">&quot;bookDao&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line"><span class="comment">//因为@component，并没有写bean名，所以要用类型获取bean</span></span><br><span class="line">        <span class="type">BookService</span> <span class="variable">bookService</span> <span class="operator">=</span> ac.getBean(BookService.class);</span><br><span class="line">        bookService.save();   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">BookDao~~~~~</span><br><span class="line">BookService~~~~</span><br></pre></td></tr></table></figure></blockquote><p><strong>Spring提供@component注解的三个衍生注解</strong></p><blockquote><p>@Repository：用于数据层bean定义(Dao层)</p><p>​  也可以加括号来指定bean名，如：@Repository(“bookDao2”)</p><p>@Service：用于业务层bean定义(Service层)</p><p>@Controller：用于表现层bean定义(Controller层)</p><p><span style="color:red">@Service,@Repository不能写在接口上,需要写在接口的实现类上</span></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookController</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="15-2-纯注释开发"><a href="#15-2-纯注释开发" class="headerlink" title="15.2 纯注释开发"></a>15.2 纯注释开发</h3><p>新建一个<code>SpringConfig</code>类，用来替代配置文件。</p><p>其位置：<code>com.spring.config.SpringConfig.java</code></p><blockquote><p>com包</p><blockquote><p>spring包</p><blockquote><p>config包</p><blockquote><p><code>SpringConfig.java</code></p></blockquote></blockquote></blockquote></blockquote><blockquote><p><code>@Configuration</code> ：用于设定当前类为配置类<br><code>@ComponentScan(&quot;com.spring&quot;)</code> ：用用于设定扫描路径，此注释只能添加一次，多个数据用数组格式</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用来替代 &lt;context:component-scan base-package=&quot;com.spring&quot;/&gt;</span></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">//用于设定当前类为配置类</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.spring&quot;)</span> <span class="comment">//用用于设定扫描路径，此注释只能添加一次，多个数据用数组格式</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppForAnnotation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//改用注释配置初始化容器</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> ac.getBean(BookDao.class);</span><br><span class="line">        bookDao.save();</span><br><span class="line"></span><br><span class="line">        <span class="type">BookService</span> <span class="variable">bookService</span> <span class="operator">=</span> ac.getBean(BookService.class);</span><br><span class="line">        bookService.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">BookDao~~~~~</span><br><span class="line">BookService~~~~</span><br></pre></td></tr></table></figure></blockquote><h3 id="15-3-bean管理"><a href="#15-3-bean管理" class="headerlink" title="15.3 bean管理"></a>15.3 bean管理</h3><blockquote><p>作用范围</p><ul><li><code>@Scope(&quot;singleton&quot;)</code>：单例，默认单例</li><li><code>@Scope(&quot;prototype&quot;)</code>：多例</li></ul><p>bean生命周期控制</p><ul><li><p><code>@PostConstruct</code>注解：init</p></li><li><p><code>@PreDestroy</code>注解：destory</p></li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span> <span class="comment">//多例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;destroy~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="15-4-依赖注入"><a href="#15-4-依赖注入" class="headerlink" title="15.4 依赖注入"></a>15.4 依赖注入</h3><p><strong><span style="color:red">1.引用类型</span></strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookService~~~~&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppForAnnotation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BookService</span> <span class="variable">bookService</span> <span class="operator">=</span> ac.getBean(BookService.class);</span><br><span class="line">        bookService.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">BookService~~~~ //在创建好BookService的bean,并注入BookDao</span><br><span class="line">BookDao~~~~~ //调用BookDao的方法save();</span><br></pre></td></tr></table></figure></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository(&quot;bookDao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository(&quot;bookDao2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl2</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>当有多个同类型的bean，使用<code>@Qualifier(&quot;bookDao2&quot;)</code>来指定bean名</p><p>并且需要<code>@Autowired</code>和<code>@Qualifier(&quot;bookDao2&quot;)</code>一起使用</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;bookDao2&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookService~~~~&quot;</span>);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意：</strong></p><ul><li><strong>自动装配</strong>基于<strong>反射</strong>设计创建对象并<strong>暴力反射</strong>对应属性为私有属性初始化数据，无需提供<code>setter</code>方法</li><li><strong>自动装配</strong>建议使用<strong>无参构造方法</strong>创建对象，如果不提供对应的构造方法，请提供唯一的构造方法</li><li><code>@Qualifier</code>注解无法单独使用，必须配合<code>@Autowired</code>注解使用</li></ul><p><strong><span style="color:red">2.简单类型</span></strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line"><span class="meta">@Value(&quot;dahuang&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookDao~~~~~&quot;</span>+<span class="string">&quot;姓名：&quot;</span>+name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppForAnnotation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> ac.getBean(BookDao.class);</span><br><span class="line">        bookDao.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">BookDao~~~~~姓名：dahaung</span><br></pre></td></tr></table></figure></blockquote><p>但是，我们为什么不直接赋值，为什么要用<code>@Value</code>注解呢？</p><p>我们可以用<code>properties</code>文件，向其传值。</p><p><strong><span style="color:red">3.读取properties文件</span></strong></p><p>通过创建一个<code>jdbc.properties</code>文件：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name</span>=<span class="string">dahei</span></span><br></pre></td></tr></table></figure><p>在配置类中新加注解<code>@PropertySource()</code>，括号中指定文件名：</p><blockquote><p>如：<code>@PropertySource(&quot;jdbc.properties&quot;)</code>或者<code>@PropertySource(&quot;classpath:jdbc.properties&quot;)</code></p><p>也可以指定多个文件：</p><p>如：<code>@PropertySource(&#123;&quot;jdbc.properties&quot;,&quot;jdbc1.properties&quot;,&quot;jdbc2.properties&quot;&#125;)</code></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.spring&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;jdbc.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>BookDaoImpl</code>中将注解改为：<code>@Value(&quot;$&#123;&#125;&quot;)</code>，在<code>&#123;&#125;</code>中填入properties文件中的属性</p><p>如：<code>@Value(&quot;$&#123;name&#125;&quot;)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BookDao~~~~~&quot;</span>+<span class="string">&quot;姓名：&quot;</span>+name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="15-5-第三方bean管理"><a href="#15-5-第三方bean管理" class="headerlink" title="15.5 第三方bean管理"></a>15.5 第三方bean管理</h3><p><strong><span style="color:red">1.使用独立的配置管理第三方bean</span></strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">    <span class="comment">//定义一个方法获得想要管理的bean</span></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// 表示当前方法返回值是一个bean</span></span><br><span class="line">    <span class="keyword">public</span> DruidDataSource <span class="title function_">dataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">    <span class="comment">//相关配置</span></span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/demo&quot;</span>);</span><br><span class="line">        ds.getUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是<strong>不建议</strong>将独立配置<strong>直接</strong>写在核心配置类中：</p><p><strong>方法一：<span style="color:red">导入式</span>(建议使用)</strong></p><p>在<code>config包</code>创建一个<code>JdbcConfig.java</code>配置类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="comment">//定义一个方法获得想要管理的bean</span></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// 表示当前方法返回值是一个bean</span></span><br><span class="line">    <span class="keyword">public</span> DruidDataSource <span class="title function_">dataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        <span class="comment">//相关配置</span></span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/demo&quot;</span>);</span><br><span class="line">        ds.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>SpringConfig.java</code>核心配置类中导入：</p><blockquote><p>使用注解<code>@Import()</code>在括号中添加要导入的配置类的类型</p><p>如：<code>@Import(JdbcConfig.class)</code></p><p>此注解只能添加一次，导入多个配置类，可以使用数组格式导入</p><p>如：<code>@Import(&#123;JdbcConfig.class, XXXConfig.class, XXXConfig.calss&#125;)</code></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(JdbcConfig.class)</span> <span class="comment">//导入JdbcConfigpei</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>方式二：<span style="color:red">扫描式</span>(不建议使用)</strong></p><p><strong>注意：使用扫描式需要在独立的配置类加入注解<code>@Configuration</code></strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="comment">//定义一个方法获得想要管理的bean</span></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// 表示当前方法返回值是一个bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        <span class="comment">//相关配置</span></span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/demo&quot;</span>);</span><br><span class="line">        ds.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>SpringConfig.java</code>核心配置类中扫描：</p><p>使用注解<code>@ComponentScan()</code>在括号中添加要扫描的路径</p><p>如：<code>@@ComponentScan(&quot;com.spring.config&quot;)</code></p><p>扫描多个路径，可以使用数组格式导入</p><p>如：<code>@Import(&#123;&quot;com.spring.config&quot;,&quot;com.spring.dao&quot;&#125;)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.spring.config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><span style="color:red">2.第三方bean注入资源</span></strong></p><ul><li>简单类型依赖注入(<strong><span style="color:red">成员变量</span></strong>)：</li></ul><p>利用注解<code>@PropertySource(&quot;jdbc.properties&quot;)</code>和<code>@Import(JdbcConfig.class)</code>导入核心主配置文件中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.spring&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;jdbc.properties&quot;)</span></span><br><span class="line"><span class="meta">@Import(JdbcConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用注解<code>@Value(&quot;$&#123;&#125;&quot;)</code>注入数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.driver&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个方法获得想要管理的bean</span></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// 表示当前方法返回值是一个bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        </span><br><span class="line">        ds.setDriverClassName(driver);</span><br><span class="line">        ds.setUrl(url);</span><br><span class="line">        ds.setUsername(userName);</span><br><span class="line">        ds.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>引入类型依赖注入(<strong><span style="color:red">方法形参</span></strong>)：</li></ul><blockquote><p>引用类型注入只需要为<strong>bean定义的方法</strong>设置<strong>形参</strong>，容器会根据类型自动装配对象</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个方法获得想要管理的bean</span></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// 表示当前方法返回值是一个bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">(BookDao bookDao)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;已引用：&quot;</span>+bookDao);</span><br><span class="line">        </span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line"><span class="comment">//对ds进行相关设置</span></span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="15-6-总结"><a href="#15-6-总结" class="headerlink" title="15.6 总结"></a>15.6 总结</h3><p><strong><span style="color:red">XML配置与注解配置的比较：</span></strong></p><table><thead><tr><th align="center">功能</th><th>XML配置</th><th>注解</th></tr></thead><tbody><tr><td align="center">定义bean</td><td>bean标签：<br>&gt;id属性<br>&gt;class属性</td><td>@Component <br>&gt;@Controller <br>&gt;<span style="color:red">@Service</span> <br>&gt;@Repository<br><span style="color:red">@ComponentScan</span></td></tr><tr><td align="center">设置依赖注入</td><td>setter注入(set方法)<br>&gt;引用&#x2F;简单<br>构造器注入(构造方法)<br>&gt;自动装配</td><td><span style="color:red">@Autowird</span><br>&gt;@Qualifier<br>@Value</td></tr><tr><td align="center">配置第三方bean</td><td>bean标签<br>&gt;静态工厂<br>&gt;实例工厂<br>&gt;FactoryBean</td><td><span style="color:red">@Bean</span></td></tr><tr><td align="center">作用范围</td><td>scope属性</td><td>@Scope</td></tr><tr><td align="center">生命周期</td><td>标准接口<br>&gt;init-method<br>&gt;destory-method</td><td>@PostConstructor<br>@PreDestroy</td></tr></tbody></table></div><div class="story post-story"><h2 id="16-AOP"><a href="#16-AOP" class="headerlink" title="16.AOP"></a>16.AOP</h2><h3 id="16-1-AOP简介"><a href="#16-1-AOP简介" class="headerlink" title="16.1 AOP简介"></a>16.1 AOP简介</h3><blockquote><p>AOP(Aspect Oriented Programming)面向切面编程，一种编程范式，指导开发者如何组织程序结构</p><ul><li>OOP(Object Oriented Programing)面向对象编程</li></ul><p>作用：在不惊动原始设计的基础上为其进行功能增强</p><p>Spring理念：无入侵式&#x2F;无侵入式</p></blockquote><p><img src="https://s2.loli.net/2022/06/27/Nzn7AdMOxjL5fPk.jpg" class="lazyload" data-srcset="https://s2.loli.net/2022/06/27/Nzn7AdMOxjL5fPk.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="2176E56AC16DA86709ADB8795730ABC7.png"></p><p>执行<code>save()</code>方法 </p><ul><li><p>运行结果：</p><p>打印出一万次的book dao <strong>save</strong> … 和消耗的时间</p></li></ul><p>执行<code>update()</code>方法没有图中<strong>蓝色区域的代码</strong>，</p><ul><li><p>但是，运行结果：</p><p>仍会打印打印出一万次的book dao <strong>update</strong> … 和消耗的时间</p></li></ul><blockquote><p>连接点(JoinPoint)：程序执行过程中的任意位置，粒度为执行方法，抛出异常，设置变量等(<strong>代表所有的方法</strong>)</p><ul><li>在SpringAOP中，理解方法的执行</li></ul><p>切入点(Pointcut)：匹配连接点的式子(<strong>代表要追加功能的方法</strong>)</p><ul><li>在SpringAOP中，一个切入点只描述一个具体方法，也可以匹配多个方法<ul><li>一个具体方法：com.spring.dao包下的BookDao接口中的五星参无返回值的save()方法</li><li>匹配多个方法：所有save方法，所有的get开头的方法，所有以Dao结尾的接口中的任意方法，所有带有一个形参的方法</li></ul></li></ul><p>通知(Advice)：在切入点执行的操作，也就是共性功能(<strong>代表追加的功能</strong>)</p><ul><li>在SpringAOP中，功能最终以方法的形式呈现</li></ul><p>通知类：定义通知的类</p><p>切面(Aspect)：描述通知与切入的对应关系</p></blockquote><h3 id="16-2-AOP入门"><a href="#16-2-AOP入门" class="headerlink" title="16.2 AOP入门"></a>16.2 AOP入门</h3><blockquote><p>案例设定：测试接口执行效率</p><p>简化设定：在接口执行当前输出当前的系统时间</p><p>开发模式：XML or <span style="color:red">注解</span>(此入门案例采用注解的方式)</p><p>思路分析：</p><ol><li>导入坐标(pom.xml)</li><li>制作连接点方法(原始操作，Dao接口与实现类)</li><li>制作共性功能(通知类与通知)</li><li>定义切入点</li><li>绑定切入点与通知关系(切面)</li></ol></blockquote><p>pom.xml：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>创建一个<code>MyAdivice.java</code>类</p><p>其位置：<code>com.spring.aop.MyAdivice.java</code></p><blockquote><p><code>@Component</code>注解：定义为Spring加载的bean</p><p><code>@Aspect</code>注解：把当前类标识为⼀个切⾯供容器读取</p><p><code>@Pointcut(&quot;execution()&quot;)</code>注解：定义切入点，⽅法签名必须是public及void型。</p><p><code>@Before(&quot;pt()&quot;)</code>注解：标识⼀个前置增强⽅法</p><p>切入点<code>pt()</code>的定义依托一个不具有实际意义的方法进行，即无参数、无返回值、方法无实际逻辑</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(void com.spring.dao.BookDao.update())&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@EnableAspectJAutoProxy</code>注解：开启<em>AOP</em>代理自动配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.spring&quot;)</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> ac.getBean(BookDao.class);</span><br><span class="line">        bookDao.update();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">1656341601464</span><br><span class="line">book dao update~~~</span><br></pre></td></tr></table></figure></blockquote><h3 id="16-3-AOP工作流程"><a href="#16-3-AOP工作流程" class="headerlink" title="16.3 AOP工作流程"></a>16.3 AOP工作流程</h3><ol><li><p>Spring容器启动</p></li><li><p>读取所有切面配置中的切入点</p></li><li><p>初始化bean，判定bean对应的类中的方法是否匹配到任意切入点</p><ul><li><p>匹配失败，创建对象</p><p>获取bean，调用方法并执行，完成操作</p></li><li><p>匹配成功，调用方法并执行，完成操作</p><p>获取的bean是代理对象时，根据代理对象的运行模式运行原始方法与增强内容，完成操作</p></li></ul></li><li><p>AOP核心本质：代理模式</p><p>目标对象(Target)：原始功能去掉共性功能对应的类产生的对象，这种对象是无法直接完成最终工作的</p><p>代理(proxy)：目标对象无法直接完成工作，需要进行功能回填，通过原始对象的代理对象实现</p></li></ol><p>代码依旧是入门案例的</p><p>但是将主函数修改，打印<code>bookDao</code>的类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> ac.getBean(BookDao.class);</span><br><span class="line">        System.out.println(bookDao);</span><br><span class="line">        System.out.println(bookDao.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">com.spring.dao.impl.BookDaoImpl@d23e042</span><br><span class="line">class jdk.proxy2.$Proxy20</span><br></pre></td></tr></table></figure></blockquote><blockquote><p><code>System.out.println(bookDao)</code>打印出<code>com.spring.dao.impl.BookDaoImpl@d23e042</code></p><p>是因为AOP对<code>BookDao</code>的<code>toString()</code>方法进行了重写</p><p><code>class jdk.proxy2.$Proxy20</code>：最终用的是代理的对象</p></blockquote><h3 id="16-4-AOP切入点表达式"><a href="#16-4-AOP切入点表达式" class="headerlink" title="16.4 AOP切入点表达式"></a>16.4 AOP切入点表达式</h3><p>切入点：要进行增强的方法</p><p>切入点表达式：要进行增强的方法的描述方法</p><p><strong>1.语法格式</strong></p><p>切入点标准格式：<code>动作关键字(访问修饰符 返回值 包名.接口/类名.方法(参数) 异常名)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">execution(<span class="keyword">public</span> User com.spring.service.UserService.findById(<span class="type">int</span>))</span><br><span class="line">execution(<span class="keyword">public</span> User com.spring.service.impl.UserServiceImpl.findById(<span class="type">int</span>))</span><br></pre></td></tr></table></figure><ul><li>动作关键字：描述切入点行为动作，如execution表示执行到指定切入点</li><li>访问修饰符：public，private等，可以省略</li><li>返回值</li><li>包名</li><li>接口&#x2F;类名：接口名或者类名都可以</li><li>方法名</li><li>参数</li><li>异常名：方法定义中抛出指定异常，可以省略</li></ul><p><strong>2.通配符</strong></p><p>可以使用通配符描述切入点，快速描述</p><ul><li><code>*</code>：单个独立的任意符号，可以独立出现，也可以作为前缀或者后缀的匹配符出现</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(<span class="keyword">public</span> * com.spring.*.UserService.find*(*))</span><br></pre></td></tr></table></figure><p>解释：匹配com.spring包下的任意包中含有UserService类或接口中所有含有find开头的带有任意<strong>一个</strong>参数的方法</p><ul><li><code>..</code>：多个连续的任意符号，可以独立出现，常用于简化包名与参数的书写</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(<span class="keyword">public</span> User com..UserService.findById(..))</span><br></pre></td></tr></table></figure><p>解释：匹配com包中的任意包中的UserService类或接口中的<strong>所有</strong>名称为findById的方法</p><ul><li><code>+</code>：专用于匹配子类类型</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* *..*Service+.*(..))</span><br></pre></td></tr></table></figure><p>解释：匹配·任意包下的以Service结尾的类或接口的子类中<strong>业务层的所有方法</strong></p><ul><li><span style="color:red">常用写法</span></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* com.spring.*.*Service.save(..))</span><br></pre></td></tr></table></figure><p>解释：匹配业务层所有的名为save的方法</p><p><strong>3.书写技巧</strong></p><blockquote><ul><li><p>所有代码按照标准规范开发，<strong>否则</strong>一下技巧<span style="color:red">全部失效</span></p></li><li><p>描述切入点<span style="color:red">通常描述接口</span>，而不描述实现类</p></li><li><p>访问控制修饰符针对接口开发均采用public描述(<span style="color:red">可省略</span>)</p></li><li><p>返回值类型对应<span style="color:red">增删改类</span>使用精准类型加速匹配，对于<span style="color:red">查询类</span>返回值使用<code>*</code>通配符快速描述</p></li><li><p><span style="color:red">包名</span>书写尽量<span style="color:red">不使用<code>..</code>匹配</span>，效率过低，常用<code>*</code>做单个包描述匹配，或精准匹配</p></li><li><p><span style="color:red">接口名&#x2F;类名</span>书写名称与模块的<span style="color:red">采用<code>*</code>匹配</span></p><p>如：<code>UserService</code>书写成<code>*Service</code>，绑定业务层接口名</p></li><li><p><span style="color:red">方法名</span>书写以<span style="color:red">动词</span>进行<span style="color:red">精准匹配</span>，名词采用<code>*</code>匹配</p><p>如：<code>getById</code>书写成<code>getBy*</code>，<code>selectAll</code>书写成<code>selectAll</code></p></li><li><p>参数规则较为复杂，根据业务方法灵活调整</p></li><li><p>通常<span style="color:red">不使用异常</span>作为匹配规则</p></li></ul></blockquote><h3 id="16-5-AOP通知类型"><a href="#16-5-AOP通知类型" class="headerlink" title="16.5 AOP通知类型"></a>16.5 AOP通知类型</h3><p>AOP通知描述了抽取的共性功能，根据共性功能抽取的位置不同，最终运行代码时要将其加入到合理的位置</p><p>AOP通知共分为5钟类型</p><ul><li>前置通知</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(void com.spring.dao.BookDao.update())&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Before(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">before~~~</span><br><span class="line">book dao update~~~</span><br></pre></td></tr></table></figure></blockquote><ul><li>后置通知</li></ul><p>​    </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(void com.spring.dao.BookDao.update())&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Before(&quot;pt()&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;after~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">book dao update~~~</span><br><span class="line">after~~~</span><br></pre></td></tr></table></figure></blockquote><ul><li>环绕通知(重点)</li></ul><p><strong>1.无返回值</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(void com.spring.dao.BookDao.update())&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before~~~&quot;</span>);</span><br><span class="line">        <span class="comment">//表示对原始操作的调用</span></span><br><span class="line">        pjp.proceed();</span><br><span class="line">        System.out.println(<span class="string">&quot;after~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">before~~~</span><br><span class="line">book dao update~~~</span><br><span class="line">after~~~</span><br></pre></td></tr></table></figure></blockquote><p><strong>2.有返回值</strong></p><p>在<code>BookDaoImpl</code>中新写一个有返回值的<code>select</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">select</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;book dao select~~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(void com.spring.dao.BookDao.select())&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">method</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before~~~&quot;</span>);</span><br><span class="line">        <span class="comment">//表示对原始操作的调用，并获得返回值</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line">        System.out.println(<span class="string">&quot;after~~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> ac.getBean(BookDao.class);</span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> bookDao.select();</span><br><span class="line">        System.out.println(num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">before~~~</span><br><span class="line">book dao select~~~</span><br><span class="line">after~~~</span><br><span class="line">100</span><br></pre></td></tr></table></figure></blockquote><p>并且有无返回值都<span style="color:red">建议</span>这样的写法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">method</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before~~~&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line">        System.out.println(<span class="string">&quot;after~~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>@Around</code>注意事项</p><blockquote><ol><li>环绕通知必须依赖形参<code>ProceedingJoinPoint</code>才能实现对原始方法的调用 ,进而实现原始方法调用前后同时添加通知</li><li>通知中如果未使用<code>ProceedingJoinPoint</code>对原始方法进行调用将跳过原始方法的执行</li><li>对原始方法的调用可以不接收返回值 ,通知方法设置成<code>void</code>即可, 如果接收返回值, 必须设定为<code>Object</code>类型</li><li>原始方法的返回值如果 是<code>void</code>类型,通知方法的返回值类型可以设置成<code>void</code> ,也可以设置成<code>Object</code></li><li>由于无法预知原始方法运行后是否会抛出异常 ,因此环绕通知方法必须抛出<code>Throwable</code>对象</li></ol></blockquote><ul><li>返回后通知(了解)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(int com.spring.dao.BookDao.select())&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterReturn~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">book dao select~~~</span><br><span class="line">afterReturn~~~</span><br><span class="line">100</span><br></pre></td></tr></table></figure></blockquote><p><code>@after</code>和<code>@AfterReturning</code>的区别：</p><blockquote><p>原始方法有异常时：</p><p><code>@after</code>也会打印通知的方法</p><p><code>@AfterReturning</code>不会打印通知的方法</p></blockquote><ul><li>抛出异常后通知(了解)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(int com.spring.dao.BookDao.select())&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@AfterThrowing(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterThrowing~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">book dao select~~~</span><br><span class="line"><span class="number">100</span></span><br></pre></td></tr></table></figure></blockquote><p><code>@AfterThrowing</code>注解：只有原始方法抛出异常，才会执行通知的方法</p><h3 id="16-6-AOP通知获取数据"><a href="#16-6-AOP通知获取数据" class="headerlink" title="16.6 AOP通知获取数据"></a>16.6 AOP通知获取数据</h3><blockquote><p>获取切入点方法的参数</p><ul><li>JoinPoint：适用于前置、后置、返回后、抛出异常后通知 </li><li>ProceedJointPoint：适用于环绕通知</li></ul><p>获取切入点方法返回值</p><ul><li>返回后通知</li><li>环绕通知</li></ul><p>获取切入点方法运行异常信息</p><ul><li>抛出异常后通知</li><li>环绕通知</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">select</span><span class="params">(<span class="type">int</span> id, String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;book dao select~~~&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;id:&quot;</span>+id+<span class="string">&quot; name:&quot;</span>+name);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AOP通知获取参数数据</strong></p><p><code>joinPoint</code>对象描述了连接点方法的运行状态，可以获取到原始方法的<strong>调用参数</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(int com.spring.dao.BookDao.select(..))&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">(JoinPoint jp)</span>&#123;</span><br><span class="line">        Object[] args = jp.getArgs();</span><br><span class="line">        System.out.println(Arrays.toString(args));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>主函数调用<code>select</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">        <span class="type">BookDao</span> <span class="variable">bookDao</span> <span class="operator">=</span> ac.getBean(BookDao.class);</span><br><span class="line">        bookDao.select(<span class="number">100</span>, <span class="string">&quot;dahuang&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">[100, dahuang]</span><br><span class="line">book dao select~~~</span><br></pre></td></tr></table></figure></blockquote><p>ProceedingJoinPoint是JoinPoint的子类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> Object <span class="title function_">method</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">       Object[] args = pjp.getArgs();</span><br><span class="line">       System.out.println(Arrays.toString(args));</span><br><span class="line">       args[<span class="number">0</span>] = <span class="number">666</span>;</span><br><span class="line">       <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> pjp.proceed(args);</span><br><span class="line">       <span class="keyword">return</span> ret;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line">[100, dahuang]</span><br><span class="line">book dao select~~~</span><br><span class="line">id:666 name:dahuang</span><br></pre></td></tr></table></figure></blockquote><p><strong>AOP通知获取返回数据</strong></p><p>抛出异常后通知可以获取切入点方法中出现的异常信息，使用形参可以接收对应的异常对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AfterReturning(value = &quot;pt()&quot;, returning = &quot;ret&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">(JoinPoint jp, <span class="type">int</span> ret)</span>&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;afterReturn~~~&quot;</span>+ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>环绕通知中可以手工书写对原始方法的调用，得到的结果即为原始方法的返回值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">method</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>AOP通知获取异常数据(了解)</strong></p><p>抛出异常后通知可以获取切入点方法中出现的异常信息，使用形参可以接收对应的异常对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AfterThrowing(value = &quot;pt()&quot;, throwing = &quot;t&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">(JoinPoint jp, Throwable t)</span>&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;afterThrowing~~~&quot;</span>+t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>抛出异常后通知可以获取切入点方法运行的异常信息，使用形参可以接收运行时抛出的异常对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">method</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ret = pjp.proceed();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Throwable t)&#123;</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="16-7-AOP总结"><a href="#16-7-AOP总结" class="headerlink" title="16.7 AOP总结"></a>16.7 AOP总结</h3><p>1.基本概念：</p><blockquote><p>概念：AOP(Aspect Oriented Programming) 面向切面编程，一种编程范式 </p><p>作用：在不惊动原始设计的基础上为方法进行功能<span style="color:red">增强</span></p><p>核心概念</p><ul><li>代理(Proxy)：SpringAOP的核心本质是采用代理模式实现的</li><li>连接点(JoinPoint )：在SpringAOP中 ,理解为任意方法的执行</li><li>切入点( Pointcut )：匹配连接点的式子,也是具有共性功能的方法描述</li><li>通知(Advice)：若干个方法的共性功能,在切入点处执行,最终体现为-一个方法 </li><li>切面( Aspect )：描述通知与切入点的对应关系</li><li>目标对象 ( Target )：被代理的原始对象成为目标对象</li></ul></blockquote><p>2.切入点：</p><blockquote><p>切入点表达式标准格式：</p><ul><li>动作关键字(访问修饰符 返回值 包名.类&#x2F;接口名.方法名(参数) 异常名) </li><li><code>execution(* com.spring.service.*Service.*(..))</code></li></ul><p>切入点表达式描述通配符：</p><ul><li><p>作用: 用于快速描述,范围描述</p></li><li><p><code>*</code>：匹配任意符号(常用)</p></li><li><p><code>..</code>：匹配多个连续的任意符号(常用)</p></li><li><p><code>+</code>：匹配子类类型</p></li></ul><p>切入点表达式书写技巧 </p><ol><li>按<span style="color:red">标准规范</span>开发</li><li>查询操作的返回值建议使用<code>*</code>匹配</li><li>减少使用<code>..</code>的形式描述包</li><li><span style="color:red">对接口进行描述</span>,使用<code>*</code>表示模块名,例如<code>UserService</code>的匹配描述为<code>*Service</code></li><li>方法名书写保留动词,例如get ,使用<code>*</code>表示名词,例如<code>getById</code>匹配描述为<code>getBy*</code></li><li>参数根据实际情况灵活调整</li></ol></blockquote><p>3.通知类型：</p><blockquote><p>前置通知</p><p>后置通知</p><p><span style="color:red">环绕通知</span>(重点)</p><ul><li>环绕通知依赖形参<code>ProceedingJoinPoint</code>才能实现对原始方法的调用</li><li>环绕通知可以隔离原始方法的调用执行</li><li>环绕通知返回值设置为<code>0bject</code>类型</li><li>环绕通知中可以对原始方法调用过程中出现的异常进行处理</li></ul><p>返回后通知</p><p>抛出异常后通知</p></blockquote><p>4.通知获取数据：</p><blockquote><p>获取切入点方法的参数</p><ul><li>JoinPoint：适用于前置、后置、返回后、抛出异常后通知,设置为方法的第一个形参</li><li>ProceedJointPoint：适用于环绕通知</li></ul><p>获取切入点方法返回值</p><ul><li>返回后通知 .</li><li>环绕通知</li></ul><p>获取切入点方法运行异常信息</p><ul><li>抛出异常后通知</li><li>环绕通知</li></ul></blockquote></div><div class="story post-story"><h2 id="17-Spring事务"><a href="#17-Spring事务" class="headerlink" title="17.Spring事务"></a>17.Spring事务</h2><h3 id="17-1-Spring事务简介"><a href="#17-1-Spring事务简介" class="headerlink" title="17.1 Spring事务简介"></a>17.1 Spring事务简介</h3><p>事务作用：在数据层保障一系列的数据库操作同成功同失败</p><p>Spring事务作用：在数据层或业务层保障一系列的数据库操作同成功同失败</p><p>案例：银行转账</p><blockquote><p>需求:实现任意两个账户间转账操作</p><p>需求微缩: A账户减钱, B账户加钱</p><p>分析:</p><p>①数据层提供基础操作, 指定账户减钱( outMoney ) , 指定账户加钱( inMoney ) </p><p>②业务层提供转账操作( transfer ) , 调用减钱与加钱的操作</p><p>③提供2个账号和操作金额执行转账操作</p><p>④基于Spring整合MyBatis环境搭建上述操作</p></blockquote><p>JDK版本：8</p><p>项目结构：</p><img src="https://s2.loli.net/2022/06/30/rxS3XABMkZpz1qI.png" class="lazyload" data-srcset="https://s2.loli.net/2022/06/30/rxS3XABMkZpz1qI.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="项目结构" style="zoom: 67%;" /><p><code>pom.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>com.spring.config包下：</p><p><code>JdbcConfig</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.driver&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(driver);</span><br><span class="line">        ds.setUrl(url);</span><br><span class="line">        ds.setUsername(userName);</span><br><span class="line">        ds.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置事务管理器，mybatis使用的是jdbc事务</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">transactionManager</span><span class="params">(DataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="type">DataSourceTransactionManager</span> <span class="variable">transactionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>();</span><br><span class="line">        transactionManager.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> transactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MybatisConfig</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactoryBean <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">ssfb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        ssfb.setTypeAliasesPackage(<span class="string">&quot;com.itheima.p&quot;</span>);</span><br><span class="line">        ssfb.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> ssfb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MapperScannerConfigurer <span class="title function_">mapperScannerConfigurer</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MapperScannerConfigurer</span> <span class="variable">msc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapperScannerConfigurer</span>();</span><br><span class="line">        msc.setBasePackage(<span class="string">&quot;com.itheima.dao&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> msc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>核心配置类：<code>SpringConfig</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.itheima&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span></span><br><span class="line"><span class="meta">@Import(&#123;JdbcConfig.class,MybatisConfig.class&#125;)</span></span><br><span class="line"><span class="comment">//开启注解式事务驱动</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Account</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Double money;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">getMoney</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMoney</span><span class="params">(Double money)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Account&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, money=&quot;</span> + money +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>com.spring.dao包下：</p><p><code>AccountDao</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;update demo.account set money = money + #&#123;money&#125; where name = #&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">inMoney</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name, <span class="meta">@Param(&quot;money&quot;)</span> Double money)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;update demo.account set money = money - #&#123;money&#125; where name = #&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">outMoney</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name, <span class="meta">@Param(&quot;money&quot;)</span> Double money)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AccountService</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="comment">//配置当前接口方法具有事务</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out,String in ,Double money)</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AccountServiceImpl</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out,String in ,Double money)</span> &#123;</span><br><span class="line">        accountDao.outMoney(out,money);</span><br><span class="line">        accountDao.inMoney(in,money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类：<code>AccountServiceTest</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = SpringConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTransfer</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        accountService.transfer(<span class="string">&quot;Tom&quot;</span>,<span class="string">&quot;Jerry&quot;</span>,<span class="number">100D</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="17-2-Spring事务角色"><a href="#17-2-Spring事务角色" class="headerlink" title="17.2 Spring事务角色"></a>17.2 Spring事务角色</h3><p>事务角色</p><ul><li><p>事务管理员：发起事务方，在Spring中通常代指业务层开启事务的方法</p></li><li><p>事务协调员：加入事务方，在Spring中通常代指数据层方法，也可以是业务层的方法</p></li></ul><h3 id="17-3-Spring事务属性"><a href="#17-3-Spring事务属性" class="headerlink" title="17.3 Spring事务属性"></a>17.3 Spring事务属性</h3><table><thead><tr><th align="center">属性</th><th align="center">作用</th><th align="center">示例</th></tr></thead><tbody><tr><td align="center">readOnly</td><td align="center">设置是否为只读事务</td><td align="center">readOnly&#x3D;true 只读事务</td></tr><tr><td align="center">timeout</td><td align="center">设置事务超时时间</td><td align="center">timeout&#x3D;-1 永不超时</td></tr><tr><td align="center"><span style="color:red">rollbackFor</span></td><td align="center">设置事务回滚异常(class)</td><td align="center">rollbackFor&#x3D;{NullPointException.class}</td></tr><tr><td align="center">rollbackForClassName</td><td align="center">设置事务回滚异常(String)</td><td align="center">同上字符串格式</td></tr><tr><td align="center">noRollbackFor</td><td align="center">设置事务不回滚异常(class)</td><td align="center">norollbackFor&#x3D;{NullPointException.class}</td></tr><tr><td align="center">noRollbackForClassName</td><td align="center">设置事务不回滚异常(String)</td><td align="center">同上字符串格式</td></tr><tr><td align="center"><span style="color:red">propagation</span></td><td align="center">设置事务传播行为</td><td align="center">…..</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out, String in, Double money)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        accountDao.outMoney(out,money);</span><br><span class="line">        <span class="comment">//添加IOException类型错误</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">true</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>();</span><br><span class="line">        accountDao.inMoney(in,money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后，报错，<code>outMoney</code>方法执行了，但<code>inMoney</code>方法没有执行。</p><p>并不是所有错误类型都会回滚，</p><p>我们希望<code>transfer</code>方法，调用的事务同失败。</p><p>在<code>@Transactional</code>注解中的属性<code>rollbackFor</code>添加错误的类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = &#123;IOException.class&#125;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out, String in, Double money)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再次运行后，报错，<code>outMoney</code>和<code>inMoney</code>方法都没有执行</p><p>案例：转账业务追加日志</p><blockquote><p>需求:实现任意两个账户间转账操作,并对每次转账操作在数据库进行留痕 </p><p>需求微缩: A账户减钱, B账户加钱,数据库记录日志</p><p>分析:</p><p>①:基于转账操作案例添加日志模块,实现数据库中记录日志</p><p>②:业务层转账操作( transfer ) ,调用减钱、加钱与记录日志功能</p><p>实现效果预期：</p><p>​<strong>无论转账操作是否成功,均进行转账操作的日志留痕</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LogService logService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out, String in, Double money)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            accountDao.outMoney(out,money);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        accountDao.inMoney(in,money);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span>&#123;</span><br><span class="line">            logService.log(out,in,money);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后，<code>outMoney</code>方法和<code>inMoney</code>方法进行回滚，同时<code>log</code>方法也进行了回滚，未将日志记录到数据库中</p><p>存在问题：</p><p> 日志的记录与转账操作隶属同一个事务，同成功同失败</p><ul><li>事务传播行为：事务协调员对事物管理员所携带事务的处理态度</li></ul><p><img src="https://s2.loli.net/2022/06/30/yXdkb8CIgoGnWVp.jpg" class="lazyload" data-srcset="https://s2.loli.net/2022/06/30/yXdkb8CIgoGnWVp.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="事务传播.png"></p><p>在业务层接口添加Spring事务，</p><p><code>@Transactional</code>注解中的<code>propagation</code>属性设置事务传播行为<span style="color:red">REQIRES_NEW</span>(需要新事务)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LogService</span> &#123;</span><br><span class="line">    <span class="comment">//设置为新事务</span></span><br><span class="line"><span class="meta">@Transactional(propagation=Propagation.REQIRES_NEW)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String out, String in, Double money)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后，<code>outMoney</code>方法和<code>inMoney</code>方法进行回滚，事务成功。</p><p><code>log</code>方法执行，将日志记录到数据库中</p><table>    <tr>        <th>传播属性</th>        <th>事务管理员</th>        <th>事务协调员</th>    </tr>    <tr align="center">                 <td rowspan="2">REQUIRED(默认)</td>                 <td>开启T</td>        <td>加入T</td>    </tr>    <tr align="center">                         <td>无</td>        <td>新建T2</td>    </tr>    <tr align="center">                 <td rowspan="2">REQUIRES_NEW</td>                 <td>开启T</td>        <td>新建T2</td>    </tr>    <tr align="center">                         <td>无</td>        <td>新建T2</td>    </tr>    <tr align="center">                 <td rowspan="2">SUPPORTS</td>                 <td>开启T</td>        <td>加入T</td>    </tr>    <tr align="center">                         <td>无</td>        <td>无</td>    </tr>    <tr align="center">                 <td rowspan="2">NOT_SUPPORTED</td>                 <td>开启T</td>        <td>无</td>    </tr>    <tr align="center">                         <td>无</td>        <td>无</td>    </tr>    <tr align="center">                 <td rowspan="2">MANDATORY</td>                 <td>开启T</td>        <td>加入T</td>    </tr>    <tr align="center">                         <td>无</td>        <td style="color:red">ERROR</td>    </tr>    <tr align="center">                 <td rowspan="2">NEVER</td>                 <td>开启T</td>        <td style="color:red">ERROR</td>    </tr>    <tr align="center">                         <td>无</td>        <td>无</td>    </tr>    <tr align="center">                 <td>NESTED</td>        <td colspan="2">设置savePoint，一旦事务回滚，事务将回滚到savePoint处，交由客户端提交/回滚</td>    </tr></table><p>​      </p></div><div class="story post-story"><h2 id="18-结语"><a href="#18-结语" class="headerlink" title="18.结语"></a>18.结语</h2><p>你竟然看完了(不敢相信！！)，真的人会看吗！真的吗！ゞ◎Д◎ヾ</p><p>本人也是初学Spring，笔记中如果有什么遗漏或错误的地方欢迎大佬指正（≧∀≦）</p><ul><li>本人QQ：2691936018</li><li>备注：Spring</li></ul><p>另外关于Spring框架，如果有新的内容需要补充，本人也会进行更新的</p><p>本笔记的学习视频：<a href="https://www.bilibili.com/video/BV1Fi4y1S7ix">黑马2022最新SSM框架</a></p><p>我们SpringMVC见！！(还是不太相信能有人看╮(╯▽╰)╭)</p></div>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 框架 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringMVC框架的学习笔记</title>
      <link href="/2022/08/06/Java/SpringMCV%E6%A1%86%E6%9E%B6/"/>
      <url>/2022/08/06/Java/SpringMCV%E6%A1%86%E6%9E%B6/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="1-初认SpringMVC"><a href="#1-初认SpringMVC" class="headerlink" title="1.初认SpringMVC"></a>1.初认SpringMVC</h2><h3 id="1-1-SpringMVC简介"><a href="#1-1-SpringMVC简介" class="headerlink" title="1.1 SpringMVC简介"></a>1.1 SpringMVC简介</h3><blockquote><p>SpringMVC技术与Servlet技术功能等同，均属于web层开发技术</p><p>SpringMVC是一种基于java实现MVC模型的轻量级<span style="color:red">Web框架</span></p><p>优点：</p><ul><li>使用简单，开发便捷(相比与Servlet)</li><li>灵活性强</li></ul></blockquote><p>项目结构：</p><img src="https://s2.loli.net/2022/07/02/45iHRuqkbcsFL2A.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/02/45iHRuqkbcsFL2A.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220702172705111" style="zoom:67%;" /><h3 id="1-2-SpringMVC入门"><a href="#1-2-SpringMVC入门" class="headerlink" title="1.2 SpringMVC入门"></a>1.2 SpringMVC入门</h3><p>1.使用SpringMVC技术需要先导入SpringMVC坐标与Servlet</p><p>不需要导入spring-context包，spring-webmvc包中包含spring-context包</p><p>2.导入Tomcat插件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span> <span class="comment">&lt;!-- 和Tomcat有冲突 --&gt;</span>       </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>        </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Tomcat插件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span>8888<span class="tag">&lt;/<span class="name">port</span>&gt;</span> <span class="comment">&lt;!--端口可任意只要没有被占用--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span>&gt;</span>/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3.创建SpringMVC控制器类(等同于Servlet功能)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="comment">//设置当前控制器方法的请求路径</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="comment">//设置当前控制器方法响应内容为当前返回值，无需解析</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4.初始化SpringMVC环境(同Spring环境)，设定SpringMVC加载对应的bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建SpringMVC的配置文件，加载controller对应的bean</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.springmvc.controller&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMvcConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5.初始化Servlet容器，加载SpringMVC环境，并设置SpringMVC技术处理的请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个servlet容器启动的配置类，在里面加载Spring的配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContainerInitConfig</span> <span class="keyword">extends</span> <span class="title class_">AbstractDispatcherServletInitializer</span> &#123;</span><br><span class="line">    <span class="comment">//加载SpringMVC容器的配置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> WebApplicationContext <span class="title function_">createServletApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigWebApplicationContext</span> <span class="variable">acwac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigWebApplicationContext</span>();</span><br><span class="line">        acwac.register(SpringMvcConfig.class);</span><br><span class="line">        <span class="keyword">return</span> acwac;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//设定SpringMVC对应的请求的映射路径</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">        <span class="comment">//设置为/表示拦截所有请求，任意请求都将转入到SpringMVC中进行处理</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//加载Spring容器配置，现在不需要</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> WebApplicationContext <span class="title function_">createRootApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>右键找到<code>Run Maven</code>再找到<code>tomcat7:run</code>点击运行，打开浏览器打开<code>http://localhost:8888/save</code></p><p>页面即可出现内容：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>&#x27;info&#x27;<span class="punctuation">:</span>&#x27;springmvc&#x27;<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>此时控制台打印出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br></pre></td></tr></table></figure><h3 id="1-3-入门总结"><a href="#1-3-入门总结" class="headerlink" title="1.3 入门总结"></a>1.3 入门总结</h3><blockquote><p>SpringMVC入门程序开发总结(1+N)</p><ul><li><p>一次性工作</p><ul><li>创建工程, 设置服务器，加载工程</li><li>导入坐标</li><li>创建web容器启动类, 加载SpringMVC配置， 并设置SpringMVC请求拦截路径</li><li>SpringMVC核心配置类 (设置配置类,扫描controller包, 加载Controller控制器bean)</li></ul></li><li><p>多次工作</p><ul><li>定义处理请求的控制器类</li><li>定义处理请求的控制器方法， 并配置映射路径<code>@RequestMapping</code>与返回json数据<code>@ResponseBody</code></li></ul></li></ul></blockquote><h3 id="1-4-工作流程"><a href="#1-4-工作流程" class="headerlink" title="1.4 工作流程"></a>1.4 工作流程</h3><p>入门案例工作流程分析</p><blockquote><ul><li><p>启动服务器初始化过程</p><ol><li>服务器启动, 执行<code>ServletContainersInitConfig</code>类,初始化web容器</li><li>执行<code>createServletApplicationContext</code>方法，创建了<code>WebApplicationContext</code>对象</li><li>加载<code>SpringMvcConfig</code>配置文件</li><li>执行<code>@ComponentScan</code>加载对应的bean</li><li>加载<code>UserController</code>, 每个<code>@RequestMapping</code>的名称对应一 个具体的方法</li><li>执行<code>getServletMappings</code>方法, 定义所有的请求都通过SpringMVC</li></ol></li><li><p>单次请求过程</p><ol><li>发送请求<code>http:localhost:8888/save</code></li><li>web容器发现所有请求都经过SpringMVC, 将请求交给SpringMVC处理</li><li>解析请求路径&#x2F;save</li><li>由&#x2F;save匹配执行对应的方法<code>save()</code></li><li>执行<code>save()</code> </li><li>检测到有<code>@ResponseBody</code>直接将<code>save()</code>方法的返回值作为响应求体返回给请求方</li></ol></li></ul></blockquote><h3 id="1-5-bean加载控制"><a href="#1-5-bean加载控制" class="headerlink" title="1.5 bean加载控制"></a>1.5 bean加载控制</h3><blockquote><p>com</p><blockquote><p>springmvc</p><blockquote><p>config</p><p>controller</p><p>service</p><p>dao</p></blockquote></blockquote></blockquote><p>Controller加载控制业务与业务bean加载控制</p><p>SpringMVC相关bean</p><ul><li>表现层bean(Controller)</li></ul><p>Spring控制的bean</p><ul><li>业务bean(Service)</li><li>功能bean(DataSourse等)</li></ul><p>SpringMVC相关的bean加载控制</p><ul><li>SpringMVC加载的bean对应的包均在<code>com.springnvc.controller</code>包内</li></ul><p>Spring相关bean加载控制</p><ul><li>Spring加载的bean设定范围为<code>com.springmvc</code>，排除controller包内的bean</li><li>Spring加载的bean设定范围为精准范围，如：<code>com.springmvc.dao</code>、<code>com.springmvc.service</code>等(常用)</li><li>不区分Spring与SpringMVC的环境，加载到同一个环境中</li></ul><p>方式一(常用)：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.springmvc.dao&quot;,&quot;com.springmvc.service&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方式二：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(value = &quot;com.springmvc&quot;, </span></span><br><span class="line"><span class="meta">        excludeFilters = @ComponentScan.Filter(</span></span><br><span class="line"><span class="meta">                type = FilterType.ANNOTATION, //按照注解排除</span></span><br><span class="line"><span class="meta">                classes = Controller.class //需要排除的注解类型</span></span><br><span class="line"><span class="meta">        )</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>加载SpringMVC和Spring配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContainerInitConfig</span> <span class="keyword">extends</span> <span class="title class_">AbstractDispatcherServletInitializer</span> &#123;</span><br><span class="line">    <span class="comment">//加载SpringMVC配置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> WebApplicationContext <span class="title function_">createServletApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigWebApplicationContext</span> <span class="variable">acwac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigWebApplicationContext</span>();</span><br><span class="line">        acwac.register(SpringMvcConfig.class);</span><br><span class="line">        <span class="keyword">return</span> acwac;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//加载SpringMVC配置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> WebApplicationContext <span class="title function_">createRootApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigWebApplicationContext</span> <span class="variable">acwac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigWebApplicationContext</span>();</span><br><span class="line">        acwac.register(SpringConfig.class);</span><br><span class="line">        <span class="keyword">return</span> acwac;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简化操作(常用)：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletContainerInitConfig</span> <span class="keyword">extends</span> <span class="title class_">AbstractAnnotationConfigDispatcherServletInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;SpringConfig.class&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;SpringMvcConfig.class&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="2-请求与响应"><a href="#2-请求与响应" class="headerlink" title="2.请求与响应"></a>2.请求与响应</h2><h3 id="2-1-请求映射路径"><a href="#2-1-请求映射路径" class="headerlink" title="2.1 请求映射路径"></a>2.1 请求映射路径</h3><p>项目结构：</p><p><img src="https://s2.loli.net/2022/07/04/2gBEA6xmdpzqMPQ.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/04/2gBEA6xmdpzqMPQ.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220704114846464.png"></p><p>BookController：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;book is saving~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserController：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>运行程序后报错，无法启动。</p><p>因为路径都为<code>/save</code>的话，在网页请求<code>/save</code>，程序会不知道调用哪个控制器方法</p></blockquote><p>改进：</p><p>BookController：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;book is saving~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserController：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>还可以更加精简，增加模块的请求路径前缀：</p><blockquote><p><code>@RequestMapping</code>注解：</p><ul><li>设置在控制器方法上：请求访问路径</li><li>设置在类上：统一设置当前类中控制器方法请求路径前缀</li></ul></blockquote><p>BookController：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/book&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;book is saving~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserController：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-请求方式"><a href="#2-2-请求方式" class="headerlink" title="2.2 请求方式"></a>2.2 请求方式</h3><blockquote><ul><li>Get请求</li><li>Post请求</li></ul></blockquote><p>所要访问的控制器方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(String name, <span class="type">int</span> age)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;name=&quot;</span>+name+<span class="string">&quot;  age=&quot;</span>+age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><span style="color:red">get请求</span>：</p><ul><li>url地址传参，地址参数要与形参变量名相同，定义形参几个接收参数</li></ul><p>访问链接：<code>http://localhost:8888/user/save?name=dahuang&amp;age=18</code></p><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br><span class="line">name=dahuang  age=18</span><br></pre></td></tr></table></figure></blockquote><p><span style="color:red">post请求</span>：</p><ul><li>form表单post请求传参，表单参数名要与形参变量名相同，定义形参几个接收参数</li></ul><p>访问链接：<code>http://localhost:8888/user/save</code></p><p>提交数据形式：<code>x-www-form-urlencoded</code></p><img src="https://s2.loli.net/2022/07/04/vRYxZPSKoEeOFpA.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/04/vRYxZPSKoEeOFpA.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220704190432127" style="zoom:67%;" /><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br><span class="line">name=dahei  age=20</span><br></pre></td></tr></table></figure></blockquote><p>如果参数为中文呢？</p><img src="https://s2.loli.net/2022/07/04/NVSRTfE2vUmruy7.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/04/NVSRTfE2vUmruy7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220704190806620" style="zoom:67%;" /><p>控制台打印，会乱码：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br><span class="line">name=å¤§é»  age=20</span><br></pre></td></tr></table></figure></blockquote><p><span style="color:red">Post请求中文乱码处理</span>：</p><p>在<code>ServletContainerInitConfig</code>配置文件中重写<code>getServletFilters()</code>方法</p><p>为web容器添加过滤器并指定字符集，Spring-web包中提供了专用的字符过滤器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Filter[] getServletFilters() &#123;</span><br><span class="line">    <span class="type">CharacterEncodingFilter</span> <span class="variable">aef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CharacterEncodingFilter</span>();</span><br><span class="line">    aef.setEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Filter</span>[]&#123;aef&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再次运行后，控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br><span class="line">name=大黄  age=20</span><br></pre></td></tr></table></figure></blockquote><h3 id="2-3-5种类型参数传递"><a href="#2-3-5种类型参数传递" class="headerlink" title="2.3 5种类型参数传递"></a>2.3 5种类型参数传递</h3><blockquote><p>参数种类</p><ul><li>普通参数</li><li>POJO参数</li><li>嵌套POJO参数</li><li>数组类型参数</li><li>集合类型参数</li></ul></blockquote><p><span style="color:red">普通参数</span>：请求参数名与形参变量名不同，使用<code>@RequestParam</code>注解绑定参数关系</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String userName, <span class="type">int</span> age)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;name=&quot;</span>+userName+<span class="string">&quot;  age=&quot;</span>+age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><span style="color:red">POJO参数</span>：请求参数名与形参对象名相同，定义POJO类型形参即可接收参数</p><p>创建一个实体类<code>User</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;<span class="keyword">return</span> name;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;<span class="built_in">this</span>.name = name;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;<span class="keyword">return</span> age;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;<span class="built_in">this</span>.age = age;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>UserController</code>中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(User user)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">   System.out.println(user.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>get请求：</p><p>url地址：<code>http://localhost:8888/user/save?name=dahei&amp;age=16</code></p><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br><span class="line">User&#123;name=&#x27;dahei&#x27;, age=16&#125;</span><br></pre></td></tr></table></figure></blockquote><p><span style="color:red">嵌套POJO参数</span>：POJO对象中包含POJO对象</p><p>创建一个新实体类<code>Address</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String province;</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProvince</span><span class="params">()</span> &#123;<span class="keyword">return</span> province;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProvince</span><span class="params">(String province)</span> &#123;<span class="built_in">this</span>.province = province;&#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCity</span><span class="params">()</span> &#123;<span class="keyword">return</span> city;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCity</span><span class="params">(String city)</span> &#123;<span class="built_in">this</span>.city = city;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Address&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;province=&#x27;&quot;</span> + province + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, city=&#x27;&quot;</span> + city + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将<code>Address</code>对象加入到<code>User</code>对象中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Address <span class="title function_">getAddress</span><span class="params">()</span> &#123;<span class="keyword">return</span> address;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAddress</span><span class="params">(Address address)</span> &#123;<span class="built_in">this</span>.address = address;&#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;<span class="keyword">return</span> name;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;<span class="built_in">this</span>.name = name;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;<span class="keyword">return</span> age;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;<span class="built_in">this</span>.age = age;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, address=&quot;</span> + address +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>get请求：</p><p>url地址：<code>http://localhost:8888/user/save?name=dahuang&amp;age=20&amp;address.province=tianjin&amp;address.city=baodi</code></p><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br><span class="line">User&#123;name=&#x27;dahuang&#x27;, age=20, address=Address&#123;province=&#x27;tianjin&#x27;, city=&#x27;baodi&#x27;&#125;&#125;</span><br></pre></td></tr></table></figure></blockquote><p><span style="color:red">数组参数</span>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(String[] hobbies)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">        System.out.println(Arrays.toString(hobbies));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>get请求：</p><p>url地址：<code>http://localhost:8888/user/save?hobbies=TV&amp;hobbies=game&amp;hobbies=food</code></p><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br><span class="line">[TV, game, food]</span><br></pre></td></tr></table></figure></blockquote><p><span style="color:red">集合参数</span>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(<span class="meta">@RequestParam</span> List&lt;String&gt; hobbies)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">        System.out.println(hobbies.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>get请求：</p><p>url地址：<code>http://localhost:8888/user/save?hobbies=TV&amp;hobbies=game&amp;hobbies=food</code></p><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br><span class="line">[TV, game, food]</span><br></pre></td></tr></table></figure></blockquote><h3 id="2-4-传递json数据"><a href="#2-4-传递json数据" class="headerlink" title="2.4 传递json数据*"></a>2.4 传递json数据*</h3><p>导入<code>jackson</code>坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>json有两种格式：</p><ul><li>对象格式：<code>&#123;&quot;key1&quot;:obj,&quot;key2&quot;:obj,&quot;key3&quot;:obj...&#125;</code></li><li>数组&#x2F;集合格式：<code>[obj,obj,obj...]</code></li></ul><p>在<code>SpringMvcConfig</code>配置文件中，添加注解<code>@EnableWebMvc</code>：</p><p><code>@EnableWebMvc</code>注解：开启json数据转换成对象的功能</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.springmvc.controller&quot;)</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMvcConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><span style="color:red">集合参数</span>：json格式</p><p><code>@RequestBody</code>注解：将请求中请求体所包含的数据传递给请求参数，此注解一个处理器方法只能使用一次</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;String&gt; hobbies)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">        System.out.println(hobbies.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/07/04/bVpUlEH5xgsIyo1.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/04/bVpUlEH5xgsIyo1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220704214758222.png" style="zoom:67%;" /><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br><span class="line">[TV, game, food]</span><br></pre></td></tr></table></figure></blockquote><p><span style="color:red">POJO参数</span>：json格式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/07/04/3iM7ZXNQSEkJ4ep.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/04/3iM7ZXNQSEkJ4ep.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220704220445677.png" style="zoom:67%;" /><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br><span class="line">User&#123;name=&#x27;dahuang&#x27;, age=20, address=Address&#123;province=&#x27;tianjin&#x27;, city=&#x27;baodi&#x27;&#125;&#125;</span><br></pre></td></tr></table></figure></blockquote><p><span style="color:red">集合对象参数</span>：json格式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;User&gt; list)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user is saving~~&quot;</span>);</span><br><span class="line">        System.out.println(list.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/07/04/SVgIhQqeRl9yjN7.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/04/SVgIhQqeRl9yjN7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220704221250254.png" style="zoom:67%;" /><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user is saving~~</span><br><span class="line">[User&#123;name=&#x27;dahei&#x27;, age=20, address=Address&#123;province=&#x27;tianjin&#x27;, city=&#x27;baodi&#x27;&#125;&#125;, User&#123;name=&#x27;dahuang&#x27;, age=20, address=Address&#123;province=&#x27;guizhou&#x27;, city=&#x27;zunyi&#x27;&#125;&#125;]</span><br></pre></td></tr></table></figure></blockquote><p><code>@RequestBody</code>与<code>@RequestParam</code>的区别：</p><blockquote><p>区别</p><ul><li><code>@RequestParam</code>用于url地址传参，表单传参 <code>application/x-www-form-urlencoded</code></li><li><code>@RequestBody</code>用于接收json数据  <code>application/json</code></li></ul><p>应用</p><ul><li>后期开发，发送json格式数据为主，<code>@RequestBody</code>拥有较广</li><li>如果发送非json格式数据，选用<code>@RequestParam</code>接收请求参数</li></ul></blockquote><h3 id="2-5-日期类型参数传递"><a href="#2-5-日期类型参数传递" class="headerlink" title="2.5 日期类型参数传递"></a>2.5 日期类型参数传递</h3><p>日期类型数据基于系统不同格式也不尽相同</p><ul><li>2022-07-04</li><li>2022&#x2F;07&#x2F;04</li><li>07&#x2F;04&#x2F;2022</li></ul><p>接收形参时，根据不同的日期格式设置不同的接收方式</p><p><code>@DataTimeFormat</code>注解中的<code>pattern</code>属性来自定义日期时间型数据格式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/date&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(Date date1,</span></span><br><span class="line"><span class="params">                       <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-mm-dd&quot;)</span> Date date2,</span></span><br><span class="line"><span class="params">                       <span class="meta">@DateTimeFormat(pattern = &quot;yyyy/mm/dd HH:mm:ss&quot;)</span> Date date3)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;date1==&gt;&quot;</span>+date1);</span><br><span class="line">        System.out.println(<span class="string">&quot;date2==&gt;&quot;</span>+date2);</span><br><span class="line">        System.out.println(<span class="string">&quot;date3==&gt;&quot;</span>+date3);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#x27;info&#x27;:&#x27;springmvc&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/07/04/y5KgH9NFTUPoXBR.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/04/y5KgH9NFTUPoXBR.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220704231311600.png" style="zoom:67%;" /><p>控制台打印：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">date1==&gt;Mon Jul 04 00:00:00 CST 2022</span><br><span class="line">date2==&gt;Tue Jan 04 00:07:00 CST 2022</span><br><span class="line">date3==&gt;Tue Jan 04 23:10:00 CST 2022</span><br></pre></td></tr></table></figure><p>类型转换器：</p><p>Converter接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Converter</span>&lt;S, T&gt; &#123;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">T <span class="title function_">convert</span><span class="params">(S val)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>请求参数年龄数据(String&#x3D;&#x3D;&gt;Integer)</li><li>日期格式转换(String&#x3D;&#x3D;&gt;Date)</li></ul><p><code>@EnableWebMvc</code>注解作用之一：根据类型匹配对应的类型转换器</p><h3 id="2-6-响应数据"><a href="#2-6-响应数据" class="headerlink" title="2.6 响应数据"></a>2.6 响应数据</h3><blockquote><p>响应页面</p><p>响应数据</p><ul><li><p>文本数据</p></li><li><p>json数据</p></li></ul></blockquote><p><span style="color:red">响应页面</span>：</p><p>在<code>webapp</code>资源包中新建文件：<code>page.jsp</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Hello SpringMVC!<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>页面跳转：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/jumpPage&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">jumpPage</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;页面跳转&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;page.jsp&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>url地址：<code>http://localhost:8888/jumpPage</code></p><p>会自动跳转到<code>page.jsp</code>页面</p><p><span style="color:red">响应文本数据</span>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/toText&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toText</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;返回纯文本数据&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello SpringMVC&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>url地址：<code>http://localhost:8888/toText</code></p><p>页面数据：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello SpringMVC</span><br></pre></td></tr></table></figure><p><span style="color:red">响应POJO对象</span>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/toPojo&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">toPojo</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;返回POJO数据&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;大黄&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>url地址：<code>http://localhost:8888/toPojo</code></p><p>页面数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;大黄&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>其中是<code>jackson</code>自动将对象转换成json数据</p><p>所以一定要导入<code>jackson</code>坐标</p><p><span style="color:red">响应POJO集合对象</span>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/toPojoList&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">toPojoList</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;返回POJO集合对象数据&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user1.setName(<span class="string">&quot;大黄&quot;</span>);</span><br><span class="line">        user1.setAge(<span class="number">18</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user2.setName(<span class="string">&quot;大黑&quot;</span>);</span><br><span class="line">        user2.setAge(<span class="number">20</span>);</span><br><span class="line">        List&lt;User&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(user1);</span><br><span class="line">        list.add(user2);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>url地址：<code>http://localhost:8888/toPojoList</code></p><p>页面数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;大黄&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;大黑&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><blockquote><p><code>@ResponseBody</code>注解：</p><p>设置当前控制器返回值作为响应体</p><p>控制器方法返回值数据类型为<code>String</code>，则返回文本数据</p><p>控制器方法返回值数据类型为对象，则自动将对象转换成json数据</p><p>类型转换器：</p><p>web请求专用类型转换器：HttpMessageConverter接口</p></blockquote></div><div class="story post-story"><h2 id="3-REST风格"><a href="#3-REST风格" class="headerlink" title="3.REST风格"></a>3.REST风格</h2><h3 id="3-1-REST简介"><a href="#3-1-REST简介" class="headerlink" title="3.1 REST简介"></a>3.1 REST简介</h3><blockquote><p>REST(Representational State Transfer)：表现形式状态转换</p><ul><li><p>传统风格资源描述形式</p><ul><li><code>http://localhost:8888/user/getById?id=1</code></li><li><code>http://localhost:8888/user/saveUser</code></li></ul></li><li><p>REST风格描述形式</p><ul><li><code>http://localhost:8888/user/1</code></li><li><code>http://localhost:8888/user</code></li></ul></li></ul><p>优点：</p><ul><li>隐藏资源的访问行为，无法通过地址得知对资源是如何操作</li><li>书写简化</li></ul></blockquote><blockquote><p>按照REST风格访问资源时使用行为动作区分对资源进行了何种操作</p><ul><li><p><code>http://localhost:8888/users</code>            查询全部用户信息(get)</p></li><li><p><code>http://localhost:8888/users/1</code>        查询指定用户信息(post)</p></li><li><p><code>http://localhost:8888/users</code>            添加用户信息(post)</p></li><li><p><code>http://localhost:8888/users</code>            修改用户信息(put)</p></li><li><p><code>http://localhost:8888/users/1</code>        删除用户信息(delete)</p></li></ul><p>描述模块的名称通常使用复数，也就是加<code>s</code>的格式描述，表示此类资源，而非单个资源。</p><ul><li>例如：users、books….</li></ul><p>根据REST风格对资源进行访问称为<span style="color:red">RESTFul</span></p></blockquote><h3 id="3-2-REST入门"><a href="#3-2-REST入门" class="headerlink" title="3.2 REST入门"></a>3.2 REST入门</h3><p><code>@RequestMapping</code>注解中<code>method</code>属性可以设定http请求地址，例如：GET、POST、PUT、DELETE…</p><p><code>@PathVariable</code>注解：绑定路径参数与处理器方法形参间的关系，要求路径参数名与形参名一一对应</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/users&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;save~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;save success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/users&quot;, method = RequestMethod.PUT)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">update</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;update~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;update success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/users/&#123;id&#125;&quot;, method = RequestMethod.DELETE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123; <span class="comment">//路径变量</span></span><br><span class="line">        System.out.println(<span class="string">&quot;delete~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;delete success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/users&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAll</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getAll~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;getAll success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/users/&#123;id&#125;&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getById~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;getById success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>@RequestBody</code> <code>@RequestParam</code> <code>@PathVariable</code></strong></p><blockquote><p>区别</p><ul><li><p><code>@RequestParam</code>用于接收url地址传参或表单传参</p></li><li><p><code>@RequestBody</code>用于接收json数据</p></li><li><p><code>@PathVariab1e</code>用于接收路径参数, 使用{参数名称}描述路径参数</p></li></ul><p>应用</p><ul><li><p>后期开发中，发送请求参数超过1个时，以json格式为主, <code>@RequestBody</code>应用较广</p></li><li><p>如果发送非json格式数据 ,选用<code>@RequestParam</code>接收请求参数</p></li><li><p>采用RESTful进行开发，当参数数量较少时，例如1个， 可以采用<code>@PathVariable</code>接收请求路径变量，通常用于传递id值</p></li></ul></blockquote><h3 id="3-3-REST快速开发"><a href="#3-3-REST快速开发" class="headerlink" title="3.3 REST快速开发"></a>3.3 REST快速开发</h3><p><code>@ResponseBody</code>：</p><ul><li>设置当前控制器类为RESTful风格，等同于<code>@Controller</code>与<code>@ResponseBody</code>两个注解组合功能</li></ul><p>标准请求动作映射：</p><ul><li><p><code>@GetMapping</code>：对应GET请求</p></li><li><p><code>@PostMapping</code>：对应POST请求</p></li><li><p><code>@PutMapping</code>：对应PUT请求</p></li><li><p><code>@DeleteMapping</code>：对应DELETE请求</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@ResponseBody + @Controller ==&gt; @RestController</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;save~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;save success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">update</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;update~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;update success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123; <span class="comment">//路径变量</span></span><br><span class="line">        System.out.println(<span class="string">&quot;delete~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;delete success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAll</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getAll~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;getAll success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getById~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;getById success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="4-SSM整合"><a href="#4-SSM整合" class="headerlink" title="4.SSM整合"></a>4.SSM整合</h2><h2 id="5-拦截器"><a href="#5-拦截器" class="headerlink" title="5.拦截器"></a>5.拦截器</h2><h3 id="5-1-拦截器的概念"><a href="#5-1-拦截器的概念" class="headerlink" title="5.1 拦截器的概念"></a>5.1 拦截器的概念</h3><blockquote><p>拦截器(Interceptor)是一种动态拦截方法调用的机制，再SpringMVC中动态拦截控制器方法的执行</p><p>作用：</p><ul><li><p>在指定的方法调用前后执行预先设定的代码</p></li><li><p>阻止原始方法的执行</p></li></ul></blockquote><p>拦截器与过滤器的区别：</p><blockquote><p>归属不同：Filter属于Servlet技术，Interceptor属于SpringMVC技术</p><p>拦截内容不同：Filter对所有访问进行数据增强，Interceptor仅针对SpringMVC的访问进行增强</p></blockquote><h3 id="5-2-拦截器入门"><a href="#5-2-拦截器入门" class="headerlink" title="5.2 拦截器入门"></a>5.2 拦截器入门</h3><blockquote><ol><li><p>制作拦截器功能类</p></li><li><p>配置拦截器的执行位置</p></li></ol></blockquote><p>项目结构：</p><img src="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220706220216540.png" class="lazyload" data-srcset="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220706220216540.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220706220216540" style="zoom:67%;" /><p>ProjectInterceptor：</p><p>此时<code>preHandle</code>方法的返回值为<code>true</code>：执行请求的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProjectInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;preHandle~~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;postHandle~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterCompletion~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SpringMvcSupport：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMvcSupport</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProjectInterceptor projectInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(projectInterceptor).addPathPatterns(<span class="string">&quot;/users&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SpringMvcConfig中添加扫描路径”com.springmvc.config”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.springmvc.controller&quot;,&quot;com.springmvc.config&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMvcConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserController：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;save~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;save success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">update</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;update~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;update success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123; <span class="comment">//路径变量</span></span><br><span class="line">        System.out.println(<span class="string">&quot;delete~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;delete success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAll</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getAll~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;getAll success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getById~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;getById success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220706220756908.png" class="lazyload" data-srcset="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220706220756908.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220706220756908" style="zoom:67%;" /><p>页面展示：</p><blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getAll success</span><br></pre></td></tr></table></figure></blockquote><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">preHandle~~~</span><br><span class="line">getAll~~</span><br><span class="line">postHandle~~~</span><br><span class="line">afterCompletion~~~</span><br></pre></td></tr></table></figure></blockquote><p>如果<code>preHandle</code>方法的返回值为<code>false</code>：不会执行请求的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProjectInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;preHandle~~~&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;postHandle~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterCompletion~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/07/06/7Bo9Guw6TZtga2C.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/06/7Bo9Guw6TZtga2C.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220706221253148" style="zoom:67%;" /><p>页面无内容，被拦截</p><p>控制台打印：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preHandle~~~</span><br></pre></td></tr></table></figure><p>所以可以通过if语句进行某种判断，返回<code>true</code>或<code>false</code>，来是否执行请求的方法</p><h3 id="5-3-拦截器参数"><a href="#5-3-拦截器参数" class="headerlink" title="5.3 拦截器参数"></a>5.3 拦截器参数</h3><p>前置处理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                         HttpServletResponse response, </span></span><br><span class="line"><span class="params">                         Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;preHandle~~~&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>参数：</p><ul><li>request：请求对象</li></ul><ul><li>response：响应对象</li></ul><ul><li>handle：被调用的处理器对象，本质为一个方法对象，对反射技术中的Method对象进行了再包装</li></ul><p>返回值：</p><ul><li><p>返回值为false，被拦截的处理将不执行</p></li><li><p>返回值为true，被拦截的处理将会执行</p></li></ul></blockquote><p>后置处理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                       HttpServletResponse response, </span></span><br><span class="line"><span class="params">                       Object handler, </span></span><br><span class="line"><span class="params">                       ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;postHandle~~~&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>参数：</p><ul><li>modelAndView：如果处理器执行完成具有返回结果，可以读取到对应数据与页面信息，并进行调整(了解即可)</li></ul></blockquote><p>完成后处理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                            HttpServletResponse response, </span></span><br><span class="line"><span class="params">                            Object handler, </span></span><br><span class="line"><span class="params">                            Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;afterCompletion~~~&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>参数：</p><ul><li>ex：如果处理执行过程中出现异常对象，可以针对异常情况进行单独处理(了解即可)</li></ul></blockquote><h3 id="5-4-拦截器链配置-了解"><a href="#5-4-拦截器链配置-了解" class="headerlink" title="5.4 拦截器链配置(了解)"></a>5.4 拦截器链配置(了解)</h3><blockquote><p>当配置多个拦截器时，形成拦截链</p><p>拦截器链的运行顺序：</p><ul><li>preHandle：与配置顺序相同，必定运行</li><li>postHandle：与配置顺序相反，可能不运行</li><li>afterCompletion：与配置顺序相反，可能不运行</li></ul><p>但拦截器出现对原始处理器的拦截，后面的拦截器均终止运行</p><p>当拦截器运行中断，仅运行配置再前面的拦截器的<code>afterCompletion</code>操作</p><p>通常开发项目时，很少会用到拦截器链，一般一个拦截器就可以解决问题</p></blockquote><p>按照1、2、3的顺序配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMvcSupport</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProjectInterceptor1 projectInterceptor1;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProjectInterceptor2 projectInterceptor2;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProjectInterceptor3 projectInterceptor3;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(projectInterceptor1).addPathPatterns(<span class="string">&quot;/users&quot;</span>);</span><br><span class="line">        registry.addInterceptor(projectInterceptor2).addPathPatterns(<span class="string">&quot;/users&quot;</span>);</span><br><span class="line">        registry.addInterceptor(projectInterceptor3).addPathPatterns(<span class="string">&quot;/users&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>全部的<code>preHandle</code>方法返回值都为<code>true</code>：</li></ul><pre class="mermaid">graph LR;    pre1-->pre2-->pre3-->c(controller)-->post3-->post2-->post1-->after3-->after2-->after1;</pre><ul><li>3的<code>preHandle</code>方法返回值为false：</li></ul><pre class="mermaid">graph LR;    pre1-->pre2-->pre3-->after2-->after1;</pre><ul><li>2的<code>preHandle</code>方法返回值为false：</li></ul><pre class="mermaid">graph LR;    pre1-->pre2-->after1;</pre><ul><li>1的<code>preHandle</code>方法返回值为false：</li></ul><pre class="mermaid">graph LR;    pre1;</pre></div>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 框架 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloud框架的学习笔记</title>
      <link href="/2022/08/06/Java/SpringCloud%E6%A1%86%E6%9E%B6/"/>
      <url>/2022/08/06/Java/SpringCloud%E6%A1%86%E6%9E%B6/</url>
      
        <content type="html"><![CDATA[<p>微服务技术栈：</p><img src="https://s2.loli.net/2022/08/06/B7LsSzUhuZjyKDQ.png" class="lazyload" data-srcset="https://s2.loli.net/2022/08/06/B7LsSzUhuZjyKDQ.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="IMG_2719" style="zoom:120%;" /><img src="https://s2.loli.net/2022/08/14/rhAQoPUmKETVqlD.png" class="lazyload" data-srcset="https://s2.loli.net/2022/08/14/rhAQoPUmKETVqlD.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220814132340938.png" style="zoom: 50%;" /><h1 id="实用篇"><a href="#实用篇" class="headerlink" title="实用篇"></a>实用篇</h1><div class="story post-story"><h2 id="1-微服务治理"><a href="#1-微服务治理" class="headerlink" title="1.微服务治理"></a>1.微服务治理</h2><h3 id="1-1-认识微服务"><a href="#1-1-认识微服务" class="headerlink" title="1.1 认识微服务"></a>1.1 认识微服务</h3><p><strong>单体架构</strong>：</p><blockquote><p>单体架构：将业务的所有功能集中在一个项目开发，打成一个包部署</p><p>优点：</p><ul><li>架构简单</li><li>部署成本低</li></ul><p>缺点：</p><ul><li>耦合度高</li></ul><p>特点：</p><ul><li>简单方便、高度耦合、拓展性差、适合小型项目</li></ul></blockquote><p><strong>分布式架构</strong>：</p><blockquote><p>分布式架构：根据业务功能对系统进行拆分，每个业务模块作为独立项目开发，称为一个服务</p><p>优点：</p><ul><li>降低服务耦合</li><li>有利于服务升级拓展</li></ul><p>分布式架构所要考虑的问题：</p><ul><li>服务拆分粒度如何？</li><li>服务集群地址如何维护？</li><li>服务之间如何实现远程调用？</li><li>服务健康状态如何感知？</li></ul><p>特点：</p><p>松耦合、拓展性好，但架构复杂、难度大，适合大型互联网项目</p></blockquote><p><strong>微服务特点</strong>：</p><blockquote><p>微服务是一种经过良好架构设计的<strong>分布式</strong>架构</p><p>微服务架构特征：</p><ul><li><p>单一职责：</p><p>微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责，避免单一职责，避免重复开发</p></li><li><p>面向服务：</p><p>微服务对外暴露业务接口</p></li><li><p>自治：</p><p>团队独立、技术独立、数据独立、部署独立</p></li><li><p>隔离性强：</p><p>服务调用做好隔离、容错、降级、避免出现级联问题</p></li></ul><p>优点：</p><ul><li>拆分粒度更小、服务更独立、耦合度更低</li></ul><p>缺点：</p><ul><li>架构非常复杂、运维、监控、部署难度更高</li></ul></blockquote><p><strong>微服务技术</strong>：</p><p>微服务这种方案需要技术落地，全球的互联网公司都在积极尝试自己的微服务落地技术</p><p>在国内最知名的就是<strong>SpringCloud</strong>和<strong>阿里巴巴的Dubbo</strong></p><p><strong>微服务技术对比</strong>：</p><table><thead><tr><th align="center"></th><th align="center">Dubbo</th><th align="center">SpringCloud</th><th align="center">SpringCloudAlibaba</th></tr></thead><tbody><tr><td align="center">注册中心</td><td align="center">zookeeper、Redis</td><td align="center">Eureka、Consul</td><td align="center">Nacos、Eureka</td></tr><tr><td align="center">服务远程调用</td><td align="center">Dubbo协议(RFC协议)</td><td align="center">Feign(http协议)</td><td align="center">Dubbo、Feign</td></tr><tr><td align="center">配置中心</td><td align="center">无</td><td align="center">SpringCloudConfig</td><td align="center">SpringCloudConfig、Nacos</td></tr><tr><td align="center">服务网关</td><td align="center">无</td><td align="center">SpringCloudGateway、Zuul</td><td align="center">SpringCloudGatway、Zuul</td></tr><tr><td align="center">服务监控和保护</td><td align="center">dubbo-admin(功能弱)</td><td align="center">Hystrix</td><td align="center">Sentinel</td></tr></tbody></table><p><strong>企业需求</strong>：</p><blockquote><ul><li><p><strong>SpringCloud+Feign</strong></p><ul><li>使用SpringCloud技术栈</li><li>服务接口采用Restful风格</li><li>服务调用采用Feign方式</li></ul></li><li><p><strong>SpringCloudAlibaba+Feign</strong></p><ul><li>使用SpringCloudAlibaba技术栈</li><li>服务接口采用Restful风格</li><li>服务调用采用Feign方式</li></ul></li><li><p><strong>SpringCloudAlibaba+Dubbo</strong></p><ul><li>使用SpringCloudAlibaba技术栈</li><li>服务接口采用Dubbo协议标准</li><li>服务调用采用Dubbo方式</li></ul></li><li><p><strong>Dubbo原始模式</strong></p><ul><li>基于Dubbo老旧技术体系</li><li>服务接口采用Dubbo协议标准</li><li>服务调用采用Dubbo方式</li></ul></li></ul></blockquote><p><strong>SpringCloud</strong>：</p><blockquote><p><a href="https://spring.io/projects/spring-cloud">SpringCloud</a>是目前国内使用最广泛的微服务框架</p><p>SpringCloud集成了各种微服务功能组件，并基于SpringBoot实现了这些组件的<strong>自动装配</strong>，从而提供了良好的开箱即用体验：</p><img src="https://s2.loli.net/2022/08/14/3VfGQYtvF6BMy7w.png" class="lazyload" data-srcset="https://s2.loli.net/2022/08/14/3VfGQYtvF6BMy7w.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220814144726965" style="zoom: 67%;" /><p>SpringCloud与SpringBoot的存在版本兼容关系</p><p><strong>本次学习采用的版本为 Hoxton.SR10，因此对应的SpringBoot版本为2.3.x版本</strong></p></blockquote><h3 id="1-2-分布式服务架构案例"><a href="#1-2-分布式服务架构案例" class="headerlink" title="1.2 分布式服务架构案例"></a>1.2 分布式服务架构案例</h3><p>服务拆分注意事项：</p><blockquote><ol><li>不同微服务，不要重复开发相同业务</li><li>微服务数据独立，不要访问其他微服务的数据库</li><li>微服务可以将自己的业务暴露为接口，供其他的服务调用</li></ol></blockquote><h3 id="1-3-服务拆分"><a href="#1-3-服务拆分" class="headerlink" title="1.3 服务拆分"></a>1.3 服务拆分</h3><p>服务拆分注意事项：</p><blockquote><p>1.不同微服务，不要重复开发相同业务</p><p>2.微服务数据独立，不要访问其它微服务的数据库</p><p>3.微服务可以将自己的业务暴露为接口，供其他微服务调用</p></blockquote><p>案例：根据订单id查询订单功能</p><p>需求：根据订单id查询订单的同时，把订单所属的用户信息一起返回</p><p>查询订单信息：<code>http://localhost:8080/order/101</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">101</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">699900</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Apple 苹果 iPhone 12 &quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;num&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span><span class="keyword">null</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>user信息为<code>null</code>，我们需要在查询订单信息的同时，也可以获得订单所属用户信息</p><p>我们可以调用user服务的接口</p><p>在<code>order-service</code>服务的<code>OrderApplication</code>中注册<code>RestTemplate</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan(&quot;cn.itcast.order.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建RestTemplate对象并注入Spring容器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>OrderService</code>中添加http请求：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">queryOrderById</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.查询订单</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderMapper.findById(orderId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2.利用restTemplate向user服务发送http请求</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8081/user/&quot;</span> + order.getUserId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> restTemplate.getForObject(url, User.class);</span><br><span class="line">        order.setUser(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.返回</span></span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新查询订单信息：<code>http://localhost:8080/order/101</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">101</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">699900</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Apple 苹果 iPhone 12 &quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;num&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;柳岩&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span><span class="string">&quot;湖南省衡阳市&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>成功获得user信息！</p></div><div class="story post-story"><h2 id="3-Eureka"><a href="#3-Eureka" class="headerlink" title="3.Eureka"></a>3.Eureka</h2><h3 id="3-1-提供者与消费者"><a href="#3-1-提供者与消费者" class="headerlink" title="3.1 提供者与消费者"></a>3.1 提供者与消费者</h3><blockquote><ul><li><p>服务提供者：一次业务，被其他微服务调用的服务(提供接口给其他微服务)</p></li><li><p>服务消费者：一次业务，调用其他微服务的服务(调用其他微服务提供的接口)</p></li><li><p>服务A调用了服务B，服务B又调用服务C，服务B属于什么？</p><p>相对于A，就是消费者；相对于C，就是提供者</p></li><li><p>提供者与消费者其实是相对的</p></li></ul></blockquote><h3 id="3-2-Eureka原理分析"><a href="#3-2-Eureka原理分析" class="headerlink" title="3.2 Eureka原理分析"></a>3.2 Eureka原理分析</h3><p>在<code>OrderService</code>中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8081/user/&quot;</span> + order.getUserId();</span><br></pre></td></tr></table></figure><blockquote><p>如果每次更改服务端口，都需要重新修改代码吗？</p><p>如果有多个user服务实例，但是总是调用一个端口，其余的user服务怎么办？</p><p>服务消费者该如何获取服务提供者的地址信息呢？</p><p>如果有多个服务提供者，消费者该如何选择呢？</p><p>消费者如何得到服务提供者的健康状态呢？</p></blockquote><p>Eureka的作用：</p><img src="https://s2.loli.net/2022/09/08/iYx7WsSwfJoT1nd.png" class="lazyload" data-srcset="https://s2.loli.net/2022/09/08/iYx7WsSwfJoT1nd.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220908104127361.png" style="zoom: 67%;" /><blockquote><ul><li>服务消费者该如何获取服务提供者的地址信息呢？</li></ul><p> 服务提供者启动时间向Eureka注册自己的信息</p><p> Eureka保存这些信息</p><p> 消费者根据服务名称向Eureka拉取提供者信息</p><ul><li>如果有多个服务提供者，消费者该如何选择呢？</li></ul><p> 服务消费者利用负载均衡算法，从服务列表中挑选一个</p><ul><li>消费者如何得到服务提供者的健康状态呢？</li></ul><p> 服务提供者会每隔30秒向EurekaServer发送心跳请求，报告健康状况</p><p> Eureka会更新记录服务列表信息，心跳不会正常会被踢出</p><p> 消费者就可以拉取到最新的信息</p></blockquote><p>在Eureka架构中，微服务角色有两类：</p><ul><li>EurekaServer：服务端，注册中心<ul><li>记录服务信息</li><li>心跳监控</li></ul></li><li>EurekaClient： 客户端<ul><li>provider：服务提供省，例如案例中的 user-service<ul><li>注册自己的信息到EurekaServer</li><li>每隔30秒向Eureka Server发送心跳</li></ul></li><li>consumer：服务消费者，例如案例中的 order-service<ul><li>根据服务名称从Eurekaserver拉取服务列表</li><li>基于服务列表做负载均衡，选中一个微服务后发起远程调用</li></ul></li></ul></li></ul><h3 id="3-3-搭建Eureka服务"><a href="#3-3-搭建Eureka服务" class="headerlink" title="3.3 搭建Eureka服务"></a>3.3 搭建Eureka服务</h3><ol><li><p>创建项目，引入<code>spring-cloud-starter-netflix-eureka-server</code>依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>编写启动类，添加<code>@EnableEurekaServer</code>注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>添加<code>applcation.yaml</code>文件，配置信息：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10086</span> <span class="comment">#服务端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaserver</span> <span class="comment">#eureka的服务名称</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="comment">#eureka的地址信息</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="3-4-服务注册"><a href="#3-4-服务注册" class="headerlink" title="3.4 服务注册"></a>3.4 服务注册</h3><p>注册user-service服务注册到EurekaServer：</p><ol><li><p>在user-service项目引入spring-cloud-starter-netflix-eureka-client的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在<code>application.yaml</code>文件，添加下面的配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">userservice</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:10086/eureka</span></span><br></pre></td></tr></table></figure></li></ol><p>注册多个<code>user-service</code>服务：</p><p>在idea中，找到user-service服务，右键选择复制配置：</p><img src="https://s2.loli.net/2022/09/08/T7Ox6X4u9IfHiBV.png" class="lazyload" data-srcset="https://s2.loli.net/2022/09/08/T7Ox6X4u9IfHiBV.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="2022-09-08.png" style="zoom: 67%;" /><p>第一个user-service服务的端口为8081，</p><p>我将第二个user-service服务的端口设置为8082(可随意设置，但不要使用占用的端口)</p><img src="https://s2.loli.net/2022/09/08/efqK5jOJ7CDnTH1.png" class="lazyload" data-srcset="https://s2.loli.net/2022/09/08/efqK5jOJ7CDnTH1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220908223721561.png" style="zoom:50%;" /><h3 id="3-5-服务发现"><a href="#3-5-服务发现" class="headerlink" title="3.5 服务发现"></a>3.5 服务发现</h3><p><strong>在order-service完成服务拉取</strong></p><p>服务拉取基于服务名称获取服务列表，然后在对服务列表做负载均衡</p><ol><li><p>修改OrderService的代码，修改访问的url路径，用服务名替代ip、端口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://userservice/user/&quot;</span> + order.getUserId();</span><br></pre></td></tr></table></figure><p>完整代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">queryOrderById</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.查询订单</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderMapper.findById(orderId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//利用restTemplate向user服务发送http请求</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://userservice/user/&quot;</span> + order.getUserId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> restTemplate.getForObject(url, User.class);</span><br><span class="line">        order.setUser(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.返回</span></span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在order-service项目的启动类<code>OrderApplication</code>中<code>RestTemplate</code>添加<strong>负载均衡</strong>注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span> <span class="comment">//负载均衡注解</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完整代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan(&quot;cn.itcast.order.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="3-6-总结"><a href="#3-6-总结" class="headerlink" title="3.6 总结"></a>3.6 总结</h3><blockquote><ol><li>搭建<code>EurekaServer</code>注册中心<ul><li>引入eureka-server依赖</li><li>添加<code>@EnableEurekaServer</code>注解</li><li>在<code>application.yaml</code>中配置<code>eureka</code>地址</li></ul></li><li>服务注册<ul><li>引入eureka-client依赖</li><li>在<code>application.yaml</code>中添加<code>eureka</code>地址</li></ul></li><li>服务发现<ul><li>引入eureka-client依赖</li><li>在<code>application.yaml</code>中添加<code>eureka</code>地址</li><li>给<code>RestTemplate</code>配置bean中添加<code>@LoadBalanced</code>注解</li><li>用服务提供者在eureka注册的服务名称远程调用</li></ul></li></ol></blockquote></div><div class="story post-story"><h2 id="4-Ribbon"><a href="#4-Ribbon" class="headerlink" title="4.Ribbon"></a>4.Ribbon</h2><h3 id="4-1-负载均衡原理"><a href="#4-1-负载均衡原理" class="headerlink" title="4.1 负载均衡原理"></a>4.1 负载均衡原理</h3><p>负载均衡流程：</p><pre class="mermaid">graph LRA[order-service]B{Ribbon负载均衡}C(eureka-service)D[user-service:8081]E[user-service:8082]A--1.发起请求<br>http://userservice/user/1-->BB--2.拉取<br>userservice-->CC--3.返回服务列表<br>localhost:8081<br>localhost:8082-->BB--4.轮询到8081-->DB-->E</pre><p>负载均衡原理：</p><pre class="mermaid">graph LRA[order-service]B[RibbonLoadBalancerClient]C[DynamicServerListLoadBalancer]D(eureka-service)E[IRule]F[user-service:8081]G[user-service:8082]A--1.发起请求<br>http://userservice/user/1-->BC--3.拉取<br>userservice-->DD--4.返回服务列表<br>localhost:8081<br>localhost:8082-->Csubgraph LoadBalancerInterceptor负载均衡拦截器      B--2.获取url中的服务id<br>userservice-->C    C--5.服务负载均衡<br>localhost:8081<br>localhost:8082-->E    E--6.选择某个服务<br>localhost:8081-->B endsubgraph 请求      B-->F    B-.->G end</pre><h3 id="4-2-负载均衡策略-IRule"><a href="#4-2-负载均衡策略-IRule" class="headerlink" title="4.2 负载均衡策略(IRule)"></a>4.2 负载均衡策略(IRule)</h3><p>Ribbon的负载均衡是一个叫做IRule的接口来定义的，每一个子接口都是一种规则：</p><pre class="mermaid">classDiagram      IRule <|-- AbstractLoadBalancerRule      AbstractLoadBalancerRule <|-- RetryRule      AbstractLoadBalancerRule <|-- ClientConfigEnabledRobinRule      AbstractLoadBalancerRule <|-- RundRobinRule      AbstractLoadBalancerRule <|-- RandomRule      ClientConfigEnabledRobinRule <|-- BestAvailabeRule      ClientConfigEnabledRobinRule <|-- PredicateBaseRule      RundRobinRule <|-- WeightedResponseTimeRule      PredicateBaseRule <|-- AvailablityFilteringRule      PredicateBaseRule <|-- ZoneAvoidanceRule</pre><table><thead><tr><th align="center">内置负载均衡规则类</th><th>规则描述</th></tr></thead><tbody><tr><td align="center">RoundRobinRule</td><td>简单轮询服务列表来选择服务器。它是Ribbon默认的负载均衡规则。</td></tr><tr><td align="center">AvailabilityFilteringRule</td><td>对以下两种服务器进行忽略：<br/>(1) 在默认情况下，这台服务器如果3次连接失败，这台服务器就会被设置为 “短路”状态。短路状态将持续30秒，如果再次连接失败，短路的持续时间就会几何级地增加。<br/>(2) 并发数过高的服务器。如果一个服务器的并发连接数过高，配置了<code>AvailabilityFilteringRule</code>规则的客户端也会将其忽路。并发连接数的上限，可以由客户端的<br/><code>&lt;clientName&gt;.&lt;sclientConfigNamespace&gt;.ActiveConnectionsLimit</code>属性进行配置。</td></tr><tr><td align="center">WeightedResponseTimeRule</td><td>为每一个服务器赋子一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。</td></tr><tr><td align="center"><span style="color:red">ZoneAvoidanceRule</span></td><td>以区域可用的服务器为基础进行服务器的选择。使用Zone对服务器进行分类，这个Zone可以理解为机房、一个机架等。而后再对Zone内的多个服务做轮询。</td></tr><tr><td align="center">BestAvailabeRule</td><td>忽略哪些短路的服务器，并选择并发数较低的服务器。</td></tr><tr><td align="center">RandomRule</td><td>随机选择一个可用的服务器。</td></tr><tr><td align="center">RetryRule</td><td>重试机制的选择逻辑。</td></tr></tbody></table><p>修改负载均衡规则：</p><p>通过定义<code>IRule</code>实现可以修改负载均衡规则，有两种方式：</p><ol><li><p>代码方式：在<code>order-service</code>中的<code>OrderApplication</code>类或者新建一个配置类中，定义一个新的<code>IRule</code>：</p><p>此方式是作用全局请求的所有的服务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> IRule <span class="title function_">randomRule</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置文件方式：在<code>order-service</code>中的application.yaml文件中，添加新的配置信息也可以修改规则：</p><p>此方式可以指定<code>user-service</code>服务的负载均衡规则</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">userservice:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RondomRule</span> <span class="comment">#负载均衡规则</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="4-3-饥饿加载"><a href="#4-3-饥饿加载" class="headerlink" title="4.3 饥饿加载"></a>4.3 饥饿加载</h3><p>Ribbon默认采用懒加载，即第一次访问才会去创建LoadBalanceClient，请求时间较长</p><p>而饥饿加载会在项目启动时创建，降低第一次访问的耗时</p><p>可以通过下面配置开启饥饿加载：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eager-load:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>        <span class="comment">#开启饥饿加载</span></span><br><span class="line">    <span class="attr">clients:</span> <span class="string">userservice</span> <span class="comment">#指定对userservice这个服务饥饿加载，可以指定多个服务用 -XXXservice </span></span><br></pre></td></tr></table></figure><h3 id="4-4-总结"><a href="#4-4-总结" class="headerlink" title="4.4 总结"></a>4.4 总结</h3><blockquote><ol><li><p>Ribbon负载均衡规则</p><ul><li><p>规则接口是IRule</p></li><li><p>默认实现是ZoneAvoidanceRule，根据zone选择服务列表，然后轮询</p></li></ul></li><li><p>负载均衡自定义方式</p><ul><li>代码方式：配置灵活，但修改时需要重新打包发布</li><li>配置方式：直观，方便，无需重新打包发布，但是无法做全局配置</li></ul></li><li><p>饥饿加载</p><ul><li><p>Ribbon默认采用懒加载</p></li><li><p>开启饥饿加载</p></li><li><p>指定饥饿加载的微服务名称</p></li></ul></li></ol></blockquote></div><div class="story post-story"><h2 id="5-Nacos"><a href="#5-Nacos" class="headerlink" title="5.Nacos"></a>5.Nacos</h2><p><code>Nacos</code>是阿里巴巴的产品，现在是<code>SpringCloud</code>中的一个组件，相比<code>Eureka</code>功能更加丰富，在国内受欢迎程度较高</p><h3 id="5-1-快速入门"><a href="#5-1-快速入门" class="headerlink" title="5.1 快速入门"></a>5.1 快速入门</h3><p>服务注册到Nacos</p><ol><li><p>在cloud-demo父工程添加spring-cloud-alibaba的管理依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>注释掉order-service和user-service中的eureka依赖(pom以及配置信息)</p></li><li><p>添加nacos的客户端依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在application.yaml中配置user-service服务的Nacos信息：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">userservice</span> <span class="comment">#user-service服务名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">主机地址ip:8848</span> <span class="comment">#nacos服务地址</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="5-2-服务多级存储模型"><a href="#5-2-服务多级存储模型" class="headerlink" title="5.2 服务多级存储模型"></a>5.2 服务多级存储模型</h3><pre class="mermaid">graph TBA[服务]B(集群1)C(集群2)D(集群3)E(实例1)F(实例2)G(实例3)H(实例4)I(实例5)J(实例6)A-.-CA-.-BA-.-Dsubgraph 北京    B-->E    B-->Fendsubgraph 上海<br>例如:实例3userserivce端口为8083<br><br>    C-->G    C-->Hendsubgraph 杭州<br>例如:实例5userserivce端口为8081<br>例如:实例6userserivce端口为8082<br><br><br>    D-->I    D-->Jend</pre><p>服务调用要尽可能选择本地集群的服务，跨集群调用延迟较高</p><p>当本地集群不可访问时，才去访问其他集群</p><p>服务集群属性：</p><ol><li><p>修改appliaction.yaml，添加下面内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">cluster-name:</span> <span class="string">HZ</span> <span class="comment">#自定义集群名称，HZ为杭州</span></span><br></pre></td></tr></table></figure></li><li><p>先将启动user-service1和user-service2，注意不要停止运行这两个服务</p><p>再复制一个配置叫做user-service3，将<code>cluster-name</code>属性改为<code>SH</code>(上海)，启动服务</p></li><li><p>在Nacos控制台可以看到集群变化：</p><p>可以看到有两个集群<code>HZ</code>和<code>SH</code></p></li></ol><p>总结：</p><ol><li><p>Nacos服务分级存储模型</p><ul><li>一级为服务，例如userservice</li><li>二级为集群，例如杭州或上海</li><li>三级为实例，例如杭州机房的某台部署了userservice的服务器</li></ul></li><li><p>如何设置实例的集群属性</p><p>修改<code>application.yaml</code>文件中的<code>spring.cloud.discover.cluster-name</code>属性</p></li></ol><h3 id="5-3-NacosRule负载均衡"><a href="#5-3-NacosRule负载均衡" class="headerlink" title="5.3 NacosRule负载均衡"></a>5.3 NacosRule负载均衡</h3><p>根据集群负载均衡：</p><ol><li><p>修改order-service中的application.yaml，设置集群为HZ：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        cluster-name: HZ #自定义集群名称，HZ为杭州</span><br></pre></td></tr></table></figure></li><li><p>在order-service中设置负载均衡的Rule为NacosRule：</p><p>此规则会默认寻找与自己同集群的服务，未找到才寻找其他集群</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">userservice:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.alibaba.cloud.nacos.ribbon.NacosRule</span> <span class="comment">#负载均衡规则</span></span><br></pre></td></tr></table></figure></li></ol><p>总结：</p><ol><li>NacosRule负载均衡策略<ul><li>优先选择同集群服务实例列表</li><li>未找到本地集群，才会寻找其他集群，并会警告</li><li>确定了可用实例列表后，再采用随机负载均衡挑选实例</li></ul></li></ol><h3 id="5-4-服务实例的权重"><a href="#5-4-服务实例的权重" class="headerlink" title="5.4 服务实例的权重"></a>5.4 服务实例的权重</h3><p>根据权重负载均衡：</p><p>实际部署会出现这样的场景：</p><ul><li>服务设备性能有差异，部分实例所在机器性能较好，而另一些较差，我们希望性能好的机器能承担更多的用户请求</li></ul><p>Nacos提供了权重配置来控制访问频率，权重越大则访问频率越高</p><ol><li><p>在Nacos控制台可以设置实例的权重值，首先选中实例后面的编辑</p><p><img src="https://s2.loli.net/2022/09/11/ykx57jlZXweRUuo.png" class="lazyload" data-srcset="https://s2.loli.net/2022/09/11/ykx57jlZXweRUuo.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220910224808085.png"></p></li><li><p>将权重设置为0.1，测试可以发现8081端口被访问的频率大大降低</p><img src="https://s2.loli.net/2022/09/11/vZKcMo9FOwfYh8a.png" class="lazyload" data-srcset="https://s2.loli.net/2022/09/11/vZKcMo9FOwfYh8a.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220910225118298.png" style="zoom: 50%;" /><p>可用于灰度发布。</p></li></ol><p>总结：</p><ol><li>实例的权重控制<ul><li>Nacos控制台可以设置实例的权重值，区间在0~1之间</li><li>同集群内的多个实例，权重越高被访问的频率越高</li><li>权重设置为0，则完全不会被访问</li></ul></li></ol><h3 id="5-5-环境隔离"><a href="#5-5-环境隔离" class="headerlink" title="5.5 环境隔离"></a>5.5 环境隔离</h3><p>环境隔离——namespace</p><p>Nacos中服务存储和数据存储的最外层都是一个名为namespace的东西，用来做最外层隔离</p><p>层序：</p><p>Namespace( Group ( Service&#x2F;Data ) )</p><ol><li><p>在Nacos控制台选项列表点击<code>命名空间</code>，再点击<code>新建命名空间</code></p><p><img src="https://s2.loli.net/2022/09/11/Yh1KOgpN9RE8WL3.png" class="lazyload" data-srcset="https://s2.loli.net/2022/09/11/Yh1KOgpN9RE8WL3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220911103047943.png"></p></li><li><p>新建名空间设置：</p></li></ol><img src="https://s2.loli.net/2022/09/11/KJEcZMQuH8pUvSk.png" class="lazyload" data-srcset="https://s2.loli.net/2022/09/11/KJEcZMQuH8pUvSk.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220911103305781.png" style="zoom:67%;" /><ol start="3"><li><p>选择命名空间选项，找到命名空间名称为<code>dev</code>，复制其命名空间id：</p><p><img src="https://s2.loli.net/2022/09/11/aQ7b4wME3SWFIe6.png" class="lazyload" data-srcset="https://s2.loli.net/2022/09/11/aQ7b4wME3SWFIe6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220911104544560.png"></p></li><li><p>修改服务的命名空间：</p><p>修改<code>order-service</code>的<code>application.yaml</code>，添加namespace并填入上面获取的id：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">orderservice</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">f2b2f43b-d7bb-4857-8548-5595ef899fd2</span></span><br></pre></td></tr></table></figure></li><li><p>启动order-service服务，会发现出现在了dev中：</p><p><img src="https://s2.loli.net/2022/09/11/sJdbeMr3A5VlKmW.png" class="lazyload" data-srcset="https://s2.loli.net/2022/09/11/sJdbeMr3A5VlKmW.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220911105111829.png"></p></li><li><p>不做任何修改<strong>启动user-service服务</strong>后，</p><p>并访问<code>http://localhost:8080/order/101</code></p><p>order-service服务报错：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">09-<span class="number">11</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">24</span>:<span class="number">428</span> ERROR <span class="number">8788</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">1</span>] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() <span class="keyword">for</span> servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is org.mybatis.spring.MyBatisSystemException: nested exception is org.apache.ibatis.exceptions.PersistenceException: </span><br><span class="line">### Error querying database.  Cause: org.springframework.jdbc.CannotGetJdbcConnectionException: Failed to obtain JDBC Connection; nested exception is com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure</span><br></pre></td></tr></table></figure><p>userservice处于<code>public</code>中，orderservice处于<code>dev</code>中；</p><p>orderservice服务没有找到userservie服务，说明userservice服务和orderservice服务，已经被<code>隔离</code>了</p></li></ol><p>总结：</p><ol><li>Nacos环境隔离<ul><li>namespace用来做环境隔离</li><li>每个namespace都有唯一id</li><li>不同namespace下的服务不可见</li></ul></li></ol><h3 id="5-6-非临时实例"><a href="#5-6-非临时实例" class="headerlink" title="5.6 非临时实例*"></a>5.6 非临时实例*</h3><p>Nacos注册中心原理：</p><pre class="mermaid">graph BTA(nacos注册中心)B(服务消费者)C(服务提供者)C--注册服务信息-->AB-.定时拉取服务pull.->AB--远程调用-->CC-.临时实例<br>采用心跳检测.->AA-.非临时实例<br>nacos主动询问.->CA--主动推送变更信息<br>push-->B</pre><p>在nacos里创建的实例默认为临时实例</p><p>服务注册到Nacos时，可以选择注册为临时或非临时实例，通过下面的配置来设置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">orderservice</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">ephemeral:</span> <span class="literal">false</span> <span class="comment">#flase为非临时实例，默认为true临时实例</span></span><br></pre></td></tr></table></figure><p>总结：</p><ol><li>Nacos与eureka的共同点<ul><li>都支持服务注册和服务拉取</li><li>都支持服务提供者心跳方式做健康检测</li></ul></li><li>Nacos与Eureka的区别<ul><li>Nacos支持服务端<strong>主动检测提供者状态</strong>：<strong>临时实例</strong>采用<strong>心跳模式</strong>，<strong>非临时实例</strong>采用<strong>主动检测模式</strong></li><li>临时实例心跳不正常会被剔除，非临时实例则不会被剔除</li><li>Nacos支持服务列表变更的消息推送模式，服务列表更新更及时</li><li>Nacos集群默认采用AP方式，当集群中存在非临时实例时，采用CP模式；Eureka采用AP方式</li></ul></li></ol></div><div class="story post-story"><h2 id="6-Nacos配置管理"><a href="#6-Nacos配置管理" class="headerlink" title="6.Nacos配置管理"></a>6.Nacos配置管理</h2><h3 id="6-1-Nacos实现配置管理"><a href="#6-1-Nacos实现配置管理" class="headerlink" title="6.1 Nacos实现配置管理"></a>6.1 Nacos实现配置管理</h3><p>统一配置管理</p><ul><li><p>配置更改热更新：</p><img src="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220911131141255.png" class="lazyload" data-srcset="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220911131141255.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220911131141255" style="zoom:67%;" /><p>新建配置：</p><p>打开Nacos控制台，点击配置管理-&gt;配置列表，点击右边的<code>+</code> 号</p><p><img src="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220911131318760.png" class="lazyload" data-srcset="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220911131318760.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220911131318760"></p><p>填入配置：</p><ul><li>配置文件id名：[服务名称]-[profile].[后缀名]    后缀名与配置格式一致</li><li>分组：默认即可</li><li>配置格式：推荐使用yaml格式</li></ul><p>示例：</p><p><img src="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220911132734612.png" class="lazyload" data-srcset="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220911132734612.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220911132734612"></p></li><li><p>获取配置步骤：</p><pre class="mermaid">  graph LRA{项目启动}B(读取本地配置文件<br>application.yaml)C(创建Spring容器)D(加载bean)E(读取nacos中的配置文件)A--naocs地址<br>bootstrap.yaml-->EE-->B-->C-->D</pre><ol><li><p>引入Nacos的配置管理客户端依赖：</p><p>在user-service项目引入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在配置文件同级文件包中新建<code>bootstrap.yaml</code>，并删除<code>application.yaml</code>中的nacos的相关配置</p><p><code>bootstrap.yaml</code>内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">userservice</span> <span class="comment">#服务名称</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment">#环境</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">43.142</span><span class="number">.167</span><span class="number">.75</span><span class="string">:8848</span> <span class="comment">#nacos地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#文件后缀为yaml</span></span><br></pre></td></tr></table></figure></li><li><p>在UserController中，测试读取Nacos中的配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="comment">//注入nacos中的配置属性</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pattern.dateformat&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String dateformat;</span><br><span class="line"><span class="comment">//通过dateformat的时间格式，返回格式化的时间</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/now&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDateformat</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(dateformat));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>总结：</p><p>将配置交给Nacos管理的步骤：</p><ol><li>在Nacos中添加配置文件</li><li>在微服务中引入nacos的config依赖</li><li>在微服务中添加bootstrap.yml， 配置nacos地址当前环境、服务名称、文件后缀名。这些决定了程序启动时去nacos读取哪个文件</li></ol></li></ul><h3 id="6-2-配置热更新"><a href="#6-2-配置热更新" class="headerlink" title="6.2 配置热更新"></a>6.2 配置热更新</h3><p>Nacos中都配置文件变更后，微服务无需重启就可以感知。不过需要通过两种配置实现：</p><ul><li><p>方式一：在<code>@Value</code>注入的变量所在类上添加注解<code>@RefreshScope</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pattern.dateformat&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String dateformat;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/now&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDateformat</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(dateformat));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>方式二：使用<code>@ConfigurationProperties(prefix = &quot;&quot;)</code>注解</p><p>新建config包，创建<code>PatternProperties</code>类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">//交给spring管理</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;pattern&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PatternProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String dateformat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在UserController注入PatternProperties：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="comment">//注入PatternProperties</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PatternProperties patternProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/now&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDateformat</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(patternProperties.getDateformat()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>总结：</p><p>Nacos配置更改后，微服务可以实现热更新，方式如下：</p><ol><li>通过@value注解注入，结合@Refreshscope来刷新</li><li>通过@ConfiqurationProperties注入，自动刷新</li></ol><p>注意事项：</p><ul><li>不是所有的配置都适合放到配置中心，维护起来比较麻烦</li><li>建议将一些关键参数，需要运行时调整的参数放到nacos配置中心，一般都是自定义配置</li></ul><h3 id="6-3-多环境配置共享"><a href="#6-3-多环境配置共享" class="headerlink" title="6.3 多环境配置共享"></a>6.3 多环境配置共享</h3><p>微服务启动会从nacos读取多个配置文件：</p><ul><li>[spring.application.name]-[spring.profile.active].yaml，例如：userservice-dev.yaml</li><li>[spring.application.name].yaml，例如：userservice.yaml</li></ul><p>无论profile如何变化，[spring.application.name].yaml这个文件一定会加载的，因此可以多环境共享配置可以写入这个文件</p><p><img src="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220911214926009.png" class="lazyload" data-srcset="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220911214926009.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220911214926009"></p><p>多配置的优先级：</p><p>服务名-profile.yaml &gt; 服务名.yaml &gt; 本地配置</p><p>总结：</p><p>微服务会从nacos读取的配置文件：</p><ul><li>[服务名]-[spring-profile.active].yaml，环境配置</li><li>[服务名].yaml，默认配置，多环境共享</li></ul><p>优先级</p><ul><li>[服务名]-[环境].yaml &gt; [服务名].yaml＞本地配置</li></ul><h3 id="6-4-Nacos集群搭建"><a href="#6-4-Nacos集群搭建" class="headerlink" title="6.4 Nacos集群搭建"></a>6.4 Nacos集群搭建</h3><p>Nacos生产环境下一定要部署为集群状态</p><pre class="mermaid">graph TBA(Nacos<br>client)B[Nginx]C(Nacos<br>node1)D(Nacos<br>node2)E(Nacos<br>node3)F[(MySQL<br>主)]G[(MySQL<br>从)]H[(MySQL<br>从)]A-->BB-->C-->FB-->D-->FB-->E-->Fsubgraph .    F-.-G    F-.-Hend</pre></div><div class="story post-story"><h2 id="7-Feign"><a href="#7-Feign" class="headerlink" title="7.Feign"></a>7.Feign</h2><h3 id="7-1-远程调用"><a href="#7-1-远程调用" class="headerlink" title="7.1 远程调用"></a>7.1 远程调用</h3><p>RestTemplate方式存在的问题：</p><p>RestTemplate发起远程调用，示例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//利用restTemplate向user服务发送http请求</span></span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://userservice/user/&quot;</span> + order.getUserId();</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> restTemplate.getForObject(url, User.class);</span><br></pre></td></tr></table></figure><p>存在问题：</p><ul><li>代码可读性差，编程体验不统一</li><li>参数复杂，URL难以维护</li><li>不够优雅！！！</li></ul><p><strong>优雅的Feign</strong></p><p>介绍：</p><ul><li><p><a href="https://github.com/OpenFeign/feign">Feign</a>是一个声明式的http客户端。</p></li><li><p>其作用就是帮助我们优雅的实现http请求的发送，解决上面提到的问题。</p></li></ul><p>使用Feign步骤：</p><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在order-service的启动管理类添加开启Feign功能的注解<code>@EnableFeignClients</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;cn.itcast.order.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>新建clients包，包中创建<code>UserClient</code>，来编写Feign客户端：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;userservice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>使用Feign进行远程调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserClient userClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">queryOrderById</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.查询订单</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderMapper.findById(orderId);</span><br><span class="line"><span class="comment">//使用Feign远程调用</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.findById(order.getUserId());</span><br><span class="line">        order.setUser(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.返回</span></span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>总结：</p><p>Feign的使用步骤：</p><ol><li>引入依赖</li><li>添加<code>@EnableFeignClients</code>注解</li><li>编写FeignClient接口</li><li>使用FiegnClient中定义的方法代替RestTemplate</li></ol><h3 id="7-2-自定义配置"><a href="#7-2-自定义配置" class="headerlink" title="7.2 自定义配置"></a>7.2 自定义配置</h3><p>Feign运行自定义配置来覆盖默认配置，可以修改的配置如下：</p><table><thead><tr><th>类型</th><th>作用</th><th>说明</th></tr></thead><tbody><tr><td><span style="color:red">feign.Logger.Level</span></td><td>修改日志级别</td><td>包含四种不同的级别：NONE、BASIC、HEADERS、FULL</td></tr><tr><td>feign.codec.Decoder</td><td>响应结果的解析器</td><td>http远程调用的结果做解析，例如解析json字符串为java对象</td></tr><tr><td>feign.codec.Encoder</td><td>请求参数编码</td><td>将请求参数编码，便于通过http请求发送</td></tr><tr><td>feign.Contract</td><td>请求参数编码</td><td>默认是SpringMVC的注解</td></tr><tr><td>feign.Retryer</td><td>失败重试机制</td><td>请求失败的重试机制，默认是没有，不过会使用Ribbon的重试</td></tr></tbody></table><p>一般我们需要配置的就是日志级别</p><p>配置Feign日志的两种方式：</p><ul><li><p>方式一：配置文件方式</p><ul><li><p>全局生效：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span> </span><br><span class="line">      <span class="attr">default:</span> <span class="comment">#default就是全局配置，如果写的是服务名称，就是针对此服务的配置</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">FULL</span> <span class="comment">#日志级别</span></span><br></pre></td></tr></table></figure></li><li><p>局部生效</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">userservice:</span> <span class="comment">#default就是全局配置，如果写的是服务名称，就是针对此服务的配置</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">FULL</span> <span class="comment">#日志级别</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>方式二：注解方式</p><p>先声明一个Bean：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignClientConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">feignLogLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.BASIC;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>全局配置，将bean放到<code>@EnableFeignClients</code>注解中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(defaultConfiguration = FeignClientConfig.class)</span></span><br></pre></td></tr></table></figure></li><li><p>局部配置，将bean放到<code>@FeignClient</code>注解中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;userservice&quot;, configuration = FeignClientConfig.class)</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><p>总结：</p><p>Feign的日志配置：</p><ol><li>方式一是配置文件，<code>feign.client.config.xxx.loggerLevel</code><ul><li>如果xxx是default则代表全局</li><li>如果xxx是服务名称，例如<code>userservice</code>则代表某服务</li></ul></li><li>方式二是java代码配置<code>Logger.Level</code>这个Bean<ul><li>如果在<code>@EnableFeignClients</code>注解声明则代表全局</li><li>如果在<code>@FeignClient</code>注解中声明则代表某服务</li></ul></li></ol><h3 id="7-3-性能优化"><a href="#7-3-性能优化" class="headerlink" title="7.3 性能优化"></a>7.3 性能优化</h3><p>Feign底层的客户端实现：</p><ul><li>URLConnection：默认实现，不支持连接池</li><li>Apache HttpClient：支持连接池</li><li>OKHttp：支持连接池</li></ul><p>因此优化Feign的性能主要包括：</p><ul><li>使用连接池代替默认的URLConnection</li><li>日志级别，最好为basic或none</li></ul><p>Feign添加HttpClient的支持：</p><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>配置连接池：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">httpclient:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启feign对HttpClient的支持</span></span><br><span class="line">    <span class="attr">max-connections:</span> <span class="number">200</span> <span class="comment">#最大连接数</span></span><br><span class="line">    <span class="attr">max-connections-per-route:</span> <span class="number">50</span> <span class="comment">#每个路径的最大连接数</span></span><br></pre></td></tr></table></figure></li></ol><p>总结：</p><p>Feign的优化：</p><ol><li>日志级别尽量用basic</li><li>使用HttpClient或OKHttp代替URLConnection<ul><li>引入feign-httpclient依赖</li><li>配置文件开启httpClient功能，设置连接池参数</li></ul></li></ol><h3 id="7-4-最佳实践"><a href="#7-4-最佳实践" class="headerlink" title="7.4 最佳实践"></a>7.4 最佳实践</h3><p>Feign的最佳实践</p><p>方式一：继承</p><p>给消费者的FeignClient和提供者的Controller定义统一的父接口作为标准</p></div><div class="story post-story"><h2 id="2-Docker"><a href="#2-Docker" class="headerlink" title="2.Docker"></a>2.Docker</h2><h2 id="3-异步通信"><a href="#3-异步通信" class="headerlink" title="3.异步通信"></a>3.异步通信</h2><h2 id="4-分布式搜索"><a href="#4-分布式搜索" class="headerlink" title="4.分布式搜索"></a>4.分布式搜索</h2><p>0</p></div>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 框架 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot框架的学习笔记</title>
      <link href="/2022/08/06/Java/SpringBoot%E6%A1%86%E6%9E%B6/"/>
      <url>/2022/08/06/Java/SpringBoot%E6%A1%86%E6%9E%B6/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="1-热部署"><a href="#1-热部署" class="headerlink" title="1.热部署"></a>1.热部署</h2><h2 id="2-配置高级"><a href="#2-配置高级" class="headerlink" title="2.配置高级"></a>2.配置高级</h2><h3 id="2-1-自定义bean属性绑定"><a href="#2-1-自定义bean属性绑定" class="headerlink" title="2.1 自定义bean属性绑定"></a>2.1 自定义bean属性绑定</h3><p>导入<code>lombok</code>坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>application.yaml</code>配置中：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">servers:</span></span><br><span class="line">  <span class="attr">ipAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2345</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure><p><code>ServerConfig</code>类中：</p><p><code>@ConfigurationProperties</code>注解将<code>application.yaml</code>配置中的属性进行绑定</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;servers&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String ipAddress;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ServerConfig serverConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testGetServer</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(serverConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-第三方bean属性绑定"><a href="#2-2-第三方bean属性绑定" class="headerlink" title="2.2 第三方bean属性绑定"></a>2.2 第三方bean属性绑定</h3><p>导入<code>druid</code>坐标：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;druid&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.1</span><span class="number">.16</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p><code>application.yaml</code>中：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSource:</span></span><br><span class="line">  <span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.driver123</span></span><br></pre></td></tr></table></figure><p>配置<code>bean</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;datasource&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DruidDataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        <span class="comment">//使用配置文件中的属性进行注入</span></span><br><span class="line">        <span class="comment">//dataSource.setDriverClassName(&quot;com.mysql.jdbc.driver&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DruidDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(dataSource.getDriverClassName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@EnableConfigurationProperties</code>注解：</p><ul><li>开启属性绑定并设置对应的目标</li><li>可以将使用的<code>@ConfigurationProperties</code>注解对应的类加入Spring容器</li><li><code>@EnableConfigurationProperties</code>注解与<code>@Component</code>注解不能同时使用</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ServerConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;datasource&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DruidDataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        <span class="comment">//dataSource.setDriverClassName(&quot;123456&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时要将<code>ServerConfig</code>中的<code>@Component</code>注释删除：</p><p>如果不删除<code>@Component</code>注释，则会造成bean加载两次，报错</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;servers&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String ipAddress;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果<code>idea</code>出现<span style="color:red">Spring Boot Configuration Annotation Processor not configured</span>问题：</p><p>导入坐标即可：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-3-松散绑定"><a href="#2-3-松散绑定" class="headerlink" title="2.3 松散绑定"></a>2.3 松散绑定</h3><p><code>@ConfigurationProperties</code>注解：绑定属性支持属性名宽松绑定</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;servers&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String ipAddress;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>支持多种格式：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">servers:</span></span><br><span class="line">  <span class="comment">#ipAddress: 127.0.0.1  #驼峰格式</span></span><br><span class="line">  <span class="comment">#ipaddress: 127.0.0.1</span></span><br><span class="line">  <span class="comment">#ip_address: 127.0.0.1  #unline格式</span></span><br><span class="line">  <span class="comment">#IPADDRESS: 127.0.0.1</span></span><br><span class="line">  <span class="comment">#IP_ADDRESS: 127.0.0.1  #常量格式</span></span><br><span class="line">  <span class="comment">#IP_ADD_RE_SS: 127.0.0.1</span></span><br><span class="line">  <span class="attr">ip-address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  <span class="comment">#烤肉串格式</span></span><br></pre></td></tr></table></figure><p>注意：宽松绑定不支持<span style="color:red">@value 注解</span>引用单个属性的方式</p><p><code>@ConfigurationProperties</code>注解：绑定属性支持属性名宽松绑定</p><p>绑定前缀规范：</p><ul><li><p>指的是：<code>prefix = &quot;datasource&quot;</code>中的<code>datasource</code></p></li><li><p>仅能用使用小写字母、数字、中划线作为合法字符</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;datasource&quot;)</span></span><br><span class="line"><span class="keyword">public</span> DruidDataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">    <span class="comment">//dataSource.setDriverClassName(&quot;123456&quot;);</span></span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-常用计量单位的应用"><a href="#2-4-常用计量单位的应用" class="headerlink" title="2.4 常用计量单位的应用"></a>2.4 常用计量单位的应用</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">servers:</span></span><br><span class="line">  <span class="attr">ipAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  <span class="comment">#驼峰格式</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2345</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">-1</span></span><br><span class="line">  <span class="attr">serverTimeout:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">dataSize:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><p>指定单位：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;servers&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String ipAddress;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeout; <span class="comment">//long类型描述时间单位为毫秒</span></span><br><span class="line">    <span class="meta">@DurationUnit(ChronoUnit.HOURS)</span> <span class="comment">//指定描述时间单位为小时</span></span><br><span class="line">    <span class="keyword">private</span> Duration serverTimeout;</span><br><span class="line">    <span class="meta">@DataSizeUnit(DataUnit.MEGABYTES)</span> <span class="comment">//指定内存大小单位为MB</span></span><br><span class="line">    <span class="keyword">private</span> DataSize dataSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-bean属性校验"><a href="#2-4-bean属性校验" class="headerlink" title="2.4 bean属性校验"></a>2.4 bean属性校验</h3><p>导入<code>JSR303</code>规范接口的坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.validation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>validation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>导入使用<code>hibernate</code>框架提供的校验器做实现类的坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate.validator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>@Validated</code>注解为开启bean的校验功能：</p><ul><li><code>@Min</code>注解为设置最小值，并设置提示信息</li><li><code>@Max</code>注解为设置最大值，并设置提示信息</li><li>等等还有很多…</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;servers&quot;)</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Min(value = 1000, message = &quot;最小值不能超过1000&quot;)</span></span><br><span class="line">    <span class="meta">@Max(value = 8888, message = &quot;最大值不能超过8888&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-5-进制数据转换规则"><a href="#2-5-进制数据转换规则" class="headerlink" title="2.5 进制数据转换规则"></a>2.5 进制数据转换规则</h3><p>配置文件的<code>dataSource</code>中的<code>password</code>设置为<code>012345</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSource:</span></span><br><span class="line">  <span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.driver123</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">012345</span></span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DruidDataSource dataSource;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(dataSource.getPassword());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取的<code>passord</code>为<code>5347</code>，明显与设置的密码不符</p><p>这是因为0开头的密码被当成八进制进行处理了</p><p>将密码用改用字符串形式，用双引号包裹：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSource:</span></span><br><span class="line">  <span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.driver123</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;012345&quot;</span></span><br></pre></td></tr></table></figure><p><strong>yaml语法规则</strong></p><p>字面值表达方式：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">boolean:</span> <span class="literal">TRUE</span>                           <span class="comment">#TRUE true True FALSE False false均可</span></span><br><span class="line"><span class="attr">float:</span> <span class="number">3.14</span>                             <span class="comment">#支持科学计数法 6.5201314e+5</span></span><br><span class="line"><span class="attr">int:</span> <span class="number">123</span>                                <span class="comment">#支持二进制 八进制 十六进制</span></span><br><span class="line"><span class="attr">null:</span> <span class="string">~</span>                                 <span class="comment">#使用 ~ 表示null</span></span><br><span class="line"><span class="attr">string1:</span> <span class="string">HelloWord</span>                      <span class="comment">#字符串可以直接书写</span></span><br><span class="line"><span class="attr">string2:</span> <span class="string">&quot;Hello Word&quot;</span>                   <span class="comment">#可以使用双引号包裹特殊字符</span></span><br><span class="line"><span class="attr">data:</span> <span class="number">2022-07-27</span>                        <span class="comment">#日期格式必须使用yyyy-MM-dd格式</span></span><br><span class="line"><span class="attr">datatime:</span> <span class="number">2022-07-27T20:37:30+08:00</span>     <span class="comment">#日期与时间之间使用T连接，最后使用+代表时区</span></span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="3-测试"><a href="#3-测试" class="headerlink" title="3.测试"></a>3.测试</h2><h3 id="3-1-加载测试专用属性"><a href="#3-1-加载测试专用属性" class="headerlink" title="3.1 加载测试专用属性"></a>3.1 加载测试专用属性</h3><p><code>application.yaml</code>配置文件中：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">prop:</span> <span class="string">testVal</span></span><br></pre></td></tr></table></figure><p>测试，读取prop值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertiesAndArgsTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.prop&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String val;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>运行结果：testVal</p></blockquote><p><strong>第一种方式</strong>：<code>properties</code>属性</p><p>可以使用<code>@SpringBootTest</code>注解中：</p><ul><li><p><code>properties</code>属性可以为当前测试用例添加临时的属性配置</p></li><li><p>并且可以覆盖主配置文件的属性配置</p></li><li><p>优点：比多环境开发中的测试环境影响范围更小，仅对当前测试类有效</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(properties = &#123;&quot;test.prop=test1&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertiesAndArgsTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.prop&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String val;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>运行结果：test1</p></blockquote><p><strong>第二种方式</strong>：<code>args</code>属性</p><p>可以使用<code>@SpringBootTest</code>注解中：</p><ul><li><p><code>args</code>属性可以为当前测试用例添加临时命令行参数</p></li><li><p>并且可以覆盖主配置文件的属性配置</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(args = &#123;&quot;--test.prop=test2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertiesAndArgsTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.prop&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String val;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>运行结果：test2</p></blockquote><p>第三种方式：同时使用<code>properties</code>属性以及<code>args</code>属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(properties = &#123;&quot;test.prop=test1&quot;&#125;, args = &#123;&quot;--test.prop=test2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertiesAndArgsTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.prop&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String val;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>运行结果：test2</p></blockquote><p>所以，优先级为命令行参数<code>args</code>属性 &gt; <code>properties</code>属性  &gt; <code>application.yaml</code>配置文件</p><h3 id="3-2-加载测试专用配置"><a href="#3-2-加载测试专用配置" class="headerlink" title="3.2 加载测试专用配置"></a>3.2 加载测试专用配置</h3><p>在<code>test</code>包下创建<code>MsgConfig</code>配置类：</p><ul><li>仅服务于测试下的，不能定义在<code>main</code>包下，如果定义到<code>main</code>包下就属于源码级别了</li><li>导入第三方bean太麻烦，简单的定义一个bean</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsgConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">Msg</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;bean msg&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<code>@Import</code>注解加载当前测试类专用的配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Import(&#123;MsgConfig.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> String Msg;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testGetMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-测试类启动Web环境"><a href="#3-3-测试类启动Web环境" class="headerlink" title="3.3 测试类启动Web环境"></a>3.3 测试类启动Web环境</h3><p>导入坐标：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>创建一个<code>UserController</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getById</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getById is running&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;UserId&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p><code>webEnvironment</code>属性：</p><ul><li><p><code>SpringBootTest.WebEnvironment.NONE</code>为默认关闭web环境</p></li><li><p><code>SpringBootTest.WebEnvironment.DEFINED_PORT</code>为配置文件中定义的端口</p></li><li><p><code>SpringBootTest.WebEnvironment.RANDOM_PORT</code>为随机端口</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testRandomPort</span><span class="params">()</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虚拟发送请求：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span> <span class="comment">//开启虚拟Mvc的调用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="comment">//注入虚拟Mvc调用对象</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testWeb</span><span class="params">(<span class="meta">@Autowired</span> MockMvc mockMvc)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//创建虚拟请求，当前访问/books，get请求</span></span><br><span class="line">        <span class="type">MockHttpServletRequestBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> MockMvcRequestBuilders.get(<span class="string">&quot;/users&quot;</span>);</span><br><span class="line">        <span class="comment">//执行请求</span></span><br><span class="line">        mockMvc.perform(builder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4-虚拟请求匹配响应"><a href="#3-4-虚拟请求匹配响应" class="headerlink" title="3.4 虚拟请求匹配响应"></a>3.4 虚拟请求匹配响应</h3><p><strong>虚拟请求状态匹配</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testStatus</span><span class="params">(<span class="meta">@Autowired</span> MockMvc mockMvc)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MockHttpServletRequestBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> MockMvcRequestBuilders.get(<span class="string">&quot;/users&quot;</span>);</span><br><span class="line">        <span class="type">ResultActions</span> <span class="variable">actions</span> <span class="operator">=</span> mockMvc.perform(builder);</span><br><span class="line">        <span class="comment">//定义本次调用的预期值</span></span><br><span class="line">        <span class="type">StatusResultMatchers</span> <span class="variable">status</span> <span class="operator">=</span> MockMvcResultMatchers.status();</span><br><span class="line">        <span class="comment">//预计本次调用成功，状态为200</span></span><br><span class="line">        <span class="type">ResultMatcher</span> <span class="variable">ok</span> <span class="operator">=</span> status.isOk();</span><br><span class="line">        <span class="comment">//添加预计值到本次调用中进行比较</span></span><br><span class="line">        actions.andExpect(ok);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>虚拟请求体匹配</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testBody</span><span class="params">(<span class="meta">@Autowired</span> MockMvc mockMvc)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MockHttpServletRequestBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> MockMvcRequestBuilders.get(<span class="string">&quot;/users&quot;</span>);</span><br><span class="line">        <span class="type">ResultActions</span> <span class="variable">actions</span> <span class="operator">=</span> mockMvc.perform(builder);</span><br><span class="line">        <span class="comment">//定义本次调用的预期值</span></span><br><span class="line">        <span class="type">ContentResultMatchers</span> <span class="variable">content</span> <span class="operator">=</span> MockMvcResultMatchers.content();</span><br><span class="line">        <span class="comment">//预计本次调用成功，响应值为&quot;UserId&quot;</span></span><br><span class="line">        <span class="type">ResultMatcher</span> <span class="variable">result</span> <span class="operator">=</span> content.string(<span class="string">&quot;UserId&quot;</span>);</span><br><span class="line">        <span class="comment">//添加预计值到本次调用中进行比较</span></span><br><span class="line">        actions.andExpect(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>虚拟请求体(Json)匹配</strong>：</p><p>导入坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>5.7.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>创建<code>User</code>实体类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>UserController</code>中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getById is running&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(<span class="number">1</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        user.setName(<span class="string">&quot;大黄&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span> <span class="comment">//开启虚拟Mvc的调用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testJson</span><span class="params">(<span class="meta">@Autowired</span> MockMvc mockMvc)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MockHttpServletRequestBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> MockMvcRequestBuilders.get(<span class="string">&quot;/users&quot;</span>);</span><br><span class="line">        <span class="type">ResultActions</span> <span class="variable">actions</span> <span class="operator">=</span> mockMvc.perform(builder);</span><br><span class="line">        <span class="comment">//定义本次调用的预期值</span></span><br><span class="line">        <span class="type">ContentResultMatchers</span> <span class="variable">content</span> <span class="operator">=</span> MockMvcResultMatchers.content();</span><br><span class="line">        <span class="comment">//预计本次调用成功，返回的值</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(<span class="number">1</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        user.setName(<span class="string">&quot;大黄&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">userJson</span> <span class="operator">=</span> JSONUtil.toJsonStr(user); <span class="comment">//转换成Json</span></span><br><span class="line">        <span class="type">ResultMatcher</span> <span class="variable">result</span> <span class="operator">=</span> content.json(userJson);</span><br><span class="line">        <span class="comment">//添加预计值到本次调用中进行比较</span></span><br><span class="line">        actions.andExpect(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>虚拟请求头匹配</strong>：</p><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span> <span class="comment">//开启虚拟Mvc的调用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testContentType</span><span class="params">(<span class="meta">@Autowired</span> MockMvc mockMvc)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MockHttpServletRequestBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> MockMvcRequestBuilders.get(<span class="string">&quot;/users&quot;</span>);</span><br><span class="line">        <span class="type">ResultActions</span> <span class="variable">actions</span> <span class="operator">=</span> mockMvc.perform(builder);</span><br><span class="line">        <span class="comment">//定义本次调用的预期值</span></span><br><span class="line">        <span class="type">HeaderResultMatchers</span> <span class="variable">header</span> <span class="operator">=</span> MockMvcResultMatchers.header();</span><br><span class="line">        <span class="comment">//预计本次调用成功，返回的值</span></span><br><span class="line">        <span class="type">ResultMatcher</span> <span class="variable">contentType</span> <span class="operator">=</span> header.string(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        <span class="comment">//添加预计值到本次调用中进行比较</span></span><br><span class="line">        actions.andExpect(contentType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通常测试，会写到一起：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span> <span class="comment">//开启虚拟Mvc的调用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testGetById</span><span class="params">(<span class="meta">@Autowired</span> MockMvc mockMvc)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MockHttpServletRequestBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> MockMvcRequestBuilders.get(<span class="string">&quot;/users&quot;</span>);</span><br><span class="line">        <span class="type">ResultActions</span> <span class="variable">actions</span> <span class="operator">=</span> mockMvc.perform(builder);</span><br><span class="line"></span><br><span class="line">        <span class="type">StatusResultMatchers</span> <span class="variable">status</span> <span class="operator">=</span> MockMvcResultMatchers.status();</span><br><span class="line">        <span class="type">ResultMatcher</span> <span class="variable">ok</span> <span class="operator">=</span> status.isOk();</span><br><span class="line">        actions.andExpect(ok);</span><br><span class="line"></span><br><span class="line">        <span class="type">HeaderResultMatchers</span> <span class="variable">header</span> <span class="operator">=</span> MockMvcResultMatchers.header();</span><br><span class="line">        <span class="type">ResultMatcher</span> <span class="variable">contentType</span> <span class="operator">=</span> header.string(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        actions.andExpect(contentType);</span><br><span class="line"></span><br><span class="line">        <span class="type">ContentResultMatchers</span> <span class="variable">content</span> <span class="operator">=</span> MockMvcResultMatchers.content();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(<span class="number">1</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        user.setName(<span class="string">&quot;大黄&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">userJson</span> <span class="operator">=</span> JSONUtil.toJsonStr(user); <span class="comment">//转换成Json</span></span><br><span class="line">        <span class="type">ResultMatcher</span> <span class="variable">result</span> <span class="operator">=</span> content.json(userJson);</span><br><span class="line">        actions.andExpect(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-5-业务层测试事务回滚"><a href="#3-5-业务层测试事务回滚" class="headerlink" title="3.5 业务层测试事务回滚"></a>3.5 业务层测试事务回滚</h3><p>导入坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/demo?serverTimezone=UTC</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">table-prefix:</span> <span class="string">tbl_</span></span><br><span class="line">      <span class="comment">#将id设为自动增长</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment">#开启日志，标准输出：将数据打印到控制台</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure><p>Dao层：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookDao</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Book&gt;&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Service层：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;Book&gt; &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">saveBook</span><span class="params">(Book book)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BookDao, Book&gt; <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveBook</span><span class="params">(Book book)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> save(book);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p><code>@Transactional</code>：为测试用例添加事务，SpringBoot会对测试用例对应的事务提交操作进行回滚<br><code>@Rollback</code>：默认为true(可不写此注释)，改为false为提交事务，不回滚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Transactional</span> <span class="comment">//开启SpringBoot事务</span></span><br><span class="line"><span class="meta">@Rollback(value = true)</span> <span class="comment">//默认value值为true，开启回滚(可不写)；value值为false，关闭回滚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DaoTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BookService bookService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSave</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">        book.setName(<span class="string">&quot;springboot&quot;</span>);</span><br><span class="line">        book.setType(<span class="string">&quot;java&quot;</span>);</span><br><span class="line">        book.setDescription(<span class="string">&quot;这是书&quot;</span>);</span><br><span class="line"></span><br><span class="line">        bookService.saveBook(book);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-6-测试用例设置随机数据"><a href="#3-6-测试用例设置随机数据" class="headerlink" title="3.6 测试用例设置随机数据"></a>3.6 测试用例设置随机数据</h3><p>在配置文件中添加：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">testcase:</span><br><span class="line">  book:</span><br><span class="line">    id: $&#123;random.<span class="type">int</span>&#125;</span><br><span class="line">    name: 用户$&#123;random.value&#125; #可加前缀</span><br><span class="line">    uuid: $&#123;random.uuid&#125;</span><br><span class="line">    time: $&#123;random.<span class="type">long</span>&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testBookCase</span><span class="params">(<span class="meta">@Autowired</span> BookCase bookCase)</span> &#123;</span><br><span class="line">    System.out.println(bookCase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>多次运行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BookCase(id=-<span class="number">1723189530</span>, name=用户36fc0553fae0662a1398f194a79d702c, uuid=c4f742bf-85b8-<span class="number">4416</span>-<span class="number">836d</span>-ab656e20c050, time=<span class="number">9037975923279012585</span>)</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BookCase(id=<span class="number">1758479696</span>, name=用户4952f34e3caadde83261a58b5c9a439f, uuid=4a5747f7-80ff-<span class="number">4161</span>-<span class="number">8771</span>-8dfdce6c470a, time=-<span class="number">2080170540354815861</span>)</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BookCase(id=<span class="number">1773052492</span>, name=用户88777f3bd07cb35dfe29b18b4873e7ed, uuid=3bd7d980-d5d6-46f2-bbf3-c190cdfe28ec, time=-<span class="number">4024744750514505719</span>)</span><br></pre></td></tr></table></figure><p>测试通常采用随机值进行测试，使用SpringBoot提供的随机数为其赋值：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">testcase:</span></span><br><span class="line">  <span class="attr">book:</span></span><br><span class="line">    <span class="attr">id:</span> <span class="string">$&#123;random.int&#125;</span>        <span class="comment"># 随机整数</span></span><br><span class="line">    <span class="attr">id2:</span> <span class="string">$&#123;random.int(10)&#125;</span>   <span class="comment"># 10以内的整数</span></span><br><span class="line">    <span class="attr">id3:</span> <span class="string">$&#123;random.int(5,10)&#125;</span> <span class="comment"># 5~10之间的整数 </span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">用户$&#123;random.value&#125;</span> <span class="comment"># 随机字符串，MD5字符串，32位  可加前缀</span></span><br><span class="line">    <span class="attr">uuid:</span> <span class="string">$&#123;random.uuid&#125;</span>     <span class="comment"># 随机uuid</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">$&#123;random.long&#125;</span>     <span class="comment"># 随机整数，long范围</span></span><br></pre></td></tr></table></figure><p>其中，<code>random.int(5,10)</code>的括号<code>()</code>可以是任意字符，如<code>[]</code>、<code>@@</code>、<code>!!</code>等均可</p></div><div class="story post-story"><h2 id="4-数据层解决方案"><a href="#4-数据层解决方案" class="headerlink" title="4.数据层解决方案"></a>4.数据层解决方案</h2><p>现有数据层解决方案技术选型：</p><p><code>Druid + MyBatis-Plus + MySQL</code></p><ul><li>数据源：<code>DruidDataSource</code></li><li>持久化技术：<code>MyBatis / MyBatis-Plus</code></li><li>数据库：<code>MySQL</code></li></ul><h3 id="4-1-内置数据源"><a href="#4-1-内置数据源" class="headerlink" title="4.1 内置数据源"></a>4.1 内置数据源</h3><p>数据源配置格式：</p><ul><li><p>格式一：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/demo?serverTimezone=UTC</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure></li><li><p>格式二：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line"><span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/demo?serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br></pre></td></tr></table></figure></li></ul><p>以上两种格式都指定数据源为<code>druid</code>，</p><p>如果未指定数据源呢？</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line"><span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/demo?serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure><p>运行后，采用的数据源依旧是<code>druid</code></p><p>因为导入<code>druid-spring-boot-starter</code>的坐标，会自动配置数据源：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>将<code>druid-spring-boot-starter</code>坐标注释或删除，不提供数据源，</p><p><code>SpringBoot</code>会提供3种内嵌的数据源对象供开发者选择：</p><ul><li>HikariCP：默认内置数据源对象</li><li>Tomcat提供DataSource：HikariCP在不可用的情况下，且在Web环境中，将使用Tomcat服务器配置的数据源对象</li><li>Commons DBCP：HikariCP和Tomcat数据源都不可用，将使用dbcp数据源</li></ul><p><code>HikariCP</code>数据源配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/demo?serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">maximum-pool-size:</span> <span class="number">8</span></span><br></pre></td></tr></table></figure><h3 id="4-2-JdbcTemplate"><a href="#4-2-JdbcTemplate" class="headerlink" title="4.2 JdbcTemplate"></a>4.2 JdbcTemplate</h3><p><code>SpringBoot</code>内置<code>JdbcTemplate</code>持久化解决方案：</p><p>导入坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>此外，<code>MyaBtis-Plus</code>坐标已经包含了上面的坐标</p><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testQueryForList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from tbl_book where id = 1&quot;</span>;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; books = jdbcTemplate.queryForList(sql);</span><br><span class="line">        System.out.println(<span class="string">&quot;books = &quot;</span> + books);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testQuery</span><span class="params">()</span> &#123;</span><br><span class="line">        RowMapper&lt;Book&gt; rm = <span class="keyword">new</span> <span class="title class_">RowMapper</span>&lt;Book&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Book <span class="title function_">mapRow</span><span class="params">(ResultSet resultSet, <span class="type">int</span> i)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">                <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">                book.setId(resultSet.getInt(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">                book.setName(resultSet.getString(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">                book.setType(resultSet.getString(<span class="string">&quot;type&quot;</span>));</span><br><span class="line">                book.setDescription(resultSet.getString(<span class="string">&quot;description&quot;</span>));</span><br><span class="line">                <span class="keyword">return</span> book;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from tbl_book&quot;</span>;</span><br><span class="line">        List&lt;Book&gt; books = jdbcTemplate.query(sql, rm);</span><br><span class="line">        System.out.println(<span class="string">&quot;books = &quot;</span> + books);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSave</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into tbl_book values (null, &#x27;sss&#x27;, &#x27;aaa&#x27;, &#x27;bbb&#x27;)&quot;</span>;</span><br><span class="line">        jdbcTemplate.update(sql);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>JdbcTemplate</code>配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">jdbc:</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">fetch-size:</span> <span class="number">-1</span>     <span class="comment"># 缓存行数</span></span><br><span class="line">      <span class="attr">query-timeout:</span> <span class="number">-1</span>  <span class="comment"># 查询超时时间</span></span><br><span class="line">      <span class="attr">max-rows:</span> <span class="number">-1</span>       <span class="comment"># 最大行数</span></span><br></pre></td></tr></table></figure><h3 id="4-3-内嵌数据库"><a href="#4-3-内嵌数据库" class="headerlink" title="4.3 内嵌数据库"></a>4.3 内嵌数据库</h3><p>SpringBoot提供了3种内嵌数据库供开发者选择，提高开发测试效率：</p><ul><li>H2</li><li>HSQL</li><li>Derby</li></ul><p>以H2数据库为例：</p><p>导入坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>同时还需要Web环境，所以还要导入坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">h2:</span></span><br><span class="line">    <span class="attr">console:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/h2</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>访问用户名为<code>sa</code>，默认密码为<code>123456</code></p><p>在浏览器请求链接：<code>http://localhost:8080/h2</code></p><img src="https://s2.loli.net/2022/07/31/2VKuU83cz7Dlpod.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/31/2VKuU83cz7Dlpod.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220731001302916" style="zoom:67%;" /><p>点击连接，第一次连接会报错，需要初始化添加上面的相关配置</p><p>添加H2数据库配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">h2:</span></span><br><span class="line">    <span class="attr">console:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/h2</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:h2:~/test</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.h2.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">sa</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure><p>连接成功后：</p><img src="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220731124000749.png" class="lazyload" data-srcset="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220731124000749.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220731124000749" style="zoom: 33%;" /><p>在上方的空白框中执行下面的语句，创建表：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tbl_book (id <span class="type">int</span>, type <span class="type">varchar</span>, name <span class="type">varchar</span>, description <span class="type">varchar</span>)</span><br></pre></td></tr></table></figure><p>查询语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_book</span><br></pre></td></tr></table></figure><p>需要停止<code>SpringBoot</code>项目服务，才可以进行测试</p><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testQuery</span><span class="params">()</span> &#123; <span class="comment">//查询所有</span></span><br><span class="line">        RowMapper&lt;Book&gt; rm = <span class="keyword">new</span> <span class="title class_">RowMapper</span>&lt;Book&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Book <span class="title function_">mapRow</span><span class="params">(ResultSet resultSet, <span class="type">int</span> i)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">                <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">                book.setId(resultSet.getInt(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">                book.setName(resultSet.getString(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">                book.setType(resultSet.getString(<span class="string">&quot;type&quot;</span>));</span><br><span class="line">                book.setDescription(resultSet.getString(<span class="string">&quot;description&quot;</span>));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> book;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from tbl_book&quot;</span>;</span><br><span class="line">        List&lt;Book&gt; books = jdbcTemplate.query(sql, rm);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;books = &quot;</span> + books);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSave</span><span class="params">()</span> &#123; <span class="comment">//插入</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into tbl_book values (2, &#x27;sss&#x27;, &#x27;aaa&#x27;, &#x27;bbb&#x27;)&quot;</span>;</span><br><span class="line">        jdbcTemplate.update(sql);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改用<code>MyBatis-Plus</code>技术也是可以的，并且无缝衔接，只需导入<code>MyBatis-Plus</code>坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>添加<code>MyBatis-Plus</code>的配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">table-prefix:</span> <span class="string">tbl_</span></span><br><span class="line">      <span class="comment">#将id设为自动增长</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment">#开启日志，标准输出：将数据打印到控制台</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DaoTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BookService bookService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSelectAll</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Book&gt; list = bookService.list();</span><br><span class="line">        System.out.println(<span class="string">&quot;list = &quot;</span> + list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>H2数据库控制台仅用于开发阶段，线上项目请务必关闭控制台功能：</p><p>将<code>enabled</code>改为<code>false</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">h2:</span></span><br><span class="line">    <span class="attr">console:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/h2</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="5-整合第三方技术"><a href="#5-整合第三方技术" class="headerlink" title="5.整合第三方技术"></a>5.整合第三方技术</h2><h2 id="6-监控"><a href="#6-监控" class="headerlink" title="6.监控"></a>6.监控</h2></div>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 框架 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis的学习笔记</title>
      <link href="/2022/08/06/Java/Redis/"/>
      <url>/2022/08/06/Java/Redis/</url>
      
        <content type="html"><![CDATA[<h1 id="基础篇"><a href="#基础篇" class="headerlink" title="基础篇"></a>基础篇</h1><div class="story post-story"><h2 id="1-初识Redis"><a href="#1-初识Redis" class="headerlink" title="1.初识Redis"></a>1.初识Redis</h2><h3 id="1-1-认识NoSql"><a href="#1-1-认识NoSql" class="headerlink" title="1.1 认识NoSql"></a>1.1 认识NoSql</h3><p>键值数据库是一种NoSql数据库</p><table><thead><tr><th align="center">key</th><th>value</th></tr></thead><tbody><tr><td align="center">1001</td><td>{<br>   “id”:1001,<br>   “name”:”张三”,<br>   “age”:20,<br>}</td></tr></tbody></table><p>SQL：关系型数据库</p><p>NoSQL：非关系型数据库</p><p>SQL与NoSQl的比较：</p><table><thead><tr><th align="center"></th><th>SQL</th><th>NoSQL</th></tr></thead><tbody><tr><td align="center">数据结构</td><td>结构化</td><td>非结构化：<br>1.键值类型(Redis)<br>2.文档类型(MongoDB)<br>3.列类型(HBase)<br>4.Graph类型(Neo4j)</td></tr><tr><td align="center">数据关联</td><td>关联的(数据有关联)</td><td>无关联的</td></tr><tr><td align="center">查询方式</td><td>SQL查询(SQL语法通用)</td><td>非SQL(语法不统一)</td></tr><tr><td align="center">事务特性</td><td>ACID</td><td>BASE</td></tr><tr><td align="center">存储方式</td><td>磁盘</td><td>内存</td></tr><tr><td align="center">扩展性</td><td>垂直</td><td>水平</td></tr><tr><td align="center">使用场景</td><td>1.数据结构固定<br>2.相关业务数据安全性、<br>一致性要求较高</td><td>1.数据结构不固定<br>2.相关业务数据安全性、一致性要求不高<br>3.对性能要求</td></tr></tbody></table><h3 id="1-2-认识Redis"><a href="#1-2-认识Redis" class="headerlink" title="1.2 认识Redis"></a>1.2 认识Redis</h3><p>Redis诞生于2009年全称时Remote Dictionary Server，远程词典服务器，是一个基于内存的键值型NoSQL数据库。</p><p>特征：</p><ul><li><p>键值(key-value)型：value支持多种不同数据结构，功能丰富</p></li><li><p>单线程：每个命令具备原子性</p></li><li><p>低延迟、速度快：基于内存、IO多路复用、良好的编码(C语言开发)</p></li><li><p>支持数据持久化</p></li><li><p>支持主从集群、分片集群</p></li><li><p>支持多语言客户端</p></li></ul><h3 id="1-3-Redis的安装及其配置"><a href="#1-3-Redis的安装及其配置" class="headerlink" title="1.3 Redis的安装及其配置"></a>1.3 Redis的安装及其配置</h3><p>(<span style="color:red">不要看这个教程安装，有问题</span>)</p><p>​大多企业都是基于Linux服务器来部署项目，而且Redis官方也没有提供Windows版本的安装包。因此会使用基于Linux系统来安装Redis。</p><p>Redis官网：<a href="https://redis.io/">Redis</a></p><p>Linux版本为：CentOS7</p><p>注意：下面的安装Redis方法不适用于<strong>Ubuntu</strong></p><p>打开命令行，依次输入一下内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">转换成root权限</span></span><br><span class="line">su - </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">输入密码</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装gcc依赖</span></span><br><span class="line">yum install -y gcc tcl</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入到src目录</span></span><br><span class="line">cd /usr/local/src</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载redis-6.2.6.tar.gz</span></span><br><span class="line">wget https://download.redis.io/releases/redis-6.2.6.tar.gz</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解压redis-6.2.6.tar.gz</span></span><br><span class="line">tar -zxvf redis-6.2.6.tar.gz</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入redis-6.2.6</span></span><br><span class="line">cd redis-6.2.6</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">运行编译命令</span></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>默认安装路径为<code>/usr/local/bin</code>目录下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll /usr/local/bin</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/01/25/GjaV3w5Yc7x4s8K.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/GjaV3w5Yc7x4s8K.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220707211843362.png"></p><p>看到这个样子安装基本成功了</p><p>Redis的配置文件：</p><p>重新打开命令行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">su -</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">输入密码</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入到redis-6.2.6目录</span></span><br><span class="line">cd /usr/local/src/redis-6.2.6</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备份redis.conf</span></span><br><span class="line">cp redis.conf redis.conf.bck</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">打开redis.conf配置文件</span></span><br><span class="line">vi redis.conf</span><br></pre></td></tr></table></figure><p>修改redis.conf文件的一些配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#bind 127.0.0.1 -::会导致只能在本地访问，修改为0.0.0.0就可以在任意ip访问，生产环境不要设置为0.0.0.0</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">#守护进程，修改为yes即可后台运行</span><br><span class="line">daemonize yes</span><br><span class="line">#设置密码为123456</span><br><span class="line">requirepass 123456</span><br></pre></td></tr></table></figure><p>查找：<code>/</code>+所要查找的字符串；按<code>n</code>向下查找，按<code>N</code>向上查找</p><p>输入<code>i</code>即可修改数据，修改完成后按<code>ESC</code>退出编辑</p><p><code>:wq</code>为保存并退出</p><p>退出后：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-server redis.conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看redis进程</span></span><br><span class="line">ps -ef|grep redis </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">杀死进程</span></span><br><span class="line">kill -9 端口号</span><br></pre></td></tr></table></figure><p>接着设置开机自启：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">新建一个系统服务文件</span></span><br><span class="line">vi /etc/systemd/system/redis.service</span><br></pre></td></tr></table></figure><p>将下面内容全部复制到redis.service文件中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=redis-server</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/usr/local/bin/redis-server /usr/local/src/redis-6.2.6/redis.conf</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>保存退出后，</p><p>接着:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重载系统服务</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动redis</span></span><br><span class="line">systemctl start redis</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看redis状态</span></span><br><span class="line">systemctl status redis</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">停止redis</span></span><br><span class="line">systemctl stop redis</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">redis开机自启</span></span><br><span class="line">systemctl enable redis</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="2-Redis命令"><a href="#2-Redis命令" class="headerlink" title="2.Redis命令"></a>2.Redis命令</h2><h3 id="2-1-Redis数据结构介绍"><a href="#2-1-Redis数据结构介绍" class="headerlink" title="2.1 Redis数据结构介绍"></a>2.1 Redis数据结构介绍</h3><p>Redis是一个key-value的数据库，key一般是String类型，不过value的类型多种多样：</p><table><thead><tr><th align="center">数据类型</th><th>格式</th></tr></thead><tbody><tr><td align="center"><span style="color:red">String</span></td><td>hello Redis</td></tr><tr><td align="center"><span style="color:red">Hash</span></td><td>{name: “jack”, age: 21}</td></tr><tr><td align="center"><span style="color:red">List</span></td><td>[A -&gt; B -&gt; C -&gt; D]</td></tr><tr><td align="center"><span style="color:red">Set</span></td><td>{A, B, C}</td></tr><tr><td align="center"><span style="color:red">SortSet</span></td><td>{A: 1, B: 2, C: 3}</td></tr><tr><td align="center"><span style="color:red">GEO</span>(地理坐标)</td><td>{A: (120.3, 30.5)}</td></tr><tr><td align="center"><span style="color:red">BitMap</span></td><td>0101001001100101011001000110100101110011</td></tr><tr><td align="center"><span style="color:red">HyperLog</span></td><td>0101001001100101011001000110100101110011</td></tr></tbody></table><p>基本类型：String、Hash、List、Set、SortSet</p><p>特殊类型：GEO、BitMap、HyperLog</p><h3 id="2-2-Redis通用命令"><a href="#2-2-Redis通用命令" class="headerlink" title="2.2 Redis通用命令"></a>2.2 Redis通用命令</h3><table><thead><tr><th>命令</th><th>解释</th><th>举例</th></tr></thead><tbody><tr><td>KEYS</td><td>查看符合模板的所有key，<br>不建议在生产环境设备上使用(效率低)</td><td><code>KEYS *</code>：查看所有key<br><code>KEYS n*</code>：查看所有n开头的key</td></tr><tr><td>DEL</td><td>删除一个指定key</td><td><code>DEL name</code>：删除name</td></tr><tr><td>EXISTS</td><td>判断key是否存在</td><td><code>EXISTS name</code>：存在返回1，否则返回0</td></tr><tr><td>EXPIRE</td><td>给一个key设置有效期，<br>有效期到期key会被自动删除</td><td><code>EXPIRE name 20</code>：设置name的有效期为20秒</td></tr><tr><td>TTL</td><td>查看一个key的剩余有效期</td><td><code>TTL name</code>：查看name的有效期，<br>如果返回-2，则说明到期了<br>如果返回-1，则说明永久有效</td></tr></tbody></table><h3 id="2-3-String类型"><a href="#2-3-String类型" class="headerlink" title="2.3 String类型"></a>2.3 String类型</h3><p>String类型、也就是字符串类型，是Redis中最简单的存储类型</p><p>其value是字符串，不过根据字符串的格式不同，又可以分类为3类：</p><ul><li><p>string：普通字符串</p></li><li><p>int：整数类型，可以做自增、自减操作</p></li><li><p>float：浮点类型，可以做自增、自减操作</p></li></ul><p>不管是哪种格式，底层都是字节数组形式存储，字符串类型的最大空间不能超过512m</p><table><thead><tr><th align="center">Key</th><th align="center">Value</th></tr></thead><tbody><tr><td align="center">msg</td><td align="center">hello Redis</td></tr><tr><td align="center">num</td><td align="center">10</td></tr><tr><td align="center">score</td><td align="center">98.5</td></tr></tbody></table><p>String类型常见命令：</p><table><thead><tr><th align="center">命令</th><th></th><th></th></tr></thead><tbody><tr><td align="center">SET key value</td><td>添加或修改已经存在的一个String类型的键值对</td><td><code>SET name Jerry</code>：把name的value设置为Jerry</td></tr><tr><td align="center">GET key</td><td>根据key获取String类型的value</td><td><code>GET name</code>：获取到value为”Jerry”</td></tr><tr><td align="center">MSET</td><td>批量添加多个String类型的键值对</td><td><code>MSET score 12.5 age 18</code>：添加多个键值对</td></tr><tr><td align="center">MGET</td><td>根据多个key获取多个String类型的value</td><td><code>MGET name score age</code>：得到多个value为”Jreey” “12.5” “18”</td></tr><tr><td align="center">INCR</td><td>让一个整型的key自增1</td><td><code>INCR age</code>：age的value加1，由18变为19</td></tr><tr><td align="center">INCRBY</td><td>让一个整型的key自增并指定步长</td><td><code>INCRBY age 2</code>：age的value加2，由19变为21</td></tr><tr><td align="center">INCRBYFLOAT</td><td>让一个浮点类型的数字自增并指定步长</td><td><code>INCRBYFLOAT score 0.5</code>：score的value加0.5，由12.5变为13.0</td></tr><tr><td align="center">SETNX</td><td>添加一个String类型的键值对，<br>前提是这个<span style="color:red">key</span>不存在，否则不执行(新增效果)</td><td><code>SETNX name Tom</code>：不执行，返回0<br><code>SETNX k1 v1</code>：执行，返回1</td></tr><tr><td align="center">SETEX</td><td>添加一个String类型的键值对，并且指定有效期</td><td><code>SETEX name 10 jerry </code>：添加键值对，并将有效期设置为10秒</td></tr></tbody></table><h3 id="2-4-Key的层级格式"><a href="#2-4-Key的层级格式" class="headerlink" title="2.4 Key的层级格式"></a>2.4 Key的层级格式</h3><p>Redis没有类似于MySQL中的<code>Table</code>表的概念</p><p>Redis的Key允许有多个单词形成层级结构，多个单词之间用<code>:</code>隔开，格式(不固定)如下：</p><p><code>项目名:业务名:类型:id</code></p><p>例如项目名叫<code>demo</code>，有<code>user</code>和<code>book</code>两种不同类型的数据，我们可以这样定义Key：</p><ul><li><p>user相关的Key：<code>demo:user:1</code></p></li><li><p>book相关的Key：<code>demo:book:1</code></p></li></ul><p>如果Value是一个java对象，例如一个User对象，则可以将对象序列化为json字符串后存储：</p><table><thead><tr><th align="center">Key</th><th align="center">Value</th></tr></thead><tbody><tr><td align="center"><code>demo:user:1</code></td><td align="center">{“id”: 1, “name”: “Jerry”, “age”: 18}</td></tr><tr><td align="center"><code>demo:book:1</code></td><td align="center">{“id”: 1, “name”: “BOOK”, “price”: 15}</td></tr></tbody></table><p>插入操作(注意：Value值要加<code>&#39;&#39;</code>)：</p><ul><li><p><code>set demo:user:1 &#39;&#123;&quot;id&quot;: 1, &quot;name&quot;: &quot;Jerry&quot;, &quot;age&quot;: 18&#125;&#39;</code></p></li><li><p><code>set demo:book:1 &#39;&#123;&quot;id&quot;: 1, &quot;name&quot;: &quot;BOOK&quot;, &quot;price&quot;: 15&#125;&#39;</code></p></li></ul><p>打开图形界面客户端查看：</p><p><img src="https://s2.loli.net/2022/07/08/vckFyG2VYdjzhOS.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/08/vckFyG2VYdjzhOS.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220708185626850"></p><h3 id="2-5-Hash类型"><a href="#2-5-Hash类型" class="headerlink" title="2.5 Hash类型"></a>2.5 Hash类型</h3><p>Hash类型，也叫散列，其value是一个无序字典，类似于java中的HashMap结构</p><p>String结构是将对象序列化为json字符串后存储，当需要修改对象某个字段时很不方便(需要修改整个字符串)：</p><table><thead><tr><th align="center">Key</th><th align="center">Value</th></tr></thead><tbody><tr><td align="center"><code>demo:user:1</code></td><td align="center">{“id”: 1, “name”: “Jerry”, “age”: 18}</td></tr><tr><td align="center"><code>demo:user:2</code></td><td align="center">{“id”: 2, “name”: “Tom”, “price”: 20}</td></tr></tbody></table><p>而Hash结构可以将对象中每个字段独立存储，可以针对单个字段做CRUD：</p><table>    <tr align="center">                 <th rowspan="2">Key</th>                 <th colspan="2">Value</th>    </tr>    <tr align="center">                         <td>field</td>        <td>value</td>    </tr>    <tr align="center">                 <td rowspan="2">demo:user:1</td>                 <td>name</td>        <td>Jerry</td>    </tr>    <tr align="center">                         <td>age</td>        <td>18</td>    </tr>    <tr align="center">                 <td rowspan="2">demo:user:2</td>                 <td>name</td>        <td>Tom</td>    </tr>    <tr align="center">                         <td>age</td>        <td>20</td>    </tr></table><p>Hash类型常见命令：</p><table><thead><tr><th align="center">命令</th><th></th><th></th></tr></thead><tbody><tr><td align="center">HSET key field value</td><td>添加或修改hash类型key的field的值</td><td><code>HSET demo:user:2 name LiHua</code>：把name的value设置为Lihua</td></tr><tr><td align="center">HGET key field</td><td>获取一个hash类型key的field的值</td><td><code>HGET demo:user:2 name</code>：获取到value为”LiHua”</td></tr><tr><td align="center">HMSET</td><td>批量添加多个hash类型key的field的值</td><td><code>HMSET demo:user:3 name LiLei age 22</code>：添加多个field的值</td></tr><tr><td align="center">HMGET</td><td>批量获取根据多个hash类型key的field的值</td><td><code>HMGET demo:user:3 name age</code>：得到多个field的值为”LiLei” “22”</td></tr><tr><td align="center">HGETALL</td><td>获取一个hash类型的key中的所有的field和value</td><td><code>HGETALL demo:user:3</code>：获取到key中所有的field和value</td></tr><tr><td align="center">HKEYS</td><td>获取一个hash类型的key中的所有的field</td><td><code>HKEYS demo:user:3</code>：获取key中所有的field</td></tr><tr><td align="center">HVALS</td><td>获取一个hash类型的key中的所有的value</td><td><code>HVALS demo:user:3</code>：获取key中所有的value</td></tr><tr><td align="center">HINCRBY</td><td>让一个hash类型的key的字段自增并指定步长</td><td><code>HINCRBY demo:user:3 age 2</code>：age的value加2，由22变为24</td></tr><tr><td align="center">HSETNX</td><td>添加一个hash类型的key的field值，<br>前提是这个<span style="color:red">field</span>不存在，否则不执行(新增效果)</td><td><code>HSETNX demo:user:3 name XXX</code>：存在field值不执行，返回0<br><code>HSETNX demo:user:3 sex man</code>：不存在field值执行，返回1</td></tr></tbody></table><h3 id="2-6-List类型"><a href="#2-6-List类型" class="headerlink" title="2.6 List类型"></a>2.6 List类型</h3><p>Redis中的List类型与java中的LinkList类似，可以看作是一个双向链表结构，既可以支持正向检索也可以支持反向检索。</p><p>特征与LinkList也类似：</p><ul><li><p>有序</p></li><li><p>元素可以重复</p></li><li><p>插入和删除快</p></li><li><p>查询速度一般</p></li></ul><p>常用来存储一个有序数据，如：评论列表、点赞列表等</p><p>List类型的常见命令：</p><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>LPUSH key element</td><td>向列表左侧插入一个或多个元素</td><td><code>LPUSH user 1 2 3</code>：<br>表中从第一位依次为 “3” “2” “1”</td></tr><tr><td>LPOP key</td><td>移除并返回列表左侧的第一个元素，没有则返回nil</td><td>LPOP user 1</td></tr><tr><td>RPUSH key element</td><td>向列表右侧插入一个或多个元素</td><td><code>RPUSH user 4 5 6</code>：<br/>表中从第一位依次为 “4” “5” “6”</td></tr><tr><td>RPOP key</td><td>移除并返回列表右侧的第一个元素</td><td></td></tr><tr><td>LRANGE key star end</td><td>返回一段角标范围内的所有元素</td><td><code>LRANGE 1 star 2</code>：从0开始，<br>获取到1~2之间的元素</td></tr><tr><td>BLPOP</td><td>与LPOP类似，<br>只不过在没有元素时等待指定时间，<br>而不是直接返回nil</td><td><code>BLPOP user2 1 100</code>：<br>移除并返回到左侧的第一个元素，<br>没有则等待100秒，超时返回nil</td></tr><tr><td>BRPOP</td><td>与RPOP类似，<br/>只不过在没有元素时等待指定时间，<br/>而不是直接返回nil</td><td></td></tr></tbody></table><p>List结构模拟一个栈</p><ul><li><p>入口和出口在同一边</p></li><li><p>如：<code>LPUSH</code>和<code>LPOP</code>或者 <code>RPUSH</code>和<code>RPOP</code></p></li></ul><p>List结构模拟一个队列</p><ul><li><p>入口和出口不在同一边</p></li><li><p>如：<code>LPUSH</code>和<code>RPOP</code>  或者 <code>RPUSH</code>和<code>LPOP</code></p></li></ul><p>List结构模拟一个阻塞队列</p><ul><li>入口和出口不在同一边</li><li>出队采用<code>BLPOP</code>或者<code>BRPOP</code></li><li>如：<code>LPUSH</code>和<code>BRPOP</code>  或者 <code>RPUSH</code>和<code>BLPOP</code></li></ul><h3 id="2-7-Set类型"><a href="#2-7-Set类型" class="headerlink" title="2.7 Set类型"></a>2.7 Set类型</h3><p>Redis的Set结构与Java中的Hashset类似，可以看做是一个value为null的HashMap。因为也是一个hash表，因此具备与Hashset类似的特征：</p><ul><li>无序</li><li>元素不可重复</li><li>查找快</li><li>支持交集、并集、差集等功能</li></ul><p>Set类型的常见命令：</p><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>SADD key member</td><td>向set中添加一个或多个元素</td><td><code>SADD s1 a b c</code></td></tr><tr><td>SREM key member</td><td>移除set中的指定元素</td><td><code>SREM s1 a</code></td></tr><tr><td>SCARD key</td><td>返回set中元素的个数</td><td><code>SCARD s1</code></td></tr><tr><td>SISMEMBER key member</td><td>判断一个元素是否存在于set中</td><td><code>SISMEMBER s1 a</code></td></tr><tr><td>SMEMBERS</td><td>获取set中的所有元素</td><td><code>SMEMBERS</code></td></tr><tr><td>SINTER key1 key2</td><td>求key1与key2的<span style="color:red">交集</span></td><td></td></tr><tr><td>SDIFF key1 key2</td><td>求key1与key2的<span style="color:red">差集</span></td><td></td></tr><tr><td>SUNION key1 key2</td><td>求key1与key2的<span style="color:red">并集</span></td><td></td></tr></tbody></table><h3 id="2-8-SortedSet类型"><a href="#2-8-SortedSet类型" class="headerlink" title="2.8 SortedSet类型"></a>2.8 SortedSet类型</h3><p>Redis的SortedSet是一个可排序的set集合，与java中的TreeSet有些类似，但底层数据结构却差别很大Sortedset中的每一个元素都带有一个score属性，可以基于score属性对元素排序，底层的实现是一个跳表(SkipList)加hash表。<br>SortedSet具备下列特性：</p><ul><li><p>可排序</p></li><li><p>元素不重复</p></li><li><p>查询速度快</p></li></ul><p>因为Sortedset的可排序特性，经常被用来<strong>实现排行榜</strong>这样的功能。</p><p>SortedSet类型的常见命令：</p><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>ZADD key score member</td><td>添加一个或多个元素到sorted set，<br>如果已经存在则更新其score值</td><td><code>ZADD SSet 85 Tom 98 Jerry 77 Rose 78 Jack</code>：<br>向SSet中添加元素，并按照升序排列</td></tr><tr><td>ZREM key member</td><td>删除sorted set中的一个指定元素</td><td><code>ZREM SSet Tom</code>：删除Tom</td></tr><tr><td>ZSCORE key member</td><td>获取sorted set中的指定元素的score值</td><td></td></tr><tr><td>ZRANK key member</td><td>获取sorted set 中的指定元素升序的排名</td><td><code>ZRANK SSet Rose</code>：<br>按照升序的序列，从0开始，<br>返回Rose的排名</td></tr><tr><td>Z<span style="color:red">REV</span>RANK key member</td><td>获取sorted set 中的指定元素降序的排名</td><td><code>ZRANK SSet Rose</code>：<br>按照降序的序列，从0开始，<br>返回Rose的排名</td></tr><tr><td>ZCARD key</td><td>获取sorted set中的元素个数</td><td></td></tr><tr><td>ZCOUNT key min max</td><td>统计score值在给定范国内的所有元素的个数</td><td></td></tr><tr><td>ZINCRBY key increment member</td><td>让sorted set中的指定元素自增，<br>步长为指定的increment值</td><td></td></tr><tr><td>ZRANGE key min max</td><td>按照score升序排序后，获取指定排名范围内的元素</td><td><code>ZCOUNT SSet 0 2</code>：按照升序的情况，<br/>获取0~2范围的元素</td></tr><tr><td>Z<span style="color:red">REV</span>RANGE key min max</td><td>按照score的降序排序后，获取指定排名范围内的元素</td><td><code>ZCOUNT SSet 0 2</code>：按照降序的情况，<br>获取0~2范围的元素</td></tr><tr><td>ZRANGEBYSCORE key min  max</td><td>按照score排序后，获取指定score范国内的元素</td><td><code>ZRANGEBYSCORE SSet 0 80</code>：<br>返回0~80分数的元素</td></tr><tr><td>ZDIFF、ZINTER、ZUNION</td><td>求差集、交集、并集</td><td></td></tr></tbody></table><p>注意：所有排名默认都是升序，如果降序则在命令的Z后面添加<span style="color:red">REV</span>即可</p><p>例如：Z<span style="color:red">REV</span>RANK</p></div><div class="story post-story"><h2 id="3-Redis的java客户端"><a href="#3-Redis的java客户端" class="headerlink" title="3.Redis的java客户端"></a>3.Redis的java客户端</h2><p><a href="https://redis.io/docs/clients/">Redis官网</a>中提供了各种语言的客户端</p><p>Java：</p><blockquote><p><code>Jedis</code>：以Redis命令作为方法名称，学习成本低，简单实用但是Jedis实例是线程不安全的，多线程环境下需要基于连接池来使用</p><p><code>Lettuce</code>：基于Netty实现的，支持同步、异步和响应式编程方式，并且是线程安全的。支持Redis的哨兵模式、集群模式和管道模式</p><p><code>Redisson</code>：是一个基于Redis实现的分布式、可伸缩的Java数据结构集合。包含了诸如Map、Queue、LockSemaphore、Atomiclong等强大功能</p><p>其中Spring整合了<code>Jedis</code>和<code>Lettuce</code>，只需导入坐标<code>Spring Data Redis</code></p></blockquote><h3 id="3-1-Jedis快速入门"><a href="#3-1-Jedis快速入门" class="headerlink" title="3.1 Jedis快速入门"></a>3.1 Jedis快速入门</h3><p>Jedis：<a href="https://github.com/redis/jedis">Jedis官网</a></p><p>引入jedis依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>完整依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- jedis依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 测试依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>       </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>以下在<code>Test</code>中进行：</p><ol><li>建立连接</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BeforeEach</span> <span class="comment">//在测试方法执行之前执行的方法</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//建立连接</span></span><br><span class="line">        jedis = <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//设置密码</span></span><br><span class="line">        jedis.auth(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="comment">//选择库</span></span><br><span class="line">        jedis.select(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>测试String类型</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">    jedis.set(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">    System.out.println(jedis.get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>释放资源</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AfterEach</span> <span class="comment">//在测试方法执行之后执行的方法</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (jedis != <span class="literal">null</span>)&#123;</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完整测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Jedis jedis;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span> <span class="comment">//在测试方法执行之前执行的方法</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//建立连接</span></span><br><span class="line">        jedis = <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//设置密码</span></span><br><span class="line">        jedis.auth(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="comment">//选择库</span></span><br><span class="line">        jedis.select(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">        jedis.set(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">        System.out.println(jedis.get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span> &#123;</span><br><span class="line">        jedis.hset(<span class="string">&quot;demo:user:2&quot;</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line">        jedis.hset(<span class="string">&quot;demo:user:2&quot;</span>,<span class="string">&quot;age&quot;</span>,<span class="string">&quot;18&quot;</span>);</span><br><span class="line">        Map&lt;String, String&gt; map = jedis.hgetAll(<span class="string">&quot;demo:user:2&quot;</span>);</span><br><span class="line">        System.out.println(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span> <span class="comment">//在测试方法执行之后执行的方法</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (jedis != <span class="literal">null</span>)&#123;</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jedis使用的基本步骤：</p><blockquote><ol><li><p>引入依赖</p></li><li><p>创建jedis对象，建立连接</p></li><li><p>使用jedis的方法名与Redis命令一致</p></li><li><p>释放资源</p></li></ol></blockquote><h3 id="3-2-Jedis的连接池"><a href="#3-2-Jedis的连接池" class="headerlink" title="3.2 Jedis的连接池"></a>3.2 Jedis的连接池</h3><p>Jedis本身线程是不安全的，并且频繁的创建和销毁连接会有性能损耗，因此推荐使用Jedis连接池替代Jedis的直连方法</p><p>创建<code>JedisConnectionFactory</code>工具类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisConnectionFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> JedisPool jedisPool;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//配置连接池</span></span><br><span class="line">        <span class="type">JedisPoolConfig</span> <span class="variable">jedisPoolConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">        <span class="comment">//最大连接数</span></span><br><span class="line">        jedisPoolConfig.setMaxTotal(<span class="number">8</span>);</span><br><span class="line">        <span class="comment">//最大空闲连接</span></span><br><span class="line">        jedisPoolConfig.setMaxIdle(<span class="number">8</span>);</span><br><span class="line">        <span class="comment">//最小空闲连接</span></span><br><span class="line">        jedisPoolConfig.setMinIdle(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//等待时长</span></span><br><span class="line">        jedisPoolConfig.setMaxWaitMillis(<span class="number">1000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//创建连接池对象</span></span><br><span class="line">        jedisPool = <span class="keyword">new</span> <span class="title class_">JedisPool</span>(jedisPoolConfig, </span><br><span class="line">                <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">                <span class="number">6379</span>, </span><br><span class="line">                <span class="number">1000</span>,</span><br><span class="line">                <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title function_">getJedis</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jedisPool.getResource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Jedis jedis;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span> <span class="comment">//在测试方法执行之前执行的方法</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//建立连接</span></span><br><span class="line">        jedis = JedisConnectionFactory.getJedis();</span><br><span class="line">        <span class="comment">//选择库</span></span><br><span class="line">        jedis.select(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span> &#123;</span><br><span class="line">        jedis.hset(<span class="string">&quot;demo:user:2&quot;</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line">        jedis.hset(<span class="string">&quot;demo:user:2&quot;</span>,<span class="string">&quot;age&quot;</span>,<span class="string">&quot;18&quot;</span>);</span><br><span class="line">        Map&lt;String, String&gt; map = jedis.hgetAll(<span class="string">&quot;demo:user:2&quot;</span>);</span><br><span class="line">        System.out.println(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span> <span class="comment">//在测试方法执行之后执行的方法</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (jedis != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//close方法当检测到是连接池时，并不是真正的关闭连接，而是将对象归还给连接池</span></span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-初识SpringDataRedis"><a href="#3-3-初识SpringDataRedis" class="headerlink" title="3.3 初识SpringDataRedis"></a>3.3 初识SpringDataRedis</h3><p>SpringData是Spring中数据操作的模块，包含对各种数据库的集成，其中对Redis的集成模块就叫做<a href="https://spring.io/projects/spring-data-redis">SpringDataRedis</a></p><blockquote><ul><li>提供了对不同Redis客户端的整合 （Lettuce和Jedis）</li><li>提供了RedisTemplate统一API来操作Redis</li><li>支持Redis的发布订阅模型</li><li>支持Redis哨兵和Redis集群</li><li>支持基于Lettuce的响应式编程</li><li>支持基于JDK、JSON、字符串、Spring对象的数据序列化及反序列化</li><li>支持基于Redis的JDKCollection实现</li></ul></blockquote><p>SpringDataRedis中提供了RedisTemplate工具类，其中封装了各种对Redis的操作。并且将不同数据类型的操作API封装到了不同的类型中：</p><table><thead><tr><th align="center">API</th><th align="center">返回值类型</th><th align="center">解释</th></tr></thead><tbody><tr><td align="center"><span style="color:red">redisTemplate</span>.opsForValue()</td><td align="center">ValueOperations</td><td align="center">操作String类型数据</td></tr><tr><td align="center"><span style="color:red">redisTemplate</span>.opsForHash()</td><td align="center">HashOperations</td><td align="center">操作Hash类型数据</td></tr><tr><td align="center"><span style="color:red">redisTemplate</span>.opsForList()</td><td align="center">ListOperations</td><td align="center">操作List类型数据</td></tr><tr><td align="center"><span style="color:red">redisTemplate</span>.opsForSet()</td><td align="center">SetOperations</td><td align="center">操作Set类型数据</td></tr><tr><td align="center"><span style="color:red">redisTemplate</span>.opsForZSet()</td><td align="center">ZSetOperations</td><td align="center">操作SortedSet类型数据</td></tr><tr><td align="center"><span style="color:red">redisTemplate</span></td><td align="center"></td><td align="center">通用命令</td></tr></tbody></table><h3 id="3-4-SpringDataRedis快速入门"><a href="#3-4-SpringDataRedis快速入门" class="headerlink" title="3.4 SpringDataRedis快速入门"></a>3.4 SpringDataRedis快速入门</h3><p>SpringBoot已经提供了对SpringDataRedis的支持，其中Spring默认支持<code>Lettuce</code>，如需使用<code>Jedis</code>需要额外导入依赖</p><ol><li>导入依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Redis依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>            </span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 连接池依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>配置文件</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span> <span class="comment"># 最大连接数</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span> <span class="comment">#最大空闲连接数</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment">#最小空闲连接数</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">100ms</span> <span class="comment"># 连接等待时间</span></span><br></pre></td></tr></table></figure><ol start="3"><li>注入RedisTemplate，进行测试：</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisTemplateTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//插入一条String类型的数据</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;dahuang&quot;</span>);</span><br><span class="line">        <span class="comment">//获取String类型的数据</span></span><br><span class="line">        System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SpringDataRedis的使用步骤：</p><blockquote><ol><li>引入spring-boot-starter-data-redis依赖</li><li>在application.yml配置Redis以及连接池信息</li><li>注入RedisTemplate</li></ol></blockquote><h3 id="3-5-SpringDataRedis的序列化方式"><a href="#3-5-SpringDataRedis的序列化方式" class="headerlink" title="3.5 SpringDataRedis的序列化方式"></a>3.5 SpringDataRedis的序列化方式</h3><p>RedisTemplate可以接收任意Object作为值写入Redis，只不过写入前会把Object序列化为字节形式，默认采用JDK序列化，刚才存入的数据的结果是这样：</p><p><img src="https://s2.loli.net/2022/07/12/YNlFqgBsVf56Qmh.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/12/YNlFqgBsVf56Qmh.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220712110421745"></p><p>缺点：</p><ul><li><p>可读性差</p></li><li><p>内存占用较大</p></li></ul><p>需要导入jackson依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可以自定义RedisTemplate的序列化方式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span>&#123;</span><br><span class="line">        <span class="comment">//创建RedisTemplate</span></span><br><span class="line">        RedisTemplate&lt;String,Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//设置连接工厂</span></span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="comment">//设置json序列化</span></span><br><span class="line">        <span class="type">GenericJackson2JsonRedisSerializer</span> <span class="variable">gjjrs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>();</span><br><span class="line">        <span class="comment">//设置key的序列化</span></span><br><span class="line">        redisTemplate.setKeySerializer(RedisSerializer.string());</span><br><span class="line">        redisTemplate.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line">        <span class="comment">//设置value的序列化</span></span><br><span class="line">        redisTemplate.setValueSerializer(gjjrs);</span><br><span class="line">        redisTemplate.setHashValueSerializer(gjjrs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建一个实体类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进行测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">redisTemplate.opsForValue().set(<span class="string">&quot;demo:user:3&quot;</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;dahuang&quot;</span>,<span class="number">18</span>));</span><br><span class="line"><span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> (User) redisTemplate.opsForValue().get(<span class="string">&quot;demo:user:3&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;u = &quot;</span> + u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u = User(name=dahuang, age=18)</span><br></pre></td></tr></table></figure></blockquote><p>Redis中的数据：</p><blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.redis.pojo.User&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dahuang&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">18</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="3-6-StringRedisTemplate"><a href="#3-6-StringRedisTemplate" class="headerlink" title="3.6 StringRedisTemplate"></a>3.6 StringRedisTemplate</h3><blockquote><p>尽管json的序列化方式可以满足需求，但仍然存在一些问题</p><p>为了在反序列化时知道对象的类型，json序列化器会将类的class类型写入json结果中，存入Redis，会带来额外的内存开销</p><p>为了节省空间，并不会使用json序列化器来处理value，而是统一使用String序列化器，要求只能存储String类型的key和value</p><p>当存储java对象时，手动完成对象的序列化和反序列化</p></blockquote><pre class="mermaid">graph LR;实体类 --> |手动序列化|json字符串 --> |插入|RedisRedis -->|获取| json字符串 --> |手动反序列化|实体类</pre><p>Spring默认提供了一个SpringRedisTemplate类，它的key和value的序列化方式默认就是String方式。省去了自定义RedisTemplate的过程：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringRedisTemplateTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="comment">//json工具</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testStringTemplate</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;dahei&quot;</span>, <span class="number">22</span>);</span><br><span class="line">        <span class="comment">//手动序列化</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(user);</span><br><span class="line">        <span class="comment">//插入数据</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;demo:user:5&quot;</span>,json);</span><br><span class="line">        <span class="comment">//获取数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;demo:user:5&quot;</span>);</span><br><span class="line">        <span class="comment">//手动反序列化</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> mapper.readValue(val, User.class);</span><br><span class="line">        <span class="comment">//打印user</span></span><br><span class="line">        System.out.println(<span class="string">&quot;u = &quot;</span> + u);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RedisTemplate的两种序列化实践方案：</p><blockquote><p>方案一：</p><ol><li>自定义RedisTemplate</li><li>修改RedisTemplate的序列化器为<code>GenericJackson2JsonRedisSerializer</code></li></ol><p>方案二：</p><ol><li>使用StringRedisTemplate</li><li>写入Redis时，需手动把对象序列化为json</li><li>读取Redis时，手动把读取到的json反序列化为对象</li></ol></blockquote><h3 id="3-7-RedisTemplate操作Hash类型"><a href="#3-7-RedisTemplate操作Hash类型" class="headerlink" title="3.7 RedisTemplate操作Hash类型"></a>3.7 RedisTemplate操作Hash类型</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span> &#123;</span><br><span class="line">    stringRedisTemplate.opsForHash().put(<span class="string">&quot;user:6&quot;</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;dahei&quot;</span>);</span><br><span class="line">    stringRedisTemplate.opsForHash().put(<span class="string">&quot;user:6&quot;</span>,<span class="string">&quot;age&quot;</span>,<span class="string">&quot;22&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    Map&lt;Object, Object&gt; entries = stringRedisTemplate.opsForHash().entries(<span class="string">&quot;user:6&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;entries = &quot;</span> + entries);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="实战篇"><a href="#实战篇" class="headerlink" title="实战篇"></a>实战篇</h1><img src="https://s2.loli.net/2023/01/18/Sh58HXBdImrpz1M.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/18/Sh58HXBdImrpz1M.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230118132725027.png" style="zoom:50%;" /><p>此项目为黑马点评，如需，请搜索黑马程序员获取资源</p><p>项目结构：</p><img src="https://s2.loli.net/2023/01/25/Qr2NipyDwUTHoF3.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/Qr2NipyDwUTHoF3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220715091142486.png" style="zoom:67%;" /><p>application.yaml的配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hmdp</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/hmdp?useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">time-between-eviction-runs:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">jackson:</span></span><br><span class="line">    <span class="attr">default-property-inclusion:</span> <span class="string">non_null</span> <span class="comment"># JSON处理时忽略非空字段</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.hmdp.entity</span> <span class="comment"># 别名扫描包</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.hmdp:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="1-短信登录"><a href="#1-短信登录" class="headerlink" title="1.短信登录"></a>1.短信登录</h2><h3 id="1-1-基于Session实现短信登录流程"><a href="#1-1-基于Session实现短信登录流程" class="headerlink" title="1.1 基于Session实现短信登录流程"></a>1.1 基于Session实现短信登录流程</h3><p><img src="https://s2.loli.net/2023/01/23/xHIL8TmeABuoghM.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/xHIL8TmeABuoghM.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-09-46.png"></p><h3 id="1-2-实现发送短信验证码"><a href="#1-2-实现发送短信验证码" class="headerlink" title="1.2 实现发送短信验证码"></a>1.2 实现发送短信验证码</h3><p>IUserService：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line"></span><br><span class="line">    Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserServiceImpl中实现<code>sendCode</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">//校验手机号</span></span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line">        <span class="comment">//不符合，返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;手机号格式错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//符合，生成验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);</span><br><span class="line">    <span class="comment">//保存验证码到Session</span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;code&quot;</span>,code);</span><br><span class="line">    <span class="comment">//发送验证码，模拟一下</span></span><br><span class="line">    log.debug(<span class="string">&quot;发送验证码成功，验证码为：&quot;</span>+code);</span><br><span class="line">    <span class="comment">//返回OK</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserController：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;code&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(<span class="meta">@RequestParam(&quot;phone&quot;)</span> String phone, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">//发送短信验证码并保存验证码</span></span><br><span class="line">    <span class="keyword">return</span> userService.sendCode(phone, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>日志打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">发送验证码成功，验证码为：608824</span><br></pre></td></tr></table></figure></blockquote><h3 id="1-3-实现短信验证登录与注册"><a href="#1-3-实现短信验证登录与注册" class="headerlink" title="1.3 实现短信验证登录与注册"></a>1.3 实现短信验证登录与注册</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line">    Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span>;</span><br><span class="line">    Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">//校验手机号</span></span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(loginForm.getPhone())) &#123;</span><br><span class="line">        <span class="comment">//不符合，返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;手机号格式错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//校验验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> (String) session.getAttribute(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="literal">null</span> || !code.equals(loginForm.getCode())) &#123;</span><br><span class="line">        <span class="comment">//不一致，返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;验证码错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//一致，查询手机号是否存在</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> query().eq(<span class="string">&quot;phone&quot;</span>, loginForm.getPhone()).one();</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//不存在，插入到数据库，完成注册</span></span><br><span class="line">        user = createUserByPhone(loginForm.getPhone());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存用户到Session</span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">    <span class="comment">//每个session都有唯一的id，不需要登陆凭证</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> User <span class="title function_">createUserByPhone</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setPhone(phone);</span><br><span class="line">    user.setNickName(USER_NICK_NAME_PREFIX + RandomUtil.randomNumbers(<span class="number">10</span>));</span><br><span class="line">    save(user);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> LoginFormDTO loginForm, HttpSession session)</span>&#123;</span><br><span class="line">    <span class="comment">//实现登录功能</span></span><br><span class="line">    <span class="keyword">return</span> userService.login(loginForm,session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-4-实现登录校验拦截器"><a href="#1-4-实现登录校验拦截器" class="headerlink" title="1.4 实现登录校验拦截器"></a>1.4 实现登录校验拦截器</h3><p><strong>隐藏用户敏感信息</strong>：</p><p>调用<code>/user/me</code>接口获取用户信息时，响应中包含了手机号、密码等敏感信息，并且发送的多余信息增加了服务器的压力。所以我们只需要用户昵称、头像和id等的部分信息。</p><p>定义一个UserDto：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDTO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id; <span class="comment">//id</span></span><br><span class="line">    <span class="keyword">private</span> String nickName;<span class="comment">//昵称</span></span><br><span class="line">    <span class="keyword">private</span> String icon;<span class="comment">//头像</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将<code>UserServiceImpl</code>的<code>login</code>方法中存入session的<code>User</code>转换成<code>UserDto</code>类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.setAttribute(<span class="string">&quot;user&quot;</span>, BeanUtil.copyProperties(user, UserDTO.class));</span><br></pre></td></tr></table></figure><p>新建<code>LoginInterceptor</code>拦截器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//获取session</span></span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        <span class="comment">//获取用户信息</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> (UserDTO) session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">//不存在，拦截</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//返回状态码401，未授权</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//存在，保存到TheadLocal</span></span><br><span class="line">        UserHolder.saveUser(user);</span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//移除用户</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新建<code>MvcConfig</code>配置类，添加拦截器并添加排序路径：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .excludePathPatterns( <span class="comment">//排除路径</span></span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>UserController</code>中实现获取用户信息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/me&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">me</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//获取当前登录的用户并返回</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-5-Session共享问题分析"><a href="#1-5-Session共享问题分析" class="headerlink" title="1.5 Session共享问题分析"></a>1.5 Session共享问题分析</h3><p><strong>session共享问题</strong>：多台Tomcat不能共享session存储空间，当请求切换到不同的Tomcat服务器时导致数据对是问题</p><p>session的替代方案应该满足：</p><ul><li><p>数据共享</p></li><li><p>内存存储</p></li><li><p>key、value结构</p></li></ul><p>Redis都能解决以上问题，并且延时低</p><h3 id="1-6-基于Redis实现共享Session登录流程"><a href="#1-6-基于Redis实现共享Session登录流程" class="headerlink" title="1.6 基于Redis实现共享Session登录流程"></a>1.6 基于Redis实现共享Session登录流程</h3><p><img src="https://s2.loli.net/2023/01/23/qM7r9senj8ydT3Y.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/qM7r9senj8ydT3Y.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-09-46.png"></p><p>可以采用String数据类型存储：</p><table><thead><tr><th align="center">key</th><th align="center">value</th></tr></thead><tbody><tr><td align="center">手机号</td><td align="center">验证码</td></tr></tbody></table><p>保存登录用户信息，可以使用<span style="color:red">String结构</span>，以<strong>json字符串</strong>来保存，比较直观</p><p><span style="color:red">Hash结构</span>可以将对象中的每一个字段独立存储，可以针对单个字段做CRUD，并且内存占用少(<span style="color:red">推荐</span>)</p><p>保存用户到Redis：</p><table><thead><tr><th align="center">key</th><th align="center">value</th></tr></thead><tbody><tr><td align="center">随机token为key存储用户数据</td><td align="center">{name:Tom}</td></tr></tbody></table><p>校验登录状态：</p><p><img src="https://s2.loli.net/2023/01/23/7P69spqGOZ4btne.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/7P69spqGOZ4btne.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-09-46.png"></p><h3 id="1-7-基于Redis实现短信登录"><a href="#1-7-基于Redis实现短信登录" class="headerlink" title="1.7 基于Redis实现短信登录*"></a>1.7 基于Redis实现短信登录*</h3><p>修改<code>UserServiceImpl</code>中的<code>sendCode</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span> &#123;</span><br><span class="line"><span class="comment">//校验手机号</span></span><br><span class="line"><span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line"><span class="comment">//不符合，返回错误信息</span></span><br><span class="line"><span class="keyword">return</span> Result.fail(<span class="string">&quot;手机号格式错误&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//符合，生成验证码</span></span><br><span class="line"><span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);</span><br><span class="line"><span class="comment">//保存验证码到Redis，设置有效期</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(RedisConstants.LOGIN_CODE_KEY +phone, <span class="comment">//key</span></span><br><span class="line">code, <span class="comment">//value</span></span><br><span class="line">RedisConstants.LOGIN_CODE_TTL, <span class="comment">// 2</span></span><br><span class="line">TimeUnit.MINUTES);<span class="comment">//指定单位为分钟</span></span><br><span class="line"><span class="comment">//发送验证码，模拟一下</span></span><br><span class="line">log.debug(<span class="string">&quot;发送验证码成功，验证码为：&quot;</span>+code);</span><br><span class="line"><span class="comment">//返回OK</span></span><br><span class="line"><span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改<code>UserServiceImpl</code>中的<code>login</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">        <span class="comment">//校验手机号</span></span><br><span class="line">        <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(loginForm.getPhone())) &#123;</span><br><span class="line">            <span class="comment">//不符合，返回错误信息</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;手机号格式错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//校验验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(RedisConstants.LOGIN_CODE_KEY + loginForm.getPhone());</span><br><span class="line">        <span class="keyword">if</span> (code == <span class="literal">null</span> || !code.equals(loginForm.getCode())) &#123;</span><br><span class="line">            <span class="comment">//不一致，返回错误信息</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;验证码错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//一致，查询手机号是否存在</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> query().eq(<span class="string">&quot;phone&quot;</span>, loginForm.getPhone()).one();</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//不存在，插入到数据库，完成注册</span></span><br><span class="line">            user = createUserByPhone(loginForm.getPhone());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//随机生成登录令牌token，</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//将User对象转成UserDto在转换成Map数据类型</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);</span><br><span class="line">        <span class="comment">//map数据类型的键值对都需要是String类型的</span></span><br><span class="line">        Map&lt;String, Object&gt; userMap = BeanUtil.beanToMap(userDTO,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),</span><br><span class="line">                CopyOptions.create().setIgnoreNullValue(<span class="literal">true</span>) <span class="comment">//忽略空的值</span></span><br><span class="line">                        .setFieldValueEditor((fieldName, fieldValue) -&gt; fieldValue.toString()));<span class="comment">//所有value值转换为String</span></span><br><span class="line">        <span class="comment">//保存用户到Redis</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.LOGIN_USER_KEY + token;</span><br><span class="line">        stringRedisTemplate.opsForHash().putAll(key, userMap);</span><br><span class="line">        <span class="comment">//设置有效期30分钟</span></span><br><span class="line">        stringRedisTemplate.expire(key, <span class="comment">//key</span></span><br><span class="line">                RedisConstants.LOGIN_USER_TTL, <span class="comment">// 30</span></span><br><span class="line">                TimeUnit.MINUTES); <span class="comment">//分钟</span></span><br><span class="line">        <span class="comment">//返回token</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(token);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>MVcConfig</code>配置类中注入<code>StringRedisTemplate</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>(stringRedisTemplate))</span><br><span class="line">                .excludePathPatterns( <span class="comment">//排除路径</span></span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LoginInterceptor</code>中获取Redis中的数据：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LoginInterceptor</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//获取token，前端会将token放入到请求头中</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">            <span class="comment">//返回状态码401，未授权</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取用户信息</span></span><br><span class="line">        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(RedisConstants.LOGIN_USER_KEY + token);</span><br><span class="line">        <span class="comment">//不存在，拦截</span></span><br><span class="line">        <span class="keyword">if</span> (userMap.isEmpty())&#123;</span><br><span class="line">            <span class="comment">//返回状态码401，未授权</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将map转换成UserDto</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(userMap,<span class="keyword">new</span> <span class="title class_">UserDTO</span>(),<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//存在，保存到TheadLocal</span></span><br><span class="line">        UserHolder.saveUser(user);</span><br><span class="line">        <span class="comment">//刷新有效期</span></span><br><span class="line">        stringRedisTemplate.expire(RedisConstants.LOGIN_USER_KEY + token, <span class="comment">//key</span></span><br><span class="line">                RedisConstants.LOGIN_USER_TTL, <span class="comment">// 30</span></span><br><span class="line">                TimeUnit.MINUTES); <span class="comment">//分钟</span></span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//移除用户</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-8-解决状态登录刷新问题"><a href="#1-8-解决状态登录刷新问题" class="headerlink" title="1.8 解决状态登录刷新问题*"></a>1.8 解决状态登录刷新问题*</h3><p><strong>拦截器</strong></p><blockquote><ol><li><p>获取token</p></li><li><p>查询Redis的用户信息</p><p>不存在，则拦截</p><p>存在，则继续</p></li><li><p>保存到ThreadLocal</p></li><li><p>刷新token的有效期</p></li><li><p>放行</p></li></ol></blockquote><p>拦截器只会拦截登录的路径，从而刷新token有效期。</p><p>但是其他的一些不需要登录也可以查看的页面，比如首页，则不会刷新token有效期。</p><p>有可能长时间查看其他页面，导致在查看需要登录的路径，token过了有效期，需要重新登录的问题</p><pre class="mermaid">sequenceDiagram        用户-->>拦截器1:发送请求        note over 拦截器1:拦截一切路径<br>1. 获取token<br>2. 查询Redis的用户<br>3. 保存到ThreadLocal<br>4. 刷新token的有效期<br>5. 放行        拦截器1->>拦截器2:进入        note over 拦截器2:拦截需要登录的路径<br>查看token<br>存在，则拦截<br>不存在，则继续        拦截器2->>UserController:进入</pre><p><code>RefreshTokenInterceptor</code>中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshTokenInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RefreshTokenInterceptor</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//获取token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="comment">//token不存在，直接放行，不添加到ThreadLocal</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取用户信息</span></span><br><span class="line">        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(RedisConstants.LOGIN_USER_KEY + token);</span><br><span class="line">        <span class="comment">//用户信息不存在，直接放行，不添加到ThreadLocal</span></span><br><span class="line">        <span class="keyword">if</span> (userMap.isEmpty())&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将map转换成UserDto</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(userMap,<span class="keyword">new</span> <span class="title class_">UserDTO</span>(),<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//保存到TheadLocal</span></span><br><span class="line">        UserHolder.saveUser(user);</span><br><span class="line">        <span class="comment">//刷新有效期</span></span><br><span class="line">        stringRedisTemplate.expire(RedisConstants.LOGIN_USER_KEY + token, <span class="comment">//key</span></span><br><span class="line">                RedisConstants.LOGIN_USER_TTL, <span class="comment">// 30</span></span><br><span class="line">                TimeUnit.MINUTES); <span class="comment">//分钟</span></span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//移除用户</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LoginInterceptor</code>中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//判断ThreadLocal是否存在用户</span></span><br><span class="line">        <span class="keyword">if</span> (UserHolder.getUser() == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//没有，拦截，设置状态码</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//有用户放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MvcConfig</code>配置类中：</p><ol><li>先进行token刷新拦截，刷新用户有效期；</li><li>再进行登录拦截，判断token是否有效</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">//token刷新拦截器</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">RefreshTokenInterceptor</span>(stringRedisTemplate))</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>) <span class="comment">//拦截所有路径</span></span><br><span class="line">                .order(<span class="number">0</span>); <span class="comment">// 注册顺序为0</span></span><br><span class="line">        <span class="comment">//登录拦截器</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .excludePathPatterns( <span class="comment">//排除路径</span></span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                ).order(<span class="number">1</span>); <span class="comment">//注册顺序为1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="2-商户查询缓存"><a href="#2-商户查询缓存" class="headerlink" title="2.商户查询缓存"></a>2.商户查询缓存</h2><h3 id="2-1-什么是缓存"><a href="#2-1-什么是缓存" class="headerlink" title="2.1 什么是缓存"></a>2.1 什么是缓存</h3><p><strong>缓存</strong>就是数据交换的缓冲区(称作Cache)，是贮存数据的临时地方，一般<strong>读写性能较高</strong></p><pre class="mermaid">graph LR浏览器缓存 --> Tomcat应用层缓存 --> 数据库缓存 --> CPU缓存数据库缓存 --> 磁盘缓存</pre><blockquote><p>缓存的作用</p><ul><li>降低后端的负载</li><li>提高读写效率，降低响应时间</li></ul><p>缓存的成本</p><ul><li>数据一致性成本</li><li>代码维护成本</li><li>运维成本</li></ul></blockquote><h3 id="2-2-添加Redis缓存"><a href="#2-2-添加Redis缓存" class="headerlink" title="2.2 添加Redis缓存"></a>2.2 添加Redis缓存</h3><p>缓存的作用模型：</p><pre class="mermaid">sequenceDiagram        客户端->>Redis:请求        Redis->>客户端:命中(分支1)        Redis->>数据库:未命中(分支2)        数据库->>Redis:写缓存        数据库->>客户端:响应</pre><p>根据id查询商铺缓存的流程：</p><img src="https://s2.loli.net/2023/01/23/Xmb5Qt3y1YSPRfl.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/Xmb5Qt3y1YSPRfl.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-09-46.png" style="zoom:67%;" /><p><code>IShopService</code>创建一个<code>queryById</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IShopService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;Shop&gt; &#123;</span><br><span class="line">    <span class="comment">// ctrl+b转到实现类</span></span><br><span class="line">    Result <span class="title function_">queryById</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>ShopServiceImpl</code>中实现<code>queryById</code>方法，从而实现商铺信息缓存：</p><p>这里选择获取和存储Redis的数据类型为String</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//从Redis查询商铺缓存，Redis数据类型为String</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//判断是否存在，不为null</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//存在，返回信息</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//为null不存在，根据id查询</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//id不存在，返回错误信息</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;店铺不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//id存在，将数据写入Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop));</span><br><span class="line">    <span class="comment">//返回商铺信息</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ShopController</code>中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//通过id获取商铺信息</span></span><br><span class="line">    <span class="keyword">return</span> shopService.queryById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里选择获取和存储Redis的数据类型为Hash</p><h3 id="2-3-缓存更新策略"><a href="#2-3-缓存更新策略" class="headerlink" title="2.3 缓存更新策略"></a>2.3 缓存更新策略</h3><table><thead><tr><th align="center"></th><th align="center">内存淘汰</th><th align="center">超时剔除</th><th>主动更新</th></tr></thead><tbody><tr><td align="center">说明</td><td align="center">不用自己维护，<br>利用Redis的内存淘汰机制，<br>当内存不足时自动淘汰部分数据。<br>下次查询时更新缓存。</td><td align="center">给缓存数据添加TTL时间，<br>到期后自动删除缓存。<br>下次查询时更新缓存。</td><td>编写业务逻辑，<br>在修改数据库的同时，<br>更新缓存。</td></tr><tr><td align="center">一致性</td><td align="center">差</td><td align="center">一般</td><td>好</td></tr><tr><td align="center">维护成本</td><td align="center">无</td><td align="center">低</td><td>高</td></tr></tbody></table><p>业务场景：</p><blockquote><ul><li><p>低一致性需求：</p><p>使用内存淘汰机制。例如：店铺类型的查询缓存</p></li><li><p>高一致性需求：</p><p>主动更新，并以超时剔除为兜底方案。例如：店铺详情查询的缓存</p></li></ul></blockquote><p>主动更新策略：</p><blockquote><ul><li><p>方案一：Cache Aside Pattern(<span style="color:red">可控性高，企业开发常用</span>)</p><p>由缓存的调用者，在更新数据库的同时更新缓存。</p></li><li><p>方案二：Read&#x2F;Write Through Pattern</p><p>缓存与数据库整合为一个服务，由服务来维护一致性。调用者调用该服务，无需关心缓存一致性问题。</p></li><li><p>方案三：Write Behind Caching Pattern</p><p>调用者只操作缓存，由其它线程异步的将缓存数据持久化到数据库，保证最终一致。</p><ul><li><p>说明：</p><p>可以多次修改缓存中的数据，在将缓存的数据一次性更新到数据库中</p><p>如果缓存中的数据未更新到数据库时，出现宕机数据就会完全丢失</p></li></ul></li></ul></blockquote><p>:cherry_blossom:方案一：Cache Aside Pattern</p><blockquote><p>操作缓存和数据库时有三个问题需要考虑：</p><ol><li><p>删除缓存还是更新缓存？</p><ul><li>更新缓存：每次更新数据库都要更新缓存，无效写操作较多:negative_squared_cross_mark:</li><li>删除缓存：更新数据库时让缓存失效，查询时在更新缓存:white_check_mark:</li></ul></li><li><p>如何保证缓存与数据库的操作的同时成功或失败？</p><ul><li>单体系，将缓存与数据库的操作放在一个事务</li><li>分布式系统，利用TTC等分布式事务方案</li></ul></li><li><p>先操作缓存还是先操作数据库？(数据库的数据操作相比Redis的数据操作慢)</p><ul><li><p>先删除缓存，在操作数据库</p><p>异常情况：(<span style="color:red">出现情况高</span>)</p><p><code>线程1</code>删除缓存后，<code>线程2</code>查询缓存未命中，再查询数据库。将数据库中的旧数据又写入了缓存后，<code>线程1</code>才将数据库的数据进行了更新。导致<code>线程2</code>之前拿到的数据库的数据为旧数据。</p></li><li><p>先操作数据库，在删除缓存:cherry_blossom:(胜出)</p><p>异常情况：(<span style="color:red">出现情况低</span>)</p><p><code>线程1</code>查询缓存未命中，再查询数据库获取到旧数据后，<code>线程2</code>这时更新了数据库的数据，删除了缓存后，<code>线程1</code>才开始写入缓存。导致线程1之前拿到的数据库的数据为旧数据。</p></li></ul></li></ol></blockquote><p><span style="color:red">总结</span>：</p><p>缓存更新策略的最佳实践方案</p><blockquote><ol><li><p>低一致性需求：使用Redis自带的内存淘汰机制</p></li><li><p>高一致性需求：主动更新，并以超时剔除为兜底方案</p><ul><li><p>读操作：</p><p>缓存命中直接返回</p><p>缓存未命中则查询数据库，并写入缓存，设置超时时间</p></li><li><p>写操作：</p><p>先写数据库，然后再删除缓存</p><p>要确保数据库与缓存操作的原子性</p></li></ul></li></ol></blockquote><h3 id="2-4-添加缓存更新策略"><a href="#2-4-添加缓存更新策略" class="headerlink" title="2.4 添加缓存更新策略"></a>2.4 添加缓存更新策略</h3><p>给查询商铺的缓存添加<strong>超时剔除</strong>和<strong>主动更新</strong>的策略</p><p>修改ShopController中的业务逻辑，满足一下的需求：</p><blockquote><ol><li>根据id查询店铺时，如果缓存未命中，则查询数据库，将数据库的结果写入缓存，并设置超时时间</li><li>根据id修改店铺时，先修改数据库，在删除缓存</li></ol></blockquote><p>修改<code>ShopServiceImpl</code>中的<code>queryById</code>方法，将写入Redis的数据设置有效期：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//从Redis查询商铺缓存</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//判断是否存在，不为null</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//存在，返回信息</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//为null不存在，根据id查询</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//id不存在，返回错误信息</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;店铺不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//id存在，将数据写入Redis，设置有效期</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, <span class="comment">//key </span></span><br><span class="line">            JSONUtil.toJsonStr(shop), <span class="comment">// value</span></span><br><span class="line">            RedisConstants.CACHE_SHOP_TTL, <span class="comment">// 30</span></span><br><span class="line">            TimeUnit.MINUTES); <span class="comment">//分钟</span></span><br><span class="line">    <span class="comment">//返回商铺信息</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>IShopService</code>中创建<code>update</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IShopService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;Shop&gt; &#123;</span><br><span class="line">    <span class="comment">// ctrl+b转到实现类</span></span><br><span class="line">    Result <span class="title function_">queryById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    Result <span class="title function_">update</span><span class="params">(Shop shop)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ShopServiceImpl</code>中,实现<code>update</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(Shop shop)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> shop.getId();</span><br><span class="line">    <span class="comment">//判断商铺是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;商铺id不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新数据库</span></span><br><span class="line">    updateById(shop);</span><br><span class="line">    <span class="comment">//删除缓存，下次用再取</span></span><br><span class="line">    stringRedisTemplate.delete(RedisConstants.CACHE_SHOP_KEY + id);</span><br><span class="line"><span class="comment">//返回成功信息</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ShopController</code>中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateShop</span><span class="params">(<span class="meta">@RequestBody</span> Shop shop)</span> &#123;</span><br><span class="line">    <span class="comment">//更新数据</span></span><br><span class="line">    <span class="keyword">return</span> shopService.update(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-5-缓存穿透"><a href="#2-5-缓存穿透" class="headerlink" title="2.5 缓存穿透"></a>2.5 缓存穿透</h3><p><strong>缓存穿透</strong>是指客户端请求的数据在缓存中和数据库中都不存在，这样缓存永远不会生效，这些请求到会<strong>多次</strong>打到数据库。(<strong>多次查询不存在的信息，频繁请求数据库，有可能导致数据库崩溃</strong>)</p><p>常见的解决方案有两种：</p><ul><li><p><span style="color:red">缓存空对象</span></p><p>优点：实现简单，维护方便</p><p>缺点：</p><ul><li><p>额外的内存消耗</p></li><li><p>可能造成短期的不一致</p><p>(查询一个id未命中，Redis写入一个空对象，此时数据库插入这个id，导致信息不一致)</p><pre class="mermaid">    sequenceDiagram        客户端->>Redis:请求        note left of Redis:未命中        Redis->>数据库:请求        note left of 数据库:未命中        数据库->>Redis:缓存null<br>设置TTL</pre></li></ul></li><li><p><span style="color:red">布隆过滤</span></p><p>优点：内存占用较少，没有多余的key</p><p>缺点：</p><ul><li><p>实现复杂</p></li><li><p>存在误判可能</p><pre class="mermaid">    sequenceDiagram        客户端->>布隆过滤:请求        布隆过滤->>客户端:拒绝        note left of 布隆过滤:不存在        布隆过滤->>Redis:放行，请求        note left of Redis:存在        Redis->>客户端:返回        note over Redis,客户端:命中        Redis->>数据库:请求        note left of 数据库:未命中        数据库->>Redis:缓存数据        数据库->>客户端:返回数据</pre></li></ul></li></ul><h3 id="2-6-缓存空对象解决缓存穿透"><a href="#2-6-缓存空对象解决缓存穿透" class="headerlink" title="2.6 缓存空对象解决缓存穿透*"></a>2.6 缓存空对象解决缓存穿透*</h3><p>就是将之前判断商铺不存在时，<code>返回404信息</code>改为<code>将空值写入Redis</code></p><img src="https://s2.loli.net/2023/01/23/IQq65lHoPWDVrJt.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/IQq65lHoPWDVrJt.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-02-28.png" style="zoom:67%;" /><p><code>ShopServiceImpl</code>中的<code>queryById</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//从Redis查询商铺缓存</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//判断是否存在，不为null和空字符串&quot;&quot;的情况</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//存在，返回信息</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//命中的是否为空字符串</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;店铺不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//为null不存在，根据id查询</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//id不存在，返回错误信息</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//将空值写入Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key,<span class="comment">//key</span></span><br><span class="line">                <span class="string">&quot;&quot;</span>, <span class="comment">//空值</span></span><br><span class="line">                RedisConstants.CACHE_NULL_TTL,<span class="comment">// 2</span></span><br><span class="line">                TimeUnit.MINUTES); <span class="comment">//分钟</span></span><br><span class="line">        <span class="comment">//返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;店铺不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//id存在，将数据写入Redis，设置有效期</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, <span class="comment">//key</span></span><br><span class="line">            JSONUtil.toJsonStr(shop), <span class="comment">// value</span></span><br><span class="line">            RedisConstants.CACHE_SHOP_TTL, <span class="comment">// 30</span></span><br><span class="line">            TimeUnit.MINUTES); <span class="comment">//分钟</span></span><br><span class="line">    <span class="comment">//返回商铺信息</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>缓存穿透产生的原因是什么？</p><ul><li>用户请求的数据再缓存和数据库中都不存在，不断发起这样的请求，给数据库带来了巨大压力</li></ul><p>缓存穿透的解决方案有哪些？</p><ul><li><p>缓存null值</p></li><li><p>布隆过滤</p></li><li><p>增加id的复杂度，避免被猜到id规律</p></li><li><p>做好数据的基础格式校验</p></li></ul></blockquote><h3 id="2-7-缓存雪崩"><a href="#2-7-缓存雪崩" class="headerlink" title="2.7 缓存雪崩"></a>2.7 缓存雪崩</h3><p><strong>缓存雪崩</strong>是指同一时间<strong>大量的缓存key同时失效</strong>或者<strong>Redis服务宕机</strong>，导致大量请求到达数据库，带来压力。</p><pre class="mermaid">sequenceDiagram        客户端->>Redis:请求        note over Redis:宕机或大量缓存同时失效        Redis->>数据库:大量请求        note left of 数据库:带来巨大压力        数据库->>客户端:返回</pre><p>解决方案：</p><blockquote><ul><li><p>给不同的key的TTL添加随机值</p></li><li><p>利用Redis集群提高服务的可用性</p></li><li><p>给缓存业务添加降级限流策略</p></li><li><p>给业务添加多级缓存</p></li></ul></blockquote><h3 id="2-8-缓存击穿"><a href="#2-8-缓存击穿" class="headerlink" title="2.8 缓存击穿"></a>2.8 缓存击穿</h3><p><strong>缓存击穿问题</strong>也叫<strong>热点Ky问题</strong>，就是一个被<strong>高并发访问</strong>并且<strong>缓存重建业务较复杂的key</strong>突然失效了，无数的请求访问会在瞬间给数据库带来巨大的冲击。(有一个key失效，导致大量同时的多个请求访问数据库)</p><img src="https://s2.loli.net/2023/01/18/hUFzefXO93P8Ca5.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/18/hUFzefXO93P8Ca5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230118144229645.png" style="zoom:67%;" /><p>解决方案：</p><ol><li><p>互斥锁</p><img src="https://s2.loli.net/2023/01/18/FEfBzaUH8sPTnGv.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/18/FEfBzaUH8sPTnGv.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230118144727875.png" style="zoom:67%;" /></li><li><p>逻辑过期</p><p>给热点key设置一个逻辑时效(不在设置TTL，而是在value中添加一个时效字段expire)</p><table><thead><tr><th>KEY</th><th>VALUE</th></tr></thead><tbody><tr><td>heima:user:1</td><td>{name:”Jack”, age: “21”, expire:15214223}</td></tr></tbody></table><img src="https://s2.loli.net/2023/01/18/GSQLMtYvE1suIpX.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/18/GSQLMtYvE1suIpX.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230118145709814.png" style="zoom: 67%;" /></li></ol><table><thead><tr><th>解决方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>互斥锁</td><td>没有额外的内存消耗<br>保证一致性<br>实现简单</td><td>线程需要等待，性能受影响<br>可能有死锁风险</td></tr><tr><td>逻辑过期</td><td>线程无需等待，性能较好</td><td>不保证一致性<br>有额外内存消耗(需要维护expire字段)<br>实现复杂</td></tr></tbody></table><h3 id="2-9基于互斥锁解决缓存击穿"><a href="#2-9基于互斥锁解决缓存击穿" class="headerlink" title="2.9基于互斥锁解决缓存击穿*"></a>2.9基于互斥锁解决缓存击穿*</h3><p>需求：修改根据d查询商铺的业务，基于互斥锁方式来解决缓存击穿问题</p><img src="https://s2.loli.net/2023/01/23/cvf5yoYUrlL6uHR.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/cvf5yoYUrlL6uHR.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-02-28.png" style="zoom:67%;" /><p><strong>使用Redis中的<code>setnx</code>实现互斥锁</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//上锁，只有在key值不存在时，才可以被设置;设置锁时，一般会加上有效期,避免产生死锁</span><br><span class="line">setnx lock 1</span><br><span class="line">//解锁</span><br><span class="line">del lock</span><br></pre></td></tr></table></figure><p><code>ShopServiceImpl</code>中的<code>queryById</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> querySolveCacheBreakdownByMutex(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回商铺信息</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;店铺不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解决缓存击穿，通过互斥锁解决</span></span><br><span class="line"><span class="keyword">private</span> Shop <span class="title function_">querySolveCacheBreakdownByMutex</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//从Redis查询商铺缓存</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//判断是否存在，不为null和空字符串&quot;&quot;的情况</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//存在，返回信息</span></span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//命中的是否为空字符串</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lock</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//尝试获取互斥锁</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lock);</span><br><span class="line">        <span class="comment">//获取失败</span></span><br><span class="line">        <span class="keyword">if</span> (!isLock)&#123;</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="comment">//递归，直到能够获取到shop</span></span><br><span class="line">            <span class="keyword">return</span> querySolveCacheBreakdownByMutex(id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//为null不存在，根据id查询</span></span><br><span class="line">        shop = getById(id);</span><br><span class="line">        <span class="comment">//id不存在，返回错误信息</span></span><br><span class="line">        <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//将空值写入Redis</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(key,<span class="comment">//key</span></span><br><span class="line">                                                  <span class="string">&quot;&quot;</span>, <span class="comment">//空值</span></span><br><span class="line">                                                  RedisConstants.CACHE_NULL_TTL,<span class="comment">// 2</span></span><br><span class="line">                                                  TimeUnit.MINUTES); <span class="comment">//分钟</span></span><br><span class="line">            <span class="comment">//返回空信息</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//id存在，将数据写入Redis，设置有效期</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="comment">//key</span></span><br><span class="line">                                              JSONUtil.toJsonStr(shop), <span class="comment">// value</span></span><br><span class="line">                                              RedisConstants.CACHE_SHOP_TTL, <span class="comment">// 30</span></span><br><span class="line">                                              TimeUnit.MINUTES); <span class="comment">//分钟</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//释放锁，finally的执行早于try里面的return</span></span><br><span class="line">        unlock(lock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    <span class="comment">//尝试获取互斥锁，设置有效时间</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key,</span><br><span class="line">                                                                 <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                                                                 <span class="number">10</span>, <span class="comment">//设置10秒</span></span><br><span class="line">                                                                 TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//判断是否获取锁</span></span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    <span class="comment">//解锁，删除key</span></span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-10-利用逻辑过期解决缓存击穿"><a href="#2-10-利用逻辑过期解决缓存击穿" class="headerlink" title="2.10 利用逻辑过期解决缓存击穿*"></a>2.10 利用逻辑过期解决缓存击穿*</h3><p>需求：修改根据d查询商铺的业务，利用逻辑过期解决缓存击穿问题</p><img src="https://s2.loli.net/2023/01/23/VDKlyLJihvgbE7N.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/23/VDKlyLJihvgbE7N.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-23_23-02-28.png" style="zoom:67%;" /><p><code>Shop类</code>中并没有<code>expireTime字段</code>，在Shop类中添加此字段也是可以的，但是这样就对原来的业务逻辑做了修改。</p><p>可以新建一个<code>RedisData类</code>，添加<code>expireTime字段</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ShopServiceImpl</code>中的<code>queryById</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> querySolveCacheBreakdownByExpireTime(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回商铺信息</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;店铺不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解决缓存击穿，通过逻辑过期解决</span></span><br><span class="line"><span class="keyword">private</span> Shop <span class="title function_">querySolveCacheBreakdownByExpireTime</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//从Redis查询商铺缓存</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">redisDataShopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//判断是否存在，为null和空字符串&quot;&quot;的情况</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(redisDataShopJson)) &#123;</span><br><span class="line">        <span class="comment">//不存在，就不是热点key，一般热点商铺都会提前存入Redis，返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//json转对象</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(redisDataShopJson, RedisData.class);</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);</span><br><span class="line">    <span class="comment">//判断是否过期</span></span><br><span class="line">    <span class="keyword">if</span>(!LocalDateTime.now().isAfter(redisData.getExpireTime()))&#123;</span><br><span class="line">        <span class="comment">//未过期，返回</span></span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">lock</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//获取互斥锁成功</span></span><br><span class="line">    <span class="keyword">if</span>(tryLock(lock))&#123;</span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//注意！需要进行双重检查，因为线程b在线程a重建缓存前，判断shop过期</span></span><br><span class="line">                <span class="comment">//在线程a释放锁后，因为某种原因线程b才开始获取互斥锁，导致重复重建缓存</span></span><br><span class="line">                <span class="comment">//我懒</span></span><br><span class="line">                <span class="comment">//重建缓存</span></span><br><span class="line">                addShop2Redis(shop.getId(), <span class="number">30L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//释放锁</span></span><br><span class="line">                unlock(lock);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//无论是否过期都返回</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//创建线程池</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addShop2Redis</span><span class="params">(Long id, Long expireSeconds)</span>&#123;</span><br><span class="line">    <span class="comment">//查询shop信息</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//封装过期时间</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">    redisData.setData(shop);</span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));</span><br><span class="line">    <span class="comment">//写入Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(</span><br><span class="line">        RedisConstants.CACHE_SHOP_KEY + id,</span><br><span class="line">        JSONUtil.toJsonStr(redisData));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    <span class="comment">//尝试获取互斥锁，设置有效时间</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key,</span><br><span class="line">                                                                 <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                                                                 <span class="number">10</span>, <span class="comment">//设置10秒</span></span><br><span class="line">                                                                 TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//判断是否获取锁</span></span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    <span class="comment">//解锁，删除key</span></span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-11-缓存工具封装"><a href="#2-11-缓存工具封装" class="headerlink" title="2.11 缓存工具封装*"></a>2.11 缓存工具封装*</h3><p>基于StringRedisTemplate封装一个缓存工具类，满足下列需求：</p><ol><li>将任java对象序列化为json并存在string类型的key中，并且可以设置TTL过期时同</li><li>将任意java对象序列化为json并存在string类型的key中，并且可以设置逻辑过期时同，用于处理缓存击穿问题</li><li>根据指定的key查询缓存，并反序列化为指定类型，利用缓存空值的方式解决缓存穿透问题</li><li>根据指定的key查询缓存，并反序列化为指定类型，需要利用逻辑过期解决缓存击穿问题</li></ol><p>创建<code>CacheClient类</code>封装缓存工具：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheClient</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithExpire</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        <span class="comment">//设置逻辑过期</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">        redisData.setData(value);</span><br><span class="line">        redisData.setExpireTime(LocalDateTime.now().plusSeconds(timeUnit.toSeconds(time)));</span><br><span class="line">        <span class="comment">//写入Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//缓存穿透</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, I&gt; T <span class="title function_">queryWithPenetration</span><span class="params">(String keyPrefix,</span></span><br><span class="line"><span class="params">                        I id, Class&lt;T&gt; type,</span></span><br><span class="line"><span class="params">                        Function&lt;I, T&gt; dbFallback,</span></span><br><span class="line"><span class="params">                        Long time, TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//不为null和&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json))&#123;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//为&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(json))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//数据库查询</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">        <span class="comment">//不存在，写入空值</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="built_in">this</span>.set(key, <span class="string">&quot;&quot;</span>, RedisConstants.CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//存在</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, t, time, timeUnit);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//缓存击穿基于互斥锁</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, I&gt; T <span class="title function_">queryWithBreakdownByMutex</span><span class="params">(String keyPrefix,</span></span><br><span class="line"><span class="params">                                              I id, Class&lt;T&gt; type,</span></span><br><span class="line"><span class="params">                                              Function&lt;I, T&gt; dbFallback,</span></span><br><span class="line"><span class="params">                                              Long time, TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="comment">//从Redis查询商铺缓存</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//判断是否存在，不为null和空字符串&quot;&quot;的情况</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//命中的是否为空字符串</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lock</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//尝试获取互斥锁</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lock);</span><br><span class="line">            <span class="comment">//获取失败</span></span><br><span class="line">            <span class="keyword">if</span> (!isLock)&#123;</span><br><span class="line">                Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                <span class="comment">//递归，直到能够获取到shop</span></span><br><span class="line">                <span class="keyword">return</span> queryWithBreakdownByMutex(keyPrefix, id, type, dbFallback, time, timeUnit);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//为null不存在，根据id查询</span></span><br><span class="line">            t = dbFallback.apply(id);</span><br><span class="line">            <span class="comment">//id不存在，返回错误信息</span></span><br><span class="line">            <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//将空值写入Redis</span></span><br><span class="line">                <span class="built_in">this</span>.set(key, <span class="string">&quot;&quot;</span>, RedisConstants.CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//id存在，将数据写入Redis，设置有效期</span></span><br><span class="line">            <span class="built_in">this</span>.set(key, JSONUtil.toJsonStr(t), time, timeUnit);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放锁，finally的执行早于try里面的return</span></span><br><span class="line">            unlock(lock);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//缓存击穿利用逻辑过期</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, I&gt; T <span class="title function_">queryWithBreakdownByExpireTime</span><span class="params">(String keyPrefix,</span></span><br><span class="line"><span class="params">                                              I id, Class&lt;T&gt; type,</span></span><br><span class="line"><span class="params">                                              Function&lt;I, T&gt; dbFallback,</span></span><br><span class="line"><span class="params">                                              Long addTime, TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="comment">//从Redis查询商铺缓存</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">redisDataShopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//判断是否存在，为null和空字符串&quot;&quot;的情况</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(redisDataShopJson)) &#123;</span><br><span class="line">            <span class="comment">//不存在，就不是热点key，一般热点商铺都会提前存入Redis，返回错误信息</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//json转对象</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(redisDataShopJson, RedisData.class);</span><br><span class="line">        <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">        <span class="comment">//判断是否过期</span></span><br><span class="line">        <span class="keyword">if</span>(!LocalDateTime.now().isAfter(redisData.getExpireTime()))&#123;</span><br><span class="line">            <span class="comment">//未过期，返回</span></span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">lock</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="comment">//获取互斥锁成功</span></span><br><span class="line">        <span class="keyword">if</span>(tryLock(lock))&#123;</span><br><span class="line">            CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//注意！需要进行双重检查，因为线程b在线程a重建缓存前，判断shop过期</span></span><br><span class="line">                    <span class="comment">//在线程a释放锁后，因为某种原因线程b才开始获取互斥锁，导致重复重建缓存</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//重建缓存</span></span><br><span class="line">                    <span class="built_in">this</span>.setWithExpire(key, dbFallback.apply(id), addTime, timeUnit);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//释放锁</span></span><br><span class="line">                    unlock(lock);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//无论是否过期都返回</span></span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String lockKey)</span>&#123;</span><br><span class="line">        <span class="comment">//尝试获取互斥锁，设置有效时间</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(lockKey,</span><br><span class="line">                <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="number">10</span>, <span class="comment">//设置10秒</span></span><br><span class="line">                TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//判断是否获取锁</span></span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String lockKey)</span>&#123;</span><br><span class="line">        <span class="comment">//解锁，删除key</span></span><br><span class="line">        stringRedisTemplate.delete(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ShopServiceImpl</code>中的<code>queryById</code>方法中，直接调用<code>CacheClient </code>的方法即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> CacheClient cacheClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//缓存穿透</span></span><br><span class="line">    <span class="comment">/*Shop shop = cacheClient.queryWithPenetration(</span></span><br><span class="line"><span class="comment">                RedisConstants.CACHE_SHOP_KEY,</span></span><br><span class="line"><span class="comment">                id,</span></span><br><span class="line"><span class="comment">                Shop.class,</span></span><br><span class="line"><span class="comment">                this::getById,</span></span><br><span class="line"><span class="comment">                30L, TimeUnit.MINUTES);*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//缓存击穿基于互斥锁</span></span><br><span class="line">    <span class="comment">/*Shop shop = cacheClient.queryWithBreakdownByMutex(</span></span><br><span class="line"><span class="comment">                RedisConstants.CACHE_SHOP_KEY,</span></span><br><span class="line"><span class="comment">                id,</span></span><br><span class="line"><span class="comment">                Shop.class,</span></span><br><span class="line"><span class="comment">                this::getById,</span></span><br><span class="line"><span class="comment">                30L, TimeUnit.SECONDS);*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//缓存击穿利用逻辑过期时间</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> cacheClient.queryWithBreakdownByExpireTime(</span><br><span class="line">        RedisConstants.CACHE_SHOP_KEY,</span><br><span class="line">        id,</span><br><span class="line">        Shop.class,</span><br><span class="line">        <span class="built_in">this</span>::getById,</span><br><span class="line">        <span class="number">30L</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回商铺信息</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;店铺不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="3-优惠券秒杀"><a href="#3-优惠券秒杀" class="headerlink" title="3.优惠券秒杀"></a>3.优惠券秒杀</h2><h3 id="3-1-全局唯一ID"><a href="#3-1-全局唯一ID" class="headerlink" title="3.1 全局唯一ID"></a>3.1 全局唯一ID</h3><p>每个店铺都可以发布优惠券；</p><p>当用户抢购时，就会生成订单并保存到<code>tb_voucher_order</code>这张表中，而订单表如果使用数据库自增ID就存在一些问题：</p><ul><li>id的规律性太明显</li><li>受单表数据量的限制</li></ul><p>全局D生成器，是一种在分布式系统下用来生成全局唯一ID的工具，一般要满足下列特性：</p><ul><li>唯一性</li><li>高可用</li><li>高性能</li><li>递增性</li><li>安全性</li></ul><p>为了增加ID的安全性，我们可以不直接使用Redis自增的数值，而是拼接一些其它信息：</p><p><img src="https://s2.loli.net/2023/01/24/mVndfKosv1MWEOi.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/24/mVndfKosv1MWEOi.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-24_23-06-42.png"></p><p>ID的组成部分：</p><ul><li>符号位：1bit，永远为0</li><li>时间戳：31bt，以秒为单位，可以使用69年</li><li>序列号：32bit，秒内的计数器，支持每秒产生2^32个不同ID</li></ul><h3 id="3-2-Redis实现全局唯一ID"><a href="#3-2-Redis实现全局唯一ID" class="headerlink" title="3.2 Redis实现全局唯一ID*"></a>3.2 Redis实现全局唯一ID*</h3><p>创建<code>RedisIdWorker类</code>实现全局唯一ID：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="comment">//起始时间戳为2023/1/1 00:00:00</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">START_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1672531200L</span>;</span><br><span class="line">    <span class="comment">//序列号位数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SN</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdWorker</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span>&#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="comment">//获取当前时间戳</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="comment">//获取时间戳</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> current - START_TIMESTAMP;</span><br><span class="line">        <span class="comment">//获取今天的日期</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Redis自增，生成今天的序列号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;inc:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + date;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">increment</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//拼接时间戳和序列号</span></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; SN | increment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>全局唯一D生成策略：</p><ul><li>UUID</li><li>Redis自增</li><li>snowflake算法</li><li>数据库自增</li></ul><p>Redis自增ID策略：</p><ul><li>每天一个key，方便统计订单量</li><li>ID构造为时间戳+序列号</li></ul></blockquote><h3 id="3-3-添加优惠券"><a href="#3-3-添加优惠券" class="headerlink" title="3.3 添加优惠券"></a>3.3 添加优惠券</h3><p>每个店铺都可以发布优惠券，分为平价券和特价券。平价券(折扣小)可以任意购买，而特价券(折扣大)需要秒杀抢购：</p><p>表关系如下：</p><ul><li>tb_voucher：优惠券的基本信息，优惠金额、使用规则等</li><li>tb_seckill_voucher：优惠券的库存、开始抢购时间，结束抢购时间。<strong>特价优惠券才需要填写这些信息</strong></li></ul><p>添加特价优惠券业务逻辑：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherMapper, Voucher&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">        <span class="comment">// 保存优惠券，mybatis-plus在执行save方法后自动返回ID</span></span><br><span class="line">        save(voucher);</span><br><span class="line">        <span class="comment">// 保存秒杀信息</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">        seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">        seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">        seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">        seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">        seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加特价优惠券需要后台添加，可以使用postman模拟：</p><img src="https://s2.loli.net/2023/01/25/fZhVujRP6FcMiON.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/fZhVujRP6FcMiON.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png" style="zoom: 67%;" /><h3 id="3-4-实现优惠券秒杀下单"><a href="#3-4-实现优惠券秒杀下单" class="headerlink" title="3.4 实现优惠券秒杀下单"></a>3.4 实现优惠券秒杀下单</h3><p>下单时需要判断两点：</p><ul><li>秒杀是否开始或结束，如果尚未开始或已经结束则无法下单</li><li>库存是否充足，不足则无法下单</li></ul><img src="https://s2.loli.net/2023/01/25/UZpBnJM4FyVqXT5.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/UZpBnJM4FyVqXT5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png" style="zoom:67%;" /><p>实现<code>VoucherOrderServiceImpl</code>中的<code>seckillVoucher</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">//查询优惠券</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">//判断时间</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;未在规定时间内&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检查库存</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//减扣库存</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建订单</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="comment">//返回订单id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-5-库存超卖问题分析"><a href="#3-5-库存超卖问题分析" class="headerlink" title="3.5 库存超卖问题分析"></a>3.5 库存超卖问题分析</h3><p>在高并发的场景下，或可能会导致库存数量变为负数，发生库存超卖的情况：</p><img src="https://s2.loli.net/2023/01/25/hB3SdaQpcP1MtqX.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/hB3SdaQpcP1MtqX.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png" style="zoom:67%;" /><p>超卖问题是典型的多线程安全问题，针对这一问题的常见解决方案就是加锁：</p><blockquote><p><strong>悲观锁</strong>：认为线程安全问题<strong>一定</strong>会发生，因此在操作数据之前先获取锁，确保线程串行执行。</p><ul><li>例如Synchronized、Lock都属于悲观锁</li></ul><p><strong>乐观锁</strong>：认为线程安全问题<strong>不一定</strong>会发生，因此不加锁，只是在更新数据时去判断有没有其它线程对数据做了修改。</p><ul><li>如果没有修改则认为是安全的，自己才更新数据。</li><li>如果已经被其它线程修改说明发生了安全问题，此时可以重试或异常。</li></ul></blockquote><p><strong>CAS法</strong>：</p><img src="https://s2.loli.net/2023/01/25/bcOnadB2UuNXmyW.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/bcOnadB2UuNXmyW.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png" style="zoom:67%;" /><p>修改sql语句即可：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> stock <span class="operator">=</span> stock <span class="operator">-</span> <span class="number">1</span> <span class="keyword">where</span> voucher_id <span class="operator">=</span> ? <span class="keyword">and</span> stock <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure><h3 id="3-6-乐观锁解决超卖问题"><a href="#3-6-乐观锁解决超卖问题" class="headerlink" title="3.6 乐观锁解决超卖问题*"></a>3.6 乐观锁解决超卖问题*</h3><p>修改<code>VoucherOrderServiceImpl</code>中的<code>seckillVoucher</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//查询优惠券</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//判断时间</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;未在规定时间内&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//检查库存</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//减扣库存</span></span><br><span class="line">    <span class="comment">//set stock = stock-1 where voucher_id = ? and stock = ?</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">        .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">        .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">        .eq(<span class="string">&quot;stock&quot;</span>, voucher.getStock())</span><br><span class="line">        .update();</span><br><span class="line">    <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建订单</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="comment">//返回订单id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>但是这样做，在高并发的情况下，例如：库存有100个、此时有100线程同时秒杀，会导致只有一个线程秒杀成功，其余99个线程均失败，<strong>失败率过高</strong></p></blockquote><p>可以改为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> stock <span class="operator">=</span> stock <span class="operator">-</span> <span class="number">1</span> <span class="keyword">where</span> voucher_id <span class="operator">=</span> ? <span class="keyword">and</span> stock <span class="operator">&gt;</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>再次修改<code>VoucherOrderServiceImpl</code>中的<code>seckillVoucher</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//查询优惠券</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//判断时间</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;未在规定时间内&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//检查库存</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//减扣库存</span></span><br><span class="line">    <span class="comment">//set stock = stock-1 where voucher_id = ? and stock &gt; 0</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">        .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">        .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">        .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        .update();</span><br><span class="line">    <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建订单</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="comment">//返回订单id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>超卖这样的线程安全问题，解决方案：</p><ul><li>悲观锁：添加同步锁，让线程串行执行<ul><li>优点：简单粗暴</li><li>缺点：性能一般</li></ul></li><li>乐观锁：不加锁，在更新时判断是否有其它线程在修改<ul><li>优点：性能好</li><li>缺点：存在成功率低的问题</li></ul></li></ul></blockquote><h3 id="3-7-实现一人一单功能"><a href="#3-7-实现一人一单功能" class="headerlink" title="3.7 实现一人一单功能*"></a>3.7 实现一人一单功能*</h3><p>需求：修改秒杀业务，要求同一个优惠券，一个用户只能下一单</p><img src="https://s2.loli.net/2023/01/25/2JIwgTADmxMrKlZ.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/2JIwgTADmxMrKlZ.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png" style="zoom:67%;" /><p>添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>添加注解，开启暴露代理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAspectJAutoProxy(exposeProxy = true)</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.hmdp.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HmDianPingApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HmDianPingApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;、</span><br></pre></td></tr></table></figure><p>修改<code>VoucherOrderServiceImpl</code>的<code>seckillVoucher</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">//查询优惠券</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">//判断时间</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;未在规定时间内&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检查库存</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//intern()方法:如果字符串常量池中已经存在一个等于此String对象的字符串，就直接从常量池中返回这个字符串对象的引用</span></span><br><span class="line">        <span class="comment">//字符串常量池中不存在这个字符串对象，那么就新建并添加这个字符串对象到字符串常量池中，并返回新建的字符串对象的引用</span></span><br><span class="line">        <span class="comment">//锁住userId相同地请求，应该先提交事务，再释放锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">            <span class="comment">//this调用会导致事务不生效，可以通过AopContext获取到Proxy对象,从而实现代理.</span></span><br><span class="line">            <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">//检查一人一单</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;用户已经购买过了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//减扣库存</span></span><br><span class="line">        <span class="comment">//set stock = stock-1 where voucher_id = ? and stock &gt; 0</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建订单</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="comment">//返回订单id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-8-一人一单的并发安全问题"><a href="#3-8-一人一单的并发安全问题" class="headerlink" title="3.8 一人一单的并发安全问题"></a>3.8 一人一单的并发安全问题</h3><p>通过加锁可以解决在<strong>单机情况</strong>下的一人一单安全问题，但是在<strong>集群模式</strong>下就不行了。</p><ol><li><p>我们将服务启动两份，端口分别为<strong>8081</strong>和<strong>8082</strong></p></li><li><p>然后修改nginx的conf目录下的nginx.conf文件，配置反向代理和负载均衡：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">server 127.0.0.1:8081 max_fails=5 fail_timeout=10s weight=1;</span><br><span class="line">server 127.0.0.1:8082 max_fails=5 fail_timeout=10s weight=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>用户请求会在这两个节点上负载均衡，再次测试下是否存在线程安全问题。</p></li></ol><p>两个服务(两个进程)，导致锁失效：</p><p><img src="https://s2.loli.net/2023/01/25/Cb5c8MTFtgAQS9x.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/Cb5c8MTFtgAQS9x.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png"></p></div><div class="story post-story"><h2 id="4-分布式锁"><a href="#4-分布式锁" class="headerlink" title="4.分布式锁"></a>4.分布式锁</h2><h3 id="4-1-分布式锁的基本原理"><a href="#4-1-分布式锁的基本原理" class="headerlink" title="4.1 分布式锁的基本原理"></a>4.1 分布式锁的基本原理</h3><p><img src="https://s2.loli.net/2023/01/25/ImCMd7VriUjOu5w.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/25/ImCMd7VriUjOu5w.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-25_15-48-59.png"></p><p><strong>分布式锁</strong>：满足分布式系统或集群模式下多进程可见并且互斥的锁。</p><ul><li>多进程可见</li><li>互斥</li><li>高可用</li><li>高性能</li><li>安全性</li></ul><p>分布式锁的核心是实现多进程之间互斥，而满足这一点的方式有很多，常见的有三种：</p><table><thead><tr><th></th><th>MySQL</th><th>Redis</th><th>Zookeeper</th></tr></thead><tbody><tr><td>互斥</td><td>利用mysql本身的互斥锁机制</td><td>利用setnxi这样的互斥命令</td><td>利用节点的唯一性和有序性实现互斥</td></tr><tr><td>高可用</td><td>好</td><td>好</td><td>好</td></tr><tr><td>高性能</td><td>一般</td><td>好</td><td>一般</td></tr><tr><td>安全性</td><td>断开连接，自动释放锁</td><td>利用锁超时时间，到期释放</td><td>临时节点，断开连接自动释放</td></tr></tbody></table><h3 id="4-2-Redis分布式锁实现思路"><a href="#4-2-Redis分布式锁实现思路" class="headerlink" title="4.2 Redis分布式锁实现思路"></a>4.2 Redis分布式锁实现思路</h3><p>实现分布式锁时需要实现的两个基本方法：</p><ul><li><p>获取锁：</p><ul><li><p>互斥：确保只能有一个线程获取锁</p></li><li><p>非阻塞：尝试一次，成功返回true，失败返回false</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">流加锁，利用setnx的互斥特性</span></span><br><span class="line">SETNX lock thread1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加锁过期时间，避免服务宕机引起的死锁</span></span><br><span class="line">EXPIRE lock 10</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">==&gt;</span></span><br><span class="line">SET lock thread1 NX EX 10</span><br></pre></td></tr></table></figure></li></ul></li><li><p>释放锁：</p><ul><li><p>手动释放</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">释放锁，删除即可</span></span><br><span class="line">DEL key</span><br></pre></td></tr></table></figure></li><li><p>超时释放：获取锁时添加一个超时时间</p></li></ul></li></ul><img src="https://s2.loli.net/2023/01/28/tyvABwoPWT4Gn2e.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/28/tyvABwoPWT4Gn2e.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-28_19-17-46.png" style="zoom:67%;" /> <h3 id="4-3-实现Redis分布式锁"><a href="#4-3-实现Redis分布式锁" class="headerlink" title="4.3 实现Redis分布式锁"></a>4.3 实现Redis分布式锁</h3><p>需求：定义一个类，实现下面接口，利用Redis实现分布式锁功能。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line">    <span class="comment">//尝试获取锁，设置过期时间</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span>;</span><br><span class="line">    <span class="comment">//释放锁</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现ILock接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="comment">//业务名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String businessName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String businessName, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.businessName = businessName;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//获取线程标识</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + businessName, String.valueOf(value), timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(KEY_PREFIX + businessName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改<code>VoucherOrderServiceImpl</code>中的<code>seckillVoucher</code>方法业务逻辑：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//查询优惠券</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//判断时间</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;未在规定时间内&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//检查库存</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//创建锁对象</span></span><br><span class="line">    <span class="type">SimpleRedisLock</span> <span class="variable">isLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRedisLock</span>(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line">    <span class="comment">//尝试获取锁</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> isLock.tryLock(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span> (!flag)&#123;</span><br><span class="line">        <span class="comment">//获取锁失败，返回错误</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;不允许重复下单&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取锁成功</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//this调用会导致事务不生效，可以通过AopContext获取到Proxy对象,从而实现代理.</span></span><br><span class="line">        <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="comment">//生成一人一单的订单</span></span><br><span class="line">        <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//释放锁</span></span><br><span class="line">        isLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-Redis分布式锁误删问题"><a href="#4-4-Redis分布式锁误删问题" class="headerlink" title="4.4 Redis分布式锁误删问题"></a>4.4 Redis分布式锁误删问题</h3><img src="https://s2.loli.net/2023/01/28/4NxZewbU1j8WkgH.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/28/4NxZewbU1j8WkgH.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-28_19-17-46.png" style="zoom:67%;" /><img src="https://s2.loli.net/2023/01/28/CNPvc9AgR8J1Xmx.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/28/CNPvc9AgR8J1Xmx.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-28_19-17-46.png" style="zoom: 67%;" /><p>需求：修改之前的分布式锁实现，满足：</p><ol><li>在获取锁时存入线程标示(可以用UUID表示)</li><li>在释放锁时先获取锁中的线程标示，判断是否与当前线程标示一致<ul><li>如果一致则释放锁</li><li>如果不一致则不释放锁</li></ul></li></ol><p>修改<code>SimpleRedisLock</code>类，添加线程标示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line">    <span class="comment">//业务名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String businessName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String businessName, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.businessName = businessName;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//获取线程标识</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + businessName, value, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//获取当前线程标示</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">//获取value值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + businessName);</span><br><span class="line">        <span class="comment">//判断是否为当前线程的锁</span></span><br><span class="line">        <span class="keyword">if</span>(value.equals(result))&#123;</span><br><span class="line">            stringRedisTemplate.delete(KEY_PREFIX + businessName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-5-分布式锁的原子性问题"><a href="#4-5-分布式锁的原子性问题" class="headerlink" title="4.5 分布式锁的原子性问题"></a>4.5 分布式锁的原子性问题</h3><img src="https://s2.loli.net/2023/01/28/TPewK3VD6M5vho8.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/28/TPewK3VD6M5vho8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-28_19-17-46.png" style="zoom:67%;" /><p>在释放锁时，判断是否一致时，因为某种原因导致阻塞，经过一段时间后才释放锁，产生的原子性问题</p><p>判断是否一致时和释放锁，应该绑定在一起执行</p><h3 id="4-6-lua脚本解决多条命令原子性问题"><a href="#4-6-lua脚本解决多条命令原子性问题" class="headerlink" title="4.6 lua脚本解决多条命令原子性问题"></a>4.6 lua脚本解决多条命令原子性问题</h3><p>Redis:提供了Lua脚本功能，在一个脚本中编写多条Redisi命令，确保多条命令执行时的原子性。Lua是一种编<br>程语言，它的基本语法大家可以参考网站：<a href="https://www.runoob.com/lua/lua-tutorial.html">Lua教程|菜鸟教程</a></p><p>这里重点介绍Redis提供的调用函数，语法如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--执行redis命令</span></span><br><span class="line">redis.call(<span class="string">&#x27;命令名称&#x27;</span>, <span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;其它参数&#x27;</span>, ...)</span><br></pre></td></tr></table></figure><p>例如：我们要执行<code>set name jack</code>，则脚本是这样：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--执行set name jack</span></span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br></pre></td></tr></table></figure><p>例如，我们要先执行<code>set name Rose</code>，再执行<code>get name</code>，则脚本如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--先执行set name jack</span></span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br><span class="line"><span class="comment">--再执行get name</span></span><br><span class="line"><span class="keyword">local</span> name redis.call(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"><span class="comment">--返回</span></span><br><span class="line"><span class="keyword">return</span> name</span><br></pre></td></tr></table></figure><p>写好脚本以后，需要用Redis命令来调用脚本，调用脚本的常见命令如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt;help @scripting</span><br><span class="line"></span><br><span class="line">EVAL script numkeys key [key ...] arg [arg ...]</span><br><span class="line">summary: Execute a Lua script server side</span><br><span class="line">since: 2.6.0</span><br></pre></td></tr></table></figure><p>例如，我们要执行<code>redis.call(&#39;set&#39;, &#39;name&#39;, &#39;jack&#39;)</code>这个脚本，语法如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">调用脚本，脚本内容、需要key参数的个数</span></span><br><span class="line">EVAL &quot;return redis.call(&#x27;set&#x27;,&#x27;name&#x27;,&#x27;jack&#x27;)&quot; 0</span><br></pre></td></tr></table></figure><p>如果脚本中的key、value不想写死，可以作为参数传递。key类型参数会放入KEYS数组，其它参数会放入ARGV数组，在脚本中可以从KEYS和ARGV数组获取这些参数：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">调用脚本</span></span><br><span class="line">EVAL &quot;return redis.call(&#x27;set&#x27;,KEYS[1],ARGV[1])&quot; 1 name Rose</span><br></pre></td></tr></table></figure><p>释放锁的业务流程：</p><ol><li>获取锁中的线程标示</li><li>判断是否与指定的标示(当前线程标示)一致</li><li>如果一致则释放锁(删除)</li><li>如果不一致则什么都不做</li></ol><p>用Lua脚本实现：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--这里的KEYS[1]就是锁的key，这里的ARGV[1]就是当前线程标示</span></span><br><span class="line"><span class="comment">--获取锁中的标示，判断是否与当前线程标示一致</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;GET&#x27;</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line"><span class="comment">--一致，则删除锁</span></span><br><span class="line"><span class="keyword">return</span> redis.call(<span class="string">&#x27;DEL&#x27;</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--不一致，则直接返回</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="4-7-java调用lua脚本改进分布式锁"><a href="#4-7-java调用lua脚本改进分布式锁" class="headerlink" title="4.7 java调用lua脚本改进分布式锁"></a>4.7 java调用lua脚本改进分布式锁</h3><p>需求：基于Lua脚本实现分布式锁的释放锁逻辑</p><p>提示：RedisTemplate调用Lua脚本的API如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">execute</span><span class="params">(RedisScript&lt;T&gt; script, List&lt;K&gt; keys, Object... args)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.scriptExecutor.execute(script, keys, args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在resources资源包中创建lua脚本<code>unlock.lua</code>：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--这里的KEYS[1]就是锁的key，这里的ARGV[1]就是当前线程标示</span></span><br><span class="line"><span class="comment">--获取锁中的标示，判断是否与当前线程标示一致</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;GET&#x27;</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line"><span class="comment">--一致，则删除锁</span></span><br><span class="line"><span class="keyword">return</span> redis.call(<span class="string">&#x27;DEL&#x27;</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--不一致，则直接返回</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>再次改进<code>SimpleRedisLock</code>类中的<code>unlock</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line">    <span class="comment">//初始化lua脚本</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/unlock.lua&quot;</span>));</span><br><span class="line">        UNLOCK_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//业务名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String businessName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String businessName, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.businessName = businessName;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//获取线程标识</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + businessName, value, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//获取当前线程标示</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">//调用lua脚本</span></span><br><span class="line">        stringRedisTemplate.execute(</span><br><span class="line">                UNLOCK_SCRIPT,</span><br><span class="line">                Collections.singletonList(KEY_PREFIX + businessName),</span><br><span class="line">                value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基于Redis的分布式锁实现思路：</p><ul><li>利用<code>set nx ex</code>获取锁，并设置过期时间，保存线程标示</li><li>释放锁时先判断线程标示是否与自己一致，一致则删除锁</li></ul><p>特性：</p><ul><li>利用<code>set nx</code>满足互斥性</li><li>利用<code>set ex</code>保证故障时锁依然能释放，避免死锁，提高安全性</li><li>利用Redis集群保证高可用和高并发特性</li></ul><h3 id="4-8-Redisson功能介绍"><a href="#4-8-Redisson功能介绍" class="headerlink" title="4.8 Redisson功能介绍"></a>4.8 Redisson功能介绍</h3><p>基于<code>setnx</code>实现的分布式锁存在下面的问题：</p><ul><li><p>不可重入</p><ul><li>同一个线程无法多次获取同一把锁</li></ul></li><li><p>不可重试</p><ul><li>获取锁只尝试一次就返回false，没有重试机制</li></ul></li><li><p>超时释放</p><ul><li>锁超时释放虽然可以避免死锁，但如果是业务执行耗时较长，也会导致锁释放，存在安全隐思</li></ul></li><li><p>主从一致性</p><ul><li>如果Redis提供了主从集群，主从同步存在延迟，当主机宕机时，如果从并同步主中的锁数据，则会出现锁实现</li></ul></li></ul><p><a href="https://github.com/redisson/redisson">Redisson</a>是一个在Redis的基础上实现的java驻内存数据网格(In-Memory Data Grid)。它不仅提供了一系列的分布式的java常用对象，还提供了许多分布式服务，其中就包含了各种分布式锁的实现。</p><p>分布式锁(Lock)和同步器(Synchronizer)：</p><ol><li>可重入锁(Reentrant Lock)</li><li>公平锁(Fair Lock)</li><li>联锁(MultiLock)</li><li>红锁(RedLock)</li><li>读写锁(ReadWriteLock)</li><li>信号量(Semaphore)</li><li>可过期性信号量(PermitExpirableSemaphore)</li><li>闭锁(CountDownLatch)</li></ol><h3 id="4-9-Redisson快速入门"><a href="#4-9-Redisson快速入门" class="headerlink" title="4.9 Redisson快速入门"></a>4.9 Redisson快速入门</h3><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.19.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br></pre></td></tr></table></figure></li><li><p>配置Redisson客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//配置类</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">//添加redis地址，这里添加了单点的地址，也可以使用config.useClusterServers()添加集群地址</span></span><br><span class="line">        config.useSingleServer()</span><br><span class="line">            .setAddress(<span class="string">&quot;redis://192.168.150.101:6379&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">//创建客户端</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>测试，使用Redisson的分布式锁</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">//获取锁（可重入），指定锁的名称</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;anyLock&quot;</span>);</span><br><span class="line">    <span class="comment">//尝试获取锁，参数分别是：获取锁的最大等待时间（期间会重试），锁自动释放时间，时间单位</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>,<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//判断释放获取成功</span></span><br><span class="line">    <span class="keyword">if</span>(isLock) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;执行业务&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放锁</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>再次修改<code>VoucherOrderServiceImpl</code>的<code>seckillVoucher</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//查询优惠券</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//判断时间</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span>(now.isBefore(voucher.getBeginTime()) || now.isAfter(voucher.getEndTime()) )&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;未在规定时间内&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//检查库存</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//创建锁对象</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">isLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">    <span class="comment">//尝试获取锁</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> isLock.tryLock();</span><br><span class="line">    <span class="keyword">if</span> (!flag)&#123;</span><br><span class="line">        <span class="comment">//获取锁失败，返回错误</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;不允许重复下单&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取锁成功</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//this调用会导致事务不生效，可以通过AopContext获取到Proxy对象,从而实现代理.</span></span><br><span class="line">        <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="comment">//生成一人一单的订单</span></span><br><span class="line">        <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//释放锁</span></span><br><span class="line">        isLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-10-Redisson可重入锁原理"><a href="#4-10-Redisson可重入锁原理" class="headerlink" title="4.10 Redisson可重入锁原理"></a>4.10 Redisson可重入锁原理</h3><p>可重入锁采用的数据结构为hash：</p><table><thead><tr><th><span style="color:red">KEY</span></th><th><span style="color:red">VALUE</span></th><th><span style="color:red">VALUE</span></th></tr></thead><tbody><tr><td></td><td><span style="color:brown">field</span></td><td><span style="color:brown">value</span></td></tr><tr><td>lock</td><td>Thread1</td><td>0</td></tr></tbody></table><img src="https://s2.loli.net/2023/01/29/pORBwjfb6o39gql.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/29/pORBwjfb6o39gql.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png" style="zoom:67%;" /><p>获取锁的Lua脚本：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>];<span class="comment">--锁的key</span></span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">1</span>];<span class="comment">--线程唯一标识</span></span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>];<span class="comment">--锁的自动释放时阅</span></span><br><span class="line"><span class="comment">--判断是否存在</span></span><br><span class="line"><span class="keyword">if</span>(redis.call(<span class="string">&#x27;exists&#x27;</span>,key) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line"><span class="comment">--不存在，获取锁</span></span><br><span class="line">redis.call(<span class="string">&#x27;hset&#x27;</span>,key,threadId,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="comment">--设置有效期</span></span><br><span class="line">redis.call(<span class="string">&#x27;expire&#x27;</span>,key,releaseTime);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;<span class="comment">--返回结果</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">--锁已经存在，判断hreadId,是否是自己</span></span><br><span class="line"><span class="keyword">if</span>(redis.call(<span class="string">&#x27;hexists&#x27;</span>,key,threadId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line"><span class="comment">--不存在，获取锁重入次数+1</span></span><br><span class="line">redis.call(<span class="string">&#x27;hincrby&#x27;</span>,key,threadId,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="comment">--设置有效期</span></span><br><span class="line">redis.call(<span class="string">&#x27;expire&#x27;</span>,key,releaseTime);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;<span class="comment">--返回结果</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;<span class="comment">--代码走到这里，说明获取锁的不是自己，获取锁失败</span></span><br></pre></td></tr></table></figure><p>释放锁的Lua脚本：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>];<span class="comment">--key</span></span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">1</span>];<span class="comment">--线程唯-标识</span></span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>];<span class="comment">--锁的自动释放时间</span></span><br><span class="line"><span class="comment">--判断当前锁是否还是被自己特有</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;HEXISTS&#x27;</span>,key,threadId) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>;<span class="comment">--如果已经不是自己，则直接返回</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">--是自己的锁，则重入次数-1</span></span><br><span class="line">Local count redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>,key,threadId,<span class="number">-1</span>);</span><br><span class="line"><span class="comment">--判断是否重入次数是否已经为0</span></span><br><span class="line"><span class="keyword">if</span> (count &gt; <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line"><span class="comment">--大于0说明不能释放锁，重置有效期然后返回</span></span><br><span class="line">redis.call(EXPIRE<span class="string">&#x27;,key,releaseTime);</span></span><br><span class="line"><span class="string">return nil;</span></span><br><span class="line"><span class="string">else --等于0说明可以释放锁，直接删除</span></span><br><span class="line"><span class="string">redis.call(&#x27;</span>DEL<span class="string">&#x27;,key);</span></span><br><span class="line"><span class="string">return nil;</span></span><br><span class="line"><span class="string">end;</span></span><br></pre></td></tr></table></figure><p>可重入锁原理测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建锁对象</span></span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;Lock&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//业务1</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="type">boolean</span> isLock lock.tryLock();</span><br><span class="line"><span class="keyword">if</span>(!isLock) &#123;</span><br><span class="line">log.error(<span class="string">&quot;获取锁失败，1&quot;</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;获取锁成功，1&quot;</span>);</span><br><span class="line"><span class="comment">//执行业务2</span></span><br><span class="line">            method2();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;释放锁，1&quot;</span>);</span><br><span class="line">lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//业务2</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="type">boolean</span> isLock lock.tryLock();</span><br><span class="line"><span class="keyword">if</span>(!isLock)&#123;</span><br><span class="line">log.error(<span class="string">&quot;获取锁失败，2&quot;</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;获取锁成功，2&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;释放锁，2&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>执行业务1，检查Redis中所是否存在ThreadId</p><ul><li>如果存在，则ThreadId对应的Value值+1，此时变为1</li><li>如果不存在，创建TheadId，再将ThreadId对应的Value值+1，此时变为1</li></ul><p>之后调用业务2，Redis中所对应的ThreadId的Value值+2，此时变为2</p><p>同时业务1完成，释放锁，Redis中所对应的ThreadId的Value值-1，此时又变为1</p><p>之后业务2完成，释放锁，Redis中所对应的ThreadId的Value值-1，此时又变为0</p><p>如果变为0，则删除此key</p></blockquote><h3 id="4-11-Redisson锁重试和WatchDog机制？？？？？？"><a href="#4-11-Redisson锁重试和WatchDog机制？？？？？？" class="headerlink" title="4.11 Redisson锁重试和WatchDog机制？？？？？？"></a>4.11 Redisson锁重试和WatchDog机制？？？？？？</h3><p><img src="https://s2.loli.net/2023/01/29/HKLQMA8PkdaFeh2.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/29/HKLQMA8PkdaFeh2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"></p><h3 id="4-12-Redisson的MultiLock原理"><a href="#4-12-Redisson的MultiLock原理" class="headerlink" title="4.12 Redisson的MultiLock原理"></a>4.12 Redisson的MultiLock原理</h3><img src="https://s2.loli.net/2023/01/30/hznQLSBpjiYMF4X.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/30/hznQLSBpjiYMF4X.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"  /><p>在主从集群下，对所有结点获取锁，如果有某个结点宕机，就会导致锁消失，但别的结点仍然存在锁，就不会有重复获取锁问题</p><p>在<code>RedisConfig</code>配置多个Redis：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//配置类</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">//添加redis地址，这里添加了单点的地址，也可以使用config.useClusterServers()添加集群地址</span></span><br><span class="line">        config.useSingleServer()</span><br><span class="line">            .setAddress(<span class="string">&quot;redis://192.168.150.101:6379&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">//创建客户端</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//配置类</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">//添加redis地址，这里添加了单点的地址，也可以使用config.useClusterServers()添加集群地址</span></span><br><span class="line">        config.useSingleServer()</span><br><span class="line">            .setAddress(<span class="string">&quot;redis://192.168.150.101:6380&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">//创建客户端</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//配置类</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">//添加redis地址，这里添加了单点的地址，也可以使用config.useClusterServers()添加集群地址</span></span><br><span class="line">        config.useSingleServer()</span><br><span class="line">            .setAddress(<span class="string">&quot;redis://192.168.150.101:6381&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">//创建客户端</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试联锁：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HmDianPingApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient2;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient3;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RLock lock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前类中的每个@Test方法之前执行注解方法</span></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock2</span> <span class="operator">=</span> redissonClient2.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock3</span> <span class="operator">=</span> redissonClient3.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建联锁 multiLock</span></span><br><span class="line">        lock = redissonClient.getMultiLock(lock1, lock2, lock3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">//尝试获取锁，参数分别是：获取锁的最大等待时间（期间会重试），锁自动释放时间，时间单位</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//判断释放获取成功</span></span><br><span class="line">        <span class="keyword">if</span>(isLock) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;执行业务&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//释放锁</span></span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-13-总结"><a href="#4-13-总结" class="headerlink" title="4.13 总结"></a>4.13 总结</h3><p>不可重入Redis分布式锁：</p><ul><li>原理：利用setnx的互斥性；利用ex避免死锁；释放锁时判断线程标示</li><li>缺陷：不可重入、无法重试、锁超时失效</li></ul><p>可重入的Redis分布式锁：</p><ul><li>原理：利用hash结构，记录线程标示和重入次数；利用watchDog延续锁时间；利用信号量控制锁重试等待</li><li>缺陷：redis宕机引起锁失效问题</li></ul><p>Redisson的multiLock:</p><ul><li>原理：多个独立的Redis节点，必须在所有节点都获取重入锁，才算获取锁成功</li><li>缺陷：运维成本高、实现复杂</li></ul></div><div class="story post-story"><h2 id="5-Redis秒杀优化"><a href="#5-Redis秒杀优化" class="headerlink" title="5.Redis秒杀优化"></a>5.Redis秒杀优化</h2><h3 id="5-1-Redis异步秒杀思路"><a href="#5-1-Redis异步秒杀思路" class="headerlink" title="5.1 Redis异步秒杀思路"></a>5.1 Redis异步秒杀思路</h3><p><img src="https://s2.loli.net/2023/01/30/eETKOUhIz7Hj3Bi.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/30/eETKOUhIz7Hj3Bi.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"></p><p>将秒杀优惠券库存放入Redis中：</p><table><thead><tr><th>KEY</th><th>VALUE</th></tr></thead><tbody><tr><td>stock:vid:10</td><td>100</td></tr></tbody></table><p>将<strong>下单的用户id</strong>放入也放入到Redis的<strong>set集合</strong>中：</p><table><thead><tr><th>KEY</th><th>VALUE</th></tr></thead><tbody><tr><td>order:vid:10</td><td>1, 2, 3, 4, 5, 6</td></tr></tbody></table><p><img src="https://s2.loli.net/2023/01/30/BORgEAqbCX82vKG.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/30/BORgEAqbCX82vKG.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"></p><h3 id="5-2-基于Redis完成秒杀资格判断"><a href="#5-2-基于Redis完成秒杀资格判断" class="headerlink" title="5.2 基于Redis完成秒杀资格判断"></a>5.2 基于Redis完成秒杀资格判断</h3><p>改进秒杀业务，提高并发性能</p><p>需求：</p><ul><li>新增秒杀优惠券的同时，将优惠券信息保存到Redis中</li><li>基于lua脚本，判断秒杀库存、一人一单，决定用户是否抢购成功</li><li>如果抢购成功，将优惠券d和用户id封装后存入阻塞队列</li><li>开启线程任务，不断从阻塞队列中获取信息，实现异步下单功能</li></ul><p>在<code>VoucherServiceImpl</code>中修改<code>addSeckillVoucher</code>方法向Redis中添加优惠券：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// 保存优惠券，mybatis-plus在执行save方法后自动返回ID</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// 保存秒杀信息</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">//保存秒杀库存到Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue()</span><br><span class="line">                .set(RedisConstants.SECKILL_STOCK_KEY + voucher.getId(),</span><br><span class="line">                        voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建<code>seckill.lua</code>脚本，判断库存、一人一单：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>];  <span class="comment">--优惠券id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>];     <span class="comment">--用户id</span></span><br><span class="line"><span class="comment">--拼接key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId;</span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId;</span><br><span class="line"></span><br><span class="line"><span class="comment">--判断库存是否充足</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--库存不足，返回1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--判断用户是否已经下单</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--用户已经下单，返回2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--减扣库存</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">--将用户id插入到set合集中</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>重写<code>VoucherOrderServiceImpl</code>的<code>seckillVoucher</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化lua脚本</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SECKILL_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//设置脚本位置</span></span><br><span class="line">        SECKILL_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/seckill.lua&quot;</span>));</span><br><span class="line">        <span class="comment">//设置返回值类型</span></span><br><span class="line">        SECKILL_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">//执行lua脚本</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">                SECKILL_SCRIPT,</span><br><span class="line">                Collections.emptyList(),</span><br><span class="line">                voucherId.toString(), userId.toString());</span><br><span class="line">        <span class="comment">//异常信息，返回失败</span></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(result == <span class="number">1</span> ? <span class="string">&quot;库存不足&quot;</span> : <span class="string">&quot;不能重复下单&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//模拟，生成订单号</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">order</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(order);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-3-基于阻塞队列实现秒杀异步下单"><a href="#5-3-基于阻塞队列实现秒杀异步下单" class="headerlink" title="5.3 基于阻塞队列实现秒杀异步下单"></a>5.3 基于阻塞队列实现秒杀异步下单</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line">    <span class="comment">//全局唯一ID</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line">    <span class="comment">//redisson分布式锁</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line">    <span class="comment">//代理对象</span></span><br><span class="line">    <span class="keyword">private</span> IVoucherOrderService proxy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化lua脚本</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SECKILL_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//设置脚本位置</span></span><br><span class="line">        SECKILL_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/seckill.lua&quot;</span>));</span><br><span class="line">        <span class="comment">//设置返回值类型</span></span><br><span class="line">        SECKILL_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化阻塞队列</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span>*<span class="number">1024</span>);</span><br><span class="line">    <span class="comment">//初始化单线程池</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在spring容器初始化的时候执行该方法</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//获取队列的订单信息，没有订单则阻塞等待</span></span><br><span class="line">                    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                    <span class="comment">//处理订单</span></span><br><span class="line">                    handleVoucherOrder(voucherOrder);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;处理订单异常&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//主方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">//执行lua脚本</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">                SECKILL_SCRIPT,</span><br><span class="line">                Collections.emptyList(),</span><br><span class="line">                voucherId.toString(), userId.toString());</span><br><span class="line">        <span class="comment">//异常信息，返回失败</span></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(result == <span class="number">1</span> ? <span class="string">&quot;库存不足&quot;</span> : <span class="string">&quot;不能重复下单&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取主线程代理对象</span></span><br><span class="line">        proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="comment">//创建订单</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">//加入到阻塞队列中</span></span><br><span class="line">        orderTasks.add(voucherOrder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//再次进行逻辑判断，互斥的处理订单</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">isLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//尝试获取锁</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> isLock.tryLock();</span><br><span class="line">        <span class="keyword">if</span> (!flag)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;不能重复下单&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取锁成功</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//生成一人一单的订单</span></span><br><span class="line">            proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放锁</span></span><br><span class="line">            isLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//操作数据库，生成订单</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="comment">//检查一人一单</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;用户已经购买过一次&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//减扣库存</span></span><br><span class="line">        <span class="comment">//set stock = stock-1 where voucher_id = ? and stock &gt; 0</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId())</span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//从数据库生成订单</span></span><br><span class="line">        save(voucherOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>秒杀业务的优化思路是什么？</p><ol><li>先利用Redis完成库存余量、一人一单判断，完成抢单业务</li><li>再将下单业务放入阻塞队列，利用独立线程异步下单</li></ol><p>基于阻塞队列的异步秒杀存在哪些问题？</p><ul><li>内存限制问题</li><li>数据安全问题</li></ul></div><div class="story post-story"><h2 id="6-Redis消息队列"><a href="#6-Redis消息队列" class="headerlink" title="6.Redis消息队列"></a>6.Redis消息队列</h2><h3 id="6-1-消息队列"><a href="#6-1-消息队列" class="headerlink" title="6.1 消息队列"></a>6.1 消息队列</h3><p>消息队列(<strong>M</strong>essage <strong>Q</strong>ueue)，字面意思就是存放消息的队列。</p><p>最简单的消息队列模型包括3个角色：</p><ul><li>消息队列：存储和管理消息，也被称为消息代理(Message Broker)</li><li>生产者：发送消息到消息队列</li><li>消费者：从消息队列获取消息并处理消息</li></ul><p><img src="https://s2.loli.net/2023/01/30/DqTYk1EBjdxWNr4.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/30/DqTYk1EBjdxWNr4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"></p><p>Redis提供了三种不同的方式来实现消息队列：</p><ul><li>list结构：基于List结构模拟消息队列</li><li>PubSub：基本的点对点消息模型</li><li>Stream：比较完善的消息队列模型</li></ul><table><thead><tr><th></th><th>List</th><th>PubSub</th><th>Stream</th></tr></thead><tbody><tr><td>消息持久化</td><td>支持</td><td>不支持</td><td>支持</td></tr><tr><td>阻塞读取</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>消息堆积处理</td><td>受限于内存空间，可以<br/>利用多消费者加快处理</td><td>受限于消费者缓冲区</td><td>受限于队列长度，可以利用消费<br/>者组提高消费速度，减少堆积</td></tr><tr><td>消息确认机制</td><td>不支持</td><td>不支持</td><td>支持</td></tr><tr><td>消息回溯</td><td>不支持</td><td>不支持</td><td>支持</td></tr></tbody></table><h3 id="6-2-基于List实现消息队列"><a href="#6-2-基于List实现消息队列" class="headerlink" title="6.2 基于List实现消息队列"></a>6.2 基于List实现消息队列</h3><p>消息队列(Message Queue)，字面意思就是存放消息的队列。</p><p>而Redis的list数据结构是一个双向链表，很容易模拟出队列效果。</p><p>队列是入口和出口不在一边，因此我们可以利用：<strong>LPUSH结合RPOP</strong> 或者 <strong>RPUSH结合LPOP</strong>来实现。</p><p>不过要注意的是，当队列中没有消息时RPOP或LPOP操作会返回null，并不像JVM的阻塞队列那样会阻塞并等待消息。</p><p>因此这里应该使用<strong>BRPOP</strong>或者<strong>BLPOP</strong>来实视阻塞效果。</p><p>基于List的消息队列的优缺点：</p><blockquote><p>优点：</p><ul><li>利用Redis存储，不受限于JVM内存上限</li><li>基于Redis的持久化机制，数据安全性有保证</li><li>可以满足消息有序性</li></ul><p>缺点：</p><ul><li>无法避免消息丢失：移除队列后，会删除数据。如果此时宕机，造成数据丢失</li><li>只支持单消费者</li></ul></blockquote><h3 id="6-3-PubSub实现消息队列"><a href="#6-3-PubSub实现消息队列" class="headerlink" title="6.3 PubSub实现消息队列"></a>6.3 PubSub实现消息队列</h3><p>PubSub(发布订阅)是Redis2.0版本引入的消息传递模型。顾名思义，消费者可以订阅一个或多个channel，生产者向对应channel发送消息后，所有订阅者都能收到相关消息。</p><ul><li><code>SUBSCRIBE channel[channel]</code>：订阅一个或多个频道</li><li><code>PUBLISH channel msg</code>：向一个频道发送消息</li><li><code>PSUBSCRIBE pattern[pattern]</code>：订阅与pattern格式匹配的所有频道</li></ul><img src="https://s2.loli.net/2023/01/30/Ui5ACYH2r1WNo9E.png" class="lazyload" data-srcset="https://s2.loli.net/2023/01/30/Ui5ACYH2r1WNo9E.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-01-29_16-02-30.png"  /><p>基于PubSub的消息队列有哪些优缺点？</p><blockquote><p>优点：</p><ul><li>采用发布订阅模型，支持多生产、多消费</li></ul><p>缺点：</p><ul><li>不支持数据持久化</li><li>无法避免消息丢失</li><li>消息堆积有上限，超出时数据丢失</li></ul></blockquote><h3 id="6-4-Stream的单消费模式"><a href="#6-4-Stream的单消费模式" class="headerlink" title="6.4 Stream的单消费模式"></a>6.4 Stream的单消费模式</h3><p>Stream是Redis5.0引入的一种新数据类型，可以实现一个功能非常完善的消息队列。</p><p>发送消息的命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xadd key [nomkstream] [maxlen|minid [=|~] threshold [limit count]] *|ID field value</span><br></pre></td></tr></table></figure><ul><li><code>[nomkstream]</code>：如果队列不存在，是否自动创建队列，默认是自动创建</li><li><code>[maxlen|minid [=|~] threshold [limit count]]</code>：设置消息队列的最大消息数量</li><li><code>*|ID</code>：消息的唯一Id，*代表由Redis自动生成。格式是”时间戳-递增数字”，例如”1644804662707-0”</li><li><code>field value</code>：发送到队列中的消息，称为Entry。格式就是多个key-value键值对</li></ul><p>例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#创建名为users的队列，并向其中发送一个消息，内容是：&#123;name=jack,age=21&#125;，并且使用那redis自动生成id</span></span></span><br><span class="line">127.0.0.1:6379&gt; XADD users name jack age 21</span><br><span class="line">&quot;1644805700523-0&quot;</span><br></pre></td></tr></table></figure><p>读取消息：XREAD</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xread [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] ID [ID ...]</span><br></pre></td></tr></table></figure><ul><li><code>[COUNT count]</code>：每次读取消息的最大数量</li><li><code>[BLOCK milliseconds]</code>：当没有消息时，是否阻塞、阻塞时长</li><li><code>STREAMS key [key ...]</code>：要从哪个队列读取消息，key就是队列名</li><li><code>ID [ID ...]</code>：起始id，只返回大于该ID的消息<ul><li>0：代表从第一个消息开始</li><li>$：代表从最新的消息开始</li></ul></li></ul><p>例如，使用XREAD读取第一个消息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; XREAD COUNT 1 STREAMS users 0</span><br><span class="line">1)1) &quot;users&quot;</span><br><span class="line">2)1)1) &quot;1644805700523-0&quot;</span><br><span class="line">2)1) &quot;name</span><br><span class="line">2) &quot;jack&quot;</span><br><span class="line">3) &quot;age&quot;</span><br><span class="line">4) &quot;21&quot;</span><br></pre></td></tr></table></figure><p>XREAD阻塞方式，读取最新的消息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; XREAD COUNT 1 BLOCK 1000 STREAMS users $</span><br><span class="line">(nil)</span><br><span class="line">(1.07s)</span><br></pre></td></tr></table></figure><p>在业务开发中，我们可以循环的调用XREAD阻塞方式来查询最新消息，从而实现持续监听队列的效果，伪代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">//尝试读取队列中的消息，最多阻塞2秒</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.xecute(<span class="string">&quot;XREAD COUNT 1 BLOCK 2000 STREAMS users $&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理消息</span></span><br><span class="line">    handleMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意，当我们指定起始ID为$时，代表读取最新的消息，如果我们处理一条消息的过程中，又有超过1条以上的消息到达队列，则下次获取时也只能获取到最新的一条，会出现<strong>漏读消息</strong>的问题。</p></blockquote><p>STREAM类型消息队列的XREAD命令特点：</p><blockquote><ul><li>消息可回潮</li><li>一个消息可以被多个消费者读取</li><li>可以阻塞读取</li><li>有消息漏读的风险</li></ul></blockquote><h3 id="6-5-Stream的消费者组模式"><a href="#6-5-Stream的消费者组模式" class="headerlink" title="6.5 Stream的消费者组模式"></a>6.5 Stream的消费者组模式</h3><p>消费者组(Consumer Group)：将多个消费者划分到一个组中，监听同一个队列。</p><p>具备下列特点：</p><ul><li><p>消息分流</p><p>队列中的消息会分流给组内的不同消费者，而不是重复消费，从而加快消息处理的速度</p></li><li><p>消息标示</p><p>消费者组会维护一个标示，记录最后一个被处理的消息，哪怕消费者宕机重启，还会从标示之后读取消息。确保每一个消息都会被消费</p></li><li><p>消息确认</p><p>消费者获取消息后，消息处于pending状态，并存入一个pending-list。当处理完成后需要通过XACK来确认消息，标记消息为已处理，才会从pending-List移除。</p></li></ul><p>创建消费者组：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE key groupName ID [MKSTREAM]</span><br></pre></td></tr></table></figure><ul><li>key：队列名称</li><li>groupName：消费者组名称</li><li>ID：起始ID标示，<code>$</code>代表队列中最后一个消息，<code>0</code>则代表队列中第一个消息</li><li>MKSTREAM：队列不存在时自动创建队列</li></ul><p>其它常见命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除指定的消费者组</span></span><br><span class="line">XGROUP DESTORY key groupName</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">给指定的消费者组添加消费者</span></span><br><span class="line">XGROUP CREATECONSUMER key groupname consumername</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除消费者组中的指定消费者</span></span><br><span class="line">XGROUP DELCONSUMER key groupname consumername</span><br></pre></td></tr></table></figure><p>从消费者组读取消息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]</span><br></pre></td></tr></table></figure><ul><li><code>group</code>：消费组名称</li><li><code>consumer</code>：消费者名称，如果消费者不存在，会自动创建一个消费者</li><li><code>count</code>：本次查询的最大数量</li><li><code>BLOCK milliseconds</code>：当没有消息时最长等待时间</li><li><code>NOACK</code>：无需手动ACK,获取到消息后自动确认</li><li><code>STREAMS  key</code>：指定队列名称</li><li><code>ID</code>：获取消息的起始ID:<ul><li><code>&quot;&gt;&quot;</code>：从下一个未消费的消息开始</li><li>其它：根据指定id从pending-list中获取已消费但未确认的消息，例如0，是从pending-List中的第一个<br>消息开始</li></ul></li></ul><p>ACK，消息确认：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SACK stream.orders g1 id</span><br></pre></td></tr></table></figure><p>消费者监听消息的基本思路：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line"><span class="comment">//尝试监听队列，使用阻塞模式，最长等待2000毫秒</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;&quot;</span>)</span><br><span class="line"><span class="keyword">if</span>(msg == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//null说明没有消息，继续下一次</span></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">     &#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//处理消息，完成后一定要ACK</span></span><br><span class="line">handleMessage(msg);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 STREAMS s1 0&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(msg == nu11) &#123;</span><br><span class="line">                <span class="comment">//null说明没有异常消息，所有消息都已确认，结束循环</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//说明有异常消息，再沈处理</span></span><br><span class="line">                handleMessage(msg)；</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">                <span class="comment">//再次出现异常，记灵日志，继续循环</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>STREAM类型消息队列的<code>XREADGROUP</code>命令特点：</p><ul><li>消息可回溯</li><li>可以多消费者争抢消息，加快消费速度</li><li>可以阻塞读取</li><li>没有消息漏读的风险</li><li>有消息确认机制，保证消息至少被消费一次</li></ul><h3 id="6-6-基于Stream消息队列实现异步秒杀"><a href="#6-6-基于Stream消息队列实现异步秒杀" class="headerlink" title="6.6 基于Stream消息队列实现异步秒杀"></a>6.6 基于Stream消息队列实现异步秒杀</h3><p>需求：</p><ol><li>创建一个Stream类型的消息队列，名为stream.orders</li><li>修改之前的秒杀下单Lua脚本，在认定有抢购资格后，直接向stream.orders中添加消息，内容包含voucherld、userld、orderld</li><li>项目启动时，开启一个线程任务，尝试获取stream.orders中的消息，完成下单</li></ol><p>创建名为<code>stream.orders</code>消息队列：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE stream.orders g1 0 MKSTREAM</span><br></pre></td></tr></table></figure><p>创建<code>seckillStream</code>的Lua脚本：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>];  <span class="comment">--优惠券id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>];     <span class="comment">--用户id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>];    <span class="comment">--订单id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--拼接key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId;</span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId;</span><br><span class="line"></span><br><span class="line"><span class="comment">--判断库存是否充足</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--库存不足，返回1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--判断用户是否已经下单</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--用户已经下单，返回2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--减扣库存</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">--将用户id插入到set合集中</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId);</span><br><span class="line"></span><br><span class="line"><span class="comment">--发送消息到队列中，XADD stream.orders * k1 v1 k2 v2 ···</span></span><br><span class="line">redis.call(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>继续改进<code>VoucherOrderServiceImpl</code>类中的 <code>seckillVoucher</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line">    <span class="comment">//全局唯一ID</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line">    <span class="comment">//redisson分布式锁</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line">    <span class="comment">//代理对象</span></span><br><span class="line">    <span class="keyword">private</span> IVoucherOrderService proxy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化lua脚本</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SECKILL_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//设置脚本位置</span></span><br><span class="line">        SECKILL_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/seckillStream.lua&quot;</span>));</span><br><span class="line">        <span class="comment">//设置返回值类型</span></span><br><span class="line">        SECKILL_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化单线程池</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在spring容器初始化的时候执行该方法</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;stream.orders&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//获取消息队列中的订单信息，没有订单则阻塞等待2秒</span></span><br><span class="line">                    <span class="comment">//XREADGROUP GROUP c1 COUNT 1 BLOCK 2000 STREAMS streams.order &gt;</span></span><br><span class="line">                    List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                            Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                            StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">2</span>)),</span><br><span class="line">                            StreamOffset.create(queueName, ReadOffset.lastConsumed())</span><br><span class="line">                    );</span><br><span class="line">                    <span class="comment">//判断消息是否获取成功</span></span><br><span class="line">                    <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                        <span class="comment">//获取失败，进入下次循环</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//解析消息中的订单信息</span></span><br><span class="line">                    MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                    Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                    <span class="comment">//获取成功，则处理订单</span></span><br><span class="line">                    handleVoucherOrder(voucherOrder);</span><br><span class="line">                    <span class="comment">//完成ACK确认</span></span><br><span class="line">                    <span class="comment">//SACK stream.orders g1 id</span></span><br><span class="line">                    stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;处理订单异常&quot;</span>, e);</span><br><span class="line">                    handlePendingList();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//pending-list检查</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePendingList</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//获取pending-list中的订单信息</span></span><br><span class="line">                    <span class="comment">//XREADGROUP GROUP c1 COUNT 1 STREAMS streams.order 0</span></span><br><span class="line">                    List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                            Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                            StreamReadOptions.empty().count(<span class="number">1</span>),</span><br><span class="line">                            StreamOffset.create(queueName, ReadOffset.from(<span class="string">&quot;0&quot;</span>))</span><br><span class="line">                    );</span><br><span class="line">                    <span class="comment">//判断消息是否获取成功</span></span><br><span class="line">                    <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                        <span class="comment">//获取失败，pending-list中没有异常消息，结束循环</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//解析消息中的订单信息</span></span><br><span class="line">                    MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                    Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                    <span class="comment">//获取成功，处理异常的订单</span></span><br><span class="line">                    handleVoucherOrder(voucherOrder);</span><br><span class="line">                    <span class="comment">//完成ACK确认</span></span><br><span class="line">                    <span class="comment">//SACK stream.orders g1 id</span></span><br><span class="line">                    stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;处理pending-list订单异常&quot;</span>, e);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行lua脚本</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">                SECKILL_SCRIPT,</span><br><span class="line">                Collections.emptyList(),</span><br><span class="line">                voucherId.toString(), userId.toString(), String.valueOf(orderId));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//异常信息，返回失败</span></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(result == <span class="number">1</span> ? <span class="string">&quot;库存不足&quot;</span> : <span class="string">&quot;不能重复下单&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取主线程代理对象</span></span><br><span class="line">        proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//再次进行逻辑判断，互斥的处理订单</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">isLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//尝试获取锁</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> isLock.tryLock();</span><br><span class="line">        <span class="keyword">if</span> (!flag)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;不能重复下单&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取锁成功</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//生成一人一单的订单</span></span><br><span class="line">            proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放锁</span></span><br><span class="line">            isLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//操作数据库，生成订单</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="comment">//检查一人一单</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;用户已经购买过一次&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//减扣库存</span></span><br><span class="line">        <span class="comment">//set stock = stock-1 where voucher_id = ? and stock &gt; 0</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId())</span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//从数据库生成订单</span></span><br><span class="line">        save(voucherOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="6-达人探店"><a href="#6-达人探店" class="headerlink" title="6.达人探店"></a>6.达人探店</h2><h3 id="6-1-发布探店笔记"><a href="#6-1-发布探店笔记" class="headerlink" title="6.1 发布探店笔记"></a>6.1 发布探店笔记</h3><p>探店笔记类似点评网站的评价，往往是图文结合。对应的表有两个：</p><ul><li>tb_blog：探店笔记表，包含笔记中的标题、文字、图片等</li><li>tb_blog_comments：其他用户对探店笔记的评价</li></ul><p>图片上传：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;blog&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">uploadImage</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile image)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取原始文件名称</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> image.getOriginalFilename();</span><br><span class="line">            <span class="comment">// 生成新文件名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> createNewFileName(originalFilename);</span><br><span class="line">            <span class="comment">// 保存文件</span></span><br><span class="line">            image.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, fileName));</span><br><span class="line">            <span class="comment">// 返回结果</span></span><br><span class="line">            log.debug(<span class="string">&quot;文件上传成功，&#123;&#125;&quot;</span>, fileName);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(fileName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;文件上传失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>保存blog：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IBlogService blogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(<span class="meta">@RequestBody</span> Blog blog)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取登录用户</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        blog.setUserId(user.getId());</span><br><span class="line">        <span class="comment">// 保存探店博文</span></span><br><span class="line">        blogService.save(blog);</span><br><span class="line">        <span class="comment">// 返回id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-2-查看探店笔记"><a href="#6-2-查看探店笔记" class="headerlink" title="6.2 查看探店笔记"></a>6.2 查看探店笔记</h3><p><code>BlogController</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IBlogService blogService;</span><br><span class="line"><span class="comment">//获取热点笔记列表</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hot&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> blogService.queryHotBlog(current);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//通过id获取笔记</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> blogService.queryBlogById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>BlogServiceImpl</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;</span><br><span class="line">        <span class="comment">// 根据用户查询</span></span><br><span class="line">        Page&lt;Blog&gt; page = query()</span><br><span class="line">                .orderByDesc(<span class="string">&quot;liked&quot;</span>)</span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">        <span class="comment">// 获取当前页数据</span></span><br><span class="line">        List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">        <span class="comment">// 查询用户</span></span><br><span class="line">        records.forEach(blog -&gt;&#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">            blog.setName(user.getNickName());</span><br><span class="line">            blog.setIcon(user.getIcon());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (blog == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;笔记不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">        blog.setName(user.getNickName());</span><br><span class="line">        blog.setIcon(user.getIcon());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-3-点赞功能"><a href="#6-3-点赞功能" class="headerlink" title="6.3 点赞功能"></a>6.3 点赞功能</h3><p>需求：</p><ul><li>同一个用户只能点赞一次，再次点击则取消点赞</li><li>如果当前用户已经点赞，则点赞按钮高亮显示（前端已实现，判断字段Blog类的isLike属性）</li></ul><p>实现步骤：</p><ol><li>给Blog类中添加一个isLike字段，标示是否被当前用户点赞</li><li>修改点赞功能，利用Redis的set集合判断是否点赞过，未点赞过则点赞数+1，已点赞过则点赞数-1</li><li>修改根据id查询Blog的业务，判断当前登录用户是否点赞过，赋值给isLike字段</li><li>修改分页查询Blog业务，判断当前登录用户是否点赞过，赋值给isLike字段</li></ol><p>修改<code>BlogServiceImpl</code>，添加blog是否已点赞功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;</span><br><span class="line">        <span class="comment">// 根据用户查询</span></span><br><span class="line">        Page&lt;Blog&gt; page = query()</span><br><span class="line">                .orderByDesc(<span class="string">&quot;liked&quot;</span>)</span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">        <span class="comment">// 获取当前页数据</span></span><br><span class="line">        List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">        <span class="comment">// 查询用户</span></span><br><span class="line">        records.forEach(blog -&gt;&#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">            blog.setName(user.getNickName());</span><br><span class="line">            blog.setIcon(user.getIcon());</span><br><span class="line">            <span class="comment">//设置当前blog是否已经点赞</span></span><br><span class="line">            isLikedBlog(blog);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (blog == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;笔记不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">        blog.setName(user.getNickName());</span><br><span class="line">        blog.setIcon(user.getIcon());</span><br><span class="line">        <span class="comment">//设置查询的blog是否已经点赞</span></span><br><span class="line">        isLikedBlog(blog);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isLikedBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        <span class="comment">//需要判断，没有登录拦截器拦截路径</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从Redis中查询是否点赞过</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + blog.getId();</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">        blog.setIsLike(BooleanUtil.isTrue(isMember));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加点赞功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="comment">//不需要判断，因为有登录拦截器拦截路径</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//从Redis中查询是否点赞过</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">        <span class="comment">//如果未点赞，则点赞</span></span><br><span class="line">        <span class="keyword">if</span> (BooleanUtil.isFalse(isMember))&#123;</span><br><span class="line">            <span class="comment">//更新数据库中blog的点赞量</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update()</span><br><span class="line">                    .setSql(<span class="string">&quot;liked = liked + 1&quot;</span>)</span><br><span class="line">                    .eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">            <span class="comment">//如果更新成功</span></span><br><span class="line">            <span class="keyword">if</span> (isSuccess)&#123;</span><br><span class="line">                <span class="comment">//将userId放入到Redis的set集合中</span></span><br><span class="line">                stringRedisTemplate.opsForSet().add(key, userId.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果已经点赞，则取消点赞</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//更新数据库中blog的点赞量</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update()</span><br><span class="line">                    .setSql(<span class="string">&quot;liked = liked - 1&quot;</span>)</span><br><span class="line">                    .eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">            <span class="comment">//如果更新成功</span></span><br><span class="line">            <span class="keyword">if</span> (isSuccess)&#123;</span><br><span class="line">                <span class="comment">//从Redis的set集合中移除userId</span></span><br><span class="line">                stringRedisTemplate.opsForSet().remove(key, userId.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-4-点赞排行榜"><a href="#6-4-点赞排行榜" class="headerlink" title="6.4 点赞排行榜"></a>6.4 点赞排行榜</h3><p>在探店笔记的详情页面，应该把给该笔记点赞的人显示出来，比如最早点赞的TOP5，形成点赞排行榜：</p><p>需求：按照点赞时间先后排序，返回Top5的用户</p><table><thead><tr><th></th><th>List</th><th>Set</th><th>SortedSet</th></tr></thead><tbody><tr><td>排序方式</td><td>按添加顺序排序</td><td>无法排序</td><td>根据score值排序</td></tr><tr><td>唯一性</td><td>不唯一</td><td>唯一</td><td>唯一</td></tr><tr><td>查找方式</td><td>按索引查找或首尾查找</td><td>根据元素查找</td><td>根据元素查找</td></tr></tbody></table><p>Sortedset的可排序特性，可以用来<strong>实现排行榜</strong>这样的功能。</p><p>添加点赞用户：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zadd key vlaue score</span><br></pre></td></tr></table></figure><p>获取score前五名的用户：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zscore key 0 4</span><br></pre></td></tr></table></figure><p>从<code>set</code>集合改进为<code>SortSet</code>集合：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;</span><br><span class="line">        <span class="comment">// 根据用户查询</span></span><br><span class="line">        Page&lt;Blog&gt; page = query()</span><br><span class="line">                .orderByDesc(<span class="string">&quot;liked&quot;</span>)</span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">        <span class="comment">// 获取当前页数据</span></span><br><span class="line">        List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">        <span class="comment">// 查询用户</span></span><br><span class="line">        records.forEach(blog -&gt;&#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">            blog.setName(user.getNickName());</span><br><span class="line">            blog.setIcon(user.getIcon());</span><br><span class="line">            <span class="comment">//设置当前blog是否已经点赞</span></span><br><span class="line">            isLikedBlog(blog);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (blog == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;笔记不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">        blog.setName(user.getNickName());</span><br><span class="line">        blog.setIcon(user.getIcon());</span><br><span class="line">        <span class="comment">//设置查询的blog是否已经点赞</span></span><br><span class="line">        isLikedBlog(blog);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="comment">//不需要判断，因为有登录拦截器拦截路径</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//从Redis中查询是否点赞过</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;</span><br><span class="line">        <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">        <span class="comment">//如果未点赞，则点赞</span></span><br><span class="line">        <span class="keyword">if</span> (score == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//更新数据库中blog的点赞量</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update()</span><br><span class="line">                    .setSql(<span class="string">&quot;liked = liked + 1&quot;</span>)</span><br><span class="line">                    .eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">            <span class="comment">//如果更新成功</span></span><br><span class="line">            <span class="keyword">if</span> (isSuccess)&#123;</span><br><span class="line">                <span class="comment">//将userId放入到Redis的sortedSet集合中,以时间戳为score</span></span><br><span class="line">                stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果已经点赞，则取消点赞</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//更新数据库中blog的点赞量</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update()</span><br><span class="line">                    .setSql(<span class="string">&quot;liked = liked - 1&quot;</span>)</span><br><span class="line">                    .eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">            <span class="comment">//如果更新成功</span></span><br><span class="line">            <span class="keyword">if</span> (isSuccess)&#123;</span><br><span class="line">                <span class="comment">//从Redis的set集合中移除userId</span></span><br><span class="line">                stringRedisTemplate.opsForZSet().remove(key, userId.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isLikedBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        <span class="comment">//需要判断，没有登录拦截器拦截路径</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从Redis中查询是否点赞过</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + blog.getId();</span><br><span class="line">        <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">        blog.setIsLike(score != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>BlogServiceImpl</code> 添加点赞排行榜功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;</span><br><span class="line">        <span class="comment">//查询点赞前5的userId</span></span><br><span class="line">        Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0L</span>, <span class="number">4L</span>);</span><br><span class="line">        <span class="comment">//判断是否为null或者为空，则返回空列表</span></span><br><span class="line">        <span class="keyword">if</span> (top5 == <span class="literal">null</span> || top5.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解析userId</span></span><br><span class="line">        List&lt;Long&gt; userIds = top5</span><br><span class="line">                .stream()</span><br><span class="line">                .map(Long::valueOf)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="type">String</span> <span class="variable">join</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, userIds);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取userDto信息，获取的信息应该也要按照先后顺序</span></span><br><span class="line">        <span class="comment">//WHERE id IN 5,1 ORDER BY FIELD(id,5,1)</span></span><br><span class="line">        List&lt;UserDTO&gt; top5List = userService.query()</span><br><span class="line">                .in(<span class="string">&quot;id&quot;</span>, userIds)</span><br><span class="line">                .last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + join + <span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">                .stream()</span><br><span class="line">                .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(top5List);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="7-好友关注"><a href="#7-好友关注" class="headerlink" title="7.好友关注"></a>7.好友关注</h2><h3 id="7-1-关注和取关"><a href="#7-1-关注和取关" class="headerlink" title="7.1 关注和取关"></a>7.1 关注和取关</h3><p>在探店图文的详情页面中，可以关注发布笔记的作者：</p><ol><li>尝试关注用户</li><li>是否已经关注用户</li></ol><p>需求：基于该表数据结构，实现两个接口：</p><ol><li>关注和取关接口</li><li>判断是否关注的接口</li></ol><p>关注是User之间的关系，是博主与粉丝的关系，数据库中有一张tb_follow表来标示</p><p>在<code>FollowServiceImpl</code>中实现关注和取消关注：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;FollowMapper, Follow&gt; <span class="keyword">implements</span> <span class="title class_">IFollowService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId)</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).count();</span><br><span class="line">        <span class="comment">//判断是否大于0</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(count &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (BooleanUtil.isTrue(isFollow)) &#123;</span><br><span class="line">            <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">            follow.setUserId(userId);</span><br><span class="line">            follow.setFollowUserId(followUserId);</span><br><span class="line">            <span class="comment">//保存</span></span><br><span class="line">            save(follow);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//delete from tb_follow where userId = ? and follow_user_id = ?</span></span><br><span class="line">            remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                    .eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId)</span><br><span class="line">                    .eq(<span class="string">&quot;user_id&quot;</span>, userId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-2-共同关注"><a href="#7-2-共同关注" class="headerlink" title="7.2 共同关注"></a>7.2 共同关注</h3><p>需求：利用Redis中恰当的数据结构，实现共同关注功能。在博主个人页面展示出当前用户与博主的共同好友。</p><p>Redis中的set集合支持交集，我们需要把之前的<strong>关注和取关</strong>以及<strong>是否已经关注</strong>，进行改进</p><p>在 <code>FollowServiceImpl</code>中<code>isFollow()</code> 和 <code>follow()</code>方法，将关注列表添加到Redis的set集合中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;FollowMapper, Follow&gt; <span class="keyword">implements</span> <span class="title class_">IFollowService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//先从Redis中查找是否已经关注了</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet()</span><br><span class="line">                .isMember(RedisConstants.FOLLOW_KEY + userId, followUserId.toString());</span><br><span class="line">        <span class="keyword">if</span> (BooleanUtil.isTrue(isMember))&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId)</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).count();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断是否大于0</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//从Redis添加关注</span></span><br><span class="line">            stringRedisTemplate.opsForSet()</span><br><span class="line">                    .add(RedisConstants.FOLLOW_KEY + userId, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(count &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (BooleanUtil.isTrue(isFollow)) &#123;</span><br><span class="line">            <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">            follow.setUserId(userId);</span><br><span class="line">            follow.setFollowUserId(followUserId);</span><br><span class="line">            <span class="comment">//保存</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line">            <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">                <span class="comment">//从Redis添加关注</span></span><br><span class="line">                stringRedisTemplate.opsForSet()</span><br><span class="line">                        .add(RedisConstants.FOLLOW_KEY + userId, followUserId.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//delete from tb_follow where userId = ? and follow_user_id = ?</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                    .eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId)</span><br><span class="line">                    .eq(<span class="string">&quot;user_id&quot;</span>, userId));</span><br><span class="line">            <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">                <span class="comment">//从Redis中移除关注</span></span><br><span class="line">                stringRedisTemplate.opsForSet()</span><br><span class="line">                        .remove(RedisConstants.FOLLOW_KEY + userId, followUserId.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>FollowServiceImpl</code> 实现共同关注：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;FollowMapper, Follow&gt; <span class="keyword">implements</span> <span class="title class_">IFollowService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">commonFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line"></span><br><span class="line">        Set&lt;String&gt; common = stringRedisTemplate.opsForSet().intersect(</span><br><span class="line">                RedisConstants.FOLLOW_KEY + userId,</span><br><span class="line">                RedisConstants.FOLLOW_KEY + followUserId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断是否为null或者为空，则返回空列表</span></span><br><span class="line">        <span class="keyword">if</span> (common == <span class="literal">null</span> || common.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解析userId</span></span><br><span class="line">        List&lt;Long&gt; userIds = common</span><br><span class="line">                .stream()</span><br><span class="line">                .map(Long::valueOf)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取userDto信息</span></span><br><span class="line">        List&lt;UserDTO&gt; commonList = userService.listByIds(userIds)</span><br><span class="line">                .stream()</span><br><span class="line">                .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(commonList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-3-关注推送Feed流实现分析"><a href="#7-3-关注推送Feed流实现分析" class="headerlink" title="7.3 关注推送Feed流实现分析"></a>7.3 关注推送Feed流实现分析</h3><p>关注推送也叫做Feed流，直译为投喂。为用户持续的提供“沉浸式”的体验，通过无限下拉刷新获取新的信息。</p><p><img src="https://s2.loli.net/2023/02/01/hMULzRu8p7GYkti.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/01/hMULzRu8p7GYkti.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-01_13-55-47.png"></p><p>Feed流产品有两种常见模式：</p><ul><li><p>Timeline：不做内容筛选，简单的按照内容发布时间排序，常用于好友或关注。例如朋友圈</p><ul><li>优点：信息全面，不会有缺失。并且实现也相对简单</li><li>缺点：信息噪音较多，用户不一定感兴趣，内容获取效率低</li></ul></li><li><p>智能排序：利用智能算法屏蔽掉违规的、用户不感兴趣的内容。推送用户感兴趣信息来吸引用户</p><ul><li>优点：投喂用户感兴趣信息，用户粘度很高，容易沉迷</li><li>缺点：如果算法不精准，可能起到反作用</li></ul></li></ul><p>本例中的个人页面，是<strong>基于关注的好友</strong>来做Feed流，因此采用Timeline的模式。该模式的实现方案有三种：</p><ul><li><p>拉模式：也叫做读扩散。</p><img src="https://s2.loli.net/2023/02/01/5mRbF9h174cjed6.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/01/5mRbF9h174cjed6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-01_13-55-47.png"  /></li><li><p>推模式：也叫做写扩散。</p><img src="https://s2.loli.net/2023/02/01/IBtNOXDMHAwvdVn.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/01/IBtNOXDMHAwvdVn.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-01_13-55-47.png" style="zoom:67%;" /></li><li><p>推拉结合：也叫做读写混合，兼具推和拉两种模式的优点。</p><p><img src="https://s2.loli.net/2023/02/01/iuSzEwRbmflLOPB.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/01/iuSzEwRbmflLOPB.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-01_13-55-47.png"></p></li></ul><table><thead><tr><th></th><th>拉模式</th><th>推模式</th><th>推拉结合</th></tr></thead><tbody><tr><td>写比例</td><td>低</td><td>高</td><td>中</td></tr><tr><td>读比例</td><td>高</td><td>低</td><td>中</td></tr><tr><td>用户读取延迟</td><td>高</td><td>低</td><td>低</td></tr><tr><td>实现难度</td><td>复杂</td><td>简单</td><td>很复杂</td></tr><tr><td>使用场景</td><td>很少使用</td><td>用户量少，没有大V</td><td>过千万的用户量，有大V</td></tr></tbody></table><h3 id="7-4-推送到粉丝收件箱"><a href="#7-4-推送到粉丝收件箱" class="headerlink" title="7.4 推送到粉丝收件箱"></a>7.4 推送到粉丝收件箱</h3><p>需求：</p><ol><li>修改新增探店笔记的业务，在保存blog到数据库的同时，推送到粉丝的收件箱(推模式)</li><li>收件箱满足可以根据时间戳排序，必须用Redis的数据结构实现</li><li>查询收件箱数据时，可以实现分页查询</li></ol><p>Feed流中的数据会不断更新，所以数据的角标也在变化，因此不能采用传统的分页模式。</p><p>Feed流的滚动分页：</p><p><img src="https://s2.loli.net/2023/02/01/mu9A6DCEkPVXN4T.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/01/mu9A6DCEkPVXN4T.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-01_13-55-47.png"></p><p>保存blog到数据库，将blog的id放入粉丝收件箱：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IFollowService followService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        blog.setUserId(userId);</span><br><span class="line">        <span class="comment">//将blog保存到数据库</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(blog);</span><br><span class="line">        <span class="keyword">if</span> (!isSuccess) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;新增图书失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//查询到所有粉丝</span></span><br><span class="line">        List&lt;Follow&gt; followList = followService.query().eq(<span class="string">&quot;follow_user_id&quot;</span>, userId).list();</span><br><span class="line">        <span class="comment">//遍历将blog的id放入到粉丝的Redis的sortedset集合中</span></span><br><span class="line">        <span class="keyword">for</span> (Follow follow : followList) &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">            stringRedisTemplate.opsForZSet()</span><br><span class="line">                    .add(RedisConstants.FEED_KEY + id,</span><br><span class="line">                            blog.getId().toString(),</span><br><span class="line">                            System.currentTimeMillis());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-5-滚动分页查询收件箱思路"><a href="#7-5-滚动分页查询收件箱思路" class="headerlink" title="7.5 滚动分页查询收件箱思路"></a>7.5 滚动分页查询收件箱思路</h3><p>需求：在个人主页的“关注”卡片中，查询并展示推送的Blog信息：</p><p>Redis的sortedSet集合的滚动分页命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZREVRANGEBYSCORE feed:userId max min WITHSCORES LIMIT offset count</span><br></pre></td></tr></table></figure><p>分页查询参数：</p><ul><li>max：上一次查询的最小时间戳 | 当前时间(score)</li><li>min：最小时间戳，固定为0</li><li>offset：上一次的结果中，与最小值一样的元素的个数(偏移量)</li><li>count：分页大小，固定为3</li></ul><h3 id="7-6-实现滚动分页查询"><a href="#7-6-实现滚动分页查询" class="headerlink" title="7.6 实现滚动分页查询"></a>7.6 实现滚动分页查询</h3><p>封装滚动分页数据：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScoreResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;?&gt; list;</span><br><span class="line">    <span class="keyword">private</span> Integer offset;</span><br><span class="line">    <span class="keyword">private</span> Long minTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>BlogServiceImpl</code>中实现获取推文：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(Integer offset, Long maxTime)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//获取滚动分页数据</span></span><br><span class="line">        Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">                .reverseRangeByScoreWithScores(</span><br><span class="line">                        RedisConstants.FEED_KEY + userId,</span><br><span class="line">                        <span class="number">0</span>, maxTime,</span><br><span class="line">                        offset, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断是否为null或者为空，则返回空列表</span></span><br><span class="line">        <span class="keyword">if</span> (typedTuples == <span class="literal">null</span> || typedTuples.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//解析出blogId列表、minTime最小时间戳、offset偏移量</span></span><br><span class="line">        List&lt;Long&gt; blogIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typedTuples.size());</span><br><span class="line">        <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        offset = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; typedTuple : typedTuples) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">blogIdStr</span> <span class="operator">=</span> typedTuple.getValue();</span><br><span class="line">            blogIds.add(Long.valueOf(blogIdStr));</span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> typedTuple.getScore().longValue();</span><br><span class="line">            <span class="keyword">if</span> (time == minTime)&#123;</span><br><span class="line">                offset++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                minTime = time;</span><br><span class="line">                offset = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">join</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, blogIds);</span><br><span class="line">        <span class="comment">//根据blogId，获得按照顺序的blogList列表</span></span><br><span class="line">        List&lt;Blog&gt; blogList = query()</span><br><span class="line">                .in(<span class="string">&quot;id&quot;</span>, blogIds)</span><br><span class="line">                .last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + join + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加是否已点赞，以及名字、头像</span></span><br><span class="line">        <span class="keyword">for</span> (Blog blog : blogList) &#123;</span><br><span class="line">            queryUserToBlog(blog);</span><br><span class="line">            isLikedBlog(blog);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//封装数据，返回</span></span><br><span class="line">        <span class="type">ScoreResult</span> <span class="variable">scoreResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScoreResult</span>();</span><br><span class="line">        scoreResult.setList(blogList);</span><br><span class="line">        scoreResult.setOffset(offset);</span><br><span class="line">        scoreResult.setMinTime(minTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(scoreResult);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isLikedBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        <span class="comment">//需要判断，没有登录拦截器拦截路径</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从Redis中查询是否点赞过</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.BLOG_LIKED_KEY + blog.getId();</span><br><span class="line">        <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">        blog.setIsLike(score != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">queryUserToBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">        blog.setName(user.getNickName());</span><br><span class="line">        blog.setIcon(user.getIcon());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="8-附近的商户"><a href="#8-附近的商户" class="headerlink" title="8.附近的商户"></a>8.附近的商户</h2><h3 id="8-1-GEO数据结构"><a href="#8-1-GEO数据结构" class="headerlink" title="8.1 GEO数据结构"></a>8.1 GEO数据结构</h3><p>GEO就是Geolocation的简写形式，代表地理坐标。</p><p>Redis在3.2版本中加入了对GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据。常见的命令有：</p><blockquote><ul><li><code>GEOADD</code>：添加一个地理空间信息，包含：经度(longitude)、纬度(latitude)、值(member)</li><li><code>GEODIST</code>：计算指定的两个点之间的距离并返回</li><li><code>GEOHASH</code>：将指定member的坐标转为hash字符串形式并返回</li><li><code>GEOPOS</code>：返回指定member的坐标</li><li><code>GEORADIUS</code>：指定圆心、半径，找到该圆内包含的所有member，并按照与圆心之间的距离排序后返回。6.2以后已废弃</li><li><code>GEOSEARCH</code>：在指定范围内搜索member,并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形。6.2.新功能</li><li><code>GEOSEARCHSTORE</code>：与<code>GEOSEARCH</code>功能一致，不过可以把结果存储到一个指定的key。6.2.新功能</li></ul></blockquote><p>练习Redis的GEO功能<br>需求：</p><ol><li><p>添加下面几条数据：</p><ul><li><p>北京南站(116.378248, 39.865275)</p></li><li><p>北京站(116.42803, 39.903738)</p></li><li><p>北京西站(116.322287, 39.893729)</p></li></ul></li><li><p>计算北京西站到北京站的距离</p></li><li><p>搜索天安门(116.397904, 39.909005)附近10km内的所有火车站，并按照距离升序排序</p></li></ol><p>添加数据：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geoadd g1 116.378248 39.865275 bjnz 116.42803 39.903738 bjz 116.322287 39.893729 bjxz</span><br></pre></td></tr></table></figure><p>计算北京西站到北京站的距离(km)：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geodist g1 bjxz bjz km</span><br></pre></td></tr></table></figure><p>搜索天安门附近10km内的所有火车站，并按照距离升序排序：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geosearch g1 fromlonlat 116.397904 39.909005 byradius 10 km withdist</span><br></pre></td></tr></table></figure><h3 id="8-2-导入店铺数据到GEO"><a href="#8-2-导入店铺数据到GEO" class="headerlink" title="8.2 导入店铺数据到GEO"></a>8.2 导入店铺数据到GEO</h3><p>在首页中点击某个频道，即可看到频道下的商户：</p><p>按照商户类型做分组，类型相同的商户作为同一组，以typeld为key存入同一个GEO集合中即可</p><table><thead><tr><th>KEY</th><th>VALUE</th><th>SCORE</th></tr></thead><tbody><tr><td>shop:geo:1</td><td>火锅</td><td>…</td></tr><tr><td></td><td>烧烤</td><td>…</td></tr><tr><td>shop:geo:2</td><td>KTV1</td><td>…</td></tr><tr><td></td><td>KTV2</td><td>…</td></tr></tbody></table><p>从数据库中获取shop列表，以typeId为key，商家的id为value，存入经纬度：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testQueryShop2Redis</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Shop&gt; list = shopService.list();</span><br><span class="line">    <span class="comment">//以typeId将shop分组</span></span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="comment">//分批完成写入Redis</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">//获取类型d</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="comment">//获取同类型的店铺的集合</span></span><br><span class="line">        List&lt;Shop&gt; value = entry.getValue();</span><br><span class="line">        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(value.size());</span><br><span class="line">        <span class="comment">//写入redis</span></span><br><span class="line">        <span class="keyword">for</span> (Shop shop : value) &#123;</span><br><span class="line">            locations.add(<span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(</span><br><span class="line">                shop.getId().toString(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(),shop.getY()))</span><br><span class="line">                         );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-3-实现附近商户功能"><a href="#8-3-实现附近商户功能" class="headerlink" title="8.3 实现附近商户功能"></a>8.3 实现附近商户功能</h3><p>SpringDataRedis的2.3.9版本并不支持Redis6.2提供的GEOSEARCH命令，因此我们需要提示其版本，修改自己的POM文件，内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 排除redis老版本依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 添加redis新版本依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在 <code>ShopServiceImpl</code>的 <code>queryShopByType()</code>方法 实现附近商户功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;ShopMapper, Shop&gt; <span class="keyword">implements</span> <span class="title class_">IShopService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class="line">        <span class="comment">//如果坐标为null，则直接返回数据</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span> || y == <span class="literal">null</span>) &#123;</span><br><span class="line">            Page&lt;Shop&gt; page = query()</span><br><span class="line">                    .eq(<span class="string">&quot;type_id&quot;</span>, typeId)</span><br><span class="line">                    .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;Shop&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">            <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current-<span class="number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo()</span><br><span class="line">                .search(</span><br><span class="line">                        RedisConstants.SHOP_GEO_KEY + typeId,</span><br><span class="line">                        GeoReference.fromCoordinate(x, y),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">5</span> * <span class="number">1000</span>),</span><br><span class="line">                        RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs()</span><br><span class="line">                                .includeDistance()</span><br><span class="line">                                .limit(end));<span class="comment">//截取0~end个数据</span></span><br><span class="line">        <span class="comment">//如果为空的情况</span></span><br><span class="line">        <span class="keyword">if</span> (results == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; content = results.getContent();</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> content.size();</span><br><span class="line">        <span class="comment">//截取的数据有可能为空</span></span><br><span class="line">        <span class="keyword">if</span> (from &gt;= size)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//截取from~end的数据</span></span><br><span class="line">        List&lt;Long&gt; shopIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(size);</span><br><span class="line">        List&lt;Double&gt; distances = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(size);</span><br><span class="line">        content.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class="line">            <span class="comment">//获取shopId</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">shopIdStr</span> <span class="operator">=</span> result.getContent().getName();</span><br><span class="line">            shopIds.add(Long.valueOf(shopIdStr));</span><br><span class="line">            <span class="comment">//获取距离</span></span><br><span class="line">            <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> result.getDistance().getValue();</span><br><span class="line">            distances.add(distance);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">join</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, shopIds);</span><br><span class="line">        <span class="comment">//根据shopId，获得按照顺序的shopList列表</span></span><br><span class="line">        List&lt;Shop&gt; shopList = query()</span><br><span class="line">                .in(<span class="string">&quot;id&quot;</span>, shopIds)</span><br><span class="line">                .last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + join + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">        <span class="comment">//将距离放入shop中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; shopList.size(); i++) &#123;</span><br><span class="line">            shopList.get(i).setDistance(distances.get(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(shopList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="9-用户签到"><a href="#9-用户签到" class="headerlink" title="9.用户签到"></a>9.用户签到</h2><h3 id="9-1-BitMap功能"><a href="#9-1-BitMap功能" class="headerlink" title="9.1 BitMap功能"></a>9.1 BitMap功能</h3><p>用<code>tb_user_sign</code>表来存储用户签到信息</p><p>我们按月来统计用户签到信息，签到记录为1，未签到则记录为0.</p><p><img src="https://s2.loli.net/2023/02/02/QnP8IXoHdGU9NW7.png" class="lazyload" data-srcset="https://s2.loli.net/2023/02/02/QnP8IXoHdGU9NW7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Snipaste_2023-02-02_20-40-50.png"></p><p>把每一个bit位对应当月的每一天，形成了映射关系。用0和1标示业务状态，这种思路就称为位图(BitMap)。</p><p>Redis中是利用string类型数据结构实现<strong>BitMap</strong>，因此最大上限是512M，转换为bit则是$2^{32}$个bit位。</p><p>BitMap的操作命令有：</p><blockquote><ul><li><code>SETBIT</code>：向指定位置(offset)存入一个0或1</li><li><code>GETBIT</code>：获取指定位置(offset)的bit值</li><li><code>BITCOUNT</code>：统计BitMap中值为1的bit位的数量</li><li><code>BITFIELD</code>：操作(查询、修改、自增)BitMap中bit数组中的指定位置(offset)的值</li><li><code>BITFIELD_RO</code>：获取BitMap中bit数组，并以十进制形式返回</li><li><code>BTOP</code>：将多个BitMap的结果做位运算(与、或、异或)</li><li><code>BITPOS</code>：查找bit数组中指定范围内第一个0或1出现的位置</li></ul></blockquote><h3 id="9-2-实现签到功能"><a href="#9-2-实现签到功能" class="headerlink" title="9.2 实现签到功能"></a>9.2 实现签到功能</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="comment">//获取年月</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">format</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.USER_SIGN_KEY + userId + format;</span><br><span class="line">        <span class="comment">//获取本月的第几天</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">day</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line"><span class="comment">//判断今天是否已经签到过</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().getBit(key, day - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (BooleanUtil.isTrue(isSuccess))&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;你今天已经签到过了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//签到</span></span><br><span class="line">        stringRedisTemplate.opsForValue().setBit(key, day-<span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-3-统计连续签到"><a href="#9-3-统计连续签到" class="headerlink" title="9.3 统计连续签到"></a>9.3 统计连续签到</h3><p>连续签到天数：从最后一次签到开始向前统计，直到遇到第一次未签到为止，计算总的签到次数，就是连续签到天数。</p><p>实现连续签到统计功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="comment">//获取年月</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">format</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.USER_SIGN_KEY + userId + format;</span><br><span class="line">        <span class="comment">//获取本月的第几天</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">day</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">        <span class="comment">//获取本月截至今天为止的所有的签到记录，返回的是一个十进制的数字</span></span><br><span class="line">        <span class="comment">//BITFIELD sign:userId:yyyyMM GET day 0</span></span><br><span class="line">        List&lt;Long&gt; values = stringRedisTemplate.opsForValue()</span><br><span class="line">                .bitField(</span><br><span class="line">                        key,</span><br><span class="line">                        BitFieldSubCommands.create()</span><br><span class="line">                                .get(BitFieldSubCommands.BitFieldType.unsigned(day))</span><br><span class="line">                                .valueAt(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">if</span> (values == <span class="literal">null</span> || values.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取bit</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">num</span> <span class="operator">=</span> values.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//从后往前，如果为最后一位为0，则退出循环</span></span><br><span class="line">        <span class="keyword">while</span> ((num &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//不为0，说明已签到</span></span><br><span class="line">            count++;</span><br><span class="line">            <span class="comment">//num无符号右移1位</span></span><br><span class="line">            num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="10-UV统计"><a href="#10-UV统计" class="headerlink" title="10.UV统计"></a>10.UV统计</h2><h3 id="10-1-HyperLogLog的用法"><a href="#10-1-HyperLogLog的用法" class="headerlink" title="10.1 HyperLogLog的用法"></a>10.1 HyperLogLog的用法</h3><p><strong>UV</strong>：全称Unique Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录1次。</p><p><strong>PV</strong>：全称Page View，也叫页面访问量或点击量，用户每访问网站的一个页面，记录1次PV,用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。</p><p>UV统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。但是如果每个访问的用户都保存到Redis中，数据量会非常恐怖。</p><p><strong>Hyperloglog</strong>(HLL)是从Loglog算法派生的概率算法，用于确定非常大的集合的基数，而不需要存储其所有值。</p><p>相关算法原理大家可以参考：<a href="https://juejin.cn/post/6844903785744056333#heading-0">https://juejin.cn/post/6844903785744056333#heading-0</a></p><p>Redis中的HLL是基于string结构实现的，单个HLL的内存永远小于16kb，内存占用低的令人发指！作为代价，其测量结果是概率性的，有小于0.81%的误差。不过对于UV统计来说，这完全可以忽略。</p><p>添加数据：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfadd h1 e1 e2 e3</span><br></pre></td></tr></table></figure><p>统计UV：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfcount h1</span><br></pre></td></tr></table></figure><h3 id="10-2-测试百万数据的统计"><a href="#10-2-测试百万数据的统计" class="headerlink" title="10.2 测试百万数据的统计"></a>10.2 测试百万数据的统计</h3><p>我们直接利用单元测试，向HyperLogLog中添加100万条数据，看看内存占用和统计效果如何：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testHyperLogLog</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//准岛数组，装用户数掘</span></span><br><span class="line">    String[] users = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">1000</span>];</span><br><span class="line">    <span class="comment">//数组角标</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">100000</span>; i++)&#123;</span><br><span class="line">        <span class="comment">//赋值</span></span><br><span class="line">        users[index++] = <span class="string">&quot;user_&quot;</span> + i;</span><br><span class="line">        <span class="comment">//每1000条发送一次</span></span><br><span class="line">        <span class="keyword">if</span>(i%<span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            index = <span class="number">0</span>;</span><br><span class="line">            stringRedisTemplate.opsForHyperLogLog().add(<span class="string">&quot;hll1&quot;</span>,users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//统计数量</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> stringRedisTemplate.opsForHyperLogLog().size(<span class="string">&quot;hll1&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;size = &quot;</span> + size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>输出：size &#x3D; 99839</p></blockquote></div>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2022/08/06/Java/MyBatis-Plus%E6%A1%86%E6%9E%B6/"/>
      <url>/2022/08/06/Java/MyBatis-Plus%E6%A1%86%E6%9E%B6/</url>
      
        <content type="html"><![CDATA[<hr><hr><div class="story post-story"><h2 id="1-初识MyBatis-Plus"><a href="#1-初识MyBatis-Plus" class="headerlink" title="1.初识MyBatis-Plus"></a>1.初识MyBatis-Plus</h2><p>MyBatis-Plus是MyBatis的增强工具，在MyBatis的基础上<strong>只做增强不做改变</strong>，为了<strong>简化开发</strong>，<strong>提高效率</strong>而生</p><p><strong>官网</strong>：<a href="https://baomidou.com/">MyBatis-Plus</a></p><p><strong>特性</strong>：</p><blockquote><ul><li><p><strong>无入侵</strong>：只做增强不做改变，导入它不会对现有工程产生影响。</p></li><li><p><strong>损耗小</strong>：启动即会自动注入基本CRUD，性能基本不损耗，直接面向对象操作</p></li><li><p><strong>强大的CRUD操作</strong>：内置通用Mapper、通用Service，仅仅通过少量配置即可实现单表大部分CRUD操作，更有强大的条件构造器，满足各类使用需求</p></li><li><p><strong>支持Lambda形式调用</strong>：通过Lambda表达式，方便的编写各类查询条件，无需再担心字段写错</p></li><li><p><strong>支持多种数据库</strong>：支持MySQL、MariaDB、 Oracle、 DB2、 H2、 HSQL、 SQLite、 Postgre、SQL Server等多种数据库</p></li><li><p><strong>支持主键自动生成</strong>：支持多达4种主键策略(内含分布式唯一ID生成器- Sequence)，可自由配置，完美解决主键问题</p></li><li><p><strong>支持XML热加载</strong>：Mapper对应的XML支持热加载，对于简单的CRUD操作，甚至可以无XML启动</p></li><li><p><strong>支持ActiveRecord模式</strong>：支持ActiveRecord形式调用，实体类只需继承Model类即可进行强大的CRUD操作</p></li><li><p><strong>支持自定义全局通用操作</strong>：支持全局通用方法注入(Write once，use anywhere)</p></li><li><p><strong>支持关键词自动转义</strong>：支持数据库关键词( order、 key…. )自动转义，还可自定义关键词</p></li><li><p><strong>内置代码生成器</strong>：采用代码或者Maven插件可快速生成Mapper、 Model、Service、Controller层代码，支持模板引擎，更有超多自定义配置等您来使用</p></li><li><p><strong>内置分页插件</strong>：基于MyBatis物理分页，开发者无需关心具体操作，配置好插件之后，写分页等同于普通List查询</p></li><li><p><strong>内置性能分析插件</strong>：可输出Sql语句以及其执行时间，建议开发测试时启用该功能，能快速揪出慢查询</p></li><li><p><strong>内置全局拦截插件</strong>：提供全表delete、update 操作智能分析阻断，也可自定义拦截规则，预防误操作</p></li><li><p><strong>内置Sql注入剥离器</strong>：支持Sql注入剥离，有效预防Sql注入攻击</p></li></ul></blockquote></div><div class="story post-story"><h2 id="2-创建数据库"><a href="#2-创建数据库" class="headerlink" title="2.创建数据库"></a>2.创建数据库</h2><p>创建数据库：</p><ul><li><p>数据名：mp</p></li><li><p>字符集：utf-8</p></li></ul><p>创建表：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建测试表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_user` (</span><br><span class="line">`id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">`user_name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">`password` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">`name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">`age` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">`email` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="3-Mybatis-Plus快速入门"><a href="#3-Mybatis-Plus快速入门" class="headerlink" title="3.Mybatis-Plus快速入门"></a>3.Mybatis-Plus快速入门</h2><p>导入所有依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mybatis-plus插件依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mysql --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 数据库连接池 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 简化bean代码工具 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 单元测试插件依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 日志插件依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.36<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>resourses</code>资源包中，新建<code>log4j.properties</code>文件：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log4j.rootLogger</span>=<span class="string">DEBUG,A1</span></span><br><span class="line"><span class="attr">log4j.appender.A1</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="attr">log4j.appender.A1.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="attr">log4j.appender.A1.layout.ConversionPattern</span>=<span class="string">[%t] [%c]-[%p] %m%n</span></span><br></pre></td></tr></table></figure><p>创建User实体类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> <span class="comment">//生成getter和setterd方法</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span> <span class="comment">// 生成无参构造函数</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span> <span class="comment">// 生成有参构造函数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>项目结构：</p><img src="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220714203703395.png" class="lazyload" data-srcset="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220714203703395.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220714203703395" style="zoom:67%;" /><h3 id="3-1-Mybatis实现查询"><a href="#3-1-Mybatis实现查询" class="headerlink" title="3.1 Mybatis实现查询"></a>3.1 Mybatis实现查询</h3><p>在<code>resources</code>资源包中，创建<code>mybatis-config.xml</code>文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">        PUBLIC <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;environments <span class="keyword">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span><br><span class="line">        &lt;environment id=<span class="string">&quot;development&quot;</span>&gt;</span><br><span class="line">            &lt;transactionManager type=<span class="string">&quot;JDBC&quot;</span>/&gt;</span><br><span class="line">            &lt;dataSource type=<span class="string">&quot;POOLED&quot;</span>&gt;</span><br><span class="line">                &lt;property name=<span class="string">&quot;driver&quot;</span> value=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span><br><span class="line">                &lt;property name=<span class="string">&quot;url&quot;</span> value=<span class="string">&quot;jdbc:mysql://localhost:3306/mp?</span></span><br><span class="line"><span class="string">useUnicode=true&amp;amp;characterEncoding=utf8&amp;amp;autoReconnect=true&amp;amp;allowMultiQuerie</span></span><br><span class="line"><span class="string">s=true&amp;amp;useSSL=false&quot;</span>/&gt;</span><br><span class="line">                &lt;property name=<span class="string">&quot;username&quot;</span> value=<span class="string">&quot;root&quot;</span>/&gt;</span><br><span class="line">                &lt;property name=<span class="string">&quot;password&quot;</span> value=<span class="string">&quot;123456&quot;</span>/&gt;</span><br><span class="line">            &lt;/dataSource&gt;</span><br><span class="line">        &lt;/environment&gt;</span><br><span class="line">    &lt;/environments&gt;</span><br><span class="line">    &lt;mappers&gt;</span><br><span class="line">        &lt;mapper resource=<span class="string">&quot;UserMapper.xml&quot;</span>/&gt;</span><br><span class="line">    &lt;/mappers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><p>创建<code>UserMapper</code>接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    </span><br><span class="line">    List&lt;User&gt; <span class="title function_">findAll</span><span class="params">()</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>resources</code>资源包创建<code>UserMapper.xml</code>文件:：</p><ul><li><p><code>namespace</code>为<code>UserMapper</code>接口的位置</p></li><li><p><code>id</code>为<code>UserMapper</code>中的方法名</p></li><li><p><code>resultType</code>为实体类的位置</p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.mybatisp.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findAll&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.mybatisp.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        select * from tb_user</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p>单元测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindAll</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;mybatis-config.xml&quot;</span>);</span><br><span class="line">    <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(is);</span><br><span class="line"></span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">    <span class="type">UserMapper</span> <span class="variable">userMapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(userMapper.findAll());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[User(id=1, userName=null, password=123456, name=张三, age=18, email=test1@itcast.cn), User(id=2, userName=null, password=123456, name=李四, age=20, email=test2@itcast.cn), User(id=3, userName=null, password=123456, name=王五, age=28, email=test3@itcast.cn), User(id=4, userName=null, password=123456, name=赵六, age=21, email=test4@itcast.cn), User(id=5, userName=null, password=123456, name=孙七, age=24, email=test5@itcast.cn)]</span><br></pre></td></tr></table></figure></blockquote><h3 id="3-2-Mybatis-MP实现查询"><a href="#3-2-Mybatis-MP实现查询" class="headerlink" title="3.2 Mybatis+MP实现查询"></a>3.2 Mybatis+MP实现查询</h3><p>将UserMapper继承BaseMapper，将拥有了BaseMapper中的所有方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; <span class="title function_">findAll</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>单元测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindAll2</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;mybatis-config.xml&quot;</span>);</span><br><span class="line">    <span class="comment">//这里使用的是MP中的MybatisSqlSessionFactoryBuilder</span></span><br><span class="line">    <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisSqlSessionFactoryBuilder</span>().build(is);</span><br><span class="line"></span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line">    <span class="type">UserMapper</span> <span class="variable">userMapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(userMapper.findAll());</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行成功！</p><p>改用BaseMapper中定义的方法查询所有：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindAll2</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;mybatis-config.xml&quot;</span>);</span><br><span class="line">    <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisSqlSessionFactoryBuilder</span>().build(is);</span><br><span class="line"></span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line">    <span class="type">UserMapper</span> <span class="variable">userMapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//System.out.println(userMapper.findAll());</span></span><br><span class="line">    System.out.println(userMapper.selectList(<span class="literal">null</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>报错：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Table &#x27;mp.user&#x27; doesn&#x27;t exist</span><br></pre></td></tr></table></figure><p>报错原因是没有找到<code>user</code>表，因为数据库中的表名为<code>tb_user</code>所以导致没有找到该表。需要指定表：</p><p>在User实体类中与数据库中的表进行映射：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> <span class="comment">//生成getter和setter方法</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span> <span class="comment">// 生成无参构造函数</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span> <span class="comment">// 生成有参构造函数</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_user&quot;)</span> <span class="comment">//指定为tb_user表</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再次运行，成功！</p><h3 id="3-3-Spring-Mybatis-MP"><a href="#3-3-Spring-Mybatis-MP" class="headerlink" title="3.3 Spring+Mybatis+MP"></a>3.3 Spring+Mybatis+MP</h3><p>新建项目：</p><p>导入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.36<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在<code>resources</code>资源包中创建<code>log4j.properties</code>文件：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log4j.rootLogger</span>=<span class="string">DEBUG,A1</span></span><br><span class="line"><span class="attr">log4j.appender.A1</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="attr">log4j.appender.A1.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="attr">log4j.appender.A1.layout.ConversionPattern</span>=<span class="string">[%t] [%c]-[%p] %m%n</span></span><br></pre></td></tr></table></figure><p>在<code>resources</code>资源包中创建<code>jdbc.properties</code>文件：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jdbc.driver</span>=<span class="string">com.mysql.jdbc.driver</span></span><br><span class="line"><span class="attr">jdbc.url</span>=<span class="string">jdbc:mysql://localhost:3306/mp?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line"><span class="attr">jdbc.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">jdbc.password</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure><p>在<code>resources</code>资源包中创建<code>applicationContext.xml</code>文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath*:*.properties&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 定义数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--这里使用MP提供的sqlSessionFactory，完成了Spring与MP的整合--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--扫描mapper接口，使用的依然是Mybatis原生的扫描器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;basePackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mybatisp.mapper&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>创建User实体类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> <span class="comment">//生成getter和setter方法</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span> <span class="comment">// 生成无参构造函数</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span> <span class="comment">// 生成有参构造函数</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建UerMapper接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>单元测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(locations = &quot;classpath:applicationContext.xml&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectList</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(userMapper.selectList(<span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行成功！</p><h3 id="3-4-SpringBoot-Mybaits-MP"><a href="#3-4-SpringBoot-Mybaits-MP" class="headerlink" title="3.4 SpringBoot+Mybaits+MP"></a>3.4 SpringBoot+Mybaits+MP</h3><p>xml版</p><p>项目结构：</p><img src="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220715004613423.png" class="lazyload" data-srcset="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220715004613423.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220715004613423" style="zoom:67%;" /><p>创建springboot项目自动导入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.mybatisp.SpringbootMpApplication<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>application.yml：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/mp?serverTimezone=UTC</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure><p>User实体类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> <span class="comment">//生成getter和setter方法</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span> <span class="comment">// 生成无参构造函数</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span> <span class="comment">// 生成有参构造函数</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserMapper接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>单元测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserMapperTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(userMapper.selectList(<span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行成功！</p></div><div class="story post-story"><h2 id="9-代码生成器"><a href="#9-代码生成器" class="headerlink" title="9.代码生成器"></a>9.代码生成器</h2><p>创建Springboot项目：</p><p>添加下面的依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.freemarker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>创建一个测试类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastAutoGeneratorTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        FastAutoGenerator.create(<span class="string">&quot;jdbc:mysql://localhost:3306/mp?serverTimezone=UTC&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;root&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;123456&quot;</span>)</span><br><span class="line">                .globalConfig(builder -&gt; &#123;</span><br><span class="line">                    builder.author(<span class="string">&quot;baomidou&quot;</span>) <span class="comment">// 设置作者</span></span><br><span class="line">                            <span class="comment">//.enableSwagger() // 开启 swagger 模式</span></span><br><span class="line">                            .fileOverride() <span class="comment">// 覆盖已生成文件</span></span><br><span class="line">                            .outputDir(<span class="string">&quot;E:\\Java_Web\\Mybatis-p\\mp_04_generator\\src\\main\\java&quot;</span>); <span class="comment">// 指定输出目录</span></span><br><span class="line">                &#125;)</span><br><span class="line">                .packageConfig(builder -&gt; &#123;</span><br><span class="line">                    builder.parent(<span class="string">&quot;com&quot;</span>) <span class="comment">// 设置父包名</span></span><br><span class="line">                            .moduleName(<span class="string">&quot;mybatisp&quot;</span>) <span class="comment">// 设置父包模块名</span></span><br><span class="line">                            .pathInfo(Collections.singletonMap(OutputFile.xml, </span><br><span class="line">                                    <span class="string">&quot;E:\\Java_Web\\Mybatis-p\\mp_04_generator\\src\\main\\resources\\mapper&quot;</span>)); <span class="comment">// 设置mapperXml生成路径</span></span><br><span class="line">                &#125;)</span><br><span class="line">                .strategyConfig(builder -&gt; &#123;</span><br><span class="line">                    builder.addInclude(<span class="string">&quot;tb_user&quot;</span>) <span class="comment">// 设置需要生成的表名</span></span><br><span class="line">                            .addTablePrefix(<span class="string">&quot;tb_&quot;</span>, <span class="string">&quot;c_&quot;</span>); <span class="comment">// 设置过滤表前缀</span></span><br><span class="line">                &#125;)</span><br><span class="line">                .templateEngine(<span class="keyword">new</span> <span class="title class_">FreemarkerTemplateEngine</span>()) <span class="comment">// 使用Freemarker引擎模板，默认的是Velocity引擎模板</span></span><br><span class="line">                .execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台打印：</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">08:57:51.095 [main] DEBUG com.baomidou.mybatisplus.generator.AutoGenerator - ==========================准备生成文件...==========================</span><br><span class="line">08:57:51.521 [main] DEBUG com.baomidou.mybatisplus.generator.config.querys.MySqlQuery - 执行SQL:show table status WHERE 1=1  AND NAME IN (&#x27;tb_user&#x27;)</span><br><span class="line">08:57:51.538 [main] DEBUG com.baomidou.mybatisplus.generator.config.querys.MySqlQuery - 返回记录数:1,耗时(ms):16</span><br><span class="line">08:57:51.550 [main] DEBUG com.baomidou.mybatisplus.generator.config.querys.MySqlQuery - 执行SQL:show full fields from `tb_user`</span><br><span class="line">08:57:51.559 [main] DEBUG com.baomidou.mybatisplus.generator.config.querys.MySqlQuery - 返回记录数:6,耗时(ms):9</span><br><span class="line">08:57:51.652 [main] DEBUG com.baomidou.mybatisplus.generator.AutoGenerator - ==========================文件生成完成！！！==========================</span><br></pre></td></tr></table></figure></blockquote><p>以下为生成的文件：</p><img src="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220715090110049.png" class="lazyload" data-srcset="C:\Users\26919\AppData\Roaming\Typora\typora-user-images\image-20220715090110049.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220715090110049" style="zoom:67%;" /></div>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB的学习笔记</title>
      <link href="/2022/08/06/Java/MongoDB_/"/>
      <url>/2022/08/06/Java/MongoDB_/</url>
      
        <content type="html"><![CDATA[<p>未完待续</p><div class="story post-story"><h2 id="1-MongoDB相关概念"><a href="#1-MongoDB相关概念" class="headerlink" title="1.MongoDB相关概念"></a>1.MongoDB相关概念</h2><p>业务场景</p><p>传统的关系型数据库(如：MySQL)，在数据操作的“三高”需求以及应对Web2.0网站需求面前，显得力不从心。</p><p>“三高”需求：</p><blockquote><ul><li>High performance：对数据库高并发读写的需求</li><li>Huge Storage：对海量数据的高效率存储和访问的需求。</li><li>High Scalability &amp;&amp; High Availability：对数据库的高可扩展性和高可用性的需求。</li></ul></blockquote><p>而MongoDB可应对”三高”需求，貝体的应用场景如：</p><blockquote><ol><li>社交场景：使用MongoDB 存储存储用户信息，以及用户发表的朋友圖信息，通过地理位置素引1实现附近的<br>人、地点等功能。</li><li>游戏场景：使用 MongoDB 存储游戏用户信息，用户的装备、积分等直接以内嵌文档的形式存储，方便查询<br>高效率存储和访问。</li><li>物流场员：使用 MongoDB 存储订单信息，订单状态在运送过程中会不断更新，以MongODB 内嵌数组的开式来存储，一次查询就能将订单所有的变更读取出来。</li><li>物联网场景：使用MongoDB 存储所有接入的智能设备信息，以及设备汇报的日志信息，并对这些信息进行多<br>维度的分析。</li><li>视频直播：使用 MongoDB 存储用户信息、点赞互动信息等。</li></ol></blockquote><p>这些应用场景，对数据操作方面的共同特点是：</p><blockquote><ol><li>数据量大</li><li>写入操作频繁(读写很频繁)</li><li>价值较低的数据，对事务性要求不高(缺点)</li></ol><p>对于这样的数据，我们更适合使用MongoDB来实现数据的存储</p></blockquote><p>何时选择MongoDB？</p><p>在架构选型上，除了上述的三个特点外，如果你还犹豫是否要选择它？可以考忠以下的一些问题：</p><blockquote><ul><li><p>应用不需要車务及复杂 ioin 支持</p></li><li><p>新应用，需求会变，数据模型无法确定，想快速迭代开发</p></li><li><p>应用需要2000-3000以上的读写OPS（更高也可以）</p></li><li><p>应用需要TB甚至 PB级别数据存储</p></li><li><p>应用发展迅速，需要能快速水平扩展</p></li><li><p>应用要求存储的数据不天失</p></li><li><p>应用需要99.999%高可用</p></li><li><p>应用需要大量的地理位置查询、文本查询</p></li></ul><p>如果上述有1个符合，可以考虑MongoDB， 2个及以上的符合，选择MongoDB 绝不会后悔。</p></blockquote><p>数据库：articledb</p><p>专栏文章评论(表)：comment</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>备注</th></tr></thead><tbody><tr><td>_id</td><td>ID</td><td>ObjectId或String</td><td>Mongo的主键的字段</td></tr><tr><td>articleid</td><td>文章ID</td><td>String</td><td></td></tr><tr><td>content</td><td>评论内容</td><td>String</td><td></td></tr><tr><td>userid</td><td>评论人ID</td><td>String</td><td></td></tr><tr><td>nickname</td><td>评论人昵称</td><td>String</td><td></td></tr><tr><td>createdatetime</td><td>评论的日期时间</td><td>Date</td><td></td></tr><tr><td>likenum</td><td>点赞数</td><td>Int32</td><td></td></tr><tr><td>replynum</td><td>回复数</td><td>Int32</td><td></td></tr><tr><td>state</td><td>状态</td><td>String</td><td>0：不可见<br/>1：可见</td></tr><tr><td>parentid</td><td>上级ID</td><td>String</td><td>如果为0表示文章的顶级评论</td></tr></tbody></table></div><div class="story post-story"><h2 id="2-MongoDB的相关命令"><a href="#2-MongoDB的相关命令" class="headerlink" title="2.MongoDB的相关命令"></a>2.MongoDB的相关命令</h2><h3 id="2-1-数据库的创建与删除"><a href="#2-1-数据库的创建与删除" class="headerlink" title="2.1 数据库的创建与删除"></a>2.1 数据库的创建与删除</h3><table><thead><tr><th align="center">命令</th><th>解释</th><th>例子</th></tr></thead><tbody><tr><td align="center">use <code>数据库名</code></td><td>选择数据库，如果不存在则创建</td><td>use articledb</td></tr><tr><td align="center">show dbs或<br>show databases</td><td>查看所有数据库</td><td></td></tr><tr><td align="center">db</td><td>查看当前正在使用的数据库</td><td></td></tr><tr><td align="center">db.dropDatabase()</td><td>删除当前正在的使用的数据库</td><td></td></tr><tr><td align="center">db.createCollection(<code>name</code>)<br><code>name</code>: 要创建的集合名称</td><td>显示创建集合(了解)</td><td>db.createCollection(“mycollection”)</td></tr><tr><td align="center">show collections或<br>show tables</td><td>查看当前数据库中的表</td><td></td></tr><tr><td align="center">db.<code>集合</code>.drop()</td><td>删除当前正在的使用的数据库中的集合</td><td>db.mycollection.drop()</td></tr></tbody></table><p>文档(document)的数据结构与JSON基本一致，所有存储在集合中的数据都是BSON格式</p><h3 id="2-2-文档的插入"><a href="#2-2-文档的插入" class="headerlink" title="2.2 文档的插入"></a>2.2 文档的插入</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.insert(</span><br><span class="line">&lt;document or array of documents&gt;<span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">writeConcern<span class="punctuation">:</span> &lt;document&gt;<span class="punctuation">,</span></span><br><span class="line">ordered<span class="punctuation">:</span> &lt;boolean&gt;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>单个文档插入</strong>：</p><p>使用insert()或save()方法插入：</p><blockquote><p>db.<code>collection</code>.insert(<code>document</code>)</p></blockquote><p>示例：</p><p>向comment集合中插入一条数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insert(<span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;articleid&quot;</span><span class="punctuation">:</span><span class="string">&quot;100000&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;content&quot;</span><span class="punctuation">:</span><span class="string">&quot;今天天气真好，阳光明媚&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span><span class="punctuation">:</span><span class="string">&quot;1001&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;Tom&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;createdatetime&quot;</span><span class="punctuation">:</span>new Date()<span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;likenum&quot;</span><span class="punctuation">:</span>NumberInt(<span class="number">10</span>)<span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;state&quot;</span><span class="punctuation">:</span><span class="keyword">null</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><blockquote><ol><li>comment集合如果不存在，则会隐式创建 。</li><li>mongo中的数字，默认情况下是double类型，如果要存整型，必须使用函数NumberInt(整型数字)，否则取出来就有问题了。</li><li>插入当前日期使用 new Date()</li><li>插入的数据没有指定 _id ，会自动生成主键值</li><li>如果某字段没值，可以赋值为null，或不写该字段。</li></ol></blockquote><p>如果出现：<code>WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</code>，说明插入成功。</p><p><strong>多条文档插入</strong>：</p><blockquote><p>db.comment.insertMany([<code>document1</code>,<code>document2</code>,…])</p></blockquote><p>示例：</p><p>向comment集合中插入多条数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insertMany(<span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;articleid&quot;</span><span class="punctuation">:</span><span class="string">&quot;100001&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span><span class="string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;userid&quot;</span><span class="punctuation">:</span><span class="string">&quot;1002&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;相忘于江湖&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;createdatetime&quot;</span><span class="punctuation">:</span>new Date(<span class="string">&quot;2019-08-05T22:08:15.522Z&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;likenum&quot;</span><span class="punctuation">:</span>NumberInt(<span class="number">1000</span>)<span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;articleid&quot;</span><span class="punctuation">:</span><span class="string">&quot;100001&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span><span class="string">&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;userid&quot;</span><span class="punctuation">:</span><span class="string">&quot;1005&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;伊人憔悴&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;createdatetime&quot;</span><span class="punctuation">:</span>new Date(<span class="string">&quot;2019-08-05T23:58:51.485Z&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;likenum&quot;</span><span class="punctuation">:</span>NumberInt(<span class="number">888</span>)<span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span>)</span><br></pre></td></tr></table></figure><blockquote><p>插入时指定了 _id ，则主键就是该值。 </p><p>如果某条数据插入失败，将会终止插入，但已经插入成功的数据不会回滚掉。 </p></blockquote><p>批量插入由于数据较多容易出现失败，因此，可以使用try catch进行异常捕捉处理，测试的时候可以不处理。如（了解）：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">try <span class="punctuation">&#123;</span></span><br><span class="line">db.comment.insertMany(<span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;articleid&quot;</span><span class="punctuation">:</span><span class="string">&quot;100001&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span><span class="string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;userid&quot;</span><span class="punctuation">:</span><span class="string">&quot;1002&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;相忘于江湖&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;createdatetime&quot;</span><span class="punctuation">:</span>new Date(<span class="string">&quot;2019-08-05T22:08:15.522Z&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;likenum&quot;</span><span class="punctuation">:</span>NumberInt(<span class="number">1000</span>)<span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;articleid&quot;</span><span class="punctuation">:</span><span class="string">&quot;100001&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span><span class="string">&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;userid&quot;</span><span class="punctuation">:</span><span class="string">&quot;1005&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;伊人憔悴&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;createdatetime&quot;</span><span class="punctuation">:</span>new Date(<span class="string">&quot;2019-08-05T23:58:51.485Z&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;likenum&quot;</span><span class="punctuation">:</span>NumberInt(<span class="number">888</span>)<span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span>)</span><br><span class="line"><span class="punctuation">&#125;</span> catch (e) <span class="punctuation">&#123;</span></span><br><span class="line">print (e);</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-3-文档的查询"><a href="#2-3-文档的查询" class="headerlink" title="2.3 文档的查询"></a>2.3 文档的查询</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(&lt;query&gt;<span class="punctuation">,</span> <span class="punctuation">[</span>projection<span class="punctuation">]</span>)</span><br></pre></td></tr></table></figure><p><strong>查询所有</strong>：</p><p>查询comment集合的所有文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find() 或 </span><br><span class="line">db.comment.find(<span class="punctuation">&#123;</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p><strong>条件查询</strong>：</p><p>查询询userid为1003的记录</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span>&#x27;<span class="number">1003</span>&#x27;<span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>如果只需要返回第一条数据</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.findOne(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span>&#x27;<span class="number">1003</span>&#x27;<span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p><strong>投影查询</strong>：查询结果返回部分字段</p><p>查询结果显示userid和nickname：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="string">&quot;1003&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span>nickname<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1003&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;凯撒&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;5&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1003&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;凯撒&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>默认 _id 会显示。</p><p>查询结果只显示userid和nickname，不显示_id：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="string">&quot;1003&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span>nickname<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span>_id<span class="punctuation">:</span><span class="number">0</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1003&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;凯撒&quot;</span> <span class="punctuation">&#125;</span> </span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1003&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;凯撒&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-4-文档的更新"><a href="#2-4-文档的更新" class="headerlink" title="2.4 文档的更新"></a>2.4 文档的更新</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update(query<span class="punctuation">,</span> update<span class="punctuation">,</span> options)</span><br><span class="line">或</span><br><span class="line">db.collection.update(</span><br><span class="line">&lt;query&gt;<span class="punctuation">,</span></span><br><span class="line">&lt;update&gt;<span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">upsert<span class="punctuation">:</span> &lt;boolean&gt;<span class="punctuation">,</span></span><br><span class="line">multi<span class="punctuation">:</span> &lt;boolean&gt;<span class="punctuation">,</span></span><br><span class="line">writeConcern<span class="punctuation">:</span> &lt;document&gt;<span class="punctuation">,</span></span><br><span class="line">collation<span class="punctuation">:</span> &lt;document&gt;<span class="punctuation">,</span></span><br><span class="line">arrayFilters<span class="punctuation">:</span> <span class="punctuation">[</span> &lt;filterdocument1&gt;<span class="punctuation">,</span> ... <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">hint<span class="punctuation">:</span> &lt;document|string&gt; <span class="comment">// Available starting in MongoDB 4.2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>覆盖修改</strong>：</p><p>修改_id为1的记录，点赞量为1001</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(<span class="punctuation">&#123;</span>_id<span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>likenum<span class="punctuation">:</span>NumberInt(<span class="number">1001</span>)<span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>执行后，这条文档除了<code>likenum</code>字段其它字段都不见了</p><p><strong>局部修改</strong>：们需要使用修改器<code>$set</code>来实现</p><p>修改_id为2的记录，点赞量为889</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(<span class="punctuation">&#123;</span>_id<span class="punctuation">:</span><span class="string">&quot;2&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>$set<span class="punctuation">:</span><span class="punctuation">&#123;</span>likenum<span class="punctuation">:</span>NumberInt(<span class="number">889</span>)<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p><strong>批量修改</strong>：</p><p>更新用户id为<code>1003</code>的用户的昵称为<code>大黄</code> </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认只修改第一条数据</span></span><br><span class="line">db.comment.update(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="string">&quot;1003&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>$set<span class="punctuation">:</span><span class="punctuation">&#123;</span>nickname<span class="punctuation">:</span><span class="string">&quot;大黄&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>)</span><br><span class="line"><span class="comment">//修改所有符合条件的数据</span></span><br><span class="line">db.comment.update(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="string">&quot;1003&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>$set<span class="punctuation">:</span><span class="punctuation">&#123;</span>nickname<span class="punctuation">:</span><span class="string">&quot;大黄&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>multi<span class="punctuation">:</span><span class="keyword">true</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>列值增长修改：使用<code>$inc</code>运算符来实现对某列值在原有值的基础上进行增加或减少</p><p>对3号数据的点赞数，每次递增1</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(<span class="punctuation">&#123;</span>_id<span class="punctuation">:</span><span class="string">&quot;3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>$inc<span class="punctuation">:</span><span class="punctuation">&#123;</span>likenum<span class="punctuation">:</span>NumberInt(<span class="number">1</span>)<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><h3 id="2-5-文档的删除"><a href="#2-5-文档的删除" class="headerlink" title="2.5 文档的删除"></a>2.5 文档的删除</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.remove(条件)</span><br></pre></td></tr></table></figure><p>将数据全部删除：(谨慎使用)</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.remove(<span class="punctuation">&#123;</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>删除_id&#x3D;1的记录：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.remove(<span class="punctuation">&#123;</span>_id<span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><h3 id="2-6-文档的分页查询"><a href="#2-6-文档的分页查询" class="headerlink" title="2.6 文档的分页查询"></a>2.6 文档的分页查询</h3><p><strong>统计查询</strong>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.count(query<span class="punctuation">,</span> options)</span><br></pre></td></tr></table></figure><p>统计所有记录数：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.count()</span><br></pre></td></tr></table></figure><p>按条件统计记录数：</p><p>统计userid为1003的记录条数</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.count(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="string">&quot;1003&quot;</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p> <strong>分页列表查询</strong>：使用<code>limit()</code>方法来读取指定数量的数据，使用<code>skip()</code>方法来跳过指定数量的数据。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find().limit(NUMBER).skip(NUMBER)</span><br></pre></td></tr></table></figure><p>返回指定条数的记录，可以在find方法后调用limit来返回结果(TopN)，默认值20</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().limit(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>skip方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）,默认值是0</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().skip(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p><strong>分页查询</strong>：需求：每页2个，第二页开始：跳过前两条数据，接着值显示3和4条数据</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一页</span></span><br><span class="line">db.comment.find().skip(<span class="number">0</span>).limit(<span class="number">2</span>)</span><br><span class="line"><span class="comment">//第二页</span></span><br><span class="line">db.comment.find().skip(<span class="number">2</span>).limit(<span class="number">2</span>)</span><br><span class="line"><span class="comment">//第三页</span></span><br><span class="line">db.comment.find().skip(<span class="number">4</span>).limit(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p><strong>排序查询</strong>：</p><p><code>sort()</code> 方法对数据进行排序，<code>sort()</code> 方法可以通过参数指定排序的字段，</p><p>并使用 <code>1</code> 和 <code>-1</code> 来指定排序的方式，其中 1 为升序排列，而 -1 是用 于降序排列。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find().sort(<span class="punctuation">&#123;</span>KEY<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span>)</span><br><span class="line">或</span><br><span class="line">db.集合名称.find().sort(排序方式)</span><br></pre></td></tr></table></figure><p>对userid降序排列，并对访问量进行升序排列</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().sort(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="number">-1</span><span class="punctuation">,</span>likenum<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><blockquote><p><code>skip()</code>, <code>limilt()</code>, <code>sort()</code>三个放在一起执行的时候，</p><p>执行的顺序：<code>sort()</code>&#x3D;&gt;<code>skip()</code>&#x3D;&gt;<code>limit()</code>，和命令编写顺序无关</p></blockquote><h3 id="2-7-文档的更多查询"><a href="#2-7-文档的更多查询" class="headerlink" title="2.7 文档的更多查询"></a>2.7 文档的更多查询</h3><p><strong>正则的复杂条件查询</strong>：</p><p>正则表达式是<code>js</code>的语法，直接量的写法。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(<span class="punctuation">&#123;</span>field<span class="punctuation">:</span>/正则表达式/<span class="punctuation">&#125;</span>)</span><br><span class="line">或</span><br><span class="line">db.集合.find(<span class="punctuation">&#123;</span>字段<span class="punctuation">:</span>/正则表达式/<span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>查询评论内容包含“开水”的所有文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>content<span class="punctuation">:</span>/开水/<span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>查询评论的内容中以“专家”开头的</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>content<span class="punctuation">:</span>/^专家/<span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p><strong>比较查询</strong>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.find(<span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> $gt<span class="punctuation">:</span> value <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>) <span class="comment">// 大于: field &gt; value</span></span><br><span class="line">db.集合名称.find(<span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> $lt<span class="punctuation">:</span> value <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>) <span class="comment">// 小于: field &lt; value</span></span><br><span class="line">db.集合名称.find(<span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> $gte<span class="punctuation">:</span> value <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>) <span class="comment">// 大于等于: field &gt;= value</span></span><br><span class="line">db.集合名称.find(<span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> $lte<span class="punctuation">:</span> value <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>) <span class="comment">// 小于等于: field &lt;= value</span></span><br><span class="line">db.集合名称.find(<span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> $ne<span class="punctuation">:</span> value <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>) <span class="comment">// 不等于: field != value、</span></span><br></pre></td></tr></table></figure><p>查询评论点赞数量大于700的记录</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>likenum<span class="punctuation">:</span><span class="punctuation">&#123;</span>$gt<span class="punctuation">:</span>NumberInt(<span class="number">700</span>)<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p><strong>包含查询</strong>：包含使用<code>$in</code>操作符，不包含使用<code>$nin</code>操作符</p><p>查询评论集合中<code>userid</code>字段包含1003或1004的文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="punctuation">&#123;</span>$in<span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;1003&quot;</span><span class="punctuation">,</span><span class="string">&quot;1004&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>查询评论集合中<code>userid</code>字段不包含1003和1004的文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="punctuation">&#123;</span>$nin<span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;1003&quot;</span><span class="punctuation">,</span><span class="string">&quot;1004&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p><strong>条件连接查询</strong>：</p><p>查询同时满足两个以上条件，需要使用<code>$and</code>操作符将条件进行关联</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$and<span class="punctuation">:</span><span class="punctuation">[</span> <span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>查询评论集合中<code>likenum</code>大于等于700 并且小于2000的文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>$and<span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span>likenum<span class="punctuation">:</span><span class="punctuation">&#123;</span>$gte<span class="punctuation">:</span>NumberInt(<span class="number">700</span>)<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>likenum<span class="punctuation">:</span><span class="punctuation">&#123;</span>$lt<span class="punctuation">:</span>NumberInt(<span class="number">2000</span>)<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>两个以上条件之间是或者的关系，我们使用 <code>$or</code> 操作符进行关联</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$or<span class="punctuation">:</span><span class="punctuation">[</span> <span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>查询评论集合中<code>userid</code>为1003，或者点赞数小于1000的文档记录</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>$or<span class="punctuation">:</span><span class="punctuation">[</span> <span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="string">&quot;1003&quot;</span><span class="punctuation">&#125;</span> <span class="punctuation">,</span><span class="punctuation">&#123;</span>likenum<span class="punctuation">:</span><span class="punctuation">&#123;</span>$lt<span class="punctuation">:</span><span class="number">1000</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><h3 id="2-8-常用命令小结"><a href="#2-8-常用命令小结" class="headerlink" title="2.8 常用命令小结*"></a>2.8 常用命令小结*</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//选择切换数据库：</span></span><br><span class="line">use articledb</span><br><span class="line"><span class="comment">//插入数据：</span></span><br><span class="line">db.comment.insert(<span class="punctuation">&#123;</span>bson数据<span class="punctuation">&#125;</span>)</span><br><span class="line"><span class="comment">//查询所有数据：</span></span><br><span class="line">db.comment.find();</span><br><span class="line"><span class="comment">//条件查询数据：</span></span><br><span class="line">db.comment.find(<span class="punctuation">&#123;</span>条件<span class="punctuation">&#125;</span>)</span><br><span class="line"><span class="comment">//查询符合条件的第一条记录：</span></span><br><span class="line">db.comment.findOne(<span class="punctuation">&#123;</span>条件<span class="punctuation">&#125;</span>)</span><br><span class="line"><span class="comment">//查询符合条件的前几条记录：</span></span><br><span class="line">db.comment.find(<span class="punctuation">&#123;</span>条件<span class="punctuation">&#125;</span>).limit(条数)</span><br><span class="line"><span class="comment">//查询符合条件的跳过的记录：</span></span><br><span class="line">db.comment.find(<span class="punctuation">&#123;</span>条件<span class="punctuation">&#125;</span>).skip(条数)</span><br><span class="line"><span class="comment">//修改数据：</span></span><br><span class="line">db.comment.update(<span class="punctuation">&#123;</span>条件<span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>修改后的数据<span class="punctuation">&#125;</span>) </span><br><span class="line">或</span><br><span class="line">db.comment.update(<span class="punctuation">&#123;</span>条件<span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>$set<span class="punctuation">:</span><span class="punctuation">&#123;</span>要修改部分的字段<span class="punctuation">:</span>数据<span class="punctuation">&#125;</span>)</span><br><span class="line"><span class="comment">//修改数据并自增某字段值：</span></span><br><span class="line">db.comment.update(<span class="punctuation">&#123;</span>条件<span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>$inc<span class="punctuation">:</span><span class="punctuation">&#123;</span>自增的字段<span class="punctuation">:</span>步进值<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>)</span><br><span class="line"><span class="comment">//删除数据：</span></span><br><span class="line">db.comment.remove(<span class="punctuation">&#123;</span>条件<span class="punctuation">&#125;</span>)</span><br><span class="line"><span class="comment">//统计查询：</span></span><br><span class="line">db.comment.count(<span class="punctuation">&#123;</span>条件<span class="punctuation">&#125;</span>)</span><br><span class="line"><span class="comment">//模糊查询：</span></span><br><span class="line">db.comment.find(<span class="punctuation">&#123;</span>字段名<span class="punctuation">:</span>/正则表达式/<span class="punctuation">&#125;</span>)</span><br><span class="line"><span class="comment">//条件比较运算：</span></span><br><span class="line">db.comment.find(<span class="punctuation">&#123;</span>字段名<span class="punctuation">:</span><span class="punctuation">&#123;</span>$gt<span class="punctuation">:</span>值<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>)</span><br><span class="line"><span class="comment">//包含查询：</span></span><br><span class="line">db.comment.find(<span class="punctuation">&#123;</span>字段名<span class="punctuation">:</span><span class="punctuation">&#123;</span>$in<span class="punctuation">:</span><span class="punctuation">[</span>值<span class="number">1</span>，值<span class="number">2</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>)或db.comment.find(<span class="punctuation">&#123;</span>字段名<span class="punctuation">:</span><span class="punctuation">&#123;</span>$nin<span class="punctuation">:</span><span class="punctuation">[</span>值<span class="number">1</span>，值<span class="number">2</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>)</span><br><span class="line"><span class="comment">//条件连接查询：</span></span><br><span class="line">db.comment.find(<span class="punctuation">&#123;</span>$and<span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span>条件<span class="number">1</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>条件<span class="number">2</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span>)或db.comment.find(<span class="punctuation">&#123;</span>$or<span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span>条件<span class="number">1</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>条件<span class="number">2</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="3-索引"><a href="#3-索引" class="headerlink" title="3.索引"></a>3.索引</h2><p>索引支持在MongoDB中高效地执行查询。</p><p>如果没有索引，MongoDB必须执行全集合扫描，即扫描集合中的每个文档，以选择与查询语句匹配的文档。</p><p>这种扫描全集合的查询效率是非常低的，特别在处理大量的数据时，查询可以要花费几十秒甚至几分钟，这对网站的性能是非常致命的。</p><p>索引是特殊的数据结构，它以易于遍历的形式存储集合数据集的一小部分。</p><p>索引存储特定字段或一组字段的值，按字段值排序。</p><p>索引项的排序支持有效的相等匹配和基于范围的查询操作。</p><p>此外，MongoDB还可以使用索引中的排序返回排序结果。</p><p>MongoDB索引使用B树数据结构（确切的说是B-Tree，MySQL是B+Tree）</p><h3 id="3-1-索引的类型"><a href="#3-1-索引的类型" class="headerlink" title="3.1 索引的类型"></a>3.1 索引的类型</h3><p><strong>单字段索引</strong>：</p><p>MongoDB支持在文档的单个字段上创建用户定义的升序&#x2F;降序索引，称为单字段索引(Single Field Index)</p><p>对于单个字段索引和排序操作，索引键的排序顺序(即升序或降序)并不重要，因为MongoDB可以在任何方向上遍历索引</p><p><strong>复合索引</strong>：</p><p>MongoDB还支持多个字段的用户定义索引，即复合索引(Compound Index)</p><p>复合索引中列出的字段顺序具有重要意义。</p><p>例如，如果复合索引由 { userid: 1, score: -1 } 组成，则索引首先按userid正序排序，然后 在每个userid的值内，再在按score倒序排序。</p><p><strong>其他索引</strong>：</p><p>地理空间索引(Geospatial Index)、文本索引(Text Indexes)、哈希索引(Hashed Indexes)。 </p><ul><li><p>地理空间索引(Geospatial Index)：</p><p>为了支持对地理空间坐标数据的有效查询，MongoDB提供了两种特殊的索引：返回结果时使用平面几何的二维索引和返回结果时使用球面 几何的二维球面索引。 </p></li><li><p>文本索引(Text Indexes)：</p><p>MongoDB提供了一种文本索引类型，支持在集合中搜索字符串内容。这些文本索引不存储特定于语言的停止词（例如“the”、“a”、“or”）， 而将集合中的词作为词干，只存储根词。 </p></li><li><p>哈希索引(Hashed Indexes)：</p><p>为了支持基于散列的分片，MongoDB提供了散列索引类型，它对字段值的散列进行索引。这些索引在其范围内的值分布更加随机，但只支 持相等匹配，不支持基于范围的查询。</p></li></ul><h3 id="3-2-索引的管理操作"><a href="#3-2-索引的管理操作" class="headerlink" title="3.2 索引的管理操作"></a>3.2 索引的管理操作</h3><p><strong>索引的查看</strong>：返回一个集合中的所有索引的数组</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.getIndexes() <span class="comment">//该语法命令运行要求是MongoDB 3.0+</span></span><br></pre></td></tr></table></figure><p>例：查看comment集合中所有的索引情况</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.getIndexes()</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;v&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_id_&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;ns&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;articledb.comment&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>默认<code>_id</code>索引：</p><p>MongoDB在创建集合的过程中，在 <code>_id</code> 字段上创建一个唯一的索引，默认名字为 <code>_id_</code> ，该索引可防止客户端插入两个具有相同值的文 档，不能在<code>_id</code>字段上删除此索引。 </p><p>注意：该索引是唯一索引，因此值不能重复，即 <code>_id</code> 值不能重复的。在分片集群中，通常使用 <code>_id</code> 作为片键。</p><p><strong>索引的创建</strong>：在集合上创建索引</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.createIndex(keys<span class="punctuation">,</span> options)</span><br></pre></td></tr></table></figure><p>在3.0.0版本前创建索引方法为<code>db.collection.ensureIndex()</code>，之后的版本使用了 <code>db.collection.createIndex()</code>方法，<code>ensureIndex()</code>还能用，但只是<code>createIndex()</code>的别名</p><p>单字段索引示例：对 userid 字段建立索引</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;createdCollectionAutomatically&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> <span class="comment">//按升序创建索引</span></span><br><span class="line"><span class="attr">&quot;numIndexesBefore&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;numIndexesAfter&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;ok&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>查看索引：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.getIndexes()</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;v&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_id_&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;ns&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;articledb.comment&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;v&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;userid_1&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;ns&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;articledb.comment&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p><strong>索引的移除</strong>：可以移除指定的索引，或移除所有索引</p><p>指定索引的移除：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.dropIndex(index)</span><br></pre></td></tr></table></figure><p>例：删除 <code>comment</code> 集合中 <code>userid</code> 字段上的升序索引</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.dropIndex(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>所有索引的移除：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.dropIndexes()</span><br></pre></td></tr></table></figure><p>例：删除集合中所有索引</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.dropIndexes() <span class="comment">//_id的字段的索引是无法删除的，只能删除非_id字段的索引</span></span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;nIndexesWas&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;msg&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;non-_id indexes dropped for collection&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;ok&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="3-3-索引的使用"><a href="#3-3-索引的使用" class="headerlink" title="3.3 索引的使用"></a>3.3 索引的使用</h3><p><strong>执行计划</strong>：</p><p>分析查询性能（Analyze Query Performance）通常使用执行计划（解释计划、Explain Plan）来查看查询的情况，如：查询耗费的时间、是 否基于索引查询等。 </p><p>建立的索引是否有效，效果如何，都需要通过执行计划查看：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(query<span class="punctuation">,</span>options).explain(options)</span><br></pre></td></tr></table></figure><p>例：查看根据<code>userid</code>查询数据的情况</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="string">&quot;1003&quot;</span><span class="punctuation">&#125;</span>).explain()</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;queryPlanner&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;plannerVersion&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;namespace&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;articledb.comment&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;indexFilterSet&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;parsedQuery&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;$eq&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1003&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;winningPlan&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;stage&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;COLLSCAN&quot;</span><span class="punctuation">,</span> <span class="comment">//表示全集合扫描</span></span><br><span class="line"><span class="attr">&quot;filter&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;$eq&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1003&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;direction&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;forward&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;rejectedPlans&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;serverInfo&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;host&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;9ef3740277ad&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;port&quot;</span> <span class="punctuation">:</span> <span class="number">27017</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4.0.10&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;gitVersion&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;c389e7f69f637f7a1ac3cc9fae843b635f20b766&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;ok&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>例：对<code>userid</code>建立索引</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;createdCollectionAutomatically&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;numIndexesBefore&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;numIndexesAfter&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;ok&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>再次查看执行计划：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="string">&quot;1013&quot;</span><span class="punctuation">&#125;</span>).explain()</span><br></pre></td></tr></table></figure><p>结果·：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;queryPlanner&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;plannerVersion&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;namespace&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;articledb.comment&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;indexFilterSet&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;parsedQuery&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;$eq&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1013&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;winningPlan&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;stage&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;FETCH&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;inputStage&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;stage&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;IXSCAN&quot;</span><span class="punctuation">,</span> <span class="comment">//基于索引的扫描</span></span><br><span class="line"><span class="attr">&quot;keyPattern&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;indexName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;userid_1&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isMultiKey&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;multiKeyPaths&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isUnique&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isSparse&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isPartial&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;indexVersion&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;direction&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;forward&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;indexBounds&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;[\&quot;1013\&quot;, \&quot;1013\&quot;]&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;rejectedPlans&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;serverInfo&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;host&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;9ef3740277ad&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;port&quot;</span> <span class="punctuation">:</span> <span class="number">27017</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4.0.10&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;gitVersion&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;c389e7f69f637f7a1ac3cc9fae843b635f20b766&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;ok&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>涵盖的查询</strong>：</p><p>当查询条件和查询的投影仅包含索引字段时，MongoDB直接从索引返回结果，而不扫描任何文档或将文档带入内存。 这些覆盖的查询可以非常有效</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="string">&quot;1003&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span>_id<span class="punctuation">:</span><span class="number">0</span><span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1003&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1003&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(<span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="string">&quot;1003&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span>userid<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span>_id<span class="punctuation">:</span><span class="number">0</span><span class="punctuation">&#125;</span>).explain()</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;queryPlanner&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;plannerVersion&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;namespace&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;articledb.comment&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;indexFilterSet&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;parsedQuery&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;$eq&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1003&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;winningPlan&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;stage&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;PROJECTION&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;transformBy&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;inputStage&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;stage&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;IXSCAN&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;keyPattern&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;indexName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;userid_1&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isMultiKey&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;multiKeyPaths&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isUnique&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isSparse&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isPartial&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;indexVersion&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;direction&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;forward&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;indexBounds&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;userid&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;[\&quot;1003\&quot;, \&quot;1003\&quot;]&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;rejectedPlans&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;serverInfo&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;host&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bobohost.localdomain&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;port&quot;</span> <span class="punctuation">:</span> <span class="number">27017</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4.0.10&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;gitVersion&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;c389e7f69f637f7a1ac3cc9fae843b635f20b766&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;ok&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="4-文章评论"><a href="#4-文章评论" class="headerlink" title="4.文章评论"></a>4.文章评论</h2><h3 id="4-1-案例分析"><a href="#4-1-案例分析" class="headerlink" title="4.1 案例分析"></a>4.1 案例分析</h3><p>案例：实现某头条的文章评论</p><p>需要实现一下功能：</p><blockquote><ol><li>基本的增删改查API</li><li>根据文章id查询评论</li><li>评论点赞</li></ol></blockquote><p>数据库：articledb</p><p>专栏文章评论(表)：comment</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>备注</th></tr></thead><tbody><tr><td>_id</td><td>ID</td><td>ObjectId或String</td><td>Mongo的主键的字段</td></tr><tr><td>articleid</td><td>文章ID</td><td>String</td><td></td></tr><tr><td>content</td><td>评论内容</td><td>String</td><td></td></tr><tr><td>userid</td><td>评论人ID</td><td>String</td><td></td></tr><tr><td>nickname</td><td>评论人昵称</td><td>String</td><td></td></tr><tr><td>createdatetime</td><td>评论的日期时间</td><td>Date</td><td></td></tr><tr><td>likenum</td><td>点赞数</td><td>Int32</td><td></td></tr><tr><td>replynum</td><td>回复数</td><td>Int32</td><td></td></tr><tr><td>state</td><td>状态</td><td>String</td><td>0：不可见<br/>1：可见</td></tr><tr><td>parentid</td><td>上级ID</td><td>String</td><td>如果为0表示文章的顶级评论</td></tr></tbody></table><p>技术选型：</p><blockquote><ul><li><p>mongodb-driver(了解)</p><p>mongodb-driver是mongo官方推出的java连接mongoDB的驱动包，相当于JDBC驱动</p></li><li><p>SpringDataMongoDB</p><p>SpringData家族成员之一，用于操作MongoDB的持久层框架，封装了底层的mongodb-driver。</p></li></ul></blockquote><p>项目结构：</p><img src="https://s2.loli.net/2022/07/25/b3wpiTWvNY9aGn4.png" class="lazyload" data-srcset="https://s2.loli.net/2022/07/25/b3wpiTWvNY9aGn4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220725105709041" style="zoom: 67%;" /><h3 id="4-2-文章微服务模块搭建"><a href="#4-2-文章微服务模块搭建" class="headerlink" title="4.2 文章微服务模块搭建"></a>4.2 文章微服务模块搭建</h3><p>导入坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-rds-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在<code>application.yml</code>中：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#数据源配置</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="comment">#默认主机地址</span></span><br><span class="line">      <span class="attr">database:</span> <span class="string">articledb</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">27017</span> <span class="comment">#默认端口27017</span></span><br><span class="line">      <span class="comment">#也可以使用uri连接</span></span><br><span class="line">      <span class="comment">#uri: mongodb://localhost:27017/articledb</span></span><br></pre></td></tr></table></figure><h3 id="4-3-文章评论基本的CRUD"><a href="#4-3-文章评论基本的CRUD" class="headerlink" title="4.3 文章评论基本的CRUD"></a>4.3 文章评论基本的CRUD</h3><p><code>Comment</code>实体类中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">把一个java类声明为mongodb的文档，可以通过collection参数指定这个类对应的文档。</span></span><br><span class="line"><span class="comment">@Document(collection=&quot;mongodb 对应 collection 名&quot;)</span></span><br><span class="line"><span class="comment">    若未加 @Document ，该 bean save 到 mongo 的 comment collection</span></span><br><span class="line"><span class="comment">    若添加 @Document ，则 save 到 comment collection</span></span><br><span class="line"><span class="comment">复合索引</span></span><br><span class="line"><span class="comment">@CompoundIndex( def = &quot;&#123;&#x27;userid&#x27;: 1, &#x27;nickname&#x27;: -1&#125;&quot;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Document(collection=&quot;comment&quot;)</span><span class="comment">//可以省略，如果省略，则默认使用类名小写映射集合</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Comment</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span> <span class="comment">//主键标识，该属性的值会自动对应mongodb的主键字段&quot;_id&quot;，如果该属性名就叫“id”,则该注解可以省略，否则必须写</span></span><br><span class="line">    <span class="keyword">private</span> String id;<span class="comment">//主键</span></span><br><span class="line">    <span class="meta">@Field(&quot;content&quot;)</span>     <span class="comment">//该属性对应mongodb的字段的名字，如果一致，则无需该注解</span></span><br><span class="line">    <span class="keyword">private</span> String content;<span class="comment">//吐槽内容</span></span><br><span class="line">    <span class="keyword">private</span> Date publishtime;<span class="comment">//发布日期</span></span><br><span class="line">    <span class="meta">@Indexed</span> <span class="comment">//添加了一个单字段的索引</span></span><br><span class="line">    <span class="keyword">private</span> String userid;<span class="comment">//发布人ID</span></span><br><span class="line">    <span class="keyword">private</span> String nickname;<span class="comment">//昵称</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createdatetime;<span class="comment">//评论的日期时间</span></span><br><span class="line">    <span class="keyword">private</span> Integer likenum;<span class="comment">//点赞数</span></span><br><span class="line">    <span class="keyword">private</span> Integer replynum;<span class="comment">//回复数</span></span><br><span class="line">    <span class="keyword">private</span> String state;<span class="comment">//状态</span></span><br><span class="line">    <span class="keyword">private</span> String parentid;<span class="comment">//上级ID</span></span><br><span class="line">    <span class="keyword">private</span> String articleid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CommentRepository</code>中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CommentRepository</span> <span class="keyword">extends</span> <span class="title class_">MongoRepository</span>&lt;Comment,String&gt; &#123;</span><br><span class="line">    Page&lt;Comment&gt; <span class="title function_">findByParentid</span><span class="params">(String parentid, Pageable pageable)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CommentService</code>中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CommentService</span> &#123;</span><br><span class="line">    <span class="comment">//保存一个评论</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">saveComment</span><span class="params">(Comment comment)</span>;</span><br><span class="line">    <span class="comment">//更新评论</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateComment</span><span class="params">(Comment comment)</span>;</span><br><span class="line">    <span class="comment">//根据id删除评论</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteCommentById</span><span class="params">(String id)</span>;</span><br><span class="line">    <span class="comment">//查询所有评论</span></span><br><span class="line">    List&lt;Comment&gt; <span class="title function_">findCommentList</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">//根据id查询评论</span></span><br><span class="line">    Comment <span class="title function_">findCommentById</span><span class="params">(String id)</span>;</span><br><span class="line">    <span class="comment">//根据父id，查询子评论的分页列表</span></span><br><span class="line">    Page&lt;Comment&gt; <span class="title function_">findCommentListPageByParentid</span><span class="params">(String parentid, <span class="type">int</span> page, <span class="type">int</span> size)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CommentServiceImpl</code>中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommentServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CommentService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommentRepository commentRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveComment</span><span class="params">(Comment comment)</span> &#123;</span><br><span class="line">        commentRepository.save(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateComment</span><span class="params">(Comment comment)</span> &#123;</span><br><span class="line">        commentRepository.save(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteCommentById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        commentRepository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Comment&gt; <span class="title function_">findCommentList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> commentRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Comment <span class="title function_">findCommentById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> commentRepository.findById(id).get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Page&lt;Comment&gt; <span class="title function_">findCommentListPageByParentid</span><span class="params">(String parentid, <span class="type">int</span> page, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> commentRepository.findByParentid(parentid, PageRequest.of(page-<span class="number">1</span>,size));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommentServiceTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommentService commentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSave</span><span class="params">()</span> &#123;</span><br><span class="line">        Comment comment=<span class="keyword">new</span> <span class="title class_">Comment</span>();</span><br><span class="line">        comment.setArticleid(<span class="string">&quot;100001&quot;</span>);</span><br><span class="line">        comment.setContent(<span class="string">&quot;不要吃我&quot;</span>);</span><br><span class="line">        comment.setCreatedatetime(LocalDateTime.now());</span><br><span class="line">        comment.setUserid(<span class="string">&quot;1004&quot;</span>);</span><br><span class="line">        comment.setNickname(<span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line">        comment.setState(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        comment.setParentid(<span class="string">&quot;62ddfe4c2f8d0c6ca75ba67f&quot;</span>); <span class="comment">//父评论id</span></span><br><span class="line">        comment.setLikenum(<span class="number">0</span>);</span><br><span class="line">        comment.setReplynum(<span class="number">0</span>);</span><br><span class="line">        commentService.saveComment(comment);</span><br><span class="line"></span><br><span class="line">        commentService.saveComment(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testFindById</span><span class="params">()</span> &#123;<span class="comment">//id查找</span></span><br><span class="line">        System.out.println(commentService.findCommentById(<span class="string">&quot;62ddfe4c2f8d0c6ca75ba67f&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testDeleteById</span><span class="params">()</span> &#123;<span class="comment">//删除</span></span><br><span class="line">        commentService.deleteCommentById(<span class="string">&quot;666&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testFindAll</span><span class="params">()</span> &#123;<span class="comment">//查找所有</span></span><br><span class="line">        System.out.println(commentService.findCommentList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testUpdate</span><span class="params">()</span> &#123; <span class="comment">//更新</span></span><br><span class="line">        <span class="type">Comment</span> <span class="variable">comment</span> <span class="operator">=</span> commentService.findCommentById(<span class="string">&quot;62ddfe4c2f8d0c6ca75ba67f&quot;</span>);</span><br><span class="line">        comment.setLikenum(<span class="number">666</span>);</span><br><span class="line"></span><br><span class="line">        commentService.updateComment(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testFindCommentListByParentid</span><span class="params">()</span> &#123; <span class="comment">//分页查找</span></span><br><span class="line">        Page&lt;Comment&gt; commentPage = commentService.findCommentListPageByParentid(<span class="string">&quot;62ddfe4c2f8d0c6ca75ba67f&quot;</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;----总记录数：&quot;</span>+commentPage.getTotalElements());</span><br><span class="line">        System.out.println(<span class="string">&quot;----当前页数据：&quot;</span>+commentPage.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-MongoTemplate实现评论点赞"><a href="#4-4-MongoTemplate实现评论点赞" class="headerlink" title="4.4 MongoTemplate实现评论点赞"></a>4.4 MongoTemplate实现评论点赞</h3><p>以下为点赞的临时示例代码：</p><p> <code>CommentService</code> 新增<code>updateThumbup</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCommentThumbupToIncrementingOld</span><span class="params">(String id)</span>&#123;</span><br><span class="line"><span class="type">Comment</span> <span class="variable">comment</span> <span class="operator">=</span> CommentRepository.findById(id).get();</span><br><span class="line">comment.setLikenum(comment.getLikenum()+<span class="number">1</span>);</span><br><span class="line">CommentRepository.save(comment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>以上方法虽然实现起来比较简单，但是执行效率并不高</p><p>我只需要将点赞数加1就可以了，没必要查询出所有字段修改后再更新所有字段。</p></blockquote><p>可以使用MongoTemplate类来实现对某列的操作。</p><p>在<code>CommentService</code>声明一个<code>updateCommentLikenum</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CommentService</span> &#123;</span><br><span class="line">    <span class="comment">//点赞数+1</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateCommentLikenum</span><span class="params">(String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CommentServiceImpl</code>中实现<code>updateCommentLikenum</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCommentLikenum</span><span class="params">(String id)</span>&#123;</span><br><span class="line">    <span class="comment">//查询对象</span></span><br><span class="line">    <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(Criteria.where(<span class="string">&quot;_id&quot;</span>).is(id));</span><br><span class="line">    <span class="comment">//更新对象</span></span><br><span class="line">    <span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">    <span class="comment">//局部更新，相当于$set update.set(key,value)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//递增$inc  update.inc(&quot;likenum&quot;,1) 默认增加1</span></span><br><span class="line">    update.inc(<span class="string">&quot;likenum&quot;</span>);</span><br><span class="line">    <span class="comment">//参数1：查询对象 参数2：更新对象 参数3：集合的名字或实体类的类型Comment.class</span></span><br><span class="line">    mongoTemplate.updateFirst(query,update,<span class="string">&quot;comment&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUpdateLikenum</span><span class="params">()</span> &#123; <span class="comment">//点赞加1</span></span><br><span class="line">    commentService.updateCommentLikenum(<span class="string">&quot;62ddfe4c2f8d0c6ca75ba67f&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2022/08/06/Java/ELK%E6%90%9C%E7%B4%A2_/"/>
      <url>/2022/08/06/Java/ELK%E6%90%9C%E7%B4%A2_/</url>
      
        <content type="html"><![CDATA[<hr><hr><div class="story post-story"><h2 id="1-ELK简介"><a href="#1-ELK简介" class="headerlink" title="1.ELK简介"></a>1.ELK简介</h2><p><a href="https://www.elastic.co/cn/">ELK</a>是包含但不限于<code>Elasticsearch(简称ES)</code>、<code>Logstash</code>、<code>Kibana</code>三个开源软件的组成的一个整体，这三个软件合成ELK。</p><p>本课程从分别对三个组件经行详细介绍：</p><blockquote><ul><li><p>Elasticsearch：因为它是elk的核心。本课程从es底层对文档、索引、 搜索、聚合、集群经行介绍，从搜索和聚合分析实例来展现es的魅力。</p></li><li><p>Logstash：从内部如何采集数据到指定地方来展现它数据采集的功能。</p></li><li><p>Kibana：从数据绘图展现数据可视化的功能。</p></li></ul></blockquote></div><div class="story post-story"><h2 id="2-Elastic-Stack概念"><a href="#2-Elastic-Stack概念" class="headerlink" title="2.Elastic Stack概念"></a>2.Elastic Stack概念</h2><p>随着ELK的发展，又有新成员Beats、elastic cloud的加入，所以就形成了Elastic Stack。 所以说，ELK是旧的称呼，Elastic Stack是新的名字</p><h3 id="2-1-Elastic-Stack特色"><a href="#2-1-Elastic-Stack特色" class="headerlink" title="2.1 Elastic Stack特色"></a>2.1 Elastic Stack特色</h3><blockquote><ul><li>处理方式灵活：Elasticsearch是目前最流行的准实时全文检索引擎，具有高速检索大数据的能力</li><li>配置简单：安装ELK的每个组件，仅需配置每个组件的一个配置文件即可，修改处不多，因为大量参数已经默认配在系统中，修改想要修改的选项即可</li><li>接口简单：采用json形式RESTFUL APl接受数据并响应，无关语言</li><li>性能高效：Elasticsearch基于优秀的全文搜索技术<strong>Lucene</strong>，采用倒排索引，可以轻易地在百亿级别数据下，搜索出想要的内容，并且是秒级响应</li><li>灵活扩展：Elasticsearch和Logstash都可以根据集群规模线性拓展，Elasticsearch内部自动实现集群协作</li><li>数据展现华丽：Kibana作为前端展现工具，图表华丽，配置简单</li></ul></blockquote><h3 id="2-2-Elastic-Stack组件"><a href="#2-2-Elastic-Stack组件" class="headerlink" title="2.2 Elastic Stack组件"></a>2.2 Elastic Stack组件</h3><ul><li><p><strong>Elasticsearch</strong>：</p><p>Elasticsearch 是使用java开发，基于Lucene分布式、通过Restful方式进行交互的近实时搜泰平台框架。它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</p></li><li><p><strong>Logstash</strong>：</p><p>Logstash 基于java开发，是一个数据抽取转化工具。一般工作方式为C&#x2F;S架构，client端安装在需要收集信息的主机上，server端负责将收到的各节点日志进行过滤、 修改等操作在一并发往Elasticsearch或其他组件去。</p></li><li><p><strong>Kibana</strong>：</p><p>Kibana 基于nodejs，也是一个开源和免费的可视化工具，Kibana可以为Logstash和Elasticsearch 提供的日志分析友好的web界面，可以汇总、分析和搜索重要数据日志。</p></li><li><p><strong>Beats</strong>：</p><p>Beats平台集合了多种单一用途数据采集器。它们从成百上千或成千上万台机器和系统向Logstash或Elasticsearch发送数据。</p><p>Beats由如下组成：</p><ul><li><p><strong>Packetbeat</strong>：</p><p><strong>轻量型网络数据采集器</strong>，用于深挖网线上传输的数据，了解应用程序动态。Packetbeat 是一款轻量型网络数据包分析器，能够多将数据发送至Logstash 或 Elasticsearch。其支持ICMP (V4 and v6)、DNS、HTTP、MySQL、PostgreSQL、Redis、MongoDB、Memcache等协议。</p></li><li><p><strong>Filebeat</strong>：</p><p><strong>轻量型日志采集器</strong>， 当您要面对成百上千其至成千上万的的服务器、虚拟机和容器生成的志时，请告别 SSH 吧。Filebeat 将为您提供一种轻量型方法，用于转发和汇总日志与文件，让简单的事情不再繁杂。</p></li><li><p><strong>Metricbeat</strong>：</p><p><strong>轻量型指标采集器</strong>。Metricbeat 能够多以一种轻量型的方式输送各种系统和服务统计数据，从CPU到内存，从 Redis 到Nginx，不一而足。可定期获取外部系统的监控指标信息，其可以监控、收集 Apache、http、HAProxy、MongoDB、MySQL、Nginx、PostgreSQL、Redis、System、Zookeeper等服务。</p></li><li><p><strong>Winlogbeat</strong>：</p><p><strong>轻量型 Windows 事件日志采集器</strong>。用于密切监控基于Windows 的基础设施上发生的事件。Winlogbeat 能够多以一种轻量型的方式，将Windows 事件日志实时地流式传输至 Elasticsearch 和 Logstash。</p></li><li><p><strong>Auditbeat</strong>：</p><p><strong>轻量型申计日志采集器</strong>。收集您 Linux 审计框架的数据，监控文件完整性。Auditbeat 实时采集这些事件，然后发送到 Elastic Stack 其他部分做进一步分析。</p></li><li><p><strong>Heartbeat</strong>：</p><p><strong>面向运行状态监测的轻量型采集器</strong>。通过主动探测来监测服务的可用性。通过给定 URL列表，Heartbeat 仅仅询问：<code>网站运行正常吗？</code>Heartbeat 会将此信息和响应时间发送至 Elastic 的其他部分，以进行进一步分析。</p></li></ul></li><li><p><strong>Elastic cloud</strong>：</p><p>基于 Elasticsearch 的软件即服务(SaaS)解决方案。通过 Elastic 的官方合作伙伴使用托管的 Elasticsearch 服务。</p></li></ul></div><div class="story post-story"><h2 id="3-Elasticsearch概念"><a href="#3-Elasticsearch概念" class="headerlink" title="3.Elasticsearch概念"></a>3.Elasticsearch概念</h2><h3 id="3-1-搜索是什么"><a href="#3-1-搜索是什么" class="headerlink" title="3.1 搜索是什么"></a>3.1 搜索是什么</h3><p>概念：用户输入想要的关键词，返回含有该关键词的所有信息</p><p>场景：</p><ul><li>互联网搜索：谷歌、百度</li><li>站内搜索(垂直搜索)：搜索商品(淘宝、京东)</li></ul><h3 id="3-2-数据库搜索"><a href="#3-2-数据库搜索" class="headerlink" title="3.2 数据库搜索"></a>3.2 数据库搜索</h3><p><strong>站内搜索</strong>(垂直搜索)：</p><blockquote><ul><li><p>数据量小、简单搜索，可以使用数据库</p></li><li><p>存在问题：</p><ul><li>存储问题。电商网站商品上亿条时，涉及到单表数据过大必须拆分表，数据磁盘占用过大必须分库(mycat)。</li><li>性能问题：解决上面问题后，查询”笔记本电脑”等关键词时，上亿条数据的商品名字段逐行扫描，性能跟不上。</li><li>不能分词：如搜索<code>&quot;笔记本电脑&quot;</code>，只能搜索完全和关键词一样的数据，那么数据量小时，如果搜索<code>&quot;笔记电脑&quot;</code>，<code>&quot;电脑&quot;</code>数据要不要给用户。</li></ul></li></ul></blockquote><p><strong>互联网搜索</strong>：数据量过大(PB级)，不会使用数据库。</p><h3 id="3-3-全文检索"><a href="#3-3-全文检索" class="headerlink" title="3.3 全文检索"></a>3.3 全文检索</h3><p><strong>倒排索引</strong>：</p><blockquote><ul><li><p>数据存储时 ，经行分词建立term索引库。</p></li><li><p>倒排索引：源于实际应用中需要根据属性的值来查找记录。这种索引表中的每项都包括一个属性值和具有该属性值的各记录的地址。由于不是由记录来确定属性值，而是由属性值来确定记录的位置，因而称为倒排索引(inverted index)。带有倒排索引的文件我们称为倒排索引文任，简称倒排文任(inverted file)。</p></li></ul></blockquote><p><strong>Lucene</strong>：</p><blockquote><ul><li>就是一个jar包，里面封装了全文检索的引擎、搜索的算法代码。</li><li>开发时，引入Lucene的jar包，通过api开发搜索相关业务。底层会在磁盘建立索引库。</li></ul></blockquote><h3 id="3-4-初识Elasticsearch"><a href="#3-4-初识Elasticsearch" class="headerlink" title="3.4 初识Elasticsearch"></a>3.4 初识Elasticsearch</h3><p><a href="https://www.elastic.co/cn/elasticsearch/">Elasticsearch</a>是一个基于Luncene的搜索服务器，并且是一个分布式、RESTful 风格的搜索和数据分析引擎</p><p><strong>功能介绍</strong>：</p><blockquote><ul><li><p><strong>分布式的搜索引擎和数据分析引擎</strong></p><ul><li>搜索：互联网搜索、电商网站站内搜索、OA系统查询</li><li>数据分析：电商网站查询近—周哪些品类的图书销售前十，新国网站，最近3天阅读量最高的十个关键词，舆情分析</li></ul></li><li><p><strong>全文检索，结构化检索，数据分析</strong></p><ul><li><p>全文检索：</p><p>搜索商品名称包含java的图书</p><p><code>select * from books where book_name like &quot;%java%&quot;</code></p></li><li><p>结构化检索：</p><p>搜索商品分类为spring的图书都有哪些</p><p><code>select * from books where category _id=&#39;spring&#39;</code></p></li><li><p>数据分析：</p><p>分析每一个分类下有多少种图书</p><p><code>select category _id,count(*) from books group by category_id</code></p></li></ul></li><li><p><strong>对海量数据进行近实时的处理</strong></p><ul><li>分布式：ES自动可以将海量数据分散到多台服务器上去存储和检索,经行并行查<br>询，提高搜索效率。相对的，Lucene是单机应用。</li><li>近实时：数据库上亿条数据查询，搜索一次耗时几个小时，是批处理(batch-<br>processing）。而ES只需秒级即可查询海量数据，所以叫近实时，秒级。</li></ul></li></ul></blockquote><p><strong>使用场景</strong>：</p><blockquote><ul><li>维基百科：全文搜索、高亮、搜索推荐</li><li>GitHub：搜索上千行代码</li><li>电商网站：检索商品、搜索推荐</li><li>日志数据分析：Logstash采集日志，ES进行复杂的数据分析，Kibana数据可视化</li><li>百度搜索：第一次查询使用es</li><li>OA、ERP系统站内搜索</li></ul></blockquote><p><strong>特点</strong>：</p><blockquote><ul><li>可拓展性高：</li></ul><p> 大型分布式集群（数百台服务器）技术，处理PB级数据，大公司可以使用。小公司数据量小，也可以部署在单机。大数据领域使用广泛。</p><ul><li>技术整合：</li></ul><p> 将全文检索、数据分析、分布式相关技术整合在一起<code>lucene(全文检索)、商用的数据分析软件(BI软件)、分布式数据库(mycat)</code></p><ul><li>部署简单：</li></ul><p> 开箱即用，很多默认配置不需关心，解压完成直接运行即可，拓展时，只需多部署几个实例即可，负载均衡、分片迁移集群内部自己实施。</p><ul><li>接口简单：</li></ul><p> 使用restful api经行交互，跨语言。</p><ul><li>功能强大：</li></ul><p> Elasticsearch作为传统数据库的一个补充，提供了数据库所不不能提供的很多功能，如全文检索、同义词处理、相关度排名。</p></blockquote><p><strong>Lucene与Elasticsearch的关系</strong>：</p><blockquote><ul><li><p><strong>Luncene</strong>：</p><p>最先进、功能最强大的搜索库，直接基于lucene开发，非常复杂，api复杂</p></li><li><p><strong>Elasticsearch</strong>：</p><p>基于lucene，封装了许多lucene底层功能，提供简单易用的restful api接口和许多语言的客户端，如java的高级客户端(Java High Level REST Client)和底层客户端(Java Low Level REST Client )</p></li></ul></blockquote><h3 id="3-5-Elasticsearch核心概念"><a href="#3-5-Elasticsearch核心概念" class="headerlink" title="3.5 Elasticsearch核心概念"></a>3.5 Elasticsearch核心概念</h3><ol><li><p><strong>NRT(Near Realtime)：进实时</strong></p><ul><li><p>写入数据时，过1秒才会被搜索到，因为内部在分词、录入索引。</p></li><li><p>es搜索时：搜索和分析数据需要秒级出结果。</p></li></ul></li><li><p><strong>Cluster：集群</strong></p><p>包含一个或多个启动着es实例的机器群。通常一台机器起一个es实例。同一网络下，集名一样的多个es实例自动组成集群，自动均衡分片等行为。默认集群名为“elasticsearch”。</p></li><li><p><strong>Node：节点</strong></p><p>每个es实例称为一个节点。节点名自动分配，也可以手动配置。</p></li><li><p><strong>Index：索引</strong></p><p>包含一堆有相似结构的文档数据。</p><p>索引创建规则：</p><ul><li><p>仅限小写字母</p></li><li><p>不能包含<code>\ / * ? &quot; &lt; &gt; | #</code>以及空格符等特殊符号</p></li><li><p>从7.0版本开始不再包含冒号</p></li><li><p>不能以<code>- _ +</code>开头</p></li><li><p>不能超过255个字节（注意它是字节，因此多字节字符将计入255个限制）</p></li></ul></li><li><p><strong>Document：文档</strong></p><p>es中的最小数据单元。一个document就像数据库中的一条记录。通常以json格式显示。多个document存储于一个索引（Index）中。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">book document</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;book_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;book_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java编程思想&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;book_desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;从Java的基础语法到最高级特性（深入的[面向对象](https://baike.baidu.com/item/面向对象)概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;category_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;category_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>Field：字段</strong></p><p>就像数据库中的列（Columns），定义每个document应该有的字段。</p></li><li><p><strong>Type：类型</strong></p><p>每个索引里都可以有一个或多个type，type是index中的一个逻辑数据分类，一个type下的document，都有相同的field。</p><p><strong>注意</strong>：6.0之前的版本有type（类型）概念，type相当于关系数据库的表，ES官方将在ES9.0版本中彻底删除type。本教程type都为_doc。</p></li><li><p><strong>Shard：分片</strong></p><p>index数据过大时，将index里面的数据，分为多个shard，分布式的存储在各个服务器上面。可以支持海量数据和高并发，提升性能和吞吐量，充分利用多台机器的cpu。</p></li><li><p><strong>Replica：副本</strong></p><p>在分布式环境下，任何一台机器都会随时宕机，如果宕机，index的一个分片没有，导致此index不能搜索。所以，为了保证数据的安全，我们会将每个index的分片经行备份，存储在另外的机器上。保证少数机器宕机es集群仍可以搜索。</p><p>能正常提供查询和插入的分片我们叫做主分片(primary shard)，其余的我们就管他们叫做备份的分片 (replica shard)。</p><p>es6默认新建索引时，5分片，2副本，也就是一主一备，共10个分片。所以，es集群最小规模为两台。</p></li></ol><p><strong>Elasticsearch与数据库比较：</strong></p><table><thead><tr><th align="center">关系型数据库(MySQL)</th><th align="center">非关系型数据库(Elasticsearch)</th></tr></thead><tbody><tr><td align="center">数据库Database</td><td align="center">索引Index</td></tr><tr><td align="center">表Table</td><td align="center">索引Index(原为Type)</td></tr><tr><td align="center">数据行Row</td><td align="center">文档Document</td></tr><tr><td align="center">数据列Column</td><td align="center">字段Field</td></tr><tr><td align="center">约束 Schema</td><td align="center">约束 Schema</td></tr></tbody></table></div><div class="story post-story"><h2 id="4-ES快速入门"><a href="#4-ES快速入门" class="headerlink" title="4.ES快速入门"></a>4.ES快速入门</h2><h3 id="4-1-文档-document-的数据格式"><a href="#4-1-文档-document-的数据格式" class="headerlink" title="4.1 文档(document)的数据格式"></a>4.1 文档(document)的数据格式</h3><ol><li>应用系统的数据结构都是面向对象的，具有复杂的数据结构</li><li>对象存储到数据库，需要将关联的复杂对象属性插到另一张表，查询时再拼接起来。</li><li>ES面向文档，文档中存储的数据结构，与对象一致。所以一个对象可以直接存成一个文档。</li><li>ES的document用<strong>json数据格式</strong>来表达。</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;last_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhang&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;classInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;className&quot;</span><span class="punctuation">:</span> <span class="string">&quot;三年二班&quot;</span><span class="punctuation">,</span>     </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="4-2-简单的集群管理"><a href="#4-2-简单的集群管理" class="headerlink" title="4.2 简单的集群管理"></a>4.2 简单的集群管理</h3><p>使用kibana的控制台，浏览器访问：<code>http://主机地址:5601/app/dev_tools#/console</code></p><p><strong>检查集群的健康状况</strong>：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/health?v</span><br></pre></td></tr></table></figure><p>响应结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">epoch      timestamp cluster        status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1660972717 05:18:37  docker-cluster green           1         1     11  11    0    0        0             0                  -                100.0%</span><br></pre></td></tr></table></figure><p>健康状况的三种情况：</p><ul><li><p>green：每个索引的primary shard和replica shard都是active状态的</p></li><li><p>yellow：每个索引的primary shard都是active状态的，但是部分replica shard不是active状态，处于不可用的状态</p></li><li><p>red：不是所有索引的primary shard都是active状态的，部分索引有数据丢失了</p></li></ul><p><strong>查看集群中的索引</strong>：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/indexes?v</span><br></pre></td></tr></table></figure><p>响应结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">health status index                           uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   .geoip_databases                dGx7TrfoTCuOqVS7y6CTRA   1   0         41            0     38.9mb         38.9mb</span><br><span class="line">green  open   .kibana_7.17.5_001              JGFQAr7hRWqaoIfIpo_Liw   1   0        438            2      6.7mb          6.7mb</span><br><span class="line">green  open   .apm-custom-link                f8HqzrG-TWipwqbNoGLQEA   1   0          0            0       226b           226b</span><br><span class="line">green  open   kibana_sample_data_ecommerce    -WV4YJoiTaWtfACqobRV9g   1   0       4675            0      4.2mb          4.2mb</span><br><span class="line">green  open   .apm-agent-configuration        hoLYS7CRRTCooCP3ndNt6Q   1   0          0            0       226b           226b</span><br><span class="line">green  open   .kibana_task_manager_7.17.5_001 lSfnkGiSSzKTvesWhYZgaQ   1   0         17        77315      8.2mb          8.2mb</span><br><span class="line">green  open   .async-search                   _bMoH_6WQkKhHkGAcpl1MA   1   0          0            0       249b           249b</span><br><span class="line">green  open   .tasks                          jBJ9hH7TTn2TXtFwmYDjVw   1   0          6            0       23kb           23kb</span><br></pre></td></tr></table></figure><p><strong>简单的索引操作</strong>：</p><p>创建索引：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /demo_index</span><br></pre></td></tr></table></figure><p>响应结果：</p><blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;acknowledged&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;shards_acknowledged&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;demo_index&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></blockquote><p>删除索引：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /demo_index</span><br></pre></td></tr></table></figure><p>响应结果：</p><blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;acknowledged&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="4-3-案例介绍"><a href="#4-3-案例介绍" class="headerlink" title="4.3 案例介绍"></a>4.3 案例介绍</h3><p>有一个售卖图书的网站，需要为其基于ES构建一个后台系统，提供以下功能：</p><blockquote><ol><li>对商品信息进行CRUD（增删改查）操作</li><li>执行简单的结构化查询</li><li>可以执行简单的全文检索，以及复杂的phrase（短语）检索</li><li>对于全文检索的结果，可以进行高亮显示</li><li>对数据进行简单的聚合分析</li></ol></blockquote><h3 id="4-4-商品的CRUD操作"><a href="#4-4-商品的CRUD操作" class="headerlink" title="4.4 商品的CRUD操作"></a>4.4 商品的CRUD操作</h3><p>document的CRUD操作</p><p>**新建图书索引<code>book</code>**：<code>PUT /index</code></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /book</span><br></pre></td></tr></table></figure><p>**新增图书(文档)**：<code>PUT /index/type/id</code></p><p>新增图书1：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;Bootstrap开发&quot;,</span><br><span class="line">&quot;description&quot;: &quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;,</span><br><span class="line">&quot;studymodel&quot;: &quot;201002&quot;,</span><br><span class="line">&quot;price&quot;:38.6,</span><br><span class="line">&quot;timestamp&quot;:&quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">&quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">&quot;tags&quot;: [ &quot;bootstrap&quot;, &quot;dev&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新增图书1：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;java编程思想&quot;,</span><br><span class="line">&quot;description&quot;: &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,</span><br><span class="line">&quot;studymodel&quot;: &quot;201001&quot;,</span><br><span class="line">&quot;price&quot;:68.6,</span><br><span class="line">&quot;timestamp&quot;:&quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">&quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">&quot;tags&quot;: [ &quot;java&quot;, &quot;dev&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看所有图书：<code>GET /index/_search</code></p><p>**查询图书(检索文档)**：<code>GET /index/type/id</code></p><p>查看图书1</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_doc/1</span><br></pre></td></tr></table></figure><p>响应结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;book&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bootstrap开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;studymodel&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;201002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">38.6</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2019-08-25 19:11:35&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pic&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;bootstrap&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;dev&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>修改图书</strong>：</p><ul><li>全局替换：</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;Bootstrap开发教程&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;,</span><br><span class="line">    &quot;studymodel&quot;: &quot;201002&quot;,</span><br><span class="line">    &quot;price&quot;:38.6,</span><br><span class="line">    &quot;timestamp&quot;:&quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">    &quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">    &quot;tags&quot;: [ &quot;bootstrap&quot;, &quot;开发&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>替换操作是整体覆盖，要带上所有信息。</p><p>每次执行后，返回结果中版本号<code>_version</code>在不断增加，此过程为全量替换。</p><p>实质：旧文档的内容不会立即删除，只是标记为<code>deleted</code>。适当的时机，集群会将这些文档删除。</p><ul><li><p>局部替换：</p><p><code>POST /index/_update/id</code>或</p><p><code>POST /index/type/id/_update</code></p></li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /book/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123;</span><br><span class="line">   &quot;name&quot;: &quot; Bootstrap开发教程高级&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>内部与全量替换是一样的，旧文档标记为删除，新建一个文档。</p><p>优点：</p><ul><li>大大减少网络传输次数和流量，提升性能</li><li>减少并发冲突发生的概率</li></ul><p>**删除图书(删除文档)**：<code>DELETE /index/type/id</code></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /book/_doc/1</span><br></pre></td></tr></table></figure><p>实质：<strong>旧文档的内容不会立即删除</strong>，只是标记为deleted。适当的时机，集群会将这些文档删除。</p></div><div class="story post-story"><h2 id="5-文档document入门"><a href="#5-文档document入门" class="headerlink" title="5.文档document入门"></a>5.文档document入门</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_doc/1</span><br></pre></td></tr></table></figure><p>响应结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;book&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bootstrap开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;studymodel&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;201002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">38.6</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2019-08-25 19:11:35&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pic&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;bootstrap&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;dev&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="5-1-字段解析"><a href="#5-1-字段解析" class="headerlink" title="5.1 字段解析"></a>5.1 字段解析</h3><ol><li><p><strong>_index</strong></p><ul><li>含义：此文档属于哪个索引</li><li>原则：类似数据放在一个索引中。数据库中表的定义规则。如图书信息放在book索引中，员工信息放在employee索引中。各个索引存储和搜索时互不影响。</li><li>定义规则：英文小写。尽量不要使用特殊字符。order user</li></ul></li><li><p><strong>_type</strong></p><ul><li>含义：类别。book java node</li><li>注意：以后的es9将彻底删除此字段，所以当前版本在不断弱化type。不需要关注。见到<code>_type</code>都为<code>_doc</code>。</li></ul></li><li><p><strong>_id</strong></p><ul><li>含义：文档的唯一标识。就像表的id主键。结合索引可以标识和定义一个文档。</li><li>生成：手动（put &#x2F;index&#x2F;_doc&#x2F;id）、自动</li></ul></li></ol><h3 id="5-2-自动生成文档id"><a href="#5-2-自动生成文档id" class="headerlink" title="5.2 自动生成文档id"></a>5.2 自动生成文档id</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /book/_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;ELK&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>响应结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;book&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;FrnSuoIB-YsVyRxk4XeZ&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>自动生成的id就为<code>FrnSuoIB-YsVyRxk4XeZ</code></p><p>特点：长度为20个字符，URL安全，base64编码，GUID，分布式生成不冲突 </p><h3 id="5-3-定制返回字段"><a href="#5-3-定制返回字段" class="headerlink" title="5.3 定制返回字段"></a>5.3 定制返回字段</h3><p>就像sql一样不是查询所有<code>select * from book</code>，而是<code>select name, price from book</code></p><p>查询id为1的<strong>书名</strong>以及<strong>价格</strong>：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET  /book/_doc/1?_source_includes=name,price</span><br></pre></td></tr></table></figure><p>注意：name与price中间只有<code>,</code>不能有空格<code> </code></p><p>响应结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;book&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">38.6</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot; Bootstrap开发教程高级&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="5-4-文档的强制替换"><a href="#5-4-文档的强制替换" class="headerlink" title="5.4 文档的强制替换"></a>5.4 文档的强制替换</h3><p>强制创建：<code>PUT /index/ _doc/id/_create</code></p><p><strong>为防止覆盖原有数据</strong>，我们在新增时，设置为强制创建，不会覆盖原有文档。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /book/_doc/1/_create</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123;</span><br><span class="line">   &quot;name&quot;: &quot; Bootstrap开发教程高级666&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>响应结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;[1]: version conflict, document already exists (current version [4])&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_GEFBf0rSxG9GxzJtG8w5A&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;shard&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;book&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reason&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;[1]: version conflict, document already exists (current version [4])&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index_uuid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_GEFBf0rSxG9GxzJtG8w5A&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;shard&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;book&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="number">409</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="5-5-脚本更新"><a href="#5-5-脚本更新" class="headerlink" title="5.5 脚本更新"></a>5.5 脚本更新</h3><p>es可以内置脚本执行复杂操作。例如<strong>painless</strong>脚本。</p><p>注意：groovy脚本在es6以后就不支持了。原因是耗内存，不安全远程注入漏洞。</p><p><strong>内置脚本</strong></p><ul><li><p>需求1：修改文档1的num字段+1。</p><p>插入数据：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;num&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行脚本：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /test/_update/1</span><br><span class="line">&#123;</span><br><span class="line">   &quot;script&quot; : &quot;ctx._source.num+=1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查询文档1：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_doc/1</span><br></pre></td></tr></table></figure><p>响应数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;num&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>需求2：搜索所有文档，将num字段乘以2输出</p><p>插入数据：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;num&quot;: 5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查询所有将<code>num x 2</code>：</p><p>注意：<strong>源数据不变</strong>，只是将查询的数据 x 2 </p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script_fields&quot;: &#123;</span><br><span class="line">    &quot;my_doubled_field&quot;: &#123;</span><br><span class="line">      &quot;script&quot;: &#123;</span><br><span class="line">       &quot;lang&quot;: &quot;expression&quot;,</span><br><span class="line">        &quot;source&quot;: &quot;doc[&#x27;num&#x27;] * mul&quot;,</span><br><span class="line">        &quot;params&quot;: &#123;</span><br><span class="line">          &quot;mul&quot;: 2</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>响应结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">364</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;my_doubled_field&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="number">2.0</span> #由<span class="number">1</span>变成<span class="number">2</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;my_doubled_field&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="number">10.0</span> #由<span class="number">5</span>变成<span class="number">10</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li></ul><p><strong>外部脚本</strong>：</p><p>注意：脚本性能低下，且容易发生注入，本教程忽略</p><p>自行了解：<a href="">官方文档</a></p></div><div class="story post-story"><h2 id="6-ES的并发问题"><a href="#6-ES的并发问题" class="headerlink" title="6.ES的并发问题"></a>6.ES的并发问题</h2><p>如同秒杀，多线程情况下，es同样会出现并发冲突问题。</p><h3 id="6-1-乐观锁与悲观锁"><a href="#6-1-乐观锁与悲观锁" class="headerlink" title="6.1 乐观锁与悲观锁"></a>6.1 乐观锁与悲观锁</h3><p>为控制并发问题，我们通常采用锁机制。</p><p>分为悲观锁和乐观锁两种机制：</p><blockquote><ul><li><p>悲观锁：<strong>很悲观，所有情况都上锁</strong>。此时只有一个线程可以操作数据。具体例子为数据库中的行级锁、表级锁、读锁、写锁等。</p><p>特点：优点是方便，直接加锁，对程序透明。缺点是效率低。</p></li><li><p>乐观锁：<strong>很乐观，对数据本身不加锁</strong>。提交数据时，通过一种机制验证是否存在冲突，如es中通过版本号验证。</p><p>特点：优点是并发能力高。缺点是操作繁琐，在提交数据时，可能反复重试多次。</p></li></ul></blockquote><h3 id="6-2-基于-version乐观锁控制"><a href="#6-2-基于-version乐观锁控制" class="headerlink" title="6.2 基于_version乐观锁控制"></a>6.2 基于_version乐观锁控制</h3></div>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>爬取某易云的免费音乐</title>
      <link href="/2022/08/06/Python/%E7%88%AC%E8%99%AB/%E7%88%AC%E5%8F%96%E6%9F%90%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90/"/>
      <url>/2022/08/06/Python/%E7%88%AC%E8%99%AB/%E7%88%AC%E5%8F%96%E6%9F%90%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90/</url>
      
        <content type="html"><![CDATA[<p>获取加密的字符串：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 前端自定义的字符串常量</span></span><br><span class="line">_g = <span class="string">&quot;0CoJUm6Qyw8W8jud&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 16位随机数</span></span><br><span class="line"><span class="comment"># 必须要自己手动固定</span></span><br><span class="line"><span class="comment"># 因为data中的params和encSecKey到了服务器解析后会对比随机数是否相同</span></span><br><span class="line"><span class="comment"># 获取encSecKey过程中唯一的变量就是这个随机数，固定了随机数就是固定了encSecKey</span></span><br><span class="line"><span class="comment"># 这样就只需要获取params了</span></span><br><span class="line">_i = <span class="string">&quot;Zrv1r2M2VOINoxIJ&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密工具：转化为16的倍数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_to_16</span>(<span class="params">data</span>):</span><br><span class="line">    pad = <span class="number">16</span> - <span class="built_in">len</span>(data) % <span class="number">16</span></span><br><span class="line">    data += <span class="built_in">chr</span>(pad) * pad</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取加密的params</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_aes</span>(<span class="params">a, b</span>):</span><br><span class="line">    key = b.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    iv = <span class="string">&quot;0102030405060708&quot;</span>.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    aes = AES.new(key=key, IV=iv, mode=AES.MODE_CBC)  <span class="comment"># 创造加密器</span></span><br><span class="line">    a = _to_16(a)</span><br><span class="line">    bs = aes.encrypt(a.encode(<span class="string">&quot;utf-8&quot;</span>))  <span class="comment"># 加密,加密内容长度必须是16的倍数，</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(b64encode(bs), <span class="string">&quot;utf-8&quot;</span>)  <span class="comment"># 转化为字符串返回，</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取encSecKey</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_encSecKey</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;d6b3977cdc2bf7c55093043afcc1037c7c9a52e0ee558aaa9afb4b6af&quot;</span> \</span><br><span class="line">           <span class="string">&quot;0078171aacc26f75e38da3cc754ac9e7c55b835f6a52496f0c7507445&quot;</span> \</span><br><span class="line">           <span class="string">&quot;8de571d3d5fa1c1d4ed2e8e91b95797030da6904e0a0b379fd1722665&quot;</span> \</span><br><span class="line">           <span class="string">&quot;29fab6d9ce2f10ead2880567491406334d7d4a90a39698eae9f886a22&quot;</span> \</span><br><span class="line">           <span class="string">&quot;7cdd18399533760d314d13281d3b&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取加密参数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_data</span>(<span class="params">data</span>):</span><br><span class="line">    data = json.dumps(data)</span><br><span class="line">    params = _get_aes(data, _g)</span><br><span class="line">    params = _get_aes(params, _i)</span><br><span class="line">    encSecKey = _get_encSecKey()</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;params&quot;</span>: params,</span><br><span class="line">        <span class="string">&quot;encSecKey&quot;</span>: encSecKey</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><p>获取歌曲列表：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> GetData</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_search</span>(<span class="params">content</span>):</span><br><span class="line">    data = &#123;<span class="string">&quot;hlposttag&quot;</span>: <span class="string">&quot;&lt;/span&gt;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hlpretag&quot;</span>: <span class="string">&#x27;&lt;span class=&quot;s-fc7&quot;&gt;&#x27;</span>,</span><br><span class="line">            <span class="string">&quot;limit&quot;</span>: <span class="number">30</span>,</span><br><span class="line">            <span class="string">&quot;offset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;s&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;content&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&quot;total&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;1&quot;</span>&#125;</span><br><span class="line">    url = <span class="string">&quot;https://music.163.com/weapi/cloudsearch/get/web?csrf_token=&quot;</span></span><br><span class="line">    data = GetData.get_data(data)</span><br><span class="line">    resp = requests.post(url=url, data=data)</span><br><span class="line">    <span class="keyword">return</span> resp.json()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_list</span>(<span class="params">content</span>):</span><br><span class="line">    search_list = _search(content)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;序号     songId           歌手                   歌曲       &quot;</span>)</span><br><span class="line">    index = <span class="number">1</span></span><br><span class="line">    <span class="built_in">list</span> = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> search_list[<span class="string">&quot;result&quot;</span>][<span class="string">&quot;songs&quot;</span>]:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;index&#125;</span>      <span class="subst">&#123;i[<span class="string">&#x27;id&#x27;</span>]&#125;</span>        <span class="subst">&#123;i[<span class="string">&#x27;ar&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;name&#x27;</span>]&#125;</span>                 <span class="subst">&#123;i[<span class="string">&#x27;name&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        temp = &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: i[<span class="string">&quot;id&quot;</span>],</span><br><span class="line">            <span class="string">&quot;song_name&quot;</span>: i[<span class="string">&quot;name&quot;</span>],</span><br><span class="line">            <span class="string">&quot;singer&quot;</span>:i[<span class="string">&quot;ar&quot;</span>][<span class="number">0</span>][<span class="string">&quot;name&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">list</span>.append(temp)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----------------------------------------------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span></span><br></pre></td></tr></table></figure><p>下载歌曲：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> GetData</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_download_song</span>(<span class="params">url, name</span>):</span><br><span class="line">    song_name = name + <span class="string">&quot;.m4a&quot;</span></span><br><span class="line"></span><br><span class="line">    resp = requests.get(url=url)</span><br><span class="line"></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;./&quot;</span> + song_name, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">    f.write(resp.content)</span><br><span class="line">    f.close()</span><br><span class="line">    <span class="built_in">print</span>(name + <span class="string">&quot;下载成功&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_song_url</span>(<span class="params">dic</span>):</span><br><span class="line">    data = &#123;<span class="string">&quot;csrf_token&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;encodeType&quot;</span>: <span class="string">&quot;aac&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ids&quot;</span>: <span class="string">f&quot;[<span class="subst">&#123;dic[<span class="string">&#x27;id&#x27;</span>]&#125;</span>]&quot;</span>,</span><br><span class="line">            <span class="string">&quot;level&quot;</span>: <span class="string">&quot;standard&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">    data = GetData.get_data(data)</span><br><span class="line">    url = <span class="string">&quot;https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=&quot;</span></span><br><span class="line">    resp = requests.post(url=url, data=data)</span><br><span class="line"></span><br><span class="line">    song_url = resp.json()[<span class="string">&quot;data&quot;</span>][<span class="number">0</span>][<span class="string">&quot;url&quot;</span>]</span><br><span class="line"></span><br><span class="line">    _download_song(song_url, dic[<span class="string">&quot;song_name&quot;</span>] + <span class="string">&quot;_&quot;</span> + dic[<span class="string">&quot;singer&quot;</span>])</span><br></pre></td></tr></table></figure><p>主函数调用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;仅供学习交流，严禁用于商业用途，请于24小时内删除！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    search = <span class="built_in">input</span>(<span class="string">&quot;请输入要搜索的歌曲或歌手&quot;</span>)</span><br><span class="line">    <span class="built_in">list</span> = GetSongId.show_list(search)</span><br><span class="line"></span><br><span class="line">    index = <span class="built_in">input</span>(<span class="string">&quot;请选择以上的序号(-1取消)&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> index != -<span class="number">1</span>:</span><br><span class="line">        Download.get_song_url(<span class="built_in">list</span>[<span class="built_in">int</span>(index)-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>目前2022&#x2F;8&#x2F;6为止，使用正常</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
          <category> 爬虫 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爬虫 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1408. 数组中的字符串匹配</title>
      <link href="/2022/08/06/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1408%20%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%B9%E9%85%8D/"/>
      <url>/2022/08/06/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1408%20%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%B9%E9%85%8D/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个字符串数组 <code>words</code> ，数组中的每个字符串都可以看作是一个单词。请你按 任意 顺序返回 <code>words</code> 中是其他单词的子字符串的所有单词。</p><p>如果你可以删除 <code>words[j]</code> 最左侧和&#x2F;或最右侧的若干字符得到 <code>word[i]</code> ，那么字符串 <code>words[i]</code> 就是 <code>words[j]</code> 的一个子字符串。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：words &#x3D; [“mass”,”as”,”hero”,”superhero”]<br>输出：[“as”,”hero”]<br>解释：”as” 是 “mass” 的子字符串，”hero” 是 “superhero” 的子字符串。<br>[“hero”,”as”] 也是有效的答案</p></blockquote></div><div class="story post-story"><h2 id="思路：暴力枚举"><a href="#思路：暴力枚举" class="headerlink" title="思路：暴力枚举"></a>思路：暴力枚举</h2><p>与每个字符串进行匹配</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">stringMatching</span><span class="params">(vector&lt;string&gt;&amp; words)</span> </span>&#123;</span><br><span class="line">        vector&lt;string&gt; ans;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; words.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; words.<span class="built_in">size</span>(); j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i != j &amp;&amp; words[j].<span class="built_in">find</span>(words[i]) != string::npos)&#123;</span><br><span class="line">                    ans.<span class="built_in">emplace_back</span>(words[i]);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂对分析："><a href="#复杂对分析：" class="headerlink" title="复杂对分析："></a>复杂对分析：</h2><ul><li><p>时间复杂度：O(n^2 x L^2)，其中 n 是字符串数组的长度，L 是字符串数组中最长字符串的长度。使用 KMP 字符串匹配算法可以将时间复杂度优化到 O(n^2 × T)，其中 T 是字符串数组中所有字符串的平均长度。</p></li><li><p>空间复杂度：O(1)。返回值不计入空间复杂度。如果使用 KMP 字符串匹配算法，那么对应的空间复杂度为 O(T)。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)623. 在二叉树中增加一行</title>
      <link href="/2022/08/05/%E6%AF%8F%E6%97%A5LeetCode/2022-8/623%20%E5%9C%A8%E4%BA%8C%E5%8F%89%E6%A0%91%E4%B8%AD%E5%A2%9E%E5%8A%A0%E4%B8%80%E8%A1%8C/"/>
      <url>/2022/08/05/%E6%AF%8F%E6%97%A5LeetCode/2022-8/623%20%E5%9C%A8%E4%BA%8C%E5%8F%89%E6%A0%91%E4%B8%AD%E5%A2%9E%E5%8A%A0%E4%B8%80%E8%A1%8C/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个二叉树的根 <code>root</code> 和两个整数 <code>val</code> 和 <code>depth</code> ，在给定的深度 depth 处添加一个值为 val 的节点行。</p><p>注意，根节点 <code>root</code> 位于深度 1 。</p><p>加法规则如下:</p><ul><li>给定整数 <code>depth</code>，对于深度为 <code>depth - 1</code> 的每个非空树节点 <code>cur</code> ，创建两个值为 <code>val</code> 的树节点作为 <code>cur</code> 的左子树根和右子树根。</li><li><code>cur</code> 原来的左子树应该是新的左子树根的左子树。</li><li><code>cur</code> 原来的右子树应该是新的右子树根的右子树。</li><li>如果 <code>depth == 1</code> 意味着 <code>depth - 1</code> 根本没有深度，那么创建一个树节点，值 <code>val</code> 作为整个原始树的新根，而原始树就是新根的左子树。</li></ul></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2021/03/15/addrow-tree.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2021/03/15/addrow-tree.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 50%;" /><blockquote><p>输入: root &#x3D; [4,2,6,3,1,5], val &#x3D; 1, depth &#x3D; 2<br>输出: [4,1,1,2,null,null,6,3,1,5]</p></blockquote><p>我自己写的递归很烂，不如官方的的规范、整洁！但是效率基本差不多！</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">def</span><span class="params">(TreeNode* root, <span class="type">int</span>&amp; val, <span class="type">int</span> curDepth, <span class="type">int</span>&amp; depth, <span class="type">int</span> choice)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(curDepth == depth - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(choice == <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">TreeNode</span>(val, root, <span class="literal">nullptr</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">TreeNode</span>(val, <span class="literal">nullptr</span>, root);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        root-&gt;left = <span class="built_in">def</span>(root-&gt;left, val, curDepth + <span class="number">1</span>, depth, <span class="number">1</span>);</span><br><span class="line">        root-&gt;right = <span class="built_in">def</span>(root-&gt;right, val, curDepth + <span class="number">1</span>, depth, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">TreeNode* <span class="title">addOneRow</span><span class="params">(TreeNode* root, <span class="type">int</span> val, <span class="type">int</span> depth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">def</span>(root, val, <span class="number">0</span>, depth, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>下面是官方的递归思路！</p></div><div class="story post-story"><h2 id="思路：递归"><a href="#思路：递归" class="headerlink" title="思路：递归"></a>思路：递归</h2><p>以示例中图片<strong>输出后</strong>的二叉树为例：<code>[4,1,1,2,null,null,6,3,1,5]</code></p><p>如果要在深度<code>depth</code>为3的位置插入新元素：</p><p>第一次递归：这层元素由<code>4</code> 变成了元素<code>4</code>的左右节点<code>1</code>和<code>1</code>，深度<code>depth</code>减一变为2</p><p><strong>如果深度<code>depth</code>为2的情况下</strong>，这层的节点的<strong>子节点</strong>就是要插入新元素的位置，</p><p>以这层左节点元素为例，元素<code>1</code>。创建新节点，新节点的左节点指向元素<code>1</code>的左节点，元素<code>1</code>的左节点变为新节点。这层右节点同理。到达深度为2的情况，直接返回不会到达深度为1的情况。</p><p><strong>只有在初始化深度<code>depth</code>为1的情况下</strong>，说明要在根节点<code>root</code>处插入新元素，创建新节点，新节点的左节点为根节点<code>root</code>，将根节点<code>root</code>指向为新节点，完成插入。</p><p>并且深度为n(除了深度为1的情况)，<strong>只要递归到深度depth变为2就可以插入新元素</strong>。</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">addOneRow</span><span class="params">(TreeNode* root, <span class="type">int</span> val, <span class="type">int</span> depth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">//深度为1的情况，新节点的左节点指向根节点，根节点变为新节点</span></span><br><span class="line">        <span class="keyword">if</span>(depth == <span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">TreeNode</span>(val, root, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(depth == <span class="number">2</span>) &#123; <span class="comment">//深度为2的情况</span></span><br><span class="line">            <span class="comment">//新节点指向该节点的左节点，该节点的左节点指向新节点</span></span><br><span class="line">            root-&gt;left = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(val, root-&gt;left, <span class="literal">nullptr</span>);</span><br><span class="line">            <span class="comment">//新节点指向该节点的右节点，该节点的右节点指向新节点</span></span><br><span class="line">            root-&gt;right = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(val, <span class="literal">nullptr</span>, root-&gt;right);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//递归到该节点的左节点，深度减一</span></span><br><span class="line">            root-&gt;left = <span class="built_in">addOneRow</span>(root-&gt;left, val, depth - <span class="number">1</span>);</span><br><span class="line">            <span class="comment">//递归到该节点的右节点，深度减一</span></span><br><span class="line">            root-&gt;right = <span class="built_in">addOneRow</span>(root-&gt;right, val, depth - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，其中 n 为输入的树的节点数。最坏情况下，需要遍历整棵树。</p></li><li><p>空间复杂度：O(n)，递归的深度最多为 O(n)。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1403. 非递增顺序的最小子序列</title>
      <link href="/2022/08/04/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1403%20%E9%9D%9E%E9%80%92%E5%A2%9E%E9%A1%BA%E5%BA%8F%E7%9A%84%E6%9C%80%E5%B0%8F%E5%AD%90%E5%BA%8F%E5%88%97/"/>
      <url>/2022/08/04/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1403%20%E9%9D%9E%E9%80%92%E5%A2%9E%E9%A1%BA%E5%BA%8F%E7%9A%84%E6%9C%80%E5%B0%8F%E5%AD%90%E5%BA%8F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个数组 <code>nums</code>，请你从中抽取一个子序列，满足该子序列的元素之和 严格 大于未包含在该子序列中的各元素之和。</p><p>如果存在多个解决方案，只需返回 长度最小 的子序列。如果仍然有多个解决方案，则返回 元素之和最大 的子序列。</p><p>与子数组不同的地方在于，「数组的子序列」不强调元素在原数组中的连续性，也就是说，它可以通过从数组中分离一些（也可能不分离）元素得到。</p><p>注意，题目数据保证满足所有约束条件的解决方案是 唯一 的。同时，返回的答案应当按 非递增顺序 排列。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [4,4,7,6,7]<br>输出：[7,7,6]<br>解释：子序列 [7,7] 的和为 14 ，不严格大于剩下的其他元素之和（14 &#x3D; 4 + 4 + 6）。因此，[7,6,7] 是满足题意的最小子序列。注意，元素按非递增顺序返回。 </p></blockquote><p>我自己的思路：双指针</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">minSubsequence</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>());</span><br><span class="line">        <span class="type">int</span> right = nums.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; ans;</span><br><span class="line">        <span class="type">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> ans_sum = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> temp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(left &lt;= right)&#123;</span><br><span class="line">            ans.<span class="built_in">push_back</span>(nums[right]);</span><br><span class="line">            ans_sum += nums[right];</span><br><span class="line">            right--;</span><br><span class="line">            <span class="keyword">while</span>(temp &lt; ans_sum &amp;&amp; left &lt;= right)&#123;</span><br><span class="line">                temp += nums[left];</span><br><span class="line">                left++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(ans_sum &lt;= temp)&#123;</span><br><span class="line">            ans.<span class="built_in">push_back</span>(nums[right]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>可以通过但是效率很低！下面是官方思路！</p></div><div class="story post-story"><h2 id="思路：贪心"><a href="#思路：贪心" class="headerlink" title="思路：贪心"></a>思路：贪心</h2><p>先计算出数组中各个元素加起来的总合<code>sum</code></p><p>再进行从大到小的遍历元素加起来的合<code>cur</code>，直到<strong>该子序列的元素之和</strong><code>cur</code>大于<strong>未包含在该子序列中的各元素之和</strong><code>sum-cur</code>停止。</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">minSubsequence</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> num : nums)&#123; <span class="comment">//计算总和</span></span><br><span class="line">            sum += num;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>()); <span class="comment">//排序</span></span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; ans;</span><br><span class="line">        <span class="type">int</span> cur = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = nums.<span class="built_in">size</span>() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">            ans.<span class="built_in">emplace_back</span>(nums[i]); <span class="comment">//尾部插入</span></span><br><span class="line">            cur += nums[i]; <span class="comment">//计算cur</span></span><br><span class="line">            <span class="keyword">if</span>(sum - cur &lt; cur)&#123; <span class="comment">//如果该子序列合 大于 未在子序列中的合</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(nlogn)，其中 n 为数组的长度。需要对数组进行排序，因此时间复杂度 O(nlogn)。</p></li><li><p>空间复杂度：O(logn)，其中 n 为数组的长度。排序需要的栈空间为 O(logn)。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)899. 有序队列</title>
      <link href="/2022/08/03/%E6%AF%8F%E6%97%A5LeetCode/2022-8/899%20%E6%9C%89%E5%BA%8F%E9%98%9F%E5%88%97/"/>
      <url>/2022/08/03/%E6%AF%8F%E6%97%A5LeetCode/2022-8/899%20%E6%9C%89%E5%BA%8F%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个字符串 <code>s</code> 和一个整数 <code>k</code> 。你可以从 <code>s</code> 的前 <code>k</code> 个字母中选择一个，并把它加到字符串的末尾。</p><p>返回 在应用上述步骤的任意数量的移动后，字典上最小的字符串 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “cba”, k &#x3D; 1<br>输出：”acb”<br>解释：<br>在第一步中，我们将第一个字符（“c”）移动到最后，获得字符串 “bac”。<br>在第二步中，我们将第一个字符（“b”）移动到最后，获得最终结果 “acb”。</p></blockquote></div><div class="story post-story"><h2 id="思路：脑筋急转弯"><a href="#思路：脑筋急转弯" class="headerlink" title="思路：脑筋急转弯"></a>思路：脑筋急转弯</h2><p>以s &#x3D; “cba”为例：</p><p>当k &#x3D; 1时，无论经过多少次移动，最小的字符串为”acb”，并不是”最终”最小的字符产”abc”</p><p>所以要依次遍历所有可能，找出最小的字符串</p><p>当k &gt; 1时，无论经历多少次移动，最终最小的一定是”abc”</p><p>只需对s进行排序</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">orderlyQueue</span><span class="params">(string s, <span class="type">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(k == <span class="number">1</span>)&#123; <span class="comment">//k=1时</span></span><br><span class="line">            string min_s = s; <span class="comment">//初始化最小的字符串</span></span><br><span class="line">            <span class="type">int</span> size = s.<span class="built_in">size</span>(); <span class="comment">// 获取字符串长度</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++)&#123;</span><br><span class="line">                <span class="type">char</span> temp = s[<span class="number">0</span>]; <span class="comment">//获取第一个字符</span></span><br><span class="line">                s = s.<span class="built_in">substr</span>(<span class="number">1</span>); <span class="comment">//截取除第一个字符，剩下的字符串</span></span><br><span class="line">                s.<span class="built_in">push_back</span>(temp); <span class="comment">//将第一个字符，加到字符串的后面</span></span><br><span class="line">                <span class="keyword">if</span>(min_s &gt; s)&#123; <span class="comment">//进行比较</span></span><br><span class="line">                    min_s = s;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> min_s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123; <span class="comment">//k&gt;1时</span></span><br><span class="line">            <span class="built_in">sort</span>(s.<span class="built_in">begin</span>(), s.<span class="built_in">end</span>()); <span class="comment">//排序</span></span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n^2)，其中 n 是字符串 s 的长度。当 k &#x3D; 1 时需要遍历 n 个可能的字符串，每个字符串需要 O(n) 的时间生成和判断是否字典序最小，时间复杂度是 O(n^2)；当 k &gt; 1 时需要对字符串排序，时间复杂度是 O(nlogn)。最坏情况下时间复杂度是 O(n^2)。</p></li><li><p>空间复杂度：O(n) 或 O(logn)，其中 n 是字符串 s 的长度。空间复杂度取决于具体实现的语言。对于字符串不可变的语言，当 k &#x3D; 1 时生成每个字符串和当 k &gt; 1 时生成排序后的字符串都需要 O(n) 的空间；对于字符串可变的语言，可以省略 O(n) 的空间，只有当 k &gt; 1 时排序需要 O(logn) 的空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)622. 设计循环队列</title>
      <link href="/2022/08/02/%E6%AF%8F%E6%97%A5LeetCode/2022-8/622%20%E8%AE%BE%E8%AE%A1%E5%BE%AA%E7%8E%AF%E9%98%9F%E5%88%97/"/>
      <url>/2022/08/02/%E6%AF%8F%E6%97%A5LeetCode/2022-8/622%20%E8%AE%BE%E8%AE%A1%E5%BE%AA%E7%8E%AF%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>设计你的循环队列实现。 循环队列是一种线性数据结构，其操作表现基于 FIFO（先进先出）原则并且队尾被连接在队首之后以形成一个循环。它也被称为“环形缓冲器”。</p><p>循环队列的一个好处是我们可以利用这个队列之前用过的空间。在一个普通队列里，一旦一个队列满了，我们就不能插入下一个元素，即使在队列前面仍有空间。但是使用循环队列，我们能使用这些空间去存储新的值。</p><p>你的实现应该支持如下操作：</p><ul><li><code>MyCircularQueue(k)</code>：构造器，设置队列长度为 k 。</li><li><code>Front()</code>：从队首获取元素。如果队列为空，返回 -1 。</li><li><code>Rear()</code>：获取队尾元素。如果队列为空，返回 -1 。</li><li><code>enQueue(value)</code>：向循环队列插入一个元素。如果成功插入则返回真。</li><li><code>deQueue()</code>：从循环队列中删除一个元素。如果成功删除则返回真。</li><li><code>isEmpty()</code>：检查循环队列是否为空。</li><li><code>isFull()</code>：检查循环队列是否已满。</li></ul></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>MyCircularQueue circularQueue &#x3D; new MyCircularQueue(3); &#x2F;&#x2F; 设置长度为 3<br>circularQueue.enQueue(1);  &#x2F;&#x2F; 返回 true<br>circularQueue.enQueue(2);  &#x2F;&#x2F; 返回 true<br>circularQueue.enQueue(3);  &#x2F;&#x2F; 返回 true<br>circularQueue.enQueue(4);  &#x2F;&#x2F; 返回 false，队列已满<br>circularQueue.Rear();  &#x2F;&#x2F; 返回 3<br>circularQueue.isFull();  &#x2F;&#x2F; 返回 true<br>circularQueue.deQueue();  &#x2F;&#x2F; 返回 true<br>circularQueue.enQueue(4);  &#x2F;&#x2F; 返回 true<br>circularQueue.Rear();  &#x2F;&#x2F; 返回 4</p></blockquote></div><div class="story post-story"><h2 id="思路：数组"><a href="#思路：数组" class="headerlink" title="思路：数组"></a>思路：数组</h2><p>初始化(空栈)：</p><p>以示例为例，设置长度<code>k</code>为3，但是初始化的实际容量<code>capacity</code>应该为<code>k+1</code>即为4</p><p>初始化头节点<code>front</code>以及尾节点<code>rear</code>为0号位置</p><p>注意：<code>rear</code>指向的位置不是末尾的元素，而是末尾的元素的下一位置</p><p>是否为空判断：<code>front</code>与<code>rear</code>是否再同一个位置，即<code>front == rear</code></p><table><thead><tr><th align="center">front<br>$\Downarrow$</th><th align="center"></th><th align="center"></th><th align="center"></th></tr></thead><tbody><tr><td align="center">0</td><td align="center">1</td><td align="center">2</td><td align="center">3</td></tr><tr><td align="center">空</td><td align="center">空</td><td align="center">空</td><td align="center">空</td></tr><tr><td align="center">$\Uparrow$<br>rear</td><td align="center"></td><td align="center"></td><td align="center"></td></tr></tbody></table><p>如何循环？：</p><p>将<code>rear</code>指针所在的3号位置赋值为4后，需要将<code>rear</code>指针后移，但是<code>rear+1</code>后会导致越界</p><p>我们希望<code>rear</code>指针应该移动到0号位置，可以进行取余操作：<code>(rear + 1) % capacity</code></p><p><code>rear</code>指针当前的位置为3，容量<code>capacity</code>为4，带入公式：<code>(3 + 1) % 4 = 0</code></p><p><code>rear</code>指针移动我们所想要的到达的0号位置</p><table><thead><tr><th align="center"></th><th align="center"></th><th align="center">front<br/>$\Downarrow$</th><th align="center"></th></tr></thead><tbody><tr><td align="center">0</td><td align="center">1</td><td align="center">2</td><td align="center">3</td></tr><tr><td align="center">空</td><td align="center">空</td><td align="center">3</td><td align="center">空</td></tr><tr><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">$\Uparrow$<br/>rear</td></tr></tbody></table><table><thead><tr><th align="center"></th><th align="center"></th><th align="center">front<br/>$\Downarrow$</th><th align="center"></th></tr></thead><tbody><tr><td align="center">0</td><td align="center">1</td><td align="center">2</td><td align="center">3</td></tr><tr><td align="center">空</td><td align="center">空</td><td align="center">3</td><td align="center">4</td></tr><tr><td align="center">$\Uparrow$<br/>rear</td><td align="center"></td><td align="center"></td><td align="center"></td></tr></tbody></table><p>满列的情况：</p><p>当存储的元素个数为3时，就达到满列的情况</p><p>判断是否为满列：rear指针后移，如果<code>front</code>与<code>rear</code>在同一位置，则说明满列</p><p>即<code>(rear + 1) % capacity == front</code></p><table><thead><tr><th align="center">front<br>$\Downarrow$</th><th align="center"></th><th align="center"></th><th align="center"></th></tr></thead><tbody><tr><td align="center">0</td><td align="center">1</td><td align="center">2</td><td align="center">3</td></tr><tr><td align="center">1</td><td align="center">2</td><td align="center">3</td><td align="center">空</td></tr><tr><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">$\Uparrow$<br/>rear</td></tr></tbody></table><p>注意：也可以使用链表实现队列解决该问题！！用链表实现队列更简单</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><p>以下为数组实现：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyCircularQueue</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; queue; <span class="comment">// 队列</span></span><br><span class="line">    <span class="type">int</span> capacity;      <span class="comment">//容量</span></span><br><span class="line">    <span class="type">int</span> front;         <span class="comment">//头节点</span></span><br><span class="line">    <span class="type">int</span> rear;          <span class="comment">//尾节点</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MyCircularQueue</span>(<span class="type">int</span> k) &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;capacity = k + <span class="number">1</span>; </span><br><span class="line">        <span class="keyword">this</span>-&gt;queue = <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(<span class="keyword">this</span>-&gt;capacity); <span class="comment">//初始化容量为k+1</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;front = <span class="number">0</span>;                           <span class="comment">//初始化头节点</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;rear = <span class="number">0</span>;                            <span class="comment">//初始化尾节点</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//入列</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">enQueue</span><span class="params">(<span class="type">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断是否为满列</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;<span class="built_in">isFull</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">//插入队列</span></span><br><span class="line">        queue[<span class="keyword">this</span>-&gt;rear] = value;</span><br><span class="line">        <span class="comment">//rear指针后移</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;rear = (<span class="keyword">this</span>-&gt;rear + <span class="number">1</span>) % <span class="keyword">this</span>-&gt;capacity;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//出列</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">deQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断是否为空</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;<span class="built_in">isEmpty</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">//front指针后移</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;front = (<span class="keyword">this</span>-&gt;front + <span class="number">1</span>) % <span class="keyword">this</span>-&gt;capacity;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Front</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断是否为空</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;<span class="built_in">isEmpty</span>()) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="comment">//返回头节点的元素</span></span><br><span class="line">        <span class="keyword">return</span> queue[<span class="keyword">this</span>-&gt;front];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Rear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断是否为空</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;<span class="built_in">isEmpty</span>()) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="comment">//rear指针为末尾元素的下一位，要回到上一位置</span></span><br><span class="line">        <span class="comment">//如果rear=0，代入公式：(0 - 1 + 4) % 4 = 3；3为上一个位置</span></span><br><span class="line">        <span class="type">int</span> temp = (<span class="keyword">this</span>-&gt;rear - <span class="number">1</span> + <span class="keyword">this</span>-&gt;capacity) % <span class="keyword">this</span>-&gt;capacity;</span><br><span class="line">        <span class="comment">//返回该位置的元素</span></span><br><span class="line">        <span class="keyword">return</span> queue[temp];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断头节点与尾节点是否在同一位置</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;front == <span class="keyword">this</span>-&gt;rear;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断尾节点的下一个位置是否与头节点在同一位置</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>-&gt;rear + <span class="number">1</span>) % <span class="keyword">this</span>-&gt;capacity == <span class="keyword">this</span>-&gt;front;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：初始化和每项操作的时间复杂度均为 O(1)。</li><li>空间复杂度：O(k)，其中 k 为给定的队列元素数目。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1374. 生成每种字符都是奇数个的字符串</title>
      <link href="/2022/08/01/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1374%20%E7%94%9F%E6%88%90%E6%AF%8F%E7%A7%8D%E5%AD%97%E7%AC%A6%E9%83%BD%E6%98%AF%E5%A5%87%E6%95%B0%E4%B8%AA%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
      <url>/2022/08/01/%E6%AF%8F%E6%97%A5LeetCode/2022-8/1374%20%E7%94%9F%E6%88%90%E6%AF%8F%E7%A7%8D%E5%AD%97%E7%AC%A6%E9%83%BD%E6%98%AF%E5%A5%87%E6%95%B0%E4%B8%AA%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数 n，请你返回一个含 n 个字符的字符串，其中每种字符在该字符串中都恰好出现 奇数次 。</p><p>返回的字符串必须只含小写英文字母。如果存在多个满足题目要求的字符串，则返回其中任意一个即可。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：n &#x3D; 4<br>输出：”pppz”<br>解释：”pppz” 是一个满足题目要求的字符串，因为 ‘p’ 出现 3 次，且 ‘z’ 出现 1 次。当然，还有很多其他字符串也满足题目要求，比如：”ohhh” 和 “love”。</p></blockquote><p>多说无益！</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">generateTheString</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n%<span class="number">2</span> == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">string</span>(n<span class="number">-1</span>,<span class="string">&#x27;a&#x27;</span>) + <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">string</span>(n, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(n)。</li><li>空间复杂度：O(1)。这里不计入返回值需要的空间。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1161. 最大层内元素和</title>
      <link href="/2022/07/31/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1161%20%E6%9C%80%E5%A4%A7%E5%B1%82%E5%86%85%E5%85%83%E7%B4%A0%E5%92%8C/"/>
      <url>/2022/07/31/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1161%20%E6%9C%80%E5%A4%A7%E5%B1%82%E5%86%85%E5%85%83%E7%B4%A0%E5%92%8C/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个二叉树的根节点 <code>root</code>。设根节点位于二叉树的第 <code>1</code> 层，而根节点的子节点位于第 <code>2</code> 层，依此类推。</p><p>请返回层内元素之和 <strong>最大</strong> 的那几层（可能只有一层）的层号，并返回其中 <strong>最小</strong> 的那个。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2019/08/17/capture.jpeg" class="lazyload" data-srcset="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2019/08/17/capture.jpeg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:50%;" /><blockquote><p>输入：root &#x3D; [1,7,0,7,-8,null,null]<br>输出：2<br>解释：<br>第 1 层各元素之和为 1，<br>第 2 层各元素之和为 7 + 0 &#x3D; 7，<br>第 3 层各元素之和为 7 + -8 &#x3D; -1，<br>所以我们返回第 2 层的层号，它的层内元素之和最大。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>使用队列，层序遍历二叉树同时计算出每层的元素之和，比较每层的总和，得出最大总和所在的层数</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxLevelSum</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        queue&lt;TreeNode*&gt; q;</span><br><span class="line">        q.<span class="built_in">push</span>(root);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> max_sum = <span class="number">-999999</span>; <span class="comment">//设置最大元素之和</span></span><br><span class="line">        <span class="type">int</span> max_level_sum = <span class="number">1</span>; <span class="comment">//记录最大总和的所在的层</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> level_sum = <span class="number">1</span>; <span class="comment">//当前层数</span></span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>())&#123; <span class="comment">//第一个循环，遍历层</span></span><br><span class="line">            <span class="type">int</span> size = q.<span class="built_in">size</span>(); <span class="comment">//获取当前层的节点数</span></span><br><span class="line">            <span class="type">int</span> sum = <span class="number">0</span>; <span class="comment">//初始化该层的元素之和</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(size != <span class="number">0</span>)&#123; <span class="comment">//第二个循环，遍历每层的节点</span></span><br><span class="line">                TreeNode* p = q.<span class="built_in">front</span>(); <span class="comment">//获取该节点</span></span><br><span class="line">                q.<span class="built_in">pop</span>(); <span class="comment">//移除在队列中的该节点</span></span><br><span class="line">                sum += p-&gt;val; <span class="comment">//加上该节点的值，计算该层的元素之和</span></span><br><span class="line">                <span class="keyword">if</span>(p-&gt;left != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">                    q.<span class="built_in">push</span>(p-&gt;left); <span class="comment">//插入下一层的左节点</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(p-&gt;right != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">                    q.<span class="built_in">push</span>(p-&gt;right);<span class="comment">//插入下一层的右节点</span></span><br><span class="line">                &#125;</span><br><span class="line">                size--; <span class="comment">//已遍历完gai该层节点数减一</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(max_sum &lt; sum)&#123; <span class="comment">//如果该层的元素之和大于之前的</span></span><br><span class="line">                max_sum = sum;</span><br><span class="line">                max_level_sum = level_sum;</span><br><span class="line">            &#125;</span><br><span class="line">            level_sum++; <span class="comment">//层数加一，进入下一层</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> max_level_sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1331. 数组序号转换</title>
      <link href="/2022/07/28/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1331%20%E6%95%B0%E7%BB%84%E5%BA%8F%E5%8F%B7%E8%BD%AC%E6%8D%A2/"/>
      <url>/2022/07/28/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1331%20%E6%95%B0%E7%BB%84%E5%BA%8F%E5%8F%B7%E8%BD%AC%E6%8D%A2/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数数组 <code>arr</code> ，请你将数组中的每个元素替换为它们排序后的序号。</p><p>序号代表了一个元素有多大。序号编号的规则如下：</p><p>序号从 1 开始编号。<br>一个元素越大，那么序号越大。如果两个元素相等，那么它们的序号相同。<br>每个数字的序号都应该尽可能地小。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：arr &#x3D; [37,12,28,9,100,56,80,5,12]<br>输出：[5,3,4,2,8,6,7,1,3]</p></blockquote></div><div class="story post-story"><h2 id="思路：哈希表"><a href="#思路：哈希表" class="headerlink" title="思路：哈希表"></a>思路：哈希表</h2><blockquote><p>首先用<code>temp</code>数组拷贝一份原数组<code>arr</code></p><p>将<code>temp</code>数组进行排序</p><p>用一个哈希表保存<code>temp</code>数组各元素的排列序号</p><p>最后根据原数组<code>arr</code>各个元素的位置返回排列序号</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">arrayRankTransform</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; arr)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">temp</span><span class="params">(arr)</span></span>; <span class="comment">//拷贝一份数组</span></span><br><span class="line">        <span class="built_in">sort</span>(temp.<span class="built_in">begin</span>(), temp.<span class="built_in">end</span>()); <span class="comment">//将temp排序</span></span><br><span class="line"></span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; map;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> count = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; temp.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="comment">//如果map中已经存在，则跳过</span></span><br><span class="line">            <span class="keyword">if</span>(!map.<span class="built_in">count</span>(temp[i]))&#123;</span><br><span class="line">                map[temp[i]] = count;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; ans;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; arr.<span class="built_in">size</span>(); j++)&#123;</span><br><span class="line">            ans.<span class="built_in">emplace_back</span>(map[arr[j]]); <span class="comment">//插入序号</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n×logn)，其中 n 是输入数组 arr 的长度，排序消耗 O(n×logn) 时间。</p></li><li><p>空间复杂度：O(n)。有序数组和哈希表各消耗 O(n) 空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)919. 完全二叉树插入器</title>
      <link href="/2022/07/25/%E6%AF%8F%E6%97%A5LeetCode/2022-7/919%20%E5%AE%8C%E5%85%A8%E4%BA%8C%E5%8F%89%E6%A0%91%E6%8F%92%E5%85%A5%E5%99%A8/"/>
      <url>/2022/07/25/%E6%AF%8F%E6%97%A5LeetCode/2022-7/919%20%E5%AE%8C%E5%85%A8%E4%BA%8C%E5%8F%89%E6%A0%91%E6%8F%92%E5%85%A5%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>完全二叉树： </p><ul><li>是每一层（除最后一层外）都是完全填充（即，节点数达到最大）的，并且所有的节点都尽可能地集中在左侧。</li></ul><p>设计一种算法，将一个新节点插入到一个完整的二叉树中，并在插入后保持其完整。</p><p>实现 <code>CBTInserter</code> 类：</p><ul><li><code>CBTInserter(TreeNode root)</code> 使用头节点为 root 的给定树初始化该数据结构；</li><li><code>CBTInserter.insert(int v)</code>  向树中插入一个值为 Node.val &#x3D;&#x3D; val的新节点 TreeNode。使树保持完全二叉树的状态，并返回插入节点 TreeNode 的父节点的值；</li><li><code>CBTInserter.get_root()</code> 将返回树的头节点。</li></ul></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2021/08/03/lc-treeinsert.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2021/08/03/lc-treeinsert.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 50%;" /><blockquote><p>输入：<br>[“CBTInserter”, “insert”, “insert”, “get_root”]<br>[[[1, 2]], [3], [4], []]<br>输出：<br>[null, 1, 2, [1, 2, 3, 4]]</p><p>解释：<br>CBTInserter cBTInserter &#x3D; new CBTInserter([1, 2]);<br>cBTInserter.insert(3);  &#x2F;&#x2F; 返回父节点 1<br>cBTInserter.insert(4);  &#x2F;&#x2F; 返回父节点 2<br>cBTInserter.get_root(); &#x2F;&#x2F; 返回根节点 [1, 2, 3, 4]</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>应用队列实现树的层序遍历：</p><blockquote><ol><li>首先将二叉树的根节点进队，判断队列不为空，就输出队头的元素</li><li>判断节点如果有孩子，就将孩子进队</li><li>遍历过的节点出队</li><li>循环，直到q.empty()</li></ol></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CBTInserter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//存入最底层的节点方便以后插入</span></span><br><span class="line">    queue&lt;TreeNode*&gt; node;</span><br><span class="line">    TreeNode* root;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取底层节点</span></span><br><span class="line">    <span class="built_in">CBTInserter</span>(TreeNode* root) &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;root = root;</span><br><span class="line">        queue&lt;TreeNode*&gt; q;</span><br><span class="line">        <span class="comment">//向队尾插入节点</span></span><br><span class="line">        q.<span class="built_in">push</span>(root); </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (!q.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="comment">//返回队列中的第一个元素</span></span><br><span class="line">            TreeNode* n = q.<span class="built_in">front</span>(); </span><br><span class="line">            <span class="comment">//删除队列第一个元素</span></span><br><span class="line">            q.<span class="built_in">pop</span>(); </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (n-&gt;left) &#123;</span><br><span class="line">                q.<span class="built_in">push</span>(n-&gt;left);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (n-&gt;right) &#123;</span><br><span class="line">                q.<span class="built_in">push</span>(n-&gt;right);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!(n-&gt;left &amp;&amp; n-&gt;right)) &#123; <span class="comment">//获取最底层的节点</span></span><br><span class="line">                node.<span class="built_in">push</span>(n);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">insert</span><span class="params">(<span class="type">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建一个新节点</span></span><br><span class="line">        TreeNode* new_node = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(val);</span><br><span class="line">        <span class="comment">// 获得队列的第一个元素</span></span><br><span class="line">        TreeNode* n = node.<span class="built_in">front</span>(); </span><br><span class="line">        <span class="comment">//获取该节点的值</span></span><br><span class="line">        <span class="type">int</span> ret = n-&gt;val;</span><br><span class="line">        <span class="comment">// 如果不存在，就插入左节点</span></span><br><span class="line">        <span class="keyword">if</span>(!(n-&gt;left))&#123;</span><br><span class="line">            n-&gt;left = new_node;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//存在，就插入到右节点</span></span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            n-&gt;right = new_node;</span><br><span class="line">            <span class="comment">//删除该节点，因为左右节点都已经存在</span></span><br><span class="line">            node.<span class="built_in">pop</span>(); </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将新节点插入到队列</span></span><br><span class="line">        node.<span class="built_in">push</span>(new_node);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">TreeNode* <span class="title">get_root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：初始化 CBTInserter(root) 需要的时间为 O(n)，其中 n 是给定的初始完全二叉树的节点个数。insert(v) 和 get_root() 的时间复杂度均为 O(1)。</p></li><li><p>空间复杂度：O(n+q)，其中 q 是 insert(v) 的调用次数。在调用了 q 次 insert(v) 后，完全二叉树中有 n+q 个节点，其中有一半的节点在队列中，需要 O(n+q) 的空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1184. 公交站间的距离</title>
      <link href="/2022/07/24/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1184%20%E5%85%AC%E4%BA%A4%E7%AB%99%E9%97%B4%E7%9A%84%E8%B7%9D%E7%A6%BB/"/>
      <url>/2022/07/24/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1184%20%E5%85%AC%E4%BA%A4%E7%AB%99%E9%97%B4%E7%9A%84%E8%B7%9D%E7%A6%BB/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>环形公交路线上有 <code>n</code> 个站，按次序从 <code>0</code> 到 <code>n - 1</code> 进行编号。我们已知每一对相邻公交站之间的距离，<code>distance[i]</code> 表示编号为 <code>i</code> 的车站和编号为 <code>(i + 1) % n</code> 的车站之间的距离。</p><p>环线上的公交车都可以按顺时针和逆时针的方向行驶。</p><p>返回乘客从出发点 <code>start</code> 到目的地 <code>destination</code> 之间的最短距离。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2019/09/08/untitled-diagram-1.jpg" class="lazyload" data-srcset="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2019/09/08/untitled-diagram-1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:67%;" /><blockquote><p>输入：distance &#x3D; [1,2,3,4], start &#x3D; 0, destination &#x3D; 1<br>输出：1<br>解释：公交站 0 和 1 之间的距离顺时针是 1 ，逆时针是 9，所以最小值是 1。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>先计算总的距离<code>all_sum</code>，再计算<code>start</code>到<code>destination</code>的距离为<code>positive_sum</code></p><p>返回顺时针的距离<code>positive_sum</code>以及逆时针的距离<code>all_sum-positive_sum</code>它们中的最小距离</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">distanceBetweenBusStops</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; distance, <span class="type">int</span> start, <span class="type">int</span> destination)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> all_sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i =<span class="number">0</span>; i &lt; distance.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            all_sum += distance[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(start &gt; destination) <span class="built_in">swap</span>(start, destination);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> positive_sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(start; start &lt; destination; start++)&#123;</span><br><span class="line">            positive_sum += distance[start];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(positive_sum, all_sum - positive_sum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>优化后：将两个循环合并在一起</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">distanceBetweenBusStops</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; distance, <span class="type">int</span> start, <span class="type">int</span> destination)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> all_sum = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> positive_sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(start &gt; destination) <span class="built_in">swap</span>(start, destination);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i =<span class="number">0</span>; i &lt; distance.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            all_sum += distance[i];</span><br><span class="line">            <span class="keyword">if</span>(i &gt;= start &amp;&amp; i &lt; destination)&#123;</span><br><span class="line">                positive_sum += distance[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(positive_sum, all_sum - positive_sum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)814. 二叉树剪枝</title>
      <link href="/2022/07/21/%E6%AF%8F%E6%97%A5LeetCode/2022-7/814%20%E4%BA%8C%E5%8F%89%E6%A0%91%E5%89%AA%E6%9E%9D/"/>
      <url>/2022/07/21/%E6%AF%8F%E6%97%A5LeetCode/2022-7/814%20%E4%BA%8C%E5%8F%89%E6%A0%91%E5%89%AA%E6%9E%9D/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你二叉树的根结点 <code>root</code> ，此外树的每个结点的值要么是 <code>0</code> ，要么是 <code>1</code> 。</p><p>返回移除了所有不包含 1 的子树的原二叉树。</p><p>节点 <code>node</code> 的子树为 <code>node</code> 本身加上所有 <code>node</code> 的后代。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://s3-lc-upload.s3.amazonaws.com/uploads/2018/04/06/1028_2.png" class="lazyload" data-srcset="https://s3-lc-upload.s3.amazonaws.com/uploads/2018/04/06/1028_2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 33%;" /><blockquote><p>输入：root &#x3D; [1,null,0,0,1]<br>输出：[1,null,0,null,1]<br>解释：<br>只有红色节点满足条件“所有不包含 1 的子树”。 右图为返回的答案。</p></blockquote><p><code>自底向上</code>进行剪枝，如果某个节点不存在左右节点，并且该节点值为0的话就需要<code>剪枝</code></p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">pruneTree</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        </span><br><span class="line">        root-&gt;left = <span class="built_in">pruneTree</span>(root-&gt;left);</span><br><span class="line">        root-&gt;right = <span class="built_in">pruneTree</span>(root-&gt;right);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(root-&gt;left == <span class="literal">nullptr</span> &amp;&amp; root-&gt;right ==<span class="literal">nullptr</span> &amp;&amp; root-&gt;val == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(n)，其中 n 是二叉树节点的个数。每个节点都需要遍历一次。</p></li><li><p>空间复杂度：O(n)，其中 n 是二叉树节点的个数。递归的深度最多为 O(n)。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1252. 奇数值单元格的数目</title>
      <link href="/2022/07/12/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1252%20%E5%A5%87%E6%95%B0%E5%80%BC%E5%8D%95%E5%85%83%E6%A0%BC%E7%9A%84%E6%95%B0%E7%9B%AE/"/>
      <url>/2022/07/12/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1252%20%E5%A5%87%E6%95%B0%E5%80%BC%E5%8D%95%E5%85%83%E6%A0%BC%E7%9A%84%E6%95%B0%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个 <code>m</code> x <code>n</code> 的矩阵，最开始的时候，每个单元格中的值都是 0。</p><p>另有一个二维索引数组 <code>indices</code>，<code>indices[i] = [ri, ci]</code> 指向矩阵中的某个位置，其中 <code>ri</code> 和 <code>ci</code> 分别表示指定的行和列（从 0 开始编号）。</p><p>对 <code>indices[i]</code> 所指向的每个位置，应同时执行下述增量操作：</p><p><code>ri</code> 行上的所有单元格，加 1 。<br><code>ci</code> 列上的所有单元格，加 1 。<br>给你 <code>m</code>、<code>n</code> 和 <code>indices</code> 。请你在执行完所有 <code>indices</code> 指定的增量操作后，返回矩阵中 奇数值单元格 的数目。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：m &#x3D; 2, n &#x3D; 3, indices &#x3D; [[0,1],[1,1]]<br>输出：6<br>解释：</p><p>[[0,0,0],     &#x3D;&#x3D;&gt;     [[1,2,1],    &#x3D;&#x3D;&gt;    [[1,3,1],  </p><p> [0,0,0]]                 [0,1,0]]              [1,3,1]]    返回奇数的个数</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">oddCells</span><span class="params">(<span class="type">int</span> m, <span class="type">int</span> n, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; indices)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">dp</span><span class="params">(n)</span></span>;</span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">dps</span>(m, dp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; indices.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">                dps[indices[i][<span class="number">0</span>]][j] += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; m; k++) &#123;</span><br><span class="line">                dps[k][indices[i][<span class="number">1</span>]] += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (dps[i][j] % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(q×(m+n)+m×n), 其中 q 表示数组 indices 的长度，m,n 为矩阵的行数与列数。遍历数组时，每次都需要更新矩阵中一行加一列，需要的时间为 O(q×(m+n))，最后还需要遍历矩阵，需要的时间为 O(m×n)，总的时间复杂度为 O(q×(m+n)+m×n)。</p></li><li><p>空间复杂度：O(m×n)，其中 m,n 为矩阵的行数与列数。需要存储矩阵的所有元素。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)676. 实现一个魔法字典</title>
      <link href="/2022/07/11/%E6%AF%8F%E6%97%A5LeetCode/2022-7/676%20%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AD%94%E6%B3%95%E5%AD%97%E5%85%B8/"/>
      <url>/2022/07/11/%E6%AF%8F%E6%97%A5LeetCode/2022-7/676%20%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AD%94%E6%B3%95%E5%AD%97%E5%85%B8/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>设计一个使用单词列表进行初始化的数据结构，单词列表中的单词 互不相同 。 如果给出一个单词，请判定能否只将这个单词中一个字母换成另一个字母，使得所形成的新单词存在于你构建的字典中。</p><p>实现 <code>MagicDictionary</code> 类：</p><p><code>MagicDictionary()</code> 初始化对象<br><code>void buildDict(String[] dictionary)</code> 使用字符串数组 <code>dictionary</code> 设定该数据结构，<code>dictionary</code> 中的字符串互不相同<br><code>bool search(String searchWord)</code> 给定一个字符串 <code>searchWord</code> ，判定能否只将字符串中 一个 字母换成另一个字母，使得所形成的新字符串能够与字典中的任一字符串匹配。如果可以，返回 <code>true</code>；否则，返回 <code>false</code>。 </p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入<br>[“MagicDictionary”, “buildDict”, “search”, “search”, “search”, “search”]<br>[[], [[“hello”, “leetcode”]], [“hello”], [“hhllo”], [“hell”], [“leetcoded”]]<br>输出<br>[null, null, false, true, false, false]</p><p>解释<br>MagicDictionary magicDictionary &#x3D; new MagicDictionary();<br>magicDictionary.buildDict([“hello”, “leetcode”]);<br>magicDictionary.search(“hello”); &#x2F;&#x2F; 返回 False<br>magicDictionary.search(“hhllo”); &#x2F;&#x2F; 将第二个 ‘h’ 替换为 ‘e’ 可以匹配 “hello” ，所以返回 True<br>magicDictionary.search(“hell”); &#x2F;&#x2F; 返回 False<br>magicDictionary.search(“leetcoded”); &#x2F;&#x2F; 返回 False</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>遍历词典，找到与<code>searchWord</code>单词长度一样的单词，再与之对比相同的位置的字母是否相同，记录不相同字母的次数，只有不相同的字母的次数为1时，才可以返回<code>true</code></p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MagicDictionary</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;string&gt; dic;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MagicDictionary</span>() &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">buildDict</span><span class="params">(vector&lt;string&gt; dictionary)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;dic= dictionary;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">search</span><span class="params">(string searchWord)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = searchWord.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; dic.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(dic[i].<span class="built_in">size</span>() == n)&#123;</span><br><span class="line">                <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(dic[i][j] != searchWord[j])&#123;</span><br><span class="line">                        count++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(count == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(qnl)，其中 n 是数组 dictionary 的长度，l 是数组 dictionary 中字符串的平均长度，q 是函数 search(searchWord) 的调用次数。</li></ul><ul><li>空间复杂度：O(nl)，即为数组需要使用的空间。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)873. 最长的斐波那契子序列的长度</title>
      <link href="/2022/07/09/%E6%AF%8F%E6%97%A5LeetCode/2022-7/873%20%E6%9C%80%E9%95%BF%E7%9A%84%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E5%AD%90%E5%BA%8F%E5%88%97%E7%9A%84%E9%95%BF%E5%BA%A6/"/>
      <url>/2022/07/09/%E6%AF%8F%E6%97%A5LeetCode/2022-7/873%20%E6%9C%80%E9%95%BF%E7%9A%84%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E5%AD%90%E5%BA%8F%E5%88%97%E7%9A%84%E9%95%BF%E5%BA%A6/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>如果序列 $X_1, X_2, …, X_n$ 满足下列条件，就说它是 斐波那契式 的：</p><p>n &gt;&#x3D; 3<br>对于所有 i + 2 &lt;&#x3D; n，都有 $X_i + X_{i+1} &#x3D; X_{i+2}$<br>给定一个严格递增的正整数数组形成序列 <code>arr</code> ，找到 <code>arr</code> 中最长的斐波那契式的子序列的长度。如果一个不存在，返回  0 。</p><p>（回想一下，子序列是从原序列 <code>arr</code> 中派生出来的，它从 <code>arr</code> 中删掉任意数量的元素（也可以不删），而不改变其余元素的顺序。例如， [3, 5, 8] 是 [3, 4, 5, 6, 7, 8] 的一个子序列）</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入: arr &#x3D; [1,3,7,11,12,14,18]<br>输出: 3<br>解释: 最长的斐波那契式子序列有 [1,11,12]、[3,11,14] 以及 [7,11,18] 。</p></blockquote></div><div class="story post-story"><h2 id="思路：递归"><a href="#思路：递归" class="headerlink" title="思路：递归"></a>思路：递归</h2><p>费劲尽心，最后运行超时！！</p><h3 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">def</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; arr, vector&lt;<span class="type">int</span>&gt; dp, <span class="type">int</span> pos)</span></span>&#123;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> n = dp.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=pos; i &lt; arr.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(n &lt; <span class="number">2</span>)&#123;</span><br><span class="line">                <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">n_dp</span><span class="params">(dp)</span></span>;</span><br><span class="line">                n_dp.<span class="built_in">emplace_back</span>(arr[i]);</span><br><span class="line">                ans = <span class="built_in">max</span>(<span class="built_in">def</span>(arr, n_dp, i+<span class="number">1</span>)+<span class="number">1</span>, ans);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(n &gt;= <span class="number">2</span> &amp;&amp; dp[n<span class="number">-1</span>] + dp[n<span class="number">-2</span>] == arr[i])&#123;</span><br><span class="line">                vector&lt;<span class="type">int</span>&gt; <span class="built_in">n_dp</span>(dp);</span><br><span class="line">                n_dp.<span class="built_in">emplace_back</span>(arr[i]);</span><br><span class="line">                ans = <span class="built_in">max</span>(<span class="built_in">def</span>(arr, n_dp, i+<span class="number">1</span>)+<span class="number">1</span>, ans);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(ans &lt;= <span class="number">2</span> &amp;&amp; pos &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">lenLongestFibSubseq</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; arr)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; dp;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">def</span>(arr, dp, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="思路：动态规划"><a href="#思路：动态规划" class="headerlink" title="思路：动态规划"></a>思路：动态规划</h2><p>摆烂了！</p><p><code>arr[k]+arr[j]=arr[i]</code></p><p>大小：<code>k&lt;j&lt;i</code></p><h3 id="代码-cpp-：-1"><a href="#代码-cpp-：-1" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">lenLongestFibSubseq</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; arr)</span> </span>&#123;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; indices;</span><br><span class="line">        <span class="type">int</span> n = arr.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            indices[arr[i]] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建全是0的n*n二维数组</span></span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">dp</span>(n, <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n));</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = i - <span class="number">1</span>; j &gt;= <span class="number">0</span> &amp;&amp; arr[j] * <span class="number">2</span> &gt; arr[i]; j--) &#123;</span><br><span class="line">                <span class="type">int</span> k = <span class="number">-1</span>;</span><br><span class="line">                <span class="comment">//如果indices中存在arr[i]-arr[j]这个数</span></span><br><span class="line">                <span class="keyword">if</span> (indices.<span class="built_in">count</span>(arr[i] - arr[j])) &#123;</span><br><span class="line">                    <span class="comment">//获得获得此数</span></span><br><span class="line">                    k = indices[arr[i] - arr[j]];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//如果k不等于-1</span></span><br><span class="line">                <span class="keyword">if</span> (k &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    dp[j][i] = <span class="built_in">max</span>(dp[k][j] + <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//获得到最大的序列长度</span></span><br><span class="line">                ans = <span class="built_in">max</span>(ans, dp[j][i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h3><ul><li><p>时间复杂度：O(n^2)，其中 n 是数组 arr 的长度。动态规划的状态数是 O(n^2)，每个状态的计算时间都是 O(1)</p></li><li><p>空间复杂度：O(n^2)，其中 n 是数组 arr 的长度。需要创建二维数组 dp，空间是 O(n^2)</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1846. 减小和重新排列数组后的最大元素</title>
      <link href="/2022/07/08/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1846%20%E5%87%8F%E5%B0%8F%E5%92%8C%E9%87%8D%E6%96%B0%E6%8E%92%E5%88%97%E6%95%B0%E7%BB%84%E5%90%8E%E7%9A%84%E6%9C%80%E5%A4%A7%E5%85%83%E7%B4%A0/"/>
      <url>/2022/07/08/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1846%20%E5%87%8F%E5%B0%8F%E5%92%8C%E9%87%8D%E6%96%B0%E6%8E%92%E5%88%97%E6%95%B0%E7%BB%84%E5%90%8E%E7%9A%84%E6%9C%80%E5%A4%A7%E5%85%83%E7%B4%A0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个正整数数组 <code>arr</code> 。请你对 <code>arr</code> 执行一些操作（也可以不进行任何操作），使得数组满足以下条件：</p><p><code>arr</code> 中 第一个 元素必须为 1 。<br>任意相邻两个元素的差的绝对值 小于等于 1 ，也就是说，对于任意的 <code>1 &lt;= i &lt; arr.length</code> （数组下标从 0 开始），都满足 <code>abs(arr[i] - arr[i - 1]) &lt;= 1</code> 。<code>abs(x)</code> 为 x 的绝对值。<br>你可以执行以下 2 种操作任意次：</p><p>减小 <code>arr</code> 中任意元素的值，使其变为一个 更小的正整数 。<br>重新排列 <code>arr</code> 中的元素，你可以以任意顺序重新排列。<br>请你返回执行以上操作后，在满足前文所述的条件下，<code>arr</code> 中可能的 最大值 。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：arr &#x3D; [100,1,1000]<br>输出：3<br>解释：<br>一个可行的方案如下：</p><ol><li>重新排列 arr 得到 [1,100,1000] 。</li><li>将第二个元素减小为 2 。</li><li>将第三个元素减小为 3 。<br>现在 arr &#x3D; [1,2,3] ，满足所有条件。<br>arr 中最大元素为 3 。</li></ol></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maximumElementAfterDecrementingAndRearranging</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; arr)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//将arr数组排序</span></span><br><span class="line">        <span class="built_in">sort</span>(arr.<span class="built_in">begin</span>(), arr.<span class="built_in">end</span>());</span><br><span class="line">        <span class="comment">//如果第一个元素不为1，则设置为1</span></span><br><span class="line">        <span class="keyword">if</span>(arr[<span class="number">0</span>] != <span class="number">1</span>) arr[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">将最大数设置为数组第一个元素</span><br><span class="line">        <span class="type">int</span> max = arr[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; arr.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="comment">//当前的元素减去前面的元素，它们的绝对值肯定是大于0的</span></span><br><span class="line">            <span class="type">int</span> temp = arr[i] - arr[i<span class="number">-1</span>];</span><br><span class="line">            <span class="comment">//如果绝对值大于1，则设置当前的元素为前面的元素+1</span></span><br><span class="line">            <span class="keyword">if</span>(temp &gt; <span class="number">1</span>) arr[i] = arr[i<span class="number">-1</span>]+<span class="number">1</span>;</span><br><span class="line">            <span class="comment">//如果当前元素大于max的元素，将当前元素设置为最大数</span></span><br><span class="line">            <span class="keyword">if</span>(arr[i] &gt; max) max = arr[i];</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//返回最大数</span></span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(nlogn)，其中 n 是数组 arr 的长度。时间复杂度即排序的复杂度。</p></li><li><p>空间复杂度：O(logn)。空间复杂度不考虑输入，因此空间复杂度主要取决于排序时产生的 O(logn) 的栈空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)593. 有效的正方形</title>
      <link href="/2022/07/08/%E6%AF%8F%E6%97%A5LeetCode/2022-7/593%20%E6%9C%89%E6%95%88%E7%9A%84%E6%AD%A3%E6%96%B9%E5%BD%A2/"/>
      <url>/2022/07/08/%E6%AF%8F%E6%97%A5LeetCode/2022-7/593%20%E6%9C%89%E6%95%88%E7%9A%84%E6%AD%A3%E6%96%B9%E5%BD%A2/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定2D空间中四个点的坐标 p1, p2, p3 和 p4，如果这四个点构成一个正方形，则返回 true 。</p><p>点的坐标 pi 表示为 [xi, yi] 。输入 不是 按任何顺序给出的。</p><p>一个 有效的正方形 有四条等边和四个等角(90度角)。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：p1 &#x3D; [1,0], p2 &#x3D; [-1,0], p3 &#x3D; [0,1], p4 &#x3D; [0,-1]<br>输出：true</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>自己想出的一种很无脑的思路！</p><p>先做一个判断，某一行或某一列是否存在三个以上的点，存在则不可能是正方形</p><p>选取其中一个最小的点，计算与其余点之间的距离。如果是正方形的话，一定有两个相等的边长，和一个较长的对角线，并且满足勾股定理。</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">judge</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; p1, vector&lt;<span class="type">int</span>&gt;&amp; p2, vector&lt;<span class="type">int</span>&gt;&amp; p3, vector&lt;<span class="type">int</span>&gt;&amp; p4)</span></span>&#123;</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(p1[<span class="number">0</span>] == p2[<span class="number">0</span>]) count++;</span><br><span class="line">        <span class="keyword">if</span>(p1[<span class="number">0</span>] == p3[<span class="number">0</span>]) count++;</span><br><span class="line">        <span class="keyword">if</span>(p1[<span class="number">0</span>] == p4[<span class="number">0</span>]) count++;</span><br><span class="line"><span class="comment">//判断某行，是否存在三个点</span></span><br><span class="line">        <span class="keyword">if</span>(count &gt;= <span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(p1[<span class="number">1</span>] == p2[<span class="number">1</span>]) count++;</span><br><span class="line">        <span class="keyword">if</span>(p1[<span class="number">1</span>] == p3[<span class="number">1</span>]) count++;</span><br><span class="line">        <span class="keyword">if</span>(p1[<span class="number">1</span>] == p4[<span class="number">1</span>]) count++;</span><br><span class="line"><span class="comment">//判断某列，是否存在三个点</span></span><br><span class="line">        <span class="keyword">if</span>(count &gt;= <span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">validSquare</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; p1, vector&lt;<span class="type">int</span>&gt;&amp; p2, vector&lt;<span class="type">int</span>&gt;&amp; p3, vector&lt;<span class="type">int</span>&gt;&amp; p4)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断是否存在有三个点在一条线上</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">is_duo</span>(p1,p2,p3,p4)) <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> n1 = p1[<span class="number">0</span>] + p1[<span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span> n2 = p2[<span class="number">0</span>] + p2[<span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span> n3 = p3[<span class="number">0</span>] + p3[<span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span> n4 = p4[<span class="number">0</span>] + p4[<span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line"><span class="comment">//选取一个最小的点作为计算与其余点之间的距离</span></span><br><span class="line">        <span class="type">int</span> min_num = <span class="built_in">min</span>(n1, n2);</span><br><span class="line">        min_num = <span class="built_in">min</span>(n3, min_num);</span><br><span class="line">        min_num = <span class="built_in">min</span>(n4, min_num);</span><br><span class="line"><span class="comment">//与p1点交换，使p1点变为最小点</span></span><br><span class="line">        <span class="keyword">if</span>(min_num == n2) p1.<span class="built_in">swap</span>(p2);</span><br><span class="line">        <span class="keyword">if</span>(min_num == n3) p1.<span class="built_in">swap</span>(p3);</span><br><span class="line">        <span class="keyword">if</span>(min_num == n4) p1.<span class="built_in">swap</span>(p4);</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; nums;</span><br><span class="line">        <span class="comment">//计算p1点到其余三个点的距离，未取根号因为会产生小数</span></span><br><span class="line">        <span class="type">int</span> num1 = <span class="built_in">pow</span>(p1[<span class="number">0</span>]-p2[<span class="number">0</span>], <span class="number">2</span>) + <span class="built_in">pow</span>(p1[<span class="number">1</span>]-p2[<span class="number">1</span>], <span class="number">2</span>);</span><br><span class="line">        nums.<span class="built_in">push_back</span>(num1);</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> num2 = <span class="built_in">pow</span>(p1[<span class="number">0</span>]-p3[<span class="number">0</span>], <span class="number">2</span>) + <span class="built_in">pow</span>(p1[<span class="number">1</span>]-p3[<span class="number">1</span>], <span class="number">2</span>);</span><br><span class="line">        nums.<span class="built_in">push_back</span>(num2);</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> num3 = <span class="built_in">pow</span>(p1[<span class="number">0</span>]-p4[<span class="number">0</span>], <span class="number">2</span>) + <span class="built_in">pow</span>(p1[<span class="number">1</span>]-p4[<span class="number">1</span>], <span class="number">2</span>);</span><br><span class="line">        nums.<span class="built_in">push_back</span>(num3);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>()); <span class="comment">//排序，对角线大于边长</span></span><br><span class="line"><span class="comment">//如果存在对角线为0</span></span><br><span class="line">        <span class="keyword">if</span>(nums[<span class="number">2</span>] == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">        <span class="comment">//如果两条边长不相等 </span></span><br><span class="line">        <span class="keyword">if</span>(nums[<span class="number">0</span>] != nums[<span class="number">1</span>]) <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">        <span class="comment">//勾股定理，判断是否为直角</span></span><br><span class="line">        <span class="keyword">if</span>(nums[<span class="number">0</span>] + nums[<span class="number">1</span>] != nums[<span class="number">2</span>]) <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)729. 我的日程安排表 I</title>
      <link href="/2022/07/05/%E6%AF%8F%E6%97%A5LeetCode/2022-7/729%20%E6%88%91%E7%9A%84%E6%97%A5%E7%A8%8B%E5%AE%89%E6%8E%92%E8%A1%A8%20I/"/>
      <url>/2022/07/05/%E6%AF%8F%E6%97%A5LeetCode/2022-7/729%20%E6%88%91%E7%9A%84%E6%97%A5%E7%A8%8B%E5%AE%89%E6%8E%92%E8%A1%A8%20I/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>实现一个 <code>MyCalendar</code> 类来存放你的日程安排。如果要添加的日程安排不会造成 重复预订 ，则可以存储这个新的日程安排。</p><p>当两个日程安排有一些时间上的交叉时（例如两个日程安排都在同一时间内），就会产生 重复预订 。</p><p>日程可以用一对整数 <code>start</code> 和 <code>end</code> 表示，这里的时间是半开区间，即 <code>[start, end)</code>, 实数 x 的范围为，  <code>start &lt;= x &lt; end</code> 。</p><p>实现 <code>MyCalendar</code> 类：</p><p><code>MyCalendar()</code> 初始化日历对象。<br><code>boolean book(int start, int end)</code> 如果可以将日程安排成功添加到日历中而不会导致重复预订，返回 <code>true</code>。否则，返回 <code>false</code> 并且不要将该日程安排添加到日历中。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：<br>[“MyCalendar”, “book”, “book”, “book”]<br>[[], [10, 20], [15, 25], [20, 30]]<br>输出：<br>[null, true, false, true]</p></blockquote></div><div class="story post-story"><h2 id="思路：二分查找"><a href="#思路：二分查找" class="headerlink" title="思路：二分查找"></a>思路：二分查找</h2><p>设已经插入了一些日程：</p><p>$[[start_1,end_1),[start_2,end_2),[start_3,end_3)]$</p><p>日程之间不交叉并且一定是有这样的排序：</p><p>$start_1 &lt; end_1 \leq start_2 &lt; end_2 \leq start_3 &lt; end_3$</p><p>如果要插入<code>[start, end)</code></p><p>一定是在$end_i \leq start&lt;end&lt; start_{i+1}$</p><p>利用二分查找，找到恰比<code>end</code>大的元素：$start_{i+1}$</p><p>再将$start_{i+1}$前面的元素$end_i$与<code>start</code>比较，看是否交叉。</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyCalendar</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//set默认的比较规则先按照first比较，如果first相同，再按照second比较</span></span><br><span class="line">    set&lt;pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt;&gt; calendar;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">book</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取比end恰好大的元素的迭代器，没有则返回迭代器end()</span></span><br><span class="line">        <span class="comment">//如果calendar没有元素，则返回迭代器begin()</span></span><br><span class="line">        <span class="keyword">auto</span> temp = calendar.<span class="built_in">lower_bound</span>(&#123;end, <span class="number">0</span>&#125;);</span><br><span class="line">        <span class="comment">//如果temp为begin()说明没有元素直接插入</span></span><br><span class="line">        <span class="comment">//如果不为begin()则与temp前面的元素的右区间比较，如果小于等于start说明没有交叉，插入</span></span><br><span class="line">        <span class="keyword">if</span>(temp == calendar.<span class="built_in">begin</span>() || (--temp)-&gt;second &lt;= start)&#123;</span><br><span class="line">            calendar.<span class="built_in">insert</span>(&#123;start, end&#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(nlogn), 其中 n 表示日程安排的数量。由于每次在进行预订时，都需要进行二分查找，需要的时间为 O(logn)。</p></li><li><p>空间复杂度：O(n)，其中 n 表示日程安排的数量。需要保存所有已经预订的行程。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>set容器用法</title>
      <link href="/2022/07/05/C++/set%E5%AE%B9%E5%99%A8/"/>
      <url>/2022/07/05/C++/set%E5%AE%B9%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="set容器："><a href="#set容器：" class="headerlink" title="set容器："></a>set容器：</h2><p>所有元素都会在插入时自动排序，底层结构采用二叉树实现。</p></div><div class="story post-story"><h2 id="set和multiset区别："><a href="#set和multiset区别：" class="headerlink" title="set和multiset区别："></a>set和multiset区别：</h2><ul><li>set不可以插入重复数据，而multiset可以</li><li>set插入数据的同时会返回插入结果，表示插入是否成功</li><li>multiset不会检测数据，因此可以插入重复数据</li></ul><p>set容器的使用：</p><p>头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;set&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br></pre></td></tr></table></figure><p>构造函数：</p><table><thead><tr><th align="center">构造函数</th><th>解释</th></tr></thead><tbody><tr><td align="center">set()</td><td>默认构造函数</td></tr><tr><td align="center">set(const set &amp;st)</td><td>拷贝构造函数</td></tr></tbody></table><p>成员函数：</p><table><thead><tr><th align="center">成员函数</th><th>解释</th></tr></thead><tbody><tr><td align="center">void insert(T key)</td><td>插入key</td></tr><tr><td align="center">void emplace(T key)</td><td>插入key，比insert()效率高</td></tr><tr><td align="center">erase()</td><td>删除</td></tr><tr><td align="center">void clear()</td><td>清空</td></tr><tr><td align="center">bool find(T key)</td><td>查找</td></tr><tr><td align="center">int count(T key)</td><td>统计</td></tr><tr><td align="center">int size()</td><td>获取大小</td></tr><tr><td align="center">bool empty()</td><td>是否为空</td></tr><tr><td align="center">void swap(set &amp;st)</td><td>交换</td></tr><tr><td align="center">iterator lower_bound(T key)</td><td>如果set容器中没有元素，则返回迭代器begin()；<br>如果set容器中存在元素，则返回恰好比key大的元素的迭代器，不存在则返回迭代器end()</td></tr></tbody></table><p>自定义数据类型排序</p><p>set&lt;pair&lt;int,int&gt;&gt;</p><p>set默认的比较规则先按照first比较，如果first相同，再按照second 比较。</p></div>]]></content>
      
      
      <categories>
          
          <category> C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> 容器 </tag>
            
            <tag> STL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1200. 最小绝对差</title>
      <link href="/2022/07/04/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1200%20%E6%9C%80%E5%B0%8F%E7%BB%9D%E5%AF%B9%E5%B7%AE/"/>
      <url>/2022/07/04/%E6%AF%8F%E6%97%A5LeetCode/2022-7/1200%20%E6%9C%80%E5%B0%8F%E7%BB%9D%E5%AF%B9%E5%B7%AE/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你个整数数组 <code>arr</code>，其中每个元素都 <strong>不相同</strong>。</p><p>请你找到所有具有最小绝对差的元素对，并且按升序的顺序返回。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><p>示例1：</p><blockquote><p>输入：arr &#x3D; [4,2,1,3]<br>输出：[[1,2],[2,3],[3,4]]</p></blockquote><p>示例2：</p><blockquote><p>输入：arr &#x3D; [1,3,6,10,15]<br>输出：[[1,3]]</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>先将<code>arr</code>数组排序</p><p>再遍历<code>arr</code>数组，如果找到有比<code>min</code>更小的差值，将<code>min</code>改为该差值，将<code>dp</code>数组之前记录的数据清空(因为之前记录的都是差值大的)，重新插入差值更小的数据。</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">minimumAbsDifference</span>(vector&lt;<span class="type">int</span>&gt;&amp; arr) &#123;</span><br><span class="line">        <span class="comment">//将arr数组排序</span></span><br><span class="line">        <span class="built_in">sort</span>(arr.<span class="built_in">begin</span>(),arr.<span class="built_in">end</span>());</span><br><span class="line">        <span class="type">int</span> min = INT_MAX;</span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; dp;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; arr.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="comment">//当前的差值</span></span><br><span class="line">            <span class="type">int</span> temp = arr[i]-arr[i<span class="number">-1</span>];</span><br><span class="line">            <span class="keyword">if</span>(temp &lt; min)&#123;</span><br><span class="line">                min = temp;</span><br><span class="line">                <span class="comment">//将dp数组清空</span></span><br><span class="line">                dp.<span class="built_in">clear</span>();</span><br><span class="line">                <span class="comment">//重新插入新的差值小的数据</span></span><br><span class="line">                dp.<span class="built_in">push_back</span>(&#123;arr[i<span class="number">-1</span>],arr[i]&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(temp == min)&#123;</span><br><span class="line">                dp.<span class="built_in">push_back</span>(&#123;arr[i<span class="number">-1</span>],arr[i]&#125;);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：O(nlogn)，其中 n 是数组 arr 的长度。排序需要的时间为 O(nlogn)，遍历需要的是时间为 O(n)，因此总时间复杂度为 O(nlogn)。</p></li><li><p>空间复杂度：O(logn)，即为排序需要使用的栈空间。这里不计入返回值需要使用的空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)556. 下一个更大元素 III</title>
      <link href="/2022/07/03/%E6%AF%8F%E6%97%A5LeetCode/2022-7/556%20%E4%B8%8B%E4%B8%80%E4%B8%AA%E6%9B%B4%E5%A4%A7%E5%85%83%E7%B4%A0%20III/"/>
      <url>/2022/07/03/%E6%AF%8F%E6%97%A5LeetCode/2022-7/556%20%E4%B8%8B%E4%B8%80%E4%B8%AA%E6%9B%B4%E5%A4%A7%E5%85%83%E7%B4%A0%20III/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个正整数 <code>n</code> ，请你找出符合条件的最小整数，其由重新排列 <code>n</code> 中存在的每位数字组成，并且其值大于 <code>n</code> 。如果不存在这样的正整数，则返回 <code>-1</code> 。</p><p>注意 ，返回的整数应当是一个 <strong>32 位整数</strong> ，如果存在满足题意的答案，但不是 32 位整数 ，同样返回 <code>-1</code>。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><p>示例 1：</p><blockquote><p>输入：n &#x3D; 12324321<br>输出：12331224</p></blockquote><p>示例 2：</p><blockquote><p>输入：n &#x3D; 21<br>输出：-1</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>以<code>n = 12324321</code>为例</p><p>①.<code>pos1</code>指针从后往前遍历，找到第<code>pos1</code>位置的数比后面的数小的位置，<code>pos1</code>记录位置</p><table><thead><tr><th>1</th><th>2</th><th>3</th><th>2</th><th>4</th><th>3</th><th align="center"><span style="color:red">2</span></th><th><span style="color:red">1</span></th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td><td></td><td></td><td align="center">$\leftarrow\Uparrow$<br><br>pos1</td><td></td></tr></tbody></table><p>2与1比较，2大，<code>pos1</code>向左移</p><p>循环直到：</p><table><thead><tr><th>1</th><th>2</th><th>3</th><th align="center"><span style="color:red">2</span></th><th><span style="color:red">4</span></th><th>3</th><th align="center">2</th><th>1</th></tr></thead><tbody><tr><td></td><td></td><td></td><td align="center">$\leftarrow\Uparrow$<br/><br/>pos1</td><td></td><td></td><td align="center"></td><td></td></tr></tbody></table><p>2与4比较，2小，记录<code>pos1</code>的位置</p><p>②.再定义<code>pos2</code>指针，从后往前遍历，找到比<code>pos1</code>位置后面的数中，有比<code>pos1</code>位置的数大的数，用pos2记录位置</p><table><thead><tr><th>1</th><th>2</th><th>3</th><th align="center"><span style="color:red">2</span></th><th>4</th><th>3</th><th align="center">2</th><th align="center"><span style="color:red">1</span></th></tr></thead><tbody><tr><td></td><td></td><td></td><td align="center">$\Uparrow$<br><br>pos1</td><td></td><td></td><td align="center"></td><td align="center">$\leftarrow\Uparrow$<br/><br/>pos2</td></tr></tbody></table><p><code>pos1</code>大于<code>pos2</code>，<code>pos2</code>指针左移</p><p>循环直到：</p><table><thead><tr><th>1</th><th>2</th><th>3</th><th align="center"><span style="color:red">2</span></th><th>4</th><th align="center"><span style="color:red">3</span></th><th align="center">2</th><th align="center">1</th></tr></thead><tbody><tr><td></td><td></td><td></td><td align="center">$\Uparrow$<br><br>pos1</td><td></td><td align="center">$\leftarrow\Uparrow$<br/><br/>pos2</td><td align="center"></td><td align="center"></td></tr></tbody></table><p><code>pos1</code>小于<code>pos2</code>，记录指针<code>pos2</code>位置</p><p>③.交换<code>pos1</code>和<code>pos2</code>的位置</p><table><thead><tr><th>1</th><th>2</th><th>3</th><th><span style="color:red">3</span></th><th>4</th><th><span style="color:red">2</span></th><th>2</th><th>1</th></tr></thead></table><p>④.将<code>pos1</code>位置后面的数进行反转</p><table><thead><tr><th>1</th><th>2</th><th>3</th><th>3</th><th>1</th><th>2</th><th>2</th><th>4</th></tr></thead></table><p>结果：12331224</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> <span class="title function_">nextGreaterElement</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="comment">//将n转换成字符串</span></span><br><span class="line">        <span class="type">string</span> <span class="variable">num</span> <span class="operator">=</span> to_string(n);</span><br><span class="line">        <span class="type">int</span> <span class="variable">pos1</span> <span class="operator">=</span> num.size()-<span class="number">2</span>;</span><br><span class="line">        <span class="comment">//从后往前遍历，找到前面的数小于后面的数，前面数的位置</span></span><br><span class="line">        <span class="keyword">while</span>(pos1 &gt;= <span class="number">0</span> &amp;&amp; num[pos1] &gt;= num[pos1+<span class="number">1</span>])&#123;</span><br><span class="line">            pos1--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//遍历到字符串第0个位置，还没有小于的数，则不存在</span></span><br><span class="line">        <span class="keyword">if</span>(pos1 &lt; <span class="number">0</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pos2</span> <span class="operator">=</span> num.size()-<span class="number">1</span>;</span><br><span class="line">        <span class="comment">//从后往前遍历，找到有比pos1位置的数小的数，返回pos2位置</span></span><br><span class="line">        <span class="keyword">while</span>(pos2 &gt; pos1 &amp;&amp; num[pos1] &gt;= num[pos2])&#123;</span><br><span class="line">            pos2--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//交换两个位置的数</span></span><br><span class="line">        swap(num[pos1],num[pos2]);</span><br><span class="line">        <span class="comment">//将pos1后面的字符串反转</span></span><br><span class="line">        reverse(num.begin() + pos1 + <span class="number">1</span>, num.end());</span><br><span class="line">        <span class="comment">//防止溢出，先将temp转换成long型</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">temp</span> <span class="operator">=</span> stol(num);</span><br><span class="line">        <span class="comment">//如果超出int的范围，返回-1</span></span><br><span class="line">        <span class="keyword">if</span>(temp &gt; INT_MAX) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(logn)。</li><li>空间复杂度：O(logn)。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)871. 最低加油次数</title>
      <link href="/2022/07/02/%E6%AF%8F%E6%97%A5LeetCode/2022-7/871%20%E6%9C%80%E4%BD%8E%E5%8A%A0%E6%B2%B9%E6%AC%A1%E6%95%B0/"/>
      <url>/2022/07/02/%E6%AF%8F%E6%97%A5LeetCode/2022-7/871%20%E6%9C%80%E4%BD%8E%E5%8A%A0%E6%B2%B9%E6%AC%A1%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>汽车从起点出发驶向目的地，该目的地位于出发位置东面 target 英里处。</p><p>沿途有加油站，每个 <code>station[i]</code> 代表一个加油站，它位于出发位置东面 <code>station[i][0]</code> 英里处，并且有 <code>station[i][1]</code>升汽油。</p><p>假设汽车油箱的容量是无限的，其中最初有<code>startFuel</code>升燃料。它每行驶 1 英里就会用掉 1 升汽油。</p><p>当汽车到达加油站时，它可能停下来加油，将所有汽油从加油站转移到汽车中。</p><p>为了到达目的地，汽车所必要的最低加油次数是多少？如果无法到达目的地，则返回 -1 。</p><p>注意：如果汽车到达加油站时剩余燃料为 0，它仍然可以在那里加油。如果汽车到达目的地时剩余燃料为 0，仍然认为它已经到达目的地。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><p>示例1：</p><blockquote><p>输入：target &#x3D; 100, startFuel &#x3D; 1, stations &#x3D; [[10,100]]<br>输出：-1<br>解释：我们无法抵达目的地，甚至无法到达第一个加油站。</p></blockquote><p>示例2：</p><blockquote><p>输入：target &#x3D; 100, startFuel &#x3D; 10, stations &#x3D; [[10,60],[20,30],[30,30],[60,40]]<br>输出：2<br>解释：<br>我们出发时有 10 升燃料。<br>我们开车来到距起点 10 英里处的加油站，消耗 10 升燃料。将汽油从 0 升加到 60 升。<br>然后，我们从 10 英里处的加油站开到 60 英里处的加油站（消耗 50 升燃料），<br>并将汽油从 10 升加到 50 升。然后我们开车抵达目的地。<br>我们沿途在1两个加油站停靠，所以返回 2 。</p></blockquote><p>思路：</p></div><div class="story post-story"><h2 id="一、回溯法"><a href="#一、回溯法" class="headerlink" title="一、回溯法"></a>一、回溯法</h2><h3 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">def</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; stations,<span class="type">int</span> cur_station, <span class="type">int</span> begin, <span class="type">int</span>&amp; end, <span class="type">int</span> oil)</span></span>&#123;</span><br><span class="line">        <span class="comment">//到达目的地</span></span><br><span class="line">        <span class="keyword">if</span>(oil+begin &gt;= end) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//油量不够到达目的地</span></span><br><span class="line">        <span class="keyword">if</span>(cur_station+<span class="number">1</span> == stations.<span class="built_in">size</span>() &amp;&amp; oil+begin &lt; end)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//油量不够到达下一个加油站</span></span><br><span class="line">        <span class="keyword">if</span>(cur_station+<span class="number">1</span> &lt; stations.<span class="built_in">size</span>() &amp;&amp; oil+begin &lt; stations[cur_station+<span class="number">1</span>][<span class="number">0</span>])&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = INT_MAX;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = cur_station+<span class="number">1</span>; i &lt; stations.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(stations[i][<span class="number">0</span>] &lt;= begin+oil)&#123;</span><br><span class="line">                <span class="type">int</span> temp = <span class="built_in">def</span>(stations, i, stations[i][<span class="number">0</span>] ,end ,oil+begin-stations[i][<span class="number">0</span>]+stations[i][<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">if</span>(temp != <span class="number">-1</span> &amp;&amp; ans &gt; temp+<span class="number">1</span>) ans = temp+<span class="number">1</span>; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(ans == INT_MAX) ans = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minRefuelStops</span><span class="params">(<span class="type">int</span> target, <span class="type">int</span> startFuel, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; stations)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//出发地没有加油站，第一个加油站编号为0，所以初始化为-1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">def</span>(stations, <span class="number">-1</span>, <span class="number">0</span>, target, startFuel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>运行超时</p></div><div class="story post-story"><h2 id="二、贪心"><a href="#二、贪心" class="headerlink" title="二、贪心"></a>二、贪心</h2><h3 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h3><p>如果不需要加油就往前走，当不够到达下一个加油站或目的地，就从之前走到过的加油站之中选择汽油量最多的加油站进行补充汽油。</p><p>以此往复，到达目的地。</p><p>如果所有加油站的汽油都被加完，并且没到达目的地，则不可能到达。</p><h3 id="代码-cpp-：-1"><a href="#代码-cpp-：-1" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minRefuelStops</span><span class="params">(<span class="type">int</span> target, <span class="type">int</span> startFuel, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; stations)</span> </span>&#123;</span><br><span class="line">        priority_queue&lt;<span class="type">int</span>&gt; pq;</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>; <span class="comment">//初始化加油次数</span></span><br><span class="line">        <span class="type">int</span> begin = <span class="number">0</span>; <span class="comment">//初始化路程</span></span><br><span class="line">        <span class="type">int</span> cur_fuel = startFuel;<span class="comment">//初始化车的汽油量</span></span><br><span class="line">        <span class="type">int</span> cur_distance; <span class="comment">//表示当前的路程</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= stations.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i &lt; stations.<span class="built_in">size</span>()) cur_distance = stations[i][<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">else</span> cur_distance = target;</span><br><span class="line">            <span class="comment">//(cur_distance - begin)：表示第i-1个加油站到第i个加油站之间的路程，cur_fuel为到第i个加油站时剩余的油量</span></span><br><span class="line">            cur_fuel -= cur_distance - begin;</span><br><span class="line">            <span class="comment">//如果油量为负数，说明需要从第i个加油站，之前的加油站之中选择加油量最多的加油站，进行补充汽油</span></span><br><span class="line">            <span class="keyword">while</span> (cur_fuel &lt; <span class="number">0</span> &amp;&amp; !pq.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                cur_fuel += pq.<span class="built_in">top</span>();<span class="comment">//选择汽油量最多的加油站补充</span></span><br><span class="line">                pq.<span class="built_in">pop</span>();</span><br><span class="line">                count++;<span class="comment">//加油次数加1</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//都已经把之前的加油站的汽油都补充了，还是负数说明无法到达下一个加油站或目的地</span></span><br><span class="line">            <span class="keyword">if</span> (cur_fuel &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; stations.<span class="built_in">size</span>()) &#123;</span><br><span class="line">                <span class="comment">//将第i个加油站的汽油量记录，现在不需要加油，等以后缺油再加</span></span><br><span class="line">                pq.<span class="built_in">emplace</span>(stations[i][<span class="number">1</span>]);</span><br><span class="line">                begin = cur_distance;<span class="comment">//更新路程</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h3><ul><li><p>时间复杂度：O(nlogn)，其中 n 是数组 <code>stations</code> 的长度。需要遍历数组 <code>stations</code> 一次，每个加油站的汽油量最多添加到优先队列和从优先队列中移除各一次，每次优先队列的操作需要 O(logn) 的时间，因此时间复杂度是 O(nlogn)。</p></li><li><p>空间复杂度：O(n)，其中 n 是数组 <code>stations</code> 的长度。优先队列需要 O(n) 的空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vector容器用法</title>
      <link href="/2022/06/30/C++/vecter%E5%AE%B9%E5%99%A8/"/>
      <url>/2022/06/30/C++/vecter%E5%AE%B9%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="vector是什么？"><a href="#vector是什么？" class="headerlink" title="vector是什么？"></a>vector是什么？</h2><p>vector是一个能够存放任意类型的动态数组。</p><p>vector实现动态增长的原理：<br>vector的原理就是动态数组。<br>当插入新元素的时候，如果空间不足，那么vector会重新申请更大的一块空间，将原空间数据拷贝到新空间，释放旧空间数据，再把新元素插入新申请空间。</p><p>需要导入头文件：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="构造函数："><a href="#构造函数：" class="headerlink" title="构造函数："></a>构造函数：</h2><table><thead><tr><th align="center">构造函数</th><th>解释</th></tr></thead><tbody><tr><td align="center"><span style="color:red">vector()</span></td><td>创建一个空的vector</td></tr><tr><td align="center"><span style="color:red">vector(int size)</span></td><td>创建一个vector,元素个数为size，且值均为0(默认为0)</td></tr><tr><td align="center"><span style="color:red">vector(int size, T value)</span></td><td>创建一个vector，元素个数为size,且值均为value</td></tr><tr><td align="center"><span style="color:red">vector(const vector&amp; v)</span></td><td>另一个vector容器拷贝到这个vector中</td></tr><tr><td align="center">vector(iterator begin(), iterator end())</td><td>另一个[begin,end)区间内的数组元素的复制这个vector中</td></tr></tbody></table></div><div class="story post-story"><h2 id="成员函数："><a href="#成员函数：" class="headerlink" title="成员函数："></a>成员函数：</h2><table><thead><tr><th align="center">插入函数</th><th>解释</th></tr></thead><tbody><tr><td align="center">void push_back(const T&amp; x)</td><td>容器尾部插入一个元素X</td></tr><tr><td align="center">void <span style="color:red">emplace_back(const T&amp; x)</span></td><td>容器尾部插入一个元素X，比push_back()效率高</td></tr><tr><td align="center">iterator insert(iterator it,const T&amp; x)</td><td>容器中迭代器指向元素的前面插入一个元素x</td></tr><tr><td align="center">iterator insert(iterator it,int n,const T&amp; x)</td><td>容器中迭代器指向元素的前面插入n个相同的元素x</td></tr><tr><td align="center">iterator insert(iterator it,const_iterator first,const_iterator last)</td><td>向量中迭代器指向元素的前面插入另一个相同类型的vector容器的[first,last)间的数据</td></tr></tbody></table><table><thead><tr><th align="center">删除函数</th><th align="left">解释</th></tr></thead><tbody><tr><td align="center">iterator erase(iterator it)</td><td align="left">删除容器中迭代器指向的元素</td></tr><tr><td align="center">iterator erase(iterator first,iterator last)</td><td align="left">删除容器中[first,last)中的元素</td></tr><tr><td align="center">void <span style="color:red">pop_back()</span></td><td align="left">删除容器中最后一个元素</td></tr><tr><td align="center">void clear()</td><td align="left">清空容器中所有元素</td></tr></tbody></table><p><img src="https://s2.loli.net/2022/06/30/fSvFNGZcyYA1exu.png" class="lazyload" data-srcset="https://s2.loli.net/2022/06/30/fSvFNGZcyYA1exu.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="插入和迭代器指针"></p><table><thead><tr><th align="center">遍历函数</th><th>解释</th></tr></thead><tbody><tr><td align="center">T at(int pos)</td><td>返回pos位置的元素(第一个位置为0)</td></tr><tr><td align="center">T front()</td><td>返回首元素</td></tr><tr><td align="center">T back()</td><td>返回尾元素</td></tr><tr><td align="center">iterator <span style="color:red">begin()</span></td><td>返回vector容器中指向的第一个元素的迭代器</td></tr><tr><td align="center">iterator <span style="color:red">end()</span></td><td>返回vector容器中指向最后一个元素的下一个位置的迭代器</td></tr><tr><td align="center">reverse_iterator rbegin()</td><td>反向迭代器，指向容器中最后一个元素</td></tr><tr><td align="center">reverse_iterator rend()</td><td>反向迭代器，指向容器第一个元素前面的位置</td></tr></tbody></table><table><thead><tr><th align="center">大小函数</th><th>解释</th></tr></thead><tbody><tr><td align="center">int <span style="color:red">size()</span></td><td>返回vector容器中元素的个数</td></tr><tr><td align="center">int capacity()</td><td>返回当前vector容器所能容纳的最大容量</td></tr><tr><td align="center">int max_size()</td><td>返回vector容器的最大可允许的容量</td></tr><tr><td align="center">void resize(int size)</td><td>更改vector容器的元素的个数为size</td></tr><tr><td align="center">void reserve(int capacity)</td><td>更改vector容器的容量为capacity</td></tr></tbody></table><table><thead><tr><th align="center">赋值函数</th><th>解释</th></tr></thead><tbody><tr><td align="center">vector<T>&amp; operator&#x3D;</td><td>将右边vector容器的元素拷贝到左边vector容器中</td></tr><tr><td align="center">void assign(int n,const T&amp; x)</td><td>设置容器中前n个元素的值为x</td></tr><tr><td align="center">void assign(const_iterator first,const_iterator last)</td><td>将另一个vector容器中[first,last)中元素设置成当前vector容器的元素</td></tr></tbody></table><table><thead><tr><th align="center">其他函数</th><th>解释</th></tr></thead><tbody><tr><td align="center">bool <span style="color:red">empty()</span></td><td>判断向量是否为空，若为空，则返回真</td></tr><tr><td align="center">void swap(vector&amp; v)</td><td>将两个同类型vector容器的元素互换</td></tr></tbody></table></div><div class="story post-story"><h2 id="vector的遍历："><a href="#vector的遍历：" class="headerlink" title="vector的遍历："></a>vector的遍历：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; v.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">cout &lt;&lt; v[i] &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; v.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">cout &lt;&lt; v1.<span class="built_in">at</span>(i) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (vector&lt;<span class="type">int</span>&gt;::iterator it = v.<span class="built_in">begin</span>(); it != v.<span class="built_in">end</span>(); it++)&#123;</span><br><span class="line">cout &lt;&lt; *it &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> it = v.<span class="built_in">begin</span>(); it != v.<span class="built_in">end</span>(); it++)&#123;</span><br><span class="line">cout &lt;&lt; *it &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>]]></content>
      
      
      <categories>
          
          <category> C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> 容器 </tag>
            
            <tag> STL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)1175. 质数排列</title>
      <link href="/2022/06/30/%E6%AF%8F%E6%97%A5LeetCode/2022-6/1175%20%E8%B4%A8%E6%95%B0%E6%8E%92%E5%88%97/"/>
      <url>/2022/06/30/%E6%AF%8F%E6%97%A5LeetCode/2022-6/1175%20%E8%B4%A8%E6%95%B0%E6%8E%92%E5%88%97/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>请你帮忙给从 1 到 <code>n</code> 的数设计排列方案，使得所有的「质数」都应该被放在「质数索引」（索引从 1 开始）上；你需要返回可能的方案总数。<br>由于答案可能会很大，所以请你返回答案 <strong>模 mod $10^9$ + 7</strong> 之后的结果即可。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：n &#x3D; 5<br>输出：12</p></blockquote><p>解释：</p><p>先看质数定义：一个大于1的自然数，<strong>除了1和它自身外</strong>，不能被其他自然数整除的数叫做质数。(1不是质数)</p><p>用红色标记质数：</p><table><thead><tr><th>1</th><th><span style="color:red">2</span></th><th><span style="color:red">3</span></th><th>4</th><th><span style="color:red">5</span></th></tr></thead></table><p>题目的意思是将质数和非质数各分一组，进行排序一共有多少种可能：</p><blockquote><p>m个数排列m个位置，全排列公式：$A^m_m&#x3D;m!$</p><p>$A^3_3$为质数的所有排列次数</p><p>$A^2_2$为非质数的所有排列次数</p><p>并且每有一个质数的排列组合就有$A^2_2$次非质数的排列： </p><p>总数：$A^3_3 \times A^2_2&#x3D;3! \times 2!&#x3D;12$</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>遍历数组判断是否为质数，记录质数的个数<code>p</code>，非质数个数为<code>n-p</code></p><p>运用公式求出总数：$A^p_p \times A^{n-p}_{n-p}&#x3D;p! \times (n-p)!$</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> mod = <span class="built_in">pow</span>(<span class="number">10</span>,<span class="number">9</span>)+<span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断是否为质数</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">is_prime</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">        <span class="comment">//从2开始</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">2</span>; i*i &lt;= n;i++)&#123;</span><br><span class="line">            <span class="comment">//模运算为0，不是质数</span></span><br><span class="line">            <span class="keyword">if</span>(n%i == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//n!运算 Long类型防止溢出</span></span><br><span class="line">    <span class="function"><span class="type">long</span> <span class="title">factorial</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">        <span class="type">long</span> sum = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">2</span>; i &lt;= n; i++)&#123;</span><br><span class="line">            sum *=i;</span><br><span class="line">            sum = sum%mod;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">numPrimeArrangements</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> prime_num = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//从2开始，1不是质数</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">2</span>; i &lt;= n; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">is_prime</span>(i))&#123;</span><br><span class="line">                prime_num++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//n!*(n-p)!</span></span><br><span class="line">        <span class="type">long</span> result = (<span class="built_in">factorial</span>(prime_num)*<span class="built_in">factorial</span>(n-prime_num))%mod;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>)result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>复杂度分析：</p><ul><li><p>时间复杂度：O($n^{3&#x2F;2}$)。求 n 个数中质数个数的时间复杂度为 O($n^{3&#x2F;2}$)，阶乘的时间复杂度为 O(n)，总的时间复杂度为 O($n^{3&#x2F;2}$)。</p></li><li><p>空间复杂度：O(1)O(1)，只使用了常数空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)535. TinyURL的加密与解密</title>
      <link href="/2022/06/29/%E6%AF%8F%E6%97%A5LeetCode/2022-6/535%20TinyURL%E7%9A%84%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86/"/>
      <url>/2022/06/29/%E6%AF%8F%E6%97%A5LeetCode/2022-6/535%20TinyURL%E7%9A%84%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>TinyURL 是一种 URL 简化服务， 比如：当你输入一个 URL <code>https://leetcode.com/problems/design-tinyurl</code> 时，它将返回一个简化的URL <code>http://tinyurl.com/4e9iAk</code> 。请你设计一个类来加密与解密 <code>TinyURL </code>。</p><p>加密和解密算法如何设计和运作是没有限制的，你只需要保证一个 <code>URL</code> 可以被加密成一个 <code>TinyURL</code> ，并且这个 <code>TinyURL</code> 可以用解密方法恢复成原本的 <code>URL</code> 。</p><p>实现 Solution 类：</p><p><code>Solution()</code> 初始化 <code>TinyURL</code> 系统对象。<br><code>String encode(String longUrl)</code> 返回 <code>longUrl</code> 对应的 <code>TinyURL</code> 。<br><code>String decode(String shortUrl)</code> 返回 <code>shortUrl</code> 原本的 URL 。题目数据保证给定的 <code>shortUrl</code> 是由同一个系统对象加密的。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：url &#x3D; “<code>https://leetcode.com/problems/design-tinyurl</code>“<br>输出：”<code>https://leetcode.com/problems/design-tinyurl</code>“</p><p>解释：<br>Solution obj &#x3D; new Solution();<br>string tiny &#x3D; obj.encode(url); &#x2F;&#x2F; 返回加密后得到的 TinyURL 。<br>string ans &#x3D; obj.decode(tiny); &#x2F;&#x2F; 返回解密后得到的原本的 URL 。</p></blockquote></div><div class="story post-story"><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>使用自增<code>id</code>作为<code>longUrl</code>的键，存入<code>unordered_map</code>容器中</p><p>根据<code>id</code>来获取对应的<code>longUrl</code></p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    unordered_map&lt;<span class="type">int</span>, string&gt; map;</span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Solution</span>()&#123;</span><br><span class="line">        id = <span class="number">0</span>; <span class="comment">//初始化id</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">string <span class="title">encode</span><span class="params">(string longUrl)</span> </span>&#123;</span><br><span class="line">        id++;</span><br><span class="line">        map[id] = longUrl;</span><br><span class="line">        <span class="comment">//http://tinyurl.com/1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;http://tinyurl.com/&quot;</span>+<span class="built_in">to_string</span>(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">string <span class="title">decode</span><span class="params">(string shortUrl)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//substr(int pos)：获取pos位置起的所有字符串</span></span><br><span class="line">        <span class="comment">//stoi(string str)：将string类型的字符串转换成int类型的整数</span></span><br><span class="line">        <span class="type">int</span> t_id = <span class="built_in">stoi</span>(shortUrl.<span class="built_in">substr</span>(<span class="number">19</span>));</span><br><span class="line">        <span class="keyword">return</span> map[t_id];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li><p>时间复杂度：</p><ul><li>Encode 函数：O(n)O(n)，其中 n 是字符串 <code>longUrl</code> 的长度。</li><li>Decode 函数：O(1)O(1)。我们把 <code>shortUrl</code> 当成有限长度的字符串看待。</li></ul></li><li><p>空间复杂度：</p><ul><li>Encode 函数：O(n)O(n)。保存字符串 <code>longUrl</code> 需要 O(n)O(n) 的空间。</li><li>Decode 函数：O(1)O(1)。</li></ul></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)324. 摆动排序 II</title>
      <link href="/2022/06/28/%E6%AF%8F%E6%97%A5LeetCode/2022-6/324%20%E6%91%86%E5%8A%A8%E6%8E%92%E5%BA%8F%20II/"/>
      <url>/2022/06/28/%E6%AF%8F%E6%97%A5LeetCode/2022-6/324%20%E6%91%86%E5%8A%A8%E6%8E%92%E5%BA%8F%20II/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给你一个整数数组 <code>nums</code>，将它重新排列成 <code>nums[0] &lt; nums[1] &gt; nums[2] &lt; nums[3]...</code> 的顺序。</p><p>你可以假设所有输入数组都可以得到满足题目要求的结果。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：nums &#x3D; [1,5,2,4,3,6]<br>输出：[3,6,2,5,1,4]</p></blockquote></div><div class="story post-story"><h2 id="思路：双指针法"><a href="#思路：双指针法" class="headerlink" title="思路：双指针法"></a>思路：双指针法</h2><p>将数组<code>nums</code>按从小到大排列：</p><table><thead><tr><th>1</th><th>2</th><th align="center">3</th><th>4</th><th>5</th><th align="center">6</th></tr></thead><tbody><tr><td></td><td></td><td align="center">$\leftarrow\Uparrow$<br><br>left</td><td></td><td></td><td align="center">$\leftarrow\Uparrow$<br><br>right</td></tr></tbody></table><p>把排序好的数组分成两部分，<code>left</code>指针位于数组中间，<code>right</code>指针位于数组末尾，</p><p>将<code>left</code>和<code>right</code>当前位置的元素依次打印后，<code>left</code>和<code>right</code>指针左移，直至结束</p><p>输出：[3, 6, 2, 5, 1, 4]</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">wiggleSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = nums.<span class="built_in">size</span>(); <span class="comment">//获取数组的元素个数</span></span><br><span class="line">        <span class="type">int</span> left = n/<span class="number">2</span><span class="number">-1</span>; <span class="comment">//定义左指针</span></span><br><span class="line">        <span class="type">int</span> right = n<span class="number">-1</span>; <span class="comment">//定义右指针</span></span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">new_nums</span><span class="params">(nums)</span></span>;</span><br><span class="line">        <span class="built_in">sort</span>(new_nums.<span class="built_in">begin</span>(),new_nums.<span class="built_in">end</span>()); <span class="comment">//将新数组排序</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i%<span class="number">2</span> == <span class="number">0</span>)&#123; <span class="comment">//偶数位置插入left指针的元素，奇数位置插入right指针的元素</span></span><br><span class="line">                nums[i] = a[left];</span><br><span class="line">                left--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                nums[i] = a[right];</span><br><span class="line">                rigth--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析："><a href="#复杂度分析：" class="headerlink" title="复杂度分析："></a>复杂度分析：</h2><ul><li>时间复杂度：O(nlogn)，排序所需的时间复杂度是O(nlogn)，插入O(n)，整体O(nlogn)</li><li>空间复杂度：O(n)，需要额外的空间存放排序的元素。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)剑指 Offer II 091. 粉刷房子</title>
      <link href="/2022/06/25/%E6%AF%8F%E6%97%A5LeetCode/2022-6/%E5%89%91%E6%8C%87%20Offer%20II%20091%20%E7%B2%89%E5%88%B7%E6%88%BF%E5%AD%90/"/>
      <url>/2022/06/25/%E6%AF%8F%E6%97%A5LeetCode/2022-6/%E5%89%91%E6%8C%87%20Offer%20II%20091%20%E7%B2%89%E5%88%B7%E6%88%BF%E5%AD%90/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>假如有一排房子，共 <code>n</code> 个，每个房子可以被粉刷成红色、蓝色或者绿色这三种颜色中的一种，你需要粉刷所有的房子并且使其相邻的两个房子颜色不能相同。</p><p>当然，因为市场上不同颜色油漆的价格不同，所以房子粉刷成不同颜色的花费成本也是不同的。每个房子粉刷成不同颜色的花费是以一个 <code>n x 3</code> 的正整数矩阵 <code>costs</code>来表示的。</p><p>例如，<code>costs[0][0]</code> 表示第 0 号房子粉刷成红色的成本花费；<code>costs[1][2]</code> 表示第 1 号房子粉刷成绿色的花费，以此类推。<br>请计算出粉刷完所有房子最少的花费成本。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入: costs &#x3D; [[17,2,17],[16,16,5],[14,3,19]]<br>输出: 10<br>解释: 将 0 号房子粉刷成蓝色，1 号房子粉刷成绿色，2 号房子粉刷成蓝色。<br>            最少花费: 2 + 5 + 3 &#x3D; 10。</p></blockquote></div><div class="story post-story"><h2 id="1-递归"><a href="#1-递归" class="headerlink" title="1.递归"></a>1.递归</h2><h3 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">def</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; costs, <span class="type">int</span> pos, <span class="type">int</span> n, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; flag)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//到达最后，没有房子了，退出</span></span><br><span class="line">        <span class="keyword">if</span> (pos == n) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> ans = INT_MAX;</span><br><span class="line">        <span class="comment">//依次选择三种颜色</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> temp = INT_MAX;</span><br><span class="line">            vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">temp_flag</span>(flag);</span><br><span class="line">            <span class="comment">//粉刷第一个房子，无需看前面房子的颜色，因为前面没有房子。</span></span><br><span class="line">            <span class="keyword">if</span> (pos == <span class="number">0</span>) &#123;</span><br><span class="line">                temp_flag[pos][i] = <span class="number">-1</span>;</span><br><span class="line">                temp = <span class="built_in">def</span>(costs, pos + <span class="number">1</span>, n, temp_flag) + costs[pos][i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//粉刷墙，要看前面用了什么颜色</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (flag[pos - <span class="number">1</span>][i] != <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="comment">//将这个房子的颜色标记</span></span><br><span class="line">                temp_flag[pos][i] = <span class="number">-1</span>;</span><br><span class="line">                temp = <span class="built_in">def</span>(costs, pos + <span class="number">1</span>, n, temp_flag) + costs[pos][i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//选择花费最少的金额</span></span><br><span class="line">            ans = <span class="built_in">min</span>(ans, temp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minCost</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; costs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">def</span>(costs, <span class="number">0</span>, costs.<span class="built_in">size</span>(), costs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>采用递归的方法，提交后，结果执行超时。</p></div><div class="story post-story"><h2 id="2-动态规划"><a href="#2-动态规划" class="headerlink" title="2.动态规划"></a>2.动态规划</h2><p>$$<br>Red[pos][0]&#x3D;<br>\begin{cases}<br>cost[0][0]  &amp; pos &#x3D; 0; \<br>min(Green[pos+1][1],Blue[pos+1][2]) + costs[pos][0]  &amp; pos&gt;0<br>\end{cases} \<br>$$</p><p>$$<br>Green[pos][1]&#x3D;<br>\begin{cases}<br>cost[0][1]  &amp; pos &#x3D; 0; \<br>min(Red[pos+1][0],Blue[pos+1][2]) + costs[pos][1]  &amp; pos&gt;0<br>\end{cases} \<br>$$</p><p>$$<br>Blue[pos][2]&#x3D;<br>\begin{cases}<br>cost[0][2]  &amp; pos &#x3D; 0; \<br>min(Red[pos+1][0],Green[pos+1][1]) + costs[pos][2]  &amp; pos&gt;0<br>\end{cases}<br>$$</p><p>画出动态规划图，以示例为例：</p><p><code>costs = [[17,2,17],[16,16,5],[14,3,19]]</code></p><table><thead><tr><th align="center">颜色\pos</th><th align="center">0</th><th align="center">1</th><th align="center">2</th></tr></thead><tbody><tr><td align="center">Red(0)</td><td align="center">17</td><td align="center">18</td><td align="center">21</td></tr><tr><td align="center">Green(1)</td><td align="center">2</td><td align="center">33</td><td align="center">10</td></tr><tr><td align="center">Blue(2)</td><td align="center">17</td><td align="center">7</td><td align="center">37</td></tr></tbody></table><p>$$<br>mincost &#x3D; min(dp[2][0],dp[2][1],dp[2][2])<br>$$</p><h3 id="代码-cpp-：-1"><a href="#代码-cpp-：-1" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minCost</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; costs)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = costs.<span class="built_in">size</span>();</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">red</span><span class="params">(n, <span class="number">0</span>)</span></span>; </span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">blue</span><span class="params">(n, <span class="number">0</span>)</span></span>;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">green</span><span class="params">(n, <span class="number">0</span>)</span></span>;</span><br><span class="line">        <span class="comment">// 初始化</span></span><br><span class="line">        red[<span class="number">0</span>] = costs[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">        blue[<span class="number">0</span>] = costs[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line">        green[<span class="number">0</span>] = costs[<span class="number">0</span>][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">            red[i] = <span class="built_in">min</span>(blue[i - <span class="number">1</span>], green[i - <span class="number">1</span>]) + costs[i][<span class="number">0</span>];</span><br><span class="line">            blue[i] = <span class="built_in">min</span>(red[i - <span class="number">1</span>], green[i - <span class="number">1</span>]) + costs[i][<span class="number">1</span>];</span><br><span class="line">            green[i] = <span class="built_in">min</span>(red[i - <span class="number">1</span>], blue[i - <span class="number">1</span>]) + costs[i][<span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(red[n - <span class="number">1</span>], <span class="built_in">min</span>(blue[n - <span class="number">1</span>], green[n - <span class="number">1</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="复杂度分析"><a href="#复杂度分析" class="headerlink" title="复杂度分析"></a>复杂度分析</h3><ul><li><p>时间复杂度：O(n)，其中 n 是房子个数。需要遍历全部房子一次，由于颜色数量固定是三种，因此对于每个房子计算粉刷房子的最小花费成本的时间是 O(1)，总时间复杂度是 O(n)。</p></li><li><p>空间复杂度：O(1)。使用空间优化的方法，只需要维护一个长度为 3 的数组，空间复杂度是 O(1)。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)515. 在每个树行中找最大值(中等)</title>
      <link href="/2022/06/24/%E6%AF%8F%E6%97%A5LeetCode/2022-6/515%20%E5%9C%A8%E6%AF%8F%E4%B8%AA%E6%A0%91%E8%A1%8C%E4%B8%AD%E6%89%BE%E6%9C%80%E5%A4%A7%E5%80%BC/"/>
      <url>/2022/06/24/%E6%AF%8F%E6%97%A5LeetCode/2022-6/515%20%E5%9C%A8%E6%AF%8F%E4%B8%AA%E6%A0%91%E8%A1%8C%E4%B8%AD%E6%89%BE%E6%9C%80%E5%A4%A7%E5%80%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一棵二叉树的根节点 <code>root</code> ，请找出该二叉树中每一层的最大值。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><img src="https://assets.leetcode.com/uploads/2020/08/21/largest_e1.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2020/08/21/largest_e1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 50%;"/><blockquote><p>输入: root &#x3D; [1,3,2,5,3,null,9]<br>输出: [1,3,9]</p></blockquote></div><div class="story post-story"><h2 id="思路：深度优先搜索"><a href="#思路：深度优先搜索" class="headerlink" title="思路：深度优先搜索"></a>思路：深度优先搜索</h2><p>我们采用树的<strong>先序遍历</strong>，来进行<strong>深度优先搜索</strong>，并用<code>pos</code>来记录<strong>当前树的高度</strong>，就可以通过<code>pos</code>高度来判断是否在同一层，并且是否更新此<strong>高度</strong>的最大值。</p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(TreeNode* root, vector&lt;<span class="type">int</span>&gt;&amp; result, <span class="type">int</span> pos)</span></span>&#123;</span><br><span class="line">        <span class="comment">//如果该结点为空，则退出</span></span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(result.<span class="built_in">size</span>() == pos)&#123;</span><br><span class="line">            <span class="comment">//数组的大小小于高度，大小需要加1</span></span><br><span class="line">            result.<span class="built_in">push_back</span>(root-&gt;val);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//判断该层的某个结点，与之前记录的比较大小</span></span><br><span class="line">            result[pos] = <span class="built_in">max</span>(result[pos], root-&gt;val);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//遍历左子树，高度+1</span></span><br><span class="line">        <span class="built_in">dfs</span>(root-&gt;left, result, pos+<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//遍历右子树，高度+1</span></span><br><span class="line">        <span class="built_in">dfs</span>(root-&gt;right, result, pos+<span class="number">1</span>);        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">largestValues</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; result;</span><br><span class="line">    </span><br><span class="line">        <span class="built_in">dfs</span>(root, result, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析"><a href="#复杂度分析" class="headerlink" title="复杂度分析"></a>复杂度分析</h2><ul><li>时间复杂度：O(n)，其中 n 为二叉树节点个数。二叉树的遍历中每个节点会被访问一次且只会被访问一次。</li><li>空间复杂度：O(pos)。其中 pos 表示二叉树的高度。递归函数需要栈空间，而栈空间取决于递归的深度，因此空间复杂度等价于二叉树的高度。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)30. 串联所有单词的子串</title>
      <link href="/2022/06/23/%E6%AF%8F%E6%97%A5LeetCode/2022-6/30%20%E4%B8%B2%E8%81%94%E6%89%80%E6%9C%89%E5%8D%95%E8%AF%8D%E7%9A%84%E5%AD%90%E4%B8%B2/"/>
      <url>/2022/06/23/%E6%AF%8F%E6%97%A5LeetCode/2022-6/30%20%E4%B8%B2%E8%81%94%E6%89%80%E6%9C%89%E5%8D%95%E8%AF%8D%E7%9A%84%E5%AD%90%E4%B8%B2/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个字符串<code>s</code>和一些<strong>长度相同</strong>的单词<code>words</code>。找出<code>s</code>中恰好可以由<code>words</code>中所有单词串联形成的子串的起始位置。</p><p>注意子串要与<code>words</code>中的单词完全匹配，<strong>中间不能有其他字符</strong>，但不需要考虑<code>words</code>中单词串联的顺序。</p></div><div class="story post-story"><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><blockquote><p>输入：s &#x3D; “barfoofoobarthefoobarman”, words &#x3D; [“bar”,”foo”,”the”]<br>输出：[6,9,12]</p></blockquote><p>输出返回字串的第一个字符在<code>s</code>中的位置</p><p>第一个字串：barfoo<em><strong>foobarthe</strong></em>foobarman  <code>6</code></p><p>第二个字串：barfoofoo<em><strong>barthefoo</strong></em>barman  <code>9</code></p><p>第三个字符：barfoofoobar<em><strong>thefoobar</strong></em>man  <code>12</code></p></div><div class="story post-story"><h2 id="思路：滑动窗口"><a href="#思路：滑动窗口" class="headerlink" title="思路：滑动窗口"></a>思路：滑动窗口</h2><blockquote><p><code>word_len</code>为每个单词的长度，因为每个单词的长度都相同；</p><p><code>word_num</code>为<code>words</code>数组中单词的个数；</p><p><code>total_len</code>为<code>words</code>数组中所有的单词的总长度；</p><p><code>map</code>来记录<code>words</code>数组中每个单词的个数；</p><p><code>t_map</code>遍历<code>s</code>时用来记录；</p><p>左指针<code>left</code>和右指针<code>right</code>用来当作左右边界；</p><p><code>count</code>用来统计已经匹配单词的个数，如果<code>count == word_num</code>，就证明匹配成功；</p><p>遍历<code>s</code>时无需一个一个字符的遍历，可以一个一个单词的遍历，<code>right += word_len</code>；</p><p>如果截取的单词<code>map</code>中不存在，则之前记录的全部无效，清空<code>t_map</code>和<code>count</code>；</p><p>如果某个单词在<code>t_map</code>中的个数大于<code>map</code>中的个数，就需要删除匹配的多余的单词，就需要删除窗口中第一个单词，直到某个单词出现的次数小于<code>map</code>中的个数</p></blockquote></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">findSubstring</span><span class="params">(string s, vector&lt;string&gt;&amp; words)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//用来存放结果</span></span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; result; </span><br><span class="line">        <span class="comment">//判断s和words是否为空，如果其中有一个为空，则返回空数组</span></span><br><span class="line">        <span class="keyword">if</span>(s.<span class="built_in">empty</span>()||words.<span class="built_in">empty</span>())&#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="type">int</span> word_len = words[<span class="number">0</span>].<span class="built_in">size</span>(); <span class="comment">//一个单词的长度（每个单词长度都相同）</span></span><br><span class="line">        <span class="type">int</span> word_num = words.<span class="built_in">size</span>(); <span class="comment">// 单词的总个数</span></span><br><span class="line">        <span class="type">int</span> total_len = word_len*word_num; <span class="comment">// 全部单词的长度</span></span><br><span class="line">        <span class="comment">//建立单词-&gt;单词个数的映射</span></span><br><span class="line">        unordered_map&lt;string, <span class="type">int</span>&gt; map;</span><br><span class="line">        <span class="comment">//统计每个单词的个数</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;word : words)&#123;</span><br><span class="line">            <span class="comment">//map[key]:返回key值所对应的value值，如果不存在key值，则会使用该key值向当前容器中插入一个新value值为 0 </span></span><br><span class="line">            map[word]++; <span class="comment">//等价于 map[word] += 1</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i&lt; word_len; i++)&#123;</span><br><span class="line">            <span class="comment">//left和right用来表示窗口的左右边界</span></span><br><span class="line">            <span class="type">int</span> left = i;</span><br><span class="line">            <span class="type">int</span> right = i;</span><br><span class="line">            <span class="comment">//count用来统计已经匹配的单词个数</span></span><br><span class="line">            <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">            unordered_map&lt;string, <span class="type">int</span>&gt; t_map;</span><br><span class="line">            <span class="comment">//开始滑动窗口</span></span><br><span class="line">            <span class="comment">//right右边界依次累加单词的长度，直到超过s的长度停止循环 </span></span><br><span class="line">            <span class="keyword">while</span>(right + word_len &lt;= s.<span class="built_in">size</span>())&#123;</span><br><span class="line">                <span class="comment">//substr(pos, n):从第pos的位置开始截取n个字符获取单词</span></span><br><span class="line">                string word = s.<span class="built_in">substr</span>(right, word_len);</span><br><span class="line">                right += word_len; <span class="comment">//right跳到下一个单词</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">//count(key):在容器中查找以key键的键值对的个数。如果为0，说明此单词word在words数组中不存在。</span></span><br><span class="line">                <span class="keyword">if</span>(map.<span class="built_in">count</span>(word) == <span class="number">0</span>)&#123;</span><br><span class="line">                    count = <span class="number">0</span>; <span class="comment">//清空之前统计的个数</span></span><br><span class="line">                    left = right; <span class="comment">//将左指针left移动到右指针right位置上重新开始</span></span><br><span class="line">                    t_map.<span class="built_in">clear</span>(); <span class="comment">//之前匹配的单词没用了，清空t_map中的元素</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//如果不为0，说明此单词word在words数组中存在。</span></span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    count++; <span class="comment">//统计个数加1</span></span><br><span class="line">                    t_map[word]++;<span class="comment">// word所对应的个数加1</span></span><br><span class="line">                    <span class="comment">//t_map中的word对应的个数大于map的word对应的个数，说明匹配到多余的单词了</span></span><br><span class="line">                    <span class="keyword">while</span>(t_map[word]&gt; map[word])&#123;</span><br><span class="line">                        <span class="comment">//获取窗口的第一个单词</span></span><br><span class="line">                        string t_word = s.<span class="built_in">substr</span>(left, word_len);</span><br><span class="line">                        <span class="comment">//将t_word这个单词对应的个数减1</span></span><br><span class="line">                        <span class="comment">//并非是那个大于map中个数的单词</span></span><br><span class="line">                        t_map[t_word]--;</span><br><span class="line">                        count--; <span class="comment">//统计个数减1</span></span><br><span class="line">                        left += word_len;<span class="comment">//将左指针跳到下一个</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//如果count等于单词的个数说明匹配成功，将左指针位置记录</span></span><br><span class="line">                    <span class="keyword">if</span>(count == word_num)&#123;</span><br><span class="line">                    result.<span class="built_in">push_back</span>(left);  </span><br><span class="line">                    &#125; </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析"><a href="#复杂度分析" class="headerlink" title="复杂度分析"></a>复杂度分析</h2><ul><li>时间复杂度：O(ls×n)，其中 ls 是输入 s 的长度，n 是 words 中每个单词的长度。需要做 n 次滑动窗口，每次需要遍历一次 s。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(每日LeetCode)513. 找树左下角的值</title>
      <link href="/2022/06/22/%E6%AF%8F%E6%97%A5LeetCode/2022-6/513%20%E6%89%BE%E6%A0%91%E5%B7%A6%E4%B8%8B%E8%A7%92%E7%9A%84%E5%80%BC/"/>
      <url>/2022/06/22/%E6%AF%8F%E6%97%A5LeetCode/2022-6/513%20%E6%89%BE%E6%A0%91%E5%B7%A6%E4%B8%8B%E8%A7%92%E7%9A%84%E5%80%BC/</url>
      
        <content type="html"><![CDATA[<div class="story post-story"><h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p>给定一个二叉树的 <strong>根节点</strong> <code>root</code>，请找出该二叉树的 <strong>最底层 最左边</strong> 节点的值。</p><p>假设二叉树中至少有一个节点。</p></div><div class="story post-story"><h2 id="示例"><a href="#示例" class="headerlink" title="示例:"></a>示例:</h2><img src="https://assets.leetcode.com/uploads/2020/12/14/tree2.jpg" class="lazyload" data-srcset="https://assets.leetcode.com/uploads/2020/12/14/tree2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:50%;"/><blockquote><p>输入: [1,2,3,4,null,5,6,null,null,7]<br>输出: 7</p></blockquote></div><div class="story post-story"><h2 id="思路：深度优先搜索-DFS"><a href="#思路：深度优先搜索-DFS" class="headerlink" title="思路：深度优先搜索(DFS)"></a>思路：深度优先搜索(DFS)</h2><p>我采用了<strong>优先遍历左节点，再遍历右节点</strong>，因为只有优先遍历左节点，才会优先记录当前深度左节点的值，所以就没有必要记录当前深度右边的值了。</p><p>使用<code>depth</code>记录<strong>当前树的深度</strong>，<code>current_val</code>为<strong>记录的深度</strong><code>current_depth</code>的<strong>最左边的值</strong>。</p><p>进行判断如果<code>depth</code>的深度大于<code>current_depth</code>的深度，将<code>current_val</code>的值设置为当前结点的值，并将<code>current_depth</code>的值设置当前结点深度<code>depth</code></p></div><div class="story post-story"><h2 id="代码-cpp-："><a href="#代码-cpp-：" class="headerlink" title="代码(cpp)："></a>代码(cpp)：</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(TreeNode* root, <span class="type">int</span> depth, <span class="type">int</span>&amp; current_depth, <span class="type">int</span>&amp; current_val)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">nullptr</span>) <span class="comment">//如果当前结点为空，则退出</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//优先遍历左节点，深度加1</span></span><br><span class="line">        <span class="built_in">dfs</span>(root-&gt;left, depth+<span class="number">1</span>, current_depth, current_val);</span><br><span class="line">        <span class="comment">//其次遍历右节点，深度加1</span></span><br><span class="line">        <span class="built_in">dfs</span>(root-&gt;right, depth+<span class="number">1</span>, current_depth, current_val);</span><br><span class="line">        <span class="comment">//如果当前深度大于记录的深度</span></span><br><span class="line">        <span class="keyword">if</span> (depth &gt; current_depth)</span><br><span class="line">        &#123;</span><br><span class="line">            current_depth = depth; <span class="comment">//将当前深度记录到current_depth</span></span><br><span class="line">            current_val = root-&gt;val; <span class="comment">//将当前结点值记录到current_val</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">findBottomLeftValue</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> current_depth = <span class="number">0</span>; <span class="comment">//初始化current_depth</span></span><br><span class="line">        <span class="type">int</span> current_val = <span class="number">0</span>; <span class="comment">//初始化current_val</span></span><br><span class="line">        <span class="comment">//因为有根结点存在，将depth设置为1，而非0</span></span><br><span class="line">        <span class="built_in">dfs</span>(root, <span class="number">1</span>, current_depth, current_val);</span><br><span class="line">        <span class="keyword">return</span> current_val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="story post-story"><h2 id="复杂度分析"><a href="#复杂度分析" class="headerlink" title="复杂度分析"></a>复杂度分析</h2><ul><li><p>​时间复杂度：O(n)，其中 n 是二叉树的节点数目。需要遍历 n 个节点。</p></li><li><p>​空间复杂度：O(n)。递归栈需要占用 O(n) 的空间。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 每日LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
